<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.550">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="dcterms.date" content="2023-09-28">

<title>Akshat Dwivedi - How should the untreated in the treatment group from an experiment be analyzed?</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<link href="../../favicon.png" rel="icon" type="image/png">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="../../site_libs/bootstrap/bootstrap-dark.min.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Akshat Dwivedi</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../about.html"> 
<span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/ad1729"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://www.linkedin.com/in/akshatd/"> <i class="bi bi-linkedin" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://500px.com/p/akshatdwivedi?view=photos"> <i class="bi bi-images" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
          <div class="quarto-navbar-tools">
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <div class="quarto-title-block"><div><h1 class="title">How should the untreated in the treatment group from an experiment be analyzed?</h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li><li><hr class="dropdown-divider"></li><li><a id="quarto-view-source" class="dropdown-item" href="javascript:void(0)" role="button">View Source</a></li></ul></div></div>
                                <div class="quarto-categories">
                <div class="quarto-category">Causal Inference</div>
                <div class="quarto-category">Instrumental Variables</div>
                <div class="quarto-category">Advertising</div>
                <div class="quarto-category">R</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">September 28, 2023</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active" data-toc-expanded="99">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction">Introduction</a></li>
  <li><a href="#problem-description" id="toc-problem-description" class="nav-link" data-scroll-target="#problem-description">Problem description</a></li>
  <li><a href="#simulate-data" id="toc-simulate-data" class="nav-link" data-scroll-target="#simulate-data">Simulate data</a></li>
  <li><a href="#intention-to-treat-itt" id="toc-intention-to-treat-itt" class="nav-link" data-scroll-target="#intention-to-treat-itt">Intention-to-treat (ITT)</a>
  <ul class="collapse">
  <li><a href="#estimators-models" id="toc-estimators-models" class="nav-link" data-scroll-target="#estimators-models">Estimators / models</a></li>
  <li><a href="#back-to-itt-analysis" id="toc-back-to-itt-analysis" class="nav-link" data-scroll-target="#back-to-itt-analysis">Back to ITT analysis</a></li>
  </ul></li>
  <li><a href="#per-protocol-pp" id="toc-per-protocol-pp" class="nav-link" data-scroll-target="#per-protocol-pp">Per-protocol (PP)</a></li>
  <li><a href="#as-treated-at" id="toc-as-treated-at" class="nav-link" data-scroll-target="#as-treated-at">As-treated (AT)</a></li>
  <li><a href="#instrumental-variable-analysis-iv" id="toc-instrumental-variable-analysis-iv" class="nav-link" data-scroll-target="#instrumental-variable-analysis-iv">Instrumental variable analysis (IV)</a>
  <ul class="collapse">
  <li><a href="#iv-in-action" id="toc-iv-in-action" class="nav-link" data-scroll-target="#iv-in-action">IV in action</a></li>
  </ul></li>
  <li><a href="#all-the-estimates-in-a-single-plot" id="toc-all-the-estimates-in-a-single-plot" class="nav-link" data-scroll-target="#all-the-estimates-in-a-single-plot">All the estimates in a single plot</a></li>
  <li><a href="#profit-distribution" id="toc-profit-distribution" class="nav-link" data-scroll-target="#profit-distribution">Profit distribution</a></li>
  <li><a href="#ignored-complexities" id="toc-ignored-complexities" class="nav-link" data-scroll-target="#ignored-complexities">Ignored complexities</a></li>
  <li><a href="#references" id="toc-references" class="nav-link" data-scroll-target="#references">References</a></li>
  </ul>
<div class="toc-actions"><ul><li><a href="https://github.com/ad1729/ad1729.github.io/issues/new" class="toc-action"><i class="bi bi-github"></i>Report an issue</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content quarto-banner-title-block page-columns page-full" id="quarto-document-content">





<p>This (longer-than-expected) post compares intention-to-treat, per-protocol, as-treated, and instrumental variable analyses on a simulated dataset. Along the way, it goes off on fun tangents like 1) comparing results from different estimators for risk difference (a.k.a. uplift), and 2) comparing the bootstrap distribution with the Bayesian posterior distribution and the normal approximation for the risk difference. Finally, it uses the estimated probabilities to get the posterior predictive distribution for the total profit under different scenarios. This was written largely for me to learn about IV methods in order to deal with the problem of estimating the effect of a treatment under non-compliance in randomized experiments.</p>
<section id="introduction" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="introduction">Introduction</h2>
<p>One of the first problems I ever cut my teeth on as a data scientist many years ago was to analyze data from a marketing / advertising campaign to assess the impact of an advertisement (ad) on sales of a certain product.</p>
<p>It was a simple experimental dataset from a two-arm<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a> randomized controlled trial. The most challenging part of that analysis was how to analyze individuals – the so-called <em>non-compliers</em><a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a> <em>–</em> who were assigned to the treatment group eligible to view an ad, but who did not actually end up seeing a single ad.</p>
<div class="no-row-height column-margin column-container"><p><sup>1</sup>&nbsp;i.e., an experiment with two groups – treatment and control</p><p><sup>2</sup>&nbsp;in the usual terminology used in the instrumental variable methods literature</p></div><p>All details below are of a simplified version of the problem similar to the one I worked on, and have no resemblance to the real constraints / numbers / settings from the actual problem. This exact same problem shows up in pretty much every field (marketing, advertising, pharma, tech, psychology, economics, etc.) where experiments are regularly conducted, and the analyses in this post are applicable to those situations as well.</p>
</section>
<section id="problem-description" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="problem-description">Problem description</h2>
<p>Let’s say a company has been working on updating an existing version of a product, and wants to know whether they should invest in an advertising campaign on a specific channel (say YouTube / Instagram ads) to promote the new product. Since buying ads cost money, the campaign would have to be profitable enough in terms of increased sales to justify the ad spend<a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a>.</p>
<div class="no-row-height column-margin column-container"><p><sup>3</sup>&nbsp;The advertising company, on the other hand, is more interested in assessing the effectiveness of advertising, so would be happier to see a strong positive effect of advertising.</p></div><p>The main interest is in (functions of) two quantities – <span class="math inline">\(\text{Pr}[Y^{a=0} = 1]\)</span>, which is the proportion of sales in a population not shown the ad; and <span class="math inline">\(\text{Pr}[Y^{a=1} = 1]\)</span>, which is the proportion of sales in a population which is shown the ad. These can be used to calculate the risk difference / uplift (<span class="math inline">\(\text{Pr}[Y^{a=1} = 1] - \text{Pr}[Y^{a=0} = 1]\)</span>), the risk ratio / relative risk / lift (<span class="math inline">\(\text{Pr}[Y^{a=1} = 1] / \text{Pr}[Y^{a=0} = 1]\)</span>), or any other quantity listed in the tables <a href="https://en.wikipedia.org/wiki/Relative_risk_reduction">here</a>. The risk difference can then be used to calculate the additional profit from showing the ad compared to doing nothing.</p>
<p>The cleanest way of estimating these probabilities is through an experiment. First, a target population – say, users of a given product – is identified, and then, this group is randomly split into a treatment and a control group. Individuals assigned to the treatment group are eligible to see an ad for the newer, updated version of the product, and the control group is ineligible to view the ad. The campaign runs for a two week period, where individuals in the treatment group see an ad multiple times. The outcome for this campaign is sales of the newer product in each of the two groups in the six-week period from the start of the campaign.</p>
<p>Before writing any code, the <code>tidyverse</code> packages is loaded.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1"></a><span class="fu">library</span>(tidyverse)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>── Attaching core tidyverse packages ──────────────────────── tidyverse 2.0.0 ──
✔ dplyr     1.1.2     ✔ readr     2.1.4
✔ forcats   1.0.0     ✔ stringr   1.5.0
✔ ggplot2   3.4.2     ✔ tibble    3.2.1
✔ lubridate 1.9.2     ✔ tidyr     1.3.0
✔ purrr     1.0.1     
── Conflicts ────────────────────────────────────────── tidyverse_conflicts() ──
✖ dplyr::filter() masks stats::filter()
✖ dplyr::lag()    masks stats::lag()
ℹ Use the conflicted package (&lt;http://conflicted.r-lib.org/&gt;) to force all conflicts to become errors</code></pre>
</div>
</div>
<p>A DAG, or a <em>directed acyclic graph</em> for this problem can be visualized as follows</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1"></a>dag <span class="ot">&lt;-</span> ggdag<span class="sc">::</span><span class="fu">dagify</span>(</span>
<span id="cb3-2"><a href="#cb3-2"></a>  A <span class="sc">~</span> Z <span class="sc">+</span> U, </span>
<span id="cb3-3"><a href="#cb3-3"></a>  Y <span class="sc">~</span> A <span class="sc">+</span> U, </span>
<span id="cb3-4"><a href="#cb3-4"></a>  <span class="at">exposure =</span> <span class="st">"A"</span>, <span class="at">outcome =</span> <span class="st">"Y"</span>, </span>
<span id="cb3-5"><a href="#cb3-5"></a>  <span class="at">coords =</span> <span class="fu">list</span>(<span class="at">x =</span> <span class="fu">c</span>(<span class="at">Z =</span> <span class="dv">1</span>, <span class="at">A =</span> <span class="dv">2</span>, <span class="at">U =</span> <span class="fl">2.5</span>, <span class="at">Y =</span> <span class="dv">3</span>), </span>
<span id="cb3-6"><a href="#cb3-6"></a>                <span class="at">y =</span> <span class="fu">c</span>(<span class="at">Z =</span> <span class="dv">1</span>, <span class="at">A =</span> <span class="dv">1</span>, <span class="at">U =</span> <span class="fl">1.2</span>, <span class="at">Y =</span> <span class="dv">1</span>))</span>
<span id="cb3-7"><a href="#cb3-7"></a>) <span class="sc">%&gt;%</span> </span>
<span id="cb3-8"><a href="#cb3-8"></a>  ggdag<span class="sc">::</span><span class="fu">ggdag</span>() <span class="sc">+</span></span>
<span id="cb3-9"><a href="#cb3-9"></a>  ggdag<span class="sc">::</span><span class="fu">theme_dag</span>()</span>
<span id="cb3-10"><a href="#cb3-10"></a></span>
<span id="cb3-11"><a href="#cb3-11"></a><span class="fu">plot</span>(dag)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-2-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>where <span class="math inline">\(Y\)</span> is a binary outcome (bought the newer version of the product or not during the follow-up period), <span class="math inline">\(A\)</span> is a binary treatment variable (saw the ad or not), <span class="math inline">\(Z\)</span> is a binary variable indicating group assignment (i.e., randomly assigned to the treatment or control group), and U is the set of (unmeasured) confounder(s), i.e., one or more variables that both impact whether an individual ends up seeing the ad, and whether they end up buying the newer product or not.</p>
<p>This DAG encodes several assumptions:</p>
<ul>
<li><p>Group assignment <span class="math inline">\(Z\)</span> only affects whether someone sees an ad or not (variable <span class="math inline">\(A\)</span>)</p></li>
<li><p>There are some unmeasured common causes (confounders) <span class="math inline">\(U\)</span> that make our life difficult by potentially distorting the relationship between <span class="math inline">\(A\)</span> and <span class="math inline">\(Y\)</span></p></li>
<li><p><span class="math inline">\(Z\)</span> has no direct effect on Y; only an indirect effect entirely (mediated) via <span class="math inline">\(A\)</span></p></li>
<li><p><span class="math inline">\(Z\)</span> has no relationship with <span class="math inline">\(U\)</span>, since <span class="math inline">\(Z\)</span> is randomly assigned and should be balanced with respect to <span class="math inline">\(U\)</span> (unless we’re unlucky and there’s some imbalance by chance)</p></li>
</ul>
<p>After the campaign is over, it is observed that a subset of the treatment group never received the treatment, i.e., didn’t see the ad at all. The main question for the analysis is then – how should these non-compliers be analyzed? In this post I look at three possible choices:</p>
<ul>
<li><p>Should they be analysed as part of the treatment group, despite not receiving the treatment?</p></li>
<li><p>Should they be excluded from the analysis altogether?</p></li>
<li><p>Should they be included in the control group since they were untreated?</p></li>
</ul>
</section>
<section id="simulate-data" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="simulate-data">Simulate data</h2>
<p>Before the question in the previous section can be answered, we need to generate hypothetical data<a href="#fn4" class="footnote-ref" id="fnref4" role="doc-noteref"><sup>4</sup></a> for this fictional ad campaign.</p>
<div class="no-row-height column-margin column-container"><p><sup>4</sup>&nbsp;Inspired by a comment on <a href="https://statmodeling.stat.columbia.edu/2019/06/20/how-to-simulate-an-instrumental-variables-problem/">this post</a>, and the Imbens, Rubin 1997 paper linked therein.</p></div><p>What the following code does is it first partitions the population of 100,000 individuals into an 80-20% mix of <em>compliers</em> and <em>non-compliers</em>. Compliers are the individuals that would watch the ad if they were assigned to the target group. Non-compliers are the individuals who would not comply with the group they’re randomized to. More on this in the IV section below. Then, the potential outcomes for each individual under the two treatments depending on their compliance status are simulated.</p>
<p>If <span class="math inline">\(C_i = 1\)</span> denotes whether individual <span class="math inline">\(i\)</span> is a complier, and <span class="math inline">\(C_i = 0\)</span> otherwise, then <span class="math inline">\(\text{Pr}[Y^{a = 0}_i = 1| C_i = 0] = \text{Pr}[Y^{a = 1}_i = 1| C_i = 0] = 0.1\%\)</span>, where the probability of purchasing the new product is very small among the non-compliers independent of whether they’re assigned to the treatment or the control group.</p>
<p>Among the compliers, <span class="math inline">\(\text{Pr}[Y^{a = 0}_i = 1| C_i = 1] = 1\%\)</span>, i.e., 1% of the individuals would buy the new product if nobody was shown the ad. If the ad is rolled out to the full population, then <span class="math inline">\(\text{Pr}[Y^{a = 1}_i = 1| C_i = 1] = 11\%\)</span>, which leads to an <em>average treatment effect (ATE)</em> among the compliers of +10 percentage points.</p>
<p>These individuals are randomly assigned to the treatment (70%) or control (30%) group. Their actual treatment status (i.e., treated or untreated) is a product of the group they’re assigned to and their compliance. Their realized outcome is the outcome corresponding to the group they’re assigned to.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1"></a>simulate_data <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">n =</span> <span class="dv">100000</span>L,</span>
<span id="cb4-2"><a href="#cb4-2"></a>                          <span class="at">pY0 =</span> <span class="fl">0.01</span>,</span>
<span id="cb4-3"><a href="#cb4-3"></a>                          <span class="at">risk_diff =</span> <span class="fl">0.1</span>, </span>
<span id="cb4-4"><a href="#cb4-4"></a>                          <span class="at">seed =</span> <span class="dv">23</span>, </span>
<span id="cb4-5"><a href="#cb4-5"></a>                          <span class="at">p_compliers =</span> <span class="fl">0.8</span>, </span>
<span id="cb4-6"><a href="#cb4-6"></a>                          <span class="at">p_treatment =</span> <span class="fl">0.7</span>,</span>
<span id="cb4-7"><a href="#cb4-7"></a>                          <span class="at">pY_non_compliers_factor =</span> <span class="fl">0.1</span>) {</span>
<span id="cb4-8"><a href="#cb4-8"></a>  </span>
<span id="cb4-9"><a href="#cb4-9"></a>  pY1 <span class="ot">&lt;-</span> pY0 <span class="sc">+</span> risk_diff</span>
<span id="cb4-10"><a href="#cb4-10"></a>  pY_nc <span class="ot">&lt;-</span> pY_non_compliers_factor <span class="sc">*</span> pY0</span>
<span id="cb4-11"><a href="#cb4-11"></a>  </span>
<span id="cb4-12"><a href="#cb4-12"></a>  <span class="fu">set.seed</span>(seed)</span>
<span id="cb4-13"><a href="#cb4-13"></a>  data <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb4-14"><a href="#cb4-14"></a>    <span class="at">id =</span> <span class="dv">1</span><span class="sc">:</span>n,</span>
<span id="cb4-15"><a href="#cb4-15"></a>    <span class="co"># the underlying population can be stratified into </span></span>
<span id="cb4-16"><a href="#cb4-16"></a>    <span class="co"># never-takers and compliers</span></span>
<span id="cb4-17"><a href="#cb4-17"></a>    <span class="at">complier =</span> <span class="fu">rbinom</span>(n, <span class="dv">1</span>, <span class="at">prob =</span> p_compliers), </span>
<span id="cb4-18"><a href="#cb4-18"></a>    <span class="co"># generate individual potential outcomes</span></span>
<span id="cb4-19"><a href="#cb4-19"></a>    <span class="co"># under control and treatment, i.e., Pr[Y^0 = 1]</span></span>
<span id="cb4-20"><a href="#cb4-20"></a>    <span class="at">Y0 =</span> <span class="fu">case_when</span>(</span>
<span id="cb4-21"><a href="#cb4-21"></a>      complier <span class="sc">==</span> <span class="dv">0</span> <span class="sc">~</span> <span class="fu">rbinom</span>(n, <span class="dv">1</span>, pY_nc),</span>
<span id="cb4-22"><a href="#cb4-22"></a>      complier <span class="sc">==</span> <span class="dv">1</span> <span class="sc">~</span> <span class="fu">rbinom</span>(n, <span class="dv">1</span>, pY0),</span>
<span id="cb4-23"><a href="#cb4-23"></a>    ),</span>
<span id="cb4-24"><a href="#cb4-24"></a>    <span class="co"># assuming a constant effect of +10 percentage points</span></span>
<span id="cb4-25"><a href="#cb4-25"></a>    <span class="co"># among the compliers, and no average effect under the never-takers</span></span>
<span id="cb4-26"><a href="#cb4-26"></a>    <span class="at">Y1 =</span> <span class="fu">case_when</span>(</span>
<span id="cb4-27"><a href="#cb4-27"></a>      complier <span class="sc">==</span> <span class="dv">0</span> <span class="sc">~</span> <span class="fu">rbinom</span>(n, <span class="dv">1</span>, pY_nc),</span>
<span id="cb4-28"><a href="#cb4-28"></a>      complier <span class="sc">==</span> <span class="dv">1</span> <span class="sc">~</span> <span class="fu">rbinom</span>(n, <span class="dv">1</span>, pY1)</span>
<span id="cb4-29"><a href="#cb4-29"></a>    ), </span>
<span id="cb4-30"><a href="#cb4-30"></a>    <span class="co"># treatment assigned at random</span></span>
<span id="cb4-31"><a href="#cb4-31"></a>    <span class="co"># 70-30 split into treatment / control</span></span>
<span id="cb4-32"><a href="#cb4-32"></a>    <span class="at">Z =</span> <span class="fu">rbinom</span>(n, <span class="dv">1</span>, <span class="at">prob =</span> p_treatment),</span>
<span id="cb4-33"><a href="#cb4-33"></a>    <span class="co"># treatment uptake depends on </span></span>
<span id="cb4-34"><a href="#cb4-34"></a>    <span class="co"># being assigned to treatment (Z = 1)</span></span>
<span id="cb4-35"><a href="#cb4-35"></a>    <span class="co"># AND being a complier (C = 1)</span></span>
<span id="cb4-36"><a href="#cb4-36"></a>    <span class="at">A =</span> Z <span class="sc">*</span> complier,</span>
<span id="cb4-37"><a href="#cb4-37"></a>    <span class="co"># generate observed response using the </span></span>
<span id="cb4-38"><a href="#cb4-38"></a>    <span class="co"># consistency equation</span></span>
<span id="cb4-39"><a href="#cb4-39"></a>    <span class="at">Y =</span> (<span class="dv">1</span> <span class="sc">-</span> Z) <span class="sc">*</span> Y0 <span class="sc">+</span> Z <span class="sc">*</span> Y1</span>
<span id="cb4-40"><a href="#cb4-40"></a>  )</span>
<span id="cb4-41"><a href="#cb4-41"></a></span>
<span id="cb4-42"><a href="#cb4-42"></a>  <span class="fu">return</span>(data)</span>
<span id="cb4-43"><a href="#cb4-43"></a>}</span>
<span id="cb4-44"><a href="#cb4-44"></a></span>
<span id="cb4-45"><a href="#cb4-45"></a><span class="co"># creating these variables as they'll be helpful later on</span></span>
<span id="cb4-46"><a href="#cb4-46"></a><span class="co"># population size</span></span>
<span id="cb4-47"><a href="#cb4-47"></a>n <span class="ot">&lt;-</span> <span class="dv">100000</span>L</span>
<span id="cb4-48"><a href="#cb4-48"></a></span>
<span id="cb4-49"><a href="#cb4-49"></a><span class="co"># P[Y^0 = 1]</span></span>
<span id="cb4-50"><a href="#cb4-50"></a>pY0 <span class="ot">&lt;-</span> <span class="fl">0.01</span></span>
<span id="cb4-51"><a href="#cb4-51"></a><span class="co"># P[Y^1 = 1], ATE of +10 pct. pts.</span></span>
<span id="cb4-52"><a href="#cb4-52"></a>pY1 <span class="ot">&lt;-</span> pY0 <span class="sc">+</span> <span class="fl">0.1</span></span>
<span id="cb4-53"><a href="#cb4-53"></a></span>
<span id="cb4-54"><a href="#cb4-54"></a>data <span class="ot">&lt;-</span> <span class="fu">simulate_data</span>(<span class="at">n =</span> n, <span class="at">pY0 =</span> pY0, <span class="at">risk_diff =</span> <span class="fl">0.1</span>)</span>
<span id="cb4-55"><a href="#cb4-55"></a></span>
<span id="cb4-56"><a href="#cb4-56"></a><span class="fu">glimpse</span>(data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 100,000
Columns: 7
$ id       &lt;int&gt; 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18…
$ complier &lt;int&gt; 1, 1, 1, 1, 0, 1, 0, 0, 0, 0, 0, 1, 1, 1, 0, 1, 1, 1, 0, 1, 1…
$ Y0       &lt;int&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
$ Y1       &lt;int&gt; 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0…
$ Z        &lt;int&gt; 1, 1, 1, 0, 1, 0, 1, 1, 1, 1, 0, 1, 0, 1, 1, 1, 1, 1, 1, 0, 1…
$ A        &lt;int&gt; 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 1, 0, 1, 1, 1, 0, 0, 1…
$ Y        &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0…</code></pre>
</div>
</div>
<p>In this simulated dataset, we’ve got information on compliance and the potential outcome under each treatment at the individual level. However, from a real experiment, only the <span class="math inline">\(Z, A, Y\)</span> columns would be observed.</p>
<p>The <a href="https://magrittr.tidyverse.org/reference/exposition.html"><em>exposition pipe</em></a> <code>%$%</code> operator – similar to the pipe <code>%&gt;%</code> operator – is exported from the <em>magrittr</em> package and used with <code>base::table()</code> to expose the variables in the data frame to the table function to produce contingency tables.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1"></a><span class="fu">library</span>(magrittr, <span class="at">include.only =</span> <span class="st">"%$%"</span>)</span>
<span id="cb6-2"><a href="#cb6-2"></a></span>
<span id="cb6-3"><a href="#cb6-3"></a>data <span class="sc">%$%</span> </span>
<span id="cb6-4"><a href="#cb6-4"></a>  <span class="fu">table</span>(complier, Z) <span class="sc">%&gt;%</span> </span>
<span id="cb6-5"><a href="#cb6-5"></a>  <span class="fu">prop.table</span>(<span class="at">margin =</span> <span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>        Z
complier         0         1
       0 0.1974162 0.2003373
       1 0.8025838 0.7996627</code></pre>
</div>
</div>
<p>Since the treatment <span class="math inline">\(Z\)</span> is randomly assigned, the proportion of compliers in each group is nearly the same as expected.</p>
<p>There are several effects that can be estimated for this problem each with its own advantages and disadvantages.</p>
</section>
<section id="intention-to-treat-itt" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="intention-to-treat-itt">Intention-to-treat (ITT)</h2>
<p>The <em>intention-to-treat</em> (ITT) effect is the <em>effect of</em> <em>being assigned to the treatment</em> instead of the <em>effect of the treatment itself</em>. These are identical when treatment compliance / adherence is perfect, i.e, when all the individuals only take the treatment they are assigned to, but not otherwise.</p>
<p>For this problem, the ITT analysis would analyse individuals based on the group they were assigned to, and not the treatment they ultimately received. Those in the treatment group who didn’t see a single ad would be analysed as part of the treatment group rather than being excluded from the analysis, or being analysed as part of the control group.</p>
<p>An advantage of an ITT analysis is that randomization preserves the balance of confounders in both the treatment and control groups, so the <span class="math inline">\(Z-Y\)</span> association remains unconfounded and a valid, albeit conservative<a href="#fn5" class="footnote-ref" id="fnref5" role="doc-noteref"><sup>5</sup></a> effect of assigning the treatment at the population level. However, this validity would be affected<a href="#fn6" class="footnote-ref" id="fnref6" role="doc-noteref"><sup>6</sup></a> if this ad is rolled out to another target population – a different period in time, or another geographical location – with a different proportion of (non-)compliers<a href="#fn7" class="footnote-ref" id="fnref7" role="doc-noteref"><sup>7</sup></a>.</p>
<div class="no-row-height column-margin column-container"><p><sup>5</sup>&nbsp;Section 22.1 of the what-if book mentions that while the ITT estimate is usually conservative, it’s not guaranteed to be attenuated compared to the <em>per-protocol effect</em> (described in the next section) for <em>1)</em> <em>non-inferiority trials, or 2) if the per-protocol effect is not monotonic for all individuals and non-compliance is high</em>. It also lists other counterarguments (e.g., lack of transportability) against the ITT effect.</p><p><sup>6</sup>&nbsp;Rerunning the data simulation chunk above with <code>simulate_data(p_compliers = 0.4) %&gt;% mutate(diff = Y1 - Y0) %&gt;% pull(diff) %&gt;% mean()</code> instead of 0.8 leads to an ITT estimate of +4 instead of +8 percentage points, even though the effect of the treatment itself is still +10 percentage points.</p><p><sup>7</sup>&nbsp;For a garden-variety ad campaign, the proportion of compliers could be effectively random, unless the ad in question is visually appealing, or contentious. On the contrary, for something like a vaccine in a global pandemic, compliance could vary wildly between the trial and rollout at the population level. Source: reading internet discussions between 2021-2022.</p></div><section id="estimators-models" class="level3">
<h3 class="anchored" data-anchor-id="estimators-models">Estimators / models</h3>
<p>Since both <span class="math inline">\(Y\)</span> and <span class="math inline">\(Z\)</span> are binary variables, an estimate of the ITT effect can be obtained by fitting a simple logistic regression model, and using the <code>marginaleffects</code> package to perform <em>g-computation / (marginal / model-based) standardization</em> to get the risk difference (and the associated CIs)</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1"></a>data <span class="sc">%&gt;%</span> </span>
<span id="cb8-2"><a href="#cb8-2"></a>  <span class="fu">glm</span>(Y <span class="sc">~</span> Z, <span class="at">family =</span> <span class="fu">binomial</span>(<span class="at">link =</span> <span class="st">"logit"</span>), <span class="at">data =</span> .) <span class="sc">%&gt;%</span></span>
<span id="cb8-3"><a href="#cb8-3"></a>  marginaleffects<span class="sc">::</span><span class="fu">avg_comparisons</span>(<span class="at">variables =</span> <span class="st">"Z"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
 Term Contrast Estimate Std. Error  z Pr(&gt;|z|)   S  2.5 % 97.5 %
    Z    1 - 0   0.0807     0.0012 67   &lt;0.001 Inf 0.0783  0.083

Columns: term, contrast, estimate, std.error, statistic, p.value, s.value, conf.low, conf.high </code></pre>
</div>
</div>
<p>or by fitting an <em>identity-link logistic regression</em> where the estimated coefficient for <span class="math inline">\(Z\)</span> can be directly interpreted as the risk difference</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1"></a>data <span class="sc">%&gt;%</span> </span>
<span id="cb10-2"><a href="#cb10-2"></a>  <span class="fu">glm</span>(Y <span class="sc">~</span> Z, <span class="at">family =</span> <span class="fu">binomial</span>(<span class="at">link =</span> <span class="st">"identity"</span>), <span class="at">data =</span> .) <span class="sc">%&gt;%</span> </span>
<span id="cb10-3"><a href="#cb10-3"></a>  broom<span class="sc">::</span><span class="fu">tidy</span>(<span class="at">conf.int =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb10-4"><a href="#cb10-4"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="at">.cols =</span> <span class="fu">where</span>(is.numeric), <span class="at">.fns =</span> <span class="sc">~</span> <span class="fu">round</span>(.x, <span class="dv">4</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 × 7
  term        estimate std.error statistic p.value conf.low conf.high
  &lt;chr&gt;          &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;   &lt;dbl&gt;    &lt;dbl&gt;     &lt;dbl&gt;
1 (Intercept)   0.0087    0.0005      16.2       0   0.0077    0.0098
2 Z             0.0807    0.0012      67.0       0   0.0783    0.083 </code></pre>
</div>
</div>
<p>The use of glm + g-computation here is a bit overkill, as the same estimate can be obtained by looking at the 2x2 table of proportions scaled to sum to 1 within each column</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1"></a>data <span class="sc">%$%</span></span>
<span id="cb12-2"><a href="#cb12-2"></a>  <span class="fu">table</span>(Y, Z) <span class="sc">%&gt;%</span> </span>
<span id="cb12-3"><a href="#cb12-3"></a>  <span class="fu">print</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb12-4"><a href="#cb12-4"></a>  <span class="fu">prop.table</span>(<span class="at">margin =</span> <span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   Z
Y       0     1
  0 29772 63715
  1   261  6252</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>   Z
Y             0           1
  0 0.991309559 0.910643589
  1 0.008690441 0.089356411</code></pre>
</div>
</div>
<p>and taking the difference of <span class="math inline">\(P[Y = 1 | Z]\)</span> in the two groups to give the risk difference <span class="math inline">\(\hat{p}_1 - \hat{p}_0\)</span>, where <span class="math inline">\(\hat{p}_0 = \text{Pr}[Y = 1 | Z = 0]\)</span> and <span class="math inline">\(\hat{p}_1 = \text{Pr}[Y = 1 | Z = 1]\)</span></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1"></a><span class="fu">round</span>(<span class="fl">0.089356411</span> <span class="sc">-</span> <span class="fl">0.008690441</span>, <span class="dv">4</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.0807</code></pre>
</div>
</div>
<p>Additionally, a wald-type CI can be obtained using the formula for variance mentioned (using counts) <a href="https://en.wikipedia.org/wiki/Risk_difference">here</a> or (using proportions) <a href="https://sphweb.bumc.bu.edu/otlt/mph-modules/bs/bs704_confidence_intervals/bs704_confidence_intervals7.html">here</a></p>
<p><span class="math display">\[
SE(\hat{p}_1 - \hat{p}_0) = \sqrt{\frac{\hat{p}_0 (1 - \hat{p}_0)}{n_0} + \frac{\hat{p}_1 (1 - \hat{p}_1)}{n_1}}
\]</span></p>
<p>which results in the same standard error</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1"></a>var_p0 <span class="ot">&lt;-</span> (<span class="fl">0.008690441</span> <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">-</span> <span class="fl">0.008690441</span>)) <span class="sc">/</span> (<span class="dv">261</span> <span class="sc">+</span> <span class="dv">29772</span>)</span>
<span id="cb17-2"><a href="#cb17-2"></a>var_p1 <span class="ot">&lt;-</span> (<span class="fl">0.089356411</span> <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">-</span> <span class="fl">0.089356411</span>)) <span class="sc">/</span> (<span class="dv">6252</span> <span class="sc">+</span> <span class="dv">63715</span>)</span>
<span id="cb17-3"><a href="#cb17-3"></a></span>
<span id="cb17-4"><a href="#cb17-4"></a><span class="fu">round</span>(<span class="fu">sqrt</span>(<span class="fu">sum</span>(var_p0, var_p1)), <span class="at">digits =</span> <span class="dv">4</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.0012</code></pre>
</div>
</div>
<p><a href="https://academic.oup.com/aje/article/189/6/508/5812650">This paper</a> mentions other ways of estimating the risk difference from different models, e.g.&nbsp;linear regression + sandwich estimator for the standard errors, which are again identical to the ones from the other methods above</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1"></a>lm_mod <span class="ot">&lt;-</span> <span class="fu">lm</span>(Y <span class="sc">~</span> Z, <span class="at">data =</span> data) </span>
<span id="cb19-2"><a href="#cb19-2"></a></span>
<span id="cb19-3"><a href="#cb19-3"></a>lm_mod <span class="sc">%&gt;%</span> </span>
<span id="cb19-4"><a href="#cb19-4"></a>  broom<span class="sc">::</span><span class="fu">tidy</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb19-5"><a href="#cb19-5"></a>  <span class="fu">select</span>(term, estimate, <span class="at">model_SE =</span> std.error) <span class="sc">%&gt;%</span> </span>
<span id="cb19-6"><a href="#cb19-6"></a>  <span class="fu">mutate</span>(<span class="at">robust_SE =</span> <span class="fu">sqrt</span>(<span class="fu">diag</span>(sandwich<span class="sc">::</span><span class="fu">vcovHC</span>(lm_mod))))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 × 4
  term        estimate model_SE robust_SE
  &lt;chr&gt;          &lt;dbl&gt;    &lt;dbl&gt;     &lt;dbl&gt;
1 (Intercept)  0.00869  0.00141  0.000536
2 Z            0.0807   0.00168  0.00120 </code></pre>
</div>
</div>
<p>However, getting a distribution of this effect as opposed to just a 95% CI can be more informative from a decision making point of view. This distribution can be obtained three ways – 1) plugging the estimate and its standard error into a normal distribution and simulating effect sizes from that; 2) using the (nonparametric) bootstrap to resample the data and getting the bootstrap distribution of effect sizes; 3) using a Bayesian model to get the posterior distributions of the parameters from the model.</p>
<p>For the rest of the analyses, I pick option 3, where the simple (Bayesian) <a href="https://en.wikipedia.org/wiki/Beta-binomial_distribution#Beta-binomial_in_Bayesian_statistics"><em>Beta-Binomial</em> model</a> is fit to this data separately within the treatment and the control groups. Taking the difference of these two (Beta) posterior distributions produces the posterior distribution of the risk difference. The <code>bayesAB</code> package in R can quickly fit Beta-Binomial models, or the <code>brms</code> package can be used for more general models.</p>
</section>
<section id="back-to-itt-analysis" class="level3 page-columns page-full">
<h3 class="anchored" data-anchor-id="back-to-itt-analysis">Back to ITT analysis</h3>
<p>A <span class="math inline">\(\text{Beta}(\alpha = 1, \beta = 9)\)</span> prior is specified for the probability of success in each arm reflecting the knowledge that the we can expect the conversion in each group to be somewhere between 0%-70%. Normally this depends on the product in question – expensive and / or infrequently bought products are not expected to lead to very large conversion rates.</p>
<p>The following shows a summary of 10,000 draws from the prior distribution for the parameters</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1"></a><span class="fu">summary</span>(<span class="fu">rbeta</span>(<span class="fl">1e5</span>, <span class="dv">1</span>, <span class="dv">9</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     Min.   1st Qu.    Median      Mean   3rd Qu.      Max. 
0.0000017 0.0313705 0.0740948 0.1002186 0.1430362 0.7405391 </code></pre>
</div>
</div>
<p>which implies the following prior distribution for the risk difference</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1"></a><span class="fu">summary</span>(<span class="fu">rbeta</span>(<span class="fl">1e5</span>, <span class="dv">1</span>, <span class="dv">9</span>) <span class="sc">-</span> <span class="fu">rbeta</span>(<span class="fl">1e5</span>, <span class="dv">1</span>, <span class="dv">9</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>      Min.    1st Qu.     Median       Mean    3rd Qu.       Max. 
-0.6858270 -0.0709874 -0.0000165  0.0000020  0.0699090  0.6885754 </code></pre>
</div>
</div>
<p>A priori, we expect the difference to be pretty small with mean of close to 0, but allowing for large differences of +/- 60-70%. We can also visualize these distributions</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1"></a><span class="fu">bind_rows</span>(</span>
<span id="cb25-2"><a href="#cb25-2"></a>  <span class="fu">tibble</span>(<span class="at">x =</span> <span class="fu">rbeta</span>(<span class="fl">1e5</span>, <span class="dv">1</span>, <span class="dv">9</span>), <span class="at">cat =</span> <span class="st">"Prior conversion probability"</span>), </span>
<span id="cb25-3"><a href="#cb25-3"></a>  <span class="fu">tibble</span>(<span class="at">x =</span> <span class="fu">rbeta</span>(<span class="fl">1e5</span>, <span class="dv">1</span>, <span class="dv">9</span>) <span class="sc">-</span> <span class="fu">rbeta</span>(<span class="fl">1e5</span>, <span class="dv">1</span>, <span class="dv">9</span>), </span>
<span id="cb25-4"><a href="#cb25-4"></a>         <span class="at">cat =</span> <span class="st">"Prior risk difference"</span>)</span>
<span id="cb25-5"><a href="#cb25-5"></a>) <span class="sc">%&gt;%</span> </span>
<span id="cb25-6"><a href="#cb25-6"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">group =</span> cat, <span class="at">color =</span> cat)) <span class="sc">+</span> </span>
<span id="cb25-7"><a href="#cb25-7"></a>  <span class="fu">geom_density</span>() <span class="sc">+</span> </span>
<span id="cb25-8"><a href="#cb25-8"></a>  <span class="fu">theme_classic</span>() <span class="sc">+</span> </span>
<span id="cb25-9"><a href="#cb25-9"></a>  <span class="fu">xlab</span>(<span class="st">""</span>) <span class="sc">+</span> </span>
<span id="cb25-10"><a href="#cb25-10"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">labels =</span> scales<span class="sc">::</span>percent) <span class="sc">+</span></span>
<span id="cb25-11"><a href="#cb25-11"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> cat, <span class="at">scales =</span> <span class="st">"free"</span>) <span class="sc">+</span> </span>
<span id="cb25-12"><a href="#cb25-12"></a>  <span class="fu">guides</span>(<span class="at">color =</span> <span class="st">"none"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-13-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>To get the posterior distribution for conversion in each arm, the counts from the 2x2 contingency table can be plugged into the formula for Beta posterior distribution <span class="math inline">\(\text{Beta}(y + \alpha, n - y + \beta)\)</span>, where <span class="math inline">\(y\)</span> corresponds to the count for <span class="math inline">\(Y = 1\)</span>, and <span class="math inline">\(n-y\)</span> for <span class="math inline">\(Y = 0\)</span>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1"></a>data <span class="sc">%$%</span> <span class="fu">table</span>(Y, Z)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   Z
Y       0     1
  0 29772 63715
  1   261  6252</code></pre>
</div>
</div>
<p>This gives <span class="math inline">\(p (\alpha_0, \beta_0|y) \sim \text{Beta}(261 + 1, 29772 + 9) = \text{Beta}(262, 29781)\)</span> for the control group, and <span class="math inline">\(p (\alpha_1, \beta_1|y) \sim \text{Beta}(6252 + 1, 63715 + 9) = \text{Beta}(6253, 63724)\)</span> for the treatment group, visualized as follows</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1"></a>posterior_categories <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb28-2"><a href="#cb28-2"></a>  <span class="st">"Conversion probability </span><span class="sc">\n</span><span class="st">(control group)"</span>, </span>
<span id="cb28-3"><a href="#cb28-3"></a>  <span class="st">"Conversion probability </span><span class="sc">\n</span><span class="st">(treatment group)"</span>,</span>
<span id="cb28-4"><a href="#cb28-4"></a>  <span class="st">"Risk difference"</span></span>
<span id="cb28-5"><a href="#cb28-5"></a>)</span>
<span id="cb28-6"><a href="#cb28-6"></a></span>
<span id="cb28-7"><a href="#cb28-7"></a>sample_from_beta_posterior <span class="ot">&lt;-</span> <span class="cf">function</span>(theta_0, theta_1, </span>
<span id="cb28-8"><a href="#cb28-8"></a>                                       <span class="at">seed =</span> <span class="dv">23</span>, <span class="at">n_samples =</span> <span class="fl">1e5</span>) {</span>
<span id="cb28-9"><a href="#cb28-9"></a>  <span class="fu">set.seed</span>(seed)</span>
<span id="cb28-10"><a href="#cb28-10"></a>  posterior_control <span class="ot">&lt;-</span> <span class="fu">rbeta</span>(n_samples, theta_0[<span class="dv">1</span>], theta_0[<span class="dv">2</span>])</span>
<span id="cb28-11"><a href="#cb28-11"></a>  posterior_treatment <span class="ot">&lt;-</span> <span class="fu">rbeta</span>(n_samples, theta_1[<span class="dv">1</span>], theta_1[<span class="dv">2</span>])</span>
<span id="cb28-12"><a href="#cb28-12"></a>  risk_difference <span class="ot">&lt;-</span> posterior_treatment <span class="sc">-</span> posterior_control</span>
<span id="cb28-13"><a href="#cb28-13"></a>  </span>
<span id="cb28-14"><a href="#cb28-14"></a>  <span class="fu">tibble</span>(</span>
<span id="cb28-15"><a href="#cb28-15"></a>    <span class="at">id =</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span>n_samples, <span class="at">times =</span> <span class="dv">3</span>),</span>
<span id="cb28-16"><a href="#cb28-16"></a>    <span class="at">cat =</span> <span class="fu">rep</span>(posterior_categories, <span class="at">each =</span> n_samples),</span>
<span id="cb28-17"><a href="#cb28-17"></a>    <span class="at">x =</span> <span class="fu">c</span>(posterior_control, posterior_treatment, risk_difference)</span>
<span id="cb28-18"><a href="#cb28-18"></a>  )</span>
<span id="cb28-19"><a href="#cb28-19"></a>}</span>
<span id="cb28-20"><a href="#cb28-20"></a></span>
<span id="cb28-21"><a href="#cb28-21"></a>true_effect <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb28-22"><a href="#cb28-22"></a>  <span class="at">x =</span> <span class="fu">c</span>(<span class="cn">NA_real_</span>, <span class="cn">NA_real_</span>, pY1 <span class="sc">-</span> pY0), </span>
<span id="cb28-23"><a href="#cb28-23"></a>  <span class="at">cat =</span> posterior_categories</span>
<span id="cb28-24"><a href="#cb28-24"></a>)</span>
<span id="cb28-25"><a href="#cb28-25"></a></span>
<span id="cb28-26"><a href="#cb28-26"></a>plot_posteriors <span class="ot">&lt;-</span> <span class="cf">function</span>(posterior, <span class="at">effect =</span> true_effect) {</span>
<span id="cb28-27"><a href="#cb28-27"></a>  posterior <span class="sc">%&gt;%</span> </span>
<span id="cb28-28"><a href="#cb28-28"></a>    <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">group =</span> cat, <span class="at">color =</span> cat)) <span class="sc">+</span> </span>
<span id="cb28-29"><a href="#cb28-29"></a>    <span class="fu">geom_density</span>(<span class="at">trim =</span> <span class="cn">TRUE</span>) <span class="sc">+</span> </span>
<span id="cb28-30"><a href="#cb28-30"></a>    <span class="fu">geom_vline</span>(<span class="at">data =</span> effect, </span>
<span id="cb28-31"><a href="#cb28-31"></a>               <span class="fu">aes</span>(<span class="at">xintercept =</span> x), </span>
<span id="cb28-32"><a href="#cb28-32"></a>               <span class="at">color =</span> <span class="st">"gold3"</span>, </span>
<span id="cb28-33"><a href="#cb28-33"></a>               <span class="at">linetype =</span> <span class="st">"dashed"</span>,</span>
<span id="cb28-34"><a href="#cb28-34"></a>               <span class="at">linewidth =</span> <span class="fl">1.3</span>,</span>
<span id="cb28-35"><a href="#cb28-35"></a>               <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">+</span> </span>
<span id="cb28-36"><a href="#cb28-36"></a>    <span class="fu">theme_classic</span>() <span class="sc">+</span> </span>
<span id="cb28-37"><a href="#cb28-37"></a>    <span class="fu">theme</span>(<span class="at">plot.margin =</span> <span class="fu">margin</span>(<span class="fl">0.5</span>, <span class="fl">0.5</span>, <span class="fl">0.5</span>, <span class="fl">0.5</span>, <span class="st">"cm"</span>)) <span class="sc">+</span> </span>
<span id="cb28-38"><a href="#cb28-38"></a>    <span class="fu">xlab</span>(<span class="st">"Posterior distribution"</span>) <span class="sc">+</span> </span>
<span id="cb28-39"><a href="#cb28-39"></a>    <span class="fu">scale_x_continuous</span>(<span class="at">labels =</span> scales<span class="sc">::</span><span class="fu">label_percent</span>(<span class="at">accuracy =</span> <span class="fl">0.1</span>)) <span class="sc">+</span></span>
<span id="cb28-40"><a href="#cb28-40"></a>    <span class="fu">facet_wrap</span>(<span class="sc">~</span> cat, <span class="at">scales =</span> <span class="st">"free"</span>, <span class="at">ncol =</span> <span class="dv">3</span>) <span class="sc">+</span> </span>
<span id="cb28-41"><a href="#cb28-41"></a>    <span class="fu">guides</span>(<span class="at">color =</span> <span class="st">"none"</span>)</span>
<span id="cb28-42"><a href="#cb28-42"></a>}</span>
<span id="cb28-43"><a href="#cb28-43"></a></span>
<span id="cb28-44"><a href="#cb28-44"></a>ITT_posterior <span class="ot">&lt;-</span> <span class="fu">sample_from_beta_posterior</span>(</span>
<span id="cb28-45"><a href="#cb28-45"></a>  <span class="at">theta_0 =</span> <span class="fu">c</span>(<span class="dv">262</span>, <span class="dv">29781</span>), <span class="at">theta_1 =</span> <span class="fu">c</span>(<span class="dv">6253</span>, <span class="dv">63724</span>)</span>
<span id="cb28-46"><a href="#cb28-46"></a>)</span>
<span id="cb28-47"><a href="#cb28-47"></a></span>
<span id="cb28-48"><a href="#cb28-48"></a><span class="fu">plot_posteriors</span>(ITT_posterior)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-15-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The posterior for the risk difference completely fails to capture the underlying true effect size of +10 percentage points. However, since the dataset is simulated with the potential outcomes <span class="math inline">\(\{Y_{i}^{z = 0},\ Y_{i}^{z = 1}\}\)</span> at the individual level, we can see that the estimate of +8 percentage points is correct for <em>this population</em>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1"></a>true_ITT_effect <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span> </span>
<span id="cb29-2"><a href="#cb29-2"></a>  <span class="fu">mutate</span>(<span class="at">diff =</span> Y1 <span class="sc">-</span> Y0) <span class="sc">%&gt;%</span> </span>
<span id="cb29-3"><a href="#cb29-3"></a>  <span class="fu">pull</span>(diff) <span class="sc">%&gt;%</span> </span>
<span id="cb29-4"><a href="#cb29-4"></a>  <span class="fu">mean</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb29-5"><a href="#cb29-5"></a>  <span class="fu">print</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.08069</code></pre>
</div>
</div>
<p>The posterior distribution is summarized via the posterior mean, mode, and 95% (equal-tailed) credible intervals, which are nearly identical to the ones above.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1"></a>ITT_risk_difference <span class="ot">&lt;-</span> ITT_posterior <span class="sc">%&gt;%</span> </span>
<span id="cb31-2"><a href="#cb31-2"></a>  <span class="fu">filter</span>(cat <span class="sc">==</span> <span class="st">"Risk difference"</span>) </span>
<span id="cb31-3"><a href="#cb31-3"></a></span>
<span id="cb31-4"><a href="#cb31-4"></a><span class="co"># get the posterior density to find the mode</span></span>
<span id="cb31-5"><a href="#cb31-5"></a><span class="co"># based on this SE answer: </span></span>
<span id="cb31-6"><a href="#cb31-6"></a><span class="co"># https://stackoverflow.com/a/13874750</span></span>
<span id="cb31-7"><a href="#cb31-7"></a>ITT_risk_difference_density <span class="ot">&lt;-</span> <span class="fu">density</span>(ITT_risk_difference<span class="sc">$</span>x)</span>
<span id="cb31-8"><a href="#cb31-8"></a>ITT_risk_difference_mode <span class="ot">&lt;-</span> ITT_risk_difference_density<span class="sc">$</span>x[<span class="fu">which.max</span>(ITT_risk_difference_density<span class="sc">$</span>y)]</span>
<span id="cb31-9"><a href="#cb31-9"></a></span>
<span id="cb31-10"><a href="#cb31-10"></a>ITT_risk_difference <span class="sc">%&gt;%</span> </span>
<span id="cb31-11"><a href="#cb31-11"></a>  <span class="fu">summarize</span>(</span>
<span id="cb31-12"><a href="#cb31-12"></a>    <span class="at">mean =</span> <span class="fu">mean</span>(x), </span>
<span id="cb31-13"><a href="#cb31-13"></a>    <span class="at">lower =</span> <span class="fu">quantile</span>(x, <span class="at">probs =</span> <span class="fl">0.025</span>),</span>
<span id="cb31-14"><a href="#cb31-14"></a>    <span class="at">upper =</span> <span class="fu">quantile</span>(x, <span class="at">probs =</span> <span class="fl">0.975</span>)</span>
<span id="cb31-15"><a href="#cb31-15"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb31-16"><a href="#cb31-16"></a>  <span class="fu">mutate</span>(<span class="at">mode =</span> ITT_risk_difference_mode, <span class="at">.after =</span> mean)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 4
    mean   mode  lower  upper
   &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;
1 0.0806 0.0808 0.0783 0.0830</code></pre>
</div>
</div>
<p>Just for fun, the Bayesian posterior distribution is visually compared to the normal approximation and the bootstrap distribution for the risk difference</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1"></a>boot_ITT_fun <span class="ot">&lt;-</span> <span class="cf">function</span>(data, indx, ...) {</span>
<span id="cb33-2"><a href="#cb33-2"></a>  data <span class="ot">&lt;-</span> data[indx, ]</span>
<span id="cb33-3"><a href="#cb33-3"></a>  data <span class="sc">%&gt;%</span> </span>
<span id="cb33-4"><a href="#cb33-4"></a>    <span class="fu">count</span>(Z, Y) <span class="sc">%&gt;%</span> </span>
<span id="cb33-5"><a href="#cb33-5"></a>    <span class="co"># get P[Y = 1] within levels of Z</span></span>
<span id="cb33-6"><a href="#cb33-6"></a>    <span class="fu">group_by</span>(Z) <span class="sc">%&gt;%</span> </span>
<span id="cb33-7"><a href="#cb33-7"></a>    <span class="fu">mutate</span>(<span class="at">p =</span> n <span class="sc">/</span> <span class="fu">sum</span>(n)) <span class="sc">%&gt;%</span> </span>
<span id="cb33-8"><a href="#cb33-8"></a>    <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb33-9"><a href="#cb33-9"></a>    <span class="co"># only keep P[Y = 1 | Z]</span></span>
<span id="cb33-10"><a href="#cb33-10"></a>    <span class="fu">filter</span>(Y <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb33-11"><a href="#cb33-11"></a>    <span class="fu">pull</span>(p) <span class="sc">%&gt;%</span> </span>
<span id="cb33-12"><a href="#cb33-12"></a>    <span class="co"># get |p1 - p0|</span></span>
<span id="cb33-13"><a href="#cb33-13"></a>    <span class="fu">reduce</span>(<span class="at">.f =</span> <span class="st">`</span><span class="at">-</span><span class="st">`</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb33-14"><a href="#cb33-14"></a>    <span class="fu">abs</span>()</span>
<span id="cb33-15"><a href="#cb33-15"></a>} </span>
<span id="cb33-16"><a href="#cb33-16"></a></span>
<span id="cb33-17"><a href="#cb33-17"></a>ITT_boot <span class="ot">&lt;-</span> boot<span class="sc">::</span><span class="fu">boot</span>(<span class="at">data =</span> data, </span>
<span id="cb33-18"><a href="#cb33-18"></a>                       <span class="at">statistic =</span> boot_ITT_fun, </span>
<span id="cb33-19"><a href="#cb33-19"></a>                       <span class="at">R =</span> <span class="dv">999</span>, </span>
<span id="cb33-20"><a href="#cb33-20"></a>                       <span class="co"># multicore only works on linux</span></span>
<span id="cb33-21"><a href="#cb33-21"></a>                       <span class="at">parallel =</span> <span class="st">"multicore"</span>)</span>
<span id="cb33-22"><a href="#cb33-22"></a></span>
<span id="cb33-23"><a href="#cb33-23"></a><span class="co"># plot the three distributions</span></span>
<span id="cb33-24"><a href="#cb33-24"></a><span class="fu">set.seed</span>(<span class="dv">23</span>)</span>
<span id="cb33-25"><a href="#cb33-25"></a><span class="fu">bind_rows</span>(</span>
<span id="cb33-26"><a href="#cb33-26"></a>  <span class="fu">tibble</span>(<span class="at">x =</span> <span class="fu">rnorm</span>(<span class="dv">999</span>, <span class="fl">0.0807</span>, <span class="fl">0.0012</span>), <span class="at">y =</span> <span class="st">"Normal approximation"</span>), </span>
<span id="cb33-27"><a href="#cb33-27"></a>  <span class="fu">tibble</span>(<span class="at">x =</span> ITT_boot<span class="sc">$</span>t[, <span class="dv">1</span>], <span class="at">y =</span> <span class="st">"Bootstrap distribution"</span>), </span>
<span id="cb33-28"><a href="#cb33-28"></a>  ITT_posterior <span class="sc">%&gt;%</span> </span>
<span id="cb33-29"><a href="#cb33-29"></a>    <span class="fu">filter</span>(cat <span class="sc">==</span> <span class="st">"Risk difference"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb33-30"><a href="#cb33-30"></a>    <span class="fu">rename</span>(<span class="at">y =</span> cat) <span class="sc">%&gt;%</span> </span>
<span id="cb33-31"><a href="#cb33-31"></a>    <span class="fu">slice_sample</span>(<span class="at">n =</span> <span class="dv">999</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb33-32"><a href="#cb33-32"></a>    <span class="fu">mutate</span>(<span class="at">y =</span> <span class="st">"Beta posterior"</span>)</span>
<span id="cb33-33"><a href="#cb33-33"></a>) <span class="sc">%&gt;%</span> </span>
<span id="cb33-34"><a href="#cb33-34"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> y, <span class="at">group =</span> y, <span class="at">fill =</span> y)) <span class="sc">+</span> </span>
<span id="cb33-35"><a href="#cb33-35"></a>  ggdist<span class="sc">::</span><span class="fu">stat_halfeye</span>() <span class="sc">+</span></span>
<span id="cb33-36"><a href="#cb33-36"></a>  <span class="fu">theme_classic</span>() <span class="sc">+</span> </span>
<span id="cb33-37"><a href="#cb33-37"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>, </span>
<span id="cb33-38"><a href="#cb33-38"></a>        <span class="at">plot.margin =</span> <span class="fu">margin</span>(<span class="fl">0.5</span>, <span class="fl">0.5</span>, <span class="fl">0.5</span>, <span class="fl">0.5</span>, <span class="st">"cm"</span>)) <span class="sc">+</span> </span>
<span id="cb33-39"><a href="#cb33-39"></a>  <span class="fu">xlab</span>(<span class="st">"Distribution of risk difference / uplift (999 samples)"</span>) <span class="sc">+</span> </span>
<span id="cb33-40"><a href="#cb33-40"></a>  <span class="fu">ylab</span>(<span class="st">""</span>) <span class="sc">+</span> </span>
<span id="cb33-41"><a href="#cb33-41"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">labels =</span> scales<span class="sc">::</span><span class="fu">label_percent</span>(<span class="at">accuracy =</span> <span class="fl">0.1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-18-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>As expected, despite being philosophically different, all of these methods give nearly identical results (increasing the samples from 999 to 100,000<a href="#fn8" class="footnote-ref" id="fnref8" role="doc-noteref"><sup>8</sup></a> would lead to them being virtually identical), but all of these underestimate the correct treatment effect of +10 percentage points.</p>
<div class="no-row-height column-margin column-container"><p><sup>8</sup>&nbsp;Using the boot package here complains about memory issues when trying to set R = 100,000, and I’m too lazy to write a (parallel) map here myself.</p></div></section>
</section>
<section id="per-protocol-pp" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="per-protocol-pp">Per-protocol (PP)</h2>
<p>The <em>per-protocol</em> (PP) effect is generated by including all the people who adhere to the <em>protocol</em>, i.e., those with treatment status <span class="math inline">\(A\)</span> identical to the assignment treatment <span class="math inline">\(Z\)</span>. Contrary to the ITT effect from the previous section, this effect is a measure of the effectiveness of the actual treatment itself, although this effect estimate is prone to bias.</p>
<p>Since it’s not possible for us to measure<a href="#fn9" class="footnote-ref" id="fnref9" role="doc-noteref"><sup>9</sup></a> an individual seeing an ad if they were assigned to the control group, i.e, individuals with <span class="math inline">\(Z = 0, A = 1\)</span>, this would only exclude all the individuals with <span class="math inline">\(Z = 1\)</span> and <span class="math inline">\(A = 0\)</span>, i.e., about 14,000 individuals from the treatment group who didn’t see an ad.</p>
<div class="no-row-height column-margin column-container"><p><sup>9</sup>&nbsp;An individual in the control group cannot see an ad, if the ad is not shown to the individual.</p></div><div class="cell">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1"></a>data <span class="sc">%$%</span> <span class="fu">table</span>(A, Z)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   Z
A       0     1
  0 30033 14017
  1     0 55950</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1"></a>data <span class="sc">%&gt;%</span> <span class="fu">filter</span>(A <span class="sc">==</span> Z) <span class="sc">%$%</span> <span class="fu">table</span>(A, Z)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   Z
A       0     1
  0 30033     0
  1     0 55950</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1"></a>data <span class="sc">%&gt;%</span> </span>
<span id="cb38-2"><a href="#cb38-2"></a>  <span class="co"># only restrict analysis to those with perfect adherence / compliance</span></span>
<span id="cb38-3"><a href="#cb38-3"></a>  <span class="fu">filter</span>(A <span class="sc">==</span> Z) <span class="sc">%$%</span> </span>
<span id="cb38-4"><a href="#cb38-4"></a>  <span class="fu">table</span>(Y, A) <span class="sc">%&gt;%</span> </span>
<span id="cb38-5"><a href="#cb38-5"></a>  <span class="fu">print</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb38-6"><a href="#cb38-6"></a>  <span class="fu">sum</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   A
Y       0     1
  0 29772 49716
  1   261  6234</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 85983</code></pre>
</div>
</div>
<p>SImilar to the previous section, the posterior probability of success / conversion and the risk difference for the PP analysis can be obtained by using the same beta-binomial model from the previous section and visually assessed</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1"></a>PP_posterior <span class="ot">&lt;-</span> <span class="fu">sample_from_beta_posterior</span>(</span>
<span id="cb41-2"><a href="#cb41-2"></a>  <span class="at">theta_0 =</span> <span class="fu">c</span>(<span class="dv">261</span> <span class="sc">+</span> <span class="dv">1</span>, <span class="dv">29772</span> <span class="sc">+</span> <span class="dv">9</span>), </span>
<span id="cb41-3"><a href="#cb41-3"></a>  <span class="at">theta_1 =</span> <span class="fu">c</span>(<span class="dv">6234</span> <span class="sc">+</span> <span class="dv">1</span>, <span class="dv">49716</span> <span class="sc">+</span> <span class="dv">9</span>)</span>
<span id="cb41-4"><a href="#cb41-4"></a>)</span>
<span id="cb41-5"><a href="#cb41-5"></a></span>
<span id="cb41-6"><a href="#cb41-6"></a><span class="fu">plot_posteriors</span>(PP_posterior)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-22-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The PP effect is exaggerated – albeit by a relatively small margin – compared to both the ITT effect and the true treatment effect of +10 percentage points.</p>
</section>
<section id="as-treated-at" class="level2">
<h2 class="anchored" data-anchor-id="as-treated-at">As-treated (AT)</h2>
<p>The <em>as-treated</em> effect (AT) estimates the effect of analyzing individuals by treatment received. This analysis includes individuals in the group corresponding to the treatment actually received. So the individuals randomized to the treatment group who did not see an ad are included in the control group.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1"></a>data <span class="sc">%$%</span> <span class="fu">table</span>(Y, A)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   A
Y       0     1
  0 43771 49716
  1   279  6234</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1"></a>AT_posterior <span class="ot">&lt;-</span> <span class="fu">sample_from_beta_posterior</span>(</span>
<span id="cb44-2"><a href="#cb44-2"></a>  <span class="at">theta_0 =</span> <span class="fu">c</span>(<span class="dv">279</span> <span class="sc">+</span> <span class="dv">1</span>, <span class="dv">43771</span> <span class="sc">+</span> <span class="dv">9</span>), </span>
<span id="cb44-3"><a href="#cb44-3"></a>  <span class="at">theta_1 =</span> <span class="fu">c</span>(<span class="dv">6234</span> <span class="sc">+</span> <span class="dv">1</span>, <span class="dv">49716</span> <span class="sc">+</span> <span class="dv">9</span>)</span>
<span id="cb44-4"><a href="#cb44-4"></a>)</span>
<span id="cb44-5"><a href="#cb44-5"></a></span>
<span id="cb44-6"><a href="#cb44-6"></a><span class="fu">plot_posteriors</span>(AT_posterior)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-24-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Like the PP effect, this effect is a measure of the effectiveness of the actual treatment itself. By including the untreated from the treatment group – who had a lower probability of conversion – into the control group, the overall conversion probability in the control group is attenuated thereby leading to an exaggeration of the ATE. Thus, it overestimates the true effect and is likewise exaggerated compared to the ITT effect estimate. It is similarly prone to bias.</p>
<p>We’ve produced three estimates so far, and since we know the true effect of treatment here, we can see that they’re all biased. Great! The analysis could stop here and all the three estimates could be presented with their respective caveats.</p>
<p>But can we do better (in this experiment)?</p>
</section>
<section id="instrumental-variable-analysis-iv" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="instrumental-variable-analysis-iv">Instrumental variable analysis (IV)</h2>
<p>The fourth and final method of analysis looks at the method of <em>instrumental variables</em>. Causal estimates for the treatment effect can be obtained by using just the three variables <span class="math inline">\(\{Z, A, Y\}\)</span> if the assumptions behind this method are plausible for our (fictional) ad campaign.</p>
<p>For an instrumental variable analysis to be valid, we need an <em>instrument</em> (say <span class="math inline">\(Z\)</span>) that needs to satisfy the first three conditions and at least the fourth or the fifth condition</p>
<ul>
<li><p><em>Relevance condition</em> – Be correlated (hopefully strongly) with the treatment variable (in our case <span class="math inline">\(A\)</span>)</p></li>
<li><p><em>Ignorability -</em> Be uncorrelated with all measured and unmeasured confounders (<span class="math inline">\(U\)</span>) of the <span class="math inline">\(A \rightarrow Y\)</span> relationship and share no common causes with <span class="math inline">\(Y\)</span></p></li>
<li><p><em>Exclusion restriction</em> – have no direct impact on the outcome <span class="math inline">\(Y\)</span>, only an indirect effect entirely mediated via the treatment <span class="math inline">\(A\)</span></p></li>
<li><p><em>(Weak) Homogeneity</em> – for a binary <span class="math inline">\(Z-A\)</span> system, if <span class="math inline">\(Z\)</span> is not an <em>effect modifier</em> of the <span class="math inline">\(A-Y\)</span> relationship, i.e.,<br>
<span class="math inline">\(\mathbb{E}[Y^{a = 1} - Y^{a = 0} | Z = 1, A = a] = \mathbb{E}[Y^{a = 1} - Y^{a = 0} | Z = 0, A = a]\)</span> then the IV estimate can be interpreted as the <em>average treatment effect among the treated (ATT)</em> in the population. If the ATT is identical to the <em>ATU(ntreated),</em> then the IV estimate can be interpreted as the <em>ATE in the population.</em> Other homogeneity conditions are described in section 16.3 of the what-if book. Appendix 2.1 of the Hernán, Robins 2006 paper has some stuff on this too.</p></li>
<li><p><em>Monotonicity</em> - The trial population can be partitioned into four-latent subgroups / <em>prinicipal strata</em> defined by a combination of <span class="math inline">\(A, Z\)</span> - <em>always takers, compliers, never-takers, and defiers</em>. Always (or never) takers are people who would always (or never) take the treatment independent of group assignment. Compliers would comply with the treatment corresponding to the group they are assigned to. Defiers would do the opposite to the group they’re assigned to. In the absence of defiers and always takers, the IV estimand is the <em>complier average causal effect (CACE)</em> or the <em>local average treatment effect (LATE).</em> This can be written as</p>
<p><span class="math display">\[
\mathbb{E}[Y^{a = 1} - Y^{a = 0} | A^{z = 1} \gt A^{z = 0}] = \frac{\mathbb{E}[Y = 1 | Z = 1] - \mathbb{E}[Y = 1 | Z = 0]}{\mathbb{E}[A = 1 | Z = 1] - \mathbb{E}[A = 1 | Z = 0]}
\]</span></p></li>
</ul>
<p>The variable <span class="math inline">\(Z\)</span> from the DAG for this problem</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1"></a><span class="fu">plot</span>(dag)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-25-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>seems to fulfill the first three conditions, since individuals are randomly assigned into treatment and control groups. This makes it a <em>causal instrument</em>, as an individual cannot choose to see an ad unless they’re assigned to the treatment group.</p>
<p>Regarding homogeneity, it can be argued that the assignment of an individual<a href="#fn10" class="footnote-ref" id="fnref10" role="doc-noteref"><sup>10</sup></a> to the group cannot be an effect modifier, since this is done by a random number generator and so should not affect the potential outcomes.</p>
<div class="no-row-height column-margin column-container"><p><sup>10</sup>&nbsp;In the presence of <em>interference</em>, e.g.&nbsp;individuals in the same household being assigned to different groups but affecting each others’ potential outcomes, the unit of assignment and analysis would be at the household level.</p><p><sup>11</sup>&nbsp;Not that anyone would <em>choose</em> to see an ad.</p></div><p>Since the ad is randomized at the individual level, there can never be any defiers (i.e., individuals assigned to the control group can never deliberately switch over to the treatment group). Always takers are also not an option, since people assigned to the control group cannot choose to take the treatment<a href="#fn11" class="footnote-ref" id="fnref11" role="doc-noteref"><sup>11</sup></a>. This essentially leaves the population to be a mix of never-takers and compliers.</p>
<section id="iv-in-action" class="level3 page-columns page-full">
<h3 class="anchored" data-anchor-id="iv-in-action">IV in action</h3>
<p>Since the instrument, treatment, and outcome are all binary, we can use the following <em>ratio / Wald estimator</em> for the IV estimand</p>
<p><span class="math display">\[
\text{IV} = \frac{\text{Pr}[Y = 1 | Z = 1] - \text{Pr}[Y = 1 | Z = 0]}{\text{Pr}[A = 1 | Z = 1] - \text{Pr}[A = 1 | Z = 0]}
\]</span></p>
<p>where the numerator is the ITT effect estimate defined a few sections above, and the denominator is a measure of compliance on the risk difference scale with regards to the assigned treatment, i.e., an association between treatment assignment <span class="math inline">\(Z\)</span> and treatment uptake <span class="math inline">\(A\)</span>.</p>
<p>Depending on whether we invoke one of the homogeneity assumptions or the monotonicity assumption, we end up with either the average causal effect in the treated, or in the population, or the average causal effect among the compliers. All the different assumptions for this are described in the Swanson et al 2018 article.</p>
<p>To fit this Beta-binomial model to the data, we can use the posterior distribution of the risk difference from the ITT effect for the numerator. For the denominator, we need to get a similar distribution of treatment compliance. Looking at the 2x2 <span class="math inline">\(Z-A\)</span> table,</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1"></a>data <span class="sc">%$%</span> <span class="fu">table</span>(A, Z)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   Z
A       0     1
  0 30033 14017
  1     0 55950</code></pre>
</div>
</div>
<p>the group of <span class="math inline">\(\text{Pr}[A = 1 | Z = 0]\)</span> is (expected to be) 0, since those assigned to the control group should not be able to see the ad. We can pick a <em>degenerate</em> (Beta) prior distribution<a href="#fn12" class="footnote-ref" id="fnref12" role="doc-noteref"><sup>12</sup></a> with <span class="math inline">\(\alpha = 0,\ \beta &gt; 0\)</span>, e.g., <span class="math inline">\(\text{Beta}(0, 1)\)</span>, which results in a Beta posterior with shape <span class="math inline">\(\alpha = 0 + 0 = 0,\ \beta = 30033 + 1 = 30034\)</span>. Since <span class="math inline">\(\alpha = 0\)</span>, all draws from this posterior distribution are exactly zero.</p>
<div class="no-row-height column-margin column-container"><p><sup>12</sup>&nbsp;Since I’m not using Stan to fit the model here, I can get away with this. Using Stan, I’d pick something like a <span class="math inline">\(\text{Beta}(1, 10000)\)</span> distribution that puts a very small non-zero probability for <span class="math inline">\(\text{Pr}[A = 1 | Z = 0]\)</span>. I don’t know for sure whether the degenerate prior would cause issues for Stan to be honest.</p></div><div class="cell">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1"></a><span class="fu">summary</span>(<span class="fu">rbeta</span>(<span class="fl">1e2</span>, <span class="dv">0</span>, <span class="dv">30034</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
      0       0       0       0       0       0 </code></pre>
</div>
</div>
<p>For <span class="math inline">\(\text{Pr}[A = 1 | Z = 1]\)</span>, we can expect the compliance to be reasonably high, so the <span class="math inline">\(\text{Beta}(7, 3)\)</span> with a mean compliance of 70%, and a range of 10%-100% might be a good choice. With the large sample sizes in the dataset, the prior is going to be dominated by the likelihood anyway.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1"></a><span class="fu">summary</span>(<span class="fu">rbeta</span>(<span class="fl">1e4</span>, <span class="dv">7</span>, <span class="dv">3</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
0.09285 0.60786 0.71188 0.69917 0.80307 0.98952 </code></pre>
</div>
</div>
<p>Using the counts from the <span class="math inline">\(A-Z\)</span> table above, we get the <span class="math inline">\(\text{Beta}(55957, 14020)\)</span> posterior with <span class="math inline">\(\alpha = 7 + 55950\)</span> and <span class="math inline">\(\beta = 3 + 14017\)</span>. Taking a difference of these two posteriors would leave this posterior unchanged, so we can produce the corresponding IV posterior distribution</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1"></a><span class="fu">set.seed</span>(<span class="dv">23</span>)</span>
<span id="cb52-2"><a href="#cb52-2"></a>compliance_posterior <span class="ot">&lt;-</span> <span class="fu">rbeta</span>(<span class="fu">nrow</span>(ITT_risk_difference), <span class="dv">55957</span>, <span class="dv">14020</span>)</span>
<span id="cb52-3"><a href="#cb52-3"></a></span>
<span id="cb52-4"><a href="#cb52-4"></a>IV_labels <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Intention-to-treat effect"</span>, </span>
<span id="cb52-5"><a href="#cb52-5"></a>               <span class="st">"Proportion of compliers"</span>, </span>
<span id="cb52-6"><a href="#cb52-6"></a>               <span class="st">"Instrumental variable estimate"</span>)</span>
<span id="cb52-7"><a href="#cb52-7"></a></span>
<span id="cb52-8"><a href="#cb52-8"></a>IV_posterior <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb52-9"><a href="#cb52-9"></a>  <span class="at">id =</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(ITT_risk_difference), <span class="at">times =</span> <span class="dv">3</span>),</span>
<span id="cb52-10"><a href="#cb52-10"></a>  <span class="at">cat =</span> <span class="fu">factor</span>(<span class="fu">rep</span>(IV_labels, <span class="at">each =</span> <span class="fu">nrow</span>(ITT_risk_difference)), </span>
<span id="cb52-11"><a href="#cb52-11"></a>               <span class="at">levels =</span> IV_labels),</span>
<span id="cb52-12"><a href="#cb52-12"></a>  <span class="at">x =</span> <span class="fu">c</span>(ITT_risk_difference<span class="sc">$</span>x, compliance_posterior, </span>
<span id="cb52-13"><a href="#cb52-13"></a>        ITT_risk_difference<span class="sc">$</span>x <span class="sc">/</span> compliance_posterior)</span>
<span id="cb52-14"><a href="#cb52-14"></a>)</span>
<span id="cb52-15"><a href="#cb52-15"></a></span>
<span id="cb52-16"><a href="#cb52-16"></a>true_effect_IV <span class="ot">&lt;-</span> true_effect <span class="sc">%&gt;%</span> </span>
<span id="cb52-17"><a href="#cb52-17"></a>  <span class="fu">mutate</span>(<span class="at">cat =</span> <span class="fu">factor</span>(IV_labels, <span class="at">levels =</span> IV_labels))</span>
<span id="cb52-18"><a href="#cb52-18"></a></span>
<span id="cb52-19"><a href="#cb52-19"></a><span class="fu">plot_posteriors</span>(IV_posterior, true_effect_IV)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-29-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1"></a>IV_posterior <span class="sc">%&gt;%</span> </span>
<span id="cb53-2"><a href="#cb53-2"></a>  <span class="fu">filter</span>(cat <span class="sc">==</span> IV_labels[<span class="dv">3</span>]) <span class="sc">%&gt;%</span> </span>
<span id="cb53-3"><a href="#cb53-3"></a>  <span class="fu">summarize</span>(<span class="at">mean =</span> <span class="fu">mean</span>(x), </span>
<span id="cb53-4"><a href="#cb53-4"></a>            <span class="at">lower =</span> <span class="fu">quantile</span>(x, <span class="at">probs =</span> <span class="fl">0.025</span>), </span>
<span id="cb53-5"><a href="#cb53-5"></a>            <span class="at">upper =</span> <span class="fu">quantile</span>(x, <span class="fl">0.975</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 3
   mean  lower upper
  &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt;
1 0.101 0.0979 0.104</code></pre>
</div>
</div>
<p>Compared to the ITT, PP, and AT estimates, the IV estimate is the closest to the true treatment effect of +10 percentage points, which makes sense as all the IV conditions are valid here due to the use of a randomized experiment with the causal instrument <span class="math inline">\(Z\)</span>. However, if any of the conditions (monotonicity, relevance, etc.) were to weaken, this would lead to bias in the IV estimate.</p>
<p>Some recommend producing bounds<a href="#fn13" class="footnote-ref" id="fnref13" role="doc-noteref"><sup>13</sup></a> for the IV estimate since it’s usually not <em>point identified.</em> For the case of binary <span class="math inline">\(Z, A, Y\)</span>, we can use <code>ivtools::ivbounds()</code> to produce the <em>natural bounds</em> – which are between 8%-28% for the ATE (<code>CRD</code> in the result)</p>
<div class="no-row-height column-margin column-container"><p><sup>13</sup>&nbsp;Note to (future) self: look at the Balke, Pearl 1997 and Swanson et al 2018 papers, and the <code>causaloptim</code> R package.</p></div><div class="cell">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1"></a>data <span class="sc">%&gt;%</span> </span>
<span id="cb55-2"><a href="#cb55-2"></a>  ivtools<span class="sc">::</span><span class="fu">ivbounds</span>(<span class="at">data =</span> ., </span>
<span id="cb55-3"><a href="#cb55-3"></a>                    <span class="at">Z =</span> <span class="st">"Z"</span>, <span class="at">X =</span> <span class="st">"A"</span>, <span class="at">Y =</span> <span class="st">"Y"</span>, </span>
<span id="cb55-4"><a href="#cb55-4"></a>                    <span class="at">monotonicity =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb55-5"><a href="#cb55-5"></a>  <span class="fu">summary</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:  
ivtools::ivbounds(data = ., Z = "Z", X = "A", Y = "Y", monotonicity = TRUE)

The IV inequality is not violated

Symbolic bounds:
   lower upper  
p0 p10.0 1-p00.0
p1 p11.1 1-p01.1

Numeric bounds:
       lower    upper
p0   0.00869  0.00869
p1   0.08910  0.28944
CRD  0.08041  0.28075
CRR 10.25255 33.30515
COR 11.15758 46.46413</code></pre>
</div>
</div>
<p>The width of the bounds is 20 percentage points, which matches the formula for the width<a href="#fn14" class="footnote-ref" id="fnref14" role="doc-noteref"><sup>14</sup></a> – <span class="math inline">\(\text{Pr}[A = 1 | Z = 0] + \text{Pr}[A = 0 | Z = 1]\)</span> – where the former is 0, since we have no defiers, and 20% for the second quantity, which is the proportion of never-takers.</p>
<div class="no-row-height column-margin column-container"><p><sup>14</sup>&nbsp;given in some of the references below</p></div><p>The slight difference between the true value and the estimate is due to sampling variability, which can be assessed by simulating multiple datasets with different seeds to give a mean ATE <em>very</em> close to +10 percentage points</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1"></a><span class="fu">map_dbl</span>(</span>
<span id="cb57-2"><a href="#cb57-2"></a>  <span class="at">.x =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">100</span>, </span>
<span id="cb57-3"><a href="#cb57-3"></a>  <span class="at">.f =</span> <span class="sc">~</span> {</span>
<span id="cb57-4"><a href="#cb57-4"></a>    .x <span class="sc">%&gt;%</span> </span>
<span id="cb57-5"><a href="#cb57-5"></a>      <span class="fu">simulate_data</span>(<span class="at">seed =</span> .) <span class="sc">%&gt;%</span> </span>
<span id="cb57-6"><a href="#cb57-6"></a>      <span class="fu">mutate</span>(<span class="at">diff =</span> (Y1 <span class="sc">-</span> Y0) <span class="sc">/</span> <span class="fl">0.8</span>) <span class="sc">%&gt;%</span></span>
<span id="cb57-7"><a href="#cb57-7"></a>      <span class="fu">pull</span>(diff) <span class="sc">%&gt;%</span> </span>
<span id="cb57-8"><a href="#cb57-8"></a>      <span class="fu">mean</span>()</span>
<span id="cb57-9"><a href="#cb57-9"></a>    }) <span class="sc">%&gt;%</span> <span class="fu">mean</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.0999695</code></pre>
</div>
</div>
</section>
</section>
<section id="all-the-estimates-in-a-single-plot" class="level2">
<h2 class="anchored" data-anchor-id="all-the-estimates-in-a-single-plot">All the estimates in a single plot</h2>
<p>We can look at all four estimates in a single plot</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1"></a><span class="fu">list</span>(</span>
<span id="cb59-2"><a href="#cb59-2"></a>  <span class="st">"Instrumental variable"</span> <span class="ot">=</span> IV_posterior, </span>
<span id="cb59-3"><a href="#cb59-3"></a>  <span class="st">"As-treated"</span> <span class="ot">=</span> AT_posterior, </span>
<span id="cb59-4"><a href="#cb59-4"></a>  <span class="st">"Per-protocol"</span> <span class="ot">=</span> PP_posterior, </span>
<span id="cb59-5"><a href="#cb59-5"></a>  <span class="st">"Intention-to-treat"</span> <span class="ot">=</span> ITT_posterior</span>
<span id="cb59-6"><a href="#cb59-6"></a>) <span class="sc">%&gt;%</span> </span>
<span id="cb59-7"><a href="#cb59-7"></a>  <span class="fu">map2_dfr</span>(<span class="at">.x =</span> ., <span class="at">.y =</span> <span class="fu">names</span>(.), <span class="at">.f =</span> <span class="sc">~</span> {</span>
<span id="cb59-8"><a href="#cb59-8"></a>    .x <span class="sc">%&gt;%</span> </span>
<span id="cb59-9"><a href="#cb59-9"></a>      <span class="fu">filter</span>(<span class="fu">str_detect</span>(cat, <span class="st">"Risk|Instrument"</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb59-10"><a href="#cb59-10"></a>      <span class="fu">mutate</span>(<span class="at">cat =</span> {{ .y }})</span>
<span id="cb59-11"><a href="#cb59-11"></a>    }) <span class="sc">%&gt;%</span> </span>
<span id="cb59-12"><a href="#cb59-12"></a>  <span class="fu">mutate</span>(</span>
<span id="cb59-13"><a href="#cb59-13"></a>    <span class="at">cat =</span> <span class="fu">factor</span>(cat, <span class="at">levels =</span> <span class="fu">c</span>(</span>
<span id="cb59-14"><a href="#cb59-14"></a>      <span class="st">"Instrumental variable"</span>, <span class="st">"As-treated"</span>,</span>
<span id="cb59-15"><a href="#cb59-15"></a>      <span class="st">"Per-protocol"</span>, <span class="st">"Intention-to-treat"</span></span>
<span id="cb59-16"><a href="#cb59-16"></a>  ))) <span class="sc">%&gt;%</span> </span>
<span id="cb59-17"><a href="#cb59-17"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> cat, <span class="at">group =</span> cat, <span class="at">fill =</span> <span class="fu">rev</span>(cat))) <span class="sc">+</span> </span>
<span id="cb59-18"><a href="#cb59-18"></a>  ggdist<span class="sc">::</span><span class="fu">stat_halfeye</span>(</span>
<span id="cb59-19"><a href="#cb59-19"></a>    <span class="at">show.legend =</span> <span class="cn">FALSE</span></span>
<span id="cb59-20"><a href="#cb59-20"></a>  ) <span class="sc">+</span></span>
<span id="cb59-21"><a href="#cb59-21"></a>  <span class="fu">geom_vline</span>(</span>
<span id="cb59-22"><a href="#cb59-22"></a>    <span class="at">xintercept =</span> pY1 <span class="sc">-</span> pY0, </span>
<span id="cb59-23"><a href="#cb59-23"></a>    <span class="at">color =</span> <span class="st">"gray50"</span>, </span>
<span id="cb59-24"><a href="#cb59-24"></a>    <span class="at">linetype =</span> <span class="st">"dashed"</span>,</span>
<span id="cb59-25"><a href="#cb59-25"></a>    <span class="at">linewidth =</span> <span class="fl">1.3</span></span>
<span id="cb59-26"><a href="#cb59-26"></a>  ) <span class="sc">+</span></span>
<span id="cb59-27"><a href="#cb59-27"></a>  <span class="fu">geom_vline</span>(</span>
<span id="cb59-28"><a href="#cb59-28"></a>    <span class="at">xintercept =</span> true_ITT_effect, </span>
<span id="cb59-29"><a href="#cb59-29"></a>    <span class="at">color =</span> <span class="st">"gray20"</span>, </span>
<span id="cb59-30"><a href="#cb59-30"></a>    <span class="at">linetype =</span> <span class="st">"dotted"</span>,</span>
<span id="cb59-31"><a href="#cb59-31"></a>    <span class="at">linewidth =</span> <span class="fl">1.3</span></span>
<span id="cb59-32"><a href="#cb59-32"></a>  ) <span class="sc">+</span></span>
<span id="cb59-33"><a href="#cb59-33"></a>  <span class="fu">theme_classic</span>() <span class="sc">+</span> </span>
<span id="cb59-34"><a href="#cb59-34"></a>  <span class="fu">xlab</span>(<span class="fu">paste0</span>(</span>
<span id="cb59-35"><a href="#cb59-35"></a>    <span class="st">"Posterior distribution of risk difference / uplift</span><span class="sc">\n</span><span class="st">"</span>, </span>
<span id="cb59-36"><a href="#cb59-36"></a>    <span class="st">"(Dotted line: ATE in this population; dashed line: true ATE)"</span></span>
<span id="cb59-37"><a href="#cb59-37"></a>  )) <span class="sc">+</span> </span>
<span id="cb59-38"><a href="#cb59-38"></a>  <span class="fu">ylab</span>(<span class="st">""</span>) <span class="sc">+</span> </span>
<span id="cb59-39"><a href="#cb59-39"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">labels =</span> scales<span class="sc">::</span><span class="fu">label_percent</span>(<span class="at">accuracy =</span> <span class="fl">0.1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-33-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The IV estimate is the closest to the true treatment effectiveness of +10 percentage points (in gray), with the AT and the PP effects both showing some bias.</p>
<p>The simulated data analyzed here are from a relatively clean setting where the treatment effectiveness, sample sizes, and strength of association between A-Z are all very high. If any of these conditions weaken, the analysis may become more challenging.</p>
</section>
<section id="profit-distribution" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="profit-distribution">Profit distribution</h2>
<p>So we have two valid estimates – the ITT and the IV estimate. Can we use these estimates to calculate the total profit from this campaign, as well as other hypothetical campaigns with varying treatment / control splits and compliance?</p>
<p>This assumes that</p>
<ul>
<li><p>the effect of treatment among the compliers and the never-takers would be the same</p></li>
<li><p>the conversion probabilities specified below would apply to these other populations</p></li>
<li><p>compliance varies randomly between populations</p></li>
</ul>
<p>Data from other experiments, if available, can be used to get more realistic estimates by capturing the heterogeneity in the estimated probabilities (e.g., by meta-analysis).</p>
<p>To estimate the total profit, we need the following probability of conversion</p>
<p><span class="math display">\[
\text{Pr}[Y = 1] = \sum_z \text{Pr}[Y = 1 | Z = z] \text{Pr}[Z = z]
\]</span></p>
<p>where <span class="math inline">\(\text{Pr}[Z = z]\)</span> is the proportion of people assigned to treatment (<span class="math inline">\(Z = 1\)</span>) and control (<span class="math inline">\(Z = 0\)</span>), and the <span class="math inline">\(\text{Pr}[Y = 1 | Z = z]\)</span> is the ITT estimate<a href="#fn15" class="footnote-ref" id="fnref15" role="doc-noteref"><sup>15</sup></a> in each arm. The ITT estimate under the monotonicity assumption can be further decomposed – using the <a href="https://en.wikipedia.org/wiki/Law_of_total_probability"><em>law of total probability</em></a> – into a weighted sum of the conversion probabilities among the compliers and the never-takers<a href="#fn16" class="footnote-ref" id="fnref16" role="doc-noteref"><sup>16</sup></a></p>
<div class="no-row-height column-margin column-container"><p><sup>15</sup>&nbsp;Technically an <em>estimand</em>, but feels odd to type out ‘estimand’ everywhere in this and following paragraphs instead of ‘estimate’.</p><p><sup>16</sup>&nbsp;The <span class="math inline">\(\text{Pr}[Z = z]\)</span> term in the numerator on the right side of the equation is constant with respect to the summation (over <span class="math inline">\(c\)</span>), so can be pulled out and cancels out the same term in the denominator.</p></div><p><span class="math display">\[
\text{Pr}[Y = 1 | Z = z] = \sum_c \text{Pr}[Y = 1 | Z = z, C = c] \text{Pr}[C = c | Z = z]
\]</span></p>
<p>where <span class="math inline">\(\text{Pr}[C = c | Z = z] = \text{Pr}[C = c]\)</span> because <span class="math inline">\(Z\)</span> is randomly assigned, so <span class="math inline">\(Z \perp\!\!\!\perp C\)</span>, i.e., <span class="math inline">\(Z\)</span> and <span class="math inline">\(C\)</span> are independent.</p>
<p>Our best estimate of compliance is given by</p>
<p><span class="math display">\[
\text{Pr}[C = 1] = \text{Pr}[A = 1 | Z = 1] - \text{Pr}[A = 1 | Z = 0]
\]</span></p>
<p>and <span class="math inline">\(\text{Pr}[C = 0] = 1 - \text{Pr}[C = 1]\)</span> is the proportion of never-takers. To get the conditional probability in the first term in the sum, we can rewrite the previous equation – shown only for <span class="math inline">\(Z = 1\)</span> but is the same for <span class="math inline">\(Z = 0\)</span> – after diving each term by <span class="math inline">\(\text{Pr}[C = 1]\)</span></p>
<p><span class="math display">\[
\begin{split}
\frac{\text{Pr}[Y = 1 | Z = 1]}{\text{Pr}[C = 1]} &amp; = \text{Pr}[Y = 1 | Z = 1, C = 1] \\ &amp; + \text{Pr}[Y = 1 | Z = 1, C = 0] \frac{\text{Pr}[C = 0]}{\text{Pr}[C = 1]}
\end{split}
\]</span></p>
<p>The term on the left is the ITT estimate rescaled by the proportion of compliers. The first term on the right is the conversion probability among the compliers who received the treatment <span class="math inline">\(\text{Pr}[Y = 1 | Z = 1, C = 1]\)</span>, and the second term on the right is the probability of conversion among the never-takers who were assigned to the treatment, weighted by the ratio of never-takers to compliers.</p>
<p>This also shows why subtracting the two rescaled ITT estimates (i.e., the IV estimate) is the effect of treatment among the compliers – the second term on the right cancels out (under the assumption of exclusion restriction) since <span class="math inline">\(Z\)</span> is randomly assigned, so the never-takers in each arm should have the same probability of conversion</p>
<p><span class="math display">\[
\text{Pr}[Y = 1 | Z = 1, C = 0] = \text{Pr}[Y = 1 | Z = 0, C = 0]
\]</span></p>
<p>and proportion of compliers <span class="math inline">\(\text{Pr}[C = 1 | Z = 1] = \text{Pr}[C = 1 | Z = 0]\)</span>, and we’re left with</p>
<p><span class="math display">\[
\text{Pr}[Y = 1 | Z = 1, C = 1] - \text{Pr}[Y = 1 | Z = 0, C = 1]
\]</span></p>
<p>which is the CACE from the IV analysis.</p>
<p>While compliance (<span class="math inline">\(C\)</span>) is unobserved, we can estimate all these probabilites using the combined information present in <span class="math inline">\(Z, A, Y\)</span> along with the assumptions in the previous paragraphs.</p>
<p>For the proportion of compliers (<span class="math inline">\(\text{Pr}[C = 1]\)</span>), we can use the posterior distribution we obtained for the IV analysis.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb60-1"><a href="#cb60-1"></a>prop_compliers <span class="ot">&lt;-</span> IV_posterior <span class="sc">%&gt;%</span> </span>
<span id="cb60-2"><a href="#cb60-2"></a>  <span class="fu">filter</span>(cat <span class="sc">==</span> <span class="st">"Proportion of compliers"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb60-3"><a href="#cb60-3"></a>  <span class="fu">select</span>(id, <span class="at">p_compliers =</span> x)</span>
<span id="cb60-4"><a href="#cb60-4"></a></span>
<span id="cb60-5"><a href="#cb60-5"></a>prop_compliers <span class="sc">%&gt;%</span></span>
<span id="cb60-6"><a href="#cb60-6"></a>  <span class="fu">mutate</span>(<span class="at">p_never_takers =</span> <span class="dv">1</span> <span class="sc">-</span> p_compliers) <span class="sc">%&gt;%</span> </span>
<span id="cb60-7"><a href="#cb60-7"></a>  <span class="fu">summary</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>       id          p_compliers     p_never_takers  
 Min.   :     1   Min.   :0.7913   Min.   :0.1933  
 1st Qu.: 25001   1st Qu.:0.7986   1st Qu.:0.1993  
 Median : 50000   Median :0.7997   Median :0.2003  
 Mean   : 50000   Mean   :0.7996   Mean   :0.2004  
 3rd Qu.: 75000   3rd Qu.:0.8007   3rd Qu.:0.2014  
 Max.   :100000   Max.   :0.8067   Max.   :0.2087  </code></pre>
</div>
</div>
<p>For the probability of conversion among the never takers, we can calculate this from information among the untreated assigned to the treatment group. A <span class="math inline">\(\text{Beta}(1, 1)\)</span> prior can be assumed here to get the following <span class="math inline">\(\text{Beta}(18 + 1, 13999 + 1) = \text{Beta}(19, 14000)\)</span> posterior</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb62-1"><a href="#cb62-1"></a>data <span class="sc">%&gt;%</span> <span class="fu">filter</span>(A <span class="sc">!=</span> Z) <span class="sc">%$%</span> <span class="fu">table</span>(Y)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Y
    0     1 
13999    18 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb64-1"><a href="#cb64-1"></a>pY_never_takers <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb64-2"><a href="#cb64-2"></a>  <span class="at">id =</span> <span class="dv">1</span><span class="sc">:</span><span class="fl">1e5</span>, </span>
<span id="cb64-3"><a href="#cb64-3"></a>  <span class="at">pY_nt =</span> <span class="fu">rbeta</span>(<span class="fl">1e5</span>, <span class="dv">19</span>, <span class="dv">14000</span>)</span>
<span id="cb64-4"><a href="#cb64-4"></a>)</span>
<span id="cb64-5"><a href="#cb64-5"></a></span>
<span id="cb64-6"><a href="#cb64-6"></a>pY_never_takers <span class="sc">%&gt;%</span> <span class="fu">summary</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>       id             pY_nt          
 Min.   :     1   Min.   :0.0004274  
 1st Qu.: 25001   1st Qu.:0.0011353  
 Median : 50000   Median :0.0013325  
 Mean   : 50000   Mean   :0.0013561  
 3rd Qu.: 75000   3rd Qu.:0.0015507  
 Max.   :100000   Max.   :0.0031606  </code></pre>
</div>
</div>
<p>For the ITT estimates, the posterior probabilities from the ITT analysis above are used</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb66-1"><a href="#cb66-1"></a>ITT_posterior_subset <span class="ot">&lt;-</span> ITT_posterior <span class="sc">%&gt;%</span> </span>
<span id="cb66-2"><a href="#cb66-2"></a>  <span class="fu">filter</span>(cat <span class="sc">!=</span> <span class="st">"Risk difference"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb66-3"><a href="#cb66-3"></a>  <span class="fu">pivot_wider</span>(<span class="at">id_cols =</span> id, <span class="at">names_from =</span> cat, <span class="at">values_from =</span> x) <span class="sc">%&gt;%</span> </span>
<span id="cb66-4"><a href="#cb66-4"></a>  <span class="fu">rename</span>(</span>
<span id="cb66-5"><a href="#cb66-5"></a>        <span class="st">"p_control"</span> <span class="ot">=</span> <span class="st">"Conversion probability </span><span class="sc">\n</span><span class="st">(control group)"</span>, </span>
<span id="cb66-6"><a href="#cb66-6"></a>        <span class="st">"p_treated"</span> <span class="ot">=</span> <span class="st">"Conversion probability </span><span class="sc">\n</span><span class="st">(treatment group)"</span></span>
<span id="cb66-7"><a href="#cb66-7"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb66-8"><a href="#cb66-8"></a>  <span class="fu">glimpse</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 100,000
Columns: 3
$ id        &lt;int&gt; 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 1…
$ p_control &lt;dbl&gt; 0.008838875, 0.008459186, 0.009314263, 0.009458440, 0.008553…
$ p_treated &lt;dbl&gt; 0.09029532, 0.08987783, 0.09138095, 0.08802061, 0.09105225, …</code></pre>
</div>
</div>
<p>Putting these together gives</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb68-1"><a href="#cb68-1"></a>posterior_draws <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb68-2"><a href="#cb68-2"></a>  prop_compliers, pY_never_takers, ITT_posterior_subset</span>
<span id="cb68-3"><a href="#cb68-3"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb68-4"><a href="#cb68-4"></a>  <span class="fu">reduce</span>(<span class="at">.f =</span> <span class="sc">~</span> <span class="fu">full_join</span>(.x, .y, <span class="at">by =</span> <span class="st">"id"</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb68-5"><a href="#cb68-5"></a>  <span class="fu">glimpse</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 100,000
Columns: 5
$ id          &lt;int&gt; 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17,…
$ p_compliers &lt;dbl&gt; 0.7993178, 0.8003960, 0.7980252, 0.7976448, 0.8001245, 0.7…
$ pY_nt       &lt;dbl&gt; 0.0010972405, 0.0010973038, 0.0017398618, 0.0014166189, 0.…
$ p_control   &lt;dbl&gt; 0.008838875, 0.008459186, 0.009314263, 0.009458440, 0.0085…
$ p_treated   &lt;dbl&gt; 0.09029532, 0.08987783, 0.09138095, 0.08802061, 0.09105225…</code></pre>
</div>
</div>
<p>The conversion probabilities among the compliers are calculated, which results in the data frame with all the posterior draws for the probabilities we need.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb70-1"><a href="#cb70-1"></a><span class="co"># set seed in case a subset of the posterior draws are used</span></span>
<span id="cb70-2"><a href="#cb70-2"></a><span class="co"># set.seed(23)</span></span>
<span id="cb70-3"><a href="#cb70-3"></a>posterior_draws <span class="ot">&lt;-</span> posterior_draws <span class="sc">%&gt;%</span> </span>
<span id="cb70-4"><a href="#cb70-4"></a>  <span class="fu">mutate</span>(</span>
<span id="cb70-5"><a href="#cb70-5"></a>    <span class="fu">across</span>(</span>
<span id="cb70-6"><a href="#cb70-6"></a>      <span class="at">.cols =</span> <span class="fu">c</span>(p_treated, p_control), </span>
<span id="cb70-7"><a href="#cb70-7"></a>      <span class="co"># rescale the ITT probabilities by p(compliance) and</span></span>
<span id="cb70-8"><a href="#cb70-8"></a>      <span class="co"># shave off the effect of never takers on this probability</span></span>
<span id="cb70-9"><a href="#cb70-9"></a>      <span class="co"># to recover the p(Y = 1 | Z = z, C = 1)</span></span>
<span id="cb70-10"><a href="#cb70-10"></a>      <span class="at">.fns =</span> <span class="sc">~</span> ((.x <span class="sc">/</span> p_compliers) <span class="sc">-</span> </span>
<span id="cb70-11"><a href="#cb70-11"></a>                  (pY_nt <span class="sc">*</span> ((<span class="dv">1</span> <span class="sc">-</span> p_compliers) <span class="sc">/</span> p_compliers))), </span>
<span id="cb70-12"><a href="#cb70-12"></a>      <span class="at">.names =</span> <span class="st">"{.col}_compliers"</span></span>
<span id="cb70-13"><a href="#cb70-13"></a>    )</span>
<span id="cb70-14"><a href="#cb70-14"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb70-15"><a href="#cb70-15"></a>  <span class="co"># slice_sample(n = 5000) %&gt;% </span></span>
<span id="cb70-16"><a href="#cb70-16"></a>  <span class="co"># select(-id)  %&gt;% </span></span>
<span id="cb70-17"><a href="#cb70-17"></a>  <span class="fu">glimpse</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 100,000
Columns: 7
$ id                  &lt;int&gt; 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15,…
$ p_compliers         &lt;dbl&gt; 0.7993178, 0.8003960, 0.7980252, 0.7976448, 0.8001…
$ pY_nt               &lt;dbl&gt; 0.0010972405, 0.0010973038, 0.0017398618, 0.001416…
$ p_control           &lt;dbl&gt; 0.008838875, 0.008459186, 0.009314263, 0.009458440…
$ p_treated           &lt;dbl&gt; 0.09029532, 0.08987783, 0.09138095, 0.08802061, 0.…
$ p_treated_compliers &lt;dbl&gt; 0.1126900, 0.1120181, 0.1140685, 0.1099912, 0.1135…
$ p_control_compliers &lt;dbl&gt; 0.010782542, 0.010295105, 0.011231293, 0.011498576…</code></pre>
</div>
</div>
<p>In principle, any of these probabilities can be replaced with other priors<a href="#fn17" class="footnote-ref" id="fnref17" role="doc-noteref"><sup>17</sup></a> when attempting to <em>transport</em> these estimates to the other scenarios.</p>
<div class="no-row-height column-margin column-container"><p><sup>17</sup>&nbsp;rather than using the observed posteriors as priors.</p></div><p>For the plot below, there are two dimensions</p>
<ul>
<li><p>compliance with levels set to 50%, 80%, 100%</p></li>
<li><p>treatment / control split</p>
<ul>
<li><p>70/30% as in this experiment</p></li>
<li><p>0/100% - don’t treat the population</p></li>
<li><p>100/0% - treat the full population</p></li>
</ul></li>
</ul>
<p>It feels a bit odd to look at the combination of compliance with 0% of the population assigned to treatment, as the (non-)compliers are only identified – and the respective conditional probabilities estimated – when at least some individuals are assigned to treatment. In this case, it’s more of a hypothetical exercise using data from an experiment where &gt;0% of the population was assigned to the treatment arm. Page 41 of the Greenland et al 1999 paper mentions</p>
<blockquote class="blockquote">
<p>[…] noncompliance represents movement into a third untreated state that does not correspond to any assigned treatment (Robins, 1998).</p>
</blockquote>
<p>I haven’t managed to go through the Robins 1998 paper yet but it would be interesting to dig into this further.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb72-1"><a href="#cb72-1"></a>parameter_grid <span class="ot">&lt;-</span> <span class="fu">expand_grid</span>(</span>
<span id="cb72-2"><a href="#cb72-2"></a>  <span class="at">compliance =</span> <span class="fu">c</span>(<span class="fl">0.5</span>, <span class="fl">0.8</span>, <span class="fl">1.0</span>),</span>
<span id="cb72-3"><a href="#cb72-3"></a>  <span class="at">split =</span> <span class="fu">c</span>(<span class="fl">0.7</span>, <span class="fl">1.0</span>, <span class="fl">0.0</span>), </span>
<span id="cb72-4"><a href="#cb72-4"></a>  <span class="at">n =</span> n</span>
<span id="cb72-5"><a href="#cb72-5"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Total profit distributions for each of these hypothetical experiments is calculated using the formulas specified above. To get the variability in the profit distribution, total sales <span class="math inline">\(S \sim \text{BetaBin}(n, \alpha, \beta)\)</span> can be sampled from the <a href="https://en.wikipedia.org/wiki/Beta-binomial_distribution#Generating_beta_binomial-distributed_random_variables"><em>(beta-binomial) posterior predictive distribution</em></a><em>,</em> where the probability of conversion <span class="math inline">\(p \sim \text{Beta}(\alpha, \beta)\)</span> and <span class="math inline">\(S \sim \text{Binomial}(n, p)\)</span> under the different interventions in different settings. The total profit can be obtained from multiplying <span class="math inline">\(S\)</span> with the profit per unit, which can be fixed at (say) +100 euros.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb73-1"><a href="#cb73-1"></a>profit_distributions <span class="ot">&lt;-</span> <span class="fu">expand_grid</span>(parameter_grid, posterior_draws) <span class="sc">%&gt;%</span> </span>
<span id="cb73-2"><a href="#cb73-2"></a>  <span class="fu">mutate</span>(</span>
<span id="cb73-3"><a href="#cb73-3"></a>    <span class="co"># get the ITT estimates for the hypothetical campaigns</span></span>
<span id="cb73-4"><a href="#cb73-4"></a>    <span class="co"># under the different parameters</span></span>
<span id="cb73-5"><a href="#cb73-5"></a>    <span class="co"># pY_nt is scaled by proportion of compliers</span></span>
<span id="cb73-6"><a href="#cb73-6"></a>    <span class="co"># as this wasn't done above</span></span>
<span id="cb73-7"><a href="#cb73-7"></a>    <span class="at">p_treated_hyp =</span> ((compliance <span class="sc">*</span> p_treated_compliers) <span class="sc">+</span> </span>
<span id="cb73-8"><a href="#cb73-8"></a>      ((<span class="dv">1</span> <span class="sc">-</span> compliance) <span class="sc">*</span> (pY_nt <span class="sc">/</span> p_compliers))),</span>
<span id="cb73-9"><a href="#cb73-9"></a>    <span class="at">p_control_hyp =</span> ((compliance <span class="sc">*</span> p_control_compliers) <span class="sc">+</span> </span>
<span id="cb73-10"><a href="#cb73-10"></a>      ((<span class="dv">1</span> <span class="sc">-</span> compliance) <span class="sc">*</span> (pY_nt <span class="sc">/</span> p_compliers))),</span>
<span id="cb73-11"><a href="#cb73-11"></a>    <span class="at">n_treated =</span> <span class="fu">round</span>(split <span class="sc">*</span> n), </span>
<span id="cb73-12"><a href="#cb73-12"></a>    <span class="at">n_control =</span> n <span class="sc">-</span> n_treated, </span>
<span id="cb73-13"><a href="#cb73-13"></a>    <span class="at">s_treated =</span> <span class="fu">rbinom</span>(<span class="fu">n</span>(), n_treated, p_treated_hyp), </span>
<span id="cb73-14"><a href="#cb73-14"></a>    <span class="at">s_control =</span> <span class="fu">rbinom</span>(<span class="fu">n</span>(), n_control, p_control_hyp), </span>
<span id="cb73-15"><a href="#cb73-15"></a>    <span class="at">total_profit =</span> <span class="dv">100</span> <span class="sc">*</span> (s_treated <span class="sc">+</span> s_control)</span>
<span id="cb73-16"><a href="#cb73-16"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb73-17"><a href="#cb73-17"></a>  <span class="fu">glimpse</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 900,000
Columns: 17
$ compliance          &lt;dbl&gt; 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, …
$ split               &lt;dbl&gt; 0.7, 0.7, 0.7, 0.7, 0.7, 0.7, 0.7, 0.7, 0.7, 0.7, …
$ n                   &lt;int&gt; 100000, 100000, 100000, 100000, 100000, 100000, 10…
$ id                  &lt;int&gt; 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15,…
$ p_compliers         &lt;dbl&gt; 0.7993178, 0.8003960, 0.7980252, 0.7976448, 0.8001…
$ pY_nt               &lt;dbl&gt; 0.0010972405, 0.0010973038, 0.0017398618, 0.001416…
$ p_control           &lt;dbl&gt; 0.008838875, 0.008459186, 0.009314263, 0.009458440…
$ p_treated           &lt;dbl&gt; 0.09029532, 0.08987783, 0.09138095, 0.08802061, 0.…
$ p_treated_compliers &lt;dbl&gt; 0.1126900, 0.1120181, 0.1140685, 0.1099912, 0.1135…
$ p_control_compliers &lt;dbl&gt; 0.010782542, 0.010295105, 0.011231293, 0.011498576…
$ p_treated_hyp       &lt;dbl&gt; 0.05703136, 0.05669450, 0.05812436, 0.05588362, 0.…
$ p_control_hyp       &lt;dbl&gt; 0.006077632, 0.005833028, 0.006705751, 0.006637289…
$ n_treated           &lt;dbl&gt; 70000, 70000, 70000, 70000, 70000, 70000, 70000, 7…
$ n_control           &lt;dbl&gt; 30000, 30000, 30000, 30000, 30000, 30000, 30000, 3…
$ s_treated           &lt;int&gt; 3981, 3988, 4160, 3843, 3968, 3943, 3813, 3905, 40…
$ s_control           &lt;int&gt; 186, 172, 209, 214, 199, 189, 204, 209, 183, 159, …
$ total_profit        &lt;dbl&gt; 416700, 416000, 436900, 405700, 416700, 413200, 40…</code></pre>
</div>
</div>
<p>The posterior predictive distribution for the total profit is visually compared with simulated draws from the data generating process</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb75"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb75-1"><a href="#cb75-1"></a>simulated_profit <span class="ot">&lt;-</span> parameter_grid <span class="sc">%&gt;%</span> </span>
<span id="cb75-2"><a href="#cb75-2"></a>  <span class="fu">expand_grid</span>(<span class="at">id =</span> <span class="fu">seq</span>(<span class="at">from =</span> <span class="dv">20</span>, <span class="at">by =</span> <span class="dv">1</span>, <span class="at">length.out =</span> <span class="dv">20</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb75-3"><a href="#cb75-3"></a>  <span class="fu">pmap_dfr</span>(</span>
<span id="cb75-4"><a href="#cb75-4"></a>    <span class="at">.f =</span> <span class="cf">function</span>(compliance, split, id, n) {</span>
<span id="cb75-5"><a href="#cb75-5"></a>      <span class="fu">simulate_data</span>(<span class="at">n =</span> n,</span>
<span id="cb75-6"><a href="#cb75-6"></a>                    <span class="at">p_compliers =</span> compliance, </span>
<span id="cb75-7"><a href="#cb75-7"></a>                    <span class="at">p_treatment =</span> split,</span>
<span id="cb75-8"><a href="#cb75-8"></a>                    <span class="at">seed =</span> id) <span class="sc">%&gt;%</span></span>
<span id="cb75-9"><a href="#cb75-9"></a>        <span class="fu">summarise</span>(<span class="at">total_profit =</span> <span class="dv">100</span> <span class="sc">*</span> <span class="fu">sum</span>(Y)) <span class="sc">%&gt;%</span> </span>
<span id="cb75-10"><a href="#cb75-10"></a>        <span class="fu">tibble</span>(compliance, split, .)</span>
<span id="cb75-11"><a href="#cb75-11"></a>    }</span>
<span id="cb75-12"><a href="#cb75-12"></a>  )</span>
<span id="cb75-13"><a href="#cb75-13"></a></span>
<span id="cb75-14"><a href="#cb75-14"></a>profit_distributions_plot_data <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb75-15"><a href="#cb75-15"></a>  <span class="st">"extrapolated"</span> <span class="ot">=</span> profit_distributions <span class="sc">%&gt;%</span> </span>
<span id="cb75-16"><a href="#cb75-16"></a>    <span class="fu">select</span>(compliance, split, total_profit),</span>
<span id="cb75-17"><a href="#cb75-17"></a>  <span class="st">"simulated"</span> <span class="ot">=</span> simulated_profit</span>
<span id="cb75-18"><a href="#cb75-18"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb75-19"><a href="#cb75-19"></a>  <span class="fu">map</span>(</span>
<span id="cb75-20"><a href="#cb75-20"></a>    <span class="at">.f =</span> <span class="sc">~</span> {</span>
<span id="cb75-21"><a href="#cb75-21"></a>      .x <span class="sc">%&gt;%</span> </span>
<span id="cb75-22"><a href="#cb75-22"></a>        <span class="fu">mutate</span>(</span>
<span id="cb75-23"><a href="#cb75-23"></a>          <span class="at">total_profit =</span> total_profit <span class="sc">/</span> <span class="fl">1e5</span>, </span>
<span id="cb75-24"><a href="#cb75-24"></a>          <span class="at">compliance =</span> <span class="fu">paste0</span>(<span class="st">"Compliers: "</span>, compliance <span class="sc">*</span> <span class="dv">100</span>, <span class="st">"%"</span>), </span>
<span id="cb75-25"><a href="#cb75-25"></a>          <span class="at">compliance =</span> <span class="fu">factor</span>(compliance, </span>
<span id="cb75-26"><a href="#cb75-26"></a>                        <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"Compliers: 50%"</span>,</span>
<span id="cb75-27"><a href="#cb75-27"></a>                                   <span class="st">"Compliers: 80%"</span>,</span>
<span id="cb75-28"><a href="#cb75-28"></a>                                   <span class="st">"Compliers: 100%"</span>)),</span>
<span id="cb75-29"><a href="#cb75-29"></a>          <span class="at">split =</span> <span class="fu">paste0</span>(<span class="st">"Treatment: "</span>, split <span class="sc">*</span> <span class="dv">100</span>, <span class="st">"%"</span>), </span>
<span id="cb75-30"><a href="#cb75-30"></a>          <span class="at">split =</span> <span class="fu">factor</span>(split, </span>
<span id="cb75-31"><a href="#cb75-31"></a>                         <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"Treatment: 0%"</span>, </span>
<span id="cb75-32"><a href="#cb75-32"></a>                                    <span class="st">"Treatment: 70%"</span>, </span>
<span id="cb75-33"><a href="#cb75-33"></a>                                    <span class="st">"Treatment: 100%"</span>))</span>
<span id="cb75-34"><a href="#cb75-34"></a>        )</span>
<span id="cb75-35"><a href="#cb75-35"></a>    }</span>
<span id="cb75-36"><a href="#cb75-36"></a>  )</span>
<span id="cb75-37"><a href="#cb75-37"></a></span>
<span id="cb75-38"><a href="#cb75-38"></a>profit_distributions_plot_data <span class="sc">%&gt;%</span> </span>
<span id="cb75-39"><a href="#cb75-39"></a>  <span class="fu">pluck</span>(<span class="st">"extrapolated"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb75-40"><a href="#cb75-40"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> total_profit)) <span class="sc">+</span> </span>
<span id="cb75-41"><a href="#cb75-41"></a>  <span class="fu">geom_density</span>(<span class="at">trim =</span> <span class="cn">TRUE</span>) <span class="sc">+</span> </span>
<span id="cb75-42"><a href="#cb75-42"></a>  <span class="fu">geom_vline</span>(</span>
<span id="cb75-43"><a href="#cb75-43"></a>    <span class="at">data =</span> profit_distributions_plot_data <span class="sc">%&gt;%</span> <span class="fu">pluck</span>(<span class="st">"simulated"</span>), </span>
<span id="cb75-44"><a href="#cb75-44"></a>    <span class="fu">aes</span>(<span class="at">xintercept =</span> total_profit), <span class="at">color =</span> <span class="st">"maroon"</span></span>
<span id="cb75-45"><a href="#cb75-45"></a>  ) <span class="sc">+</span> </span>
<span id="cb75-46"><a href="#cb75-46"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span> </span>
<span id="cb75-47"><a href="#cb75-47"></a>  <span class="fu">facet_wrap</span>(<span class="fu">vars</span>(split, compliance), <span class="at">scales =</span> <span class="st">"free"</span>) <span class="sc">+</span> </span>
<span id="cb75-48"><a href="#cb75-48"></a>  <span class="co">#facet_grid(compliance ~ split, scales = "fixed") +</span></span>
<span id="cb75-49"><a href="#cb75-49"></a>  <span class="fu">xlab</span>(<span class="st">"Total profit (multiples of 100,000 EUR, per 100,000 individuals)"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-41-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The middle column shows the total profit distribution for this experiment with a 70-30% split and 80% compliance. In this fictional scenario, the ad campaign has a strong positive impact on the total profits (90,000 under 0% treated and 80% compliance vs 900,000 under 100% treated) so with the gift of hindsight, it could have been rolled out to the full population.</p>
<p>If you’re wondering why the posterior predictive distribution (black line) in each panel is not centered at the mean of the vertical lines (in maroon), it’s from using the estimated probabilities from the original dataset which differ from the true probabilities because of sampling variability<a href="#fn18" class="footnote-ref" id="fnref18" role="doc-noteref"><sup>18</sup></a>.</p>
<div class="no-row-height column-margin column-container"><p><sup>18</sup>&nbsp;This can be checked by using the true probabilities, i.e., <code>p_compliers = 0.8, pY_nt = 0.001, p_treated_compliers = 0.1, p_control_compliers = 0.01</code> instead of the posterior distributions for these probabilities.</p></div></section>
<section id="ignored-complexities" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="ignored-complexities">Ignored complexities</h2>
<p>In this post, I ignored the complexity where the exposure among the treated – i.e., number of impressions of the ad – would be continuous, possibly something like this</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb76-1"><a href="#cb76-1"></a><span class="fu">set.seed</span>(<span class="dv">23</span>)</span>
<span id="cb76-2"><a href="#cb76-2"></a><span class="fu">tibble</span>(<span class="at">impressions =</span> <span class="fu">pmax</span>(<span class="fu">round</span>(<span class="fu">rgamma</span>(<span class="fl">5e4</span>, <span class="at">shape =</span> <span class="dv">4</span>, <span class="at">scale =</span> <span class="dv">3</span>)), <span class="dv">1</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb76-3"><a href="#cb76-3"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> impressions)) <span class="sc">+</span> </span>
<span id="cb76-4"><a href="#cb76-4"></a>  <span class="fu">geom_bar</span>() <span class="sc">+</span></span>
<span id="cb76-5"><a href="#cb76-5"></a>  <span class="co">#stat_ecdf() + </span></span>
<span id="cb76-6"><a href="#cb76-6"></a>  <span class="fu">theme_classic</span>() <span class="sc">+</span> </span>
<span id="cb76-7"><a href="#cb76-7"></a>  <span class="fu">xlab</span>(<span class="st">"Impressions"</span>) <span class="sc">+</span> </span>
<span id="cb76-8"><a href="#cb76-8"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">50</span>, <span class="dv">5</span>), <span class="at">labels =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">50</span>, <span class="dv">5</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-42-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Ignoring the actual impressions effectively assumes <em>treatment variation irrelevance</em>, i.e, seeing 1 impression is as effective as seeing 20 impressions with regards to conversion. This might be fun to explore in a future post on binary instruments, with a continuous exposure<a href="#fn19" class="footnote-ref" id="fnref19" role="doc-noteref"><sup>19</sup></a>. Baiocchi et al.&nbsp;(section 12) describes an analysis with continuous treatments.</p>
<div class="no-row-height column-margin column-container"><p><sup>19</sup>&nbsp;although all references mention that this complicates the analysis</p></div><p>Issue with handling partial exposures, i.e., people with one or more partial impressions are also not tackled here.</p>
<p>For building more complex / full Bayesian IV models using brms / Stan, see <a href="https://bookdown.org/content/4857/adventures-in-covariance.html#instruments-and-causal-designs">this</a>, <a href="https://avehtari.github.io/ROS-Examples/Sesame/sesame.html">this</a>, <a href="https://modernstatisticalworkflow.blogspot.com/2017/11/bayesian-instrumental-variables-with.html">this</a>, or <a href="https://rpsychologist.com/adherence-analysis-IV-brms">this</a>.</p>
</section>
<section id="references" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="references">References</h2>
<p>These are the main references I’m using for this post<a href="#fn20" class="footnote-ref" id="fnref20" role="doc-noteref"><sup>20</sup></a>.</p>
<div class="no-row-height column-margin column-container"><p><sup>20</sup>&nbsp;although I can’t claim to have read and mastered all these.</p></div><ul>
<li>Simulating data for instrumental variables - <a href="https://statmodeling.stat.columbia.edu/2019/06/20/how-to-simulate-an-instrumental-variables-problem/">Andrew Gelman blog post link</a>, or <a href="https://bookdown.org/content/4857/adventures-in-covariance.html#instruments-and-causal-designs">this link</a> to <em>statistical rethinking</em> models implemented using brms</li>
<li><a href="https://www.hsph.harvard.edu/miguel-hernan/causal-inference-book/">Hernán, Robins</a> - Causal Inference - What if? - Chapters 16 (instrumental variables), and 22 (sections on intention-to-treat and per-protocol analyses)</li>
<li><a href="https://avehtari.github.io/ROS-Examples/">Gelman, Hill, Vehtari</a> - Regression and other stories, Sections 21.1-21.2</li>
<li><a href="https://pubmed.ncbi.nlm.nih.gov/16755261/">Hernán, Robins 2006</a> - Instruments for causal inference: an epidemiologist’s dream?</li>
<li><a href="https://www.ncbi.nlm.nih.gov/pmc/articles/PMC5642006/">Burgess, Small, Thompson 2017</a> - A review of instrumental variable estimators for Mendelian randomization</li>
<li><a href="https://onlinelibrary.wiley.com/doi/abs/10.1002/sim.6128">Baiocchi, Cheng, Small 2014</a> - Instrumental variable methods for causal inference
<ul>
<li>Good review paper for different IV situations</li>
</ul></li>
<li><a href="https://pubmed.ncbi.nlm.nih.gov/20442226/">Sussman, Hayward 2010</a> - An IV for the RCT: using instrumental variables to adjust for treatment contamination in randomised controlled trials</li>
<li><a href="https://academic.oup.com/aje/article/189/6/508/5812650">Naimi, Whitcomb 2020</a> - Calculating risk differences and risk ratios from regression models</li>
<li><a href="https://projecteuclid.org/journals/annals-of-statistics/volume-25/issue-1/Bayesian-inference-for-causal-effects-in-randomized-experiments-with-noncompliance/10.1214/aos/1034276631.full">Imbens, Rubin 1997</a> - Bayesian inference for causal effects in randomized experiments with noncompliance</li>
<li><a href="https://arxiv.org/abs/1302.6784">Balke, Pearl 1997</a> - Counterfactual Probabilities: Computational Methods, Bounds and Applications</li>
<li><a href="https://www.ncbi.nlm.nih.gov/pmc/articles/PMC6752717/">Swanson et al 2018</a> - Partial Identification of the Average Treatment Effect Using Instrumental Variables: Review of Methods for Binary Instruments, Treatments, and Outcomes
<ul>
<li>Note to future self: good rabbit hole to go down to calculate bounds on the ATE under different assumption sets</li>
</ul></li>
<li><a href="https://projecteuclid.org/journals/statistical-science/volume-14/issue-1/Confounding-and-Collapsibility-in-Causal-Inference/10.1214/ss/1009211805.full">Greenland, Pearl, Robins 1999</a> - Confounding and Collapsibility in Causal Inference</li>
<li><a href="https://pubmed.ncbi.nlm.nih.gov/9493255/">Robins 1998</a> - Correction for non-compliance in equivalence trials (<a href="https://www.hsph.harvard.edu/wp-content/uploads/sites/343/2013/03/corr-noncomp-98.pdf">free link</a>)</li>
</ul>


<!-- -->

</section>


</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
    const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
    const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
    let newTheme = '';
    if(darkModeDefault) {
      newTheme = isAlternate ? baseTheme : alternateTheme;
    } else {
      newTheme = isAlternate ? alternateTheme : baseTheme;
    }
    const changeGiscusTheme = () => {
      // From: https://github.com/giscus/giscus/issues/336
      const sendMessage = (message) => {
        const iframe = document.querySelector('iframe.giscus-frame');
        if (!iframe) return;
        iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
      }
      sendMessage({
        setConfig: {
          theme: newTheme
        }
      });
    }
    const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
    if (isGiscussLoaded) {
      changeGiscusTheme();
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  const darkModeDefault = false;
  let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
    toggleGiscusIfUsed(toAlternate, darkModeDefault);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb77" data-shortcodes="false"><pre class="sourceCode numberSource markdown number-lines code-with-copy"><code class="sourceCode markdown"><span id="cb77-1"><a href="#cb77-1"></a><span class="co">---</span></span>
<span id="cb77-2"><a href="#cb77-2"></a><span class="an">title:</span><span class="co"> "How should the untreated in the treatment group from an experiment be analyzed?"</span></span>
<span id="cb77-3"><a href="#cb77-3"></a><span class="an">date:</span><span class="co"> "2023-09-28"</span></span>
<span id="cb77-4"><a href="#cb77-4"></a><span class="an">categories:</span><span class="co"> [Causal Inference, Instrumental Variables, Advertising, R]</span></span>
<span id="cb77-5"><a href="#cb77-5"></a><span class="an">code-fold:</span><span class="co"> false</span></span>
<span id="cb77-6"><a href="#cb77-6"></a><span class="an">toc-expand:</span><span class="co"> true</span></span>
<span id="cb77-7"><a href="#cb77-7"></a><span class="an">reference-location:</span><span class="co"> margin</span></span>
<span id="cb77-8"><a href="#cb77-8"></a><span class="an">image:</span><span class="co"> "image.png"</span></span>
<span id="cb77-9"><a href="#cb77-9"></a><span class="co">---</span></span>
<span id="cb77-10"><a href="#cb77-10"></a></span>
<span id="cb77-11"><a href="#cb77-11"></a>This (longer-than-expected) post compares intention-to-treat, per-protocol, as-treated, and instrumental variable analyses on a simulated dataset. Along the way, it goes off on fun tangents like 1) comparing results from different estimators for risk difference (a.k.a. uplift), and 2) comparing the bootstrap distribution with the Bayesian posterior distribution and the normal approximation for the risk difference. Finally, it uses the estimated probabilities to get the posterior predictive distribution for the total profit under different scenarios. This was written largely for me to learn about IV methods in order to deal with the problem of estimating the effect of a treatment under non-compliance in randomized experiments.</span>
<span id="cb77-12"><a href="#cb77-12"></a></span>
<span id="cb77-13"><a href="#cb77-13"></a><span class="fu">## Introduction</span></span>
<span id="cb77-14"><a href="#cb77-14"></a></span>
<span id="cb77-15"><a href="#cb77-15"></a>One of the first problems I ever cut my teeth on as a data scientist many years ago was to analyze data from a marketing / advertising campaign to assess the impact of an advertisement (ad) on sales of a certain product.</span>
<span id="cb77-16"><a href="#cb77-16"></a></span>
<span id="cb77-17"><a href="#cb77-17"></a>It was a simple experimental dataset from a two-arm<span class="ot">[^1]</span> randomized controlled trial. The most challenging part of that analysis was how to analyze individuals -- the so-called *non-compliers*[^2] *--* who were assigned to the treatment group eligible to view an ad, but who did not actually end up seeing a single ad.</span>
<span id="cb77-18"><a href="#cb77-18"></a></span>
<span id="cb77-19"><a href="#cb77-19"></a><span class="ot">[^1]: </span>i.e., an experiment with two groups -- treatment and control</span>
<span id="cb77-20"><a href="#cb77-20"></a></span>
<span id="cb77-21"><a href="#cb77-21"></a><span class="ot">[^2]: </span>in the usual terminology used in the instrumental variable methods literature</span>
<span id="cb77-22"><a href="#cb77-22"></a></span>
<span id="cb77-23"><a href="#cb77-23"></a>All details below are of a simplified version of the problem similar to the one I worked on, and have no resemblance to the real constraints / numbers / settings from the actual problem. This exact same problem shows up in pretty much every field (marketing, advertising, pharma, tech, psychology, economics, etc.) where experiments are regularly conducted, and the analyses in this post are applicable to those situations as well.</span>
<span id="cb77-24"><a href="#cb77-24"></a></span>
<span id="cb77-25"><a href="#cb77-25"></a><span class="fu">## Problem description</span></span>
<span id="cb77-26"><a href="#cb77-26"></a></span>
<span id="cb77-27"><a href="#cb77-27"></a>Let's say a company has been working on updating an existing version of a product, and wants to know whether they should invest in an advertising campaign on a specific channel (say YouTube / Instagram ads) to promote the new product. Since buying ads cost money, the campaign would have to be profitable enough in terms of increased sales to justify the ad spend<span class="ot">[^3]</span>.</span>
<span id="cb77-28"><a href="#cb77-28"></a></span>
<span id="cb77-29"><a href="#cb77-29"></a><span class="ot">[^3]: </span>The advertising company, on the other hand, is more interested in assessing the effectiveness of advertising, so would be happier to see a strong positive effect of advertising.</span>
<span id="cb77-30"><a href="#cb77-30"></a></span>
<span id="cb77-31"><a href="#cb77-31"></a>The main interest is in (functions of) two quantities -- $\text{Pr}<span class="co">[</span><span class="ot">Y^{a=0} = 1</span><span class="co">]</span>$, which is the proportion of sales in a population not shown the ad; and $\text{Pr}<span class="co">[</span><span class="ot">Y^{a=1} = 1</span><span class="co">]</span>$, which is the proportion of sales in a population which is shown the ad. These can be used to calculate the risk difference / uplift ($\text{Pr}<span class="co">[</span><span class="ot">Y^{a=1} = 1</span><span class="co">]</span> - \text{Pr}<span class="co">[</span><span class="ot">Y^{a=0} = 1</span><span class="co">]</span>$), the risk ratio / relative risk / lift ($\text{Pr}<span class="co">[</span><span class="ot">Y^{a=1} = 1</span><span class="co">]</span> / \text{Pr}<span class="co">[</span><span class="ot">Y^{a=0} = 1</span><span class="co">]</span>$), or any other quantity listed in the tables <span class="co">[</span><span class="ot">here</span><span class="co">](https://en.wikipedia.org/wiki/Relative_risk_reduction)</span>. The risk difference can then be used to calculate the additional profit from showing the ad compared to doing nothing.</span>
<span id="cb77-32"><a href="#cb77-32"></a></span>
<span id="cb77-33"><a href="#cb77-33"></a>The cleanest way of estimating these probabilities is through an experiment. First, a target population -- say, users of a given product -- is identified, and then, this group is randomly split into a treatment and a control group. Individuals assigned to the treatment group are eligible to see an ad for the newer, updated version of the product, and the control group is ineligible to view the ad. The campaign runs for a two week period, where individuals in the treatment group see an ad multiple times. The outcome for this campaign is sales of the newer product in each of the two groups in the six-week period from the start of the campaign.</span>
<span id="cb77-34"><a href="#cb77-34"></a></span>
<span id="cb77-35"><a href="#cb77-35"></a>Before writing any code, the <span class="in">`tidyverse`</span> packages is loaded.</span>
<span id="cb77-36"><a href="#cb77-36"></a></span>
<span id="cb77-39"><a href="#cb77-39"></a><span class="in">```{r}</span></span>
<span id="cb77-40"><a href="#cb77-40"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb77-41"><a href="#cb77-41"></a><span class="in">```</span></span>
<span id="cb77-42"><a href="#cb77-42"></a></span>
<span id="cb77-43"><a href="#cb77-43"></a>A DAG, or a *directed acyclic graph* for this problem can be visualized as follows</span>
<span id="cb77-44"><a href="#cb77-44"></a></span>
<span id="cb77-47"><a href="#cb77-47"></a><span class="in">```{r}</span></span>
<span id="cb77-48"><a href="#cb77-48"></a><span class="co">#| code-fold: true</span></span>
<span id="cb77-49"><a href="#cb77-49"></a>dag <span class="ot">&lt;-</span> ggdag<span class="sc">::</span><span class="fu">dagify</span>(</span>
<span id="cb77-50"><a href="#cb77-50"></a>  A <span class="sc">~</span> Z <span class="sc">+</span> U, </span>
<span id="cb77-51"><a href="#cb77-51"></a>  Y <span class="sc">~</span> A <span class="sc">+</span> U, </span>
<span id="cb77-52"><a href="#cb77-52"></a>  <span class="at">exposure =</span> <span class="st">"A"</span>, <span class="at">outcome =</span> <span class="st">"Y"</span>, </span>
<span id="cb77-53"><a href="#cb77-53"></a>  <span class="at">coords =</span> <span class="fu">list</span>(<span class="at">x =</span> <span class="fu">c</span>(<span class="at">Z =</span> <span class="dv">1</span>, <span class="at">A =</span> <span class="dv">2</span>, <span class="at">U =</span> <span class="fl">2.5</span>, <span class="at">Y =</span> <span class="dv">3</span>), </span>
<span id="cb77-54"><a href="#cb77-54"></a>                <span class="at">y =</span> <span class="fu">c</span>(<span class="at">Z =</span> <span class="dv">1</span>, <span class="at">A =</span> <span class="dv">1</span>, <span class="at">U =</span> <span class="fl">1.2</span>, <span class="at">Y =</span> <span class="dv">1</span>))</span>
<span id="cb77-55"><a href="#cb77-55"></a>) <span class="sc">%&gt;%</span> </span>
<span id="cb77-56"><a href="#cb77-56"></a>  ggdag<span class="sc">::</span><span class="fu">ggdag</span>() <span class="sc">+</span></span>
<span id="cb77-57"><a href="#cb77-57"></a>  ggdag<span class="sc">::</span><span class="fu">theme_dag</span>()</span>
<span id="cb77-58"><a href="#cb77-58"></a></span>
<span id="cb77-59"><a href="#cb77-59"></a><span class="fu">plot</span>(dag)</span>
<span id="cb77-60"><a href="#cb77-60"></a><span class="in">```</span></span>
<span id="cb77-61"><a href="#cb77-61"></a></span>
<span id="cb77-62"><a href="#cb77-62"></a>where $Y$ is a binary outcome (bought the newer version of the product or not during the follow-up period), $A$ is a binary treatment variable (saw the ad or not), $Z$ is a binary variable indicating group assignment (i.e., randomly assigned to the treatment or control group), and U is the set of (unmeasured) confounder(s), i.e., one or more variables that both impact whether an individual ends up seeing the ad, and whether they end up buying the newer product or not.</span>
<span id="cb77-63"><a href="#cb77-63"></a></span>
<span id="cb77-64"><a href="#cb77-64"></a>This DAG encodes several assumptions:</span>
<span id="cb77-65"><a href="#cb77-65"></a></span>
<span id="cb77-66"><a href="#cb77-66"></a><span class="ss">-   </span>Group assignment $Z$ only affects whether someone sees an ad or not (variable $A$)</span>
<span id="cb77-67"><a href="#cb77-67"></a></span>
<span id="cb77-68"><a href="#cb77-68"></a><span class="ss">-   </span>There are some unmeasured common causes (confounders) $U$ that make our life difficult by potentially distorting the relationship between $A$ and $Y$</span>
<span id="cb77-69"><a href="#cb77-69"></a></span>
<span id="cb77-70"><a href="#cb77-70"></a><span class="ss">-   </span>$Z$ has no direct effect on Y; only an indirect effect entirely (mediated) via $A$</span>
<span id="cb77-71"><a href="#cb77-71"></a></span>
<span id="cb77-72"><a href="#cb77-72"></a><span class="ss">-   </span>$Z$ has no relationship with $U$, since $Z$ is randomly assigned and should be balanced with respect to $U$ (unless we're unlucky and there's some imbalance by chance)</span>
<span id="cb77-73"><a href="#cb77-73"></a></span>
<span id="cb77-74"><a href="#cb77-74"></a>After the campaign is over, it is observed that a subset of the treatment group never received the treatment, i.e., didn't see the ad at all. The main question for the analysis is then -- how should these non-compliers be analyzed? In this post I look at three possible choices:</span>
<span id="cb77-75"><a href="#cb77-75"></a></span>
<span id="cb77-76"><a href="#cb77-76"></a><span class="ss">-   </span>Should they be analysed as part of the treatment group, despite not receiving the treatment?</span>
<span id="cb77-77"><a href="#cb77-77"></a></span>
<span id="cb77-78"><a href="#cb77-78"></a><span class="ss">-   </span>Should they be excluded from the analysis altogether?</span>
<span id="cb77-79"><a href="#cb77-79"></a></span>
<span id="cb77-80"><a href="#cb77-80"></a><span class="ss">-   </span>Should they be included in the control group since they were untreated?</span>
<span id="cb77-81"><a href="#cb77-81"></a></span>
<span id="cb77-82"><a href="#cb77-82"></a><span class="fu">## Simulate data</span></span>
<span id="cb77-83"><a href="#cb77-83"></a></span>
<span id="cb77-84"><a href="#cb77-84"></a>Before the question in the previous section can be answered, we need to generate hypothetical data<span class="ot">[^4]</span> for this fictional ad campaign.</span>
<span id="cb77-85"><a href="#cb77-85"></a></span>
<span id="cb77-86"><a href="#cb77-86"></a><span class="ot">[^4]: </span>Inspired by a comment on <span class="co">[</span><span class="ot">this post</span><span class="co">](https://statmodeling.stat.columbia.edu/2019/06/20/how-to-simulate-an-instrumental-variables-problem/)</span>, and the Imbens, Rubin 1997 paper linked therein.</span>
<span id="cb77-87"><a href="#cb77-87"></a></span>
<span id="cb77-88"><a href="#cb77-88"></a>What the following code does is it first partitions the population of 100,000 individuals into an 80-20% mix of *compliers* and *non-compliers*. Compliers are the individuals that would watch the ad if they were assigned to the target group. Non-compliers are the individuals who would not comply with the group they're randomized to. More on this in the IV section below. Then, the potential outcomes for each individual under the two treatments depending on their compliance status are simulated.</span>
<span id="cb77-89"><a href="#cb77-89"></a></span>
<span id="cb77-90"><a href="#cb77-90"></a>If $C_i = 1$ denotes whether individual $i$ is a complier, and $C_i = 0$ otherwise, then $\text{Pr}<span class="co">[</span><span class="ot">Y^{a = 0}_i = 1| C_i = 0</span><span class="co">]</span> = \text{Pr}<span class="co">[</span><span class="ot">Y^{a = 1}_i = 1| C_i = 0</span><span class="co">]</span> = 0.1\%$, where the probability of purchasing the new product is very small among the non-compliers independent of whether they're assigned to the treatment or the control group.</span>
<span id="cb77-91"><a href="#cb77-91"></a></span>
<span id="cb77-92"><a href="#cb77-92"></a>Among the compliers, $\text{Pr}<span class="co">[</span><span class="ot">Y^{a = 0}_i = 1| C_i = 1</span><span class="co">]</span> = 1\%$, i.e., 1% of the individuals would buy the new product if nobody was shown the ad. If the ad is rolled out to the full population, then $\text{Pr}<span class="co">[</span><span class="ot">Y^{a = 1}_i = 1| C_i = 1</span><span class="co">]</span> = 11\%$, which leads to an *average treatment effect (ATE)* among the compliers of +10 percentage points.</span>
<span id="cb77-93"><a href="#cb77-93"></a></span>
<span id="cb77-94"><a href="#cb77-94"></a>These individuals are randomly assigned to the treatment (70%) or control (30%) group. Their actual treatment status (i.e., treated or untreated) is a product of the group they're assigned to and their compliance. Their realized outcome is the outcome corresponding to the group they're assigned to.</span>
<span id="cb77-95"><a href="#cb77-95"></a></span>
<span id="cb77-98"><a href="#cb77-98"></a><span class="in">```{r}</span></span>
<span id="cb77-99"><a href="#cb77-99"></a><span class="co">#| code-fold: true</span></span>
<span id="cb77-100"><a href="#cb77-100"></a>simulate_data <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">n =</span> <span class="dv">100000</span>L,</span>
<span id="cb77-101"><a href="#cb77-101"></a>                          <span class="at">pY0 =</span> <span class="fl">0.01</span>,</span>
<span id="cb77-102"><a href="#cb77-102"></a>                          <span class="at">risk_diff =</span> <span class="fl">0.1</span>, </span>
<span id="cb77-103"><a href="#cb77-103"></a>                          <span class="at">seed =</span> <span class="dv">23</span>, </span>
<span id="cb77-104"><a href="#cb77-104"></a>                          <span class="at">p_compliers =</span> <span class="fl">0.8</span>, </span>
<span id="cb77-105"><a href="#cb77-105"></a>                          <span class="at">p_treatment =</span> <span class="fl">0.7</span>,</span>
<span id="cb77-106"><a href="#cb77-106"></a>                          <span class="at">pY_non_compliers_factor =</span> <span class="fl">0.1</span>) {</span>
<span id="cb77-107"><a href="#cb77-107"></a>  </span>
<span id="cb77-108"><a href="#cb77-108"></a>  pY1 <span class="ot">&lt;-</span> pY0 <span class="sc">+</span> risk_diff</span>
<span id="cb77-109"><a href="#cb77-109"></a>  pY_nc <span class="ot">&lt;-</span> pY_non_compliers_factor <span class="sc">*</span> pY0</span>
<span id="cb77-110"><a href="#cb77-110"></a>  </span>
<span id="cb77-111"><a href="#cb77-111"></a>  <span class="fu">set.seed</span>(seed)</span>
<span id="cb77-112"><a href="#cb77-112"></a>  data <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb77-113"><a href="#cb77-113"></a>    <span class="at">id =</span> <span class="dv">1</span><span class="sc">:</span>n,</span>
<span id="cb77-114"><a href="#cb77-114"></a>    <span class="co"># the underlying population can be stratified into </span></span>
<span id="cb77-115"><a href="#cb77-115"></a>    <span class="co"># never-takers and compliers</span></span>
<span id="cb77-116"><a href="#cb77-116"></a>    <span class="at">complier =</span> <span class="fu">rbinom</span>(n, <span class="dv">1</span>, <span class="at">prob =</span> p_compliers), </span>
<span id="cb77-117"><a href="#cb77-117"></a>    <span class="co"># generate individual potential outcomes</span></span>
<span id="cb77-118"><a href="#cb77-118"></a>    <span class="co"># under control and treatment, i.e., Pr[Y^0 = 1]</span></span>
<span id="cb77-119"><a href="#cb77-119"></a>    <span class="at">Y0 =</span> <span class="fu">case_when</span>(</span>
<span id="cb77-120"><a href="#cb77-120"></a>      complier <span class="sc">==</span> <span class="dv">0</span> <span class="sc">~</span> <span class="fu">rbinom</span>(n, <span class="dv">1</span>, pY_nc),</span>
<span id="cb77-121"><a href="#cb77-121"></a>      complier <span class="sc">==</span> <span class="dv">1</span> <span class="sc">~</span> <span class="fu">rbinom</span>(n, <span class="dv">1</span>, pY0),</span>
<span id="cb77-122"><a href="#cb77-122"></a>    ),</span>
<span id="cb77-123"><a href="#cb77-123"></a>    <span class="co"># assuming a constant effect of +10 percentage points</span></span>
<span id="cb77-124"><a href="#cb77-124"></a>    <span class="co"># among the compliers, and no average effect under the never-takers</span></span>
<span id="cb77-125"><a href="#cb77-125"></a>    <span class="at">Y1 =</span> <span class="fu">case_when</span>(</span>
<span id="cb77-126"><a href="#cb77-126"></a>      complier <span class="sc">==</span> <span class="dv">0</span> <span class="sc">~</span> <span class="fu">rbinom</span>(n, <span class="dv">1</span>, pY_nc),</span>
<span id="cb77-127"><a href="#cb77-127"></a>      complier <span class="sc">==</span> <span class="dv">1</span> <span class="sc">~</span> <span class="fu">rbinom</span>(n, <span class="dv">1</span>, pY1)</span>
<span id="cb77-128"><a href="#cb77-128"></a>    ), </span>
<span id="cb77-129"><a href="#cb77-129"></a>    <span class="co"># treatment assigned at random</span></span>
<span id="cb77-130"><a href="#cb77-130"></a>    <span class="co"># 70-30 split into treatment / control</span></span>
<span id="cb77-131"><a href="#cb77-131"></a>    <span class="at">Z =</span> <span class="fu">rbinom</span>(n, <span class="dv">1</span>, <span class="at">prob =</span> p_treatment),</span>
<span id="cb77-132"><a href="#cb77-132"></a>    <span class="co"># treatment uptake depends on </span></span>
<span id="cb77-133"><a href="#cb77-133"></a>    <span class="co"># being assigned to treatment (Z = 1)</span></span>
<span id="cb77-134"><a href="#cb77-134"></a>    <span class="co"># AND being a complier (C = 1)</span></span>
<span id="cb77-135"><a href="#cb77-135"></a>    <span class="at">A =</span> Z <span class="sc">*</span> complier,</span>
<span id="cb77-136"><a href="#cb77-136"></a>    <span class="co"># generate observed response using the </span></span>
<span id="cb77-137"><a href="#cb77-137"></a>    <span class="co"># consistency equation</span></span>
<span id="cb77-138"><a href="#cb77-138"></a>    <span class="at">Y =</span> (<span class="dv">1</span> <span class="sc">-</span> Z) <span class="sc">*</span> Y0 <span class="sc">+</span> Z <span class="sc">*</span> Y1</span>
<span id="cb77-139"><a href="#cb77-139"></a>  )</span>
<span id="cb77-140"><a href="#cb77-140"></a></span>
<span id="cb77-141"><a href="#cb77-141"></a>  <span class="fu">return</span>(data)</span>
<span id="cb77-142"><a href="#cb77-142"></a>}</span>
<span id="cb77-143"><a href="#cb77-143"></a></span>
<span id="cb77-144"><a href="#cb77-144"></a><span class="co"># creating these variables as they'll be helpful later on</span></span>
<span id="cb77-145"><a href="#cb77-145"></a><span class="co"># population size</span></span>
<span id="cb77-146"><a href="#cb77-146"></a>n <span class="ot">&lt;-</span> <span class="dv">100000</span>L</span>
<span id="cb77-147"><a href="#cb77-147"></a></span>
<span id="cb77-148"><a href="#cb77-148"></a><span class="co"># P[Y^0 = 1]</span></span>
<span id="cb77-149"><a href="#cb77-149"></a>pY0 <span class="ot">&lt;-</span> <span class="fl">0.01</span></span>
<span id="cb77-150"><a href="#cb77-150"></a><span class="co"># P[Y^1 = 1], ATE of +10 pct. pts.</span></span>
<span id="cb77-151"><a href="#cb77-151"></a>pY1 <span class="ot">&lt;-</span> pY0 <span class="sc">+</span> <span class="fl">0.1</span></span>
<span id="cb77-152"><a href="#cb77-152"></a></span>
<span id="cb77-153"><a href="#cb77-153"></a>data <span class="ot">&lt;-</span> <span class="fu">simulate_data</span>(<span class="at">n =</span> n, <span class="at">pY0 =</span> pY0, <span class="at">risk_diff =</span> <span class="fl">0.1</span>)</span>
<span id="cb77-154"><a href="#cb77-154"></a></span>
<span id="cb77-155"><a href="#cb77-155"></a><span class="fu">glimpse</span>(data)</span>
<span id="cb77-156"><a href="#cb77-156"></a><span class="in">```</span></span>
<span id="cb77-157"><a href="#cb77-157"></a></span>
<span id="cb77-158"><a href="#cb77-158"></a>In this simulated dataset, we've got information on compliance and the potential outcome under each treatment at the individual level. However, from a real experiment, only the $Z, A, Y$ columns would be observed.</span>
<span id="cb77-159"><a href="#cb77-159"></a></span>
<span id="cb77-160"><a href="#cb77-160"></a>The <span class="co">[</span><span class="ot">*exposition pipe*</span><span class="co">](https://magrittr.tidyverse.org/reference/exposition.html)</span> <span class="in">`%$%`</span> operator -- similar to the pipe <span class="in">`%&gt;%`</span> operator -- is exported from the *magrittr* package and used with <span class="in">`base::table()`</span> to expose the variables in the data frame to the table function to produce contingency tables.</span>
<span id="cb77-161"><a href="#cb77-161"></a></span>
<span id="cb77-164"><a href="#cb77-164"></a><span class="in">```{r}</span></span>
<span id="cb77-165"><a href="#cb77-165"></a><span class="fu">library</span>(magrittr, <span class="at">include.only =</span> <span class="st">"%$%"</span>)</span>
<span id="cb77-166"><a href="#cb77-166"></a></span>
<span id="cb77-167"><a href="#cb77-167"></a>data <span class="sc">%$%</span> </span>
<span id="cb77-168"><a href="#cb77-168"></a>  <span class="fu">table</span>(complier, Z) <span class="sc">%&gt;%</span> </span>
<span id="cb77-169"><a href="#cb77-169"></a>  <span class="fu">prop.table</span>(<span class="at">margin =</span> <span class="dv">2</span>)</span>
<span id="cb77-170"><a href="#cb77-170"></a><span class="in">```</span></span>
<span id="cb77-171"><a href="#cb77-171"></a></span>
<span id="cb77-172"><a href="#cb77-172"></a>Since the treatment $Z$ is randomly assigned, the proportion of compliers in each group is nearly the same as expected.</span>
<span id="cb77-173"><a href="#cb77-173"></a></span>
<span id="cb77-174"><a href="#cb77-174"></a>There are several effects that can be estimated for this problem each with its own advantages and disadvantages.</span>
<span id="cb77-175"><a href="#cb77-175"></a></span>
<span id="cb77-176"><a href="#cb77-176"></a><span class="fu">## Intention-to-treat (ITT)</span></span>
<span id="cb77-177"><a href="#cb77-177"></a></span>
<span id="cb77-178"><a href="#cb77-178"></a>The *intention-to-treat* (ITT) effect is the *effect of* *being assigned to the treatment* instead of the *effect of the treatment itself*. These are identical when treatment compliance / adherence is perfect, i.e, when all the individuals only take the treatment they are assigned to, but not otherwise.</span>
<span id="cb77-179"><a href="#cb77-179"></a></span>
<span id="cb77-180"><a href="#cb77-180"></a>For this problem, the ITT analysis would analyse individuals based on the group they were assigned to, and not the treatment they ultimately received. Those in the treatment group who didn't see a single ad would be analysed as part of the treatment group rather than being excluded from the analysis, or being analysed as part of the control group.</span>
<span id="cb77-181"><a href="#cb77-181"></a></span>
<span id="cb77-182"><a href="#cb77-182"></a>An advantage of an ITT analysis is that randomization preserves the balance of confounders in both the treatment and control groups, so the $Z-Y$ association remains unconfounded and a valid, albeit conservative<span class="ot">[^5]</span> effect of assigning the treatment at the population level. However, this validity would be affected<span class="ot">[^6]</span> if this ad is rolled out to another target population -- a different period in time, or another geographical location -- with a different proportion of (non-)compliers<span class="ot">[^7]</span>.</span>
<span id="cb77-183"><a href="#cb77-183"></a></span>
<span id="cb77-184"><a href="#cb77-184"></a><span class="ot">[^5]: </span>Section 22.1 of the what-if book mentions that while the ITT estimate is usually conservative, it's not guaranteed to be attenuated compared to the *per-protocol effect* (described in the next section) for *1)* *non-inferiority trials, or 2) if the per-protocol effect is not monotonic for all individuals and non-compliance is high*. It also lists other counterarguments (e.g., lack of transportability) against the ITT effect.</span>
<span id="cb77-185"><a href="#cb77-185"></a></span>
<span id="cb77-186"><a href="#cb77-186"></a><span class="ot">[^6]: </span>Rerunning the data simulation chunk above with <span class="in">`simulate_data(p_compliers = 0.4) %&gt;% mutate(diff = Y1 - Y0) %&gt;% pull(diff) %&gt;% mean()`</span> instead of 0.8 leads to an ITT estimate of +4 instead of +8 percentage points, even though the effect of the treatment itself is still +10 percentage points.</span>
<span id="cb77-187"><a href="#cb77-187"></a></span>
<span id="cb77-188"><a href="#cb77-188"></a><span class="ot">[^7]: </span>For a garden-variety ad campaign, the proportion of compliers could be effectively random, unless the ad in question is visually appealing, or contentious. On the contrary, for something like a vaccine in a global pandemic, compliance could vary wildly between the trial and rollout at the population level. Source: reading internet discussions between 2021-2022.</span>
<span id="cb77-189"><a href="#cb77-189"></a></span>
<span id="cb77-190"><a href="#cb77-190"></a><span class="fu">### Estimators / models</span></span>
<span id="cb77-191"><a href="#cb77-191"></a></span>
<span id="cb77-192"><a href="#cb77-192"></a>Since both $Y$ and $Z$ are binary variables, an estimate of the ITT effect can be obtained by fitting a simple logistic regression model, and using the <span class="in">`marginaleffects`</span> package to perform *g-computation / (marginal / model-based) standardization* to get the risk difference (and the associated CIs)</span>
<span id="cb77-193"><a href="#cb77-193"></a></span>
<span id="cb77-196"><a href="#cb77-196"></a><span class="in">```{r}</span></span>
<span id="cb77-197"><a href="#cb77-197"></a>data <span class="sc">%&gt;%</span> </span>
<span id="cb77-198"><a href="#cb77-198"></a>  <span class="fu">glm</span>(Y <span class="sc">~</span> Z, <span class="at">family =</span> <span class="fu">binomial</span>(<span class="at">link =</span> <span class="st">"logit"</span>), <span class="at">data =</span> .) <span class="sc">%&gt;%</span></span>
<span id="cb77-199"><a href="#cb77-199"></a>  marginaleffects<span class="sc">::</span><span class="fu">avg_comparisons</span>(<span class="at">variables =</span> <span class="st">"Z"</span>)</span>
<span id="cb77-200"><a href="#cb77-200"></a><span class="in">```</span></span>
<span id="cb77-201"><a href="#cb77-201"></a></span>
<span id="cb77-202"><a href="#cb77-202"></a>or by fitting an *identity-link logistic regression* where the estimated coefficient for $Z$ can be directly interpreted as the risk difference</span>
<span id="cb77-203"><a href="#cb77-203"></a></span>
<span id="cb77-206"><a href="#cb77-206"></a><span class="in">```{r}</span></span>
<span id="cb77-207"><a href="#cb77-207"></a>data <span class="sc">%&gt;%</span> </span>
<span id="cb77-208"><a href="#cb77-208"></a>  <span class="fu">glm</span>(Y <span class="sc">~</span> Z, <span class="at">family =</span> <span class="fu">binomial</span>(<span class="at">link =</span> <span class="st">"identity"</span>), <span class="at">data =</span> .) <span class="sc">%&gt;%</span> </span>
<span id="cb77-209"><a href="#cb77-209"></a>  broom<span class="sc">::</span><span class="fu">tidy</span>(<span class="at">conf.int =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb77-210"><a href="#cb77-210"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="at">.cols =</span> <span class="fu">where</span>(is.numeric), <span class="at">.fns =</span> <span class="sc">~</span> <span class="fu">round</span>(.x, <span class="dv">4</span>)))</span>
<span id="cb77-211"><a href="#cb77-211"></a><span class="in">```</span></span>
<span id="cb77-212"><a href="#cb77-212"></a></span>
<span id="cb77-213"><a href="#cb77-213"></a>The use of glm + g-computation here is a bit overkill, as the same estimate can be obtained by looking at the 2x2 table of proportions scaled to sum to 1 within each column</span>
<span id="cb77-214"><a href="#cb77-214"></a></span>
<span id="cb77-217"><a href="#cb77-217"></a><span class="in">```{r}</span></span>
<span id="cb77-218"><a href="#cb77-218"></a>data <span class="sc">%$%</span></span>
<span id="cb77-219"><a href="#cb77-219"></a>  <span class="fu">table</span>(Y, Z) <span class="sc">%&gt;%</span> </span>
<span id="cb77-220"><a href="#cb77-220"></a>  <span class="fu">print</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb77-221"><a href="#cb77-221"></a>  <span class="fu">prop.table</span>(<span class="at">margin =</span> <span class="dv">2</span>)</span>
<span id="cb77-222"><a href="#cb77-222"></a><span class="in">```</span></span>
<span id="cb77-223"><a href="#cb77-223"></a></span>
<span id="cb77-224"><a href="#cb77-224"></a>and taking the difference of $P<span class="co">[</span><span class="ot">Y = 1 | Z</span><span class="co">]</span>$ in the two groups to give the risk difference $\hat{p}_1 - \hat{p}_0$, where $\hat{p}_0 = \text{Pr}<span class="co">[</span><span class="ot">Y = 1 | Z = 0</span><span class="co">]</span>$ and $\hat{p}_1 = \text{Pr}<span class="co">[</span><span class="ot">Y = 1 | Z = 1</span><span class="co">]</span>$</span>
<span id="cb77-225"><a href="#cb77-225"></a></span>
<span id="cb77-228"><a href="#cb77-228"></a><span class="in">```{r}</span></span>
<span id="cb77-229"><a href="#cb77-229"></a><span class="fu">round</span>(<span class="fl">0.089356411</span> <span class="sc">-</span> <span class="fl">0.008690441</span>, <span class="dv">4</span>)</span>
<span id="cb77-230"><a href="#cb77-230"></a><span class="in">```</span></span>
<span id="cb77-231"><a href="#cb77-231"></a></span>
<span id="cb77-232"><a href="#cb77-232"></a>Additionally, a wald-type CI can be obtained using the formula for variance mentioned (using counts) <span class="co">[</span><span class="ot">here</span><span class="co">](https://en.wikipedia.org/wiki/Risk_difference)</span> or (using proportions) <span class="co">[</span><span class="ot">here</span><span class="co">](https://sphweb.bumc.bu.edu/otlt/mph-modules/bs/bs704_confidence_intervals/bs704_confidence_intervals7.html)</span></span>
<span id="cb77-233"><a href="#cb77-233"></a></span>
<span id="cb77-234"><a href="#cb77-234"></a>$$</span>
<span id="cb77-235"><a href="#cb77-235"></a>SE(\hat{p}_1 - \hat{p}_0) = \sqrt{\frac{\hat{p}_0 (1 - \hat{p}_0)}{n_0} + \frac{\hat{p}_1 (1 - \hat{p}_1)}{n_1}}</span>
<span id="cb77-236"><a href="#cb77-236"></a>$$</span>
<span id="cb77-237"><a href="#cb77-237"></a></span>
<span id="cb77-238"><a href="#cb77-238"></a>which results in the same standard error</span>
<span id="cb77-239"><a href="#cb77-239"></a></span>
<span id="cb77-242"><a href="#cb77-242"></a><span class="in">```{r}</span></span>
<span id="cb77-243"><a href="#cb77-243"></a><span class="co">#| code-fold: true</span></span>
<span id="cb77-244"><a href="#cb77-244"></a>var_p0 <span class="ot">&lt;-</span> (<span class="fl">0.008690441</span> <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">-</span> <span class="fl">0.008690441</span>)) <span class="sc">/</span> (<span class="dv">261</span> <span class="sc">+</span> <span class="dv">29772</span>)</span>
<span id="cb77-245"><a href="#cb77-245"></a>var_p1 <span class="ot">&lt;-</span> (<span class="fl">0.089356411</span> <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">-</span> <span class="fl">0.089356411</span>)) <span class="sc">/</span> (<span class="dv">6252</span> <span class="sc">+</span> <span class="dv">63715</span>)</span>
<span id="cb77-246"><a href="#cb77-246"></a></span>
<span id="cb77-247"><a href="#cb77-247"></a><span class="fu">round</span>(<span class="fu">sqrt</span>(<span class="fu">sum</span>(var_p0, var_p1)), <span class="at">digits =</span> <span class="dv">4</span>)</span>
<span id="cb77-248"><a href="#cb77-248"></a><span class="in">```</span></span>
<span id="cb77-249"><a href="#cb77-249"></a></span>
<span id="cb77-250"><a href="#cb77-250"></a><span class="co">[</span><span class="ot">This paper</span><span class="co">](https://academic.oup.com/aje/article/189/6/508/5812650)</span> mentions other ways of estimating the risk difference from different models, e.g. linear regression + sandwich estimator for the standard errors, which are again identical to the ones from the other methods above</span>
<span id="cb77-251"><a href="#cb77-251"></a></span>
<span id="cb77-254"><a href="#cb77-254"></a><span class="in">```{r}</span></span>
<span id="cb77-255"><a href="#cb77-255"></a>lm_mod <span class="ot">&lt;-</span> <span class="fu">lm</span>(Y <span class="sc">~</span> Z, <span class="at">data =</span> data) </span>
<span id="cb77-256"><a href="#cb77-256"></a></span>
<span id="cb77-257"><a href="#cb77-257"></a>lm_mod <span class="sc">%&gt;%</span> </span>
<span id="cb77-258"><a href="#cb77-258"></a>  broom<span class="sc">::</span><span class="fu">tidy</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb77-259"><a href="#cb77-259"></a>  <span class="fu">select</span>(term, estimate, <span class="at">model_SE =</span> std.error) <span class="sc">%&gt;%</span> </span>
<span id="cb77-260"><a href="#cb77-260"></a>  <span class="fu">mutate</span>(<span class="at">robust_SE =</span> <span class="fu">sqrt</span>(<span class="fu">diag</span>(sandwich<span class="sc">::</span><span class="fu">vcovHC</span>(lm_mod))))</span>
<span id="cb77-261"><a href="#cb77-261"></a><span class="in">```</span></span>
<span id="cb77-262"><a href="#cb77-262"></a></span>
<span id="cb77-263"><a href="#cb77-263"></a>However, getting a distribution of this effect as opposed to just a 95% CI can be more informative from a decision making point of view. This distribution can be obtained three ways -- 1) plugging the estimate and its standard error into a normal distribution and simulating effect sizes from that; 2) using the (nonparametric) bootstrap to resample the data and getting the bootstrap distribution of effect sizes; 3) using a Bayesian model to get the posterior distributions of the parameters from the model.</span>
<span id="cb77-264"><a href="#cb77-264"></a></span>
<span id="cb77-265"><a href="#cb77-265"></a>For the rest of the analyses, I pick option 3, where the simple (Bayesian) <span class="co">[</span><span class="ot">*Beta-Binomial* model</span><span class="co">](https://en.wikipedia.org/wiki/Beta-binomial_distribution#Beta-binomial_in_Bayesian_statistics)</span> is fit to this data separately within the treatment and the control groups. Taking the difference of these two (Beta) posterior distributions produces the posterior distribution of the risk difference. The <span class="in">`bayesAB`</span> package in R can quickly fit Beta-Binomial models, or the <span class="in">`brms`</span> package can be used for more general models.</span>
<span id="cb77-266"><a href="#cb77-266"></a></span>
<span id="cb77-267"><a href="#cb77-267"></a><span class="fu">### Back to ITT analysis</span></span>
<span id="cb77-268"><a href="#cb77-268"></a></span>
<span id="cb77-269"><a href="#cb77-269"></a>A $\text{Beta}(\alpha = 1, \beta = 9)$ prior is specified for the probability of success in each arm reflecting the knowledge that the we can expect the conversion in each group to be somewhere between 0%-70%. Normally this depends on the product in question -- expensive and / or infrequently bought products are not expected to lead to very large conversion rates.</span>
<span id="cb77-270"><a href="#cb77-270"></a></span>
<span id="cb77-271"><a href="#cb77-271"></a>The following shows a summary of 10,000 draws from the prior distribution for the parameters</span>
<span id="cb77-272"><a href="#cb77-272"></a></span>
<span id="cb77-275"><a href="#cb77-275"></a><span class="in">```{r}</span></span>
<span id="cb77-276"><a href="#cb77-276"></a><span class="fu">summary</span>(<span class="fu">rbeta</span>(<span class="fl">1e5</span>, <span class="dv">1</span>, <span class="dv">9</span>))</span>
<span id="cb77-277"><a href="#cb77-277"></a><span class="in">```</span></span>
<span id="cb77-278"><a href="#cb77-278"></a></span>
<span id="cb77-279"><a href="#cb77-279"></a>which implies the following prior distribution for the risk difference</span>
<span id="cb77-280"><a href="#cb77-280"></a></span>
<span id="cb77-283"><a href="#cb77-283"></a><span class="in">```{r}</span></span>
<span id="cb77-284"><a href="#cb77-284"></a><span class="fu">summary</span>(<span class="fu">rbeta</span>(<span class="fl">1e5</span>, <span class="dv">1</span>, <span class="dv">9</span>) <span class="sc">-</span> <span class="fu">rbeta</span>(<span class="fl">1e5</span>, <span class="dv">1</span>, <span class="dv">9</span>))</span>
<span id="cb77-285"><a href="#cb77-285"></a><span class="in">```</span></span>
<span id="cb77-286"><a href="#cb77-286"></a></span>
<span id="cb77-287"><a href="#cb77-287"></a>A priori, we expect the difference to be pretty small with mean of close to 0, but allowing for large differences of +/- 60-70%. We can also visualize these distributions</span>
<span id="cb77-288"><a href="#cb77-288"></a></span>
<span id="cb77-291"><a href="#cb77-291"></a><span class="in">```{r}</span></span>
<span id="cb77-292"><a href="#cb77-292"></a><span class="co">#| code-fold: true</span></span>
<span id="cb77-293"><a href="#cb77-293"></a><span class="fu">bind_rows</span>(</span>
<span id="cb77-294"><a href="#cb77-294"></a>  <span class="fu">tibble</span>(<span class="at">x =</span> <span class="fu">rbeta</span>(<span class="fl">1e5</span>, <span class="dv">1</span>, <span class="dv">9</span>), <span class="at">cat =</span> <span class="st">"Prior conversion probability"</span>), </span>
<span id="cb77-295"><a href="#cb77-295"></a>  <span class="fu">tibble</span>(<span class="at">x =</span> <span class="fu">rbeta</span>(<span class="fl">1e5</span>, <span class="dv">1</span>, <span class="dv">9</span>) <span class="sc">-</span> <span class="fu">rbeta</span>(<span class="fl">1e5</span>, <span class="dv">1</span>, <span class="dv">9</span>), </span>
<span id="cb77-296"><a href="#cb77-296"></a>         <span class="at">cat =</span> <span class="st">"Prior risk difference"</span>)</span>
<span id="cb77-297"><a href="#cb77-297"></a>) <span class="sc">%&gt;%</span> </span>
<span id="cb77-298"><a href="#cb77-298"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">group =</span> cat, <span class="at">color =</span> cat)) <span class="sc">+</span> </span>
<span id="cb77-299"><a href="#cb77-299"></a>  <span class="fu">geom_density</span>() <span class="sc">+</span> </span>
<span id="cb77-300"><a href="#cb77-300"></a>  <span class="fu">theme_classic</span>() <span class="sc">+</span> </span>
<span id="cb77-301"><a href="#cb77-301"></a>  <span class="fu">xlab</span>(<span class="st">""</span>) <span class="sc">+</span> </span>
<span id="cb77-302"><a href="#cb77-302"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">labels =</span> scales<span class="sc">::</span>percent) <span class="sc">+</span></span>
<span id="cb77-303"><a href="#cb77-303"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> cat, <span class="at">scales =</span> <span class="st">"free"</span>) <span class="sc">+</span> </span>
<span id="cb77-304"><a href="#cb77-304"></a>  <span class="fu">guides</span>(<span class="at">color =</span> <span class="st">"none"</span>)</span>
<span id="cb77-305"><a href="#cb77-305"></a><span class="in">```</span></span>
<span id="cb77-306"><a href="#cb77-306"></a></span>
<span id="cb77-307"><a href="#cb77-307"></a>To get the posterior distribution for conversion in each arm, the counts from the 2x2 contingency table can be plugged into the formula for Beta posterior distribution $\text{Beta}(y + \alpha, n - y + \beta)$, where $y$ corresponds to the count for $Y = 1$, and $n-y$ for $Y = 0$.</span>
<span id="cb77-308"><a href="#cb77-308"></a></span>
<span id="cb77-311"><a href="#cb77-311"></a><span class="in">```{r}</span></span>
<span id="cb77-312"><a href="#cb77-312"></a>data <span class="sc">%$%</span> <span class="fu">table</span>(Y, Z)</span>
<span id="cb77-313"><a href="#cb77-313"></a><span class="in">```</span></span>
<span id="cb77-314"><a href="#cb77-314"></a></span>
<span id="cb77-315"><a href="#cb77-315"></a>This gives $p (\alpha_0, \beta_0|y) \sim \text{Beta}(261 + 1, 29772 + 9) = \text{Beta}(262, 29781)$ for the control group, and $p (\alpha_1, \beta_1|y) \sim \text{Beta}(6252 + 1, 63715 + 9) = \text{Beta}(6253, 63724)$ for the treatment group, visualized as follows</span>
<span id="cb77-316"><a href="#cb77-316"></a></span>
<span id="cb77-319"><a href="#cb77-319"></a><span class="in">```{r}</span></span>
<span id="cb77-320"><a href="#cb77-320"></a><span class="co">#| code-fold: true</span></span>
<span id="cb77-321"><a href="#cb77-321"></a>posterior_categories <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb77-322"><a href="#cb77-322"></a>  <span class="st">"Conversion probability </span><span class="sc">\n</span><span class="st">(control group)"</span>, </span>
<span id="cb77-323"><a href="#cb77-323"></a>  <span class="st">"Conversion probability </span><span class="sc">\n</span><span class="st">(treatment group)"</span>,</span>
<span id="cb77-324"><a href="#cb77-324"></a>  <span class="st">"Risk difference"</span></span>
<span id="cb77-325"><a href="#cb77-325"></a>)</span>
<span id="cb77-326"><a href="#cb77-326"></a></span>
<span id="cb77-327"><a href="#cb77-327"></a>sample_from_beta_posterior <span class="ot">&lt;-</span> <span class="cf">function</span>(theta_0, theta_1, </span>
<span id="cb77-328"><a href="#cb77-328"></a>                                       <span class="at">seed =</span> <span class="dv">23</span>, <span class="at">n_samples =</span> <span class="fl">1e5</span>) {</span>
<span id="cb77-329"><a href="#cb77-329"></a>  <span class="fu">set.seed</span>(seed)</span>
<span id="cb77-330"><a href="#cb77-330"></a>  posterior_control <span class="ot">&lt;-</span> <span class="fu">rbeta</span>(n_samples, theta_0[<span class="dv">1</span>], theta_0[<span class="dv">2</span>])</span>
<span id="cb77-331"><a href="#cb77-331"></a>  posterior_treatment <span class="ot">&lt;-</span> <span class="fu">rbeta</span>(n_samples, theta_1[<span class="dv">1</span>], theta_1[<span class="dv">2</span>])</span>
<span id="cb77-332"><a href="#cb77-332"></a>  risk_difference <span class="ot">&lt;-</span> posterior_treatment <span class="sc">-</span> posterior_control</span>
<span id="cb77-333"><a href="#cb77-333"></a>  </span>
<span id="cb77-334"><a href="#cb77-334"></a>  <span class="fu">tibble</span>(</span>
<span id="cb77-335"><a href="#cb77-335"></a>    <span class="at">id =</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span>n_samples, <span class="at">times =</span> <span class="dv">3</span>),</span>
<span id="cb77-336"><a href="#cb77-336"></a>    <span class="at">cat =</span> <span class="fu">rep</span>(posterior_categories, <span class="at">each =</span> n_samples),</span>
<span id="cb77-337"><a href="#cb77-337"></a>    <span class="at">x =</span> <span class="fu">c</span>(posterior_control, posterior_treatment, risk_difference)</span>
<span id="cb77-338"><a href="#cb77-338"></a>  )</span>
<span id="cb77-339"><a href="#cb77-339"></a>}</span>
<span id="cb77-340"><a href="#cb77-340"></a></span>
<span id="cb77-341"><a href="#cb77-341"></a>true_effect <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb77-342"><a href="#cb77-342"></a>  <span class="at">x =</span> <span class="fu">c</span>(<span class="cn">NA_real_</span>, <span class="cn">NA_real_</span>, pY1 <span class="sc">-</span> pY0), </span>
<span id="cb77-343"><a href="#cb77-343"></a>  <span class="at">cat =</span> posterior_categories</span>
<span id="cb77-344"><a href="#cb77-344"></a>)</span>
<span id="cb77-345"><a href="#cb77-345"></a></span>
<span id="cb77-346"><a href="#cb77-346"></a>plot_posteriors <span class="ot">&lt;-</span> <span class="cf">function</span>(posterior, <span class="at">effect =</span> true_effect) {</span>
<span id="cb77-347"><a href="#cb77-347"></a>  posterior <span class="sc">%&gt;%</span> </span>
<span id="cb77-348"><a href="#cb77-348"></a>    <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">group =</span> cat, <span class="at">color =</span> cat)) <span class="sc">+</span> </span>
<span id="cb77-349"><a href="#cb77-349"></a>    <span class="fu">geom_density</span>(<span class="at">trim =</span> <span class="cn">TRUE</span>) <span class="sc">+</span> </span>
<span id="cb77-350"><a href="#cb77-350"></a>    <span class="fu">geom_vline</span>(<span class="at">data =</span> effect, </span>
<span id="cb77-351"><a href="#cb77-351"></a>               <span class="fu">aes</span>(<span class="at">xintercept =</span> x), </span>
<span id="cb77-352"><a href="#cb77-352"></a>               <span class="at">color =</span> <span class="st">"gold3"</span>, </span>
<span id="cb77-353"><a href="#cb77-353"></a>               <span class="at">linetype =</span> <span class="st">"dashed"</span>,</span>
<span id="cb77-354"><a href="#cb77-354"></a>               <span class="at">linewidth =</span> <span class="fl">1.3</span>,</span>
<span id="cb77-355"><a href="#cb77-355"></a>               <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">+</span> </span>
<span id="cb77-356"><a href="#cb77-356"></a>    <span class="fu">theme_classic</span>() <span class="sc">+</span> </span>
<span id="cb77-357"><a href="#cb77-357"></a>    <span class="fu">theme</span>(<span class="at">plot.margin =</span> <span class="fu">margin</span>(<span class="fl">0.5</span>, <span class="fl">0.5</span>, <span class="fl">0.5</span>, <span class="fl">0.5</span>, <span class="st">"cm"</span>)) <span class="sc">+</span> </span>
<span id="cb77-358"><a href="#cb77-358"></a>    <span class="fu">xlab</span>(<span class="st">"Posterior distribution"</span>) <span class="sc">+</span> </span>
<span id="cb77-359"><a href="#cb77-359"></a>    <span class="fu">scale_x_continuous</span>(<span class="at">labels =</span> scales<span class="sc">::</span><span class="fu">label_percent</span>(<span class="at">accuracy =</span> <span class="fl">0.1</span>)) <span class="sc">+</span></span>
<span id="cb77-360"><a href="#cb77-360"></a>    <span class="fu">facet_wrap</span>(<span class="sc">~</span> cat, <span class="at">scales =</span> <span class="st">"free"</span>, <span class="at">ncol =</span> <span class="dv">3</span>) <span class="sc">+</span> </span>
<span id="cb77-361"><a href="#cb77-361"></a>    <span class="fu">guides</span>(<span class="at">color =</span> <span class="st">"none"</span>)</span>
<span id="cb77-362"><a href="#cb77-362"></a>}</span>
<span id="cb77-363"><a href="#cb77-363"></a></span>
<span id="cb77-364"><a href="#cb77-364"></a>ITT_posterior <span class="ot">&lt;-</span> <span class="fu">sample_from_beta_posterior</span>(</span>
<span id="cb77-365"><a href="#cb77-365"></a>  <span class="at">theta_0 =</span> <span class="fu">c</span>(<span class="dv">262</span>, <span class="dv">29781</span>), <span class="at">theta_1 =</span> <span class="fu">c</span>(<span class="dv">6253</span>, <span class="dv">63724</span>)</span>
<span id="cb77-366"><a href="#cb77-366"></a>)</span>
<span id="cb77-367"><a href="#cb77-367"></a></span>
<span id="cb77-368"><a href="#cb77-368"></a><span class="fu">plot_posteriors</span>(ITT_posterior)</span>
<span id="cb77-369"><a href="#cb77-369"></a><span class="in">```</span></span>
<span id="cb77-370"><a href="#cb77-370"></a></span>
<span id="cb77-371"><a href="#cb77-371"></a>The posterior for the risk difference completely fails to capture the underlying true effect size of +10 percentage points. However, since the dataset is simulated with the potential outcomes $<span class="sc">\{</span>Y_{i}^{z = 0},\ Y_{i}^{z = 1}<span class="sc">\}</span>$ at the individual level, we can see that the estimate of +8 percentage points is correct for *this population*.</span>
<span id="cb77-372"><a href="#cb77-372"></a></span>
<span id="cb77-375"><a href="#cb77-375"></a><span class="in">```{r}</span></span>
<span id="cb77-376"><a href="#cb77-376"></a>true_ITT_effect <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span> </span>
<span id="cb77-377"><a href="#cb77-377"></a>  <span class="fu">mutate</span>(<span class="at">diff =</span> Y1 <span class="sc">-</span> Y0) <span class="sc">%&gt;%</span> </span>
<span id="cb77-378"><a href="#cb77-378"></a>  <span class="fu">pull</span>(diff) <span class="sc">%&gt;%</span> </span>
<span id="cb77-379"><a href="#cb77-379"></a>  <span class="fu">mean</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb77-380"><a href="#cb77-380"></a>  <span class="fu">print</span>()</span>
<span id="cb77-381"><a href="#cb77-381"></a><span class="in">```</span></span>
<span id="cb77-382"><a href="#cb77-382"></a></span>
<span id="cb77-383"><a href="#cb77-383"></a>The posterior distribution is summarized via the posterior mean, mode, and 95% (equal-tailed) credible intervals, which are nearly identical to the ones above.</span>
<span id="cb77-384"><a href="#cb77-384"></a></span>
<span id="cb77-387"><a href="#cb77-387"></a><span class="in">```{r}</span></span>
<span id="cb77-388"><a href="#cb77-388"></a><span class="co">#| code-fold: true</span></span>
<span id="cb77-389"><a href="#cb77-389"></a>ITT_risk_difference <span class="ot">&lt;-</span> ITT_posterior <span class="sc">%&gt;%</span> </span>
<span id="cb77-390"><a href="#cb77-390"></a>  <span class="fu">filter</span>(cat <span class="sc">==</span> <span class="st">"Risk difference"</span>) </span>
<span id="cb77-391"><a href="#cb77-391"></a></span>
<span id="cb77-392"><a href="#cb77-392"></a><span class="co"># get the posterior density to find the mode</span></span>
<span id="cb77-393"><a href="#cb77-393"></a><span class="co"># based on this SE answer: </span></span>
<span id="cb77-394"><a href="#cb77-394"></a><span class="co"># https://stackoverflow.com/a/13874750</span></span>
<span id="cb77-395"><a href="#cb77-395"></a>ITT_risk_difference_density <span class="ot">&lt;-</span> <span class="fu">density</span>(ITT_risk_difference<span class="sc">$</span>x)</span>
<span id="cb77-396"><a href="#cb77-396"></a>ITT_risk_difference_mode <span class="ot">&lt;-</span> ITT_risk_difference_density<span class="sc">$</span>x[<span class="fu">which.max</span>(ITT_risk_difference_density<span class="sc">$</span>y)]</span>
<span id="cb77-397"><a href="#cb77-397"></a></span>
<span id="cb77-398"><a href="#cb77-398"></a>ITT_risk_difference <span class="sc">%&gt;%</span> </span>
<span id="cb77-399"><a href="#cb77-399"></a>  <span class="fu">summarize</span>(</span>
<span id="cb77-400"><a href="#cb77-400"></a>    <span class="at">mean =</span> <span class="fu">mean</span>(x), </span>
<span id="cb77-401"><a href="#cb77-401"></a>    <span class="at">lower =</span> <span class="fu">quantile</span>(x, <span class="at">probs =</span> <span class="fl">0.025</span>),</span>
<span id="cb77-402"><a href="#cb77-402"></a>    <span class="at">upper =</span> <span class="fu">quantile</span>(x, <span class="at">probs =</span> <span class="fl">0.975</span>)</span>
<span id="cb77-403"><a href="#cb77-403"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb77-404"><a href="#cb77-404"></a>  <span class="fu">mutate</span>(<span class="at">mode =</span> ITT_risk_difference_mode, <span class="at">.after =</span> mean)</span>
<span id="cb77-405"><a href="#cb77-405"></a><span class="in">```</span></span>
<span id="cb77-406"><a href="#cb77-406"></a></span>
<span id="cb77-407"><a href="#cb77-407"></a>Just for fun, the Bayesian posterior distribution is visually compared to the normal approximation and the bootstrap distribution for the risk difference</span>
<span id="cb77-408"><a href="#cb77-408"></a></span>
<span id="cb77-411"><a href="#cb77-411"></a><span class="in">```{r}</span></span>
<span id="cb77-412"><a href="#cb77-412"></a><span class="co">#| code-fold: true</span></span>
<span id="cb77-413"><a href="#cb77-413"></a>boot_ITT_fun <span class="ot">&lt;-</span> <span class="cf">function</span>(data, indx, ...) {</span>
<span id="cb77-414"><a href="#cb77-414"></a>  data <span class="ot">&lt;-</span> data[indx, ]</span>
<span id="cb77-415"><a href="#cb77-415"></a>  data <span class="sc">%&gt;%</span> </span>
<span id="cb77-416"><a href="#cb77-416"></a>    <span class="fu">count</span>(Z, Y) <span class="sc">%&gt;%</span> </span>
<span id="cb77-417"><a href="#cb77-417"></a>    <span class="co"># get P[Y = 1] within levels of Z</span></span>
<span id="cb77-418"><a href="#cb77-418"></a>    <span class="fu">group_by</span>(Z) <span class="sc">%&gt;%</span> </span>
<span id="cb77-419"><a href="#cb77-419"></a>    <span class="fu">mutate</span>(<span class="at">p =</span> n <span class="sc">/</span> <span class="fu">sum</span>(n)) <span class="sc">%&gt;%</span> </span>
<span id="cb77-420"><a href="#cb77-420"></a>    <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb77-421"><a href="#cb77-421"></a>    <span class="co"># only keep P[Y = 1 | Z]</span></span>
<span id="cb77-422"><a href="#cb77-422"></a>    <span class="fu">filter</span>(Y <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb77-423"><a href="#cb77-423"></a>    <span class="fu">pull</span>(p) <span class="sc">%&gt;%</span> </span>
<span id="cb77-424"><a href="#cb77-424"></a>    <span class="co"># get |p1 - p0|</span></span>
<span id="cb77-425"><a href="#cb77-425"></a>    <span class="fu">reduce</span>(<span class="at">.f =</span> <span class="st">`</span><span class="at">-</span><span class="st">`</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb77-426"><a href="#cb77-426"></a>    <span class="fu">abs</span>()</span>
<span id="cb77-427"><a href="#cb77-427"></a>} </span>
<span id="cb77-428"><a href="#cb77-428"></a></span>
<span id="cb77-429"><a href="#cb77-429"></a>ITT_boot <span class="ot">&lt;-</span> boot<span class="sc">::</span><span class="fu">boot</span>(<span class="at">data =</span> data, </span>
<span id="cb77-430"><a href="#cb77-430"></a>                       <span class="at">statistic =</span> boot_ITT_fun, </span>
<span id="cb77-431"><a href="#cb77-431"></a>                       <span class="at">R =</span> <span class="dv">999</span>, </span>
<span id="cb77-432"><a href="#cb77-432"></a>                       <span class="co"># multicore only works on linux</span></span>
<span id="cb77-433"><a href="#cb77-433"></a>                       <span class="at">parallel =</span> <span class="st">"multicore"</span>)</span>
<span id="cb77-434"><a href="#cb77-434"></a></span>
<span id="cb77-435"><a href="#cb77-435"></a><span class="co"># plot the three distributions</span></span>
<span id="cb77-436"><a href="#cb77-436"></a><span class="fu">set.seed</span>(<span class="dv">23</span>)</span>
<span id="cb77-437"><a href="#cb77-437"></a><span class="fu">bind_rows</span>(</span>
<span id="cb77-438"><a href="#cb77-438"></a>  <span class="fu">tibble</span>(<span class="at">x =</span> <span class="fu">rnorm</span>(<span class="dv">999</span>, <span class="fl">0.0807</span>, <span class="fl">0.0012</span>), <span class="at">y =</span> <span class="st">"Normal approximation"</span>), </span>
<span id="cb77-439"><a href="#cb77-439"></a>  <span class="fu">tibble</span>(<span class="at">x =</span> ITT_boot<span class="sc">$</span>t[, <span class="dv">1</span>], <span class="at">y =</span> <span class="st">"Bootstrap distribution"</span>), </span>
<span id="cb77-440"><a href="#cb77-440"></a>  ITT_posterior <span class="sc">%&gt;%</span> </span>
<span id="cb77-441"><a href="#cb77-441"></a>    <span class="fu">filter</span>(cat <span class="sc">==</span> <span class="st">"Risk difference"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb77-442"><a href="#cb77-442"></a>    <span class="fu">rename</span>(<span class="at">y =</span> cat) <span class="sc">%&gt;%</span> </span>
<span id="cb77-443"><a href="#cb77-443"></a>    <span class="fu">slice_sample</span>(<span class="at">n =</span> <span class="dv">999</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb77-444"><a href="#cb77-444"></a>    <span class="fu">mutate</span>(<span class="at">y =</span> <span class="st">"Beta posterior"</span>)</span>
<span id="cb77-445"><a href="#cb77-445"></a>) <span class="sc">%&gt;%</span> </span>
<span id="cb77-446"><a href="#cb77-446"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> y, <span class="at">group =</span> y, <span class="at">fill =</span> y)) <span class="sc">+</span> </span>
<span id="cb77-447"><a href="#cb77-447"></a>  ggdist<span class="sc">::</span><span class="fu">stat_halfeye</span>() <span class="sc">+</span></span>
<span id="cb77-448"><a href="#cb77-448"></a>  <span class="fu">theme_classic</span>() <span class="sc">+</span> </span>
<span id="cb77-449"><a href="#cb77-449"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>, </span>
<span id="cb77-450"><a href="#cb77-450"></a>        <span class="at">plot.margin =</span> <span class="fu">margin</span>(<span class="fl">0.5</span>, <span class="fl">0.5</span>, <span class="fl">0.5</span>, <span class="fl">0.5</span>, <span class="st">"cm"</span>)) <span class="sc">+</span> </span>
<span id="cb77-451"><a href="#cb77-451"></a>  <span class="fu">xlab</span>(<span class="st">"Distribution of risk difference / uplift (999 samples)"</span>) <span class="sc">+</span> </span>
<span id="cb77-452"><a href="#cb77-452"></a>  <span class="fu">ylab</span>(<span class="st">""</span>) <span class="sc">+</span> </span>
<span id="cb77-453"><a href="#cb77-453"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">labels =</span> scales<span class="sc">::</span><span class="fu">label_percent</span>(<span class="at">accuracy =</span> <span class="fl">0.1</span>))</span>
<span id="cb77-454"><a href="#cb77-454"></a><span class="in">```</span></span>
<span id="cb77-455"><a href="#cb77-455"></a></span>
<span id="cb77-456"><a href="#cb77-456"></a>As expected, despite being philosophically different, all of these methods give nearly identical results (increasing the samples from 999 to 100,000<span class="ot">[^8]</span> would lead to them being virtually identical), but all of these underestimate the correct treatment effect of +10 percentage points.</span>
<span id="cb77-457"><a href="#cb77-457"></a></span>
<span id="cb77-458"><a href="#cb77-458"></a><span class="ot">[^8]: </span>Using the boot package here complains about memory issues when trying to set R = 100,000, and I'm too lazy to write a (parallel) map here myself.</span>
<span id="cb77-459"><a href="#cb77-459"></a></span>
<span id="cb77-460"><a href="#cb77-460"></a><span class="fu">## Per-protocol (PP)</span></span>
<span id="cb77-461"><a href="#cb77-461"></a></span>
<span id="cb77-462"><a href="#cb77-462"></a>The *per-protocol* (PP) effect is generated by including all the people who adhere to the *protocol*, i.e., those with treatment status $A$ identical to the assignment treatment $Z$. Contrary to the ITT effect from the previous section, this effect is a measure of the effectiveness of the actual treatment itself, although this effect estimate is prone to bias.</span>
<span id="cb77-463"><a href="#cb77-463"></a></span>
<span id="cb77-464"><a href="#cb77-464"></a>Since it's not possible for us to measure<span class="ot">[^9]</span> an individual seeing an ad if they were assigned to the control group, i.e, individuals with $Z = 0, A = 1$, this would only exclude all the individuals with $Z = 1$ and $A = 0$, i.e., about 14,000 individuals from the treatment group who didn't see an ad.</span>
<span id="cb77-465"><a href="#cb77-465"></a></span>
<span id="cb77-466"><a href="#cb77-466"></a><span class="ot">[^9]: </span>An individual in the control group cannot see an ad, if the ad is not shown to the individual.</span>
<span id="cb77-467"><a href="#cb77-467"></a></span>
<span id="cb77-470"><a href="#cb77-470"></a><span class="in">```{r}</span></span>
<span id="cb77-471"><a href="#cb77-471"></a>data <span class="sc">%$%</span> <span class="fu">table</span>(A, Z)</span>
<span id="cb77-472"><a href="#cb77-472"></a><span class="in">```</span></span>
<span id="cb77-473"><a href="#cb77-473"></a></span>
<span id="cb77-476"><a href="#cb77-476"></a><span class="in">```{r}</span></span>
<span id="cb77-477"><a href="#cb77-477"></a>data <span class="sc">%&gt;%</span> <span class="fu">filter</span>(A <span class="sc">==</span> Z) <span class="sc">%$%</span> <span class="fu">table</span>(A, Z)</span>
<span id="cb77-478"><a href="#cb77-478"></a><span class="in">```</span></span>
<span id="cb77-479"><a href="#cb77-479"></a></span>
<span id="cb77-482"><a href="#cb77-482"></a><span class="in">```{r}</span></span>
<span id="cb77-483"><a href="#cb77-483"></a>data <span class="sc">%&gt;%</span> </span>
<span id="cb77-484"><a href="#cb77-484"></a>  <span class="co"># only restrict analysis to those with perfect adherence / compliance</span></span>
<span id="cb77-485"><a href="#cb77-485"></a>  <span class="fu">filter</span>(A <span class="sc">==</span> Z) <span class="sc">%$%</span> </span>
<span id="cb77-486"><a href="#cb77-486"></a>  <span class="fu">table</span>(Y, A) <span class="sc">%&gt;%</span> </span>
<span id="cb77-487"><a href="#cb77-487"></a>  <span class="fu">print</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb77-488"><a href="#cb77-488"></a>  <span class="fu">sum</span>()</span>
<span id="cb77-489"><a href="#cb77-489"></a><span class="in">```</span></span>
<span id="cb77-490"><a href="#cb77-490"></a></span>
<span id="cb77-491"><a href="#cb77-491"></a>SImilar to the previous section, the posterior probability of success / conversion and the risk difference for the PP analysis can be obtained by using the same beta-binomial model from the previous section and visually assessed</span>
<span id="cb77-492"><a href="#cb77-492"></a></span>
<span id="cb77-495"><a href="#cb77-495"></a><span class="in">```{r}</span></span>
<span id="cb77-496"><a href="#cb77-496"></a>PP_posterior <span class="ot">&lt;-</span> <span class="fu">sample_from_beta_posterior</span>(</span>
<span id="cb77-497"><a href="#cb77-497"></a>  <span class="at">theta_0 =</span> <span class="fu">c</span>(<span class="dv">261</span> <span class="sc">+</span> <span class="dv">1</span>, <span class="dv">29772</span> <span class="sc">+</span> <span class="dv">9</span>), </span>
<span id="cb77-498"><a href="#cb77-498"></a>  <span class="at">theta_1 =</span> <span class="fu">c</span>(<span class="dv">6234</span> <span class="sc">+</span> <span class="dv">1</span>, <span class="dv">49716</span> <span class="sc">+</span> <span class="dv">9</span>)</span>
<span id="cb77-499"><a href="#cb77-499"></a>)</span>
<span id="cb77-500"><a href="#cb77-500"></a></span>
<span id="cb77-501"><a href="#cb77-501"></a><span class="fu">plot_posteriors</span>(PP_posterior)</span>
<span id="cb77-502"><a href="#cb77-502"></a><span class="in">```</span></span>
<span id="cb77-503"><a href="#cb77-503"></a></span>
<span id="cb77-504"><a href="#cb77-504"></a>The PP effect is exaggerated -- albeit by a relatively small margin -- compared to both the ITT effect and the true treatment effect of +10 percentage points.</span>
<span id="cb77-505"><a href="#cb77-505"></a></span>
<span id="cb77-506"><a href="#cb77-506"></a><span class="fu">## As-treated (AT)</span></span>
<span id="cb77-507"><a href="#cb77-507"></a></span>
<span id="cb77-508"><a href="#cb77-508"></a>The *as-treated* effect (AT) estimates the effect of analyzing individuals by treatment received. This analysis includes individuals in the group corresponding to the treatment actually received. So the individuals randomized to the treatment group who did not see an ad are included in the control group.</span>
<span id="cb77-509"><a href="#cb77-509"></a></span>
<span id="cb77-512"><a href="#cb77-512"></a><span class="in">```{r}</span></span>
<span id="cb77-513"><a href="#cb77-513"></a>data <span class="sc">%$%</span> <span class="fu">table</span>(Y, A)</span>
<span id="cb77-514"><a href="#cb77-514"></a><span class="in">```</span></span>
<span id="cb77-515"><a href="#cb77-515"></a></span>
<span id="cb77-518"><a href="#cb77-518"></a><span class="in">```{r}</span></span>
<span id="cb77-519"><a href="#cb77-519"></a>AT_posterior <span class="ot">&lt;-</span> <span class="fu">sample_from_beta_posterior</span>(</span>
<span id="cb77-520"><a href="#cb77-520"></a>  <span class="at">theta_0 =</span> <span class="fu">c</span>(<span class="dv">279</span> <span class="sc">+</span> <span class="dv">1</span>, <span class="dv">43771</span> <span class="sc">+</span> <span class="dv">9</span>), </span>
<span id="cb77-521"><a href="#cb77-521"></a>  <span class="at">theta_1 =</span> <span class="fu">c</span>(<span class="dv">6234</span> <span class="sc">+</span> <span class="dv">1</span>, <span class="dv">49716</span> <span class="sc">+</span> <span class="dv">9</span>)</span>
<span id="cb77-522"><a href="#cb77-522"></a>)</span>
<span id="cb77-523"><a href="#cb77-523"></a></span>
<span id="cb77-524"><a href="#cb77-524"></a><span class="fu">plot_posteriors</span>(AT_posterior)</span>
<span id="cb77-525"><a href="#cb77-525"></a><span class="in">```</span></span>
<span id="cb77-526"><a href="#cb77-526"></a></span>
<span id="cb77-527"><a href="#cb77-527"></a>Like the PP effect, this effect is a measure of the effectiveness of the actual treatment itself. By including the untreated from the treatment group -- who had a lower probability of conversion -- into the control group, the overall conversion probability in the control group is attenuated thereby leading to an exaggeration of the ATE. Thus, it overestimates the true effect and is likewise exaggerated compared to the ITT effect estimate. It is similarly prone to bias.</span>
<span id="cb77-528"><a href="#cb77-528"></a></span>
<span id="cb77-529"><a href="#cb77-529"></a>We've produced three estimates so far, and since we know the true effect of treatment here, we can see that they're all biased. Great! The analysis could stop here and all the three estimates could be presented with their respective caveats.</span>
<span id="cb77-530"><a href="#cb77-530"></a></span>
<span id="cb77-531"><a href="#cb77-531"></a>But can we do better (in this experiment)?</span>
<span id="cb77-532"><a href="#cb77-532"></a></span>
<span id="cb77-533"><a href="#cb77-533"></a><span class="fu">## Instrumental variable analysis (IV)</span></span>
<span id="cb77-534"><a href="#cb77-534"></a></span>
<span id="cb77-535"><a href="#cb77-535"></a>The fourth and final method of analysis looks at the method of *instrumental variables*. Causal estimates for the treatment effect can be obtained by using just the three variables $<span class="sc">\{</span>Z, A, Y<span class="sc">\}</span>$ if the assumptions behind this method are plausible for our (fictional) ad campaign.</span>
<span id="cb77-536"><a href="#cb77-536"></a></span>
<span id="cb77-537"><a href="#cb77-537"></a>For an instrumental variable analysis to be valid, we need an *instrument* (say $Z$) that needs to satisfy the first three conditions and at least the fourth or the fifth condition</span>
<span id="cb77-538"><a href="#cb77-538"></a></span>
<span id="cb77-539"><a href="#cb77-539"></a><span class="ss">-   </span>*Relevance condition* -- Be correlated (hopefully strongly) with the treatment variable (in our case $A$)</span>
<span id="cb77-540"><a href="#cb77-540"></a></span>
<span id="cb77-541"><a href="#cb77-541"></a><span class="ss">-   </span>*Ignorability -* Be uncorrelated with all measured and unmeasured confounders ($U$) of the $A \rightarrow Y$ relationship and share no common causes with $Y$</span>
<span id="cb77-542"><a href="#cb77-542"></a></span>
<span id="cb77-543"><a href="#cb77-543"></a><span class="ss">-   </span>*Exclusion restriction* -- have no direct impact on the outcome $Y$, only an indirect effect entirely mediated via the treatment $A$</span>
<span id="cb77-544"><a href="#cb77-544"></a></span>
<span id="cb77-545"><a href="#cb77-545"></a><span class="ss">-   </span>*(Weak) Homogeneity* -- for a binary $Z-A$ system, if $Z$ is not an *effect modifier* of the $A-Y$ relationship, i.e.,\</span>
<span id="cb77-546"><a href="#cb77-546"></a>    $\mathbb{E}<span class="co">[</span><span class="ot">Y^{a = 1} - Y^{a = 0} | Z = 1, A = a</span><span class="co">]</span> = \mathbb{E}<span class="co">[</span><span class="ot">Y^{a = 1} - Y^{a = 0} | Z = 0, A = a</span><span class="co">]</span>$ then the IV estimate can be interpreted as the *average treatment effect among the treated (ATT)* in the population. If the ATT is identical to the *ATU(ntreated),* then the IV estimate can be interpreted as the *ATE in the population.* Other homogeneity conditions are described in section 16.3 of the what-if book. Appendix 2.1 of the Hernán, Robins 2006 paper has some stuff on this too.</span>
<span id="cb77-547"><a href="#cb77-547"></a></span>
<span id="cb77-548"><a href="#cb77-548"></a><span class="ss">-   </span>*Monotonicity* - The trial population can be partitioned into four-latent subgroups / *prinicipal strata* defined by a combination of $A, Z$ - *always takers, compliers, never-takers, and defiers*. Always (or never) takers are people who would always (or never) take the treatment independent of group assignment. Compliers would comply with the treatment corresponding to the group they are assigned to. Defiers would do the opposite to the group they're assigned to. In the absence of defiers and always takers, the IV estimand is the *complier average causal effect (CACE)* or the *local average treatment effect (LATE).* This can be written as</span>
<span id="cb77-549"><a href="#cb77-549"></a></span>
<span id="cb77-550"><a href="#cb77-550"></a>    $$</span>
<span id="cb77-551"><a href="#cb77-551"></a>    \mathbb{E}<span class="co">[</span><span class="ot">Y^{a = 1} - Y^{a = 0} | A^{z = 1} \gt A^{z = 0}</span><span class="co">]</span> = \frac{\mathbb{E}<span class="co">[</span><span class="ot">Y = 1 | Z = 1</span><span class="co">]</span> - \mathbb{E}<span class="co">[</span><span class="ot">Y = 1 | Z = 0</span><span class="co">]</span>}{\mathbb{E}<span class="co">[</span><span class="ot">A = 1 | Z = 1</span><span class="co">]</span> - \mathbb{E}<span class="co">[</span><span class="ot">A = 1 | Z = 0</span><span class="co">]</span>}</span>
<span id="cb77-552"><a href="#cb77-552"></a>    $$</span>
<span id="cb77-553"><a href="#cb77-553"></a></span>
<span id="cb77-554"><a href="#cb77-554"></a>The variable $Z$ from the DAG for this problem</span>
<span id="cb77-555"><a href="#cb77-555"></a></span>
<span id="cb77-558"><a href="#cb77-558"></a><span class="in">```{r}</span></span>
<span id="cb77-559"><a href="#cb77-559"></a><span class="co">#| code-fold: true</span></span>
<span id="cb77-560"><a href="#cb77-560"></a><span class="fu">plot</span>(dag)</span>
<span id="cb77-561"><a href="#cb77-561"></a><span class="in">```</span></span>
<span id="cb77-562"><a href="#cb77-562"></a></span>
<span id="cb77-563"><a href="#cb77-563"></a>seems to fulfill the first three conditions, since individuals are randomly assigned into treatment and control groups. This makes it a *causal instrument*, as an individual cannot choose to see an ad unless they're assigned to the treatment group.</span>
<span id="cb77-564"><a href="#cb77-564"></a></span>
<span id="cb77-565"><a href="#cb77-565"></a>Regarding homogeneity, it can be argued that the assignment of an individual<span class="ot">[^10]</span> to the group cannot be an effect modifier, since this is done by a random number generator and so should not affect the potential outcomes.</span>
<span id="cb77-566"><a href="#cb77-566"></a></span>
<span id="cb77-567"><a href="#cb77-567"></a><span class="ot">[^10]: </span>In the presence of *interference*, e.g. individuals in the same household being assigned to different groups but affecting each others' potential outcomes, the unit of assignment and analysis would be at the household level.</span>
<span id="cb77-568"><a href="#cb77-568"></a></span>
<span id="cb77-569"><a href="#cb77-569"></a>Since the ad is randomized at the individual level, there can never be any defiers (i.e., individuals assigned to the control group can never deliberately switch over to the treatment group). Always takers are also not an option, since people assigned to the control group cannot choose to take the treatment<span class="ot">[^11]</span>. This essentially leaves the population to be a mix of never-takers and compliers.</span>
<span id="cb77-570"><a href="#cb77-570"></a></span>
<span id="cb77-571"><a href="#cb77-571"></a><span class="ot">[^11]: </span>Not that anyone would *choose* to see an ad.</span>
<span id="cb77-572"><a href="#cb77-572"></a></span>
<span id="cb77-573"><a href="#cb77-573"></a><span class="fu">### IV in action</span></span>
<span id="cb77-574"><a href="#cb77-574"></a></span>
<span id="cb77-575"><a href="#cb77-575"></a>Since the instrument, treatment, and outcome are all binary, we can use the following *ratio / Wald estimator* for the IV estimand</span>
<span id="cb77-576"><a href="#cb77-576"></a></span>
<span id="cb77-577"><a href="#cb77-577"></a>$$</span>
<span id="cb77-578"><a href="#cb77-578"></a>\text{IV} = \frac{\text{Pr}<span class="co">[</span><span class="ot">Y = 1 | Z = 1</span><span class="co">]</span> - \text{Pr}<span class="co">[</span><span class="ot">Y = 1 | Z = 0</span><span class="co">]</span>}{\text{Pr}<span class="co">[</span><span class="ot">A = 1 | Z = 1</span><span class="co">]</span> - \text{Pr}<span class="co">[</span><span class="ot">A = 1 | Z = 0</span><span class="co">]</span>}</span>
<span id="cb77-579"><a href="#cb77-579"></a>$$</span>
<span id="cb77-580"><a href="#cb77-580"></a></span>
<span id="cb77-581"><a href="#cb77-581"></a>where the numerator is the ITT effect estimate defined a few sections above, and the denominator is a measure of compliance on the risk difference scale with regards to the assigned treatment, i.e., an association between treatment assignment $Z$ and treatment uptake $A$.</span>
<span id="cb77-582"><a href="#cb77-582"></a></span>
<span id="cb77-583"><a href="#cb77-583"></a>Depending on whether we invoke one of the homogeneity assumptions or the monotonicity assumption, we end up with either the average causal effect in the treated, or in the population, or the average causal effect among the compliers. All the different assumptions for this are described in the Swanson et al 2018 article.</span>
<span id="cb77-584"><a href="#cb77-584"></a></span>
<span id="cb77-585"><a href="#cb77-585"></a>To fit this Beta-binomial model to the data, we can use the posterior distribution of the risk difference from the ITT effect for the numerator. For the denominator, we need to get a similar distribution of treatment compliance. Looking at the 2x2 $Z-A$ table,</span>
<span id="cb77-586"><a href="#cb77-586"></a></span>
<span id="cb77-589"><a href="#cb77-589"></a><span class="in">```{r}</span></span>
<span id="cb77-590"><a href="#cb77-590"></a>data <span class="sc">%$%</span> <span class="fu">table</span>(A, Z)</span>
<span id="cb77-591"><a href="#cb77-591"></a><span class="in">```</span></span>
<span id="cb77-592"><a href="#cb77-592"></a></span>
<span id="cb77-593"><a href="#cb77-593"></a>the group of $\text{Pr}<span class="co">[</span><span class="ot">A = 1 | Z = 0</span><span class="co">]</span>$ is (expected to be) 0, since those assigned to the control group should not be able to see the ad. We can pick a *degenerate* (Beta) prior distribution<span class="ot">[^12]</span> with $\alpha = 0,\ \beta &gt; 0$, e.g., $\text{Beta}(0, 1)$, which results in a Beta posterior with shape $\alpha = 0 + 0 = 0,\ \beta = 30033 + 1 = 30034$. Since $\alpha = 0$, all draws from this posterior distribution are exactly zero.</span>
<span id="cb77-594"><a href="#cb77-594"></a></span>
<span id="cb77-595"><a href="#cb77-595"></a><span class="ot">[^12]: </span>Since I'm not using Stan to fit the model here, I can get away with this. Using Stan, I'd pick something like a $\text{Beta}(1, 10000)$ distribution that puts a very small non-zero probability for $\text{Pr}<span class="co">[</span><span class="ot">A = 1 | Z = 0</span><span class="co">]</span>$. I don't know for sure whether the degenerate prior would cause issues for Stan to be honest.</span>
<span id="cb77-596"><a href="#cb77-596"></a></span>
<span id="cb77-599"><a href="#cb77-599"></a><span class="in">```{r}</span></span>
<span id="cb77-600"><a href="#cb77-600"></a><span class="fu">summary</span>(<span class="fu">rbeta</span>(<span class="fl">1e2</span>, <span class="dv">0</span>, <span class="dv">30034</span>))</span>
<span id="cb77-601"><a href="#cb77-601"></a><span class="in">```</span></span>
<span id="cb77-602"><a href="#cb77-602"></a></span>
<span id="cb77-603"><a href="#cb77-603"></a>For $\text{Pr}<span class="co">[</span><span class="ot">A = 1 | Z = 1</span><span class="co">]</span>$, we can expect the compliance to be reasonably high, so the $\text{Beta}(7, 3)$ with a mean compliance of 70%, and a range of 10%-100% might be a good choice. With the large sample sizes in the dataset, the prior is going to be dominated by the likelihood anyway.</span>
<span id="cb77-604"><a href="#cb77-604"></a></span>
<span id="cb77-607"><a href="#cb77-607"></a><span class="in">```{r}</span></span>
<span id="cb77-608"><a href="#cb77-608"></a><span class="fu">summary</span>(<span class="fu">rbeta</span>(<span class="fl">1e4</span>, <span class="dv">7</span>, <span class="dv">3</span>))</span>
<span id="cb77-609"><a href="#cb77-609"></a><span class="in">```</span></span>
<span id="cb77-610"><a href="#cb77-610"></a></span>
<span id="cb77-611"><a href="#cb77-611"></a>Using the counts from the $A-Z$ table above, we get the $\text{Beta}(55957, 14020)$ posterior with $\alpha = 7 + 55950$ and $\beta = 3 + 14017$. Taking a difference of these two posteriors would leave this posterior unchanged, so we can produce the corresponding IV posterior distribution</span>
<span id="cb77-612"><a href="#cb77-612"></a></span>
<span id="cb77-615"><a href="#cb77-615"></a><span class="in">```{r}</span></span>
<span id="cb77-616"><a href="#cb77-616"></a><span class="co">#| code-fold: true</span></span>
<span id="cb77-617"><a href="#cb77-617"></a><span class="fu">set.seed</span>(<span class="dv">23</span>)</span>
<span id="cb77-618"><a href="#cb77-618"></a>compliance_posterior <span class="ot">&lt;-</span> <span class="fu">rbeta</span>(<span class="fu">nrow</span>(ITT_risk_difference), <span class="dv">55957</span>, <span class="dv">14020</span>)</span>
<span id="cb77-619"><a href="#cb77-619"></a></span>
<span id="cb77-620"><a href="#cb77-620"></a>IV_labels <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Intention-to-treat effect"</span>, </span>
<span id="cb77-621"><a href="#cb77-621"></a>               <span class="st">"Proportion of compliers"</span>, </span>
<span id="cb77-622"><a href="#cb77-622"></a>               <span class="st">"Instrumental variable estimate"</span>)</span>
<span id="cb77-623"><a href="#cb77-623"></a></span>
<span id="cb77-624"><a href="#cb77-624"></a>IV_posterior <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb77-625"><a href="#cb77-625"></a>  <span class="at">id =</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(ITT_risk_difference), <span class="at">times =</span> <span class="dv">3</span>),</span>
<span id="cb77-626"><a href="#cb77-626"></a>  <span class="at">cat =</span> <span class="fu">factor</span>(<span class="fu">rep</span>(IV_labels, <span class="at">each =</span> <span class="fu">nrow</span>(ITT_risk_difference)), </span>
<span id="cb77-627"><a href="#cb77-627"></a>               <span class="at">levels =</span> IV_labels),</span>
<span id="cb77-628"><a href="#cb77-628"></a>  <span class="at">x =</span> <span class="fu">c</span>(ITT_risk_difference<span class="sc">$</span>x, compliance_posterior, </span>
<span id="cb77-629"><a href="#cb77-629"></a>        ITT_risk_difference<span class="sc">$</span>x <span class="sc">/</span> compliance_posterior)</span>
<span id="cb77-630"><a href="#cb77-630"></a>)</span>
<span id="cb77-631"><a href="#cb77-631"></a></span>
<span id="cb77-632"><a href="#cb77-632"></a>true_effect_IV <span class="ot">&lt;-</span> true_effect <span class="sc">%&gt;%</span> </span>
<span id="cb77-633"><a href="#cb77-633"></a>  <span class="fu">mutate</span>(<span class="at">cat =</span> <span class="fu">factor</span>(IV_labels, <span class="at">levels =</span> IV_labels))</span>
<span id="cb77-634"><a href="#cb77-634"></a></span>
<span id="cb77-635"><a href="#cb77-635"></a><span class="fu">plot_posteriors</span>(IV_posterior, true_effect_IV)</span>
<span id="cb77-636"><a href="#cb77-636"></a><span class="in">```</span></span>
<span id="cb77-637"><a href="#cb77-637"></a></span>
<span id="cb77-640"><a href="#cb77-640"></a><span class="in">```{r}</span></span>
<span id="cb77-641"><a href="#cb77-641"></a>IV_posterior <span class="sc">%&gt;%</span> </span>
<span id="cb77-642"><a href="#cb77-642"></a>  <span class="fu">filter</span>(cat <span class="sc">==</span> IV_labels[<span class="dv">3</span>]) <span class="sc">%&gt;%</span> </span>
<span id="cb77-643"><a href="#cb77-643"></a>  <span class="fu">summarize</span>(<span class="at">mean =</span> <span class="fu">mean</span>(x), </span>
<span id="cb77-644"><a href="#cb77-644"></a>            <span class="at">lower =</span> <span class="fu">quantile</span>(x, <span class="at">probs =</span> <span class="fl">0.025</span>), </span>
<span id="cb77-645"><a href="#cb77-645"></a>            <span class="at">upper =</span> <span class="fu">quantile</span>(x, <span class="fl">0.975</span>))</span>
<span id="cb77-646"><a href="#cb77-646"></a><span class="in">```</span></span>
<span id="cb77-647"><a href="#cb77-647"></a></span>
<span id="cb77-648"><a href="#cb77-648"></a>Compared to the ITT, PP, and AT estimates, the IV estimate is the closest to the true treatment effect of +10 percentage points, which makes sense as all the IV conditions are valid here due to the use of a randomized experiment with the causal instrument $Z$. However, if any of the conditions (monotonicity, relevance, etc.) were to weaken, this would lead to bias in the IV estimate.</span>
<span id="cb77-649"><a href="#cb77-649"></a></span>
<span id="cb77-650"><a href="#cb77-650"></a>Some recommend producing bounds<span class="ot">[^13]</span> for the IV estimate since it's usually not *point identified.* For the case of binary $Z, A, Y$, we can use `ivtools::ivbounds()` to produce the *natural bounds* -- which are between 8%-28% for the ATE (<span class="in">`CRD`</span> in the result)</span>
<span id="cb77-651"><a href="#cb77-651"></a></span>
<span id="cb77-652"><a href="#cb77-652"></a><span class="ot">[^13]: </span>Note to (future) self: look at the Balke, Pearl 1997 and Swanson et al 2018 papers, and the <span class="in">`causaloptim`</span> R package.</span>
<span id="cb77-653"><a href="#cb77-653"></a></span>
<span id="cb77-656"><a href="#cb77-656"></a><span class="in">```{r}</span></span>
<span id="cb77-657"><a href="#cb77-657"></a>data <span class="sc">%&gt;%</span> </span>
<span id="cb77-658"><a href="#cb77-658"></a>  ivtools<span class="sc">::</span><span class="fu">ivbounds</span>(<span class="at">data =</span> ., </span>
<span id="cb77-659"><a href="#cb77-659"></a>                    <span class="at">Z =</span> <span class="st">"Z"</span>, <span class="at">X =</span> <span class="st">"A"</span>, <span class="at">Y =</span> <span class="st">"Y"</span>, </span>
<span id="cb77-660"><a href="#cb77-660"></a>                    <span class="at">monotonicity =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb77-661"><a href="#cb77-661"></a>  <span class="fu">summary</span>()</span>
<span id="cb77-662"><a href="#cb77-662"></a><span class="in">```</span></span>
<span id="cb77-663"><a href="#cb77-663"></a></span>
<span id="cb77-664"><a href="#cb77-664"></a>The width of the bounds is 20 percentage points, which matches the formula for the width<span class="ot">[^14]</span> -- $\text{Pr}<span class="co">[</span><span class="ot">A = 1 | Z = 0</span><span class="co">]</span> + \text{Pr}<span class="co">[</span><span class="ot">A = 0 | Z = 1</span><span class="co">]</span>$ -- where the former is 0, since we have no defiers, and 20% for the second quantity, which is the proportion of never-takers.</span>
<span id="cb77-665"><a href="#cb77-665"></a></span>
<span id="cb77-666"><a href="#cb77-666"></a><span class="ot">[^14]: </span>given in some of the references below</span>
<span id="cb77-667"><a href="#cb77-667"></a></span>
<span id="cb77-668"><a href="#cb77-668"></a>The slight difference between the true value and the estimate is due to sampling variability, which can be assessed by simulating multiple datasets with different seeds to give a mean ATE *very* close to +10 percentage points</span>
<span id="cb77-669"><a href="#cb77-669"></a></span>
<span id="cb77-672"><a href="#cb77-672"></a><span class="in">```{r}</span></span>
<span id="cb77-673"><a href="#cb77-673"></a><span class="co">#| code-fold: true</span></span>
<span id="cb77-674"><a href="#cb77-674"></a><span class="fu">map_dbl</span>(</span>
<span id="cb77-675"><a href="#cb77-675"></a>  <span class="at">.x =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">100</span>, </span>
<span id="cb77-676"><a href="#cb77-676"></a>  <span class="at">.f =</span> <span class="sc">~</span> {</span>
<span id="cb77-677"><a href="#cb77-677"></a>    .x <span class="sc">%&gt;%</span> </span>
<span id="cb77-678"><a href="#cb77-678"></a>      <span class="fu">simulate_data</span>(<span class="at">seed =</span> .) <span class="sc">%&gt;%</span> </span>
<span id="cb77-679"><a href="#cb77-679"></a>      <span class="fu">mutate</span>(<span class="at">diff =</span> (Y1 <span class="sc">-</span> Y0) <span class="sc">/</span> <span class="fl">0.8</span>) <span class="sc">%&gt;%</span></span>
<span id="cb77-680"><a href="#cb77-680"></a>      <span class="fu">pull</span>(diff) <span class="sc">%&gt;%</span> </span>
<span id="cb77-681"><a href="#cb77-681"></a>      <span class="fu">mean</span>()</span>
<span id="cb77-682"><a href="#cb77-682"></a>    }) <span class="sc">%&gt;%</span> <span class="fu">mean</span>()</span>
<span id="cb77-683"><a href="#cb77-683"></a><span class="in">```</span></span>
<span id="cb77-684"><a href="#cb77-684"></a></span>
<span id="cb77-685"><a href="#cb77-685"></a><span class="fu">## All the estimates in a single plot</span></span>
<span id="cb77-686"><a href="#cb77-686"></a></span>
<span id="cb77-687"><a href="#cb77-687"></a>We can look at all four estimates in a single plot</span>
<span id="cb77-688"><a href="#cb77-688"></a></span>
<span id="cb77-691"><a href="#cb77-691"></a><span class="in">```{r}</span></span>
<span id="cb77-692"><a href="#cb77-692"></a><span class="co">#| code-fold: true</span></span>
<span id="cb77-693"><a href="#cb77-693"></a><span class="fu">list</span>(</span>
<span id="cb77-694"><a href="#cb77-694"></a>  <span class="st">"Instrumental variable"</span> <span class="ot">=</span> IV_posterior, </span>
<span id="cb77-695"><a href="#cb77-695"></a>  <span class="st">"As-treated"</span> <span class="ot">=</span> AT_posterior, </span>
<span id="cb77-696"><a href="#cb77-696"></a>  <span class="st">"Per-protocol"</span> <span class="ot">=</span> PP_posterior, </span>
<span id="cb77-697"><a href="#cb77-697"></a>  <span class="st">"Intention-to-treat"</span> <span class="ot">=</span> ITT_posterior</span>
<span id="cb77-698"><a href="#cb77-698"></a>) <span class="sc">%&gt;%</span> </span>
<span id="cb77-699"><a href="#cb77-699"></a>  <span class="fu">map2_dfr</span>(<span class="at">.x =</span> ., <span class="at">.y =</span> <span class="fu">names</span>(.), <span class="at">.f =</span> <span class="sc">~</span> {</span>
<span id="cb77-700"><a href="#cb77-700"></a>    .x <span class="sc">%&gt;%</span> </span>
<span id="cb77-701"><a href="#cb77-701"></a>      <span class="fu">filter</span>(<span class="fu">str_detect</span>(cat, <span class="st">"Risk|Instrument"</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb77-702"><a href="#cb77-702"></a>      <span class="fu">mutate</span>(<span class="at">cat =</span> {{ .y }})</span>
<span id="cb77-703"><a href="#cb77-703"></a>    }) <span class="sc">%&gt;%</span> </span>
<span id="cb77-704"><a href="#cb77-704"></a>  <span class="fu">mutate</span>(</span>
<span id="cb77-705"><a href="#cb77-705"></a>    <span class="at">cat =</span> <span class="fu">factor</span>(cat, <span class="at">levels =</span> <span class="fu">c</span>(</span>
<span id="cb77-706"><a href="#cb77-706"></a>      <span class="st">"Instrumental variable"</span>, <span class="st">"As-treated"</span>,</span>
<span id="cb77-707"><a href="#cb77-707"></a>      <span class="st">"Per-protocol"</span>, <span class="st">"Intention-to-treat"</span></span>
<span id="cb77-708"><a href="#cb77-708"></a>  ))) <span class="sc">%&gt;%</span> </span>
<span id="cb77-709"><a href="#cb77-709"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> cat, <span class="at">group =</span> cat, <span class="at">fill =</span> <span class="fu">rev</span>(cat))) <span class="sc">+</span> </span>
<span id="cb77-710"><a href="#cb77-710"></a>  ggdist<span class="sc">::</span><span class="fu">stat_halfeye</span>(</span>
<span id="cb77-711"><a href="#cb77-711"></a>    <span class="at">show.legend =</span> <span class="cn">FALSE</span></span>
<span id="cb77-712"><a href="#cb77-712"></a>  ) <span class="sc">+</span></span>
<span id="cb77-713"><a href="#cb77-713"></a>  <span class="fu">geom_vline</span>(</span>
<span id="cb77-714"><a href="#cb77-714"></a>    <span class="at">xintercept =</span> pY1 <span class="sc">-</span> pY0, </span>
<span id="cb77-715"><a href="#cb77-715"></a>    <span class="at">color =</span> <span class="st">"gray50"</span>, </span>
<span id="cb77-716"><a href="#cb77-716"></a>    <span class="at">linetype =</span> <span class="st">"dashed"</span>,</span>
<span id="cb77-717"><a href="#cb77-717"></a>    <span class="at">linewidth =</span> <span class="fl">1.3</span></span>
<span id="cb77-718"><a href="#cb77-718"></a>  ) <span class="sc">+</span></span>
<span id="cb77-719"><a href="#cb77-719"></a>  <span class="fu">geom_vline</span>(</span>
<span id="cb77-720"><a href="#cb77-720"></a>    <span class="at">xintercept =</span> true_ITT_effect, </span>
<span id="cb77-721"><a href="#cb77-721"></a>    <span class="at">color =</span> <span class="st">"gray20"</span>, </span>
<span id="cb77-722"><a href="#cb77-722"></a>    <span class="at">linetype =</span> <span class="st">"dotted"</span>,</span>
<span id="cb77-723"><a href="#cb77-723"></a>    <span class="at">linewidth =</span> <span class="fl">1.3</span></span>
<span id="cb77-724"><a href="#cb77-724"></a>  ) <span class="sc">+</span></span>
<span id="cb77-725"><a href="#cb77-725"></a>  <span class="fu">theme_classic</span>() <span class="sc">+</span> </span>
<span id="cb77-726"><a href="#cb77-726"></a>  <span class="fu">xlab</span>(<span class="fu">paste0</span>(</span>
<span id="cb77-727"><a href="#cb77-727"></a>    <span class="st">"Posterior distribution of risk difference / uplift</span><span class="sc">\n</span><span class="st">"</span>, </span>
<span id="cb77-728"><a href="#cb77-728"></a>    <span class="st">"(Dotted line: ATE in this population; dashed line: true ATE)"</span></span>
<span id="cb77-729"><a href="#cb77-729"></a>  )) <span class="sc">+</span> </span>
<span id="cb77-730"><a href="#cb77-730"></a>  <span class="fu">ylab</span>(<span class="st">""</span>) <span class="sc">+</span> </span>
<span id="cb77-731"><a href="#cb77-731"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">labels =</span> scales<span class="sc">::</span><span class="fu">label_percent</span>(<span class="at">accuracy =</span> <span class="fl">0.1</span>))</span>
<span id="cb77-732"><a href="#cb77-732"></a><span class="in">```</span></span>
<span id="cb77-733"><a href="#cb77-733"></a></span>
<span id="cb77-734"><a href="#cb77-734"></a>The IV estimate is the closest to the true treatment effectiveness of +10 percentage points (in gray), with the AT and the PP effects both showing some bias.</span>
<span id="cb77-735"><a href="#cb77-735"></a></span>
<span id="cb77-736"><a href="#cb77-736"></a>The simulated data analyzed here are from a relatively clean setting where the treatment effectiveness, sample sizes, and strength of association between A-Z are all very high. If any of these conditions weaken, the analysis may become more challenging.</span>
<span id="cb77-737"><a href="#cb77-737"></a></span>
<span id="cb77-738"><a href="#cb77-738"></a><span class="fu">## Profit distribution</span></span>
<span id="cb77-739"><a href="#cb77-739"></a></span>
<span id="cb77-740"><a href="#cb77-740"></a>So we have two valid estimates -- the ITT and the IV estimate. Can we use these estimates to calculate the total profit from this campaign, as well as other hypothetical campaigns with varying treatment / control splits and compliance?</span>
<span id="cb77-741"><a href="#cb77-741"></a></span>
<span id="cb77-742"><a href="#cb77-742"></a>This assumes that</span>
<span id="cb77-743"><a href="#cb77-743"></a></span>
<span id="cb77-744"><a href="#cb77-744"></a><span class="ss">-   </span>the effect of treatment among the compliers and the never-takers would be the same</span>
<span id="cb77-745"><a href="#cb77-745"></a></span>
<span id="cb77-746"><a href="#cb77-746"></a><span class="ss">-   </span>the conversion probabilities specified below would apply to these other populations</span>
<span id="cb77-747"><a href="#cb77-747"></a></span>
<span id="cb77-748"><a href="#cb77-748"></a><span class="ss">-   </span>compliance varies randomly between populations</span>
<span id="cb77-749"><a href="#cb77-749"></a></span>
<span id="cb77-750"><a href="#cb77-750"></a>Data from other experiments, if available, can be used to get more realistic estimates by capturing the heterogeneity in the estimated probabilities (e.g., by meta-analysis).</span>
<span id="cb77-751"><a href="#cb77-751"></a></span>
<span id="cb77-752"><a href="#cb77-752"></a>To estimate the total profit, we need the following probability of conversion</span>
<span id="cb77-753"><a href="#cb77-753"></a></span>
<span id="cb77-754"><a href="#cb77-754"></a>$$</span>
<span id="cb77-755"><a href="#cb77-755"></a>\text{Pr}<span class="co">[</span><span class="ot">Y = 1</span><span class="co">]</span> = \sum_z \text{Pr}<span class="co">[</span><span class="ot">Y = 1 | Z = z</span><span class="co">]</span> \text{Pr}<span class="co">[</span><span class="ot">Z = z</span><span class="co">]</span> </span>
<span id="cb77-756"><a href="#cb77-756"></a>$$</span>
<span id="cb77-757"><a href="#cb77-757"></a></span>
<span id="cb77-758"><a href="#cb77-758"></a>where $\text{Pr}<span class="co">[</span><span class="ot">Z = z</span><span class="co">]</span>$ is the proportion of people assigned to treatment ($Z = 1$) and control ($Z = 0$), and the $\text{Pr}<span class="co">[</span><span class="ot">Y = 1 | Z = z</span><span class="co">]</span>$ is the ITT estimate<span class="ot">[^15]</span> in each arm. The ITT estimate under the monotonicity assumption can be further decomposed -- using the <span class="co">[</span><span class="ot">*law of total probability*</span><span class="co">](https://en.wikipedia.org/wiki/Law_of_total_probability)</span> -- into a weighted sum of the conversion probabilities among the compliers and the never-takers<span class="ot">[^16]</span></span>
<span id="cb77-759"><a href="#cb77-759"></a></span>
<span id="cb77-760"><a href="#cb77-760"></a><span class="ot">[^15]: </span>Technically an *estimand*, but feels odd to type out 'estimand' everywhere in this and following paragraphs instead of 'estimate'.</span>
<span id="cb77-761"><a href="#cb77-761"></a></span>
<span id="cb77-762"><a href="#cb77-762"></a><span class="ot">[^16]: </span>The $\text{Pr}<span class="co">[</span><span class="ot">Z = z</span><span class="co">]</span>$ term in the numerator on the right side of the equation is constant with respect to the summation (over $c$), so can be pulled out and cancels out the same term in the denominator.</span>
<span id="cb77-763"><a href="#cb77-763"></a></span>
<span id="cb77-764"><a href="#cb77-764"></a>$$</span>
<span id="cb77-765"><a href="#cb77-765"></a>\text{Pr}<span class="co">[</span><span class="ot">Y = 1 | Z = z</span><span class="co">]</span> = \sum_c \text{Pr}<span class="co">[</span><span class="ot">Y = 1 | Z = z, C = c</span><span class="co">]</span> \text{Pr}<span class="co">[</span><span class="ot">C = c | Z = z</span><span class="co">]</span> </span>
<span id="cb77-766"><a href="#cb77-766"></a>$$</span>
<span id="cb77-767"><a href="#cb77-767"></a></span>
<span id="cb77-768"><a href="#cb77-768"></a>where $\text{Pr}<span class="co">[</span><span class="ot">C = c | Z = z</span><span class="co">]</span> = \text{Pr}<span class="co">[</span><span class="ot">C = c</span><span class="co">]</span>$ because $Z$ is randomly assigned, so $Z \perp<span class="sc">\!\!\!</span>\perp C$, i.e., $Z$ and $C$ are independent.</span>
<span id="cb77-769"><a href="#cb77-769"></a></span>
<span id="cb77-770"><a href="#cb77-770"></a>Our best estimate of compliance is given by</span>
<span id="cb77-771"><a href="#cb77-771"></a></span>
<span id="cb77-772"><a href="#cb77-772"></a>$$</span>
<span id="cb77-773"><a href="#cb77-773"></a>\text{Pr}<span class="co">[</span><span class="ot">C = 1</span><span class="co">]</span> = \text{Pr}<span class="co">[</span><span class="ot">A = 1 | Z = 1</span><span class="co">]</span> - \text{Pr}<span class="co">[</span><span class="ot">A = 1 | Z = 0</span><span class="co">]</span></span>
<span id="cb77-774"><a href="#cb77-774"></a>$$</span>
<span id="cb77-775"><a href="#cb77-775"></a></span>
<span id="cb77-776"><a href="#cb77-776"></a>and $\text{Pr}<span class="co">[</span><span class="ot">C = 0</span><span class="co">]</span> = 1 - \text{Pr}<span class="co">[</span><span class="ot">C = 1</span><span class="co">]</span>$ is the proportion of never-takers. To get the conditional probability in the first term in the sum, we can rewrite the previous equation -- shown only for $Z = 1$ but is the same for $Z = 0$ -- after diving each term by $\text{Pr}<span class="co">[</span><span class="ot">C = 1</span><span class="co">]</span>$</span>
<span id="cb77-777"><a href="#cb77-777"></a></span>
<span id="cb77-778"><a href="#cb77-778"></a>$$</span>
<span id="cb77-779"><a href="#cb77-779"></a>\begin{split}</span>
<span id="cb77-780"><a href="#cb77-780"></a>\frac{\text{Pr}<span class="co">[</span><span class="ot">Y = 1 | Z = 1</span><span class="co">]</span>}{\text{Pr}<span class="co">[</span><span class="ot">C = 1</span><span class="co">]</span>} &amp; = \text{Pr}<span class="co">[</span><span class="ot">Y = 1 | Z = 1, C = 1</span><span class="co">]</span> <span class="sc">\\</span> &amp; + \text{Pr}<span class="co">[</span><span class="ot">Y = 1 | Z = 1, C = 0</span><span class="co">]</span> \frac{\text{Pr}<span class="co">[</span><span class="ot">C = 0</span><span class="co">]</span>}{\text{Pr}<span class="co">[</span><span class="ot">C = 1</span><span class="co">]</span>} </span>
<span id="cb77-781"><a href="#cb77-781"></a>\end{split}</span>
<span id="cb77-782"><a href="#cb77-782"></a>$$</span>
<span id="cb77-783"><a href="#cb77-783"></a></span>
<span id="cb77-784"><a href="#cb77-784"></a>The term on the left is the ITT estimate rescaled by the proportion of compliers. The first term on the right is the conversion probability among the compliers who received the treatment $\text{Pr}<span class="co">[</span><span class="ot">Y = 1 | Z = 1, C = 1</span><span class="co">]</span>$, and the second term on the right is the probability of conversion among the never-takers who were assigned to the treatment, weighted by the ratio of never-takers to compliers.</span>
<span id="cb77-785"><a href="#cb77-785"></a></span>
<span id="cb77-786"><a href="#cb77-786"></a>This also shows why subtracting the two rescaled ITT estimates (i.e., the IV estimate) is the effect of treatment among the compliers -- the second term on the right cancels out (under the assumption of exclusion restriction) since $Z$ is randomly assigned, so the never-takers in each arm should have the same probability of conversion</span>
<span id="cb77-787"><a href="#cb77-787"></a></span>
<span id="cb77-788"><a href="#cb77-788"></a>$$</span>
<span id="cb77-789"><a href="#cb77-789"></a>\text{Pr}<span class="co">[</span><span class="ot">Y = 1 | Z = 1, C = 0</span><span class="co">]</span> = \text{Pr}<span class="co">[</span><span class="ot">Y = 1 | Z = 0, C = 0</span><span class="co">]</span></span>
<span id="cb77-790"><a href="#cb77-790"></a>$$</span>
<span id="cb77-791"><a href="#cb77-791"></a></span>
<span id="cb77-792"><a href="#cb77-792"></a>and proportion of compliers $\text{Pr}<span class="co">[</span><span class="ot">C = 1 | Z = 1</span><span class="co">]</span> = \text{Pr}<span class="co">[</span><span class="ot">C = 1 | Z = 0</span><span class="co">]</span>$, and we're left with</span>
<span id="cb77-793"><a href="#cb77-793"></a></span>
<span id="cb77-794"><a href="#cb77-794"></a>$$</span>
<span id="cb77-795"><a href="#cb77-795"></a>\text{Pr}<span class="co">[</span><span class="ot">Y = 1 | Z = 1, C = 1</span><span class="co">]</span> - \text{Pr}<span class="co">[</span><span class="ot">Y = 1 | Z = 0, C = 1</span><span class="co">]</span></span>
<span id="cb77-796"><a href="#cb77-796"></a>$$</span>
<span id="cb77-797"><a href="#cb77-797"></a></span>
<span id="cb77-798"><a href="#cb77-798"></a>which is the CACE from the IV analysis.</span>
<span id="cb77-799"><a href="#cb77-799"></a></span>
<span id="cb77-800"><a href="#cb77-800"></a>While compliance ($C$) is unobserved, we can estimate all these probabilites using the combined information present in $Z, A, Y$ along with the assumptions in the previous paragraphs.</span>
<span id="cb77-801"><a href="#cb77-801"></a></span>
<span id="cb77-802"><a href="#cb77-802"></a>For the proportion of compliers ($\text{Pr}<span class="co">[</span><span class="ot">C = 1</span><span class="co">]</span>$), we can use the posterior distribution we obtained for the IV analysis.</span>
<span id="cb77-803"><a href="#cb77-803"></a></span>
<span id="cb77-806"><a href="#cb77-806"></a><span class="in">```{r}</span></span>
<span id="cb77-807"><a href="#cb77-807"></a>prop_compliers <span class="ot">&lt;-</span> IV_posterior <span class="sc">%&gt;%</span> </span>
<span id="cb77-808"><a href="#cb77-808"></a>  <span class="fu">filter</span>(cat <span class="sc">==</span> <span class="st">"Proportion of compliers"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb77-809"><a href="#cb77-809"></a>  <span class="fu">select</span>(id, <span class="at">p_compliers =</span> x)</span>
<span id="cb77-810"><a href="#cb77-810"></a></span>
<span id="cb77-811"><a href="#cb77-811"></a>prop_compliers <span class="sc">%&gt;%</span></span>
<span id="cb77-812"><a href="#cb77-812"></a>  <span class="fu">mutate</span>(<span class="at">p_never_takers =</span> <span class="dv">1</span> <span class="sc">-</span> p_compliers) <span class="sc">%&gt;%</span> </span>
<span id="cb77-813"><a href="#cb77-813"></a>  <span class="fu">summary</span>()</span>
<span id="cb77-814"><a href="#cb77-814"></a><span class="in">```</span></span>
<span id="cb77-815"><a href="#cb77-815"></a></span>
<span id="cb77-816"><a href="#cb77-816"></a>For the probability of conversion among the never takers, we can calculate this from information among the untreated assigned to the treatment group. A $\text{Beta}(1, 1)$ prior can be assumed here to get the following $\text{Beta}(18 + 1, 13999 + 1) = \text{Beta}(19, 14000)$ posterior</span>
<span id="cb77-817"><a href="#cb77-817"></a></span>
<span id="cb77-820"><a href="#cb77-820"></a><span class="in">```{r}</span></span>
<span id="cb77-821"><a href="#cb77-821"></a>data <span class="sc">%&gt;%</span> <span class="fu">filter</span>(A <span class="sc">!=</span> Z) <span class="sc">%$%</span> <span class="fu">table</span>(Y)</span>
<span id="cb77-822"><a href="#cb77-822"></a></span>
<span id="cb77-823"><a href="#cb77-823"></a>pY_never_takers <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb77-824"><a href="#cb77-824"></a>  <span class="at">id =</span> <span class="dv">1</span><span class="sc">:</span><span class="fl">1e5</span>, </span>
<span id="cb77-825"><a href="#cb77-825"></a>  <span class="at">pY_nt =</span> <span class="fu">rbeta</span>(<span class="fl">1e5</span>, <span class="dv">19</span>, <span class="dv">14000</span>)</span>
<span id="cb77-826"><a href="#cb77-826"></a>)</span>
<span id="cb77-827"><a href="#cb77-827"></a></span>
<span id="cb77-828"><a href="#cb77-828"></a>pY_never_takers <span class="sc">%&gt;%</span> <span class="fu">summary</span>()</span>
<span id="cb77-829"><a href="#cb77-829"></a><span class="in">```</span></span>
<span id="cb77-830"><a href="#cb77-830"></a></span>
<span id="cb77-831"><a href="#cb77-831"></a>For the ITT estimates, the posterior probabilities from the ITT analysis above are used</span>
<span id="cb77-832"><a href="#cb77-832"></a></span>
<span id="cb77-835"><a href="#cb77-835"></a><span class="in">```{r}</span></span>
<span id="cb77-836"><a href="#cb77-836"></a>ITT_posterior_subset <span class="ot">&lt;-</span> ITT_posterior <span class="sc">%&gt;%</span> </span>
<span id="cb77-837"><a href="#cb77-837"></a>  <span class="fu">filter</span>(cat <span class="sc">!=</span> <span class="st">"Risk difference"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb77-838"><a href="#cb77-838"></a>  <span class="fu">pivot_wider</span>(<span class="at">id_cols =</span> id, <span class="at">names_from =</span> cat, <span class="at">values_from =</span> x) <span class="sc">%&gt;%</span> </span>
<span id="cb77-839"><a href="#cb77-839"></a>  <span class="fu">rename</span>(</span>
<span id="cb77-840"><a href="#cb77-840"></a>        <span class="st">"p_control"</span> <span class="ot">=</span> <span class="st">"Conversion probability </span><span class="sc">\n</span><span class="st">(control group)"</span>, </span>
<span id="cb77-841"><a href="#cb77-841"></a>        <span class="st">"p_treated"</span> <span class="ot">=</span> <span class="st">"Conversion probability </span><span class="sc">\n</span><span class="st">(treatment group)"</span></span>
<span id="cb77-842"><a href="#cb77-842"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb77-843"><a href="#cb77-843"></a>  <span class="fu">glimpse</span>()</span>
<span id="cb77-844"><a href="#cb77-844"></a><span class="in">```</span></span>
<span id="cb77-845"><a href="#cb77-845"></a></span>
<span id="cb77-846"><a href="#cb77-846"></a>Putting these together gives</span>
<span id="cb77-847"><a href="#cb77-847"></a></span>
<span id="cb77-850"><a href="#cb77-850"></a><span class="in">```{r}</span></span>
<span id="cb77-851"><a href="#cb77-851"></a>posterior_draws <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb77-852"><a href="#cb77-852"></a>  prop_compliers, pY_never_takers, ITT_posterior_subset</span>
<span id="cb77-853"><a href="#cb77-853"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb77-854"><a href="#cb77-854"></a>  <span class="fu">reduce</span>(<span class="at">.f =</span> <span class="sc">~</span> <span class="fu">full_join</span>(.x, .y, <span class="at">by =</span> <span class="st">"id"</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb77-855"><a href="#cb77-855"></a>  <span class="fu">glimpse</span>()</span>
<span id="cb77-856"><a href="#cb77-856"></a><span class="in">```</span></span>
<span id="cb77-857"><a href="#cb77-857"></a></span>
<span id="cb77-858"><a href="#cb77-858"></a>The conversion probabilities among the compliers are calculated, which results in the data frame with all the posterior draws for the probabilities we need.</span>
<span id="cb77-859"><a href="#cb77-859"></a></span>
<span id="cb77-862"><a href="#cb77-862"></a><span class="in">```{r}</span></span>
<span id="cb77-863"><a href="#cb77-863"></a><span class="co"># set seed in case a subset of the posterior draws are used</span></span>
<span id="cb77-864"><a href="#cb77-864"></a><span class="co"># set.seed(23)</span></span>
<span id="cb77-865"><a href="#cb77-865"></a>posterior_draws <span class="ot">&lt;-</span> posterior_draws <span class="sc">%&gt;%</span> </span>
<span id="cb77-866"><a href="#cb77-866"></a>  <span class="fu">mutate</span>(</span>
<span id="cb77-867"><a href="#cb77-867"></a>    <span class="fu">across</span>(</span>
<span id="cb77-868"><a href="#cb77-868"></a>      <span class="at">.cols =</span> <span class="fu">c</span>(p_treated, p_control), </span>
<span id="cb77-869"><a href="#cb77-869"></a>      <span class="co"># rescale the ITT probabilities by p(compliance) and</span></span>
<span id="cb77-870"><a href="#cb77-870"></a>      <span class="co"># shave off the effect of never takers on this probability</span></span>
<span id="cb77-871"><a href="#cb77-871"></a>      <span class="co"># to recover the p(Y = 1 | Z = z, C = 1)</span></span>
<span id="cb77-872"><a href="#cb77-872"></a>      <span class="at">.fns =</span> <span class="sc">~</span> ((.x <span class="sc">/</span> p_compliers) <span class="sc">-</span> </span>
<span id="cb77-873"><a href="#cb77-873"></a>                  (pY_nt <span class="sc">*</span> ((<span class="dv">1</span> <span class="sc">-</span> p_compliers) <span class="sc">/</span> p_compliers))), </span>
<span id="cb77-874"><a href="#cb77-874"></a>      <span class="at">.names =</span> <span class="st">"{.col}_compliers"</span></span>
<span id="cb77-875"><a href="#cb77-875"></a>    )</span>
<span id="cb77-876"><a href="#cb77-876"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb77-877"><a href="#cb77-877"></a>  <span class="co"># slice_sample(n = 5000) %&gt;% </span></span>
<span id="cb77-878"><a href="#cb77-878"></a>  <span class="co"># select(-id)  %&gt;% </span></span>
<span id="cb77-879"><a href="#cb77-879"></a>  <span class="fu">glimpse</span>()</span>
<span id="cb77-880"><a href="#cb77-880"></a><span class="in">```</span></span>
<span id="cb77-881"><a href="#cb77-881"></a></span>
<span id="cb77-882"><a href="#cb77-882"></a>In principle, any of these probabilities can be replaced with other priors<span class="ot">[^17]</span> when attempting to *transport* these estimates to the other scenarios.</span>
<span id="cb77-883"><a href="#cb77-883"></a></span>
<span id="cb77-884"><a href="#cb77-884"></a><span class="ot">[^17]: </span>rather than using the observed posteriors as priors.</span>
<span id="cb77-885"><a href="#cb77-885"></a></span>
<span id="cb77-886"><a href="#cb77-886"></a>For the plot below, there are two dimensions</span>
<span id="cb77-887"><a href="#cb77-887"></a></span>
<span id="cb77-888"><a href="#cb77-888"></a><span class="ss">-   </span>compliance with levels set to 50%, 80%, 100%</span>
<span id="cb77-889"><a href="#cb77-889"></a></span>
<span id="cb77-890"><a href="#cb77-890"></a><span class="ss">-   </span>treatment / control split</span>
<span id="cb77-891"><a href="#cb77-891"></a></span>
<span id="cb77-892"><a href="#cb77-892"></a><span class="ss">    -   </span>70/30% as in this experiment</span>
<span id="cb77-893"><a href="#cb77-893"></a></span>
<span id="cb77-894"><a href="#cb77-894"></a><span class="ss">    -   </span>0/100% - don't treat the population</span>
<span id="cb77-895"><a href="#cb77-895"></a></span>
<span id="cb77-896"><a href="#cb77-896"></a><span class="ss">    -   </span>100/0% - treat the full population</span>
<span id="cb77-897"><a href="#cb77-897"></a></span>
<span id="cb77-898"><a href="#cb77-898"></a>It feels a bit odd to look at the combination of compliance with 0% of the population assigned to treatment, as the (non-)compliers are only identified -- and the respective conditional probabilities estimated -- when at least some individuals are assigned to treatment. In this case, it's more of a hypothetical exercise using data from an experiment where <span class="sc">\&gt;</span>0% of the population was assigned to the treatment arm. Page 41 of the Greenland et al 1999 paper mentions</span>
<span id="cb77-899"><a href="#cb77-899"></a></span>
<span id="cb77-900"><a href="#cb77-900"></a><span class="at">&gt; </span><span class="sc">\[</span><span class="at">...</span><span class="sc">\]</span><span class="at"> noncompliance represents movement into a third untreated state that does not correspond to any assigned treatment (Robins, 1998).</span></span>
<span id="cb77-901"><a href="#cb77-901"></a></span>
<span id="cb77-902"><a href="#cb77-902"></a>I haven't managed to go through the Robins 1998 paper yet but it would be interesting to dig into this further.</span>
<span id="cb77-903"><a href="#cb77-903"></a></span>
<span id="cb77-906"><a href="#cb77-906"></a><span class="in">```{r}</span></span>
<span id="cb77-907"><a href="#cb77-907"></a>parameter_grid <span class="ot">&lt;-</span> <span class="fu">expand_grid</span>(</span>
<span id="cb77-908"><a href="#cb77-908"></a>  <span class="at">compliance =</span> <span class="fu">c</span>(<span class="fl">0.5</span>, <span class="fl">0.8</span>, <span class="fl">1.0</span>),</span>
<span id="cb77-909"><a href="#cb77-909"></a>  <span class="at">split =</span> <span class="fu">c</span>(<span class="fl">0.7</span>, <span class="fl">1.0</span>, <span class="fl">0.0</span>), </span>
<span id="cb77-910"><a href="#cb77-910"></a>  <span class="at">n =</span> n</span>
<span id="cb77-911"><a href="#cb77-911"></a>)</span>
<span id="cb77-912"><a href="#cb77-912"></a><span class="in">```</span></span>
<span id="cb77-913"><a href="#cb77-913"></a></span>
<span id="cb77-914"><a href="#cb77-914"></a>Total profit distributions for each of these hypothetical experiments is calculated using the formulas specified above. To get the variability in the profit distribution, total sales $S \sim \text{BetaBin}(n, \alpha, \beta)$ can be sampled from the <span class="co">[</span><span class="ot">*(beta-binomial) posterior predictive distribution*</span><span class="co">](https://en.wikipedia.org/wiki/Beta-binomial_distribution#Generating_beta_binomial-distributed_random_variables)</span>*,* where the probability of conversion $p \sim \text{Beta}(\alpha, \beta)$ and $S \sim \text{Binomial}(n, p)$ under the different interventions in different settings. The total profit can be obtained from multiplying $S$ with the profit per unit, which can be fixed at (say) +100 euros.</span>
<span id="cb77-915"><a href="#cb77-915"></a></span>
<span id="cb77-918"><a href="#cb77-918"></a><span class="in">```{r}</span></span>
<span id="cb77-919"><a href="#cb77-919"></a>profit_distributions <span class="ot">&lt;-</span> <span class="fu">expand_grid</span>(parameter_grid, posterior_draws) <span class="sc">%&gt;%</span> </span>
<span id="cb77-920"><a href="#cb77-920"></a>  <span class="fu">mutate</span>(</span>
<span id="cb77-921"><a href="#cb77-921"></a>    <span class="co"># get the ITT estimates for the hypothetical campaigns</span></span>
<span id="cb77-922"><a href="#cb77-922"></a>    <span class="co"># under the different parameters</span></span>
<span id="cb77-923"><a href="#cb77-923"></a>    <span class="co"># pY_nt is scaled by proportion of compliers</span></span>
<span id="cb77-924"><a href="#cb77-924"></a>    <span class="co"># as this wasn't done above</span></span>
<span id="cb77-925"><a href="#cb77-925"></a>    <span class="at">p_treated_hyp =</span> ((compliance <span class="sc">*</span> p_treated_compliers) <span class="sc">+</span> </span>
<span id="cb77-926"><a href="#cb77-926"></a>      ((<span class="dv">1</span> <span class="sc">-</span> compliance) <span class="sc">*</span> (pY_nt <span class="sc">/</span> p_compliers))),</span>
<span id="cb77-927"><a href="#cb77-927"></a>    <span class="at">p_control_hyp =</span> ((compliance <span class="sc">*</span> p_control_compliers) <span class="sc">+</span> </span>
<span id="cb77-928"><a href="#cb77-928"></a>      ((<span class="dv">1</span> <span class="sc">-</span> compliance) <span class="sc">*</span> (pY_nt <span class="sc">/</span> p_compliers))),</span>
<span id="cb77-929"><a href="#cb77-929"></a>    <span class="at">n_treated =</span> <span class="fu">round</span>(split <span class="sc">*</span> n), </span>
<span id="cb77-930"><a href="#cb77-930"></a>    <span class="at">n_control =</span> n <span class="sc">-</span> n_treated, </span>
<span id="cb77-931"><a href="#cb77-931"></a>    <span class="at">s_treated =</span> <span class="fu">rbinom</span>(<span class="fu">n</span>(), n_treated, p_treated_hyp), </span>
<span id="cb77-932"><a href="#cb77-932"></a>    <span class="at">s_control =</span> <span class="fu">rbinom</span>(<span class="fu">n</span>(), n_control, p_control_hyp), </span>
<span id="cb77-933"><a href="#cb77-933"></a>    <span class="at">total_profit =</span> <span class="dv">100</span> <span class="sc">*</span> (s_treated <span class="sc">+</span> s_control)</span>
<span id="cb77-934"><a href="#cb77-934"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb77-935"><a href="#cb77-935"></a>  <span class="fu">glimpse</span>()</span>
<span id="cb77-936"><a href="#cb77-936"></a><span class="in">```</span></span>
<span id="cb77-937"><a href="#cb77-937"></a></span>
<span id="cb77-938"><a href="#cb77-938"></a>The posterior predictive distribution for the total profit is visually compared with simulated draws from the data generating process</span>
<span id="cb77-939"><a href="#cb77-939"></a></span>
<span id="cb77-942"><a href="#cb77-942"></a><span class="in">```{r}</span></span>
<span id="cb77-943"><a href="#cb77-943"></a><span class="co">#| code-fold: true</span></span>
<span id="cb77-944"><a href="#cb77-944"></a></span>
<span id="cb77-945"><a href="#cb77-945"></a>simulated_profit <span class="ot">&lt;-</span> parameter_grid <span class="sc">%&gt;%</span> </span>
<span id="cb77-946"><a href="#cb77-946"></a>  <span class="fu">expand_grid</span>(<span class="at">id =</span> <span class="fu">seq</span>(<span class="at">from =</span> <span class="dv">20</span>, <span class="at">by =</span> <span class="dv">1</span>, <span class="at">length.out =</span> <span class="dv">20</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb77-947"><a href="#cb77-947"></a>  <span class="fu">pmap_dfr</span>(</span>
<span id="cb77-948"><a href="#cb77-948"></a>    <span class="at">.f =</span> <span class="cf">function</span>(compliance, split, id, n) {</span>
<span id="cb77-949"><a href="#cb77-949"></a>      <span class="fu">simulate_data</span>(<span class="at">n =</span> n,</span>
<span id="cb77-950"><a href="#cb77-950"></a>                    <span class="at">p_compliers =</span> compliance, </span>
<span id="cb77-951"><a href="#cb77-951"></a>                    <span class="at">p_treatment =</span> split,</span>
<span id="cb77-952"><a href="#cb77-952"></a>                    <span class="at">seed =</span> id) <span class="sc">%&gt;%</span></span>
<span id="cb77-953"><a href="#cb77-953"></a>        <span class="fu">summarise</span>(<span class="at">total_profit =</span> <span class="dv">100</span> <span class="sc">*</span> <span class="fu">sum</span>(Y)) <span class="sc">%&gt;%</span> </span>
<span id="cb77-954"><a href="#cb77-954"></a>        <span class="fu">tibble</span>(compliance, split, .)</span>
<span id="cb77-955"><a href="#cb77-955"></a>    }</span>
<span id="cb77-956"><a href="#cb77-956"></a>  )</span>
<span id="cb77-957"><a href="#cb77-957"></a></span>
<span id="cb77-958"><a href="#cb77-958"></a>profit_distributions_plot_data <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb77-959"><a href="#cb77-959"></a>  <span class="st">"extrapolated"</span> <span class="ot">=</span> profit_distributions <span class="sc">%&gt;%</span> </span>
<span id="cb77-960"><a href="#cb77-960"></a>    <span class="fu">select</span>(compliance, split, total_profit),</span>
<span id="cb77-961"><a href="#cb77-961"></a>  <span class="st">"simulated"</span> <span class="ot">=</span> simulated_profit</span>
<span id="cb77-962"><a href="#cb77-962"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb77-963"><a href="#cb77-963"></a>  <span class="fu">map</span>(</span>
<span id="cb77-964"><a href="#cb77-964"></a>    <span class="at">.f =</span> <span class="sc">~</span> {</span>
<span id="cb77-965"><a href="#cb77-965"></a>      .x <span class="sc">%&gt;%</span> </span>
<span id="cb77-966"><a href="#cb77-966"></a>        <span class="fu">mutate</span>(</span>
<span id="cb77-967"><a href="#cb77-967"></a>          <span class="at">total_profit =</span> total_profit <span class="sc">/</span> <span class="fl">1e5</span>, </span>
<span id="cb77-968"><a href="#cb77-968"></a>          <span class="at">compliance =</span> <span class="fu">paste0</span>(<span class="st">"Compliers: "</span>, compliance <span class="sc">*</span> <span class="dv">100</span>, <span class="st">"%"</span>), </span>
<span id="cb77-969"><a href="#cb77-969"></a>          <span class="at">compliance =</span> <span class="fu">factor</span>(compliance, </span>
<span id="cb77-970"><a href="#cb77-970"></a>                        <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"Compliers: 50%"</span>,</span>
<span id="cb77-971"><a href="#cb77-971"></a>                                   <span class="st">"Compliers: 80%"</span>,</span>
<span id="cb77-972"><a href="#cb77-972"></a>                                   <span class="st">"Compliers: 100%"</span>)),</span>
<span id="cb77-973"><a href="#cb77-973"></a>          <span class="at">split =</span> <span class="fu">paste0</span>(<span class="st">"Treatment: "</span>, split <span class="sc">*</span> <span class="dv">100</span>, <span class="st">"%"</span>), </span>
<span id="cb77-974"><a href="#cb77-974"></a>          <span class="at">split =</span> <span class="fu">factor</span>(split, </span>
<span id="cb77-975"><a href="#cb77-975"></a>                         <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"Treatment: 0%"</span>, </span>
<span id="cb77-976"><a href="#cb77-976"></a>                                    <span class="st">"Treatment: 70%"</span>, </span>
<span id="cb77-977"><a href="#cb77-977"></a>                                    <span class="st">"Treatment: 100%"</span>))</span>
<span id="cb77-978"><a href="#cb77-978"></a>        )</span>
<span id="cb77-979"><a href="#cb77-979"></a>    }</span>
<span id="cb77-980"><a href="#cb77-980"></a>  )</span>
<span id="cb77-981"><a href="#cb77-981"></a></span>
<span id="cb77-982"><a href="#cb77-982"></a>profit_distributions_plot_data <span class="sc">%&gt;%</span> </span>
<span id="cb77-983"><a href="#cb77-983"></a>  <span class="fu">pluck</span>(<span class="st">"extrapolated"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb77-984"><a href="#cb77-984"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> total_profit)) <span class="sc">+</span> </span>
<span id="cb77-985"><a href="#cb77-985"></a>  <span class="fu">geom_density</span>(<span class="at">trim =</span> <span class="cn">TRUE</span>) <span class="sc">+</span> </span>
<span id="cb77-986"><a href="#cb77-986"></a>  <span class="fu">geom_vline</span>(</span>
<span id="cb77-987"><a href="#cb77-987"></a>    <span class="at">data =</span> profit_distributions_plot_data <span class="sc">%&gt;%</span> <span class="fu">pluck</span>(<span class="st">"simulated"</span>), </span>
<span id="cb77-988"><a href="#cb77-988"></a>    <span class="fu">aes</span>(<span class="at">xintercept =</span> total_profit), <span class="at">color =</span> <span class="st">"maroon"</span></span>
<span id="cb77-989"><a href="#cb77-989"></a>  ) <span class="sc">+</span> </span>
<span id="cb77-990"><a href="#cb77-990"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span> </span>
<span id="cb77-991"><a href="#cb77-991"></a>  <span class="fu">facet_wrap</span>(<span class="fu">vars</span>(split, compliance), <span class="at">scales =</span> <span class="st">"free"</span>) <span class="sc">+</span> </span>
<span id="cb77-992"><a href="#cb77-992"></a>  <span class="co">#facet_grid(compliance ~ split, scales = "fixed") +</span></span>
<span id="cb77-993"><a href="#cb77-993"></a>  <span class="fu">xlab</span>(<span class="st">"Total profit (multiples of 100,000 EUR, per 100,000 individuals)"</span>)</span>
<span id="cb77-994"><a href="#cb77-994"></a><span class="in">```</span></span>
<span id="cb77-995"><a href="#cb77-995"></a></span>
<span id="cb77-996"><a href="#cb77-996"></a>The middle column shows the total profit distribution for this experiment with a 70-30% split and 80% compliance. In this fictional scenario, the ad campaign has a strong positive impact on the total profits (90,000 under 0% treated and 80% compliance vs 900,000 under 100% treated) so with the gift of hindsight, it could have been rolled out to the full population.</span>
<span id="cb77-997"><a href="#cb77-997"></a></span>
<span id="cb77-998"><a href="#cb77-998"></a>If you're wondering why the posterior predictive distribution (black line) in each panel is not centered at the mean of the vertical lines (in maroon), it's from using the estimated probabilities from the original dataset which differ from the true probabilities because of sampling variability<span class="ot">[^18]</span>.</span>
<span id="cb77-999"><a href="#cb77-999"></a></span>
<span id="cb77-1000"><a href="#cb77-1000"></a><span class="ot">[^18]: </span>This can be checked by using the true probabilities, i.e., <span class="in">`p_compliers = 0.8, pY_nt = 0.001, p_treated_compliers = 0.1, p_control_compliers = 0.01`</span> instead of the posterior distributions for these probabilities.</span>
<span id="cb77-1001"><a href="#cb77-1001"></a></span>
<span id="cb77-1002"><a href="#cb77-1002"></a><span class="fu">## Ignored complexities</span></span>
<span id="cb77-1003"><a href="#cb77-1003"></a></span>
<span id="cb77-1004"><a href="#cb77-1004"></a>In this post, I ignored the complexity where the exposure among the treated -- i.e., number of impressions of the ad -- would be continuous, possibly something like this</span>
<span id="cb77-1005"><a href="#cb77-1005"></a></span>
<span id="cb77-1008"><a href="#cb77-1008"></a><span class="in">```{r}</span></span>
<span id="cb77-1009"><a href="#cb77-1009"></a><span class="co">#| code-fold: true</span></span>
<span id="cb77-1010"><a href="#cb77-1010"></a><span class="fu">set.seed</span>(<span class="dv">23</span>)</span>
<span id="cb77-1011"><a href="#cb77-1011"></a><span class="fu">tibble</span>(<span class="at">impressions =</span> <span class="fu">pmax</span>(<span class="fu">round</span>(<span class="fu">rgamma</span>(<span class="fl">5e4</span>, <span class="at">shape =</span> <span class="dv">4</span>, <span class="at">scale =</span> <span class="dv">3</span>)), <span class="dv">1</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb77-1012"><a href="#cb77-1012"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> impressions)) <span class="sc">+</span> </span>
<span id="cb77-1013"><a href="#cb77-1013"></a>  <span class="fu">geom_bar</span>() <span class="sc">+</span></span>
<span id="cb77-1014"><a href="#cb77-1014"></a>  <span class="co">#stat_ecdf() + </span></span>
<span id="cb77-1015"><a href="#cb77-1015"></a>  <span class="fu">theme_classic</span>() <span class="sc">+</span> </span>
<span id="cb77-1016"><a href="#cb77-1016"></a>  <span class="fu">xlab</span>(<span class="st">"Impressions"</span>) <span class="sc">+</span> </span>
<span id="cb77-1017"><a href="#cb77-1017"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">50</span>, <span class="dv">5</span>), <span class="at">labels =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">50</span>, <span class="dv">5</span>))</span>
<span id="cb77-1018"><a href="#cb77-1018"></a><span class="in">```</span></span>
<span id="cb77-1019"><a href="#cb77-1019"></a></span>
<span id="cb77-1020"><a href="#cb77-1020"></a>Ignoring the actual impressions effectively assumes *treatment variation irrelevance*, i.e, seeing 1 impression is as effective as seeing 20 impressions with regards to conversion. This might be fun to explore in a future post on binary instruments, with a continuous exposure<span class="ot">[^19]</span>. Baiocchi et al. (section 12) describes an analysis with continuous treatments.</span>
<span id="cb77-1021"><a href="#cb77-1021"></a></span>
<span id="cb77-1022"><a href="#cb77-1022"></a><span class="ot">[^19]: </span>although all references mention that this complicates the analysis</span>
<span id="cb77-1023"><a href="#cb77-1023"></a></span>
<span id="cb77-1024"><a href="#cb77-1024"></a>Issue with handling partial exposures, i.e., people with one or more partial impressions are also not tackled here.</span>
<span id="cb77-1025"><a href="#cb77-1025"></a></span>
<span id="cb77-1026"><a href="#cb77-1026"></a>For building more complex / full Bayesian IV models using brms / Stan, see <span class="co">[</span><span class="ot">this</span><span class="co">](https://bookdown.org/content/4857/adventures-in-covariance.html#instruments-and-causal-designs)</span>, <span class="co">[</span><span class="ot">this</span><span class="co">](https://avehtari.github.io/ROS-Examples/Sesame/sesame.html)</span>, <span class="co">[</span><span class="ot">this</span><span class="co">](https://modernstatisticalworkflow.blogspot.com/2017/11/bayesian-instrumental-variables-with.html)</span>, or <span class="co">[</span><span class="ot">this</span><span class="co">](https://rpsychologist.com/adherence-analysis-IV-brms)</span>.</span>
<span id="cb77-1027"><a href="#cb77-1027"></a></span>
<span id="cb77-1028"><a href="#cb77-1028"></a><span class="fu">## References</span></span>
<span id="cb77-1029"><a href="#cb77-1029"></a></span>
<span id="cb77-1030"><a href="#cb77-1030"></a>These are the main references I'm using for this post<span class="ot">[^20]</span>.</span>
<span id="cb77-1031"><a href="#cb77-1031"></a></span>
<span id="cb77-1032"><a href="#cb77-1032"></a><span class="ot">[^20]: </span>although I can't claim to have read and mastered all these.</span>
<span id="cb77-1033"><a href="#cb77-1033"></a></span>
<span id="cb77-1034"><a href="#cb77-1034"></a><span class="ss">-   </span>Simulating data for instrumental variables - <span class="co">[</span><span class="ot">Andrew Gelman blog post link</span><span class="co">](https://statmodeling.stat.columbia.edu/2019/06/20/how-to-simulate-an-instrumental-variables-problem/)</span>, or <span class="co">[</span><span class="ot">this link</span><span class="co">](https://bookdown.org/content/4857/adventures-in-covariance.html#instruments-and-causal-designs)</span> to *statistical rethinking* models implemented using brms</span>
<span id="cb77-1035"><a href="#cb77-1035"></a><span class="ss">-   </span><span class="co">[</span><span class="ot">Hernán, Robins</span><span class="co">](https://www.hsph.harvard.edu/miguel-hernan/causal-inference-book/)</span> - Causal Inference - What if? - Chapters 16 (instrumental variables), and 22 (sections on intention-to-treat and per-protocol analyses)</span>
<span id="cb77-1036"><a href="#cb77-1036"></a><span class="ss">-   </span><span class="co">[</span><span class="ot">Gelman, Hill, Vehtari</span><span class="co">](https://avehtari.github.io/ROS-Examples/)</span> - Regression and other stories, Sections 21.1-21.2</span>
<span id="cb77-1037"><a href="#cb77-1037"></a><span class="ss">-   </span><span class="co">[</span><span class="ot">Hernán, Robins 2006</span><span class="co">](https://pubmed.ncbi.nlm.nih.gov/16755261/)</span> - Instruments for causal inference: an epidemiologist's dream?</span>
<span id="cb77-1038"><a href="#cb77-1038"></a><span class="ss">-   </span><span class="co">[</span><span class="ot">Burgess, Small, Thompson 2017</span><span class="co">](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC5642006/)</span> - A review of instrumental variable estimators for Mendelian randomization</span>
<span id="cb77-1039"><a href="#cb77-1039"></a><span class="ss">-   </span><span class="co">[</span><span class="ot">Baiocchi, Cheng, Small 2014</span><span class="co">](https://onlinelibrary.wiley.com/doi/abs/10.1002/sim.6128)</span> - Instrumental variable methods for causal inference</span>
<span id="cb77-1040"><a href="#cb77-1040"></a><span class="ss">    -   </span>Good review paper for different IV situations</span>
<span id="cb77-1041"><a href="#cb77-1041"></a><span class="ss">-   </span><span class="co">[</span><span class="ot">Sussman, Hayward 2010</span><span class="co">](https://pubmed.ncbi.nlm.nih.gov/20442226/)</span> - An IV for the RCT: using instrumental variables to adjust for treatment contamination in randomised controlled trials</span>
<span id="cb77-1042"><a href="#cb77-1042"></a><span class="ss">-   </span><span class="co">[</span><span class="ot">Naimi, Whitcomb 2020</span><span class="co">](https://academic.oup.com/aje/article/189/6/508/5812650)</span> - Calculating risk differences and risk ratios from regression models</span>
<span id="cb77-1043"><a href="#cb77-1043"></a><span class="ss">-   </span><span class="co">[</span><span class="ot">Imbens, Rubin 1997</span><span class="co">](https://projecteuclid.org/journals/annals-of-statistics/volume-25/issue-1/Bayesian-inference-for-causal-effects-in-randomized-experiments-with-noncompliance/10.1214/aos/1034276631.full)</span> - Bayesian inference for causal effects in randomized experiments with noncompliance</span>
<span id="cb77-1044"><a href="#cb77-1044"></a><span class="ss">-   </span><span class="co">[</span><span class="ot">Balke, Pearl 1997</span><span class="co">](https://arxiv.org/abs/1302.6784)</span> - Counterfactual Probabilities: Computational Methods, Bounds and Applications</span>
<span id="cb77-1045"><a href="#cb77-1045"></a><span class="ss">-   </span><span class="co">[</span><span class="ot">Swanson et al 2018</span><span class="co">](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC6752717/)</span> - Partial Identification of the Average Treatment Effect Using Instrumental Variables: Review of Methods for Binary Instruments, Treatments, and Outcomes</span>
<span id="cb77-1046"><a href="#cb77-1046"></a><span class="ss">    -   </span>Note to future self: good rabbit hole to go down to calculate bounds on the ATE under different assumption sets</span>
<span id="cb77-1047"><a href="#cb77-1047"></a><span class="ss">-   </span><span class="co">[</span><span class="ot">Greenland, Pearl, Robins 1999</span><span class="co">](https://projecteuclid.org/journals/statistical-science/volume-14/issue-1/Confounding-and-Collapsibility-in-Causal-Inference/10.1214/ss/1009211805.full)</span> - Confounding and Collapsibility in Causal Inference</span>
<span id="cb77-1048"><a href="#cb77-1048"></a><span class="ss">-   </span><span class="co">[</span><span class="ot">Robins 1998</span><span class="co">](https://pubmed.ncbi.nlm.nih.gov/9493255/)</span> - Correction for non-compliance in equivalence trials (<span class="co">[</span><span class="ot">free link</span><span class="co">](https://www.hsph.harvard.edu/wp-content/uploads/sites/343/2013/03/corr-noncomp-98.pdf)</span>)</span>
</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
      &nbsp;
    </div>   
    <div class="nav-footer-center">
<p>akshat.blog © 2022-2024 Akshat Dwivedi. Built with <a href="https://www.quarto.org">Quarto</a> and <a href="https://pages.github.com">GitHub Pages</a>. Read the <a href="https://github.com/ad1729/ad1729.github.io/LICENSE.md">license.</a></p>
<div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/ad1729/ad1729.github.io/issues/new" class="toc-action"><i class="bi bi-github"></i>Report an issue</a></li></ul></div></div>
    <div class="nav-footer-right">
      &nbsp;
    </div>
  </div>
</footer>




</body></html>