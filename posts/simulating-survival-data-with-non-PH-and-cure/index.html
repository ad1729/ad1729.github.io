<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.550">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="dcterms.date" content="2024-09-22">

<title>Akshat Dwivedi - Simulating data from a time-to-event experiment with non-proportional hazards, random censoring, and cure</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<link href="../../favicon.png" rel="icon" type="image/png">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="../../site_libs/bootstrap/bootstrap-dark.min.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<style>html{ scroll-behavior: smooth; }</style>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="../../styles.css">
</head>

<body class="floating nav-fixed slimcontent">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Akshat Dwivedi</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../about.html"> 
<span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/ad1729"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://www.linkedin.com/in/akshatd/"> <i class="bi bi-linkedin" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://500px.com/p/akshatdwivedi?view=photos"> <i class="bi bi-images" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
          <div class="quarto-navbar-tools">
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default toc-left page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <div class="quarto-title-block"><div><h1 class="title">Simulating data from a time-to-event experiment with non-proportional hazards, random censoring, and cure</h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li><li><hr class="dropdown-divider"></li><li><a id="quarto-view-source" class="dropdown-item" href="javascript:void(0)" role="button">View Source</a></li></ul></div></div>
                                <div class="quarto-categories">
                <div class="quarto-category">Advertising</div>
                <div class="quarto-category">Experimentation</div>
                <div class="quarto-category">R</div>
                <div class="quarto-category">Simulation</div>
                <div class="quarto-category">Time-to-event</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">September 22, 2024</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <nav id="TOC" role="doc-toc" class="toc-active" data-toc-expanded="99">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#key-concepts" id="toc-key-concepts" class="nav-link active" data-scroll-target="#key-concepts">Key concepts</a></li>
  <li><a href="#simulate-true-event-times" id="toc-simulate-true-event-times" class="nav-link" data-scroll-target="#simulate-true-event-times">Simulate true event times</a></li>
  <li><a href="#add-censoring" id="toc-add-censoring" class="nav-link" data-scroll-target="#add-censoring">Add censoring</a></li>
  <li><a href="#add-cure" id="toc-add-cure" class="nav-link" data-scroll-target="#add-cure">Add cure</a></li>
  <li><a href="#putting-it-all-together" id="toc-putting-it-all-together" class="nav-link" data-scroll-target="#putting-it-all-together">Putting it all together</a></li>
  <li><a href="#sanity-check" id="toc-sanity-check" class="nav-link" data-scroll-target="#sanity-check">Sanity check</a></li>
  <li><a href="#comparing-arm-specific-cumulative-incidence-estimates" id="toc-comparing-arm-specific-cumulative-incidence-estimates" class="nav-link" data-scroll-target="#comparing-arm-specific-cumulative-incidence-estimates">Comparing arm-specific cumulative incidence estimates</a></li>
  <li><a href="#references" id="toc-references" class="nav-link" data-scroll-target="#references">References</a></li>
  </ul>
<div class="toc-actions"><ul><li><a href="https://github.com/ad1729/ad1729.github.io/issues/new" class="toc-action"><i class="bi bi-github"></i>Report an issue</a></li></ul></div></nav>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
    </div>
<!-- main -->
<main class="content quarto-banner-title-block page-columns page-full" id="quarto-document-content">





<p>This post is about simulating data from a log-logistic accelerated failure time mixture cure model with censoring. It also visually compares the estimated cumulative incidence curves obtained from several time-to-event estimators on a large simulated dataset.</p>
<p>It’s been quite a while since I’ve worked with time-to-event data and models. Also known as <em>survival analysis</em>, it is ideally suited for situations where the interest is not only in predicting <em>whether</em> an event will occur, but <em>how long it will take for it to occur.</em></p>
<p>So I’m writing this post to reacquaint myself with some of the key concepts — and to learn some new things along the way — by simulating and analyzing data from a fictitious experiment motivated by a real experiment I worked on many moons ago.</p>
<p>Before writing any code, the following packages are attached:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1"></a><span class="fu">library</span>(tidyverse)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>── Attaching core tidyverse packages ──────────────────────── tidyverse 2.0.0 ──
✔ dplyr     1.1.4     ✔ readr     2.1.5
✔ forcats   1.0.0     ✔ stringr   1.5.1
✔ ggplot2   3.5.1     ✔ tibble    3.2.1
✔ lubridate 1.9.3     ✔ tidyr     1.3.1
✔ purrr     1.0.2     
── Conflicts ────────────────────────────────────────── tidyverse_conflicts() ──
✖ dplyr::filter() masks stats::filter()
✖ dplyr::lag()    masks stats::lag()
ℹ Use the conflicted package (&lt;http://conflicted.r-lib.org/&gt;) to force all conflicts to become errors</code></pre>
</div>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1"></a><span class="fu">library</span>(flexsurvcure)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: survival
Loading required package: flexsurv</code></pre>
</div>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1"></a><span class="fu">library</span>(ggsurvfit)</span>
<span id="cb5-2"><a href="#cb5-2"></a></span>
<span id="cb5-3"><a href="#cb5-3"></a><span class="fu">theme_set</span>(<span class="fu">theme_bw</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Suppose a marketing manager is interested in the time it takes for an upgraded product to be adopted after launch among users of the previous version of the product. This rate-of-upgrade could be potentially hastened via a marketing campaign, which can be assumed to have a <em>transient response</em><a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a> — that is, the impact of this campaign decreases with time once the campaign has concluded.</p>
<div class="no-row-height column-margin column-container"><p><sup>1</sup>&nbsp;Not sure what this is called in marketing jargon but this is how it’s called in <a href="https://en.wikipedia.org/wiki/Transient_response">engineering</a></p></div><section id="key-concepts" class="level2">
<h2 class="anchored" data-anchor-id="key-concepts">Key concepts</h2>
<p>One of the key objects in survival analysis is the <a href="https://en.wikipedia.org/wiki/Failure_rate"><em>hazard function</em></a> (<span class="math inline">\(h(t)\)</span>), i.e., the rate at which the event of interest (e.g., product purchase) occurs as a function of time. Mathematically, it is expressed for <em>continuous-time</em> models as</p>
<p><span class="math display">\[
h(t) =
\lim_{\Delta t \to 0} \frac{P(t \le T \lt t + \Delta t | T \ge t)}{\Delta t}
\]</span></p>
<p>where <span class="math inline">\(T\)</span> indicates the event time of interest which varies from individual to individual, <span class="math inline">\(t\)</span> is a specific value of time, and <span class="math inline">\(\Delta t\)</span> is some very small increment in time. This event rate function cannot be interpreted as a probability but only as a rate, since it can have values larger than 1.</p>
<p>In case of <em>discrete-time</em> models, the hazard rate can be interpreted as the (conditional) probability <span class="math inline">\(P(T = t | T \ge t)\)</span>.</p>
<p>For our experiment, suppose the hazards in the treatment and control groups look like this:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1"></a>hazard_function_loglogistic <span class="ot">&lt;-</span> <span class="cf">function</span>(alpha, beta, </span>
<span id="cb6-2"><a href="#cb6-2"></a>                               <span class="at">min_t =</span> <span class="dv">0</span>, </span>
<span id="cb6-3"><a href="#cb6-3"></a>                               <span class="at">max_t =</span> <span class="dv">24</span>, </span>
<span id="cb6-4"><a href="#cb6-4"></a>                               <span class="at">step_t =</span> <span class="fl">0.1</span>) {</span>
<span id="cb6-5"><a href="#cb6-5"></a>  </span>
<span id="cb6-6"><a href="#cb6-6"></a>  time <span class="ot">&lt;-</span> <span class="fu">seq</span>(min_t, max_t, step_t)</span>
<span id="cb6-7"><a href="#cb6-7"></a>  numerator <span class="ot">&lt;-</span> (beta <span class="sc">/</span> alpha) <span class="sc">*</span> ((time <span class="sc">/</span> alpha) <span class="sc">^</span> (beta <span class="sc">-</span> <span class="dv">1</span>))</span>
<span id="cb6-8"><a href="#cb6-8"></a>  denominator <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">+</span> ((time <span class="sc">/</span> alpha) <span class="sc">^</span> beta)</span>
<span id="cb6-9"><a href="#cb6-9"></a></span>
<span id="cb6-10"><a href="#cb6-10"></a>  <span class="fu">tibble</span>(</span>
<span id="cb6-11"><a href="#cb6-11"></a>    <span class="at">alpha =</span> alpha,</span>
<span id="cb6-12"><a href="#cb6-12"></a>    <span class="at">beta =</span> beta,</span>
<span id="cb6-13"><a href="#cb6-13"></a>    <span class="at">parameters =</span> <span class="fu">paste0</span>(<span class="st">"LL("</span>, alpha, </span>
<span id="cb6-14"><a href="#cb6-14"></a>                        <span class="st">", "</span>, beta, <span class="st">")"</span>),</span>
<span id="cb6-15"><a href="#cb6-15"></a>    <span class="at">time =</span> time,</span>
<span id="cb6-16"><a href="#cb6-16"></a>    <span class="at">hazard =</span> numerator <span class="sc">/</span> denominator</span>
<span id="cb6-17"><a href="#cb6-17"></a>  )</span>
<span id="cb6-18"><a href="#cb6-18"></a>}</span>
<span id="cb6-19"><a href="#cb6-19"></a></span>
<span id="cb6-20"><a href="#cb6-20"></a>loglogistic_attributes <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(</span>
<span id="cb6-21"><a href="#cb6-21"></a>  <span class="fu">hazard_function_loglogistic</span>(<span class="at">alpha =</span> <span class="dv">4</span>, <span class="at">beta =</span> <span class="dv">7</span>),</span>
<span id="cb6-22"><a href="#cb6-22"></a>  <span class="fu">hazard_function_loglogistic</span>(<span class="at">alpha =</span> <span class="dv">5</span>, <span class="at">beta =</span> <span class="dv">7</span>)</span>
<span id="cb6-23"><a href="#cb6-23"></a>) <span class="sc">%&gt;%</span> </span>
<span id="cb6-24"><a href="#cb6-24"></a>  <span class="fu">mutate</span>(</span>
<span id="cb6-25"><a href="#cb6-25"></a>    <span class="at">parameters =</span> <span class="fu">case_when</span>(</span>
<span id="cb6-26"><a href="#cb6-26"></a>      alpha <span class="sc">==</span> <span class="dv">4</span> <span class="sc">~</span> <span class="st">"Treatment group (T ~ LL(4, 7))"</span>,</span>
<span id="cb6-27"><a href="#cb6-27"></a>      alpha <span class="sc">==</span> <span class="dv">5</span> <span class="sc">~</span> <span class="st">"Control group (T ~ LL(5, 7))"</span></span>
<span id="cb6-28"><a href="#cb6-28"></a>    )</span>
<span id="cb6-29"><a href="#cb6-29"></a>  ) </span>
<span id="cb6-30"><a href="#cb6-30"></a></span>
<span id="cb6-31"><a href="#cb6-31"></a>loglogistic_attributes <span class="sc">%&gt;%</span> </span>
<span id="cb6-32"><a href="#cb6-32"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> hazard, <span class="at">group =</span> parameters, <span class="at">color =</span> parameters)) <span class="sc">+</span></span>
<span id="cb6-33"><a href="#cb6-33"></a>  <span class="fu">geom_line</span>(<span class="at">linewidth =</span> <span class="fl">1.1</span>) <span class="sc">+</span></span>
<span id="cb6-34"><a href="#cb6-34"></a>  <span class="co"># campaign end date</span></span>
<span id="cb6-35"><a href="#cb6-35"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="dv">6</span>, <span class="at">linetype =</span> <span class="st">"dotted"</span>, <span class="at">color =</span> <span class="st">"gray40"</span>) <span class="sc">+</span> </span>
<span id="cb6-36"><a href="#cb6-36"></a>  <span class="fu">annotate</span>(<span class="at">geom =</span> <span class="st">"text"</span>, <span class="at">x =</span> <span class="fl">6.2</span>, <span class="at">y =</span> <span class="fl">0.6</span>, <span class="at">color =</span> <span class="st">"gray40"</span>,</span>
<span id="cb6-37"><a href="#cb6-37"></a>           <span class="at">label =</span> <span class="st">"Campaign</span><span class="sc">\n</span><span class="st">ends after</span><span class="sc">\n</span><span class="st">6 weeks"</span>, <span class="at">hjust =</span> <span class="st">"left"</span>) <span class="sc">+</span> </span>
<span id="cb6-38"><a href="#cb6-38"></a>  <span class="co"># impact of treatment disappears by 2.5 months</span></span>
<span id="cb6-39"><a href="#cb6-39"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="dv">10</span>, <span class="at">linetype =</span> <span class="st">"dotted"</span>, <span class="at">color =</span> <span class="st">"gray40"</span>) <span class="sc">+</span> </span>
<span id="cb6-40"><a href="#cb6-40"></a>  <span class="fu">annotate</span>(<span class="at">geom =</span> <span class="st">"text"</span>, <span class="at">x =</span> <span class="fl">9.8</span>, <span class="at">y =</span> <span class="fl">0.1</span>, <span class="at">color =</span> <span class="st">"gray40"</span>,</span>
<span id="cb6-41"><a href="#cb6-41"></a>           <span class="at">label =</span> <span class="st">"Impact of</span><span class="sc">\n</span><span class="st">treatment</span><span class="sc">\n</span><span class="st">dies down"</span>, <span class="at">hjust =</span> <span class="st">"right"</span>) <span class="sc">+</span> </span>
<span id="cb6-42"><a href="#cb6-42"></a>  <span class="co"># analysis date (right-censoring at 3 months)</span></span>
<span id="cb6-43"><a href="#cb6-43"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="dv">12</span>, <span class="at">linetype =</span> <span class="st">"dotted"</span>, <span class="at">color =</span> <span class="st">"gray40"</span>) <span class="sc">+</span> </span>
<span id="cb6-44"><a href="#cb6-44"></a>  <span class="fu">annotate</span>(<span class="at">geom =</span> <span class="st">"text"</span>, <span class="at">x =</span> <span class="fl">12.2</span>, <span class="at">y =</span> <span class="fl">0.1</span>, <span class="at">color =</span> <span class="st">"gray40"</span>,</span>
<span id="cb6-45"><a href="#cb6-45"></a>           <span class="at">label =</span> glue<span class="sc">::</span><span class="fu">glue</span>(<span class="st">"Cut-off date for analysis</span><span class="sc">\n</span><span class="st">"</span>, </span>
<span id="cb6-46"><a href="#cb6-46"></a>                              <span class="st">"(administrative right-censoring "</span>, </span>
<span id="cb6-47"><a href="#cb6-47"></a>                              <span class="st">"at 3 months)"</span>), </span>
<span id="cb6-48"><a href="#cb6-48"></a>           <span class="at">hjust =</span> <span class="st">"left"</span>) <span class="sc">+</span> </span>
<span id="cb6-49"><a href="#cb6-49"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"gray20"</span>, <span class="st">"forestgreen"</span>)) <span class="sc">+</span></span>
<span id="cb6-50"><a href="#cb6-50"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">24</span>, <span class="dv">4</span>)) <span class="sc">+</span></span>
<span id="cb6-51"><a href="#cb6-51"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="fl">1.2</span>, <span class="fl">0.2</span>)) <span class="sc">+</span> </span>
<span id="cb6-52"><a href="#cb6-52"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Time since product launch (in weeks)"</span>, <span class="at">y =</span> <span class="st">"Hazard rate"</span>) <span class="sc">+</span></span>
<span id="cb6-53"><a href="#cb6-53"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"bottom"</span>, <span class="at">legend.title =</span> <span class="fu">element_blank</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-2-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>These hazard functions can be expressed mathematically as<br>
<span class="math display">\[
h(t; \alpha, \beta) = \frac{(\beta/\alpha) (t / \alpha)^{\beta - 1}}{1 + (t / \alpha)^\beta}
\]</span></p>
<p>and correspond to a <a href="https://en.wikipedia.org/wiki/Log-logistic_distribution"><em>log-logistic distribution</em></a> (abbreviated as <span class="math inline">\(\text{LL}(\alpha, \beta)\)</span>) for the event times with <em>scale</em> parameter <span class="math inline">\(\alpha = 4\)</span> for the treatment group, <span class="math inline">\(\alpha = 5\)</span> for the control group, and shape parameter <span class="math inline">\(\beta = 7\)</span> identical in both groups.</p>
<p>The motivation for picking the <span class="math inline">\(\text{LL}(\alpha, \beta)\)</span> model for this experiment is that it’s a well known example of an <a href="https://en.wikipedia.org/wiki/Accelerated_failure_time_model"><em>accelerated failure time (AFT) model</em></a>. The impact of treatment is assumed to be positive and transient, where the treatment “accelerates” the event process compared to the control group, with this “accelerating” treatment group peak occurring before the peak in the control group. The hazard function in the treatment group tapers off after some time (8 weeks in this case). The non-monotonic nature — i.e., of the function first increasing and then decreasing with time — can refer to the time it takes for the information about the new product to spread through the population.</p>
<p>The AFT model can be contrasted with the <a href="https://en.wikipedia.org/wiki/Proportional_hazards_model"><em>proportional hazards (PH) model</em></a>, where the hazard rates for the two groups are assumed to be proportional over time. The <a href="https://en.wikipedia.org/wiki/Weibull_distribution"><em>Weibull distribution</em></a> is a prominent example, although it can be parameterized as an AFT model as well. Compared to the log-logistic distribution, it has a monotonic hazard function</p>
<p><span class="math display">\[
h(t; \alpha, \beta) = \frac{\beta}{\alpha} \Bigg(\frac{x}{\alpha}\Bigg) ^ {\beta - 1}
\]</span></p>
<p>with shape parameter <span class="math inline">\(\beta\)</span>, and scale parameter <span class="math inline">\(\alpha\)</span>, so is not suited for settings where the hazard is expected to go up and then down (or other non-monotonic shapes).</p>
<p>The hazard rate is a bit hard to interpret due to the fact that 1) it’s a conditional measure, 2) is a rate rather than a probability (so can have values &gt; 1), and 3) depends on the chosen unit of time.</p>
<p>A related quantity known as the <em>survivor function</em> (aka survival curve) is the marginal probability of being event-free (“surviving”) beyond time <span class="math inline">\(t\)</span>. Mathematically,</p>
<p><span class="math display">\[
S(t) = P[T &gt; t] = \text{exp} \Bigg[ - \int_0^t h(u) du \Bigg]
\]</span></p>
<p>where <span class="math inline">\(h(u)\)</span> is the hazard function (defined above).</p>
<p>When the outcome is death due to disease (in healthcare), or machine failure (in engineering), it makes sense to look at factors (or treatments) that prolong survival. In the scenario where the event occurring faster is seen as positive, the survivor function can be flipped to get the <em>cumulative incidence curve (CIC)</em></p>
<p><span class="math display">\[
P[T \le t] = F(t) = 1 - S(t)
\]</span></p>
<p>where the curve traces the probability of experiencing the event before some time <span class="math inline">\(t\)</span>, and <span class="math inline">\(F(t)\)</span> is the <a href="https://en.wikipedia.org/wiki/Cumulative_distribution_function">CDF</a> of the event times. The cumulative incidence curve corresponding to <span class="math inline">\(\text{LL}(\alpha, \beta)\)</span> is given by <span class="math inline">\(F(t) = [ 1 + (t / \alpha)^ {-\beta}] ^ {-1}\)</span> (with the survivor function <span class="math inline">\(S(t) = [1 + (t / \alpha)^ {\beta}] ^ {-1}\)</span> — notice the sign difference for <span class="math inline">\(\beta\)</span>)</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1"></a>survivor_loglogistic <span class="ot">&lt;-</span> <span class="cf">function</span>(alpha, beta, time) {</span>
<span id="cb7-2"><a href="#cb7-2"></a>  <span class="dv">1</span> <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">+</span> ((time <span class="sc">/</span> alpha) <span class="sc">^</span> beta))</span>
<span id="cb7-3"><a href="#cb7-3"></a>}</span>
<span id="cb7-4"><a href="#cb7-4"></a></span>
<span id="cb7-5"><a href="#cb7-5"></a>loglogistic_attributes <span class="ot">&lt;-</span> loglogistic_attributes <span class="sc">%&gt;%</span> </span>
<span id="cb7-6"><a href="#cb7-6"></a>  <span class="fu">mutate</span>(</span>
<span id="cb7-7"><a href="#cb7-7"></a>    <span class="at">survival =</span> <span class="fu">survivor_loglogistic</span>(alpha, beta, time),</span>
<span id="cb7-8"><a href="#cb7-8"></a>    <span class="at">cdf =</span> <span class="dv">1</span> <span class="sc">-</span> survival</span>
<span id="cb7-9"><a href="#cb7-9"></a>  ) </span>
<span id="cb7-10"><a href="#cb7-10"></a></span>
<span id="cb7-11"><a href="#cb7-11"></a>cumulative_incidence_plot <span class="ot">&lt;-</span> loglogistic_attributes <span class="sc">%&gt;%</span> </span>
<span id="cb7-12"><a href="#cb7-12"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> cdf, <span class="at">group =</span> parameters, <span class="at">color =</span> parameters)) <span class="sc">+</span> </span>
<span id="cb7-13"><a href="#cb7-13"></a>  <span class="fu">geom_line</span>(<span class="at">linewidth =</span> <span class="fl">1.1</span>) <span class="sc">+</span> </span>
<span id="cb7-14"><a href="#cb7-14"></a>  <span class="co"># campaign end date</span></span>
<span id="cb7-15"><a href="#cb7-15"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="dv">6</span>, <span class="at">linetype =</span> <span class="st">"dotted"</span>, <span class="at">color =</span> <span class="st">"gray40"</span>) <span class="sc">+</span> </span>
<span id="cb7-16"><a href="#cb7-16"></a>  <span class="fu">annotate</span>(<span class="at">geom =</span> <span class="st">"text"</span>, <span class="at">x =</span> <span class="fl">6.2</span>, <span class="at">y =</span> <span class="fl">0.6</span>, <span class="at">color =</span> <span class="st">"gray40"</span>,</span>
<span id="cb7-17"><a href="#cb7-17"></a>           <span class="at">label =</span> <span class="st">"Campaign</span><span class="sc">\n</span><span class="st">ends after</span><span class="sc">\n</span><span class="st">6 weeks"</span>, <span class="at">hjust =</span> <span class="st">"left"</span>) <span class="sc">+</span> </span>
<span id="cb7-18"><a href="#cb7-18"></a>  <span class="co"># impact of treatment disappears by 2.5 months</span></span>
<span id="cb7-19"><a href="#cb7-19"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="dv">10</span>, <span class="at">linetype =</span> <span class="st">"dotted"</span>, <span class="at">color =</span> <span class="st">"gray40"</span>) <span class="sc">+</span> </span>
<span id="cb7-20"><a href="#cb7-20"></a>  <span class="fu">annotate</span>(<span class="at">geom =</span> <span class="st">"text"</span>, <span class="at">x =</span> <span class="fl">9.8</span>, <span class="at">y =</span> <span class="fl">0.1</span>, <span class="at">color =</span> <span class="st">"gray40"</span>,</span>
<span id="cb7-21"><a href="#cb7-21"></a>           <span class="at">label =</span> <span class="st">"Impact of</span><span class="sc">\n</span><span class="st">treatment</span><span class="sc">\n</span><span class="st">dies down"</span>, <span class="at">hjust =</span> <span class="st">"right"</span>) <span class="sc">+</span> </span>
<span id="cb7-22"><a href="#cb7-22"></a>  <span class="co"># analysis date (right-censoring at 3 months)</span></span>
<span id="cb7-23"><a href="#cb7-23"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="dv">12</span>, <span class="at">linetype =</span> <span class="st">"dotted"</span>, <span class="at">color =</span> <span class="st">"gray40"</span>) <span class="sc">+</span> </span>
<span id="cb7-24"><a href="#cb7-24"></a>  <span class="fu">annotate</span>(<span class="at">geom =</span> <span class="st">"text"</span>, <span class="at">x =</span> <span class="fl">12.2</span>, <span class="at">y =</span> <span class="fl">0.1</span>, <span class="at">color =</span> <span class="st">"gray40"</span>,</span>
<span id="cb7-25"><a href="#cb7-25"></a>           <span class="at">label =</span> glue<span class="sc">::</span><span class="fu">glue</span>(<span class="st">"Cut-off date for analysis</span><span class="sc">\n</span><span class="st">"</span>, </span>
<span id="cb7-26"><a href="#cb7-26"></a>                              <span class="st">"(administrative right-censoring "</span>, </span>
<span id="cb7-27"><a href="#cb7-27"></a>                              <span class="st">"at 3 months)"</span>), </span>
<span id="cb7-28"><a href="#cb7-28"></a>           <span class="at">hjust =</span> <span class="st">"left"</span>) <span class="sc">+</span> </span>
<span id="cb7-29"><a href="#cb7-29"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"gray20"</span>, <span class="st">"forestgreen"</span>)) <span class="sc">+</span></span>
<span id="cb7-30"><a href="#cb7-30"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">labels =</span> scales<span class="sc">::</span><span class="fu">label_percent</span>()) <span class="sc">+</span></span>
<span id="cb7-31"><a href="#cb7-31"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Time since product launch (in weeks)"</span>, </span>
<span id="cb7-32"><a href="#cb7-32"></a>       <span class="at">y =</span> <span class="st">"Cumulative incidence"</span>) <span class="sc">+</span></span>
<span id="cb7-33"><a href="#cb7-33"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"bottom"</span>, <span class="at">legend.title =</span> <span class="fu">element_blank</span>())</span>
<span id="cb7-34"><a href="#cb7-34"></a></span>
<span id="cb7-35"><a href="#cb7-35"></a>cumulative_incidence_plot <span class="sc">+</span> </span>
<span id="cb7-36"><a href="#cb7-36"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">24</span>, <span class="dv">4</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-3-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>As expected of CDFs, the CIC starts at 0% for both groups at <span class="math inline">\(t = 0\)</span> and keeps increasing over time until it reaches 100%.</p>
</section>
<section id="simulate-true-event-times" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="simulate-true-event-times">Simulate true event times</h2>
<p>Finally, we can get around to simulating some data from our experiment. Normally I’d use either the <a href="https://cran.r-project.org/web/packages/coxed/"><code>coxed::sim.survdata()</code></a> function or the <a href="https://cran.r-project.org/web/packages/simsurv/"><code>simsurv::simsurv()</code></a> function, but in the interest of learning<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a> I’m going to do this manually using the <em>cumulative hazard inversion method</em> (usually attributed to <a href="https://onlinelibrary.wiley.com/doi/10.1002/sim.2059">this paper</a> and concisely described in the <code>simsurv</code> package vignette <a href="https://cran.r-project.org/web/packages/simsurv/vignettes/simsurv_technical.html">here</a>).</p>
<div class="no-row-height column-margin column-container"><p><sup>2</sup>&nbsp;These packages don’t support log-logistic models out-of-the-box anyway.</p></div><p>For simulating data from a Weibull PH model as opposed to the log-logistic AFT model, see <a href="https://stats.stackexchange.com/questions/135124/how-to-create-a-toy-survival-time-to-event-data-with-right-censoring">this</a>, <a href="https://stats.stackexchange.com/questions/603395/simulating-survival-times">this</a>, or the papers in the previous paragraph. <a href="https://onlinelibrary.wiley.com/doi/10.1002/sim.5823">This paper</a> is also pretty useful for simulating data from more complex settings.</p>
<p>Plugging in the value of <span class="math inline">\(F(T_i)\)</span> for the log-logistic distribution, and doing some algebra gives the function for simulating the true (or latent) event time <span class="math inline">\(T_i\)</span> for the <span class="math inline">\(i\)</span>-th individual from a log-logistic distribution (matches equation 8 from <a href="https://www.ncbi.nlm.nih.gov/pmc/articles/PMC5061707/">this paper</a>).</p>
<p><span class="math display">\[
\begin{align*}
S(T_i) = 1 - F(T_i) &amp;= U_i \sim \text{Uniform}(0, 1) \\
1 - \frac{1}{1 + (T_i / \alpha)^{-\beta}} &amp;= U_i \\
1 + \Bigg(\frac{T_i}{\alpha}\Bigg)^{-\beta} &amp;= \frac{1}{1 - U_i} \\
\Bigg(\frac{T_i}{\alpha}\Bigg)^{-\beta} &amp;= \frac{U_i}{1 - U_i} \\
\Bigg(\frac{\alpha}{T_i}\Bigg)^{\beta} &amp;= \frac{1 - U_i}{U_i} \\
\frac{\alpha}{T_i} &amp;= \Bigg(\frac{1 - U_i}{U_i}\Bigg)^{1 / \beta} \\
T_i &amp;= \alpha (U_i^{-1} - 1)^{-1 / \beta} \\
\end{align*}
\]</span></p>
<p>The Wikipedia page for log-logistic distribution mentions that <span class="math inline">\(\text{log}(\alpha_i) = X_i^T \gamma\)</span> can be used to specify covariates that influence the scale parameter <span class="math inline">\(\alpha_i\)</span> — with <span class="math inline">\(\gamma\)</span> the (<span class="math inline">\(p\)</span>-dimensional row) vector of coefficients, and <span class="math inline">\(X_i\)</span> the (<span class="math inline">\(p\)</span>-dimensional row) vector of covariates for individual <span class="math inline">\(i\)</span>. The shape parameter <span class="math inline">\(\beta\)</span> is assumed to be constant across covariate levels, but it’s possible to model <span class="math inline">\(\beta\)</span> as a function of covariates as well with <span class="math inline">\(\text{log}(\beta_i) = Z_i^T \delta\)</span> where <span class="math inline">\(Z\)</span> and <span class="math inline">\(X\)</span> can be identical, partly overlapping, or completely disjoint covariate sets, and <span class="math inline">\(\delta\)</span> the associated coefficients. Using logs ensures that both <span class="math inline">\(\alpha_i\)</span> and <span class="math inline">\(\beta_i\)</span> will have values greater than zero. This gives</p>
<p><span class="math display">\[
T_i = \text{exp}(X_i^T \gamma)(U_i^{-1} - 1)^{-1 / \text{exp}(Z_i^T \delta)}
\]</span></p>
<p>We can draw simulated event times across 30 experiments each with about 1000 individuals split evenly between the treatment and control groups.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1"></a>n_sim <span class="ot">&lt;-</span> <span class="dv">30</span></span>
<span id="cb8-2"><a href="#cb8-2"></a>n_sample <span class="ot">&lt;-</span> <span class="dv">1000</span></span>
<span id="cb8-3"><a href="#cb8-3"></a>n_total <span class="ot">&lt;-</span> n_sim <span class="sc">*</span> n_sample</span>
<span id="cb8-4"><a href="#cb8-4"></a></span>
<span id="cb8-5"><a href="#cb8-5"></a><span class="fu">set.seed</span>(<span class="dv">43</span>)</span>
<span id="cb8-6"><a href="#cb8-6"></a>loglogistic_samples <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb8-7"><a href="#cb8-7"></a>  <span class="at">sim_id =</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span>n_sim, <span class="at">each =</span> n_sample),</span>
<span id="cb8-8"><a href="#cb8-8"></a>  <span class="at">id =</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span>n_sample, <span class="at">times =</span> n_sim),</span>
<span id="cb8-9"><a href="#cb8-9"></a>  <span class="at">treatment =</span> <span class="fu">sample</span>(<span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>), <span class="at">size =</span> n_total,</span>
<span id="cb8-10"><a href="#cb8-10"></a>                     <span class="at">replace =</span> <span class="cn">TRUE</span>, <span class="at">prob =</span> <span class="fu">c</span>(<span class="fl">0.5</span>, <span class="fl">0.5</span>)),</span>
<span id="cb8-11"><a href="#cb8-11"></a>  <span class="at">parameters =</span> <span class="fu">case_when</span>(</span>
<span id="cb8-12"><a href="#cb8-12"></a>    treatment <span class="sc">==</span> <span class="dv">1</span> <span class="sc">~</span> <span class="st">"Treatment group (T ~ LL(4, 7))"</span>,</span>
<span id="cb8-13"><a href="#cb8-13"></a>    treatment <span class="sc">==</span> <span class="dv">0</span> <span class="sc">~</span> <span class="st">"Control group (T ~ LL(5, 7))"</span></span>
<span id="cb8-14"><a href="#cb8-14"></a>  ),</span>
<span id="cb8-15"><a href="#cb8-15"></a>  <span class="co"># -log(1.25) corresponds to alpha = 5 in control</span></span>
<span id="cb8-16"><a href="#cb8-16"></a>  <span class="co"># and alpha = 4 in treatment</span></span>
<span id="cb8-17"><a href="#cb8-17"></a>  <span class="at">linear_predictor_alpha =</span> <span class="fu">log</span>(<span class="dv">5</span>) <span class="sc">-</span> <span class="fu">log</span>(<span class="fl">1.25</span>) <span class="sc">*</span> treatment,</span>
<span id="cb8-18"><a href="#cb8-18"></a>  <span class="at">linear_predictor_beta =</span><span class="fu">log</span>(<span class="dv">7</span>),</span>
<span id="cb8-19"><a href="#cb8-19"></a>  <span class="at">u =</span> <span class="fu">runif</span>(n_total, <span class="at">min =</span> <span class="dv">0</span>, <span class="at">max =</span> <span class="dv">1</span>),</span>
<span id="cb8-20"><a href="#cb8-20"></a>  <span class="at">time =</span> (<span class="fu">exp</span>(linear_predictor_alpha) <span class="sc">*</span></span>
<span id="cb8-21"><a href="#cb8-21"></a>            (((<span class="dv">1</span> <span class="sc">/</span> u) <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">^</span> (<span class="sc">-</span><span class="dv">1</span> <span class="sc">/</span> <span class="fu">exp</span>(linear_predictor_beta))))</span>
<span id="cb8-22"><a href="#cb8-22"></a>)</span>
<span id="cb8-23"><a href="#cb8-23"></a></span>
<span id="cb8-24"><a href="#cb8-24"></a>loglogistic_samples <span class="sc">%&gt;%</span> <span class="fu">glimpse</span>(<span class="at">width =</span> <span class="dv">80</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 30,000
Columns: 8
$ sim_id                 &lt;int&gt; 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,…
$ id                     &lt;int&gt; 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, …
$ treatment              &lt;dbl&gt; 1, 0, 1, 0, 1, 0, 0, 0, 1, 0, 1, 1, 0, 1, 1, 0,…
$ parameters             &lt;chr&gt; "Treatment group (T ~ LL(4, 7))", "Control grou…
$ linear_predictor_alpha &lt;dbl&gt; 1.386294, 1.609438, 1.386294, 1.609438, 1.38629…
$ linear_predictor_beta  &lt;dbl&gt; 1.94591, 1.94591, 1.94591, 1.94591, 1.94591, 1.…
$ u                      &lt;dbl&gt; 0.74638903, 0.60531731, 0.35898984, 0.93116119,…
$ time                   &lt;dbl&gt; 4.666927, 5.315004, 3.682061, 7.253854, 4.86455…</code></pre>
</div>
</div>
<p>The estimated CDFs for each sample are added to a zoomed-in version of cumulative incidence figure above.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1"></a>cumulative_incidence_plot_samples <span class="ot">&lt;-</span> cumulative_incidence_plot </span>
<span id="cb10-2"><a href="#cb10-2"></a></span>
<span id="cb10-3"><a href="#cb10-3"></a><span class="co"># for this hacky solution to overlay the true curves over</span></span>
<span id="cb10-4"><a href="#cb10-4"></a><span class="co"># the sampled curves, see </span></span>
<span id="cb10-5"><a href="#cb10-5"></a><span class="co"># https://stackoverflow.com/questions/20249653/insert-layer-underneath-existing-layers-in-ggplot2-object</span></span>
<span id="cb10-6"><a href="#cb10-6"></a>cumulative_incidence_plot_samples<span class="sc">$</span>layers <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb10-7"><a href="#cb10-7"></a>  <span class="fu">stat_ecdf</span>(</span>
<span id="cb10-8"><a href="#cb10-8"></a>    <span class="at">data =</span> loglogistic_samples, </span>
<span id="cb10-9"><a href="#cb10-9"></a>    <span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">linetype =</span> parameters, </span>
<span id="cb10-10"><a href="#cb10-10"></a>        <span class="at">group =</span> <span class="fu">interaction</span>(sim_id, parameters)), </span>
<span id="cb10-11"><a href="#cb10-11"></a>    <span class="at">inherit.aes =</span> <span class="cn">FALSE</span>, </span>
<span id="cb10-12"><a href="#cb10-12"></a>    <span class="at">color =</span> <span class="st">"gray70"</span></span>
<span id="cb10-13"><a href="#cb10-13"></a>  ), </span>
<span id="cb10-14"><a href="#cb10-14"></a>  cumulative_incidence_plot<span class="sc">$</span>layers</span>
<span id="cb10-15"><a href="#cb10-15"></a>)</span>
<span id="cb10-16"><a href="#cb10-16"></a></span>
<span id="cb10-17"><a href="#cb10-17"></a>cumulative_incidence_plot_samples <span class="sc">+</span> </span>
<span id="cb10-18"><a href="#cb10-18"></a>  <span class="fu">coord_cartesian</span>(<span class="at">xlim =</span> <span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">10</span>)) <span class="sc">+</span> </span>
<span id="cb10-19"><a href="#cb10-19"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">2</span>, <span class="dv">10</span>, <span class="dv">1</span>)) <span class="sc">+</span> </span>
<span id="cb10-20"><a href="#cb10-20"></a>  <span class="fu">guides</span>(</span>
<span id="cb10-21"><a href="#cb10-21"></a>    <span class="at">color =</span> <span class="fu">guide_legend</span>(<span class="at">nrow =</span> <span class="dv">2</span>), </span>
<span id="cb10-22"><a href="#cb10-22"></a>    <span class="at">linetype =</span> <span class="fu">guide_legend</span>(<span class="at">nrow =</span> <span class="dv">2</span>)</span>
<span id="cb10-23"><a href="#cb10-23"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-5-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The empirical CDFs of survival times for each sample fluctuate around the true curve in each group, which is reassuring. These simulated event times are the <em>true</em> individual event times for that specific sample of individuals. These are not always observed, which brings us to our next point.</p>
</section>
<section id="add-censoring" class="level2">
<h2 class="anchored" data-anchor-id="add-censoring">Add censoring</h2>
<p>One complication I’ve ignored so far is <em>(right-)censoring</em>. Individuals are said to be right-censored if they haven’t had the event of interest yet at the time of analysis and therefore only a lower bound on their true event time is observed.</p>
<p>The most common data structure for survival analysis is the tuple <span class="math inline">\((Y_i, \delta_i)\)</span> where <span class="math inline">\(Y_i = \text{min}(T_i, C_i)\)</span> is the smaller of the event time <span class="math inline">\(T_i\)</span> or the censoring time <span class="math inline">\(C_i\)</span>, and <span class="math inline">\(\delta_i = I(T_i \le C_i)\)</span> is the event indicator with value 1 indicating the true event time is observed, and 0 indicating that the observation is censored. The censoring indicator is <span class="math inline">\(1 - \delta_i\)</span>.</p>
<p>Non-informative administrative (or Type-1) right censoring is the simplest type of censoring where the censoring time is the same for all individuals. If two analyses are carried out — one after three weeks, and another after twelve weeks — then the same individual with true <span class="math inline">\(T_i = 4.5\)</span> is recorded as <span class="math inline">\((Y_i = 3, \delta_i = 0)\)</span> in the first analysis and <span class="math inline">\((Y_i = 4.5, \delta_i = 1)\)</span> in the second analysis.</p>
<p>This can be applied to the simulated event times easily enough using simple conditionals</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1"></a>loglogistic_samples <span class="sc">%&gt;%</span> </span>
<span id="cb11-2"><a href="#cb11-2"></a>  <span class="fu">select</span>(time) <span class="sc">%&gt;%</span> </span>
<span id="cb11-3"><a href="#cb11-3"></a>  <span class="fu">mutate</span>(</span>
<span id="cb11-4"><a href="#cb11-4"></a>    <span class="at">latent =</span> time,</span>
<span id="cb11-5"><a href="#cb11-5"></a>    <span class="at">time3 =</span> <span class="fu">pmin</span>(time, <span class="fl">3.0</span>),</span>
<span id="cb11-6"><a href="#cb11-6"></a>    <span class="at">cens3 =</span> <span class="fu">as.numeric</span>(time <span class="sc">&gt;</span> <span class="fl">3.0</span>),</span>
<span id="cb11-7"><a href="#cb11-7"></a>    <span class="at">time6 =</span> <span class="fu">pmin</span>(time, <span class="fl">6.0</span>),</span>
<span id="cb11-8"><a href="#cb11-8"></a>    <span class="at">cens6 =</span> <span class="fu">as.numeric</span>(time <span class="sc">&gt;</span> <span class="fl">6.0</span>),</span>
<span id="cb11-9"><a href="#cb11-9"></a>    <span class="at">time12 =</span> <span class="fu">pmin</span>(time, <span class="fl">12.0</span>),</span>
<span id="cb11-10"><a href="#cb11-10"></a>    <span class="at">cens12 =</span> <span class="fu">as.numeric</span>(time <span class="sc">&gt;</span> <span class="fl">12.0</span>)</span>
<span id="cb11-11"><a href="#cb11-11"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb11-12"><a href="#cb11-12"></a>  <span class="fu">select</span>(<span class="sc">-</span>time) <span class="sc">%&gt;%</span> </span>
<span id="cb11-13"><a href="#cb11-13"></a>  <span class="fu">summary</span>(<span class="at">digits =</span> <span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     latent          time3          cens3          time6          cens6     
 Min.   : 0.84   Min.   :0.84   Min.   :0.00   Min.   :0.84   Min.   :0.00  
 1st Qu.: 3.73   1st Qu.:3.00   1st Qu.:1.00   1st Qu.:3.73   1st Qu.:0.00  
 Median : 4.45   Median :3.00   Median :1.00   Median :4.45   Median :0.00  
 Mean   : 4.64   Mean   :2.97   Mean   :0.93   Mean   :4.49   Mean   :0.13  
 3rd Qu.: 5.33   3rd Qu.:3.00   3rd Qu.:1.00   3rd Qu.:5.33   3rd Qu.:0.00  
 Max.   :20.05   Max.   :3.00   Max.   :1.00   Max.   :6.00   Max.   :1.00  
     time12          cens12      
 Min.   : 0.84   Min.   :0.0000  
 1st Qu.: 3.73   1st Qu.:0.0000  
 Median : 4.45   Median :0.0000  
 Mean   : 4.64   Mean   :0.0015  
 3rd Qu.: 5.33   3rd Qu.:0.0000  
 Max.   :12.00   Max.   :1.0000  </code></pre>
</div>
</div>
<p>The overall true event time distribution — in the latent column — goes up to 20 weeks, but due to censoring, 93% of observations are censored at 3 weeks, 13% at 6 weeks, and fewer than 1% at twelve weeks, with the maximum time equal to the censoring time. The larger the proportion of censoring, the larger the difference between the true mean and the mean of the censored event time distribution.</p>
<p>In more complex settings, censoring times can be simulated from (say) an exponential or gamma distribution that is assumed to be independent of the event times, or the censoring distribution can vary as a function of covariates. The next plot overlays the true event time densities in each treatment group on top of the censoring distribution <span class="math inline">\(C_i \sim \text{Gamma}(6, 1)\)</span></p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1"></a><span class="fu">set.seed</span>(<span class="dv">43</span>)</span>
<span id="cb13-2"><a href="#cb13-2"></a>loglogistic_samples <span class="sc">%&gt;%</span></span>
<span id="cb13-3"><a href="#cb13-3"></a>  <span class="fu">select</span>(parameters, time) <span class="sc">%&gt;%</span></span>
<span id="cb13-4"><a href="#cb13-4"></a>  <span class="fu">bind_rows</span>(</span>
<span id="cb13-5"><a href="#cb13-5"></a>    <span class="fu">tibble</span>(</span>
<span id="cb13-6"><a href="#cb13-6"></a>      <span class="at">parameters =</span> <span class="st">"Censoring times ~ Gamma(6, 1)"</span>,</span>
<span id="cb13-7"><a href="#cb13-7"></a>      <span class="at">time =</span> <span class="fu">rgamma</span>(<span class="fu">floor</span>(n_total <span class="sc">/</span> <span class="dv">2</span>), <span class="at">shape =</span> <span class="dv">6</span>, <span class="at">scale =</span> <span class="dv">1</span>)</span>
<span id="cb13-8"><a href="#cb13-8"></a>    )</span>
<span id="cb13-9"><a href="#cb13-9"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb13-10"><a href="#cb13-10"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">fill =</span> parameters, <span class="at">color =</span> parameters)) <span class="sc">+</span></span>
<span id="cb13-11"><a href="#cb13-11"></a>  <span class="fu">geom_density</span>(<span class="at">alpha =</span> <span class="fl">0.6</span>) <span class="sc">+</span></span>
<span id="cb13-12"><a href="#cb13-12"></a>  <span class="fu">xlab</span>(<span class="st">"Time since product launch (in weeks)"</span>) <span class="sc">+</span></span>
<span id="cb13-13"><a href="#cb13-13"></a>  <span class="fu">theme</span>(<span class="at">legend.title =</span> <span class="fu">element_blank</span>(), <span class="at">legend.position =</span> <span class="st">"bottom"</span>) <span class="sc">+</span> </span>
<span id="cb13-14"><a href="#cb13-14"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"purple3"</span>, <span class="st">"gray20"</span>, <span class="st">"forestgreen"</span>)) <span class="sc">+</span></span>
<span id="cb13-15"><a href="#cb13-15"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"purple3"</span>, <span class="st">"gray20"</span>, <span class="st">"forestgreen"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-7-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>In this case, the code is nearly the same.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1"></a><span class="fu">set.seed</span>(<span class="dv">43</span>)</span>
<span id="cb14-2"><a href="#cb14-2"></a>loglogistic_samples <span class="sc">%&gt;%</span></span>
<span id="cb14-3"><a href="#cb14-3"></a>  <span class="fu">select</span>(parameters, <span class="at">latent =</span> time) <span class="sc">%&gt;%</span></span>
<span id="cb14-4"><a href="#cb14-4"></a>  <span class="fu">mutate</span>(</span>
<span id="cb14-5"><a href="#cb14-5"></a>    <span class="at">censoring_time =</span> <span class="fu">rgamma</span>(n_total, <span class="at">shape =</span> <span class="dv">6</span>, <span class="at">scale =</span> <span class="dv">1</span>),</span>
<span id="cb14-6"><a href="#cb14-6"></a>    <span class="at">observed_time =</span> <span class="fu">pmin</span>(latent, censoring_time),</span>
<span id="cb14-7"><a href="#cb14-7"></a>    <span class="at">cens =</span> <span class="fu">as.numeric</span>(latent <span class="sc">&gt;</span> censoring_time)</span>
<span id="cb14-8"><a href="#cb14-8"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb14-9"><a href="#cb14-9"></a>  <span class="fu">summarize</span>(</span>
<span id="cb14-10"><a href="#cb14-10"></a>    <span class="fu">across</span>(</span>
<span id="cb14-11"><a href="#cb14-11"></a>      <span class="at">.cols =</span> <span class="fu">everything</span>(), </span>
<span id="cb14-12"><a href="#cb14-12"></a>      <span class="at">.fns =</span> <span class="sc">~</span> <span class="fu">round</span>(<span class="fu">mean</span>(.x), <span class="dv">2</span>), </span>
<span id="cb14-13"><a href="#cb14-13"></a>      <span class="at">.names =</span> <span class="st">"mean_{.col}"</span></span>
<span id="cb14-14"><a href="#cb14-14"></a>    ), </span>
<span id="cb14-15"><a href="#cb14-15"></a>    <span class="at">.by =</span> parameters</span>
<span id="cb14-16"><a href="#cb14-16"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 × 5
  parameters        mean_latent mean_censoring_time mean_observed_time mean_cens
  &lt;chr&gt;                   &lt;dbl&gt;               &lt;dbl&gt;              &lt;dbl&gt;     &lt;dbl&gt;
1 Treatment group …        4.12                5.99               3.81      0.25
2 Control group (T…        5.16                6                  4.46      0.4 </code></pre>
</div>
</div>
<p>Summary of the simulated data shows that 25% of the individuals in the treatment group are censored compared to 40% of the individuals in the control group over the full range of time values (about 20 weeks).</p>
</section>
<section id="add-cure" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="add-cure">Add cure</h2>
<p>Another complication is the presence of <em>(statistical) cure</em>. Some individuals will never purchase the product irrespective of whichever group they fall in. Which means that if the follow-up period is extended from 12 weeks to 150 or 500 weeks, these so-called “cured” individuals will still show up as censored because their true survival time is effectively infinite. Ignoring cure and using a cox model can lead to biased estimates of the quantities we’re interested in, as figure 2 of <a href="https://www.annualreviews.org/content/journals/10.1146/annurev-statistics-031017-100101">this paper</a> visually demonstrates. It also gives an overview of the different types of (major) cure models. Another reference I found useful was <a href="https://dial.uclouvain.be/pr/boreal/object/boreal%3A220045/datastream/PDF_02/view">this one</a><a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a>.</p>
<div class="no-row-height column-margin column-container"><p><sup>3</sup>&nbsp;This is the link to the Bertand and Legrand book chapter mentioned in the references below.</p></div><p>The family of <em>mixture cure model</em> has the following survivor function form</p>
<p><span class="math display">\[
S_{\text{pop}}(t|I, L) = (1 - \pi(I)) + \pi(I) S_u(t|L)
\]</span></p>
<p>with two parts: the first part is based on the <em>incidence</em> which is whether an individual is cured or not (<span class="math inline">\(\pi(I) = P[B = 1 | I]\)</span> is the probability of being cured as a function of covariate <span class="math inline">\(I\)</span>, and <span class="math inline">\(B\)</span> is the latent cure status); and the second part is concerned with <em>latency</em>, which is about how long it takes for the event to occur among the uncured. <span class="math inline">\(L\)</span> is the set of factors that affect latency. Overlap between <span class="math inline">\(I\)</span> and <span class="math inline">\(L\)</span> is possible.</p>
<p>The other major family of cure models is the <em>promotion time cure model</em> with the survivor function</p>
<p><span class="math display">\[
S_{\text{pop}}(t|x) = \text{exp}[-\theta(x)F(t)]
\]</span></p>
<p>which has a PH interpretation. In this model, parameters affecting cure and survival are not separated like they are in the mixture cure model.</p>
<p>Finally, <a href="https://journals.sagepub.com/doi/10.1177/1536867X0700700304">this paper</a> mentions relative survival / excess mortality models as well, which considers individuals in the treatment or control group to be cured when the hazard rate decreases to background levels.</p>
<p>The simplest cure model is the constant one, where the cure fraction is the same across all groups. This can be simulated by generating a latent “cure” variable <span class="math inline">\(B_i \sim \text{Bernoulli}(\pi_i)\)</span> (with <span class="math inline">\(\pi_i = \pi = 0.3\)</span> denoting the proportion of cured individuals in the next code chunk)</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1"></a><span class="fu">set.seed</span>(<span class="dv">43</span>)</span>
<span id="cb16-2"><a href="#cb16-2"></a>loglogistic_samples <span class="sc">%&gt;%</span></span>
<span id="cb16-3"><a href="#cb16-3"></a>  <span class="fu">mutate</span>(</span>
<span id="cb16-4"><a href="#cb16-4"></a>    <span class="at">cured =</span> <span class="fu">rbinom</span>(n_total, <span class="dv">1</span>, <span class="fl">0.3</span>),</span>
<span id="cb16-5"><a href="#cb16-5"></a>    <span class="at">time =</span> <span class="fu">ifelse</span>(cured <span class="sc">==</span> <span class="dv">1</span>, <span class="dv">10000</span>, time), </span>
<span id="cb16-6"><a href="#cb16-6"></a>    <span class="at">time6 =</span> <span class="fu">pmin</span>(time, <span class="fl">6.0</span>),</span>
<span id="cb16-7"><a href="#cb16-7"></a>    <span class="at">cens6 =</span> <span class="fu">as.numeric</span>(time <span class="sc">&gt;</span> <span class="fl">6.0</span>)</span>
<span id="cb16-8"><a href="#cb16-8"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb16-9"><a href="#cb16-9"></a>  <span class="fu">count</span>(cured, cens6) <span class="sc">%&gt;%</span> </span>
<span id="cb16-10"><a href="#cb16-10"></a>  <span class="fu">mutate</span>(<span class="at">p =</span> <span class="fu">round</span>(<span class="dv">100</span> <span class="sc">*</span> (n <span class="sc">/</span> <span class="fu">sum</span>(n)), <span class="dv">1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3 × 4
  cured cens6     n     p
  &lt;int&gt; &lt;dbl&gt; &lt;int&gt; &lt;dbl&gt;
1     0     0 18898  63  
2     0     1  2117   7.1
3     1     1  8985  30  </code></pre>
</div>
</div>
<p>If six weeks is used as the cutoff time for analysis, 63% of the individuals overall have experienced the event of interest, and 37% are censored of which 7% are the censored uncured observations, and 30% are the censored cured individuals.</p>
<p>The logistic model for incidence can be more elaborate — the following code generates data where the cure fraction varies as a function of (say) age</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1"></a>loglogistic_samples <span class="sc">%&gt;%</span></span>
<span id="cb18-2"><a href="#cb18-2"></a>  <span class="fu">mutate</span>(</span>
<span id="cb18-3"><a href="#cb18-3"></a>    <span class="at">age =</span> {</span>
<span id="cb18-4"><a href="#cb18-4"></a>      <span class="fu">rgamma</span>(<span class="at">n =</span> n_total, <span class="at">shape =</span> <span class="dv">40</span>, <span class="at">rate =</span> <span class="fl">0.7</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb18-5"><a href="#cb18-5"></a>        <span class="fu">pmin</span>(., <span class="dv">90</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb18-6"><a href="#cb18-6"></a>        <span class="fu">pmax</span>(<span class="dv">20</span>, .) <span class="sc">%&gt;%</span> </span>
<span id="cb18-7"><a href="#cb18-7"></a>        <span class="fu">round</span>(., <span class="dv">1</span>)</span>
<span id="cb18-8"><a href="#cb18-8"></a>    },</span>
<span id="cb18-9"><a href="#cb18-9"></a>    <span class="at">cured =</span> <span class="fu">rbinom</span>(n_total, <span class="dv">1</span>, <span class="fu">plogis</span>(<span class="dv">4</span> <span class="sc">-</span> <span class="fl">0.07</span> <span class="sc">*</span> age)),</span>
<span id="cb18-10"><a href="#cb18-10"></a>    <span class="at">time =</span> <span class="fu">ifelse</span>(cured <span class="sc">==</span> <span class="dv">1</span>, <span class="dv">10000</span>, time),</span>
<span id="cb18-11"><a href="#cb18-11"></a>    <span class="at">time6 =</span> <span class="fu">pmin</span>(time, <span class="fl">6.0</span>),</span>
<span id="cb18-12"><a href="#cb18-12"></a>    <span class="at">cens6 =</span> <span class="fu">as.numeric</span>(time <span class="sc">&gt;</span> <span class="fl">6.0</span>),</span>
<span id="cb18-13"><a href="#cb18-13"></a>    <span class="at">event6 =</span> <span class="dv">1</span> <span class="sc">-</span> cens6,</span>
<span id="cb18-14"><a href="#cb18-14"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="putting-it-all-together" class="level2">
<h2 class="anchored" data-anchor-id="putting-it-all-together">Putting it all together</h2>
<p>All of the respective code chunks can be combined into a single call with a total sample size of <span class="math inline">\(n = 50,000\)</span>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1"></a>n_sim <span class="ot">&lt;-</span> <span class="dv">50</span></span>
<span id="cb19-2"><a href="#cb19-2"></a>n_sample <span class="ot">&lt;-</span> <span class="dv">1000</span></span>
<span id="cb19-3"><a href="#cb19-3"></a>n_total <span class="ot">&lt;-</span> n_sim <span class="sc">*</span> n_sample</span>
<span id="cb19-4"><a href="#cb19-4"></a></span>
<span id="cb19-5"><a href="#cb19-5"></a><span class="fu">set.seed</span>(<span class="dv">43</span>)</span>
<span id="cb19-6"><a href="#cb19-6"></a></span>
<span id="cb19-7"><a href="#cb19-7"></a>simulated_data <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb19-8"><a href="#cb19-8"></a>  <span class="co">#</span></span>
<span id="cb19-9"><a href="#cb19-9"></a>  <span class="co"># simulate id variables and covariates</span></span>
<span id="cb19-10"><a href="#cb19-10"></a>  <span class="co">#</span></span>
<span id="cb19-11"><a href="#cb19-11"></a>  <span class="at">sim_id =</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span>n_sim, <span class="at">each =</span> n_sample),</span>
<span id="cb19-12"><a href="#cb19-12"></a>  <span class="at">id =</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span>n_sample, <span class="at">times =</span> n_sim),</span>
<span id="cb19-13"><a href="#cb19-13"></a>  <span class="at">treatment =</span> <span class="fu">sample</span>(<span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>), <span class="at">size =</span> n_total,</span>
<span id="cb19-14"><a href="#cb19-14"></a>                     <span class="at">replace =</span> <span class="cn">TRUE</span>, <span class="at">prob =</span> <span class="fu">c</span>(<span class="fl">0.5</span>, <span class="fl">0.5</span>)),</span>
<span id="cb19-15"><a href="#cb19-15"></a>  <span class="at">parameters =</span> <span class="fu">case_when</span>(</span>
<span id="cb19-16"><a href="#cb19-16"></a>    treatment <span class="sc">==</span> <span class="dv">1</span> <span class="sc">~</span> <span class="st">"Treatment group (T ~ LL(4, 7))"</span>,</span>
<span id="cb19-17"><a href="#cb19-17"></a>    treatment <span class="sc">==</span> <span class="dv">0</span> <span class="sc">~</span> <span class="st">"Control group (T ~ LL(5, 7))"</span></span>
<span id="cb19-18"><a href="#cb19-18"></a>  ),</span>
<span id="cb19-19"><a href="#cb19-19"></a>  <span class="at">age =</span> {</span>
<span id="cb19-20"><a href="#cb19-20"></a>      <span class="fu">rgamma</span>(<span class="at">n =</span> n_total, <span class="at">shape =</span> <span class="dv">40</span>, <span class="at">rate =</span> <span class="fl">0.7</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb19-21"><a href="#cb19-21"></a>        <span class="fu">pmin</span>(., <span class="dv">90</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb19-22"><a href="#cb19-22"></a>        <span class="fu">pmax</span>(<span class="dv">20</span>, .) <span class="sc">%&gt;%</span> </span>
<span id="cb19-23"><a href="#cb19-23"></a>        <span class="fu">round</span>(., <span class="dv">1</span>)</span>
<span id="cb19-24"><a href="#cb19-24"></a>    },</span>
<span id="cb19-25"><a href="#cb19-25"></a>  <span class="co">#</span></span>
<span id="cb19-26"><a href="#cb19-26"></a>  <span class="co"># simulate latent event times as a function of covariates</span></span>
<span id="cb19-27"><a href="#cb19-27"></a>  <span class="co">#</span></span>
<span id="cb19-28"><a href="#cb19-28"></a>  <span class="at">linear_predictor_alpha =</span> <span class="fu">log</span>(<span class="dv">5</span>) <span class="sc">-</span> <span class="fu">log</span>(<span class="fl">1.25</span>) <span class="sc">*</span> treatment,</span>
<span id="cb19-29"><a href="#cb19-29"></a>  <span class="at">linear_predictor_beta =</span><span class="fu">log</span>(<span class="dv">7</span>),</span>
<span id="cb19-30"><a href="#cb19-30"></a>  <span class="at">u =</span> <span class="fu">runif</span>(n_total, <span class="at">min =</span> <span class="dv">0</span>, <span class="at">max =</span> <span class="dv">1</span>),</span>
<span id="cb19-31"><a href="#cb19-31"></a>  <span class="at">uncured_time =</span> (<span class="fu">exp</span>(linear_predictor_alpha) <span class="sc">*</span></span>
<span id="cb19-32"><a href="#cb19-32"></a>            (((<span class="dv">1</span> <span class="sc">/</span> u) <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">^</span> (<span class="sc">-</span><span class="dv">1</span> <span class="sc">/</span> <span class="fu">exp</span>(linear_predictor_beta)))), </span>
<span id="cb19-33"><a href="#cb19-33"></a>  <span class="co"># </span></span>
<span id="cb19-34"><a href="#cb19-34"></a>  <span class="co"># simulate the cure / incidence part from a logistic model</span></span>
<span id="cb19-35"><a href="#cb19-35"></a>  <span class="co">#</span></span>
<span id="cb19-36"><a href="#cb19-36"></a>  <span class="at">cured =</span> <span class="fu">rbinom</span>(n_total, <span class="dv">1</span>, <span class="fu">plogis</span>(<span class="dv">4</span> <span class="sc">-</span> <span class="fl">0.07</span> <span class="sc">*</span> age)),</span>
<span id="cb19-37"><a href="#cb19-37"></a>  <span class="at">latent_time =</span> <span class="fu">ifelse</span>(cured <span class="sc">==</span> <span class="dv">1</span>, <span class="dv">10000</span>, uncured_time),</span>
<span id="cb19-38"><a href="#cb19-38"></a>  <span class="co">#</span></span>
<span id="cb19-39"><a href="#cb19-39"></a>  <span class="co"># simulate censoring times and censor some individuals</span></span>
<span id="cb19-40"><a href="#cb19-40"></a>  <span class="co"># </span></span>
<span id="cb19-41"><a href="#cb19-41"></a>  <span class="at">random_censoring =</span> <span class="fu">rgamma</span>(n_total, <span class="at">shape =</span> <span class="dv">6</span>, <span class="at">scale =</span> <span class="dv">1</span>),</span>
<span id="cb19-42"><a href="#cb19-42"></a>  <span class="co"># keep the smallest of the random censoring </span></span>
<span id="cb19-43"><a href="#cb19-43"></a>  <span class="co"># and administrative censoring (at t = 6) times</span></span>
<span id="cb19-44"><a href="#cb19-44"></a>  <span class="at">censoring_time =</span> <span class="fu">pmin</span>(random_censoring, <span class="dv">6</span>),</span>
<span id="cb19-45"><a href="#cb19-45"></a>  <span class="at">time =</span> <span class="fu">pmin</span>(latent_time, censoring_time),</span>
<span id="cb19-46"><a href="#cb19-46"></a>  <span class="at">cens =</span> <span class="fu">as.numeric</span>(latent_time <span class="sc">&gt;</span> censoring_time), </span>
<span id="cb19-47"><a href="#cb19-47"></a>  <span class="at">event =</span> <span class="dv">1</span> <span class="sc">-</span> cens</span>
<span id="cb19-48"><a href="#cb19-48"></a>)</span>
<span id="cb19-49"><a href="#cb19-49"></a></span>
<span id="cb19-50"><a href="#cb19-50"></a>simulated_data <span class="sc">%&gt;%</span> <span class="fu">glimpse</span>(<span class="at">width =</span> <span class="dv">80</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 50,000
Columns: 16
$ sim_id                 &lt;int&gt; 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,…
$ id                     &lt;int&gt; 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, …
$ treatment              &lt;dbl&gt; 1, 0, 1, 0, 1, 0, 0, 0, 1, 0, 1, 1, 0, 1, 1, 0,…
$ parameters             &lt;chr&gt; "Treatment group (T ~ LL(4, 7))", "Control grou…
$ age                    &lt;dbl&gt; 63.7, 44.8, 62.5, 58.0, 66.1, 39.5, 66.5, 54.3,…
$ linear_predictor_alpha &lt;dbl&gt; 1.386294, 1.609438, 1.386294, 1.609438, 1.38629…
$ linear_predictor_beta  &lt;dbl&gt; 1.94591, 1.94591, 1.94591, 1.94591, 1.94591, 1.…
$ u                      &lt;dbl&gt; 0.83141130, 0.70736178, 0.03092926, 0.12105442,…
$ uncured_time           &lt;dbl&gt; 5.024099, 5.671901, 2.445388, 3.766801, 2.51775…
$ cured                  &lt;int&gt; 0, 0, 0, 0, 0, 1, 1, 0, 1, 0, 0, 0, 0, 0, 1, 1,…
$ latent_time            &lt;dbl&gt; 5.024099, 5.671901, 2.445388, 3.766801, 2.51775…
$ random_censoring       &lt;dbl&gt; 6.513541, 9.204403, 3.982804, 12.196175, 8.3553…
$ censoring_time         &lt;dbl&gt; 6.000000, 6.000000, 3.982804, 6.000000, 6.00000…
$ time                   &lt;dbl&gt; 5.024099, 5.671901, 2.445388, 3.766801, 2.51775…
$ cens                   &lt;dbl&gt; 0, 0, 0, 0, 0, 1, 1, 1, 1, 0, 1, 0, 1, 0, 1, 1,…
$ event                  &lt;dbl&gt; 1, 1, 1, 1, 1, 0, 0, 0, 0, 1, 0, 1, 0, 1, 0, 0,…</code></pre>
</div>
</div>
</section>
<section id="sanity-check" class="level2">
<h2 class="anchored" data-anchor-id="sanity-check">Sanity check</h2>
<p>As a sanity check, the log-logistic mixture cure model can be fit to the simulated data using the <code>flexsurvcure</code> package to see whether we can recover the parameters used to generate data.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1"></a>simulated_data <span class="sc">%&gt;%</span> </span>
<span id="cb21-2"><a href="#cb21-2"></a>  <span class="co"># rename the treatment variable to make the printed summary nicer looking</span></span>
<span id="cb21-3"><a href="#cb21-3"></a>  <span class="fu">rename</span>(<span class="at">trt =</span> treatment) <span class="sc">%&gt;%</span> </span>
<span id="cb21-4"><a href="#cb21-4"></a>  <span class="fu">flexsurvcure</span>(</span>
<span id="cb21-5"><a href="#cb21-5"></a>    <span class="at">formula =</span> <span class="fu">Surv</span>(time, event, <span class="at">type =</span> <span class="st">"right"</span>) <span class="sc">~</span> age,</span>
<span id="cb21-6"><a href="#cb21-6"></a>    <span class="at">data =</span> .,</span>
<span id="cb21-7"><a href="#cb21-7"></a>    <span class="at">dist =</span> <span class="st">"llogis"</span>,</span>
<span id="cb21-8"><a href="#cb21-8"></a>    <span class="at">link =</span> <span class="st">"logistic"</span>,</span>
<span id="cb21-9"><a href="#cb21-9"></a>    <span class="at">anc =</span> <span class="fu">list</span>(</span>
<span id="cb21-10"><a href="#cb21-10"></a>      <span class="at">scale =</span> <span class="sc">~</span> trt,</span>
<span id="cb21-11"><a href="#cb21-11"></a>      <span class="at">shape =</span> <span class="sc">~</span> trt</span>
<span id="cb21-12"><a href="#cb21-12"></a>    ),</span>
<span id="cb21-13"><a href="#cb21-13"></a>    <span class="at">mixture =</span> <span class="cn">TRUE</span></span>
<span id="cb21-14"><a href="#cb21-14"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The code takes a minute or two to run, so the saved model can be read back in.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1"></a><span class="fu">read_rds</span>(<span class="st">"sanity-check-model.rds"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Call:
flexsurvcure(formula = Surv(time, event, type = "right") ~ age, 
    data = ., dist = "llogis", link = "logistic", mixture = TRUE, 
    anc = list(scale = ~trt, shape = ~trt))

Estimates: 
            data mean  est       L95%      U95%      se        exp(est)
theta             NA    0.98025   0.97650   0.98341        NA        NA
shape             NA    7.14335   6.97237   7.31851   0.08829        NA
scale             NA    4.98067   4.94343   5.01819   0.01907        NA
age         57.15674   -0.06809  -0.07126  -0.06492   0.00162   0.93418
shape(trt)   0.50436   -0.01890  -0.04914   0.01134   0.01543   0.98127
scale(trt)   0.50436   -0.21891  -0.22755  -0.21027   0.00441   0.80340
            L95%      U95%    
theta             NA        NA
shape             NA        NA
scale             NA        NA
age          0.93122   0.93714
shape(trt)   0.95204   1.01140
scale(trt)   0.79648   0.81037

N = 50000,  Events: 15676,  Censored: 34324
Total time at risk: 228001.9
Log-likelihood = -42997.34, df = 6
AIC = 86006.67</code></pre>
</div>
</div>
<p>The coefficients for the incidence submodel are usually on the logit scale, and the coefficients for the latency submodel are usually on the log scale. The printed output is a little confusing at first glance since the coefficients in the <code>est</code> column are either untransformed (age, shape and scale parameters in the treatment group), exponentiated (scale and shape parameters in the control group), or inverse-logit transformed (theta). It may have been better to split the printed output into two sections — one for the incidence model, and the other for latency. Similar to how <code>mgcv</code> gives separate output for the parametric and the spline effects.</p>
<p>The theta parameter is the intercept in the incidence submodel, with a true value of 4 on the logit scale, and therefore <span class="math inline">\(P[B = 1 | \text{age} = 0] = 0.982\)</span> (calling <code>plogis(4)</code> in R or calculating <span class="math inline">\(1 / (1 + \text{exp}(-4))\)</span>). The estimated value is 0.9802, or <code>qlogis(0.98025) = 3.904</code> on the logit scale. The age coefficient is estimated to be -0.068 on the logit scale with the true value set to -0.07. This corresponds to an odds ratio of <span class="math inline">\(\text{exp}(-0.06809) = 0.934\)</span>.</p>
<p>The shape parameter <span class="math inline">\(\beta\)</span> of the log-logistic distribution in the latency submodel is very close to the true value of 7. The <code>shape(trt)</code> value is very close to the true value of 0, since <span class="math inline">\(\beta\)</span> is assumed to be the same in each arm.</p>
<p>The scale parameter <span class="math inline">\(\alpha\)</span> in the control group is very close (4.98) to the true value of 5. The coefficient for <span class="math inline">\(\alpha\)</span> in the treatment group — with the true value of 4 — can be derived by either 1) multiplying the alpha in the control group by <code>exp(scale(trt))</code> (so <span class="math inline">\(4.98067 \times 0.80340 \approx 4\)</span>), or 2) by adding these up on the log scale and exponentiating the result (<span class="math inline">\(\text{exp}(\text{log}(4.98067) - 0.21891)\)</span>).</p>
</section>
<section id="comparing-arm-specific-cumulative-incidence-estimates" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="comparing-arm-specific-cumulative-incidence-estimates">Comparing arm-specific cumulative incidence estimates</h2>
<p>This post could very well end now, but I already wrote the code for this section and I don’t feel like making another post, so I’ve included just the plots here with minimal code. The full code for this section can be found <a href="https://github.com/ad1729/ad1729.github.io/blob/master/posts/simulating-survival-data-with-non-PH-and-cure/analyze-data.R">here</a>.</p>
<p>Essentially, I’m simulating data with administrative censoring at three and twelve weeks, with a constant cure fraction of 30%, and visually comparing the derived cumulative incidence curves in each of the treatment and control groups from the survivor functions estimated via 1) a <em>Kaplan-Meier</em> fit, 2) a <em>stratified cox model</em>, 3) the <em>casebase</em> sampling approach described in <a href="https://doi.org/10.2202/1557-4679.1125">this</a> paper and implemented in the <a href="https://cran.r-project.org/web/packages/casebase/index.html"><code>casebase</code> package</a><a href="#fn4" class="footnote-ref" id="fnref4" role="doc-noteref"><sup>4</sup></a>, and 4) a log-logistic mixture cure model with the treatment status as a variable in both the incidence and latency submodels.</p>
<div class="no-row-height column-margin column-container"><p><sup>4</sup>&nbsp;which I find extra attractive because it supports fitting penalized splines via the <code>mgcv</code> package</p></div><p>The following plot shows <span class="math inline">\(\text{log}(-\text{log}({\hat{S}(t)}))\)</span> vs <span class="math inline">\(\text{log}(t)\)</span> in the left panel, and <span class="math inline">\(\text{log}(\hat{S}(t) / (1 - \hat{S}(t)))\)</span> vs <span class="math inline">\(\text{log}(t)\)</span> in the right panel. The former is the log-minus-log-survival plot for assessing the proportional hazards assumption (parallel straight lines indicate a Weibull model may be a good fit), and the latter is the log-survival-odds plot for assessing the proportional odds assumption (straight parallel lines together imply a log-logistic AFT model). Chapter 7 from the third edition of the Kleinbaum and Klein book is a good reference on how to pick parametric models based on the information in these plots.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1"></a><span class="co"># very weird behaviour when seed is set to 43 here</span></span>
<span id="cb24-2"><a href="#cb24-2"></a><span class="co"># cure fraction ends up being 0 in the treatment group</span></span>
<span id="cb24-3"><a href="#cb24-3"></a><span class="co"># and 60% in the control group. Overall it's correct with value of 0.3</span></span>
<span id="cb24-4"><a href="#cb24-4"></a><span class="co"># this goes away by removing the set.seed(43) call before generating</span></span>
<span id="cb24-5"><a href="#cb24-5"></a><span class="co"># or using any other seed</span></span>
<span id="cb24-6"><a href="#cb24-6"></a><span class="fu">set.seed</span>(<span class="dv">49</span>)</span>
<span id="cb24-7"><a href="#cb24-7"></a>censored_and_cured_samples <span class="ot">&lt;-</span> loglogistic_samples <span class="sc">%&gt;%</span></span>
<span id="cb24-8"><a href="#cb24-8"></a>  <span class="fu">mutate</span>(</span>
<span id="cb24-9"><a href="#cb24-9"></a>    <span class="co"># add cure status and modify time distribution accordingly</span></span>
<span id="cb24-10"><a href="#cb24-10"></a>    <span class="at">latent =</span> time,</span>
<span id="cb24-11"><a href="#cb24-11"></a>    <span class="at">cured =</span> <span class="fu">rbinom</span>(<span class="fu">n</span>(), <span class="dv">1</span>, <span class="fl">0.3</span>),</span>
<span id="cb24-12"><a href="#cb24-12"></a>    <span class="at">time =</span> <span class="fu">ifelse</span>(cured <span class="sc">==</span> <span class="dv">1</span>, <span class="dv">10000</span>, time),</span>
<span id="cb24-13"><a href="#cb24-13"></a>    <span class="co"># add censoring indicator</span></span>
<span id="cb24-14"><a href="#cb24-14"></a>    <span class="at">time3 =</span> <span class="fu">pmin</span>(time, <span class="fl">3.0</span>),</span>
<span id="cb24-15"><a href="#cb24-15"></a>    <span class="at">cens3 =</span> <span class="fu">as.numeric</span>(time <span class="sc">&gt;</span> <span class="fl">3.0</span>),</span>
<span id="cb24-16"><a href="#cb24-16"></a>    <span class="at">event3 =</span> <span class="dv">1</span> <span class="sc">-</span> cens3,</span>
<span id="cb24-17"><a href="#cb24-17"></a>    <span class="at">time6 =</span> <span class="fu">pmin</span>(time, <span class="fl">6.0</span>),</span>
<span id="cb24-18"><a href="#cb24-18"></a>    <span class="at">cens6 =</span> <span class="fu">as.numeric</span>(time <span class="sc">&gt;</span> <span class="fl">6.0</span>),</span>
<span id="cb24-19"><a href="#cb24-19"></a>    <span class="at">event6 =</span> <span class="dv">1</span> <span class="sc">-</span> cens6,</span>
<span id="cb24-20"><a href="#cb24-20"></a>    <span class="at">time12 =</span> <span class="fu">pmin</span>(time, <span class="fl">12.0</span>),</span>
<span id="cb24-21"><a href="#cb24-21"></a>    <span class="at">cens12 =</span> <span class="fu">as.numeric</span>(time <span class="sc">&gt;</span> <span class="fl">12.0</span>),</span>
<span id="cb24-22"><a href="#cb24-22"></a>    <span class="at">event12 =</span> <span class="dv">1</span> <span class="sc">-</span> cens12,</span>
<span id="cb24-23"><a href="#cb24-23"></a>    <span class="fu">across</span>(<span class="fu">starts_with</span>(<span class="st">"event"</span>), as.integer)</span>
<span id="cb24-24"><a href="#cb24-24"></a>  )</span>
<span id="cb24-25"><a href="#cb24-25"></a></span>
<span id="cb24-26"><a href="#cb24-26"></a>twelve_weeks_data <span class="ot">&lt;-</span> censored_and_cured_samples <span class="sc">%&gt;%</span></span>
<span id="cb24-27"><a href="#cb24-27"></a>  <span class="fu">select</span>(<span class="at">group =</span> parameters, <span class="at">time =</span> time12, <span class="at">event =</span> event12)</span>
<span id="cb24-28"><a href="#cb24-28"></a></span>
<span id="cb24-29"><a href="#cb24-29"></a>three_weeks_data <span class="ot">&lt;-</span> censored_and_cured_samples <span class="sc">%&gt;%</span></span>
<span id="cb24-30"><a href="#cb24-30"></a>  <span class="fu">select</span>(<span class="at">group =</span> parameters, <span class="at">time =</span> time3, <span class="at">event =</span> event3)</span>
<span id="cb24-31"><a href="#cb24-31"></a></span>
<span id="cb24-32"><a href="#cb24-32"></a><span class="co"># plots for assessing the proportional hazards and proportional odds assumptions</span></span>
<span id="cb24-33"><a href="#cb24-33"></a>twelve_weeks_data <span class="sc">%&gt;%</span></span>
<span id="cb24-34"><a href="#cb24-34"></a>  <span class="fu">survfit2</span>(<span class="fu">Surv</span>(time, event, <span class="at">type =</span> <span class="st">"right"</span>) <span class="sc">~</span> group, <span class="at">data =</span> .) <span class="sc">%&gt;%</span></span>
<span id="cb24-35"><a href="#cb24-35"></a>  <span class="fu">tidy_survfit</span>(<span class="at">time =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">12</span>, <span class="fl">0.05</span>), <span class="at">type =</span> <span class="st">"survival"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb24-36"><a href="#cb24-36"></a>  <span class="fu">select</span>(time, strata, estimate) <span class="sc">%&gt;%</span></span>
<span id="cb24-37"><a href="#cb24-37"></a>  <span class="fu">mutate</span>(</span>
<span id="cb24-38"><a href="#cb24-38"></a>    <span class="at">lntime =</span> <span class="fu">log</span>(time),</span>
<span id="cb24-39"><a href="#cb24-39"></a>    <span class="st">`</span><span class="at">Log Minus Log Survival</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">log</span>(<span class="sc">-</span><span class="fu">log</span>(estimate)),</span>
<span id="cb24-40"><a href="#cb24-40"></a>    <span class="st">`</span><span class="at">Log Survival Odds</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">log</span>(estimate <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">-</span> estimate))</span>
<span id="cb24-41"><a href="#cb24-41"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb24-42"><a href="#cb24-42"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="fu">starts_with</span>(<span class="st">"Log "</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb24-43"><a href="#cb24-43"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> lntime, <span class="at">y =</span> value, <span class="at">color =</span> strata, <span class="at">group =</span> <span class="fu">interaction</span>(name, strata))) <span class="sc">+</span></span>
<span id="cb24-44"><a href="#cb24-44"></a>  <span class="fu">geom_step</span>() <span class="sc">+</span></span>
<span id="cb24-45"><a href="#cb24-45"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Log time"</span>, <span class="at">y =</span> <span class="st">""</span>) <span class="sc">+</span></span>
<span id="cb24-46"><a href="#cb24-46"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"gray20"</span>, <span class="st">"forestgreen"</span>)) <span class="sc">+</span></span>
<span id="cb24-47"><a href="#cb24-47"></a>  <span class="fu">coord_cartesian</span>(<span class="at">xlim =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="fl">0.5</span>, <span class="fl">2.5</span>)) <span class="sc">+</span></span>
<span id="cb24-48"><a href="#cb24-48"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"bottom"</span>, <span class="at">legend.title =</span> <span class="fu">element_blank</span>()) <span class="sc">+</span></span>
<span id="cb24-49"><a href="#cb24-49"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>name, <span class="at">scales =</span> <span class="st">"free_y"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-14-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The next figure shows the estimated curves from the different model overlaid on top of the true curve when analyzing data using the information available at twelve weeks. All the methods produce the same estimates and are nearly indistinguishable from the true curves.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1"></a><span class="fu">read_rds</span>(<span class="at">file =</span> <span class="st">"plot-data-12-weeks.rds"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb25-2"><a href="#cb25-2"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> CI_est, <span class="at">color =</span> group)) <span class="sc">+</span></span>
<span id="cb25-3"><a href="#cb25-3"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">linetype =</span> type, <span class="at">linewidth =</span> type)) <span class="sc">+</span></span>
<span id="cb25-4"><a href="#cb25-4"></a>  <span class="co"># add cure fraction line and text</span></span>
<span id="cb25-5"><a href="#cb25-5"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="fl">0.7</span>, <span class="at">color =</span> <span class="st">"gray40"</span>, <span class="at">linetype =</span> <span class="st">"solid"</span>) <span class="sc">+</span></span>
<span id="cb25-6"><a href="#cb25-6"></a>  <span class="fu">annotate</span>(<span class="at">geom =</span> <span class="st">"text"</span>, <span class="at">x =</span> <span class="fl">0.5</span>, <span class="at">y =</span> <span class="fl">0.76</span>, <span class="at">color =</span> <span class="st">"gray40"</span>,</span>
<span id="cb25-7"><a href="#cb25-7"></a>           <span class="at">label =</span> <span class="st">"Cure fraction of 70% in both groups"</span>, <span class="at">hjust =</span> <span class="st">"left"</span>) <span class="sc">+</span></span>
<span id="cb25-8"><a href="#cb25-8"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Time since product launch (in weeks)"</span>,</span>
<span id="cb25-9"><a href="#cb25-9"></a>       <span class="at">y =</span> <span class="st">"Cumulative incidence"</span>) <span class="sc">+</span></span>
<span id="cb25-10"><a href="#cb25-10"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"bottom"</span>, <span class="at">legend.title =</span> <span class="fu">element_blank</span>()) <span class="sc">+</span></span>
<span id="cb25-11"><a href="#cb25-11"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"gray20"</span>, <span class="st">"forestgreen"</span>)) <span class="sc">+</span></span>
<span id="cb25-12"><a href="#cb25-12"></a>  <span class="fu">scale_linetype_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"solid"</span>, <span class="st">"dotdash"</span>, <span class="st">"dashed"</span>, <span class="st">"dotted"</span>, <span class="st">"longdash"</span>)) <span class="sc">+</span></span>
<span id="cb25-13"><a href="#cb25-13"></a>  <span class="fu">scale_linewidth_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="fl">0.4</span>, <span class="fl">1.1</span>, <span class="fl">1.1</span>, <span class="fl">1.1</span>, <span class="fl">1.1</span>)) <span class="sc">+</span></span>
<span id="cb25-14"><a href="#cb25-14"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">12</span>, <span class="dv">1</span>)) <span class="sc">+</span></span>
<span id="cb25-15"><a href="#cb25-15"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">labels =</span> scales<span class="sc">::</span><span class="fu">label_percent</span>(), <span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="fl">0.2</span>)) <span class="sc">+</span></span>
<span id="cb25-16"><a href="#cb25-16"></a>  <span class="fu">coord_cartesian</span>(<span class="at">xlim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">12</span>), <span class="at">ylim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>)) <span class="sc">+</span></span>
<span id="cb25-17"><a href="#cb25-17"></a>  <span class="fu">guides</span>(</span>
<span id="cb25-18"><a href="#cb25-18"></a>    <span class="at">color =</span> <span class="fu">guide_legend</span>(<span class="at">nrow =</span> <span class="dv">2</span>),</span>
<span id="cb25-19"><a href="#cb25-19"></a>    <span class="at">linetype =</span> <span class="fu">guide_legend</span>(<span class="at">nrow =</span> <span class="dv">3</span>)</span>
<span id="cb25-20"><a href="#cb25-20"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-15-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The true cumulative incidence curves are scaled from <span class="math inline">\([0, 1]\)</span> to the interval <span class="math inline">\([0, 0.7]\)</span> to correspond to a cure fraction of 0.3 using the <a href="https://stats.stackexchange.com/questions/281162/scale-a-number-between-a-range">usual rescaling formula</a> for mapping <span class="math inline">\([x_{\text{min}}, x_{\text{}max}] \rightarrow [a,b]\)</span> (with <span class="math inline">\(a = 0\)</span>, <span class="math inline">\(b = 0.7\)</span>, <span class="math inline">\(x_{\text{max}} = 1\)</span>, <span class="math inline">\(x_{\text{min}} = 0\)</span>, and <span class="math inline">\(x\)</span> the probability <span class="math inline">\(P[T \le t]\)</span> among the uncured)</p>
<p><span class="math display">\[
x_{\text{normalized}} = a + (b - a) \frac{x - x_{\text{min}}}{x_{\text{max}} - x_{\text{min}}}
\]</span></p>
<p>which just leads to multiplying the CDF in each group by 0.7.</p>
<p>Doing the analysis after three weeks shows some interesting results</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1"></a>plot_data_three_weeks <span class="ot">&lt;-</span> <span class="fu">read_rds</span>(<span class="at">file =</span> <span class="st">"plot-data-3-weeks.rds"</span>)</span>
<span id="cb26-2"><a href="#cb26-2"></a></span>
<span id="cb26-3"><a href="#cb26-3"></a>plot_data_three_weeks <span class="sc">%&gt;%</span></span>
<span id="cb26-4"><a href="#cb26-4"></a>  <span class="fu">filter</span>(time <span class="sc">&lt;=</span> <span class="dv">3</span>) <span class="sc">%&gt;%</span></span>
<span id="cb26-5"><a href="#cb26-5"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> CI_est, <span class="at">color =</span> group)) <span class="sc">+</span></span>
<span id="cb26-6"><a href="#cb26-6"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">linetype =</span> type, <span class="at">linewidth =</span> type)) <span class="sc">+</span></span>
<span id="cb26-7"><a href="#cb26-7"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Time since product launch (in weeks)"</span>,</span>
<span id="cb26-8"><a href="#cb26-8"></a>       <span class="at">y =</span> <span class="st">"Cumulative incidence"</span>) <span class="sc">+</span></span>
<span id="cb26-9"><a href="#cb26-9"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"bottom"</span>, <span class="at">legend.title =</span> <span class="fu">element_blank</span>()) <span class="sc">+</span></span>
<span id="cb26-10"><a href="#cb26-10"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"gray20"</span>, <span class="st">"forestgreen"</span>)) <span class="sc">+</span></span>
<span id="cb26-11"><a href="#cb26-11"></a>  <span class="fu">scale_linetype_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"solid"</span>, <span class="st">"dotdash"</span>, <span class="st">"dashed"</span>, <span class="st">"dotted"</span>, <span class="st">"longdash"</span>)) <span class="sc">+</span></span>
<span id="cb26-12"><a href="#cb26-12"></a>  <span class="fu">scale_linewidth_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="fl">0.4</span>, <span class="fl">1.1</span>, <span class="fl">1.1</span>, <span class="fl">1.1</span>, <span class="fl">1.1</span>)) <span class="sc">+</span></span>
<span id="cb26-13"><a href="#cb26-13"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">3</span>, <span class="dv">1</span>)) <span class="sc">+</span></span>
<span id="cb26-14"><a href="#cb26-14"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">labels =</span> scales<span class="sc">::</span><span class="fu">label_percent</span>(), <span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="fl">0.1</span>, <span class="fl">0.02</span>)) <span class="sc">+</span></span>
<span id="cb26-15"><a href="#cb26-15"></a>  <span class="fu">guides</span>(</span>
<span id="cb26-16"><a href="#cb26-16"></a>    <span class="at">color =</span> <span class="fu">guide_legend</span>(<span class="at">nrow =</span> <span class="dv">2</span>),</span>
<span id="cb26-17"><a href="#cb26-17"></a>    <span class="at">linetype =</span> <span class="fu">guide_legend</span>(<span class="at">nrow =</span> <span class="dv">3</span>)</span>
<span id="cb26-18"><a href="#cb26-18"></a>  ) <span class="sc">+</span> </span>
<span id="cb26-19"><a href="#cb26-19"></a>  <span class="fu">coord_cartesian</span>(<span class="at">xlim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">3</span>), <span class="at">ylim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">0.1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-16-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>All the curves are close. Facetting by estimator and plotting the pointwise confidence bands for week 2 shows that the mixture cure model runs into some difficulties</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1"></a>plot_data_three_weeks <span class="sc">%&gt;%</span></span>
<span id="cb27-2"><a href="#cb27-2"></a>  <span class="fu">filter</span>(time <span class="sc">&lt;=</span> <span class="dv">3</span>, type <span class="sc">!=</span> <span class="st">"Truth"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb27-3"><a href="#cb27-3"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> CI_est)) <span class="sc">+</span></span>
<span id="cb27-4"><a href="#cb27-4"></a>  <span class="co"># plot the true line on each panel</span></span>
<span id="cb27-5"><a href="#cb27-5"></a>  <span class="fu">geom_line</span>(</span>
<span id="cb27-6"><a href="#cb27-6"></a>    <span class="at">data =</span> {</span>
<span id="cb27-7"><a href="#cb27-7"></a>      plot_data_three_weeks <span class="sc">%&gt;%</span></span>
<span id="cb27-8"><a href="#cb27-8"></a>        <span class="fu">filter</span>(type <span class="sc">==</span> <span class="st">"Truth"</span>, time <span class="sc">&lt;=</span> <span class="dv">3</span>) <span class="sc">%&gt;%</span></span>
<span id="cb27-9"><a href="#cb27-9"></a>        <span class="fu">select</span>(<span class="sc">-</span>type)</span>
<span id="cb27-10"><a href="#cb27-10"></a>    },</span>
<span id="cb27-11"><a href="#cb27-11"></a>    <span class="at">inherit.aes =</span> <span class="cn">FALSE</span>,</span>
<span id="cb27-12"><a href="#cb27-12"></a>    <span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> CI_est, <span class="at">group =</span> group, <span class="at">color =</span> group),</span>
<span id="cb27-13"><a href="#cb27-13"></a>    <span class="at">linetype =</span> <span class="st">"solid"</span>, <span class="at">linewidth =</span> <span class="dv">1</span></span>
<span id="cb27-14"><a href="#cb27-14"></a>  ) <span class="sc">+</span></span>
<span id="cb27-15"><a href="#cb27-15"></a>  <span class="co"># plot estimated curves and their confidence intervals</span></span>
<span id="cb27-16"><a href="#cb27-16"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">color =</span> group), <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">linewidth =</span> <span class="fl">1.1</span>) <span class="sc">+</span></span>
<span id="cb27-17"><a href="#cb27-17"></a>  <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> CI_lcl, <span class="at">ymax =</span> CI_ucl, </span>
<span id="cb27-18"><a href="#cb27-18"></a>                  <span class="at">color =</span> group, <span class="at">fill =</span> group), <span class="at">alpha =</span> <span class="fl">0.3</span>) <span class="sc">+</span></span>
<span id="cb27-19"><a href="#cb27-19"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Time since product launch (in weeks)"</span>,</span>
<span id="cb27-20"><a href="#cb27-20"></a>       <span class="at">y =</span> <span class="st">"Cumulative incidence"</span>) <span class="sc">+</span></span>
<span id="cb27-21"><a href="#cb27-21"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"bottom"</span>, <span class="at">legend.title =</span> <span class="fu">element_blank</span>()) <span class="sc">+</span></span>
<span id="cb27-22"><a href="#cb27-22"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"gray20"</span>, <span class="st">"forestgreen"</span>)) <span class="sc">+</span></span>
<span id="cb27-23"><a href="#cb27-23"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"gray20"</span>, <span class="st">"forestgreen"</span>)) <span class="sc">+</span></span>
<span id="cb27-24"><a href="#cb27-24"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">2</span>, <span class="dv">3</span>, <span class="fl">0.2</span>)) <span class="sc">+</span></span>
<span id="cb27-25"><a href="#cb27-25"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">labels =</span> scales<span class="sc">::</span><span class="fu">label_percent</span>(), </span>
<span id="cb27-26"><a href="#cb27-26"></a>                     <span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="fl">0.1</span>, <span class="fl">0.02</span>)) <span class="sc">+</span></span>
<span id="cb27-27"><a href="#cb27-27"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>type) <span class="sc">+</span></span>
<span id="cb27-28"><a href="#cb27-28"></a>  <span class="fu">coord_cartesian</span>(<span class="at">xlim =</span> <span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">3</span>), <span class="at">ylim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">0.1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-17-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>In this case, based on the lack of plateauing of the KM fit at three weeks, assuming a cure model would not be justifiable, so one of the other three methods used here are probably better for estimating the CIC. At twelve weeks, the KM (or the CIC) curves have plateaued so a cure model might be a decent option, and the parameters of the mixture cure model can be identified.</p>
<p>Finally, I’m going to end this post with an interesting quote I came across in the Hanley and Miettinen paper from the inventor of the highly popular Cox model preferring to use a parametric model over the semi-parametric Cox model</p>
<blockquote class="blockquote">
<p>Particularly notable are Cox’s own reflections (Reid, 1994) on the uses of his model:<br>
<br>
<strong>Reid:</strong> How do you feel about the cottage industry that’s grown up around it [the Cox model]?</p>
<p><strong>Cox:</strong> Don’t know, really. In the light of some of the further results one knows since, I think I would normally want to tackle problems parametrically, so I would take the underlying hazard to be a Weibull or something. I’m not keen on nonparametric formulations usually.</p>
<p><strong>Reid:</strong> So if you had a set of censored survival data today, you might rather fit a parametric model, even though there was a feeling among the medical statisticians that that wasn’t quite right.</p>
<p><strong>Cox:</strong> That’s right, but since then various people have shown that the answers are very insensitive to the parametric formulation of the underlying distribution [see, e.g., Cox and Oakes, Analysis of Survival Data, Chapter 8.5]. And if you want to do things like predict the outcome for a particular patient, it’s much more convenient to do that parametrically.</p>
</blockquote>
</section>
<section id="references" class="level2">
<h2 class="anchored" data-anchor-id="references">References</h2>
<ul>
<li><p>Bender, R., Augustin, T. and Blettner, M. (2005), Generating survival times to simulate Cox proportional hazards models. Statist. Med., 24: 1713-1723. <a href="https://doi.org/10.1002/sim.2059" class="uri">https://doi.org/10.1002/sim.2059</a></p></li>
<li><p>Crowther, M.J. and Lambert, P.C. (2013), Simulating biologically plausible complex survival data. Statist. Med., 32: 4118-4134. <a href="https://doi.org/10.1002/sim.5823" class="uri">https://doi.org/10.1002/sim.5823</a></p></li>
<li><p>Al-Shomrani, A.A., Shawky, A.I., Arif, O.H. <em>et al.</em> Log-logistic distribution for survival data analysis using MCMC. <em>SpringerPlus</em> <strong>5</strong>, 1774 (2016). <a href="https://doi.org/10.1186/s40064-016-3476-7" class="uri">https://doi.org/10.1186/s40064-016-3476-7</a></p></li>
<li><p>Lambert, P. C. (2007). Modeling of the Cure Fraction in Survival Studies. <em>The Stata Journal</em>, <em>7</em>(3), 351-375. <a href="https://doi.org/10.1177/1536867X0700700304" class="uri">https://doi.org/10.1177/1536867X0700700304</a></p></li>
<li><p>Amico, M. and Van Keilegom, I. (2018). Cure Models in Survival Analysis. <em>Annual Review of Statistics and Its Application,</em> Vol. 5:311-342.<br>
<a href="https://doi.org/10.1146/annurev-statistics-031017-100101" class="uri">https://doi.org/10.1146/annurev-statistics-031017-100101</a></p></li>
<li><p>Legrand, C. and Bertrand, A. (2019). Cure Models in Oncology Clinical Trials. (Seems to be a book chapter from <a href="https://www.taylorfrancis.com/chapters/edit/10.1201/9781315112084-22/cure-models-cancer-clinical-trials-catherine-legrand-aur%C3%A9lie-bertrand">this book</a>. Non-paywalled link <a href="https://dial.uclouvain.be/pr/boreal/object/boreal%3A220045/datastream/PDF_02/view">here</a>.)</p></li>
<li><p>Kleinbaum, D.G. and Klein, M. (2012) Survival Analysis: A Self-Learning Text. 3rd Edition, Springer, New York.<a href="#0">https://doi.org/10.1007/978-1-4419-6646-9</a></p></li>
<li><p>Hanley, J. &amp; Miettinen, O. (2009). Fitting Smooth-in-Time Prognostic Risk Functions via Logistic Regression. <em>The International Journal of Biostatistics</em>, <em>5</em>(1). <a href="https://doi.org/10.2202/1557-4679.1125" class="uri">https://doi.org/10.2202/1557-4679.1125</a></p></li>
</ul>


<!-- -->

</section>


</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
    const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
    const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
    let newTheme = '';
    if(darkModeDefault) {
      newTheme = isAlternate ? baseTheme : alternateTheme;
    } else {
      newTheme = isAlternate ? alternateTheme : baseTheme;
    }
    const changeGiscusTheme = () => {
      // From: https://github.com/giscus/giscus/issues/336
      const sendMessage = (message) => {
        const iframe = document.querySelector('iframe.giscus-frame');
        if (!iframe) return;
        iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
      }
      sendMessage({
        setConfig: {
          theme: newTheme
        }
      });
    }
    const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
    if (isGiscussLoaded) {
      changeGiscusTheme();
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  const darkModeDefault = false;
  let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
    toggleGiscusIfUsed(toAlternate, darkModeDefault);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/akshat\.blog");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
          // target, if specified
          link.setAttribute("target", "_blank");
          if (link.getAttribute("rel") === null) {
            link.setAttribute("rel", "noopener");
          }
          // default icon
          link.classList.add("external");
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<script src="https://giscus.app/client.js" data-repo="ad1729/ad1729.github.io" data-repo-id="R_kgDOHvxVCQ" data-category="Announcements" data-category-id="DIC_kwDOHvxVCc4CdwZG" data-mapping="title" data-reactions-enabled="0" data-emit-metadata="0" data-input-position="top" data-theme="light" data-lang="en" crossorigin="anonymous" async="">
</script>
<input type="hidden" id="giscus-base-theme" value="light">
<input type="hidden" id="giscus-alt-theme" value="dark_dimmed"><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb28" data-shortcodes="false"><pre class="sourceCode numberSource markdown number-lines code-with-copy"><code class="sourceCode markdown"><span id="cb28-1"><a href="#cb28-1"></a><span class="co">---</span></span>
<span id="cb28-2"><a href="#cb28-2"></a><span class="an">title:</span><span class="co"> "Simulating data from a time-to-event experiment with non-proportional hazards, random censoring, and cure"</span></span>
<span id="cb28-3"><a href="#cb28-3"></a><span class="an">date:</span><span class="co"> "2024-09-22"</span></span>
<span id="cb28-4"><a href="#cb28-4"></a><span class="co">#date-modified: "2024-09-22"</span></span>
<span id="cb28-5"><a href="#cb28-5"></a><span class="an">categories:</span><span class="co"> [Advertising, Experimentation, R, Simulation, Time-to-event]</span></span>
<span id="cb28-6"><a href="#cb28-6"></a><span class="an">image:</span><span class="co"> "post-image.png"</span></span>
<span id="cb28-7"><a href="#cb28-7"></a><span class="an">footnotes-hover:</span><span class="co"> true</span></span>
<span id="cb28-8"><a href="#cb28-8"></a><span class="an">code-fold:</span><span class="co"> false</span></span>
<span id="cb28-9"><a href="#cb28-9"></a><span class="co">---</span></span>
<span id="cb28-10"><a href="#cb28-10"></a></span>
<span id="cb28-11"><a href="#cb28-11"></a>This post is about simulating data from a log-logistic accelerated failure time mixture cure model with censoring. It also visually compares the estimated cumulative incidence curves obtained from several time-to-event estimators on a large simulated dataset.</span>
<span id="cb28-12"><a href="#cb28-12"></a></span>
<span id="cb28-13"><a href="#cb28-13"></a>It's been quite a while since I've worked with time-to-event data and models. Also known as *survival analysis*, it is ideally suited for situations where the interest is not only in predicting *whether* an event will occur, but *how long it will take for it to occur.*</span>
<span id="cb28-14"><a href="#cb28-14"></a></span>
<span id="cb28-15"><a href="#cb28-15"></a>So I'm writing this post to reacquaint myself with some of the key concepts — and to learn some new things along the way — by simulating and analyzing data from a fictitious experiment motivated by a real experiment I worked on many moons ago.</span>
<span id="cb28-16"><a href="#cb28-16"></a></span>
<span id="cb28-17"><a href="#cb28-17"></a>Before writing any code, the following packages are attached:</span>
<span id="cb28-18"><a href="#cb28-18"></a></span>
<span id="cb28-21"><a href="#cb28-21"></a><span class="in">```{r}</span></span>
<span id="cb28-22"><a href="#cb28-22"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb28-23"><a href="#cb28-23"></a><span class="fu">library</span>(flexsurvcure)</span>
<span id="cb28-24"><a href="#cb28-24"></a><span class="fu">library</span>(ggsurvfit)</span>
<span id="cb28-25"><a href="#cb28-25"></a></span>
<span id="cb28-26"><a href="#cb28-26"></a><span class="fu">theme_set</span>(<span class="fu">theme_bw</span>())</span>
<span id="cb28-27"><a href="#cb28-27"></a><span class="in">```</span></span>
<span id="cb28-28"><a href="#cb28-28"></a></span>
<span id="cb28-29"><a href="#cb28-29"></a>Suppose a marketing manager is interested in the time it takes for an upgraded product to be adopted after launch among users of the previous version of the product. This rate-of-upgrade could be potentially hastened via a marketing campaign, which can be assumed to have a *transient response*<span class="ot">[^1]</span> — that is, the impact of this campaign decreases with time once the campaign has concluded.</span>
<span id="cb28-30"><a href="#cb28-30"></a></span>
<span id="cb28-31"><a href="#cb28-31"></a><span class="ot">[^1]: </span>Not sure what this is called in marketing jargon but this is how it's called in <span class="co">[</span><span class="ot">engineering</span><span class="co">](https://en.wikipedia.org/wiki/Transient_response)</span></span>
<span id="cb28-32"><a href="#cb28-32"></a></span>
<span id="cb28-33"><a href="#cb28-33"></a><span class="fu">## Key concepts</span></span>
<span id="cb28-34"><a href="#cb28-34"></a></span>
<span id="cb28-35"><a href="#cb28-35"></a>One of the key objects in survival analysis is the <span class="co">[</span><span class="ot">*hazard function*</span><span class="co">](https://en.wikipedia.org/wiki/Failure_rate)</span> ($h(t)$), i.e., the rate at which the event of interest (e.g., product purchase) occurs as a function of time. Mathematically, it is expressed for *continuous-time* models as</span>
<span id="cb28-36"><a href="#cb28-36"></a></span>
<span id="cb28-37"><a href="#cb28-37"></a>$$</span>
<span id="cb28-38"><a href="#cb28-38"></a>h(t) = </span>
<span id="cb28-39"><a href="#cb28-39"></a>\lim_{\Delta t \to 0} \frac{P(t \le T \lt t + \Delta t | T \ge t)}{\Delta t}</span>
<span id="cb28-40"><a href="#cb28-40"></a>$$</span>
<span id="cb28-41"><a href="#cb28-41"></a></span>
<span id="cb28-42"><a href="#cb28-42"></a>where $T$ indicates the event time of interest which varies from individual to individual, $t$ is a specific value of time, and $\Delta t$ is some very small increment in time. This event rate function cannot be interpreted as a probability but only as a rate, since it can have values larger than 1.</span>
<span id="cb28-43"><a href="#cb28-43"></a></span>
<span id="cb28-44"><a href="#cb28-44"></a>In case of *discrete-time* models, the hazard rate can be interpreted as the (conditional) probability $P(T = t | T \ge t)$.</span>
<span id="cb28-45"><a href="#cb28-45"></a></span>
<span id="cb28-46"><a href="#cb28-46"></a>For our experiment, suppose the hazards in the treatment and control groups look like this:</span>
<span id="cb28-47"><a href="#cb28-47"></a></span>
<span id="cb28-50"><a href="#cb28-50"></a><span class="in">```{r}</span></span>
<span id="cb28-51"><a href="#cb28-51"></a><span class="co">#| code-fold: true</span></span>
<span id="cb28-52"><a href="#cb28-52"></a></span>
<span id="cb28-53"><a href="#cb28-53"></a>hazard_function_loglogistic <span class="ot">&lt;-</span> <span class="cf">function</span>(alpha, beta, </span>
<span id="cb28-54"><a href="#cb28-54"></a>                               <span class="at">min_t =</span> <span class="dv">0</span>, </span>
<span id="cb28-55"><a href="#cb28-55"></a>                               <span class="at">max_t =</span> <span class="dv">24</span>, </span>
<span id="cb28-56"><a href="#cb28-56"></a>                               <span class="at">step_t =</span> <span class="fl">0.1</span>) {</span>
<span id="cb28-57"><a href="#cb28-57"></a>  </span>
<span id="cb28-58"><a href="#cb28-58"></a>  time <span class="ot">&lt;-</span> <span class="fu">seq</span>(min_t, max_t, step_t)</span>
<span id="cb28-59"><a href="#cb28-59"></a>  numerator <span class="ot">&lt;-</span> (beta <span class="sc">/</span> alpha) <span class="sc">*</span> ((time <span class="sc">/</span> alpha) <span class="sc">^</span> (beta <span class="sc">-</span> <span class="dv">1</span>))</span>
<span id="cb28-60"><a href="#cb28-60"></a>  denominator <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">+</span> ((time <span class="sc">/</span> alpha) <span class="sc">^</span> beta)</span>
<span id="cb28-61"><a href="#cb28-61"></a></span>
<span id="cb28-62"><a href="#cb28-62"></a>  <span class="fu">tibble</span>(</span>
<span id="cb28-63"><a href="#cb28-63"></a>    <span class="at">alpha =</span> alpha,</span>
<span id="cb28-64"><a href="#cb28-64"></a>    <span class="at">beta =</span> beta,</span>
<span id="cb28-65"><a href="#cb28-65"></a>    <span class="at">parameters =</span> <span class="fu">paste0</span>(<span class="st">"LL("</span>, alpha, </span>
<span id="cb28-66"><a href="#cb28-66"></a>                        <span class="st">", "</span>, beta, <span class="st">")"</span>),</span>
<span id="cb28-67"><a href="#cb28-67"></a>    <span class="at">time =</span> time,</span>
<span id="cb28-68"><a href="#cb28-68"></a>    <span class="at">hazard =</span> numerator <span class="sc">/</span> denominator</span>
<span id="cb28-69"><a href="#cb28-69"></a>  )</span>
<span id="cb28-70"><a href="#cb28-70"></a>}</span>
<span id="cb28-71"><a href="#cb28-71"></a></span>
<span id="cb28-72"><a href="#cb28-72"></a>loglogistic_attributes <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(</span>
<span id="cb28-73"><a href="#cb28-73"></a>  <span class="fu">hazard_function_loglogistic</span>(<span class="at">alpha =</span> <span class="dv">4</span>, <span class="at">beta =</span> <span class="dv">7</span>),</span>
<span id="cb28-74"><a href="#cb28-74"></a>  <span class="fu">hazard_function_loglogistic</span>(<span class="at">alpha =</span> <span class="dv">5</span>, <span class="at">beta =</span> <span class="dv">7</span>)</span>
<span id="cb28-75"><a href="#cb28-75"></a>) <span class="sc">%&gt;%</span> </span>
<span id="cb28-76"><a href="#cb28-76"></a>  <span class="fu">mutate</span>(</span>
<span id="cb28-77"><a href="#cb28-77"></a>    <span class="at">parameters =</span> <span class="fu">case_when</span>(</span>
<span id="cb28-78"><a href="#cb28-78"></a>      alpha <span class="sc">==</span> <span class="dv">4</span> <span class="sc">~</span> <span class="st">"Treatment group (T ~ LL(4, 7))"</span>,</span>
<span id="cb28-79"><a href="#cb28-79"></a>      alpha <span class="sc">==</span> <span class="dv">5</span> <span class="sc">~</span> <span class="st">"Control group (T ~ LL(5, 7))"</span></span>
<span id="cb28-80"><a href="#cb28-80"></a>    )</span>
<span id="cb28-81"><a href="#cb28-81"></a>  ) </span>
<span id="cb28-82"><a href="#cb28-82"></a></span>
<span id="cb28-83"><a href="#cb28-83"></a>loglogistic_attributes <span class="sc">%&gt;%</span> </span>
<span id="cb28-84"><a href="#cb28-84"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> hazard, <span class="at">group =</span> parameters, <span class="at">color =</span> parameters)) <span class="sc">+</span></span>
<span id="cb28-85"><a href="#cb28-85"></a>  <span class="fu">geom_line</span>(<span class="at">linewidth =</span> <span class="fl">1.1</span>) <span class="sc">+</span></span>
<span id="cb28-86"><a href="#cb28-86"></a>  <span class="co"># campaign end date</span></span>
<span id="cb28-87"><a href="#cb28-87"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="dv">6</span>, <span class="at">linetype =</span> <span class="st">"dotted"</span>, <span class="at">color =</span> <span class="st">"gray40"</span>) <span class="sc">+</span> </span>
<span id="cb28-88"><a href="#cb28-88"></a>  <span class="fu">annotate</span>(<span class="at">geom =</span> <span class="st">"text"</span>, <span class="at">x =</span> <span class="fl">6.2</span>, <span class="at">y =</span> <span class="fl">0.6</span>, <span class="at">color =</span> <span class="st">"gray40"</span>,</span>
<span id="cb28-89"><a href="#cb28-89"></a>           <span class="at">label =</span> <span class="st">"Campaign</span><span class="sc">\n</span><span class="st">ends after</span><span class="sc">\n</span><span class="st">6 weeks"</span>, <span class="at">hjust =</span> <span class="st">"left"</span>) <span class="sc">+</span> </span>
<span id="cb28-90"><a href="#cb28-90"></a>  <span class="co"># impact of treatment disappears by 2.5 months</span></span>
<span id="cb28-91"><a href="#cb28-91"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="dv">10</span>, <span class="at">linetype =</span> <span class="st">"dotted"</span>, <span class="at">color =</span> <span class="st">"gray40"</span>) <span class="sc">+</span> </span>
<span id="cb28-92"><a href="#cb28-92"></a>  <span class="fu">annotate</span>(<span class="at">geom =</span> <span class="st">"text"</span>, <span class="at">x =</span> <span class="fl">9.8</span>, <span class="at">y =</span> <span class="fl">0.1</span>, <span class="at">color =</span> <span class="st">"gray40"</span>,</span>
<span id="cb28-93"><a href="#cb28-93"></a>           <span class="at">label =</span> <span class="st">"Impact of</span><span class="sc">\n</span><span class="st">treatment</span><span class="sc">\n</span><span class="st">dies down"</span>, <span class="at">hjust =</span> <span class="st">"right"</span>) <span class="sc">+</span> </span>
<span id="cb28-94"><a href="#cb28-94"></a>  <span class="co"># analysis date (right-censoring at 3 months)</span></span>
<span id="cb28-95"><a href="#cb28-95"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="dv">12</span>, <span class="at">linetype =</span> <span class="st">"dotted"</span>, <span class="at">color =</span> <span class="st">"gray40"</span>) <span class="sc">+</span> </span>
<span id="cb28-96"><a href="#cb28-96"></a>  <span class="fu">annotate</span>(<span class="at">geom =</span> <span class="st">"text"</span>, <span class="at">x =</span> <span class="fl">12.2</span>, <span class="at">y =</span> <span class="fl">0.1</span>, <span class="at">color =</span> <span class="st">"gray40"</span>,</span>
<span id="cb28-97"><a href="#cb28-97"></a>           <span class="at">label =</span> glue<span class="sc">::</span><span class="fu">glue</span>(<span class="st">"Cut-off date for analysis</span><span class="sc">\n</span><span class="st">"</span>, </span>
<span id="cb28-98"><a href="#cb28-98"></a>                              <span class="st">"(administrative right-censoring "</span>, </span>
<span id="cb28-99"><a href="#cb28-99"></a>                              <span class="st">"at 3 months)"</span>), </span>
<span id="cb28-100"><a href="#cb28-100"></a>           <span class="at">hjust =</span> <span class="st">"left"</span>) <span class="sc">+</span> </span>
<span id="cb28-101"><a href="#cb28-101"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"gray20"</span>, <span class="st">"forestgreen"</span>)) <span class="sc">+</span></span>
<span id="cb28-102"><a href="#cb28-102"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">24</span>, <span class="dv">4</span>)) <span class="sc">+</span></span>
<span id="cb28-103"><a href="#cb28-103"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="fl">1.2</span>, <span class="fl">0.2</span>)) <span class="sc">+</span> </span>
<span id="cb28-104"><a href="#cb28-104"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Time since product launch (in weeks)"</span>, <span class="at">y =</span> <span class="st">"Hazard rate"</span>) <span class="sc">+</span></span>
<span id="cb28-105"><a href="#cb28-105"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"bottom"</span>, <span class="at">legend.title =</span> <span class="fu">element_blank</span>())</span>
<span id="cb28-106"><a href="#cb28-106"></a><span class="in">```</span></span>
<span id="cb28-107"><a href="#cb28-107"></a></span>
<span id="cb28-108"><a href="#cb28-108"></a>These hazard functions can be expressed mathematically as\</span>
<span id="cb28-109"><a href="#cb28-109"></a>$$</span>
<span id="cb28-110"><a href="#cb28-110"></a>h(t; \alpha, \beta) = \frac{(\beta/\alpha) (t / \alpha)^{\beta - 1}}{1 + (t / \alpha)^\beta}</span>
<span id="cb28-111"><a href="#cb28-111"></a>$$</span>
<span id="cb28-112"><a href="#cb28-112"></a></span>
<span id="cb28-113"><a href="#cb28-113"></a>and correspond to a <span class="co">[</span><span class="ot">*log-logistic distribution*</span><span class="co">](https://en.wikipedia.org/wiki/Log-logistic_distribution)</span> (abbreviated as $\text{LL}(\alpha, \beta)$) for the event times with *scale* parameter $\alpha = 4$ for the treatment group, $\alpha = 5$ for the control group, and shape parameter $\beta = 7$ identical in both groups.</span>
<span id="cb28-114"><a href="#cb28-114"></a></span>
<span id="cb28-115"><a href="#cb28-115"></a>The motivation for picking the $\text{LL}(\alpha, \beta)$ model for this experiment is that it's a well known example of an <span class="co">[</span><span class="ot">*accelerated failure time (AFT) model*</span><span class="co">](https://en.wikipedia.org/wiki/Accelerated_failure_time_model)</span>. The impact of treatment is assumed to be positive and transient, where the treatment "accelerates" the event process compared to the control group, with this "accelerating" treatment group peak occurring before the peak in the control group. The hazard function in the treatment group tapers off after some time (8 weeks in this case). The non-monotonic nature — i.e., of the function first increasing and then decreasing with time — can refer to the time it takes for the information about the new product to spread through the population.</span>
<span id="cb28-116"><a href="#cb28-116"></a></span>
<span id="cb28-117"><a href="#cb28-117"></a>The AFT model can be contrasted with the <span class="co">[</span><span class="ot">*proportional hazards (PH) model*</span><span class="co">](https://en.wikipedia.org/wiki/Proportional_hazards_model)</span>, where the hazard rates for the two groups are assumed to be proportional over time. The <span class="co">[</span><span class="ot">*Weibull distribution*</span><span class="co">](https://en.wikipedia.org/wiki/Weibull_distribution)</span> is a prominent example, although it can be parameterized as an AFT model as well. Compared to the log-logistic distribution, it has a monotonic hazard function</span>
<span id="cb28-118"><a href="#cb28-118"></a></span>
<span id="cb28-119"><a href="#cb28-119"></a>$$</span>
<span id="cb28-120"><a href="#cb28-120"></a>h(t; \alpha, \beta) = \frac{\beta}{\alpha} \Bigg(\frac{x}{\alpha}\Bigg) ^ {\beta - 1}</span>
<span id="cb28-121"><a href="#cb28-121"></a>$$</span>
<span id="cb28-122"><a href="#cb28-122"></a></span>
<span id="cb28-123"><a href="#cb28-123"></a>with shape parameter $\beta$, and scale parameter $\alpha$, so is not suited for settings where the hazard is expected to go up and then down (or other non-monotonic shapes).</span>
<span id="cb28-124"><a href="#cb28-124"></a></span>
<span id="cb28-125"><a href="#cb28-125"></a>The hazard rate is a bit hard to interpret due to the fact that 1) it's a conditional measure, 2) is a rate rather than a probability (so can have values <span class="sc">\&gt;</span> 1), and 3) depends on the chosen unit of time.</span>
<span id="cb28-126"><a href="#cb28-126"></a></span>
<span id="cb28-127"><a href="#cb28-127"></a>A related quantity known as the *survivor function* (aka survival curve) is the marginal probability of being event-free ("surviving") beyond time $t$. Mathematically,</span>
<span id="cb28-128"><a href="#cb28-128"></a></span>
<span id="cb28-129"><a href="#cb28-129"></a>$$</span>
<span id="cb28-130"><a href="#cb28-130"></a>S(t) = P<span class="co">[</span><span class="ot">T &gt; t</span><span class="co">]</span> = \text{exp} \Bigg<span class="co">[</span><span class="ot"> - \int_0^t h(u) du \Bigg</span><span class="co">]</span></span>
<span id="cb28-131"><a href="#cb28-131"></a>$$</span>
<span id="cb28-132"><a href="#cb28-132"></a></span>
<span id="cb28-133"><a href="#cb28-133"></a>where $h(u)$ is the hazard function (defined above).</span>
<span id="cb28-134"><a href="#cb28-134"></a></span>
<span id="cb28-135"><a href="#cb28-135"></a>When the outcome is death due to disease (in healthcare), or machine failure (in engineering), it makes sense to look at factors (or treatments) that prolong survival. In the scenario where the event occurring faster is seen as positive, the survivor function can be flipped to get the *cumulative incidence curve (CIC)*</span>
<span id="cb28-136"><a href="#cb28-136"></a></span>
<span id="cb28-137"><a href="#cb28-137"></a>$$</span>
<span id="cb28-138"><a href="#cb28-138"></a>P<span class="co">[</span><span class="ot">T \le t</span><span class="co">]</span> = F(t) = 1 - S(t)</span>
<span id="cb28-139"><a href="#cb28-139"></a>$$</span>
<span id="cb28-140"><a href="#cb28-140"></a></span>
<span id="cb28-141"><a href="#cb28-141"></a>where the curve traces the probability of experiencing the event before some time $t$, and $F(t)$ is the <span class="co">[</span><span class="ot">CDF</span><span class="co">](https://en.wikipedia.org/wiki/Cumulative_distribution_function)</span> of the event times. The cumulative incidence curve corresponding to $\text{LL}(\alpha, \beta)$ is given by $F(t) = <span class="co">[</span><span class="ot"> 1 + (t / \alpha)^ {-\beta}</span><span class="co">]</span> ^ {-1}$ (with the survivor function $S(t) = <span class="co">[</span><span class="ot">1 + (t / \alpha)^ {\beta}</span><span class="co">]</span> ^ {-1}$ — notice the sign difference for $\beta$)</span>
<span id="cb28-142"><a href="#cb28-142"></a></span>
<span id="cb28-145"><a href="#cb28-145"></a><span class="in">```{r}</span></span>
<span id="cb28-146"><a href="#cb28-146"></a><span class="co">#| code-fold: true</span></span>
<span id="cb28-147"><a href="#cb28-147"></a></span>
<span id="cb28-148"><a href="#cb28-148"></a>survivor_loglogistic <span class="ot">&lt;-</span> <span class="cf">function</span>(alpha, beta, time) {</span>
<span id="cb28-149"><a href="#cb28-149"></a>  <span class="dv">1</span> <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">+</span> ((time <span class="sc">/</span> alpha) <span class="sc">^</span> beta))</span>
<span id="cb28-150"><a href="#cb28-150"></a>}</span>
<span id="cb28-151"><a href="#cb28-151"></a></span>
<span id="cb28-152"><a href="#cb28-152"></a>loglogistic_attributes <span class="ot">&lt;-</span> loglogistic_attributes <span class="sc">%&gt;%</span> </span>
<span id="cb28-153"><a href="#cb28-153"></a>  <span class="fu">mutate</span>(</span>
<span id="cb28-154"><a href="#cb28-154"></a>    <span class="at">survival =</span> <span class="fu">survivor_loglogistic</span>(alpha, beta, time),</span>
<span id="cb28-155"><a href="#cb28-155"></a>    <span class="at">cdf =</span> <span class="dv">1</span> <span class="sc">-</span> survival</span>
<span id="cb28-156"><a href="#cb28-156"></a>  ) </span>
<span id="cb28-157"><a href="#cb28-157"></a></span>
<span id="cb28-158"><a href="#cb28-158"></a>cumulative_incidence_plot <span class="ot">&lt;-</span> loglogistic_attributes <span class="sc">%&gt;%</span> </span>
<span id="cb28-159"><a href="#cb28-159"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> cdf, <span class="at">group =</span> parameters, <span class="at">color =</span> parameters)) <span class="sc">+</span> </span>
<span id="cb28-160"><a href="#cb28-160"></a>  <span class="fu">geom_line</span>(<span class="at">linewidth =</span> <span class="fl">1.1</span>) <span class="sc">+</span> </span>
<span id="cb28-161"><a href="#cb28-161"></a>  <span class="co"># campaign end date</span></span>
<span id="cb28-162"><a href="#cb28-162"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="dv">6</span>, <span class="at">linetype =</span> <span class="st">"dotted"</span>, <span class="at">color =</span> <span class="st">"gray40"</span>) <span class="sc">+</span> </span>
<span id="cb28-163"><a href="#cb28-163"></a>  <span class="fu">annotate</span>(<span class="at">geom =</span> <span class="st">"text"</span>, <span class="at">x =</span> <span class="fl">6.2</span>, <span class="at">y =</span> <span class="fl">0.6</span>, <span class="at">color =</span> <span class="st">"gray40"</span>,</span>
<span id="cb28-164"><a href="#cb28-164"></a>           <span class="at">label =</span> <span class="st">"Campaign</span><span class="sc">\n</span><span class="st">ends after</span><span class="sc">\n</span><span class="st">6 weeks"</span>, <span class="at">hjust =</span> <span class="st">"left"</span>) <span class="sc">+</span> </span>
<span id="cb28-165"><a href="#cb28-165"></a>  <span class="co"># impact of treatment disappears by 2.5 months</span></span>
<span id="cb28-166"><a href="#cb28-166"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="dv">10</span>, <span class="at">linetype =</span> <span class="st">"dotted"</span>, <span class="at">color =</span> <span class="st">"gray40"</span>) <span class="sc">+</span> </span>
<span id="cb28-167"><a href="#cb28-167"></a>  <span class="fu">annotate</span>(<span class="at">geom =</span> <span class="st">"text"</span>, <span class="at">x =</span> <span class="fl">9.8</span>, <span class="at">y =</span> <span class="fl">0.1</span>, <span class="at">color =</span> <span class="st">"gray40"</span>,</span>
<span id="cb28-168"><a href="#cb28-168"></a>           <span class="at">label =</span> <span class="st">"Impact of</span><span class="sc">\n</span><span class="st">treatment</span><span class="sc">\n</span><span class="st">dies down"</span>, <span class="at">hjust =</span> <span class="st">"right"</span>) <span class="sc">+</span> </span>
<span id="cb28-169"><a href="#cb28-169"></a>  <span class="co"># analysis date (right-censoring at 3 months)</span></span>
<span id="cb28-170"><a href="#cb28-170"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="dv">12</span>, <span class="at">linetype =</span> <span class="st">"dotted"</span>, <span class="at">color =</span> <span class="st">"gray40"</span>) <span class="sc">+</span> </span>
<span id="cb28-171"><a href="#cb28-171"></a>  <span class="fu">annotate</span>(<span class="at">geom =</span> <span class="st">"text"</span>, <span class="at">x =</span> <span class="fl">12.2</span>, <span class="at">y =</span> <span class="fl">0.1</span>, <span class="at">color =</span> <span class="st">"gray40"</span>,</span>
<span id="cb28-172"><a href="#cb28-172"></a>           <span class="at">label =</span> glue<span class="sc">::</span><span class="fu">glue</span>(<span class="st">"Cut-off date for analysis</span><span class="sc">\n</span><span class="st">"</span>, </span>
<span id="cb28-173"><a href="#cb28-173"></a>                              <span class="st">"(administrative right-censoring "</span>, </span>
<span id="cb28-174"><a href="#cb28-174"></a>                              <span class="st">"at 3 months)"</span>), </span>
<span id="cb28-175"><a href="#cb28-175"></a>           <span class="at">hjust =</span> <span class="st">"left"</span>) <span class="sc">+</span> </span>
<span id="cb28-176"><a href="#cb28-176"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"gray20"</span>, <span class="st">"forestgreen"</span>)) <span class="sc">+</span></span>
<span id="cb28-177"><a href="#cb28-177"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">labels =</span> scales<span class="sc">::</span><span class="fu">label_percent</span>()) <span class="sc">+</span></span>
<span id="cb28-178"><a href="#cb28-178"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Time since product launch (in weeks)"</span>, </span>
<span id="cb28-179"><a href="#cb28-179"></a>       <span class="at">y =</span> <span class="st">"Cumulative incidence"</span>) <span class="sc">+</span></span>
<span id="cb28-180"><a href="#cb28-180"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"bottom"</span>, <span class="at">legend.title =</span> <span class="fu">element_blank</span>())</span>
<span id="cb28-181"><a href="#cb28-181"></a></span>
<span id="cb28-182"><a href="#cb28-182"></a>cumulative_incidence_plot <span class="sc">+</span> </span>
<span id="cb28-183"><a href="#cb28-183"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">24</span>, <span class="dv">4</span>))</span>
<span id="cb28-184"><a href="#cb28-184"></a><span class="in">```</span></span>
<span id="cb28-185"><a href="#cb28-185"></a></span>
<span id="cb28-186"><a href="#cb28-186"></a>As expected of CDFs, the CIC starts at 0% for both groups at $t = 0$ and keeps increasing over time until it reaches 100%.</span>
<span id="cb28-187"><a href="#cb28-187"></a></span>
<span id="cb28-188"><a href="#cb28-188"></a><span class="fu">## Simulate true event times</span></span>
<span id="cb28-189"><a href="#cb28-189"></a></span>
<span id="cb28-190"><a href="#cb28-190"></a>Finally, we can get around to simulating some data from our experiment. Normally I'd use either the <span class="co">[</span><span class="ot">`coxed::sim.survdata()`</span><span class="co">](https://cran.r-project.org/web/packages/coxed/)</span> function or the <span class="co">[</span><span class="ot">`simsurv::simsurv()`</span><span class="co">](https://cran.r-project.org/web/packages/simsurv/)</span> function, but in the interest of learning<span class="ot">[^2]</span> I'm going to do this manually using the *cumulative hazard inversion method* (usually attributed to <span class="co">[</span><span class="ot">this paper</span><span class="co">](https://onlinelibrary.wiley.com/doi/10.1002/sim.2059)</span> and concisely described in the <span class="in">`simsurv`</span> package vignette <span class="co">[</span><span class="ot">here</span><span class="co">](https://cran.r-project.org/web/packages/simsurv/vignettes/simsurv_technical.html)</span>).</span>
<span id="cb28-191"><a href="#cb28-191"></a></span>
<span id="cb28-192"><a href="#cb28-192"></a><span class="ot">[^2]: </span>These packages don't support log-logistic models out-of-the-box anyway.</span>
<span id="cb28-193"><a href="#cb28-193"></a></span>
<span id="cb28-194"><a href="#cb28-194"></a>For simulating data from a Weibull PH model as opposed to the log-logistic AFT model, see <span class="co">[</span><span class="ot">this</span><span class="co">](https://stats.stackexchange.com/questions/135124/how-to-create-a-toy-survival-time-to-event-data-with-right-censoring)</span>, <span class="co">[</span><span class="ot">this</span><span class="co">](https://stats.stackexchange.com/questions/603395/simulating-survival-times)</span>, or the papers in the previous paragraph. <span class="co">[</span><span class="ot">This paper</span><span class="co">](https://onlinelibrary.wiley.com/doi/10.1002/sim.5823)</span> is also pretty useful for simulating data from more complex settings.</span>
<span id="cb28-195"><a href="#cb28-195"></a></span>
<span id="cb28-196"><a href="#cb28-196"></a>Plugging in the value of $F(T_i)$ for the log-logistic distribution, and doing some algebra gives the function for simulating the true (or latent) event time $T_i$ for the $i$-th individual from a log-logistic distribution (matches equation 8 from <span class="co">[</span><span class="ot">this paper</span><span class="co">](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC5061707/)</span>).</span>
<span id="cb28-197"><a href="#cb28-197"></a></span>
<span id="cb28-198"><a href="#cb28-198"></a>$$</span>
<span id="cb28-199"><a href="#cb28-199"></a>\begin{align*}</span>
<span id="cb28-200"><a href="#cb28-200"></a>S(T_i) = 1 - F(T_i) &amp;= U_i \sim \text{Uniform}(0, 1) <span class="sc">\\</span></span>
<span id="cb28-201"><a href="#cb28-201"></a>1 - \frac{1}{1 + (T_i / \alpha)^{-\beta}} &amp;= U_i <span class="sc">\\</span></span>
<span id="cb28-202"><a href="#cb28-202"></a>1 + \Bigg(\frac{T_i}{\alpha}\Bigg)^{-\beta} &amp;= \frac{1}{1 - U_i} <span class="sc">\\</span></span>
<span id="cb28-203"><a href="#cb28-203"></a>\Bigg(\frac{T_i}{\alpha}\Bigg)^{-\beta} &amp;= \frac{U_i}{1 - U_i} <span class="sc">\\</span></span>
<span id="cb28-204"><a href="#cb28-204"></a>\Bigg(\frac{\alpha}{T_i}\Bigg)^{\beta} &amp;= \frac{1 - U_i}{U_i} <span class="sc">\\</span></span>
<span id="cb28-205"><a href="#cb28-205"></a>\frac{\alpha}{T_i} &amp;= \Bigg(\frac{1 - U_i}{U_i}\Bigg)^{1 / \beta} <span class="sc">\\</span></span>
<span id="cb28-206"><a href="#cb28-206"></a>T_i &amp;= \alpha (U_i^{-1} - 1)^{-1 / \beta} <span class="sc">\\</span></span>
<span id="cb28-207"><a href="#cb28-207"></a>\end{align*}</span>
<span id="cb28-208"><a href="#cb28-208"></a>$$</span>
<span id="cb28-209"><a href="#cb28-209"></a></span>
<span id="cb28-210"><a href="#cb28-210"></a>The Wikipedia page for log-logistic distribution mentions that $\text{log}(\alpha_i) = X_i^T \gamma$ can be used to specify covariates that influence the scale parameter $\alpha_i$ — with $\gamma$ the ($p$-dimensional row) vector of coefficients, and $X_i$ the ($p$-dimensional row) vector of covariates for individual $i$. The shape parameter $\beta$ is assumed to be constant across covariate levels, but it's possible to model $\beta$ as a function of covariates as well with $\text{log}(\beta_i) = Z_i^T \delta$ where $Z$ and $X$ can be identical, partly overlapping, or completely disjoint covariate sets, and $\delta$ the associated coefficients. Using logs ensures that both $\alpha_i$ and $\beta_i$ will have values greater than zero. This gives</span>
<span id="cb28-211"><a href="#cb28-211"></a></span>
<span id="cb28-212"><a href="#cb28-212"></a>$$</span>
<span id="cb28-213"><a href="#cb28-213"></a>T_i = \text{exp}(X_i^T \gamma)(U_i^{-1} - 1)^{-1 / \text{exp}(Z_i^T \delta)}</span>
<span id="cb28-214"><a href="#cb28-214"></a>$$</span>
<span id="cb28-215"><a href="#cb28-215"></a></span>
<span id="cb28-216"><a href="#cb28-216"></a>We can draw simulated event times across 30 experiments each with about 1000 individuals split evenly between the treatment and control groups.</span>
<span id="cb28-217"><a href="#cb28-217"></a></span>
<span id="cb28-220"><a href="#cb28-220"></a><span class="in">```{r}</span></span>
<span id="cb28-221"><a href="#cb28-221"></a>n_sim <span class="ot">&lt;-</span> <span class="dv">30</span></span>
<span id="cb28-222"><a href="#cb28-222"></a>n_sample <span class="ot">&lt;-</span> <span class="dv">1000</span></span>
<span id="cb28-223"><a href="#cb28-223"></a>n_total <span class="ot">&lt;-</span> n_sim <span class="sc">*</span> n_sample</span>
<span id="cb28-224"><a href="#cb28-224"></a></span>
<span id="cb28-225"><a href="#cb28-225"></a><span class="fu">set.seed</span>(<span class="dv">43</span>)</span>
<span id="cb28-226"><a href="#cb28-226"></a>loglogistic_samples <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb28-227"><a href="#cb28-227"></a>  <span class="at">sim_id =</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span>n_sim, <span class="at">each =</span> n_sample),</span>
<span id="cb28-228"><a href="#cb28-228"></a>  <span class="at">id =</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span>n_sample, <span class="at">times =</span> n_sim),</span>
<span id="cb28-229"><a href="#cb28-229"></a>  <span class="at">treatment =</span> <span class="fu">sample</span>(<span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>), <span class="at">size =</span> n_total,</span>
<span id="cb28-230"><a href="#cb28-230"></a>                     <span class="at">replace =</span> <span class="cn">TRUE</span>, <span class="at">prob =</span> <span class="fu">c</span>(<span class="fl">0.5</span>, <span class="fl">0.5</span>)),</span>
<span id="cb28-231"><a href="#cb28-231"></a>  <span class="at">parameters =</span> <span class="fu">case_when</span>(</span>
<span id="cb28-232"><a href="#cb28-232"></a>    treatment <span class="sc">==</span> <span class="dv">1</span> <span class="sc">~</span> <span class="st">"Treatment group (T ~ LL(4, 7))"</span>,</span>
<span id="cb28-233"><a href="#cb28-233"></a>    treatment <span class="sc">==</span> <span class="dv">0</span> <span class="sc">~</span> <span class="st">"Control group (T ~ LL(5, 7))"</span></span>
<span id="cb28-234"><a href="#cb28-234"></a>  ),</span>
<span id="cb28-235"><a href="#cb28-235"></a>  <span class="co"># -log(1.25) corresponds to alpha = 5 in control</span></span>
<span id="cb28-236"><a href="#cb28-236"></a>  <span class="co"># and alpha = 4 in treatment</span></span>
<span id="cb28-237"><a href="#cb28-237"></a>  <span class="at">linear_predictor_alpha =</span> <span class="fu">log</span>(<span class="dv">5</span>) <span class="sc">-</span> <span class="fu">log</span>(<span class="fl">1.25</span>) <span class="sc">*</span> treatment,</span>
<span id="cb28-238"><a href="#cb28-238"></a>  <span class="at">linear_predictor_beta =</span><span class="fu">log</span>(<span class="dv">7</span>),</span>
<span id="cb28-239"><a href="#cb28-239"></a>  <span class="at">u =</span> <span class="fu">runif</span>(n_total, <span class="at">min =</span> <span class="dv">0</span>, <span class="at">max =</span> <span class="dv">1</span>),</span>
<span id="cb28-240"><a href="#cb28-240"></a>  <span class="at">time =</span> (<span class="fu">exp</span>(linear_predictor_alpha) <span class="sc">*</span></span>
<span id="cb28-241"><a href="#cb28-241"></a>            (((<span class="dv">1</span> <span class="sc">/</span> u) <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">^</span> (<span class="sc">-</span><span class="dv">1</span> <span class="sc">/</span> <span class="fu">exp</span>(linear_predictor_beta))))</span>
<span id="cb28-242"><a href="#cb28-242"></a>)</span>
<span id="cb28-243"><a href="#cb28-243"></a></span>
<span id="cb28-244"><a href="#cb28-244"></a>loglogistic_samples <span class="sc">%&gt;%</span> <span class="fu">glimpse</span>(<span class="at">width =</span> <span class="dv">80</span>)</span>
<span id="cb28-245"><a href="#cb28-245"></a><span class="in">```</span></span>
<span id="cb28-246"><a href="#cb28-246"></a></span>
<span id="cb28-247"><a href="#cb28-247"></a>The estimated CDFs for each sample are added to a zoomed-in version of cumulative incidence figure above.</span>
<span id="cb28-248"><a href="#cb28-248"></a></span>
<span id="cb28-251"><a href="#cb28-251"></a><span class="in">```{r}</span></span>
<span id="cb28-252"><a href="#cb28-252"></a><span class="co">#| code-fold: true</span></span>
<span id="cb28-253"><a href="#cb28-253"></a></span>
<span id="cb28-254"><a href="#cb28-254"></a>cumulative_incidence_plot_samples <span class="ot">&lt;-</span> cumulative_incidence_plot </span>
<span id="cb28-255"><a href="#cb28-255"></a></span>
<span id="cb28-256"><a href="#cb28-256"></a><span class="co"># for this hacky solution to overlay the true curves over</span></span>
<span id="cb28-257"><a href="#cb28-257"></a><span class="co"># the sampled curves, see </span></span>
<span id="cb28-258"><a href="#cb28-258"></a><span class="co"># https://stackoverflow.com/questions/20249653/insert-layer-underneath-existing-layers-in-ggplot2-object</span></span>
<span id="cb28-259"><a href="#cb28-259"></a>cumulative_incidence_plot_samples<span class="sc">$</span>layers <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb28-260"><a href="#cb28-260"></a>  <span class="fu">stat_ecdf</span>(</span>
<span id="cb28-261"><a href="#cb28-261"></a>    <span class="at">data =</span> loglogistic_samples, </span>
<span id="cb28-262"><a href="#cb28-262"></a>    <span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">linetype =</span> parameters, </span>
<span id="cb28-263"><a href="#cb28-263"></a>        <span class="at">group =</span> <span class="fu">interaction</span>(sim_id, parameters)), </span>
<span id="cb28-264"><a href="#cb28-264"></a>    <span class="at">inherit.aes =</span> <span class="cn">FALSE</span>, </span>
<span id="cb28-265"><a href="#cb28-265"></a>    <span class="at">color =</span> <span class="st">"gray70"</span></span>
<span id="cb28-266"><a href="#cb28-266"></a>  ), </span>
<span id="cb28-267"><a href="#cb28-267"></a>  cumulative_incidence_plot<span class="sc">$</span>layers</span>
<span id="cb28-268"><a href="#cb28-268"></a>)</span>
<span id="cb28-269"><a href="#cb28-269"></a></span>
<span id="cb28-270"><a href="#cb28-270"></a>cumulative_incidence_plot_samples <span class="sc">+</span> </span>
<span id="cb28-271"><a href="#cb28-271"></a>  <span class="fu">coord_cartesian</span>(<span class="at">xlim =</span> <span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">10</span>)) <span class="sc">+</span> </span>
<span id="cb28-272"><a href="#cb28-272"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">2</span>, <span class="dv">10</span>, <span class="dv">1</span>)) <span class="sc">+</span> </span>
<span id="cb28-273"><a href="#cb28-273"></a>  <span class="fu">guides</span>(</span>
<span id="cb28-274"><a href="#cb28-274"></a>    <span class="at">color =</span> <span class="fu">guide_legend</span>(<span class="at">nrow =</span> <span class="dv">2</span>), </span>
<span id="cb28-275"><a href="#cb28-275"></a>    <span class="at">linetype =</span> <span class="fu">guide_legend</span>(<span class="at">nrow =</span> <span class="dv">2</span>)</span>
<span id="cb28-276"><a href="#cb28-276"></a>  )</span>
<span id="cb28-277"><a href="#cb28-277"></a><span class="in">```</span></span>
<span id="cb28-278"><a href="#cb28-278"></a></span>
<span id="cb28-279"><a href="#cb28-279"></a>The empirical CDFs of survival times for each sample fluctuate around the true curve in each group, which is reassuring. These simulated event times are the *true* individual event times for that specific sample of individuals. These are not always observed, which brings us to our next point.</span>
<span id="cb28-280"><a href="#cb28-280"></a></span>
<span id="cb28-281"><a href="#cb28-281"></a><span class="fu">## Add censoring</span></span>
<span id="cb28-282"><a href="#cb28-282"></a></span>
<span id="cb28-283"><a href="#cb28-283"></a>One complication I've ignored so far is *(right-)censoring*. Individuals are said to be right-censored if they haven't had the event of interest yet at the time of analysis and therefore only a lower bound on their true event time is observed.</span>
<span id="cb28-284"><a href="#cb28-284"></a></span>
<span id="cb28-285"><a href="#cb28-285"></a>The most common data structure for survival analysis is the tuple $(Y_i, \delta_i)$ where $Y_i = \text{min}(T_i, C_i)$ is the smaller of the event time $T_i$ or the censoring time $C_i$, and $\delta_i = I(T_i \le C_i)$ is the event indicator with value 1 indicating the true event time is observed, and 0 indicating that the observation is censored. The censoring indicator is $1 - \delta_i$.</span>
<span id="cb28-286"><a href="#cb28-286"></a></span>
<span id="cb28-287"><a href="#cb28-287"></a>Non-informative administrative (or Type-1) right censoring is the simplest type of censoring where the censoring time is the same for all individuals. If two analyses are carried out — one after three weeks, and another after twelve weeks — then the same individual with true $T_i = 4.5$ is recorded as $(Y_i = 3, \delta_i = 0)$ in the first analysis and $(Y_i = 4.5, \delta_i = 1)$ in the second analysis.</span>
<span id="cb28-288"><a href="#cb28-288"></a></span>
<span id="cb28-289"><a href="#cb28-289"></a>This can be applied to the simulated event times easily enough using simple conditionals</span>
<span id="cb28-290"><a href="#cb28-290"></a></span>
<span id="cb28-293"><a href="#cb28-293"></a><span class="in">```{r}</span></span>
<span id="cb28-294"><a href="#cb28-294"></a>loglogistic_samples <span class="sc">%&gt;%</span> </span>
<span id="cb28-295"><a href="#cb28-295"></a>  <span class="fu">select</span>(time) <span class="sc">%&gt;%</span> </span>
<span id="cb28-296"><a href="#cb28-296"></a>  <span class="fu">mutate</span>(</span>
<span id="cb28-297"><a href="#cb28-297"></a>    <span class="at">latent =</span> time,</span>
<span id="cb28-298"><a href="#cb28-298"></a>    <span class="at">time3 =</span> <span class="fu">pmin</span>(time, <span class="fl">3.0</span>),</span>
<span id="cb28-299"><a href="#cb28-299"></a>    <span class="at">cens3 =</span> <span class="fu">as.numeric</span>(time <span class="sc">&gt;</span> <span class="fl">3.0</span>),</span>
<span id="cb28-300"><a href="#cb28-300"></a>    <span class="at">time6 =</span> <span class="fu">pmin</span>(time, <span class="fl">6.0</span>),</span>
<span id="cb28-301"><a href="#cb28-301"></a>    <span class="at">cens6 =</span> <span class="fu">as.numeric</span>(time <span class="sc">&gt;</span> <span class="fl">6.0</span>),</span>
<span id="cb28-302"><a href="#cb28-302"></a>    <span class="at">time12 =</span> <span class="fu">pmin</span>(time, <span class="fl">12.0</span>),</span>
<span id="cb28-303"><a href="#cb28-303"></a>    <span class="at">cens12 =</span> <span class="fu">as.numeric</span>(time <span class="sc">&gt;</span> <span class="fl">12.0</span>)</span>
<span id="cb28-304"><a href="#cb28-304"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb28-305"><a href="#cb28-305"></a>  <span class="fu">select</span>(<span class="sc">-</span>time) <span class="sc">%&gt;%</span> </span>
<span id="cb28-306"><a href="#cb28-306"></a>  <span class="fu">summary</span>(<span class="at">digits =</span> <span class="dv">2</span>)</span>
<span id="cb28-307"><a href="#cb28-307"></a><span class="in">```</span></span>
<span id="cb28-308"><a href="#cb28-308"></a></span>
<span id="cb28-309"><a href="#cb28-309"></a>The overall true event time distribution — in the latent column — goes up to 20 weeks, but due to censoring, 93% of observations are censored at 3 weeks, 13% at 6 weeks, and fewer than 1% at twelve weeks, with the maximum time equal to the censoring time. The larger the proportion of censoring, the larger the difference between the true mean and the mean of the censored event time distribution.</span>
<span id="cb28-310"><a href="#cb28-310"></a></span>
<span id="cb28-311"><a href="#cb28-311"></a>In more complex settings, censoring times can be simulated from (say) an exponential or gamma distribution that is assumed to be independent of the event times, or the censoring distribution can vary as a function of covariates. The next plot overlays the true event time densities in each treatment group on top of the censoring distribution $C_i \sim \text{Gamma}(6, 1)$</span>
<span id="cb28-312"><a href="#cb28-312"></a></span>
<span id="cb28-315"><a href="#cb28-315"></a><span class="in">```{r}</span></span>
<span id="cb28-316"><a href="#cb28-316"></a><span class="co">#| code-fold: true</span></span>
<span id="cb28-317"><a href="#cb28-317"></a></span>
<span id="cb28-318"><a href="#cb28-318"></a><span class="fu">set.seed</span>(<span class="dv">43</span>)</span>
<span id="cb28-319"><a href="#cb28-319"></a>loglogistic_samples <span class="sc">%&gt;%</span></span>
<span id="cb28-320"><a href="#cb28-320"></a>  <span class="fu">select</span>(parameters, time) <span class="sc">%&gt;%</span></span>
<span id="cb28-321"><a href="#cb28-321"></a>  <span class="fu">bind_rows</span>(</span>
<span id="cb28-322"><a href="#cb28-322"></a>    <span class="fu">tibble</span>(</span>
<span id="cb28-323"><a href="#cb28-323"></a>      <span class="at">parameters =</span> <span class="st">"Censoring times ~ Gamma(6, 1)"</span>,</span>
<span id="cb28-324"><a href="#cb28-324"></a>      <span class="at">time =</span> <span class="fu">rgamma</span>(<span class="fu">floor</span>(n_total <span class="sc">/</span> <span class="dv">2</span>), <span class="at">shape =</span> <span class="dv">6</span>, <span class="at">scale =</span> <span class="dv">1</span>)</span>
<span id="cb28-325"><a href="#cb28-325"></a>    )</span>
<span id="cb28-326"><a href="#cb28-326"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb28-327"><a href="#cb28-327"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">fill =</span> parameters, <span class="at">color =</span> parameters)) <span class="sc">+</span></span>
<span id="cb28-328"><a href="#cb28-328"></a>  <span class="fu">geom_density</span>(<span class="at">alpha =</span> <span class="fl">0.6</span>) <span class="sc">+</span></span>
<span id="cb28-329"><a href="#cb28-329"></a>  <span class="fu">xlab</span>(<span class="st">"Time since product launch (in weeks)"</span>) <span class="sc">+</span></span>
<span id="cb28-330"><a href="#cb28-330"></a>  <span class="fu">theme</span>(<span class="at">legend.title =</span> <span class="fu">element_blank</span>(), <span class="at">legend.position =</span> <span class="st">"bottom"</span>) <span class="sc">+</span> </span>
<span id="cb28-331"><a href="#cb28-331"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"purple3"</span>, <span class="st">"gray20"</span>, <span class="st">"forestgreen"</span>)) <span class="sc">+</span></span>
<span id="cb28-332"><a href="#cb28-332"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"purple3"</span>, <span class="st">"gray20"</span>, <span class="st">"forestgreen"</span>))</span>
<span id="cb28-333"><a href="#cb28-333"></a><span class="in">```</span></span>
<span id="cb28-334"><a href="#cb28-334"></a></span>
<span id="cb28-335"><a href="#cb28-335"></a>In this case, the code is nearly the same.</span>
<span id="cb28-336"><a href="#cb28-336"></a></span>
<span id="cb28-339"><a href="#cb28-339"></a><span class="in">```{r}</span></span>
<span id="cb28-340"><a href="#cb28-340"></a><span class="fu">set.seed</span>(<span class="dv">43</span>)</span>
<span id="cb28-341"><a href="#cb28-341"></a>loglogistic_samples <span class="sc">%&gt;%</span></span>
<span id="cb28-342"><a href="#cb28-342"></a>  <span class="fu">select</span>(parameters, <span class="at">latent =</span> time) <span class="sc">%&gt;%</span></span>
<span id="cb28-343"><a href="#cb28-343"></a>  <span class="fu">mutate</span>(</span>
<span id="cb28-344"><a href="#cb28-344"></a>    <span class="at">censoring_time =</span> <span class="fu">rgamma</span>(n_total, <span class="at">shape =</span> <span class="dv">6</span>, <span class="at">scale =</span> <span class="dv">1</span>),</span>
<span id="cb28-345"><a href="#cb28-345"></a>    <span class="at">observed_time =</span> <span class="fu">pmin</span>(latent, censoring_time),</span>
<span id="cb28-346"><a href="#cb28-346"></a>    <span class="at">cens =</span> <span class="fu">as.numeric</span>(latent <span class="sc">&gt;</span> censoring_time)</span>
<span id="cb28-347"><a href="#cb28-347"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb28-348"><a href="#cb28-348"></a>  <span class="fu">summarize</span>(</span>
<span id="cb28-349"><a href="#cb28-349"></a>    <span class="fu">across</span>(</span>
<span id="cb28-350"><a href="#cb28-350"></a>      <span class="at">.cols =</span> <span class="fu">everything</span>(), </span>
<span id="cb28-351"><a href="#cb28-351"></a>      <span class="at">.fns =</span> <span class="sc">~</span> <span class="fu">round</span>(<span class="fu">mean</span>(.x), <span class="dv">2</span>), </span>
<span id="cb28-352"><a href="#cb28-352"></a>      <span class="at">.names =</span> <span class="st">"mean_{.col}"</span></span>
<span id="cb28-353"><a href="#cb28-353"></a>    ), </span>
<span id="cb28-354"><a href="#cb28-354"></a>    <span class="at">.by =</span> parameters</span>
<span id="cb28-355"><a href="#cb28-355"></a>  )</span>
<span id="cb28-356"><a href="#cb28-356"></a><span class="in">```</span></span>
<span id="cb28-357"><a href="#cb28-357"></a></span>
<span id="cb28-358"><a href="#cb28-358"></a>Summary of the simulated data shows that 25% of the individuals in the treatment group are censored compared to 40% of the individuals in the control group over the full range of time values (about 20 weeks).</span>
<span id="cb28-359"><a href="#cb28-359"></a></span>
<span id="cb28-360"><a href="#cb28-360"></a><span class="fu">## Add cure</span></span>
<span id="cb28-361"><a href="#cb28-361"></a></span>
<span id="cb28-362"><a href="#cb28-362"></a>Another complication is the presence of *(statistical) cure*. Some individuals will never purchase the product irrespective of whichever group they fall in. Which means that if the follow-up period is extended from 12 weeks to 150 or 500 weeks, these so-called "cured" individuals will still show up as censored because their true survival time is effectively infinite. Ignoring cure and using a cox model can lead to biased estimates of the quantities we're interested in, as figure 2 of <span class="co">[</span><span class="ot">this paper</span><span class="co">](https://www.annualreviews.org/content/journals/10.1146/annurev-statistics-031017-100101)</span> visually demonstrates. It also gives an overview of the different types of (major) cure models. Another reference I found useful was <span class="co">[</span><span class="ot">this one</span><span class="co">](https://dial.uclouvain.be/pr/boreal/object/boreal%3A220045/datastream/PDF_02/view)</span><span class="ot">[^3]</span>.</span>
<span id="cb28-363"><a href="#cb28-363"></a></span>
<span id="cb28-364"><a href="#cb28-364"></a><span class="ot">[^3]: </span>This is the link to the Bertand and Legrand book chapter mentioned in the references below.</span>
<span id="cb28-365"><a href="#cb28-365"></a></span>
<span id="cb28-366"><a href="#cb28-366"></a>The family of *mixture cure model* has the following survivor function form</span>
<span id="cb28-367"><a href="#cb28-367"></a></span>
<span id="cb28-368"><a href="#cb28-368"></a>$$</span>
<span id="cb28-369"><a href="#cb28-369"></a>S_{\text{pop}}(t|I, L) = (1 - \pi(I)) + \pi(I) S_u(t|L)</span>
<span id="cb28-370"><a href="#cb28-370"></a>$$</span>
<span id="cb28-371"><a href="#cb28-371"></a></span>
<span id="cb28-372"><a href="#cb28-372"></a>with two parts: the first part is based on the *incidence* which is whether an individual is cured or not ($\pi(I) = P[B = 1 | I]$ is the probability of being cured as a function of covariate $I$, and $B$ is the latent cure status); and the second part is concerned with *latency*, which is about how long it takes for the event to occur among the uncured. $L$ is the set of factors that affect latency. Overlap between $I$ and $L$ is possible.</span>
<span id="cb28-373"><a href="#cb28-373"></a></span>
<span id="cb28-374"><a href="#cb28-374"></a>The other major family of cure models is the *promotion time cure model* with the survivor function</span>
<span id="cb28-375"><a href="#cb28-375"></a></span>
<span id="cb28-376"><a href="#cb28-376"></a>$$</span>
<span id="cb28-377"><a href="#cb28-377"></a>S_{\text{pop}}(t|x) = \text{exp}<span class="co">[</span><span class="ot">-\theta(x)F(t)</span><span class="co">]</span></span>
<span id="cb28-378"><a href="#cb28-378"></a>$$</span>
<span id="cb28-379"><a href="#cb28-379"></a></span>
<span id="cb28-380"><a href="#cb28-380"></a>which has a PH interpretation. In this model, parameters affecting cure and survival are not separated like they are in the mixture cure model.</span>
<span id="cb28-381"><a href="#cb28-381"></a></span>
<span id="cb28-382"><a href="#cb28-382"></a>Finally, <span class="co">[</span><span class="ot">this paper</span><span class="co">](https://journals.sagepub.com/doi/10.1177/1536867X0700700304)</span> mentions relative survival / excess mortality models as well, which considers individuals in the treatment or control group to be cured when the hazard rate decreases to background levels.</span>
<span id="cb28-383"><a href="#cb28-383"></a></span>
<span id="cb28-384"><a href="#cb28-384"></a>The simplest cure model is the constant one, where the cure fraction is the same across all groups. This can be simulated by generating a latent "cure" variable $B_i \sim \text{Bernoulli}(\pi_i)$ (with $\pi_i = \pi = 0.3$ denoting the proportion of cured individuals in the next code chunk)</span>
<span id="cb28-385"><a href="#cb28-385"></a></span>
<span id="cb28-388"><a href="#cb28-388"></a><span class="in">```{r}</span></span>
<span id="cb28-389"><a href="#cb28-389"></a><span class="fu">set.seed</span>(<span class="dv">43</span>)</span>
<span id="cb28-390"><a href="#cb28-390"></a>loglogistic_samples <span class="sc">%&gt;%</span></span>
<span id="cb28-391"><a href="#cb28-391"></a>  <span class="fu">mutate</span>(</span>
<span id="cb28-392"><a href="#cb28-392"></a>    <span class="at">cured =</span> <span class="fu">rbinom</span>(n_total, <span class="dv">1</span>, <span class="fl">0.3</span>),</span>
<span id="cb28-393"><a href="#cb28-393"></a>    <span class="at">time =</span> <span class="fu">ifelse</span>(cured <span class="sc">==</span> <span class="dv">1</span>, <span class="dv">10000</span>, time), </span>
<span id="cb28-394"><a href="#cb28-394"></a>    <span class="at">time6 =</span> <span class="fu">pmin</span>(time, <span class="fl">6.0</span>),</span>
<span id="cb28-395"><a href="#cb28-395"></a>    <span class="at">cens6 =</span> <span class="fu">as.numeric</span>(time <span class="sc">&gt;</span> <span class="fl">6.0</span>)</span>
<span id="cb28-396"><a href="#cb28-396"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb28-397"><a href="#cb28-397"></a>  <span class="fu">count</span>(cured, cens6) <span class="sc">%&gt;%</span> </span>
<span id="cb28-398"><a href="#cb28-398"></a>  <span class="fu">mutate</span>(<span class="at">p =</span> <span class="fu">round</span>(<span class="dv">100</span> <span class="sc">*</span> (n <span class="sc">/</span> <span class="fu">sum</span>(n)), <span class="dv">1</span>))</span>
<span id="cb28-399"><a href="#cb28-399"></a><span class="in">```</span></span>
<span id="cb28-400"><a href="#cb28-400"></a></span>
<span id="cb28-401"><a href="#cb28-401"></a>If six weeks is used as the cutoff time for analysis, 63% of the individuals overall have experienced the event of interest, and 37% are censored of which 7% are the censored uncured observations, and 30% are the censored cured individuals.</span>
<span id="cb28-402"><a href="#cb28-402"></a></span>
<span id="cb28-403"><a href="#cb28-403"></a>The logistic model for incidence can be more elaborate — the following code generates data where the cure fraction varies as a function of (say) age</span>
<span id="cb28-404"><a href="#cb28-404"></a></span>
<span id="cb28-407"><a href="#cb28-407"></a><span class="in">```{r}</span></span>
<span id="cb28-408"><a href="#cb28-408"></a><span class="co">#| eval: false</span></span>
<span id="cb28-409"><a href="#cb28-409"></a></span>
<span id="cb28-410"><a href="#cb28-410"></a>loglogistic_samples <span class="sc">%&gt;%</span></span>
<span id="cb28-411"><a href="#cb28-411"></a>  <span class="fu">mutate</span>(</span>
<span id="cb28-412"><a href="#cb28-412"></a>    <span class="at">age =</span> {</span>
<span id="cb28-413"><a href="#cb28-413"></a>      <span class="fu">rgamma</span>(<span class="at">n =</span> n_total, <span class="at">shape =</span> <span class="dv">40</span>, <span class="at">rate =</span> <span class="fl">0.7</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb28-414"><a href="#cb28-414"></a>        <span class="fu">pmin</span>(., <span class="dv">90</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb28-415"><a href="#cb28-415"></a>        <span class="fu">pmax</span>(<span class="dv">20</span>, .) <span class="sc">%&gt;%</span> </span>
<span id="cb28-416"><a href="#cb28-416"></a>        <span class="fu">round</span>(., <span class="dv">1</span>)</span>
<span id="cb28-417"><a href="#cb28-417"></a>    },</span>
<span id="cb28-418"><a href="#cb28-418"></a>    <span class="at">cured =</span> <span class="fu">rbinom</span>(n_total, <span class="dv">1</span>, <span class="fu">plogis</span>(<span class="dv">4</span> <span class="sc">-</span> <span class="fl">0.07</span> <span class="sc">*</span> age)),</span>
<span id="cb28-419"><a href="#cb28-419"></a>    <span class="at">time =</span> <span class="fu">ifelse</span>(cured <span class="sc">==</span> <span class="dv">1</span>, <span class="dv">10000</span>, time),</span>
<span id="cb28-420"><a href="#cb28-420"></a>    <span class="at">time6 =</span> <span class="fu">pmin</span>(time, <span class="fl">6.0</span>),</span>
<span id="cb28-421"><a href="#cb28-421"></a>    <span class="at">cens6 =</span> <span class="fu">as.numeric</span>(time <span class="sc">&gt;</span> <span class="fl">6.0</span>),</span>
<span id="cb28-422"><a href="#cb28-422"></a>    <span class="at">event6 =</span> <span class="dv">1</span> <span class="sc">-</span> cens6,</span>
<span id="cb28-423"><a href="#cb28-423"></a>  )</span>
<span id="cb28-424"><a href="#cb28-424"></a><span class="in">```</span></span>
<span id="cb28-425"><a href="#cb28-425"></a></span>
<span id="cb28-426"><a href="#cb28-426"></a><span class="fu">## Putting it all together</span></span>
<span id="cb28-427"><a href="#cb28-427"></a></span>
<span id="cb28-428"><a href="#cb28-428"></a>All of the respective code chunks can be combined into a single call with a total sample size of $n = 50,000$.</span>
<span id="cb28-429"><a href="#cb28-429"></a></span>
<span id="cb28-432"><a href="#cb28-432"></a><span class="in">```{r}</span></span>
<span id="cb28-433"><a href="#cb28-433"></a>n_sim <span class="ot">&lt;-</span> <span class="dv">50</span></span>
<span id="cb28-434"><a href="#cb28-434"></a>n_sample <span class="ot">&lt;-</span> <span class="dv">1000</span></span>
<span id="cb28-435"><a href="#cb28-435"></a>n_total <span class="ot">&lt;-</span> n_sim <span class="sc">*</span> n_sample</span>
<span id="cb28-436"><a href="#cb28-436"></a></span>
<span id="cb28-437"><a href="#cb28-437"></a><span class="fu">set.seed</span>(<span class="dv">43</span>)</span>
<span id="cb28-438"><a href="#cb28-438"></a></span>
<span id="cb28-439"><a href="#cb28-439"></a>simulated_data <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb28-440"><a href="#cb28-440"></a>  <span class="co">#</span></span>
<span id="cb28-441"><a href="#cb28-441"></a>  <span class="co"># simulate id variables and covariates</span></span>
<span id="cb28-442"><a href="#cb28-442"></a>  <span class="co">#</span></span>
<span id="cb28-443"><a href="#cb28-443"></a>  <span class="at">sim_id =</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span>n_sim, <span class="at">each =</span> n_sample),</span>
<span id="cb28-444"><a href="#cb28-444"></a>  <span class="at">id =</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span>n_sample, <span class="at">times =</span> n_sim),</span>
<span id="cb28-445"><a href="#cb28-445"></a>  <span class="at">treatment =</span> <span class="fu">sample</span>(<span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>), <span class="at">size =</span> n_total,</span>
<span id="cb28-446"><a href="#cb28-446"></a>                     <span class="at">replace =</span> <span class="cn">TRUE</span>, <span class="at">prob =</span> <span class="fu">c</span>(<span class="fl">0.5</span>, <span class="fl">0.5</span>)),</span>
<span id="cb28-447"><a href="#cb28-447"></a>  <span class="at">parameters =</span> <span class="fu">case_when</span>(</span>
<span id="cb28-448"><a href="#cb28-448"></a>    treatment <span class="sc">==</span> <span class="dv">1</span> <span class="sc">~</span> <span class="st">"Treatment group (T ~ LL(4, 7))"</span>,</span>
<span id="cb28-449"><a href="#cb28-449"></a>    treatment <span class="sc">==</span> <span class="dv">0</span> <span class="sc">~</span> <span class="st">"Control group (T ~ LL(5, 7))"</span></span>
<span id="cb28-450"><a href="#cb28-450"></a>  ),</span>
<span id="cb28-451"><a href="#cb28-451"></a>  <span class="at">age =</span> {</span>
<span id="cb28-452"><a href="#cb28-452"></a>      <span class="fu">rgamma</span>(<span class="at">n =</span> n_total, <span class="at">shape =</span> <span class="dv">40</span>, <span class="at">rate =</span> <span class="fl">0.7</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb28-453"><a href="#cb28-453"></a>        <span class="fu">pmin</span>(., <span class="dv">90</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb28-454"><a href="#cb28-454"></a>        <span class="fu">pmax</span>(<span class="dv">20</span>, .) <span class="sc">%&gt;%</span> </span>
<span id="cb28-455"><a href="#cb28-455"></a>        <span class="fu">round</span>(., <span class="dv">1</span>)</span>
<span id="cb28-456"><a href="#cb28-456"></a>    },</span>
<span id="cb28-457"><a href="#cb28-457"></a>  <span class="co">#</span></span>
<span id="cb28-458"><a href="#cb28-458"></a>  <span class="co"># simulate latent event times as a function of covariates</span></span>
<span id="cb28-459"><a href="#cb28-459"></a>  <span class="co">#</span></span>
<span id="cb28-460"><a href="#cb28-460"></a>  <span class="at">linear_predictor_alpha =</span> <span class="fu">log</span>(<span class="dv">5</span>) <span class="sc">-</span> <span class="fu">log</span>(<span class="fl">1.25</span>) <span class="sc">*</span> treatment,</span>
<span id="cb28-461"><a href="#cb28-461"></a>  <span class="at">linear_predictor_beta =</span><span class="fu">log</span>(<span class="dv">7</span>),</span>
<span id="cb28-462"><a href="#cb28-462"></a>  <span class="at">u =</span> <span class="fu">runif</span>(n_total, <span class="at">min =</span> <span class="dv">0</span>, <span class="at">max =</span> <span class="dv">1</span>),</span>
<span id="cb28-463"><a href="#cb28-463"></a>  <span class="at">uncured_time =</span> (<span class="fu">exp</span>(linear_predictor_alpha) <span class="sc">*</span></span>
<span id="cb28-464"><a href="#cb28-464"></a>            (((<span class="dv">1</span> <span class="sc">/</span> u) <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">^</span> (<span class="sc">-</span><span class="dv">1</span> <span class="sc">/</span> <span class="fu">exp</span>(linear_predictor_beta)))), </span>
<span id="cb28-465"><a href="#cb28-465"></a>  <span class="co"># </span></span>
<span id="cb28-466"><a href="#cb28-466"></a>  <span class="co"># simulate the cure / incidence part from a logistic model</span></span>
<span id="cb28-467"><a href="#cb28-467"></a>  <span class="co">#</span></span>
<span id="cb28-468"><a href="#cb28-468"></a>  <span class="at">cured =</span> <span class="fu">rbinom</span>(n_total, <span class="dv">1</span>, <span class="fu">plogis</span>(<span class="dv">4</span> <span class="sc">-</span> <span class="fl">0.07</span> <span class="sc">*</span> age)),</span>
<span id="cb28-469"><a href="#cb28-469"></a>  <span class="at">latent_time =</span> <span class="fu">ifelse</span>(cured <span class="sc">==</span> <span class="dv">1</span>, <span class="dv">10000</span>, uncured_time),</span>
<span id="cb28-470"><a href="#cb28-470"></a>  <span class="co">#</span></span>
<span id="cb28-471"><a href="#cb28-471"></a>  <span class="co"># simulate censoring times and censor some individuals</span></span>
<span id="cb28-472"><a href="#cb28-472"></a>  <span class="co"># </span></span>
<span id="cb28-473"><a href="#cb28-473"></a>  <span class="at">random_censoring =</span> <span class="fu">rgamma</span>(n_total, <span class="at">shape =</span> <span class="dv">6</span>, <span class="at">scale =</span> <span class="dv">1</span>),</span>
<span id="cb28-474"><a href="#cb28-474"></a>  <span class="co"># keep the smallest of the random censoring </span></span>
<span id="cb28-475"><a href="#cb28-475"></a>  <span class="co"># and administrative censoring (at t = 6) times</span></span>
<span id="cb28-476"><a href="#cb28-476"></a>  <span class="at">censoring_time =</span> <span class="fu">pmin</span>(random_censoring, <span class="dv">6</span>),</span>
<span id="cb28-477"><a href="#cb28-477"></a>  <span class="at">time =</span> <span class="fu">pmin</span>(latent_time, censoring_time),</span>
<span id="cb28-478"><a href="#cb28-478"></a>  <span class="at">cens =</span> <span class="fu">as.numeric</span>(latent_time <span class="sc">&gt;</span> censoring_time), </span>
<span id="cb28-479"><a href="#cb28-479"></a>  <span class="at">event =</span> <span class="dv">1</span> <span class="sc">-</span> cens</span>
<span id="cb28-480"><a href="#cb28-480"></a>)</span>
<span id="cb28-481"><a href="#cb28-481"></a></span>
<span id="cb28-482"><a href="#cb28-482"></a>simulated_data <span class="sc">%&gt;%</span> <span class="fu">glimpse</span>(<span class="at">width =</span> <span class="dv">80</span>)</span>
<span id="cb28-483"><a href="#cb28-483"></a><span class="in">```</span></span>
<span id="cb28-484"><a href="#cb28-484"></a></span>
<span id="cb28-485"><a href="#cb28-485"></a><span class="fu">## Sanity check</span></span>
<span id="cb28-486"><a href="#cb28-486"></a></span>
<span id="cb28-487"><a href="#cb28-487"></a>As a sanity check, the log-logistic mixture cure model can be fit to the simulated data using the <span class="in">`flexsurvcure`</span> package to see whether we can recover the parameters used to generate data.</span>
<span id="cb28-488"><a href="#cb28-488"></a></span>
<span id="cb28-491"><a href="#cb28-491"></a><span class="in">```{r}</span></span>
<span id="cb28-492"><a href="#cb28-492"></a><span class="co">#| eval: false</span></span>
<span id="cb28-493"><a href="#cb28-493"></a></span>
<span id="cb28-494"><a href="#cb28-494"></a>simulated_data <span class="sc">%&gt;%</span> </span>
<span id="cb28-495"><a href="#cb28-495"></a>  <span class="co"># rename the treatment variable to make the printed summary nicer looking</span></span>
<span id="cb28-496"><a href="#cb28-496"></a>  <span class="fu">rename</span>(<span class="at">trt =</span> treatment) <span class="sc">%&gt;%</span> </span>
<span id="cb28-497"><a href="#cb28-497"></a>  <span class="fu">flexsurvcure</span>(</span>
<span id="cb28-498"><a href="#cb28-498"></a>    <span class="at">formula =</span> <span class="fu">Surv</span>(time, event, <span class="at">type =</span> <span class="st">"right"</span>) <span class="sc">~</span> age,</span>
<span id="cb28-499"><a href="#cb28-499"></a>    <span class="at">data =</span> .,</span>
<span id="cb28-500"><a href="#cb28-500"></a>    <span class="at">dist =</span> <span class="st">"llogis"</span>,</span>
<span id="cb28-501"><a href="#cb28-501"></a>    <span class="at">link =</span> <span class="st">"logistic"</span>,</span>
<span id="cb28-502"><a href="#cb28-502"></a>    <span class="at">anc =</span> <span class="fu">list</span>(</span>
<span id="cb28-503"><a href="#cb28-503"></a>      <span class="at">scale =</span> <span class="sc">~</span> trt,</span>
<span id="cb28-504"><a href="#cb28-504"></a>      <span class="at">shape =</span> <span class="sc">~</span> trt</span>
<span id="cb28-505"><a href="#cb28-505"></a>    ),</span>
<span id="cb28-506"><a href="#cb28-506"></a>    <span class="at">mixture =</span> <span class="cn">TRUE</span></span>
<span id="cb28-507"><a href="#cb28-507"></a>  )</span>
<span id="cb28-508"><a href="#cb28-508"></a><span class="in">```</span></span>
<span id="cb28-509"><a href="#cb28-509"></a></span>
<span id="cb28-510"><a href="#cb28-510"></a>The code takes a minute or two to run, so the saved model can be read back in.</span>
<span id="cb28-511"><a href="#cb28-511"></a></span>
<span id="cb28-514"><a href="#cb28-514"></a><span class="in">```{r}</span></span>
<span id="cb28-515"><a href="#cb28-515"></a><span class="co">#| code-fold: true</span></span>
<span id="cb28-516"><a href="#cb28-516"></a></span>
<span id="cb28-517"><a href="#cb28-517"></a><span class="fu">read_rds</span>(<span class="st">"sanity-check-model.rds"</span>)</span>
<span id="cb28-518"><a href="#cb28-518"></a><span class="in">```</span></span>
<span id="cb28-519"><a href="#cb28-519"></a></span>
<span id="cb28-520"><a href="#cb28-520"></a>The coefficients for the incidence submodel are usually on the logit scale, and the coefficients for the latency submodel are usually on the log scale. The printed output is a little confusing at first glance since the coefficients in the <span class="in">`est`</span> column are either untransformed (age, shape and scale parameters in the treatment group), exponentiated (scale and shape parameters in the control group), or inverse-logit transformed (theta). It may have been better to split the printed output into two sections — one for the incidence model, and the other for latency. Similar to how <span class="in">`mgcv`</span> gives separate output for the parametric and the spline effects.</span>
<span id="cb28-521"><a href="#cb28-521"></a></span>
<span id="cb28-522"><a href="#cb28-522"></a>The theta parameter is the intercept in the incidence submodel, with a true value of 4 on the logit scale, and therefore $P<span class="co">[</span><span class="ot">B = 1 | \text{age} = 0</span><span class="co">]</span> = 0.982$ (calling <span class="in">`plogis(4)`</span> in R or calculating $1 / (1 + \text{exp}(-4))$). The estimated value is 0.9802, or <span class="in">`qlogis(0.98025) = 3.904`</span> on the logit scale. The age coefficient is estimated to be -0.068 on the logit scale with the true value set to -0.07. This corresponds to an odds ratio of $\text{exp}(-0.06809) = 0.934$.</span>
<span id="cb28-523"><a href="#cb28-523"></a></span>
<span id="cb28-524"><a href="#cb28-524"></a>The shape parameter $\beta$ of the log-logistic distribution in the latency submodel is very close to the true value of 7. The <span class="in">`shape(trt)`</span> value is very close to the true value of 0, since $\beta$ is assumed to be the same in each arm.</span>
<span id="cb28-525"><a href="#cb28-525"></a></span>
<span id="cb28-526"><a href="#cb28-526"></a>The scale parameter $\alpha$ in the control group is very close (4.98) to the true value of 5. The coefficient for $\alpha$ in the treatment group — with the true value of 4 — can be derived by either 1) multiplying the alpha in the control group by <span class="in">`exp(scale(trt))`</span> (so $4.98067 \times 0.80340 \approx 4$), or 2) by adding these up on the log scale and exponentiating the result ($\text{exp}(\text{log}(4.98067) - 0.21891)$).</span>
<span id="cb28-527"><a href="#cb28-527"></a></span>
<span id="cb28-528"><a href="#cb28-528"></a><span class="fu">## Comparing arm-specific cumulative incidence estimates</span></span>
<span id="cb28-529"><a href="#cb28-529"></a></span>
<span id="cb28-530"><a href="#cb28-530"></a>This post could very well end now, but I already wrote the code for this section and I don't feel like making another post, so I've included just the plots here with minimal code. The full code for this section can be found <span class="co">[</span><span class="ot">here</span><span class="co">](https://github.com/ad1729/ad1729.github.io/blob/master/posts/simulating-survival-data-with-non-PH-and-cure/analyze-data.R)</span>.</span>
<span id="cb28-531"><a href="#cb28-531"></a></span>
<span id="cb28-532"><a href="#cb28-532"></a>Essentially, I'm simulating data with administrative censoring at three and twelve weeks, with a constant cure fraction of 30%, and visually comparing the derived cumulative incidence curves in each of the treatment and control groups from the survivor functions estimated via 1) a *Kaplan-Meier* fit, 2) a *stratified cox model*, 3) the *casebase* sampling approach described in <span class="co">[</span><span class="ot">this</span><span class="co">](https://doi.org/10.2202/1557-4679.1125)</span> paper and implemented in the <span class="co">[</span><span class="ot">`casebase` package</span><span class="co">](https://cran.r-project.org/web/packages/casebase/index.html)</span><span class="ot">[^4]</span>, and 4) a log-logistic mixture cure model with the treatment status as a variable in both the incidence and latency submodels.</span>
<span id="cb28-533"><a href="#cb28-533"></a></span>
<span id="cb28-534"><a href="#cb28-534"></a><span class="ot">[^4]: </span>which I find extra attractive because it supports fitting penalized splines via the <span class="in">`mgcv`</span> package</span>
<span id="cb28-535"><a href="#cb28-535"></a></span>
<span id="cb28-536"><a href="#cb28-536"></a>The following plot shows $\text{log}(-\text{log}({\hat{S}(t)}))$ vs $\text{log}(t)$ in the left panel, and $\text{log}(\hat{S}(t) / (1 - \hat{S}(t)))$ vs $\text{log}(t)$ in the right panel. The former is the log-minus-log-survival plot for assessing the proportional hazards assumption (parallel straight lines indicate a Weibull model may be a good fit), and the latter is the log-survival-odds plot for assessing the proportional odds assumption (straight parallel lines together imply a log-logistic AFT model). Chapter 7 from the third edition of the Kleinbaum and Klein book is a good reference on how to pick parametric models based on the information in these plots.</span>
<span id="cb28-537"><a href="#cb28-537"></a></span>
<span id="cb28-540"><a href="#cb28-540"></a><span class="in">```{r}</span></span>
<span id="cb28-541"><a href="#cb28-541"></a><span class="co">#| code-fold: true</span></span>
<span id="cb28-542"><a href="#cb28-542"></a></span>
<span id="cb28-543"><a href="#cb28-543"></a><span class="co"># very weird behaviour when seed is set to 43 here</span></span>
<span id="cb28-544"><a href="#cb28-544"></a><span class="co"># cure fraction ends up being 0 in the treatment group</span></span>
<span id="cb28-545"><a href="#cb28-545"></a><span class="co"># and 60% in the control group. Overall it's correct with value of 0.3</span></span>
<span id="cb28-546"><a href="#cb28-546"></a><span class="co"># this goes away by removing the set.seed(43) call before generating</span></span>
<span id="cb28-547"><a href="#cb28-547"></a><span class="co"># or using any other seed</span></span>
<span id="cb28-548"><a href="#cb28-548"></a><span class="fu">set.seed</span>(<span class="dv">49</span>)</span>
<span id="cb28-549"><a href="#cb28-549"></a>censored_and_cured_samples <span class="ot">&lt;-</span> loglogistic_samples <span class="sc">%&gt;%</span></span>
<span id="cb28-550"><a href="#cb28-550"></a>  <span class="fu">mutate</span>(</span>
<span id="cb28-551"><a href="#cb28-551"></a>    <span class="co"># add cure status and modify time distribution accordingly</span></span>
<span id="cb28-552"><a href="#cb28-552"></a>    <span class="at">latent =</span> time,</span>
<span id="cb28-553"><a href="#cb28-553"></a>    <span class="at">cured =</span> <span class="fu">rbinom</span>(<span class="fu">n</span>(), <span class="dv">1</span>, <span class="fl">0.3</span>),</span>
<span id="cb28-554"><a href="#cb28-554"></a>    <span class="at">time =</span> <span class="fu">ifelse</span>(cured <span class="sc">==</span> <span class="dv">1</span>, <span class="dv">10000</span>, time),</span>
<span id="cb28-555"><a href="#cb28-555"></a>    <span class="co"># add censoring indicator</span></span>
<span id="cb28-556"><a href="#cb28-556"></a>    <span class="at">time3 =</span> <span class="fu">pmin</span>(time, <span class="fl">3.0</span>),</span>
<span id="cb28-557"><a href="#cb28-557"></a>    <span class="at">cens3 =</span> <span class="fu">as.numeric</span>(time <span class="sc">&gt;</span> <span class="fl">3.0</span>),</span>
<span id="cb28-558"><a href="#cb28-558"></a>    <span class="at">event3 =</span> <span class="dv">1</span> <span class="sc">-</span> cens3,</span>
<span id="cb28-559"><a href="#cb28-559"></a>    <span class="at">time6 =</span> <span class="fu">pmin</span>(time, <span class="fl">6.0</span>),</span>
<span id="cb28-560"><a href="#cb28-560"></a>    <span class="at">cens6 =</span> <span class="fu">as.numeric</span>(time <span class="sc">&gt;</span> <span class="fl">6.0</span>),</span>
<span id="cb28-561"><a href="#cb28-561"></a>    <span class="at">event6 =</span> <span class="dv">1</span> <span class="sc">-</span> cens6,</span>
<span id="cb28-562"><a href="#cb28-562"></a>    <span class="at">time12 =</span> <span class="fu">pmin</span>(time, <span class="fl">12.0</span>),</span>
<span id="cb28-563"><a href="#cb28-563"></a>    <span class="at">cens12 =</span> <span class="fu">as.numeric</span>(time <span class="sc">&gt;</span> <span class="fl">12.0</span>),</span>
<span id="cb28-564"><a href="#cb28-564"></a>    <span class="at">event12 =</span> <span class="dv">1</span> <span class="sc">-</span> cens12,</span>
<span id="cb28-565"><a href="#cb28-565"></a>    <span class="fu">across</span>(<span class="fu">starts_with</span>(<span class="st">"event"</span>), as.integer)</span>
<span id="cb28-566"><a href="#cb28-566"></a>  )</span>
<span id="cb28-567"><a href="#cb28-567"></a></span>
<span id="cb28-568"><a href="#cb28-568"></a>twelve_weeks_data <span class="ot">&lt;-</span> censored_and_cured_samples <span class="sc">%&gt;%</span></span>
<span id="cb28-569"><a href="#cb28-569"></a>  <span class="fu">select</span>(<span class="at">group =</span> parameters, <span class="at">time =</span> time12, <span class="at">event =</span> event12)</span>
<span id="cb28-570"><a href="#cb28-570"></a></span>
<span id="cb28-571"><a href="#cb28-571"></a>three_weeks_data <span class="ot">&lt;-</span> censored_and_cured_samples <span class="sc">%&gt;%</span></span>
<span id="cb28-572"><a href="#cb28-572"></a>  <span class="fu">select</span>(<span class="at">group =</span> parameters, <span class="at">time =</span> time3, <span class="at">event =</span> event3)</span>
<span id="cb28-573"><a href="#cb28-573"></a></span>
<span id="cb28-574"><a href="#cb28-574"></a><span class="co"># plots for assessing the proportional hazards and proportional odds assumptions</span></span>
<span id="cb28-575"><a href="#cb28-575"></a>twelve_weeks_data <span class="sc">%&gt;%</span></span>
<span id="cb28-576"><a href="#cb28-576"></a>  <span class="fu">survfit2</span>(<span class="fu">Surv</span>(time, event, <span class="at">type =</span> <span class="st">"right"</span>) <span class="sc">~</span> group, <span class="at">data =</span> .) <span class="sc">%&gt;%</span></span>
<span id="cb28-577"><a href="#cb28-577"></a>  <span class="fu">tidy_survfit</span>(<span class="at">time =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">12</span>, <span class="fl">0.05</span>), <span class="at">type =</span> <span class="st">"survival"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb28-578"><a href="#cb28-578"></a>  <span class="fu">select</span>(time, strata, estimate) <span class="sc">%&gt;%</span></span>
<span id="cb28-579"><a href="#cb28-579"></a>  <span class="fu">mutate</span>(</span>
<span id="cb28-580"><a href="#cb28-580"></a>    <span class="at">lntime =</span> <span class="fu">log</span>(time),</span>
<span id="cb28-581"><a href="#cb28-581"></a>    <span class="st">`</span><span class="at">Log Minus Log Survival</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">log</span>(<span class="sc">-</span><span class="fu">log</span>(estimate)),</span>
<span id="cb28-582"><a href="#cb28-582"></a>    <span class="st">`</span><span class="at">Log Survival Odds</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">log</span>(estimate <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">-</span> estimate))</span>
<span id="cb28-583"><a href="#cb28-583"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb28-584"><a href="#cb28-584"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="fu">starts_with</span>(<span class="st">"Log "</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb28-585"><a href="#cb28-585"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> lntime, <span class="at">y =</span> value, <span class="at">color =</span> strata, <span class="at">group =</span> <span class="fu">interaction</span>(name, strata))) <span class="sc">+</span></span>
<span id="cb28-586"><a href="#cb28-586"></a>  <span class="fu">geom_step</span>() <span class="sc">+</span></span>
<span id="cb28-587"><a href="#cb28-587"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Log time"</span>, <span class="at">y =</span> <span class="st">""</span>) <span class="sc">+</span></span>
<span id="cb28-588"><a href="#cb28-588"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"gray20"</span>, <span class="st">"forestgreen"</span>)) <span class="sc">+</span></span>
<span id="cb28-589"><a href="#cb28-589"></a>  <span class="fu">coord_cartesian</span>(<span class="at">xlim =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="fl">0.5</span>, <span class="fl">2.5</span>)) <span class="sc">+</span></span>
<span id="cb28-590"><a href="#cb28-590"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"bottom"</span>, <span class="at">legend.title =</span> <span class="fu">element_blank</span>()) <span class="sc">+</span></span>
<span id="cb28-591"><a href="#cb28-591"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>name, <span class="at">scales =</span> <span class="st">"free_y"</span>)</span>
<span id="cb28-592"><a href="#cb28-592"></a><span class="in">```</span></span>
<span id="cb28-593"><a href="#cb28-593"></a></span>
<span id="cb28-594"><a href="#cb28-594"></a>The next figure shows the estimated curves from the different model overlaid on top of the true curve when analyzing data using the information available at twelve weeks. All the methods produce the same estimates and are nearly indistinguishable from the true curves.</span>
<span id="cb28-595"><a href="#cb28-595"></a></span>
<span id="cb28-598"><a href="#cb28-598"></a><span class="in">```{r}</span></span>
<span id="cb28-599"><a href="#cb28-599"></a><span class="co">#| code-fold: true</span></span>
<span id="cb28-600"><a href="#cb28-600"></a></span>
<span id="cb28-601"><a href="#cb28-601"></a><span class="fu">read_rds</span>(<span class="at">file =</span> <span class="st">"plot-data-12-weeks.rds"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb28-602"><a href="#cb28-602"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> CI_est, <span class="at">color =</span> group)) <span class="sc">+</span></span>
<span id="cb28-603"><a href="#cb28-603"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">linetype =</span> type, <span class="at">linewidth =</span> type)) <span class="sc">+</span></span>
<span id="cb28-604"><a href="#cb28-604"></a>  <span class="co"># add cure fraction line and text</span></span>
<span id="cb28-605"><a href="#cb28-605"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="fl">0.7</span>, <span class="at">color =</span> <span class="st">"gray40"</span>, <span class="at">linetype =</span> <span class="st">"solid"</span>) <span class="sc">+</span></span>
<span id="cb28-606"><a href="#cb28-606"></a>  <span class="fu">annotate</span>(<span class="at">geom =</span> <span class="st">"text"</span>, <span class="at">x =</span> <span class="fl">0.5</span>, <span class="at">y =</span> <span class="fl">0.76</span>, <span class="at">color =</span> <span class="st">"gray40"</span>,</span>
<span id="cb28-607"><a href="#cb28-607"></a>           <span class="at">label =</span> <span class="st">"Cure fraction of 70% in both groups"</span>, <span class="at">hjust =</span> <span class="st">"left"</span>) <span class="sc">+</span></span>
<span id="cb28-608"><a href="#cb28-608"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Time since product launch (in weeks)"</span>,</span>
<span id="cb28-609"><a href="#cb28-609"></a>       <span class="at">y =</span> <span class="st">"Cumulative incidence"</span>) <span class="sc">+</span></span>
<span id="cb28-610"><a href="#cb28-610"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"bottom"</span>, <span class="at">legend.title =</span> <span class="fu">element_blank</span>()) <span class="sc">+</span></span>
<span id="cb28-611"><a href="#cb28-611"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"gray20"</span>, <span class="st">"forestgreen"</span>)) <span class="sc">+</span></span>
<span id="cb28-612"><a href="#cb28-612"></a>  <span class="fu">scale_linetype_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"solid"</span>, <span class="st">"dotdash"</span>, <span class="st">"dashed"</span>, <span class="st">"dotted"</span>, <span class="st">"longdash"</span>)) <span class="sc">+</span></span>
<span id="cb28-613"><a href="#cb28-613"></a>  <span class="fu">scale_linewidth_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="fl">0.4</span>, <span class="fl">1.1</span>, <span class="fl">1.1</span>, <span class="fl">1.1</span>, <span class="fl">1.1</span>)) <span class="sc">+</span></span>
<span id="cb28-614"><a href="#cb28-614"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">12</span>, <span class="dv">1</span>)) <span class="sc">+</span></span>
<span id="cb28-615"><a href="#cb28-615"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">labels =</span> scales<span class="sc">::</span><span class="fu">label_percent</span>(), <span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="fl">0.2</span>)) <span class="sc">+</span></span>
<span id="cb28-616"><a href="#cb28-616"></a>  <span class="fu">coord_cartesian</span>(<span class="at">xlim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">12</span>), <span class="at">ylim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>)) <span class="sc">+</span></span>
<span id="cb28-617"><a href="#cb28-617"></a>  <span class="fu">guides</span>(</span>
<span id="cb28-618"><a href="#cb28-618"></a>    <span class="at">color =</span> <span class="fu">guide_legend</span>(<span class="at">nrow =</span> <span class="dv">2</span>),</span>
<span id="cb28-619"><a href="#cb28-619"></a>    <span class="at">linetype =</span> <span class="fu">guide_legend</span>(<span class="at">nrow =</span> <span class="dv">3</span>)</span>
<span id="cb28-620"><a href="#cb28-620"></a>  )</span>
<span id="cb28-621"><a href="#cb28-621"></a><span class="in">```</span></span>
<span id="cb28-622"><a href="#cb28-622"></a></span>
<span id="cb28-623"><a href="#cb28-623"></a>The true cumulative incidence curves are scaled from $<span class="co">[</span><span class="ot">0, 1</span><span class="co">]</span>$ to the interval $<span class="co">[</span><span class="ot">0, 0.7</span><span class="co">]</span>$ to correspond to a cure fraction of 0.3 using the <span class="co">[</span><span class="ot">usual rescaling formula</span><span class="co">](https://stats.stackexchange.com/questions/281162/scale-a-number-between-a-range)</span> for mapping $<span class="co">[</span><span class="ot">x_{\text{min}}, x_{\text{}max}</span><span class="co">]</span> \rightarrow <span class="co">[</span><span class="ot">a,b</span><span class="co">]</span>$ (with $a = 0$, $b = 0.7$, $x_{\text{max}} = 1$, $x_{\text{min}} = 0$, and $x$ the probability $P<span class="co">[</span><span class="ot">T \le t</span><span class="co">]</span>$ among the uncured)</span>
<span id="cb28-624"><a href="#cb28-624"></a></span>
<span id="cb28-625"><a href="#cb28-625"></a>$$</span>
<span id="cb28-626"><a href="#cb28-626"></a>x_{\text{normalized}} = a + (b - a) \frac{x - x_{\text{min}}}{x_{\text{max}} - x_{\text{min}}}</span>
<span id="cb28-627"><a href="#cb28-627"></a>$$</span>
<span id="cb28-628"><a href="#cb28-628"></a></span>
<span id="cb28-629"><a href="#cb28-629"></a>which just leads to multiplying the CDF in each group by 0.7.</span>
<span id="cb28-630"><a href="#cb28-630"></a></span>
<span id="cb28-631"><a href="#cb28-631"></a>Doing the analysis after three weeks shows some interesting results</span>
<span id="cb28-632"><a href="#cb28-632"></a></span>
<span id="cb28-635"><a href="#cb28-635"></a><span class="in">```{r}</span></span>
<span id="cb28-636"><a href="#cb28-636"></a><span class="co">#| code-fold: true</span></span>
<span id="cb28-637"><a href="#cb28-637"></a></span>
<span id="cb28-638"><a href="#cb28-638"></a>plot_data_three_weeks <span class="ot">&lt;-</span> <span class="fu">read_rds</span>(<span class="at">file =</span> <span class="st">"plot-data-3-weeks.rds"</span>)</span>
<span id="cb28-639"><a href="#cb28-639"></a></span>
<span id="cb28-640"><a href="#cb28-640"></a>plot_data_three_weeks <span class="sc">%&gt;%</span></span>
<span id="cb28-641"><a href="#cb28-641"></a>  <span class="fu">filter</span>(time <span class="sc">&lt;=</span> <span class="dv">3</span>) <span class="sc">%&gt;%</span></span>
<span id="cb28-642"><a href="#cb28-642"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> CI_est, <span class="at">color =</span> group)) <span class="sc">+</span></span>
<span id="cb28-643"><a href="#cb28-643"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">linetype =</span> type, <span class="at">linewidth =</span> type)) <span class="sc">+</span></span>
<span id="cb28-644"><a href="#cb28-644"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Time since product launch (in weeks)"</span>,</span>
<span id="cb28-645"><a href="#cb28-645"></a>       <span class="at">y =</span> <span class="st">"Cumulative incidence"</span>) <span class="sc">+</span></span>
<span id="cb28-646"><a href="#cb28-646"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"bottom"</span>, <span class="at">legend.title =</span> <span class="fu">element_blank</span>()) <span class="sc">+</span></span>
<span id="cb28-647"><a href="#cb28-647"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"gray20"</span>, <span class="st">"forestgreen"</span>)) <span class="sc">+</span></span>
<span id="cb28-648"><a href="#cb28-648"></a>  <span class="fu">scale_linetype_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"solid"</span>, <span class="st">"dotdash"</span>, <span class="st">"dashed"</span>, <span class="st">"dotted"</span>, <span class="st">"longdash"</span>)) <span class="sc">+</span></span>
<span id="cb28-649"><a href="#cb28-649"></a>  <span class="fu">scale_linewidth_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="fl">0.4</span>, <span class="fl">1.1</span>, <span class="fl">1.1</span>, <span class="fl">1.1</span>, <span class="fl">1.1</span>)) <span class="sc">+</span></span>
<span id="cb28-650"><a href="#cb28-650"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">3</span>, <span class="dv">1</span>)) <span class="sc">+</span></span>
<span id="cb28-651"><a href="#cb28-651"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">labels =</span> scales<span class="sc">::</span><span class="fu">label_percent</span>(), <span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="fl">0.1</span>, <span class="fl">0.02</span>)) <span class="sc">+</span></span>
<span id="cb28-652"><a href="#cb28-652"></a>  <span class="fu">guides</span>(</span>
<span id="cb28-653"><a href="#cb28-653"></a>    <span class="at">color =</span> <span class="fu">guide_legend</span>(<span class="at">nrow =</span> <span class="dv">2</span>),</span>
<span id="cb28-654"><a href="#cb28-654"></a>    <span class="at">linetype =</span> <span class="fu">guide_legend</span>(<span class="at">nrow =</span> <span class="dv">3</span>)</span>
<span id="cb28-655"><a href="#cb28-655"></a>  ) <span class="sc">+</span> </span>
<span id="cb28-656"><a href="#cb28-656"></a>  <span class="fu">coord_cartesian</span>(<span class="at">xlim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">3</span>), <span class="at">ylim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">0.1</span>))</span>
<span id="cb28-657"><a href="#cb28-657"></a><span class="in">```</span></span>
<span id="cb28-658"><a href="#cb28-658"></a></span>
<span id="cb28-659"><a href="#cb28-659"></a>All the curves are close. Facetting by estimator and plotting the pointwise confidence bands for week 2 shows that the mixture cure model runs into some difficulties</span>
<span id="cb28-660"><a href="#cb28-660"></a></span>
<span id="cb28-663"><a href="#cb28-663"></a><span class="in">```{r}</span></span>
<span id="cb28-664"><a href="#cb28-664"></a><span class="co">#| code-fold: true</span></span>
<span id="cb28-665"><a href="#cb28-665"></a></span>
<span id="cb28-666"><a href="#cb28-666"></a>plot_data_three_weeks <span class="sc">%&gt;%</span></span>
<span id="cb28-667"><a href="#cb28-667"></a>  <span class="fu">filter</span>(time <span class="sc">&lt;=</span> <span class="dv">3</span>, type <span class="sc">!=</span> <span class="st">"Truth"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb28-668"><a href="#cb28-668"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> CI_est)) <span class="sc">+</span></span>
<span id="cb28-669"><a href="#cb28-669"></a>  <span class="co"># plot the true line on each panel</span></span>
<span id="cb28-670"><a href="#cb28-670"></a>  <span class="fu">geom_line</span>(</span>
<span id="cb28-671"><a href="#cb28-671"></a>    <span class="at">data =</span> {</span>
<span id="cb28-672"><a href="#cb28-672"></a>      plot_data_three_weeks <span class="sc">%&gt;%</span></span>
<span id="cb28-673"><a href="#cb28-673"></a>        <span class="fu">filter</span>(type <span class="sc">==</span> <span class="st">"Truth"</span>, time <span class="sc">&lt;=</span> <span class="dv">3</span>) <span class="sc">%&gt;%</span></span>
<span id="cb28-674"><a href="#cb28-674"></a>        <span class="fu">select</span>(<span class="sc">-</span>type)</span>
<span id="cb28-675"><a href="#cb28-675"></a>    },</span>
<span id="cb28-676"><a href="#cb28-676"></a>    <span class="at">inherit.aes =</span> <span class="cn">FALSE</span>,</span>
<span id="cb28-677"><a href="#cb28-677"></a>    <span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> CI_est, <span class="at">group =</span> group, <span class="at">color =</span> group),</span>
<span id="cb28-678"><a href="#cb28-678"></a>    <span class="at">linetype =</span> <span class="st">"solid"</span>, <span class="at">linewidth =</span> <span class="dv">1</span></span>
<span id="cb28-679"><a href="#cb28-679"></a>  ) <span class="sc">+</span></span>
<span id="cb28-680"><a href="#cb28-680"></a>  <span class="co"># plot estimated curves and their confidence intervals</span></span>
<span id="cb28-681"><a href="#cb28-681"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">color =</span> group), <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">linewidth =</span> <span class="fl">1.1</span>) <span class="sc">+</span></span>
<span id="cb28-682"><a href="#cb28-682"></a>  <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> CI_lcl, <span class="at">ymax =</span> CI_ucl, </span>
<span id="cb28-683"><a href="#cb28-683"></a>                  <span class="at">color =</span> group, <span class="at">fill =</span> group), <span class="at">alpha =</span> <span class="fl">0.3</span>) <span class="sc">+</span></span>
<span id="cb28-684"><a href="#cb28-684"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Time since product launch (in weeks)"</span>,</span>
<span id="cb28-685"><a href="#cb28-685"></a>       <span class="at">y =</span> <span class="st">"Cumulative incidence"</span>) <span class="sc">+</span></span>
<span id="cb28-686"><a href="#cb28-686"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"bottom"</span>, <span class="at">legend.title =</span> <span class="fu">element_blank</span>()) <span class="sc">+</span></span>
<span id="cb28-687"><a href="#cb28-687"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"gray20"</span>, <span class="st">"forestgreen"</span>)) <span class="sc">+</span></span>
<span id="cb28-688"><a href="#cb28-688"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"gray20"</span>, <span class="st">"forestgreen"</span>)) <span class="sc">+</span></span>
<span id="cb28-689"><a href="#cb28-689"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">2</span>, <span class="dv">3</span>, <span class="fl">0.2</span>)) <span class="sc">+</span></span>
<span id="cb28-690"><a href="#cb28-690"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">labels =</span> scales<span class="sc">::</span><span class="fu">label_percent</span>(), </span>
<span id="cb28-691"><a href="#cb28-691"></a>                     <span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="fl">0.1</span>, <span class="fl">0.02</span>)) <span class="sc">+</span></span>
<span id="cb28-692"><a href="#cb28-692"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>type) <span class="sc">+</span></span>
<span id="cb28-693"><a href="#cb28-693"></a>  <span class="fu">coord_cartesian</span>(<span class="at">xlim =</span> <span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">3</span>), <span class="at">ylim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">0.1</span>))</span>
<span id="cb28-694"><a href="#cb28-694"></a><span class="in">```</span></span>
<span id="cb28-695"><a href="#cb28-695"></a></span>
<span id="cb28-696"><a href="#cb28-696"></a>In this case, based on the lack of plateauing of the KM fit at three weeks, assuming a cure model would not be justifiable, so one of the other three methods used here are probably better for estimating the CIC. At twelve weeks, the KM (or the CIC) curves have plateaued so a cure model might be a decent option, and the parameters of the mixture cure model can be identified.</span>
<span id="cb28-697"><a href="#cb28-697"></a></span>
<span id="cb28-698"><a href="#cb28-698"></a>Finally, I'm going to end this post with an interesting quote I came across in the Hanley and Miettinen paper from the inventor of the highly popular Cox model preferring to use a parametric model over the semi-parametric Cox model</span>
<span id="cb28-699"><a href="#cb28-699"></a></span>
<span id="cb28-700"><a href="#cb28-700"></a><span class="at">&gt; Particularly notable are Cox’s own reflections (Reid, 1994) on the uses of his model:\</span></span>
<span id="cb28-701"><a href="#cb28-701"></a><span class="at">&gt; \</span></span>
<span id="cb28-702"><a href="#cb28-702"></a><span class="at">&gt; **Reid:** How do you feel about the cottage industry that’s grown up around it </span><span class="sc">\[</span><span class="at">the Cox model</span><span class="sc">\]</span><span class="at">?</span></span>
<span id="cb28-703"><a href="#cb28-703"></a><span class="at">&gt;</span></span>
<span id="cb28-704"><a href="#cb28-704"></a><span class="at">&gt; **Cox:** Don’t know, really. In the light of some of the further results one knows since, I think I would normally want to tackle problems parametrically, so I would take the underlying hazard to be a Weibull or something. I’m not keen on nonparametric formulations usually.</span></span>
<span id="cb28-705"><a href="#cb28-705"></a><span class="at">&gt;</span></span>
<span id="cb28-706"><a href="#cb28-706"></a><span class="at">&gt; **Reid:** So if you had a set of censored survival data today, you might rather fit a parametric model, even though there was a feeling among the medical statisticians that that wasn’t quite right.</span></span>
<span id="cb28-707"><a href="#cb28-707"></a><span class="at">&gt;</span></span>
<span id="cb28-708"><a href="#cb28-708"></a><span class="at">&gt; **Cox:** That’s right, but since then various people have shown that the answers are very insensitive to the parametric formulation of the underlying distribution </span><span class="sc">\[</span><span class="at">see, e.g., Cox and Oakes, Analysis of Survival Data, Chapter 8.5</span><span class="sc">\]</span><span class="at">. And if you want to do things like predict the outcome for a particular patient, it’s much more convenient to do that parametrically.</span></span>
<span id="cb28-709"><a href="#cb28-709"></a></span>
<span id="cb28-710"><a href="#cb28-710"></a><span class="fu">## References</span></span>
<span id="cb28-711"><a href="#cb28-711"></a></span>
<span id="cb28-712"><a href="#cb28-712"></a><span class="ss">-   </span>Bender, R., Augustin, T. and Blettner, M. (2005), Generating survival times to simulate Cox proportional hazards models. Statist. Med., 24: 1713-1723. <span class="ot">&lt;https://doi.org/10.1002/sim.2059&gt;</span></span>
<span id="cb28-713"><a href="#cb28-713"></a></span>
<span id="cb28-714"><a href="#cb28-714"></a><span class="ss">-   </span>Crowther, M.J. and Lambert, P.C. (2013), Simulating biologically plausible complex survival data. Statist. Med., 32: 4118-4134. <span class="ot">&lt;https://doi.org/10.1002/sim.5823&gt;</span></span>
<span id="cb28-715"><a href="#cb28-715"></a></span>
<span id="cb28-716"><a href="#cb28-716"></a><span class="ss">-   </span>Al-Shomrani, A.A., Shawky, A.I., Arif, O.H. *et al.* Log-logistic distribution for survival data analysis using MCMC. *SpringerPlus* **5**, 1774 (2016). <span class="ot">&lt;https://doi.org/10.1186/s40064-016-3476-7&gt;</span></span>
<span id="cb28-717"><a href="#cb28-717"></a></span>
<span id="cb28-718"><a href="#cb28-718"></a><span class="ss">-   </span>Lambert, P. C. (2007). Modeling of the Cure Fraction in Survival Studies. *The Stata Journal*, *7*(3), 351-375. <span class="ot">&lt;https://doi.org/10.1177/1536867X0700700304&gt;</span></span>
<span id="cb28-719"><a href="#cb28-719"></a></span>
<span id="cb28-720"><a href="#cb28-720"></a><span class="ss">-   </span>Amico, M. and Van Keilegom, I. (2018). Cure Models in Survival Analysis. *Annual Review of Statistics and Its Application,* Vol. 5:311-342.\</span>
<span id="cb28-721"><a href="#cb28-721"></a>    <span class="ot">&lt;https://doi.org/10.1146/annurev-statistics-031017-100101&gt;</span></span>
<span id="cb28-722"><a href="#cb28-722"></a></span>
<span id="cb28-723"><a href="#cb28-723"></a><span class="ss">-   </span>Legrand, C. and Bertrand, A. (2019). Cure Models in Oncology Clinical Trials. (Seems to be a book chapter from <span class="co">[</span><span class="ot">this book</span><span class="co">](https://www.taylorfrancis.com/chapters/edit/10.1201/9781315112084-22/cure-models-cancer-clinical-trials-catherine-legrand-aur%C3%A9lie-bertrand)</span>. Non-paywalled link <span class="co">[</span><span class="ot">here</span><span class="co">](https://dial.uclouvain.be/pr/boreal/object/boreal%3A220045/datastream/PDF_02/view)</span>.)</span>
<span id="cb28-724"><a href="#cb28-724"></a></span>
<span id="cb28-725"><a href="#cb28-725"></a><span class="ss">-   </span>Kleinbaum, D.G. and Klein, M. (2012) Survival Analysis: A Self-Learning Text. 3rd Edition, Springer, New York.<span class="co">[</span><span class="ot">https://doi.org/10.1007/978-1-4419-6646-9</span><span class="co">](#0)</span></span>
<span id="cb28-726"><a href="#cb28-726"></a></span>
<span id="cb28-727"><a href="#cb28-727"></a><span class="ss">-   </span>Hanley, J. &amp; Miettinen, O. (2009). Fitting Smooth-in-Time Prognostic Risk Functions via Logistic Regression. *The International Journal of Biostatistics*, *5*(1). <span class="ot">&lt;https://doi.org/10.2202/1557-4679.1125&gt;</span></span>
</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
      &nbsp;
    </div>   
    <div class="nav-footer-center">
<p>akshat.blog © 2022-2025 Akshat Dwivedi. Built with <a href="https://www.quarto.org">Quarto</a> and <a href="https://pages.github.com">GitHub Pages</a>. Read the <a href="https://github.com/ad1729/ad1729.github.io/LICENSE.md">license.</a></p>
<div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/ad1729/ad1729.github.io/issues/new" class="toc-action"><i class="bi bi-github"></i>Report an issue</a></li></ul></div></div>
    <div class="nav-footer-right">
      &nbsp;
    </div>
  </div>
</footer>




<script src="../../site_libs/quarto-html/zenscroll-min.js"></script>
</body></html>