<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.340">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="dcterms.date" content="2024-02-09">

<title>Akshat Dwivedi - Using an obscure causal inference method to estimate treatment effects with the help of another less obscure causal inference method</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<link href="../../favicon.png" rel="icon" type="image/png">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="../../site_libs/bootstrap/bootstrap-dark.min.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Akshat Dwivedi</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../about.html" rel="" target="">
 <span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/ad1729" rel="" target=""><i class="bi bi-github" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://www.linkedin.com/in/akshatd/" rel="" target=""><i class="bi bi-linkedin" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://500px.com/p/akshatdwivedi?view=photos" rel="" target=""><i class="bi bi-images" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
</ul>
            <div class="quarto-navbar-tools">
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
</div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <div class="quarto-title-block"><div><h1 class="title">Using an obscure causal inference method to estimate treatment effects with the help of another less obscure causal inference method</h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li><li><hr class="dropdown-divider"></li><li><a id="quarto-view-source" class="dropdown-item" href="javascript:void(0)" role="button">View Source</a></li></ul></div></div>
                                <div class="quarto-categories">
                <div class="quarto-category">Causal Inference</div>
                <div class="quarto-category">Instrumental Variables</div>
                <div class="quarto-category">G-estimation</div>
                <div class="quarto-category">G-computation</div>
                <div class="quarto-category">GEE</div>
                <div class="quarto-category">R</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">February 9, 2024</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active" data-toc-expanded="99">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction">Introduction</a></li>
  <li><a href="#parameter-of-interest" id="toc-parameter-of-interest" class="nav-link" data-scroll-target="#parameter-of-interest">Parameter of interest</a></li>
  <li><a href="#g-estimation-in-a-nutshell" id="toc-g-estimation-in-a-nutshell" class="nav-link" data-scroll-target="#g-estimation-in-a-nutshell">G-estimation in a nutshell</a></li>
  <li><a href="#g-estimation-with-an-iv" id="toc-g-estimation-with-an-iv" class="nav-link" data-scroll-target="#g-estimation-with-an-iv">G-estimation with an IV</a></li>
  <li><a href="#estimating-probabilities" id="toc-estimating-probabilities" class="nav-link" data-scroll-target="#estimating-probabilities">Estimating probabilities</a></li>
  <li><a href="#references" id="toc-references" class="nav-link" data-scroll-target="#references">References</a></li>
  <li><a href="#simulated-data" id="toc-simulated-data" class="nav-link" data-scroll-target="#simulated-data">Simulated data</a></li>
  </ul>
<div class="toc-actions"><div><i class="bi bi-github"></i></div><div class="action-links"><p><a href="https://github.com/ad1729/ad1729.github.io/issues/new" class="toc-action">Report an issue</a></p></div></div></nav>
    </div>
<!-- main -->
<main class="content quarto-banner-title-block page-columns page-full" id="quarto-document-content">




<section id="introduction" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="introduction">Introduction</h2>
<p>In a <a href="../../posts/instrumental-variable-in-RCT/index.html">previous post</a>, I used the <em>ratio estimator</em> and the method of <em>instrumental variables</em> (IV) to estimate the effect of showing an ad on sales from a fictitious ad campaign.</p>
<div class="page-columns page-full"><p>This post uses the lesser-known method of <em>g-estimation</em><a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a> to estimate the effect of a continuous exposure variable in a <em>multiplicative structural mean model</em> (MSMM) by using the randomization indicator as an instrumental variable to obtain valid treatment effect estimates in the presence of unmeasured confounding.</p><div class="no-row-height column-margin column-container"><li id="fn1"><p><sup>1</sup>&nbsp;less popular compared to IPTW and PSM, hence the clickbait-y title</p></li></div></div>
<div class="page-columns page-full"><p>As mentioned towards the end of the previous post, analyzing the treated individuals by collapsing them into a single ‘treated’ group was a simplification. The observed treatment variable would in reality be the number of impressions of the ad — naturally varying between individuals in the treated group, but zero among the individuals assigned to the control group and among the <em>never-takers</em><a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a>.</p><div class="no-row-height column-margin column-container"><li id="fn2"><p><sup>2</sup>&nbsp;i.e., people who would not take the treatment if assigned to the treatment group. <em>Defiers</em> and <em>always-takers</em> aren’t possible as individuals in the control group cannot see an ad, because compliance in the control arm is ensured by design.</p></li></div></div>
</section>
<section id="parameter-of-interest" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="parameter-of-interest">Parameter of interest</h2>
<p>If <span class="math inline">\(U\)</span> indicates the (possibly multivalued) set of unmeasured confounders, <span class="math inline">\(Z\)</span> the binary randomization variable indicating group assignment (treatment or control), <span class="math inline">\(A\)</span> the integral exposure variable indicating observed treatment level <span class="math inline">\(a\)</span> in <span class="math inline">\(\{0, 1, 2, … \}\)</span>, then an estimand or parameter of interest is the marginal <em>causal risk ratio</em> (CRR)</p>
<p><span class="math display">\[
\text{ATE} = \frac{\text{Pr}[Y^{a + 1} = 1]}{\text{Pr}[Y^{a} = 1]}
\]</span><br>
This is usually the target of inference in an experiment with perfect compliance, and corresponds to setting the treatment level to <span class="math inline">\(A = a + 1\)</span> vs <span class="math inline">\(A = a\)</span> for the full population (<span class="math inline">\(Y^a\)</span> denotes the potential outcome under treatment level <span class="math inline">\(a\)</span>).</p>
<p>Another estimand of interest may be the <em>average treatment effect in the treated</em> (ATT) or the <em>effect of the treatment on the treated</em> (ETT). This compares the treated individuals to the <em>counterfactual scenario had they not been treated</em>. This corresponds to <span class="math display">\[
\text{ATT} = \frac{\text{Pr}[Y^a = 1 | A = a]}{\text{Pr}[Y^{a = 0} = 1 | A = a]}
\]</span></p>
<p>In a setting with noncompliance (possibly due to unmeasured confounding), the estimand can be further conditioned on the IV <span class="math inline">\(Z\)</span></p>
<p><span class="math display">\[
\text{ATT}_{IV} = \frac{\text{Pr}[Y^a = 1 | A = a, Z]}{\text{Pr}[Y^{a = 0} = 1 | A = a, Z]}
\]</span></p>
<p>The main MSMM used in this post estimates the ATE if the unmeasured confounders <span class="math inline">\(U\)</span> are <em>not effect-measure modifiers</em> (i.e., the impact of treatment <span class="math inline">\(A\)</span> on the ratio scale is the same on <span class="math inline">\(Y\)</span> at all levels of <span class="math inline">\(U\)</span>). If <span class="math inline">\(U\)</span> is an effect modifier, but <span class="math inline">\(Z\)</span> is not, then the MSMM estimate can be interpreted as the <span class="math inline">\(\text{ATT}_{IV}\)</span>.</p>
<p>Pages 2-3 of <a href="https://projecteuclid.org/journals/statistical-science/volume-26/issue-3/On-Instrumental-Variables-Estimation-of-Causal-Odds-Ratios/10.1214/11-STS360.full">this paper</a> provide a concise yet illuminating discussion of the different effect measures that can be of interest.</p>
<div class="page-columns page-full"><p>Since risk ratios are <em>collapsible</em> (see <a href="https://onlinelibrary.wiley.com/doi/full/10.1002/bimj.201900297">this excellent paper</a>), the (confounder-adjusted) marginal and conditional estimands are identical<a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a>.</p><div class="no-row-height column-margin column-container"><li id="fn3"><p><sup>3</sup>&nbsp;which is only the case for risk differences and risk ratios.</p></li></div></div>
<p>Before writing any code, the main packages used in this post are attached.</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1"></a><span class="fu">library</span>(tidyverse)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>── Attaching core tidyverse packages ──────────────────────── tidyverse 2.0.0 ──
✔ dplyr     1.1.2     ✔ readr     2.1.4
✔ forcats   1.0.0     ✔ stringr   1.5.0
✔ ggplot2   3.4.2     ✔ tibble    3.2.1
✔ lubridate 1.9.2     ✔ tidyr     1.3.0
✔ purrr     1.0.1     
── Conflicts ────────────────────────────────────────── tidyverse_conflicts() ──
✖ dplyr::filter() masks stats::filter()
✖ dplyr::lag()    masks stats::lag()
ℹ Use the conflicted package (&lt;http://conflicted.r-lib.org/&gt;) to force all conflicts to become errors</code></pre>
</div>
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1"></a><span class="fu">library</span>(broom, <span class="at">include.only =</span> <span class="st">"tidy"</span>)</span>
<span id="cb3-2"><a href="#cb3-2"></a></span>
<span id="cb3-3"><a href="#cb3-3"></a><span class="co"># functions from the following packages are called via package::fun()</span></span>
<span id="cb3-4"><a href="#cb3-4"></a><span class="co"># to reduce namespace conflicts</span></span>
<span id="cb3-5"><a href="#cb3-5"></a><span class="co"># library(geeM)</span></span>
<span id="cb3-6"><a href="#cb3-6"></a><span class="co"># library(mgcv)</span></span>
<span id="cb3-7"><a href="#cb3-7"></a><span class="co"># library(ivtools)</span></span>
<span id="cb3-8"><a href="#cb3-8"></a><span class="co"># library(marginaleffects)</span></span>
<span id="cb3-9"><a href="#cb3-9"></a><span class="co"># library(glue)</span></span>
<span id="cb3-10"><a href="#cb3-10"></a><span class="co"># library(gridExtra)</span></span>
<span id="cb3-11"><a href="#cb3-11"></a></span>
<span id="cb3-12"><a href="#cb3-12"></a><span class="fu">theme_set</span>(<span class="fu">theme_bw</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="g-estimation-in-a-nutshell" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="g-estimation-in-a-nutshell">G-estimation in a nutshell</h2>
<div class="page-columns page-full"><p>The first time I read the chapter on g-estimation in the what-if book, it went over my head completely<a href="#fn4" class="footnote-ref" id="fnref4" role="doc-noteref"><sup>4</sup></a>. Conceptually, it seemed harder than the more popular (g-)methods of <em>g-computation</em> and <em>inverse probability of treatment weighting</em> (IPTW). However, its superiority to g-computation in terms of not being prone to bias due to extrapolation, superiority to IPTW<a href="#fn5" class="footnote-ref" id="fnref5" role="doc-noteref"><sup>5</sup></a> in terms of having less variability (and bias), and relative ease of handling continuous exposures (and continuous instruments) piqued my curiosity<a href="#fn6" class="footnote-ref" id="fnref6" role="doc-noteref"><sup>6</sup></a>.</p><div class="no-row-height column-margin column-container"><li id="fn4"><p><sup>4</sup>&nbsp;May have had something to do with the fact that I was attempting this at 3 AM in between sleep cycles.</p></li><li id="fn5"><p><sup>5</sup>&nbsp;I think this isn’t an issue if <em>overlap</em> (ATO) weights are used instead of the usual ATE weights, as g-estimation gives higher weight to strata with greater overlap, and empty strata don’t contribute to the final estimate.</p></li><li id="fn6"><p><sup>6</sup>&nbsp;I’m basing this on the Dukes, Vansteelandt paper.</p></li></div></div>
<p>Another advantage is that there’s no need to correctly model the relationship between the confounders <span class="math inline">\(U\)</span> and the outcome <span class="math inline">\(Y\)</span> for the correct estimation of the treatment effect. This would not be the case when using (<em>log-)binomial</em> or <em>poisson</em> regression, where misspecification of the <span class="math inline">\(U-Y\)</span> relationship can bias the estimate for <span class="math inline">\(A\)</span>.</p>
<div class="page-columns page-full"><p>The essence of g-estimation is simple<a href="#fn7" class="footnote-ref" id="fnref7" role="doc-noteref"><sup>7</sup></a> – once the true effect of the treatment <span class="math inline">\(\psi\)</span> is shaved off from the response variable <span class="math inline">\(Y\)</span>, the residuals <span class="math inline">\(H(\psi) = Y - \psi A = Y^{a = 0}\)</span> should be uncorrelated with the treatment <span class="math inline">\(A\)</span> in the confounder-adjusted propensity model, i.e., <span class="math inline">\(\text{Cov}(A, H(\psi) | U) = 0\)</span><a href="#fn8" class="footnote-ref" id="fnref8" role="doc-noteref"><sup>8</sup></a>. This is the same as picking the value of <span class="math inline">\(\psi\)</span> that leads to <span class="math inline">\(\alpha_1 = 0\)</span> in <span class="math inline">\(\mathbb{E}[A | Y^{a=0}, U] = \alpha_0 + \alpha_1 H(\psi) + \sum_{j=2}^k \alpha_j U_{j-1}\)</span><a href="#fn9" class="footnote-ref" id="fnref9" role="doc-noteref"><sup>9</sup></a>. For MSMMs, <span class="math inline">\(H(\psi) = Y \text{exp}(- \psi A)\)</span> is used where <span class="math inline">\(\psi\)</span> is the risk ratio on the log scale.</p><div class="no-row-height column-margin column-container"><li id="fn7"><p><sup>7</sup>&nbsp;after having grasped it that is</p></li><li id="fn8"><p><sup>8</sup>&nbsp;Cov denotes <em>covariance.</em></p></li><li id="fn9"><p><sup>9</sup>&nbsp;For a binary exposure variable, the <span class="math inline">\(\mathbb{E}[A]\)</span> is replaced by <span class="math inline">\(\text{logit(Pr[A = 1])}\)</span>, where <span class="math inline">\(\text{logit}(p) = \text{log}\Big(\frac{p}{1-p}\Big)\)</span> and <span class="math inline">\(p\)</span> is the probability <span class="math inline">\(\text{Pr}[A = 1]\)</span>.</p></li></div></div>
<p>This works because of the <em>conditional mean independence</em> assumption — that the exposed and unexposed individuals are exchangeable within levels of <span class="math inline">\(U\)</span> (i.e., <span class="math inline">\(Y^{a = 0} \perp\!\!\!\perp A|U\)</span>) as would be the case for a conditionally randomized experiment. In a marginally randomized experiment, the treatment assigned and received is independent of the potential outcomes, which would not be the case if people with (say) higher levels of <span class="math inline">\(U\)</span> were more likely to take the treatment (<span class="math inline">\(A &gt; 0\)</span>) and have a positive outcome <span class="math inline">\(Y = 1\)</span>. In this scenario, it wouldn’t be possible to say whether it was <span class="math inline">\(A\)</span> or <span class="math inline">\(U\)</span> causing better outcomes. This <em>lack-of-identification</em> is due to confounding between the effect of <span class="math inline">\(U\)</span> on <span class="math inline">\(Y\)</span> and the effect of <span class="math inline">\(A\)</span> on <span class="math inline">\(Y\)</span>.</p>
<p>Suppose the following dataset is available (with a true CRR value of 1.02, 70% treatment-control split, and 40% non-compliance (never-takers))</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1"></a>simulate_data <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">seed =</span> <span class="dv">24</span>, <span class="at">n =</span> <span class="fl">1e5</span>) {</span>
<span id="cb4-2"><a href="#cb4-2"></a>  </span>
<span id="cb4-3"><a href="#cb4-3"></a>  confounder_values <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="fl">1e5</span>, <span class="dv">50</span>) <span class="sc">/</span> <span class="fl">1e4</span></span>
<span id="cb4-4"><a href="#cb4-4"></a>  </span>
<span id="cb4-5"><a href="#cb4-5"></a>  <span class="fu">set.seed</span>(seed)</span>
<span id="cb4-6"><a href="#cb4-6"></a>  <span class="fu">tibble</span>(</span>
<span id="cb4-7"><a href="#cb4-7"></a>    <span class="at">id =</span> <span class="dv">1</span><span class="sc">:</span>n,</span>
<span id="cb4-8"><a href="#cb4-8"></a>    <span class="co"># randomization indicator / instrument, indicates group assignment</span></span>
<span id="cb4-9"><a href="#cb4-9"></a>    <span class="at">Z =</span> <span class="fu">rbinom</span>(n, <span class="dv">1</span>, <span class="at">prob =</span> <span class="fl">0.7</span>),</span>
<span id="cb4-10"><a href="#cb4-10"></a>    <span class="co"># simulate continuous confounder value</span></span>
<span id="cb4-11"><a href="#cb4-11"></a>    <span class="at">U =</span> <span class="fu">sample</span>(<span class="at">x =</span> confounder_values, <span class="at">size =</span> n, <span class="at">replace =</span> <span class="cn">TRUE</span>),</span>
<span id="cb4-12"><a href="#cb4-12"></a>    <span class="co"># simulate (conditional) compliance indicator</span></span>
<span id="cb4-13"><a href="#cb4-13"></a>    <span class="at">prob_C =</span> <span class="fu">plogis</span>(<span class="dv">2</span> <span class="sc">-</span> <span class="fl">0.5</span> <span class="sc">*</span> U),</span>
<span id="cb4-14"><a href="#cb4-14"></a>    <span class="at">C =</span> <span class="fu">rbinom</span>(n, <span class="dv">1</span>, prob_C),</span>
<span id="cb4-15"><a href="#cb4-15"></a>    <span class="co"># simulate observed treatment</span></span>
<span id="cb4-16"><a href="#cb4-16"></a>    <span class="co"># potential continuous exposure value is simulated </span></span>
<span id="cb4-17"><a href="#cb4-17"></a>    <span class="co"># for each individual on [1, 100]</span></span>
<span id="cb4-18"><a href="#cb4-18"></a>    <span class="co"># but for those that have Z = 0 (control) or C = 0 (never-takers), A = 0</span></span>
<span id="cb4-19"><a href="#cb4-19"></a>    <span class="at">A =</span> Z <span class="sc">*</span> C <span class="sc">*</span> <span class="fu">pmin</span>(<span class="fu">pmax</span>(<span class="fu">round</span>(<span class="fu">rgamma</span>(n, <span class="at">shape =</span> <span class="dv">5</span>, <span class="at">scale =</span> <span class="dv">4</span>)), <span class="dv">1</span>), <span class="dv">100</span>),</span>
<span id="cb4-20"><a href="#cb4-20"></a>    <span class="co"># response variable simulated with risk ratios specified</span></span>
<span id="cb4-21"><a href="#cb4-21"></a>    <span class="co"># baseline log probabilities</span></span>
<span id="cb4-22"><a href="#cb4-22"></a>    <span class="at">logpY0 =</span> <span class="fu">log</span>(<span class="fl">0.002</span>) <span class="sc">+</span> <span class="fu">log</span>(<span class="fl">1.4</span>) <span class="sc">*</span> U,</span>
<span id="cb4-23"><a href="#cb4-23"></a>    <span class="co"># impact of treatment</span></span>
<span id="cb4-24"><a href="#cb4-24"></a>    <span class="at">logpY1 =</span> logpY0 <span class="sc">+</span> <span class="fu">log</span>(<span class="fl">1.02</span>) <span class="sc">*</span> A,</span>
<span id="cb4-25"><a href="#cb4-25"></a>    <span class="co"># simulated binary responses from log-binomial model</span></span>
<span id="cb4-26"><a href="#cb4-26"></a>    <span class="at">Y =</span> <span class="fu">rbinom</span>(n, <span class="dv">1</span>, <span class="fu">exp</span>(logpY1))</span>
<span id="cb4-27"><a href="#cb4-27"></a>  )</span>
<span id="cb4-28"><a href="#cb4-28"></a>}</span>
<span id="cb4-29"><a href="#cb4-29"></a></span>
<span id="cb4-30"><a href="#cb4-30"></a>df_large <span class="ot">&lt;-</span> <span class="fu">simulate_data</span>() <span class="sc">%&gt;%</span></span>
<span id="cb4-31"><a href="#cb4-31"></a>  <span class="fu">glimpse</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 100,000
Columns: 9
$ id     &lt;int&gt; 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, …
$ Z      &lt;int&gt; 1, 1, 0, 1, 1, 0, 1, 0, 0, 1, 1, 1, 1, 1, 1, 0, 1, 1, 1, 1, 1, …
$ U      &lt;dbl&gt; 2.795, 5.120, 4.930, 1.090, 3.675, 7.735, 8.770, 8.085, 4.780, …
$ prob_C &lt;dbl&gt; 0.64622806, 0.36354746, 0.38580036, 0.81076675, 0.54053584, 0.1…
$ C      &lt;int&gt; 1, 0, 0, 1, 1, 0, 0, 0, 1, 1, 0, 1, 0, 0, 0, 0, 1, 0, 1, 0, 1, …
$ A      &lt;dbl&gt; 23, 0, 0, 21, 20, 0, 0, 0, 0, 24, 0, 24, 0, 0, 0, 0, 10, 0, 21,…
$ logpY0 &lt;dbl&gt; -5.274168, -4.491870, -4.555800, -5.847853, -4.978073, -3.61199…
$ logpY1 &lt;dbl&gt; -4.818708, -4.491870, -4.555800, -5.431998, -4.582020, -3.61199…
$ Y      &lt;int&gt; 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, …</code></pre>
</div>
</div>
<p>For exploring g-estimation with no-unmeasured confounding (since <span class="math inline">\(U\)</span> is measured) in the simple model represented by the <em>directed acyclic graph</em> (DAG) <span class="math inline">\(A \leftarrow U \rightarrow Y\)</span> and <span class="math inline">\(A \rightarrow Y\)</span>, one way of estimating the treatment effect <span class="math inline">\(\psi\)</span> is using <em>grid search</em> which visually looks like this when the estimated coefficient for <span class="math inline">\(\alpha_1\)</span> is plotted on the Y-axis</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1"></a>grid_search_coefficient <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="sc">-</span><span class="dv">1</span>, <span class="dv">1</span>, <span class="fl">0.05</span>) <span class="sc">%&gt;%</span></span>
<span id="cb6-2"><a href="#cb6-2"></a>  <span class="co"># get the coefficient from the correct and incorrect propensity models</span></span>
<span id="cb6-3"><a href="#cb6-3"></a>  <span class="fu">map_dfr</span>(<span class="at">.f =</span> <span class="sc">~</span> {</span>
<span id="cb6-4"><a href="#cb6-4"></a></span>
<span id="cb6-5"><a href="#cb6-5"></a>    temp_df <span class="ot">&lt;-</span> df_large <span class="sc">%&gt;%</span></span>
<span id="cb6-6"><a href="#cb6-6"></a>      <span class="fu">mutate</span>(<span class="at">H =</span> Y <span class="sc">*</span> <span class="fu">exp</span>(<span class="sc">-</span>.x <span class="sc">*</span> A))</span>
<span id="cb6-7"><a href="#cb6-7"></a></span>
<span id="cb6-8"><a href="#cb6-8"></a>    <span class="fu">list</span>(<span class="st">`</span><span class="at">No unmeasured confounding</span><span class="st">`</span> <span class="ot">=</span> <span class="st">"A ~ H + U"</span>, </span>
<span id="cb6-9"><a href="#cb6-9"></a>         <span class="st">`</span><span class="at">Unmeasured confounding</span><span class="st">`</span> <span class="ot">=</span> <span class="st">"A ~ H"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb6-10"><a href="#cb6-10"></a>      <span class="fu">map_dfc</span>(<span class="at">.f =</span> <span class="sc">~</span> {</span>
<span id="cb6-11"><a href="#cb6-11"></a>        temp_df <span class="sc">%&gt;%</span></span>
<span id="cb6-12"><a href="#cb6-12"></a>          <span class="fu">lm</span>(<span class="fu">formula</span>(.x), <span class="at">data =</span> .) <span class="sc">%&gt;%</span></span>
<span id="cb6-13"><a href="#cb6-13"></a>          <span class="fu">tidy</span>() <span class="sc">%&gt;%</span></span>
<span id="cb6-14"><a href="#cb6-14"></a>          <span class="fu">filter</span>(term <span class="sc">==</span> <span class="st">"H"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb6-15"><a href="#cb6-15"></a>          <span class="fu">pull</span>(estimate)</span>
<span id="cb6-16"><a href="#cb6-16"></a>      }) <span class="sc">%&gt;%</span></span>
<span id="cb6-17"><a href="#cb6-17"></a>      <span class="fu">mutate</span>(<span class="at">psi =</span> .x, <span class="at">.before =</span> <span class="st">`</span><span class="at">No unmeasured confounding</span><span class="st">`</span>)</span>
<span id="cb6-18"><a href="#cb6-18"></a>  }) </span>
<span id="cb6-19"><a href="#cb6-19"></a></span>
<span id="cb6-20"><a href="#cb6-20"></a>grid_search_coefficient <span class="sc">%&gt;%</span></span>
<span id="cb6-21"><a href="#cb6-21"></a>  <span class="fu">pivot_longer</span>(<span class="sc">-</span>psi) <span class="sc">%&gt;%</span></span>
<span id="cb6-22"><a href="#cb6-22"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">exp</span>(psi), <span class="at">y =</span> value, <span class="at">color =</span> name)) <span class="sc">+</span></span>
<span id="cb6-23"><a href="#cb6-23"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb6-24"><a href="#cb6-24"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb6-25"><a href="#cb6-25"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="fl">1.02</span>, <span class="at">linetype =</span> <span class="st">"dotdash"</span>) <span class="sc">+</span></span>
<span id="cb6-26"><a href="#cb6-26"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">linetype =</span> <span class="st">"dotdash"</span>) <span class="sc">+</span></span>
<span id="cb6-27"><a href="#cb6-27"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="sc">-</span><span class="fl">2.5</span>, <span class="at">linetype =</span> <span class="st">"dotdash"</span>) <span class="sc">+</span></span>
<span id="cb6-28"><a href="#cb6-28"></a>  <span class="fu">xlab</span>(<span class="st">"Risk ratio (true value: 1.02)"</span>) <span class="sc">+</span></span>
<span id="cb6-29"><a href="#cb6-29"></a>  <span class="fu">ylab</span>(</span>
<span id="cb6-30"><a href="#cb6-30"></a>    glue<span class="sc">::</span><span class="fu">glue</span>(<span class="st">"Estimated coefficient for H(\U1D713)"</span>,</span>
<span id="cb6-31"><a href="#cb6-31"></a>               <span class="st">" </span><span class="sc">\n</span><span class="st">from the propensity model"</span>)</span>
<span id="cb6-32"><a href="#cb6-32"></a>  ) <span class="sc">+</span></span>
<span id="cb6-33"><a href="#cb6-33"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"bottom"</span>, <span class="at">legend.title =</span> <span class="fu">element_blank</span>()) <span class="sc">+</span></span>
<span id="cb6-34"><a href="#cb6-34"></a>  <span class="fu">coord_cartesian</span>(<span class="at">xlim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">3</span>), <span class="at">ylim =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">6</span>, <span class="dv">4</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-3-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>or like this when the <span class="math inline">\(p\)</span>-value is plotted on the Y-axis (on a narrower grid)</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1"></a>grid_search_pvalue <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="sc">-</span><span class="fl">0.05</span>, <span class="fl">0.05</span>, <span class="fl">0.001</span>) <span class="sc">%&gt;%</span></span>
<span id="cb7-2"><a href="#cb7-2"></a>  <span class="co"># get the coefficient from the correct and incorrect propensity models</span></span>
<span id="cb7-3"><a href="#cb7-3"></a>  <span class="fu">map_dfr</span>(<span class="at">.f =</span> <span class="sc">~</span> {</span>
<span id="cb7-4"><a href="#cb7-4"></a></span>
<span id="cb7-5"><a href="#cb7-5"></a>    temp_df <span class="ot">&lt;-</span> df_large <span class="sc">%&gt;%</span></span>
<span id="cb7-6"><a href="#cb7-6"></a>      <span class="fu">mutate</span>(<span class="at">H =</span> Y <span class="sc">*</span> <span class="fu">exp</span>(<span class="sc">-</span>.x <span class="sc">*</span> A))</span>
<span id="cb7-7"><a href="#cb7-7"></a></span>
<span id="cb7-8"><a href="#cb7-8"></a>    <span class="fu">list</span>(<span class="st">`</span><span class="at">No unmeasured confounding</span><span class="st">`</span> <span class="ot">=</span> <span class="st">"A ~ H + U"</span>, </span>
<span id="cb7-9"><a href="#cb7-9"></a>         <span class="st">`</span><span class="at">Unmeasured confounding</span><span class="st">`</span> <span class="ot">=</span> <span class="st">"A ~ H"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb7-10"><a href="#cb7-10"></a>      <span class="fu">map_dfc</span>(<span class="at">.f =</span> <span class="sc">~</span> {</span>
<span id="cb7-11"><a href="#cb7-11"></a>        temp_df <span class="sc">%&gt;%</span></span>
<span id="cb7-12"><a href="#cb7-12"></a>          <span class="fu">lm</span>(<span class="fu">formula</span>(.x), <span class="at">data =</span> .) <span class="sc">%&gt;%</span></span>
<span id="cb7-13"><a href="#cb7-13"></a>          <span class="fu">tidy</span>() <span class="sc">%&gt;%</span></span>
<span id="cb7-14"><a href="#cb7-14"></a>          <span class="fu">filter</span>(term <span class="sc">==</span> <span class="st">"H"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb7-15"><a href="#cb7-15"></a>          <span class="fu">pull</span>(p.value)</span>
<span id="cb7-16"><a href="#cb7-16"></a>      }) <span class="sc">%&gt;%</span></span>
<span id="cb7-17"><a href="#cb7-17"></a>      <span class="fu">mutate</span>(<span class="at">psi =</span> .x, <span class="at">.before =</span> <span class="st">`</span><span class="at">No unmeasured confounding</span><span class="st">`</span>)</span>
<span id="cb7-18"><a href="#cb7-18"></a>  }) </span>
<span id="cb7-19"><a href="#cb7-19"></a></span>
<span id="cb7-20"><a href="#cb7-20"></a>grid_search_pvalue <span class="sc">%&gt;%</span></span>
<span id="cb7-21"><a href="#cb7-21"></a>  <span class="fu">pivot_longer</span>(<span class="sc">-</span><span class="fu">c</span>(psi)) <span class="sc">%&gt;%</span></span>
<span id="cb7-22"><a href="#cb7-22"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">exp</span>(psi), <span class="at">y =</span> value, <span class="at">color =</span> name)) <span class="sc">+</span></span>
<span id="cb7-23"><a href="#cb7-23"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb7-24"><a href="#cb7-24"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb7-25"><a href="#cb7-25"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="fl">1.02</span>, <span class="at">linetype =</span> <span class="st">"dotdash"</span>) <span class="sc">+</span></span>
<span id="cb7-26"><a href="#cb7-26"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">linetype =</span> <span class="st">"dotdash"</span>) <span class="sc">+</span></span>
<span id="cb7-27"><a href="#cb7-27"></a>  <span class="fu">xlab</span>(<span class="st">"Risk ratio (true value: 1.02)"</span>) <span class="sc">+</span></span>
<span id="cb7-28"><a href="#cb7-28"></a>  <span class="fu">ylab</span>(<span class="st">"P-value for the test of alpha1 = 0"</span>) <span class="sc">+</span></span>
<span id="cb7-29"><a href="#cb7-29"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"bottom"</span>, <span class="at">legend.title =</span> <span class="fu">element_blank</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-4-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>From both the graphs, it’s evident that the estimate from the correctly specified propensity model is much closer to the true value of 1.02 (or 2% increase when going from <span class="math inline">\(A = a\)</span> to <span class="math inline">\(A = a + 1\)</span>) compared to the estimate from the propensity model without <span class="math inline">\(U\)</span>. Recovering the true effect in the presence of unmeasured confounding would require knowing which non-zero value of <span class="math inline">\(\alpha_1\)</span> (here about -2.5) corresponds to the true value of <span class="math inline">\(\psi\)</span>.</p>
<div class="page-columns page-full"><p>Grid search can be kinda tedious<a href="#fn10" class="footnote-ref" id="fnref10" role="doc-noteref"><sup>10</sup></a> and computationally inefficient when there are multiple treatment parameters<a href="#fn11" class="footnote-ref" id="fnref11" role="doc-noteref"><sup>11</sup></a>, but <a href="https://academic.oup.com/aje/article/187/5/1079/4930819">this paper</a> shows a neat trick using <em>log-link</em> <em>Gamma Generalized Estimating Equations (GEE)</em> to estimate risk ratios using regression adjustment for the propensity score</p><div class="no-row-height column-margin column-container"><li id="fn10"><p><sup>10</sup>&nbsp;It was annoying to use grid-search with p-values for this setting - if the grid was too coarse so there weren’t any points close to the true value, then the p-values were very close to zero, which explains the fine grid used here. Calling <code>optimize(gest_function, interval = c(-5, 5), maximum = TRUE)</code> where gest_function takes <span class="math inline">\(\psi\)</span> as an input and returns the p-value as the output failed to find the correct value, until the interval was narrowed to (0, 2). The coefficient estimate function wouldn’t work too well either, since risk ratio values less than 1 lead to estimates of <span class="math inline">\(\alpha_1\)</span> to be very close to 0.</p></li><li id="fn11"><p><sup>11</sup>&nbsp;to account for effect-measure modification or heterogeneity of treatment effect</p></li></div></div>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1"></a>propensity_scores <span class="ot">&lt;-</span> mgcv<span class="sc">::</span><span class="fu">gam</span>(A <span class="sc">~</span> <span class="fu">s</span>(U, <span class="at">k =</span> <span class="dv">10</span>), <span class="at">data =</span> df_large) <span class="sc">%&gt;%</span></span>
<span id="cb8-2"><a href="#cb8-2"></a>  <span class="fu">fitted</span>()</span>
<span id="cb8-3"><a href="#cb8-3"></a></span>
<span id="cb8-4"><a href="#cb8-4"></a>propensity_scores <span class="sc">%&gt;%</span> <span class="fu">summary</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
  0.625   2.061   5.345   5.847   9.565  12.438 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1"></a>gest_confounder <span class="ot">&lt;-</span> df_large <span class="sc">%&gt;%</span></span>
<span id="cb10-2"><a href="#cb10-2"></a>  <span class="fu">mutate</span>(<span class="at">PS =</span> propensity_scores) <span class="sc">%&gt;%</span></span>
<span id="cb10-3"><a href="#cb10-3"></a>  geeM<span class="sc">::</span><span class="fu">geem</span>(Y <span class="sc">~</span> PS <span class="sc">+</span> A, <span class="at">data =</span> ., <span class="at">family =</span> <span class="fu">Gamma</span>(<span class="at">link =</span> <span class="st">"log"</span>),</span>
<span id="cb10-4"><a href="#cb10-4"></a>             <span class="at">corstr =</span> <span class="st">"independence"</span>, <span class="at">sandwich =</span> <span class="cn">TRUE</span>)</span>
<span id="cb10-5"><a href="#cb10-5"></a></span>
<span id="cb10-6"><a href="#cb10-6"></a><span class="fu">summary</span>(gest_confounder)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>            Estimates Model SE Robust SE    wald     p
(Intercept)  -3.02200 0.061950  0.041350 -73.080 0e+00
PS           -0.25020 0.009526  0.011600 -21.580 0e+00
A             0.01937 0.003600  0.003923   4.936 8e-07

 Estimated Correlation Parameter:  0 
 Correlation Structure:  independence 
 Est. Scale Parameter:  117.9 

 Number of GEE iterations: 2 
 Number of Clusters:  100000    Maximum Cluster Size:  1 
 Number of observations with nonzero weight:  100000 </code></pre>
</div>
</div>
<p>Unfortunately there’s no <em>tidier</em> for objects of class <code>geem</code> in the <code>broom</code> package, but it’s easy enough to write one to extract information from the fitted model as a data frame — see the following code block</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1"></a>tidy.geem <span class="ot">&lt;-</span> <span class="cf">function</span>(x, <span class="at">conf.int =</span> <span class="cn">FALSE</span>, </span>
<span id="cb12-2"><a href="#cb12-2"></a>                      <span class="at">exponentiate =</span> <span class="cn">FALSE</span>, </span>
<span id="cb12-3"><a href="#cb12-3"></a>                      <span class="at">conf.level =</span> <span class="fl">0.95</span>, </span>
<span id="cb12-4"><a href="#cb12-4"></a>                      <span class="at">robust =</span> <span class="cn">TRUE</span>, ...) {</span>
<span id="cb12-5"><a href="#cb12-5"></a>  <span class="co"># works only when broom is attached</span></span>
<span id="cb12-6"><a href="#cb12-6"></a>  <span class="co"># as it's added as an S3 method for broom::tidy(x, ...)</span></span>
<span id="cb12-7"><a href="#cb12-7"></a>  <span class="co"># could also do library(broom, include.only = "tidy")</span></span>
<span id="cb12-8"><a href="#cb12-8"></a>  <span class="co">#</span></span>
<span id="cb12-9"><a href="#cb12-9"></a>  <span class="co"># arguments are the same as broom::tidy.geeglm()</span></span>
<span id="cb12-10"><a href="#cb12-10"></a>  <span class="fu">stopifnot</span>(<span class="fu">is.logical</span>(robust))</span>
<span id="cb12-11"><a href="#cb12-11"></a>  s <span class="ot">&lt;-</span> <span class="fu">summary</span>(x)</span>
<span id="cb12-12"><a href="#cb12-12"></a>  ret <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"term"</span> <span class="ot">=</span> <span class="st">"coefnames"</span>, <span class="st">"estimate"</span> <span class="ot">=</span> <span class="st">"beta"</span>,</span>
<span id="cb12-13"><a href="#cb12-13"></a>           <span class="st">"std.error"</span> <span class="ot">=</span> <span class="cf">if</span> (robust) <span class="st">"se.robust"</span> <span class="cf">else</span> <span class="st">"se.model"</span>,</span>
<span id="cb12-14"><a href="#cb12-14"></a>           <span class="st">"statistic"</span> <span class="ot">=</span> <span class="st">"wald.test"</span>, <span class="st">"p.value"</span> <span class="ot">=</span> <span class="st">"p"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb12-15"><a href="#cb12-15"></a>    <span class="fu">map</span>(<span class="at">.x =</span> ., <span class="at">.f =</span> <span class="sc">~</span> <span class="fu">pluck</span>(s, .x)) <span class="sc">%&gt;%</span></span>
<span id="cb12-16"><a href="#cb12-16"></a>    <span class="fu">as_tibble</span>()</span>
<span id="cb12-17"><a href="#cb12-17"></a></span>
<span id="cb12-18"><a href="#cb12-18"></a>  <span class="cf">if</span> (conf.int) {</span>
<span id="cb12-19"><a href="#cb12-19"></a>    p <span class="ot">&lt;-</span> (<span class="dv">1</span> <span class="sc">+</span> conf.level) <span class="sc">/</span> <span class="dv">2</span></span>
<span id="cb12-20"><a href="#cb12-20"></a>    ret <span class="ot">&lt;-</span> ret <span class="sc">%&gt;%</span></span>
<span id="cb12-21"><a href="#cb12-21"></a>      <span class="fu">mutate</span>(</span>
<span id="cb12-22"><a href="#cb12-22"></a>        <span class="at">conf.low =</span> estimate <span class="sc">-</span> (<span class="fu">qnorm</span>(<span class="at">p =</span> p) <span class="sc">*</span> std.error),</span>
<span id="cb12-23"><a href="#cb12-23"></a>        <span class="at">conf.high =</span> estimate <span class="sc">+</span> (<span class="fu">qnorm</span>(<span class="at">p =</span> p) <span class="sc">*</span> std.error),</span>
<span id="cb12-24"><a href="#cb12-24"></a>      )</span>
<span id="cb12-25"><a href="#cb12-25"></a>  }</span>
<span id="cb12-26"><a href="#cb12-26"></a></span>
<span id="cb12-27"><a href="#cb12-27"></a>  <span class="cf">if</span> (exponentiate) {</span>
<span id="cb12-28"><a href="#cb12-28"></a>    <span class="co"># exponentiate the point estimate and the CI endpoints (if present)</span></span>
<span id="cb12-29"><a href="#cb12-29"></a>    ret <span class="ot">&lt;-</span> ret <span class="sc">%&gt;%</span></span>
<span id="cb12-30"><a href="#cb12-30"></a>      <span class="fu">mutate</span>(</span>
<span id="cb12-31"><a href="#cb12-31"></a>        <span class="fu">across</span>(</span>
<span id="cb12-32"><a href="#cb12-32"></a>          <span class="at">.cols =</span> <span class="sc">-</span><span class="fu">c</span>(term, std.error, statistic, p.value),</span>
<span id="cb12-33"><a href="#cb12-33"></a>          <span class="at">.fns =</span> exp</span>
<span id="cb12-34"><a href="#cb12-34"></a>        )</span>
<span id="cb12-35"><a href="#cb12-35"></a>      )</span>
<span id="cb12-36"><a href="#cb12-36"></a>  }</span>
<span id="cb12-37"><a href="#cb12-37"></a></span>
<span id="cb12-38"><a href="#cb12-38"></a>  <span class="fu">return</span>(ret)</span>
<span id="cb12-39"><a href="#cb12-39"></a>}</span>
<span id="cb12-40"><a href="#cb12-40"></a></span>
<span id="cb12-41"><a href="#cb12-41"></a>gest_confounder <span class="sc">%&gt;%</span></span>
<span id="cb12-42"><a href="#cb12-42"></a>  <span class="fu">tidy</span>(<span class="at">exponentiate =</span> <span class="cn">TRUE</span>, <span class="at">conf.int =</span> <span class="cn">TRUE</span>, <span class="at">robust =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb12-43"><a href="#cb12-43"></a>  <span class="fu">filter</span>(term <span class="sc">==</span> <span class="st">"A"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 7
  term  estimate std.error statistic   p.value conf.low conf.high
  &lt;chr&gt;    &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;     &lt;dbl&gt;
1 A         1.02   0.00392      4.94 0.0000008     1.01      1.03</code></pre>
</div>
</div>
<p>This can also be compared with the usual regression estimate</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1"></a>glm_model <span class="ot">&lt;-</span> <span class="fu">glm</span>(Y <span class="sc">~</span> U <span class="sc">+</span> A, <span class="at">data =</span> df_large, <span class="at">family =</span> <span class="fu">binomial</span>(<span class="at">link =</span> <span class="st">"log"</span>))</span>
<span id="cb14-2"><a href="#cb14-2"></a></span>
<span id="cb14-3"><a href="#cb14-3"></a>glm_model <span class="sc">%&gt;%</span> </span>
<span id="cb14-4"><a href="#cb14-4"></a>  <span class="fu">tidy</span>(<span class="at">exponentiate =</span> <span class="cn">TRUE</span>, <span class="at">conf.int =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb14-5"><a href="#cb14-5"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="at">.cols =</span> <span class="fu">where</span>(is.numeric), <span class="at">.fns =</span> <span class="sc">~</span> <span class="fu">round</span>(.x, <span class="dv">4</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3 × 7
  term        estimate std.error statistic p.value conf.low conf.high
  &lt;chr&gt;          &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;   &lt;dbl&gt;    &lt;dbl&gt;     &lt;dbl&gt;
1 (Intercept)   0.0022    0.0833    -73.3        0   0.0019    0.0026
2 U             1.38      0.0104     31.1        0   1.36      1.41  
3 A             1.02      0.0025      8.52       0   1.02      1.03  </code></pre>
</div>
</div>
<p>But what if <span class="math inline">\(U\)</span> is unmeasured?</p>
</section>
<section id="g-estimation-with-an-iv" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="g-estimation-with-an-iv">G-estimation with an IV</h2>
<div class="page-columns page-full"><p>In a randomized trial with perfect compliance, <span class="math inline">\(A\)</span> and <span class="math inline">\(Z\)</span> will be identical so a simple analysis using either one of these will result in an unbiased estimate of the average treatment effect. On the other hand, in the presence of imperfect compliance due to unmeasured confounding, an unadjusted analysis of <span class="math inline">\(A - Y\)</span> will lead to biased estimates of the effect of treatment, and an unadjusted analysis of <span class="math inline">\(Z - Y\)</span> will lead to an estimate of assigning treatment<a href="#fn12" class="footnote-ref" id="fnref12" role="doc-noteref"><sup>12</sup></a> instead of receiving the treatment. Analyzing only <span class="math inline">\(A-Y\)</span>, the estimated treatment effect concentrates around 0.98 on average instead of 1.02</p><div class="no-row-height column-margin column-container"><li id="fn12"><p><sup>12</sup>&nbsp;i.e., the <em>intention-to-treat</em> effect (ITT)</p></li></div></div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1"></a><span class="co"># specify the seed</span></span>
<span id="cb16-2"><a href="#cb16-2"></a><span class="fu">seq</span>(<span class="dv">1</span>, <span class="dv">100</span>, <span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb16-3"><a href="#cb16-3"></a>  <span class="fu">map_dbl</span>(<span class="at">.f =</span> <span class="sc">~</span> {</span>
<span id="cb16-4"><a href="#cb16-4"></a>    .x <span class="sc">%&gt;%</span> </span>
<span id="cb16-5"><a href="#cb16-5"></a>      <span class="fu">simulate_data</span>(<span class="at">seed =</span> ., <span class="at">n =</span> <span class="fl">1e4</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb16-6"><a href="#cb16-6"></a>      <span class="fu">glm</span>(Y <span class="sc">~</span> A, <span class="at">data =</span> ., <span class="at">family =</span> <span class="fu">binomial</span>(<span class="at">link =</span> <span class="st">"log"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb16-7"><a href="#cb16-7"></a>      <span class="fu">tidy</span>(<span class="at">exponentiate =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb16-8"><a href="#cb16-8"></a>      <span class="fu">filter</span>(term <span class="sc">==</span> <span class="st">"A"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb16-9"><a href="#cb16-9"></a>      <span class="fu">pull</span>(estimate)</span>
<span id="cb16-10"><a href="#cb16-10"></a>  }) <span class="sc">%&gt;%</span> </span>
<span id="cb16-11"><a href="#cb16-11"></a>  <span class="fu">summary</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
 0.9578  0.9741  0.9815  0.9810  0.9864  1.0035 </code></pre>
</div>
</div>
<div class="page-columns page-full"><p>If the DAG with relationships <span class="math inline">\(A \leftarrow U \rightarrow Y\)</span> and <span class="math inline">\(Z \rightarrow A \rightarrow Y\)</span> holds but only <span class="math inline">\((Z, A, Y)\)</span> are observed, and <span class="math inline">\(Z\)</span> is a variable that meets the IV conditions<a href="#fn13" class="footnote-ref" id="fnref13" role="doc-noteref"><sup>13</sup></a>, the effect of <span class="math inline">\(A\)</span> (<span class="math inline">\(\text{ATE}\)</span> or <span class="math inline">\(\text{ATT}_{IV}\)</span>) can be estimated under some additional assumptions.</p><div class="no-row-height column-margin column-container"><li id="fn13"><p><sup>13</sup>&nbsp;Associated with <span class="math inline">\(A\)</span> (relevance), not associated with any variables in the set <span class="math inline">\(U\)</span> (ignorability), and no direct effect on <span class="math inline">\(Y\)</span> (exclusion restriction)</p></li></div></div>
<p>The key idea is captured by this (estimating) equation</p>
<p><span class="math display">\[
\sum_{i = 1}^n (z_i - \bar{z})\ y_i\ \text{exp}(-\psi\ a_i) = 0
\]</span></p>
<p>where <span class="math inline">\(\bar{z}\)</span> denotes the proportion of individuals assigned to the treatment arm.</p>
<div class="page-columns page-full"><p>Since <span class="math inline">\(Z\)</span> is randomly assigned, it should be balanced with respect to all measured and unmeasured confounders <span class="math inline">\(U\)</span>. But <span class="math inline">\(A\)</span> may not be. So the correct estimate of <span class="math inline">\(\psi\)</span> is the one that leads to zero covariance between the residuals <span class="math inline">\(Y^{a = 0}\)</span> (or <span class="math inline">\(H(\psi)\)</span>) and <span class="math inline">\(Z\)</span><a href="#fn14" class="footnote-ref" id="fnref14" role="doc-noteref"><sup>14</sup></a>. Pretty magical, if you ask me.</p><div class="no-row-height column-margin column-container"><li id="fn14"><p><sup>14</sup>&nbsp;If <span class="math inline">\((a_i - \bar{a})\)</span> were to be used instead of <span class="math inline">\((z_i - \bar{z})\)</span>, then the estimate would be the same one as from the <span class="math inline">\(A- Y\)</span> analysis.</p></li></div></div>
<p>This equation can be coded up as a function which visually looks like this</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1"></a>MSNMM_function <span class="ot">&lt;-</span> <span class="cf">function</span>(psi, <span class="at">data =</span> df_large, <span class="at">positive =</span> <span class="cn">TRUE</span>) {</span>
<span id="cb18-2"><a href="#cb18-2"></a>  result <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span></span>
<span id="cb18-3"><a href="#cb18-3"></a>    <span class="fu">mutate</span>(</span>
<span id="cb18-4"><a href="#cb18-4"></a>      <span class="at">Zbar =</span> <span class="fu">mean</span>(Z),</span>
<span id="cb18-5"><a href="#cb18-5"></a>      <span class="at">s =</span> (Z <span class="sc">-</span> Zbar) <span class="sc">*</span> Y <span class="sc">*</span> <span class="fu">exp</span>(<span class="sc">-</span>psi <span class="sc">*</span> A)</span>
<span id="cb18-6"><a href="#cb18-6"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb18-7"><a href="#cb18-7"></a>    <span class="fu">pull</span>(s) <span class="sc">%&gt;%</span></span>
<span id="cb18-8"><a href="#cb18-8"></a>    <span class="fu">sum</span>()</span>
<span id="cb18-9"><a href="#cb18-9"></a></span>
<span id="cb18-10"><a href="#cb18-10"></a>  <span class="cf">if</span> (positive) result <span class="ot">&lt;-</span> <span class="fu">abs</span>(result)</span>
<span id="cb18-11"><a href="#cb18-11"></a></span>
<span id="cb18-12"><a href="#cb18-12"></a>  <span class="fu">return</span>(result)</span>
<span id="cb18-13"><a href="#cb18-13"></a>}</span>
<span id="cb18-14"><a href="#cb18-14"></a></span>
<span id="cb18-15"><a href="#cb18-15"></a>IV_grid <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="sc">-</span><span class="fl">0.05</span>, <span class="fl">0.5</span>, <span class="fl">0.01</span>) <span class="sc">%&gt;%</span></span>
<span id="cb18-16"><a href="#cb18-16"></a>  <span class="fu">tibble</span>(<span class="at">psi =</span> .) <span class="sc">%&gt;%</span></span>
<span id="cb18-17"><a href="#cb18-17"></a>  <span class="fu">rowwise</span>() <span class="sc">%&gt;%</span></span>
<span id="cb18-18"><a href="#cb18-18"></a>  <span class="fu">mutate</span>(</span>
<span id="cb18-19"><a href="#cb18-19"></a>    <span class="st">`</span><span class="at">Raw value</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">MSNMM_function</span>(psi, <span class="at">positive =</span> <span class="cn">FALSE</span>),</span>
<span id="cb18-20"><a href="#cb18-20"></a>    <span class="st">`</span><span class="at">Absolute value</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">abs</span>(<span class="st">`</span><span class="at">Raw value</span><span class="st">`</span>)</span>
<span id="cb18-21"><a href="#cb18-21"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb18-22"><a href="#cb18-22"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span></span>
<span id="cb18-23"><a href="#cb18-23"></a>  <span class="fu">pivot_longer</span>(<span class="sc">-</span>psi) <span class="sc">%&gt;%</span></span>
<span id="cb18-24"><a href="#cb18-24"></a>  <span class="fu">mutate</span>(<span class="at">name =</span> <span class="fu">fct_rev</span>(<span class="fu">factor</span>(name))) </span>
<span id="cb18-25"><a href="#cb18-25"></a></span>
<span id="cb18-26"><a href="#cb18-26"></a>IV_grid <span class="sc">%&gt;%</span></span>
<span id="cb18-27"><a href="#cb18-27"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">exp</span>(psi), <span class="at">y =</span> value, <span class="at">color =</span> name)) <span class="sc">+</span></span>
<span id="cb18-28"><a href="#cb18-28"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span> <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb18-29"><a href="#cb18-29"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">linetype =</span> <span class="st">"dotdash"</span>) <span class="sc">+</span></span>
<span id="cb18-30"><a href="#cb18-30"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="fl">1.02</span>, <span class="at">linetype =</span> <span class="st">"dotdash"</span>) <span class="sc">+</span></span>
<span id="cb18-31"><a href="#cb18-31"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"bottom"</span>, <span class="at">legend.title =</span> <span class="fu">element_blank</span>()) <span class="sc">+</span></span>
<span id="cb18-32"><a href="#cb18-32"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">n.breaks =</span> <span class="dv">10</span>) <span class="sc">+</span></span>
<span id="cb18-33"><a href="#cb18-33"></a>  <span class="fu">xlab</span>(<span class="st">"Risk ratio (true value: 1.02)"</span>) <span class="sc">+</span></span>
<span id="cb18-34"><a href="#cb18-34"></a>  <span class="fu">ylab</span>(<span class="st">"Covariance between Z and H(\U1D713)"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-9-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<div class="page-columns page-full"><p>Instead of using grid search, the <code>optimize()</code> function can be used with the absolute value of the covariance to pick the value of <span class="math inline">\(\psi\)</span> that leads to 0 covariance<a href="#fn15" class="footnote-ref" id="fnref15" role="doc-noteref"><sup>15</sup></a></p><div class="no-row-height column-margin column-container"><li id="fn15"><p><sup>15</sup>&nbsp;if the function is flat in the specified interval, the optimization step would return incorrect results (passing `interval = c(3, 5)` returns the value of 3 and an objective function value of 83.8 which is far away from 0)</p></li></div></div>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1"></a><span class="fu">optimize</span>(<span class="at">f =</span> MSNMM_function, <span class="at">interval =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">2</span>, <span class="dv">2</span>), <span class="at">maximum =</span> <span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$minimum
[1] 0.01308194

$objective
[1] 0.03266255</code></pre>
</div>
</div>
<p>This is a slight underestimate (1.013 vs 1.02) — but it seems to be a sampling artifact as the median of 100 simulated values concentrates around 1.02</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1"></a>IV_estimates <span class="ot">&lt;-</span> <span class="fu">map_dbl</span>(</span>
<span id="cb21-2"><a href="#cb21-2"></a>  <span class="at">.x =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">100</span>,</span>
<span id="cb21-3"><a href="#cb21-3"></a>  <span class="at">.f =</span> <span class="sc">~</span> {</span>
<span id="cb21-4"><a href="#cb21-4"></a>    .x <span class="sc">%&gt;%</span></span>
<span id="cb21-5"><a href="#cb21-5"></a>      <span class="fu">simulate_data</span>(<span class="at">seed =</span> .) <span class="sc">%&gt;%</span></span>
<span id="cb21-6"><a href="#cb21-6"></a>      <span class="fu">optimize</span>(</span>
<span id="cb21-7"><a href="#cb21-7"></a>        <span class="at">f =</span> MSNMM_function, <span class="at">interval =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">2</span>, <span class="dv">2</span>), </span>
<span id="cb21-8"><a href="#cb21-8"></a>        <span class="at">maximum =</span> <span class="cn">FALSE</span>, <span class="at">data =</span> .</span>
<span id="cb21-9"><a href="#cb21-9"></a>      ) <span class="sc">%&gt;%</span></span>
<span id="cb21-10"><a href="#cb21-10"></a>      <span class="fu">pluck</span>(<span class="st">"minimum"</span>)</span>
<span id="cb21-11"><a href="#cb21-11"></a>  })</span>
<span id="cb21-12"><a href="#cb21-12"></a></span>
<span id="cb21-13"><a href="#cb21-13"></a>IV_estimates <span class="sc">%&gt;%</span> <span class="fu">exp</span>() <span class="sc">%&gt;%</span> <span class="fu">summary</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
 0.9966  1.0136  1.0206  1.0219  1.0304  1.0536 </code></pre>
</div>
</div>
<div class="page-columns page-full"><p>It might just be simpler to use the <code>ivglm()</code> function from the <code>ivtools</code> package (see <a href="https://www.degruyter.com/document/doi/10.1515/em-2018-0024/html">this paper</a>) to accomplish the same thing though<a href="#fn16" class="footnote-ref" id="fnref16" role="doc-noteref"><sup>16</sup></a></p><div class="no-row-height column-margin column-container"><li id="fn16"><p><sup>16</sup>&nbsp;which has other advantages like handling multiple instruments and different effect measures</p></li></div></div>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1"></a>IV_model <span class="ot">&lt;-</span> <span class="fu">glm</span>(Z <span class="sc">~</span> <span class="dv">1</span>, <span class="at">family =</span> <span class="fu">binomial</span>(<span class="at">link =</span> <span class="st">"logit"</span>), <span class="at">data =</span> df_large)</span>
<span id="cb23-2"><a href="#cb23-2"></a></span>
<span id="cb23-3"><a href="#cb23-3"></a>IV_gest <span class="ot">&lt;-</span> df_large <span class="sc">%&gt;%</span></span>
<span id="cb23-4"><a href="#cb23-4"></a>  <span class="co"># need to cast tibble as a data frame to avoid cryptic errors</span></span>
<span id="cb23-5"><a href="#cb23-5"></a>  <span class="fu">as.data.frame</span>() <span class="sc">%&gt;%</span></span>
<span id="cb23-6"><a href="#cb23-6"></a>  ivtools<span class="sc">::</span><span class="fu">ivglm</span>(<span class="at">estmethod =</span> <span class="st">"g"</span>,</span>
<span id="cb23-7"><a href="#cb23-7"></a>                 <span class="at">X =</span> <span class="st">"A"</span>, <span class="at">Y =</span> <span class="st">"Y"</span>,</span>
<span id="cb23-8"><a href="#cb23-8"></a>                 <span class="at">fitZ.L =</span> IV_model,</span>
<span id="cb23-9"><a href="#cb23-9"></a>                 <span class="at">link =</span> <span class="st">"log"</span>, <span class="at">data =</span> .)</span>
<span id="cb23-10"><a href="#cb23-10"></a></span>
<span id="cb23-11"><a href="#cb23-11"></a>IV_gest <span class="sc">%&gt;%</span> <span class="fu">summary</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:  
ivtools::ivglm(estmethod = "g", X = "A", Y = "Y", fitZ.L = IV_model, 
    data = ., link = "log")

Coefficients: 
  Estimate Std. Error z value Pr(&gt;|z|)
A  0.01310    0.01065    1.23    0.219</code></pre>
</div>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1"></a><span class="co"># get the coefficient and CI</span></span>
<span id="cb25-2"><a href="#cb25-2"></a>glue<span class="sc">::</span><span class="fu">glue</span>(</span>
<span id="cb25-3"><a href="#cb25-3"></a>  <span class="st">"Mean: {round(exp(c(summary(IV_gest)$coefficients[1, 1])), 4)}"</span>, </span>
<span id="cb25-4"><a href="#cb25-4"></a>  <span class="st">" with 95% CI: ({round(exp(confint(IV_gest))[1], 4)},"</span>, </span>
<span id="cb25-5"><a href="#cb25-5"></a>  <span class="st">" {round(exp(confint(IV_gest))[2], 4)})"</span></span>
<span id="cb25-6"><a href="#cb25-6"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Mean: 1.0132 with 95% CI: (0.9923, 1.0346)</code></pre>
</div>
</div>
<p>where it produces nearly the same estimate as above and additionally has the option of plotting the shape of the estimating equations in a neighborhood of the estimate</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1"></a><span class="co"># can use ggplot on the output from estfun()</span></span>
<span id="cb27-2"><a href="#cb27-2"></a><span class="co"># ivtools::estfun(IV_gest, lower = -0.1, upper = 0.1, step = 0.01) %&gt;% </span></span>
<span id="cb27-3"><a href="#cb27-3"></a><span class="co">#   pluck("f") %&gt;%  </span></span>
<span id="cb27-4"><a href="#cb27-4"></a><span class="co">#   pluck("A") %&gt;% </span></span>
<span id="cb27-5"><a href="#cb27-5"></a><span class="co">#   data.frame() %&gt;% </span></span>
<span id="cb27-6"><a href="#cb27-6"></a><span class="co">#   ggplot(aes(x = exp(psi), y = Hsum)) + </span></span>
<span id="cb27-7"><a href="#cb27-7"></a><span class="co">#   geom_point() +</span></span>
<span id="cb27-8"><a href="#cb27-8"></a><span class="co">#   geom_line() </span></span>
<span id="cb27-9"><a href="#cb27-9"></a></span>
<span id="cb27-10"><a href="#cb27-10"></a><span class="fu">plot</span>(ivtools<span class="sc">::</span><span class="fu">estfun</span>(IV_gest, <span class="at">lower =</span> <span class="sc">-</span><span class="fl">0.1</span>, <span class="at">upper =</span> <span class="fl">0.1</span>, <span class="at">step =</span> <span class="fl">0.01</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-14-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>A caveat is that this approach can sometimes fail when this function has a weird shape in the presence of weak instruments (see <a href="https://academic.oup.com/aje/article/180/1/111/2739174">this paper</a>).</p>
</section>
<section id="estimating-probabilities" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="estimating-probabilities">Estimating probabilities</h2>
<p>If we had the model which included <span class="math inline">\(U\)</span> as a covariate, conditional probabilities <span class="math inline">\(\text{Pr}[Y = 1 | A = a, U = u]\)</span> as well as marginal probabilities <span class="math inline">\(\text{Pr}[Y = 1 | A = a]\)</span> (averaged over levels of <span class="math inline">\(U\)</span>) could be generated using the amazing <em>marginaleffects</em> package to perform <em>g-computation</em> with the resulting <em>dose-response curves</em> visualized<em>.</em></p>
<div class="page-columns page-full"><p>The following plot with conditional dose-response curves at quartiles of <span class="math inline">\(U\)</span> shows that the effect of the treatment with increasing <span class="math inline">\(A\)</span> is increasing across levels of <span class="math inline">\(U\)</span> — which makes sense because the treatment effect is a multiplicative (percent) change relative to the previous level<a href="#fn17" class="footnote-ref" id="fnref17" role="doc-noteref"><sup>17</sup></a></p><div class="no-row-height column-margin column-container"><li id="fn17"><p><sup>17</sup>&nbsp;the effects of <span class="math inline">\(A\)</span> and <span class="math inline">\(U\)</span> are linear on the log scale but not on the transformed probability scale</p></li></div></div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1"></a><span class="co"># get predicted probabilities from the model at quartiles of U</span></span>
<span id="cb28-2"><a href="#cb28-2"></a>glm_model <span class="sc">%&gt;%</span></span>
<span id="cb28-3"><a href="#cb28-3"></a>  marginaleffects<span class="sc">::</span><span class="fu">plot_predictions</span>(<span class="at">condition =</span> <span class="fu">list</span>(<span class="st">"A"</span>, <span class="st">"U"</span> <span class="ot">=</span> <span class="st">"fivenum"</span>)) <span class="sc">+</span></span>
<span id="cb28-4"><a href="#cb28-4"></a>  <span class="fu">xlab</span>(<span class="st">"A"</span>) <span class="sc">+</span></span>
<span id="cb28-5"><a href="#cb28-5"></a>  <span class="fu">ylab</span>(<span class="st">"Predicted probability of Y = 1"</span>) <span class="sc">+</span> </span>
<span id="cb28-6"><a href="#cb28-6"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"bottom"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-15-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>When <span class="math inline">\(U\)</span> is unmeasured, only the marginal dose-response curve can be estimated, and the following plot compares g-computation and g-estimation estimates and their CIs, with the true curve plotted for comparison</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1"></a><span class="co"># simulate 100 datasets and take the mean of probabilities under A = 0</span></span>
<span id="cb29-2"><a href="#cb29-2"></a>baseline_conversion_probability <span class="ot">&lt;-</span> <span class="fu">map_dbl</span>(</span>
<span id="cb29-3"><a href="#cb29-3"></a>  <span class="at">.x =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">100</span>,</span>
<span id="cb29-4"><a href="#cb29-4"></a>  <span class="at">.f =</span> <span class="sc">~</span> {</span>
<span id="cb29-5"><a href="#cb29-5"></a>    <span class="fu">simulate_data</span>(<span class="at">seed =</span> .x, <span class="at">n =</span> <span class="fl">1e5</span>) <span class="sc">%&gt;%</span></span>
<span id="cb29-6"><a href="#cb29-6"></a>      <span class="fu">pull</span>(logpY0) <span class="sc">%&gt;%</span></span>
<span id="cb29-7"><a href="#cb29-7"></a>      <span class="fu">exp</span>() <span class="sc">%&gt;%</span></span>
<span id="cb29-8"><a href="#cb29-8"></a>      <span class="fu">mean</span>()</span>
<span id="cb29-9"><a href="#cb29-9"></a>    }) <span class="sc">%&gt;%</span></span>
<span id="cb29-10"><a href="#cb29-10"></a>  <span class="fu">mean</span>()</span>
<span id="cb29-11"><a href="#cb29-11"></a></span>
<span id="cb29-12"><a href="#cb29-12"></a><span class="co"># true dose-response curve</span></span>
<span id="cb29-13"><a href="#cb29-13"></a>true_dose_response_curve <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb29-14"><a href="#cb29-14"></a>  <span class="at">A =</span> <span class="dv">0</span><span class="sc">:</span><span class="dv">73</span>,</span>
<span id="cb29-15"><a href="#cb29-15"></a>  <span class="at">estimate =</span> baseline_conversion_probability <span class="sc">*</span> <span class="fu">exp</span>(<span class="fu">log</span>(<span class="fl">1.02</span>) <span class="sc">*</span> A)</span>
<span id="cb29-16"><a href="#cb29-16"></a>)</span>
<span id="cb29-17"><a href="#cb29-17"></a></span>
<span id="cb29-18"><a href="#cb29-18"></a><span class="co"># g-computation by creating counterfactual predictions</span></span>
<span id="cb29-19"><a href="#cb29-19"></a><span class="co"># by setting A = a and averaging the predicted probabilities</span></span>
<span id="cb29-20"><a href="#cb29-20"></a><span class="co"># doing this over a coarser grid to get faster run times</span></span>
<span id="cb29-21"><a href="#cb29-21"></a>g_computation_dose_response_extrapolated_levels <span class="ot">&lt;-</span> glm_model <span class="sc">%&gt;%</span></span>
<span id="cb29-22"><a href="#cb29-22"></a>  marginaleffects<span class="sc">::</span><span class="fu">predictions</span>(</span>
<span id="cb29-23"><a href="#cb29-23"></a>    <span class="at">by =</span> <span class="st">"A"</span>, <span class="at">type =</span> <span class="st">"response"</span>,</span>
<span id="cb29-24"><a href="#cb29-24"></a>    <span class="at">newdata =</span> marginaleffects<span class="sc">::</span><span class="fu">datagrid</span>(</span>
<span id="cb29-25"><a href="#cb29-25"></a>      <span class="at">A =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fu">seq</span>(<span class="dv">5</span>, <span class="dv">70</span>, <span class="dv">5</span>), <span class="dv">73</span>), <span class="at">grid_type =</span> <span class="st">"counterfactual"</span></span>
<span id="cb29-26"><a href="#cb29-26"></a>    )</span>
<span id="cb29-27"><a href="#cb29-27"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb29-28"><a href="#cb29-28"></a>  <span class="fu">select</span>(A, estimate, conf.low, conf.high) <span class="sc">%&gt;%</span></span>
<span id="cb29-29"><a href="#cb29-29"></a>  <span class="fu">as_tibble</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb29-30"><a href="#cb29-30"></a>  <span class="fu">mutate</span>(<span class="at">type =</span> <span class="st">"G-computation"</span>)</span>
<span id="cb29-31"><a href="#cb29-31"></a></span>
<span id="cb29-32"><a href="#cb29-32"></a><span class="co"># get estimates of Pr[Y = 1 | A = 0]</span></span>
<span id="cb29-33"><a href="#cb29-33"></a><span class="co"># by shaving off the effect of the treatment</span></span>
<span id="cb29-34"><a href="#cb29-34"></a><span class="co"># using the point estimate and CI endpoints from ivglm</span></span>
<span id="cb29-35"><a href="#cb29-35"></a>g_estimation_pY0 <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb29-36"><a href="#cb29-36"></a>  IV_gest <span class="sc">%&gt;%</span> <span class="fu">pluck</span>(<span class="st">"est"</span>) <span class="sc">%&gt;%</span> <span class="fu">unname</span>(),</span>
<span id="cb29-37"><a href="#cb29-37"></a>  IV_gest <span class="sc">%&gt;%</span> <span class="fu">confint</span>() <span class="sc">%&gt;%</span> <span class="fu">unname</span>()</span>
<span id="cb29-38"><a href="#cb29-38"></a>) <span class="sc">%&gt;%</span></span>
<span id="cb29-39"><a href="#cb29-39"></a>  <span class="fu">set_names</span>(<span class="at">nm =</span> <span class="fu">c</span>(<span class="st">"estimate"</span>, <span class="st">"conf.low"</span>, <span class="st">"conf.high"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb29-40"><a href="#cb29-40"></a>  <span class="fu">map_dfr</span>(</span>
<span id="cb29-41"><a href="#cb29-41"></a>    <span class="at">.f =</span> <span class="sc">~</span> {</span>
<span id="cb29-42"><a href="#cb29-42"></a>      df_large <span class="sc">%&gt;%</span></span>
<span id="cb29-43"><a href="#cb29-43"></a>        <span class="fu">mutate</span>(<span class="at">H =</span> Y <span class="sc">*</span> <span class="fu">exp</span>(<span class="sc">-</span>.x <span class="sc">*</span> A)) <span class="sc">%&gt;%</span></span>
<span id="cb29-44"><a href="#cb29-44"></a>        <span class="fu">pull</span>(H) <span class="sc">%&gt;%</span></span>
<span id="cb29-45"><a href="#cb29-45"></a>        <span class="fu">mean</span>() <span class="sc">%&gt;%</span></span>
<span id="cb29-46"><a href="#cb29-46"></a>        <span class="fu">tibble</span>(<span class="at">logRR =</span> .x, <span class="at">pY0 =</span> .)</span>
<span id="cb29-47"><a href="#cb29-47"></a>    }, </span>
<span id="cb29-48"><a href="#cb29-48"></a>    <span class="at">.id =</span> <span class="st">"name"</span></span>
<span id="cb29-49"><a href="#cb29-49"></a>  )</span>
<span id="cb29-50"><a href="#cb29-50"></a></span>
<span id="cb29-51"><a href="#cb29-51"></a><span class="co"># using logRR estimate + CI and Pr[Y = 1 | A = 0]</span></span>
<span id="cb29-52"><a href="#cb29-52"></a>g_estimation_dose_response <span class="ot">&lt;-</span> g_estimation_pY0 <span class="sc">%&gt;%</span></span>
<span id="cb29-53"><a href="#cb29-53"></a>  <span class="fu">expand_grid</span>(., <span class="at">A =</span> <span class="dv">0</span><span class="sc">:</span><span class="dv">73</span>) <span class="sc">%&gt;%</span></span>
<span id="cb29-54"><a href="#cb29-54"></a>  <span class="co"># get P[Y = 1 | A = a]</span></span>
<span id="cb29-55"><a href="#cb29-55"></a>  <span class="fu">mutate</span>(<span class="at">pY =</span> pY0 <span class="sc">*</span> <span class="fu">exp</span>(logRR <span class="sc">*</span> A)) <span class="sc">%&gt;%</span></span>
<span id="cb29-56"><a href="#cb29-56"></a>  <span class="fu">select</span>(<span class="sc">-</span>pY0, <span class="sc">-</span>logRR) <span class="sc">%&gt;%</span></span>
<span id="cb29-57"><a href="#cb29-57"></a>  <span class="fu">pivot_wider</span>(<span class="at">id_cols =</span> A, <span class="at">names_from =</span> <span class="st">"name"</span>, <span class="at">values_from =</span> <span class="st">"pY"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb29-58"><a href="#cb29-58"></a>  <span class="fu">mutate</span>(<span class="at">type  =</span> <span class="st">"G-estimation (using an IV)"</span>)</span>
<span id="cb29-59"><a href="#cb29-59"></a></span>
<span id="cb29-60"><a href="#cb29-60"></a><span class="fu">bind_rows</span>(</span>
<span id="cb29-61"><a href="#cb29-61"></a>  g_computation_dose_response_extrapolated_levels,</span>
<span id="cb29-62"><a href="#cb29-62"></a>  g_estimation_dose_response</span>
<span id="cb29-63"><a href="#cb29-63"></a>) <span class="sc">%&gt;%</span></span>
<span id="cb29-64"><a href="#cb29-64"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> A, <span class="at">y =</span> estimate, <span class="at">color =</span> type)) <span class="sc">+</span></span>
<span id="cb29-65"><a href="#cb29-65"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb29-66"><a href="#cb29-66"></a>  <span class="co"># plot the true curve</span></span>
<span id="cb29-67"><a href="#cb29-67"></a>  <span class="fu">geom_line</span>(</span>
<span id="cb29-68"><a href="#cb29-68"></a>    <span class="at">data =</span> true_dose_response_curve, </span>
<span id="cb29-69"><a href="#cb29-69"></a>    <span class="fu">aes</span>(<span class="at">x =</span> A, <span class="at">y =</span> estimate), </span>
<span id="cb29-70"><a href="#cb29-70"></a>    <span class="at">color =</span> <span class="st">"gray20"</span>, <span class="at">linewidth =</span> <span class="fl">1.2</span>,, <span class="at">linetype =</span> <span class="st">"dotdash"</span>,</span>
<span id="cb29-71"><a href="#cb29-71"></a>    <span class="at">inherit.aes =</span> <span class="cn">FALSE</span></span>
<span id="cb29-72"><a href="#cb29-72"></a>  ) <span class="sc">+</span> </span>
<span id="cb29-73"><a href="#cb29-73"></a>  <span class="fu">geom_ribbon</span>(</span>
<span id="cb29-74"><a href="#cb29-74"></a>    <span class="fu">aes</span>(<span class="at">ymin =</span> conf.low, <span class="at">ymax =</span> conf.high, <span class="at">fill =</span> type), <span class="at">alpha =</span> <span class="fl">0.2</span></span>
<span id="cb29-75"><a href="#cb29-75"></a>  ) <span class="sc">+</span></span>
<span id="cb29-76"><a href="#cb29-76"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="fl">0.25</span>, <span class="fl">0.05</span>)) <span class="sc">+</span></span>
<span id="cb29-77"><a href="#cb29-77"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">80</span>, <span class="dv">10</span>)) <span class="sc">+</span></span>
<span id="cb29-78"><a href="#cb29-78"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"bottom"</span>, <span class="at">legend.title =</span> <span class="fu">element_blank</span>()) <span class="sc">+</span></span>
<span id="cb29-79"><a href="#cb29-79"></a>  <span class="fu">ylab</span>(<span class="st">"Predicted probability of Y = 1"</span>) <span class="sc">+</span> </span>
<span id="cb29-80"><a href="#cb29-80"></a>  <span class="fu">xlab</span>(<span class="st">"A (true curve in gray)"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-16-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<div class="page-columns page-full"><p>Assuming no-effect modification by <span class="math inline">\(U\)</span>, the point estimate and the CI endpoints from <code>ivglm</code> are used to first estimate <span class="math inline">\(\text{Pr}[Y = 1 | A = 0]\)</span> (which is the same as <span class="math inline">\(\text{Pr}[Y^{a = 0} = 1]\)</span><a href="#fn18" class="footnote-ref" id="fnref18" role="doc-noteref"><sup>18</sup></a>) by using the following relation</p><div class="no-row-height column-margin column-container"><li id="fn18"><p><sup>18</sup>&nbsp;assuming consistency</p></li></div></div>
<p><span class="math display">\[
\text{Pr}[Y^{a = 0} = 1] = \text{Pr}[Y = 1 | A = 0] = \text{E}[Y\ \text{exp}(\psi A)]
\]</span></p>
<p>and then using these to get the dose response curves and the following CIs</p>
<p><span class="math display">\[
\text{Pr}[Y = 1 | A] = \text{Pr}[Y = 1 | A = 0]\ \text{exp}[\psi A]
\]</span></p>
<p>The g-computation estimate is far narrower as the model has access to the information provided by <span class="math inline">\(U\)</span>, compared to the MSMM. The MSMM estimate for this sample underestimates the true value, which shows up as a large difference between the true and the MSMM curves at values of <span class="math inline">\(A\)</span> higher than 60.</p>
<p>These probabilities can be mapped to total sales / profit given the number of individuals within each treatment level. Whether these numbers can be <em>transported</em> or extrapolated to future campaigns or other populations depends on how similar the distribution of <span class="math inline">\(U\)</span> is across these groups. In that sense, these marginal estimates are actually conditional on the distribution of confounders and effect modifiers. I came across <a href="https://www.ncbi.nlm.nih.gov/pmc/articles/PMC5784860/">this paper</a> which would be interesting to read in the future.</p>
</section>
<section id="references" class="level2">
<h2 class="anchored" data-anchor-id="references">References</h2>
<p>This post is based on the following references</p>
<ul>
<li><p><a href="https://www.hsph.harvard.edu/miguel-hernan/causal-inference-book/">Hernán, Robins</a> - Causal Inference: What If? - Chapters 14 (g-estimation), and 16 (instrumental variables)</p></li>
<li><p><a href="https://projecteuclid.org/journals/statistical-science/volume-26/issue-3/On-Instrumental-Variables-Estimation-of-Causal-Odds-Ratios/10.1214/11-STS360.full">Vansteelandt et al.&nbsp;2011</a> - On Instrumental Variables Estimation of Causal Odds Ratios</p></li>
<li><p><a href="https://academic.oup.com/aje/article/173/12/1392/205870">Palmer et al.&nbsp;2011</a> - Instrumental Variable Estimation of Causal Risk Ratios and Causal Odds Ratios in Mendelian Randomization Analyses</p></li>
<li><p><a href="https://academic.oup.com/aje/article/187/5/1079/4930819">Dukes, Vansteelandt 2018</a> - A Note on G-Estimation of Causal Risk Ratios</p></li>
<li><p><a href="https://academic.oup.com/aje/article/180/1/111/2739174">Burgess et al.&nbsp;2014</a> - Lack of Identification in Semiparametric Instrumental Variable Models With Binary Outcomes</p></li>
<li><p><a href="https://www.degruyter.com/document/doi/10.1515/em-2018-0024/html">Sjolander, Martinussen 2019</a> - Instrumental Variable Estimation with the R Package ivtools</p></li>
</ul>
</section>
<section id="simulated-data" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="simulated-data">Simulated data</h2>
<div class="page-columns page-full"><p>The four figures — going clockwise from top left — show 1) the probability of compliance as a function of the confounder <span class="math inline">\(U\)</span> (where <span class="math inline">\(\text{Pr}[C = 1 | U] = 1 / (1 + \text{exp}(-2 + 0.5)) u,\ u \in [0, 10]\)</span>), 2) the realized distribution of the treatment levels among those who received the treatment<a href="#fn19" class="footnote-ref" id="fnref19" role="doc-noteref"><sup>19</sup></a> simulated from the truncated <em>Gamma</em> distribution <span class="math inline">\(x_i \sim \text{max}(1, \text{min}(\Gamma(\text{shape} = 5,\ \text{scale} = 4), 100))\)</span>, 3) balance of <span class="math inline">\(U\)</span> across levels of <span class="math inline">\(Z\)</span> (which is balanced because of randomization), and 4) balance of <span class="math inline">\(U\)</span> across levels of <span class="math inline">\(A\)</span> (which is <em>not</em> balanced because of confounding by <span class="math inline">\(U\)</span>)</p><div class="no-row-height column-margin column-container"><li id="fn19"><p><sup>19</sup>&nbsp;a value is sampled for each individual, but is realized only if <span class="math inline">\(Z = 1\)</span> and <span class="math inline">\(C = 1\)</span> (where <span class="math inline">\(C\)</span> is the compliance indicator)</p></li></div></div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1"></a><span class="co"># probability of compliance as a function of the confounder</span></span>
<span id="cb30-2"><a href="#cb30-2"></a>p_compliance <span class="ot">&lt;-</span> df_large <span class="sc">%&gt;%</span></span>
<span id="cb30-3"><a href="#cb30-3"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> U, <span class="at">y =</span> prob_C)) <span class="sc">+</span></span>
<span id="cb30-4"><a href="#cb30-4"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span> </span>
<span id="cb30-5"><a href="#cb30-5"></a>  <span class="fu">ylab</span>(<span class="st">"Compliance probability"</span>) <span class="sc">+</span></span>
<span id="cb30-6"><a href="#cb30-6"></a>  <span class="fu">coord_cartesian</span>(<span class="at">y =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>))</span>
<span id="cb30-7"><a href="#cb30-7"></a></span>
<span id="cb30-8"><a href="#cb30-8"></a><span class="co"># observed distribution of exposure levels</span></span>
<span id="cb30-9"><a href="#cb30-9"></a>A_dist <span class="ot">&lt;-</span> df_large <span class="sc">%&gt;%</span></span>
<span id="cb30-10"><a href="#cb30-10"></a>  <span class="fu">filter</span>(A <span class="sc">&gt;</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span></span>
<span id="cb30-11"><a href="#cb30-11"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> A)) <span class="sc">+</span></span>
<span id="cb30-12"><a href="#cb30-12"></a>  <span class="fu">geom_bar</span>() <span class="sc">+</span></span>
<span id="cb30-13"><a href="#cb30-13"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">100</span>, <span class="dv">10</span>), </span>
<span id="cb30-14"><a href="#cb30-14"></a>                     <span class="at">labels =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">100</span>, <span class="dv">10</span>))</span>
<span id="cb30-15"><a href="#cb30-15"></a></span>
<span id="cb30-16"><a href="#cb30-16"></a><span class="co"># check balance of U across Z</span></span>
<span id="cb30-17"><a href="#cb30-17"></a><span class="co"># balanced as expected, because Z is a randomization indicator</span></span>
<span id="cb30-18"><a href="#cb30-18"></a>UZ_plot <span class="ot">&lt;-</span> df_large <span class="sc">%&gt;%</span></span>
<span id="cb30-19"><a href="#cb30-19"></a>  <span class="fu">mutate</span>(<span class="at">Z =</span> <span class="fu">factor</span>(Z, <span class="at">levels =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">0</span>), </span>
<span id="cb30-20"><a href="#cb30-20"></a>                    <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"Treatment"</span>, <span class="st">"Control"</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb30-21"><a href="#cb30-21"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> U, <span class="at">color =</span> Z)) <span class="sc">+</span></span>
<span id="cb30-22"><a href="#cb30-22"></a>  <span class="fu">geom_density</span>() <span class="sc">+</span></span>
<span id="cb30-23"><a href="#cb30-23"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"bottom"</span>)</span>
<span id="cb30-24"><a href="#cb30-24"></a></span>
<span id="cb30-25"><a href="#cb30-25"></a><span class="co"># check balance across (dichotomized version of) A</span></span>
<span id="cb30-26"><a href="#cb30-26"></a><span class="co"># not balanced because U and A are associated</span></span>
<span id="cb30-27"><a href="#cb30-27"></a>UA_plot <span class="ot">&lt;-</span> df_large <span class="sc">%&gt;%</span></span>
<span id="cb30-28"><a href="#cb30-28"></a>  <span class="fu">mutate</span>(</span>
<span id="cb30-29"><a href="#cb30-29"></a>    <span class="st">`</span><span class="at">A (binary)</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">factor</span>(<span class="fu">as.numeric</span>(A <span class="sc">&gt;</span> <span class="dv">0</span>), </span>
<span id="cb30-30"><a href="#cb30-30"></a>                          <span class="at">levels =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">0</span>), </span>
<span id="cb30-31"><a href="#cb30-31"></a>                          <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"Treated"</span>, <span class="st">"Control"</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb30-32"><a href="#cb30-32"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> U, <span class="at">color =</span> <span class="st">`</span><span class="at">A (binary)</span><span class="st">`</span>)) <span class="sc">+</span></span>
<span id="cb30-33"><a href="#cb30-33"></a>  <span class="fu">geom_density</span>() <span class="sc">+</span></span>
<span id="cb30-34"><a href="#cb30-34"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"bottom"</span>)</span>
<span id="cb30-35"><a href="#cb30-35"></a></span>
<span id="cb30-36"><a href="#cb30-36"></a>gridExtra<span class="sc">::</span><span class="fu">grid.arrange</span>(p_compliance, A_dist, </span>
<span id="cb30-37"><a href="#cb30-37"></a>                        UZ_plot, UA_plot, <span class="at">ncol =</span> <span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-17-1.png" class="img-fluid" width="672"></p>
</div>
</div>


<!-- -->

</section>


</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  let localAlternateSentinel = 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb31" data-shortcodes="false"><pre class="sourceCode numberSource markdown number-lines code-with-copy"><code class="sourceCode markdown"><span id="cb31-1"><a href="#cb31-1"></a><span class="co">---</span></span>
<span id="cb31-2"><a href="#cb31-2"></a><span class="an">title:</span><span class="co"> "Using an obscure causal inference method to estimate treatment effects with the help of another less obscure causal inference method"</span></span>
<span id="cb31-3"><a href="#cb31-3"></a><span class="an">date:</span><span class="co"> "2024-02-09"</span></span>
<span id="cb31-4"><a href="#cb31-4"></a><span class="an">categories:</span><span class="co"> [Causal Inference, Instrumental Variables, G-estimation, G-computation, GEE, R]</span></span>
<span id="cb31-5"><a href="#cb31-5"></a><span class="an">code-fold:</span><span class="co"> true</span></span>
<span id="cb31-6"><a href="#cb31-6"></a><span class="an">toc-expand:</span><span class="co"> true</span></span>
<span id="cb31-7"><a href="#cb31-7"></a><span class="an">reference-location:</span><span class="co"> margin</span></span>
<span id="cb31-8"><a href="#cb31-8"></a><span class="an">image:</span><span class="co"> "image-MSMM-IV.png"</span></span>
<span id="cb31-9"><a href="#cb31-9"></a><span class="co">---</span></span>
<span id="cb31-10"><a href="#cb31-10"></a></span>
<span id="cb31-11"><a href="#cb31-11"></a><span class="fu">## Introduction</span></span>
<span id="cb31-12"><a href="#cb31-12"></a></span>
<span id="cb31-13"><a href="#cb31-13"></a>In a <span class="co">[</span><span class="ot">previous post</span><span class="co">](../instrumental-variable-in-RCT/index.qmd)</span>, I used the *ratio estimator* and the method of *instrumental variables* (IV) to estimate the effect of showing an ad on sales from a fictitious ad campaign.</span>
<span id="cb31-14"><a href="#cb31-14"></a></span>
<span id="cb31-15"><a href="#cb31-15"></a>This post uses the lesser-known method of *g-estimation*[^1] to estimate the effect of a continuous exposure variable in a *multiplicative structural mean model* (MSMM) by using the randomization indicator as an instrumental variable to obtain valid treatment effect estimates in the presence of unmeasured confounding.</span>
<span id="cb31-16"><a href="#cb31-16"></a></span>
<span id="cb31-17"><a href="#cb31-17"></a><span class="ot">[^1]: </span>less popular compared to IPTW and PSM, hence the clickbait-y title</span>
<span id="cb31-18"><a href="#cb31-18"></a></span>
<span id="cb31-19"><a href="#cb31-19"></a>As mentioned towards the end of the previous post, analyzing the treated individuals by collapsing them into a single 'treated' group was a simplification. The observed treatment variable would in reality be the number of impressions of the ad --- naturally varying between individuals in the treated group, but zero among the individuals assigned to the control group and among the *never-takers*<span class="ot">[^2]</span>.</span>
<span id="cb31-20"><a href="#cb31-20"></a></span>
<span id="cb31-21"><a href="#cb31-21"></a><span class="ot">[^2]: </span>i.e., people who would not take the treatment if assigned to the treatment group. *Defiers* and *always-takers* aren't possible as individuals in the control group cannot see an ad, because compliance in the control arm is ensured by design.</span>
<span id="cb31-22"><a href="#cb31-22"></a></span>
<span id="cb31-23"><a href="#cb31-23"></a><span class="fu">## Parameter of interest</span></span>
<span id="cb31-24"><a href="#cb31-24"></a></span>
<span id="cb31-25"><a href="#cb31-25"></a>If $U$ indicates the (possibly multivalued) set of unmeasured confounders, $Z$ the binary randomization variable indicating group assignment (treatment or control), $A$ the integral exposure variable indicating observed treatment level $a$ in $<span class="sc">\{</span>0, 1, 2, … <span class="sc">\}</span>$, then an estimand or parameter of interest is the marginal *causal risk ratio* (CRR)</span>
<span id="cb31-26"><a href="#cb31-26"></a></span>
<span id="cb31-27"><a href="#cb31-27"></a>$$</span>
<span id="cb31-28"><a href="#cb31-28"></a>\text{ATE} = \frac{\text{Pr}<span class="co">[</span><span class="ot">Y^{a + 1} = 1</span><span class="co">]</span>}{\text{Pr}<span class="co">[</span><span class="ot">Y^{a} = 1</span><span class="co">]</span>}</span>
<span id="cb31-29"><a href="#cb31-29"></a>$$\</span>
<span id="cb31-30"><a href="#cb31-30"></a>This is usually the target of inference in an experiment with perfect compliance, and corresponds to setting the treatment level to $A = a + 1$ vs $A = a$ for the full population ($Y^a$ denotes the potential outcome under treatment level $a$).</span>
<span id="cb31-31"><a href="#cb31-31"></a></span>
<span id="cb31-32"><a href="#cb31-32"></a>Another estimand of interest may be the *average treatment effect in the treated* (ATT) or the *effect of the treatment on the treated* (ETT). This compares the treated individuals to the *counterfactual scenario had they not been treated*. This corresponds to $$</span>
<span id="cb31-33"><a href="#cb31-33"></a>\text{ATT} = \frac{\text{Pr}<span class="co">[</span><span class="ot">Y^a = 1 | A = a</span><span class="co">]</span>}{\text{Pr}<span class="co">[</span><span class="ot">Y^{a = 0} = 1 | A = a</span><span class="co">]</span>}</span>
<span id="cb31-34"><a href="#cb31-34"></a>$$</span>
<span id="cb31-35"><a href="#cb31-35"></a></span>
<span id="cb31-36"><a href="#cb31-36"></a>In a setting with noncompliance (possibly due to unmeasured confounding), the estimand can be further conditioned on the IV $Z$</span>
<span id="cb31-37"><a href="#cb31-37"></a></span>
<span id="cb31-38"><a href="#cb31-38"></a>$$</span>
<span id="cb31-39"><a href="#cb31-39"></a>\text{ATT}_{IV} = \frac{\text{Pr}<span class="co">[</span><span class="ot">Y^a = 1 | A = a, Z</span><span class="co">]</span>}{\text{Pr}<span class="co">[</span><span class="ot">Y^{a = 0} = 1 | A = a, Z</span><span class="co">]</span>}</span>
<span id="cb31-40"><a href="#cb31-40"></a>$$</span>
<span id="cb31-41"><a href="#cb31-41"></a></span>
<span id="cb31-42"><a href="#cb31-42"></a>The main MSMM used in this post estimates the ATE if the unmeasured confounders $U$ are *not effect-measure modifiers* (i.e., the impact of treatment $A$ on the ratio scale is the same on $Y$ at all levels of $U$). If $U$ is an effect modifier, but $Z$ is not, then the MSMM estimate can be interpreted as the $\text{ATT}_{IV}$.</span>
<span id="cb31-43"><a href="#cb31-43"></a></span>
<span id="cb31-44"><a href="#cb31-44"></a>Pages 2-3 of <span class="co">[</span><span class="ot">this paper</span><span class="co">](https://projecteuclid.org/journals/statistical-science/volume-26/issue-3/On-Instrumental-Variables-Estimation-of-Causal-Odds-Ratios/10.1214/11-STS360.full)</span> provide a concise yet illuminating discussion of the different effect measures that can be of interest.</span>
<span id="cb31-45"><a href="#cb31-45"></a></span>
<span id="cb31-46"><a href="#cb31-46"></a>Since risk ratios are *collapsible* (see <span class="co">[</span><span class="ot">this excellent paper</span><span class="co">](https://onlinelibrary.wiley.com/doi/full/10.1002/bimj.201900297)</span>), the (confounder-adjusted) marginal and conditional estimands are identical<span class="ot">[^3]</span>.</span>
<span id="cb31-47"><a href="#cb31-47"></a></span>
<span id="cb31-48"><a href="#cb31-48"></a><span class="ot">[^3]: </span>which is only the case for risk differences and risk ratios.</span>
<span id="cb31-49"><a href="#cb31-49"></a></span>
<span id="cb31-50"><a href="#cb31-50"></a>Before writing any code, the main packages used in this post are attached.</span>
<span id="cb31-51"><a href="#cb31-51"></a></span>
<span id="cb31-54"><a href="#cb31-54"></a><span class="in">```{r}</span></span>
<span id="cb31-55"><a href="#cb31-55"></a><span class="co">#| code-fold: show</span></span>
<span id="cb31-56"><a href="#cb31-56"></a></span>
<span id="cb31-57"><a href="#cb31-57"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb31-58"><a href="#cb31-58"></a><span class="fu">library</span>(broom, <span class="at">include.only =</span> <span class="st">"tidy"</span>)</span>
<span id="cb31-59"><a href="#cb31-59"></a></span>
<span id="cb31-60"><a href="#cb31-60"></a><span class="co"># functions from the following packages are called via package::fun()</span></span>
<span id="cb31-61"><a href="#cb31-61"></a><span class="co"># to reduce namespace conflicts</span></span>
<span id="cb31-62"><a href="#cb31-62"></a><span class="co"># library(geeM)</span></span>
<span id="cb31-63"><a href="#cb31-63"></a><span class="co"># library(mgcv)</span></span>
<span id="cb31-64"><a href="#cb31-64"></a><span class="co"># library(ivtools)</span></span>
<span id="cb31-65"><a href="#cb31-65"></a><span class="co"># library(marginaleffects)</span></span>
<span id="cb31-66"><a href="#cb31-66"></a><span class="co"># library(glue)</span></span>
<span id="cb31-67"><a href="#cb31-67"></a><span class="co"># library(gridExtra)</span></span>
<span id="cb31-68"><a href="#cb31-68"></a></span>
<span id="cb31-69"><a href="#cb31-69"></a><span class="fu">theme_set</span>(<span class="fu">theme_bw</span>())</span>
<span id="cb31-70"><a href="#cb31-70"></a><span class="in">```</span></span>
<span id="cb31-71"><a href="#cb31-71"></a></span>
<span id="cb31-72"><a href="#cb31-72"></a><span class="fu">## G-estimation in a nutshell</span></span>
<span id="cb31-73"><a href="#cb31-73"></a></span>
<span id="cb31-74"><a href="#cb31-74"></a>The first time I read the chapter on g-estimation in the what-if book, it went over my head completely<span class="ot">[^4]</span>. Conceptually, it seemed harder than the more popular (g-)methods of *g-computation* and *inverse probability of treatment weighting* (IPTW). However, its superiority to g-computation in terms of not being prone to bias due to extrapolation, superiority to IPTW<span class="ot">[^5]</span> in terms of having less variability (and bias), and relative ease of handling continuous exposures (and continuous instruments) piqued my curiosity<span class="ot">[^6]</span>.</span>
<span id="cb31-75"><a href="#cb31-75"></a></span>
<span id="cb31-76"><a href="#cb31-76"></a><span class="ot">[^4]: </span>May have had something to do with the fact that I was attempting this at 3 AM in between sleep cycles.</span>
<span id="cb31-77"><a href="#cb31-77"></a></span>
<span id="cb31-78"><a href="#cb31-78"></a><span class="ot">[^5]: </span>I think this isn't an issue if *overlap* (ATO) weights are used instead of the usual ATE weights, as g-estimation gives higher weight to strata with greater overlap, and empty strata don't contribute to the final estimate.</span>
<span id="cb31-79"><a href="#cb31-79"></a></span>
<span id="cb31-80"><a href="#cb31-80"></a><span class="ot">[^6]: </span>I'm basing this on the Dukes, Vansteelandt paper.</span>
<span id="cb31-81"><a href="#cb31-81"></a></span>
<span id="cb31-82"><a href="#cb31-82"></a>Another advantage is that there's no need to correctly model the relationship between the confounders $U$ and the outcome $Y$ for the correct estimation of the treatment effect. This would not be the case when using (*log-)binomial* or *poisson* regression, where misspecification of the $U-Y$ relationship can bias the estimate for $A$.</span>
<span id="cb31-83"><a href="#cb31-83"></a></span>
<span id="cb31-84"><a href="#cb31-84"></a>The essence of g-estimation is simple<span class="ot">[^7]</span> -- once the true effect of the treatment $\psi$ is shaved off from the response variable $Y$, the residuals $H(\psi) = Y - \psi A = Y^{a = 0}$ should be uncorrelated with the treatment $A$ in the confounder-adjusted propensity model, i.e., $\text{Cov}(A, H(\psi) | U) = 0$<span class="ot">[^8]</span>. This is the same as picking the value of $\psi$ that leads to $\alpha_1 = 0$ in $\mathbb{E}<span class="co">[</span><span class="ot">A | Y^{a=0}, U</span><span class="co">]</span> = \alpha_0 + \alpha_1 H(\psi) + \sum_{j=2}^k \alpha_j U_{j-1}$<span class="ot">[^9]</span>. For MSMMs, $H(\psi) = Y \text{exp}(- \psi A)$ is used where $\psi$ is the risk ratio on the log scale.</span>
<span id="cb31-85"><a href="#cb31-85"></a></span>
<span id="cb31-86"><a href="#cb31-86"></a><span class="ot">[^7]: </span>after having grasped it that is</span>
<span id="cb31-87"><a href="#cb31-87"></a></span>
<span id="cb31-88"><a href="#cb31-88"></a><span class="ot">[^8]: </span>Cov denotes *covariance.*</span>
<span id="cb31-89"><a href="#cb31-89"></a></span>
<span id="cb31-90"><a href="#cb31-90"></a><span class="ot">[^9]: </span>For a binary exposure variable, the $\mathbb{E}<span class="co">[</span><span class="ot">A</span><span class="co">]</span>$ is replaced by $\text{logit(Pr<span class="co">[</span><span class="ot">A = 1</span><span class="co">]</span>)}$, where $\text{logit}(p) = \text{log}\Big(\frac{p}{1-p}\Big)$ and $p$ is the probability $\text{Pr}<span class="co">[</span><span class="ot">A = 1</span><span class="co">]</span>$.</span>
<span id="cb31-91"><a href="#cb31-91"></a></span>
<span id="cb31-92"><a href="#cb31-92"></a>This works because of the *conditional mean independence* assumption --- that the exposed and unexposed individuals are exchangeable within levels of $U$ (i.e., $Y^{a = 0} \perp\!\!\!\perp A|U$) as would be the case for a conditionally randomized experiment. In a marginally randomized experiment, the treatment assigned and received is independent of the potential outcomes, which would not be the case if people with (say) higher levels of $U$ were more likely to take the treatment ($A &gt; 0$) and have a positive outcome $Y = 1$. In this scenario, it wouldn't be possible to say whether it was $A$ or $U$ causing better outcomes. This *lack-of-identification* is due to confounding between the effect of $U$ on $Y$ and the effect of $A$ on $Y$.</span>
<span id="cb31-93"><a href="#cb31-93"></a></span>
<span id="cb31-94"><a href="#cb31-94"></a>Suppose the following dataset is available (with a true CRR value of 1.02, 70% treatment-control split, and 40% non-compliance (never-takers))</span>
<span id="cb31-95"><a href="#cb31-95"></a></span>
<span id="cb31-98"><a href="#cb31-98"></a><span class="in">```{r}</span></span>
<span id="cb31-99"><a href="#cb31-99"></a>simulate_data <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">seed =</span> <span class="dv">24</span>, <span class="at">n =</span> <span class="fl">1e5</span>) {</span>
<span id="cb31-100"><a href="#cb31-100"></a>  </span>
<span id="cb31-101"><a href="#cb31-101"></a>  confounder_values <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="fl">1e5</span>, <span class="dv">50</span>) <span class="sc">/</span> <span class="fl">1e4</span></span>
<span id="cb31-102"><a href="#cb31-102"></a>  </span>
<span id="cb31-103"><a href="#cb31-103"></a>  <span class="fu">set.seed</span>(seed)</span>
<span id="cb31-104"><a href="#cb31-104"></a>  <span class="fu">tibble</span>(</span>
<span id="cb31-105"><a href="#cb31-105"></a>    <span class="at">id =</span> <span class="dv">1</span><span class="sc">:</span>n,</span>
<span id="cb31-106"><a href="#cb31-106"></a>    <span class="co"># randomization indicator / instrument, indicates group assignment</span></span>
<span id="cb31-107"><a href="#cb31-107"></a>    <span class="at">Z =</span> <span class="fu">rbinom</span>(n, <span class="dv">1</span>, <span class="at">prob =</span> <span class="fl">0.7</span>),</span>
<span id="cb31-108"><a href="#cb31-108"></a>    <span class="co"># simulate continuous confounder value</span></span>
<span id="cb31-109"><a href="#cb31-109"></a>    <span class="at">U =</span> <span class="fu">sample</span>(<span class="at">x =</span> confounder_values, <span class="at">size =</span> n, <span class="at">replace =</span> <span class="cn">TRUE</span>),</span>
<span id="cb31-110"><a href="#cb31-110"></a>    <span class="co"># simulate (conditional) compliance indicator</span></span>
<span id="cb31-111"><a href="#cb31-111"></a>    <span class="at">prob_C =</span> <span class="fu">plogis</span>(<span class="dv">2</span> <span class="sc">-</span> <span class="fl">0.5</span> <span class="sc">*</span> U),</span>
<span id="cb31-112"><a href="#cb31-112"></a>    <span class="at">C =</span> <span class="fu">rbinom</span>(n, <span class="dv">1</span>, prob_C),</span>
<span id="cb31-113"><a href="#cb31-113"></a>    <span class="co"># simulate observed treatment</span></span>
<span id="cb31-114"><a href="#cb31-114"></a>    <span class="co"># potential continuous exposure value is simulated </span></span>
<span id="cb31-115"><a href="#cb31-115"></a>    <span class="co"># for each individual on [1, 100]</span></span>
<span id="cb31-116"><a href="#cb31-116"></a>    <span class="co"># but for those that have Z = 0 (control) or C = 0 (never-takers), A = 0</span></span>
<span id="cb31-117"><a href="#cb31-117"></a>    <span class="at">A =</span> Z <span class="sc">*</span> C <span class="sc">*</span> <span class="fu">pmin</span>(<span class="fu">pmax</span>(<span class="fu">round</span>(<span class="fu">rgamma</span>(n, <span class="at">shape =</span> <span class="dv">5</span>, <span class="at">scale =</span> <span class="dv">4</span>)), <span class="dv">1</span>), <span class="dv">100</span>),</span>
<span id="cb31-118"><a href="#cb31-118"></a>    <span class="co"># response variable simulated with risk ratios specified</span></span>
<span id="cb31-119"><a href="#cb31-119"></a>    <span class="co"># baseline log probabilities</span></span>
<span id="cb31-120"><a href="#cb31-120"></a>    <span class="at">logpY0 =</span> <span class="fu">log</span>(<span class="fl">0.002</span>) <span class="sc">+</span> <span class="fu">log</span>(<span class="fl">1.4</span>) <span class="sc">*</span> U,</span>
<span id="cb31-121"><a href="#cb31-121"></a>    <span class="co"># impact of treatment</span></span>
<span id="cb31-122"><a href="#cb31-122"></a>    <span class="at">logpY1 =</span> logpY0 <span class="sc">+</span> <span class="fu">log</span>(<span class="fl">1.02</span>) <span class="sc">*</span> A,</span>
<span id="cb31-123"><a href="#cb31-123"></a>    <span class="co"># simulated binary responses from log-binomial model</span></span>
<span id="cb31-124"><a href="#cb31-124"></a>    <span class="at">Y =</span> <span class="fu">rbinom</span>(n, <span class="dv">1</span>, <span class="fu">exp</span>(logpY1))</span>
<span id="cb31-125"><a href="#cb31-125"></a>  )</span>
<span id="cb31-126"><a href="#cb31-126"></a>}</span>
<span id="cb31-127"><a href="#cb31-127"></a></span>
<span id="cb31-128"><a href="#cb31-128"></a>df_large <span class="ot">&lt;-</span> <span class="fu">simulate_data</span>() <span class="sc">%&gt;%</span></span>
<span id="cb31-129"><a href="#cb31-129"></a>  <span class="fu">glimpse</span>()</span>
<span id="cb31-130"><a href="#cb31-130"></a><span class="in">```</span></span>
<span id="cb31-131"><a href="#cb31-131"></a></span>
<span id="cb31-132"><a href="#cb31-132"></a>For exploring g-estimation with no-unmeasured confounding (since $U$ is measured) in the simple model represented by the *directed acyclic graph* (DAG) $A \leftarrow U \rightarrow Y$ and $A \rightarrow Y$, one way of estimating the treatment effect $\psi$ is using *grid search* which visually looks like this when the estimated coefficient for $\alpha_1$ is plotted on the Y-axis</span>
<span id="cb31-133"><a href="#cb31-133"></a></span>
<span id="cb31-136"><a href="#cb31-136"></a><span class="in">```{r}</span></span>
<span id="cb31-137"><a href="#cb31-137"></a>grid_search_coefficient <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="sc">-</span><span class="dv">1</span>, <span class="dv">1</span>, <span class="fl">0.05</span>) <span class="sc">%&gt;%</span></span>
<span id="cb31-138"><a href="#cb31-138"></a>  <span class="co"># get the coefficient from the correct and incorrect propensity models</span></span>
<span id="cb31-139"><a href="#cb31-139"></a>  <span class="fu">map_dfr</span>(<span class="at">.f =</span> <span class="sc">~</span> {</span>
<span id="cb31-140"><a href="#cb31-140"></a></span>
<span id="cb31-141"><a href="#cb31-141"></a>    temp_df <span class="ot">&lt;-</span> df_large <span class="sc">%&gt;%</span></span>
<span id="cb31-142"><a href="#cb31-142"></a>      <span class="fu">mutate</span>(<span class="at">H =</span> Y <span class="sc">*</span> <span class="fu">exp</span>(<span class="sc">-</span>.x <span class="sc">*</span> A))</span>
<span id="cb31-143"><a href="#cb31-143"></a></span>
<span id="cb31-144"><a href="#cb31-144"></a>    <span class="fu">list</span>(<span class="st">`</span><span class="at">No unmeasured confounding</span><span class="st">`</span> <span class="ot">=</span> <span class="st">"A ~ H + U"</span>, </span>
<span id="cb31-145"><a href="#cb31-145"></a>         <span class="st">`</span><span class="at">Unmeasured confounding</span><span class="st">`</span> <span class="ot">=</span> <span class="st">"A ~ H"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb31-146"><a href="#cb31-146"></a>      <span class="fu">map_dfc</span>(<span class="at">.f =</span> <span class="sc">~</span> {</span>
<span id="cb31-147"><a href="#cb31-147"></a>        temp_df <span class="sc">%&gt;%</span></span>
<span id="cb31-148"><a href="#cb31-148"></a>          <span class="fu">lm</span>(<span class="fu">formula</span>(.x), <span class="at">data =</span> .) <span class="sc">%&gt;%</span></span>
<span id="cb31-149"><a href="#cb31-149"></a>          <span class="fu">tidy</span>() <span class="sc">%&gt;%</span></span>
<span id="cb31-150"><a href="#cb31-150"></a>          <span class="fu">filter</span>(term <span class="sc">==</span> <span class="st">"H"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb31-151"><a href="#cb31-151"></a>          <span class="fu">pull</span>(estimate)</span>
<span id="cb31-152"><a href="#cb31-152"></a>      }) <span class="sc">%&gt;%</span></span>
<span id="cb31-153"><a href="#cb31-153"></a>      <span class="fu">mutate</span>(<span class="at">psi =</span> .x, <span class="at">.before =</span> <span class="st">`</span><span class="at">No unmeasured confounding</span><span class="st">`</span>)</span>
<span id="cb31-154"><a href="#cb31-154"></a>  }) </span>
<span id="cb31-155"><a href="#cb31-155"></a></span>
<span id="cb31-156"><a href="#cb31-156"></a>grid_search_coefficient <span class="sc">%&gt;%</span></span>
<span id="cb31-157"><a href="#cb31-157"></a>  <span class="fu">pivot_longer</span>(<span class="sc">-</span>psi) <span class="sc">%&gt;%</span></span>
<span id="cb31-158"><a href="#cb31-158"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">exp</span>(psi), <span class="at">y =</span> value, <span class="at">color =</span> name)) <span class="sc">+</span></span>
<span id="cb31-159"><a href="#cb31-159"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb31-160"><a href="#cb31-160"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb31-161"><a href="#cb31-161"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="fl">1.02</span>, <span class="at">linetype =</span> <span class="st">"dotdash"</span>) <span class="sc">+</span></span>
<span id="cb31-162"><a href="#cb31-162"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">linetype =</span> <span class="st">"dotdash"</span>) <span class="sc">+</span></span>
<span id="cb31-163"><a href="#cb31-163"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="sc">-</span><span class="fl">2.5</span>, <span class="at">linetype =</span> <span class="st">"dotdash"</span>) <span class="sc">+</span></span>
<span id="cb31-164"><a href="#cb31-164"></a>  <span class="fu">xlab</span>(<span class="st">"Risk ratio (true value: 1.02)"</span>) <span class="sc">+</span></span>
<span id="cb31-165"><a href="#cb31-165"></a>  <span class="fu">ylab</span>(</span>
<span id="cb31-166"><a href="#cb31-166"></a>    glue<span class="sc">::</span><span class="fu">glue</span>(<span class="st">"Estimated coefficient for H(\U1D713)"</span>,</span>
<span id="cb31-167"><a href="#cb31-167"></a>               <span class="st">" </span><span class="sc">\n</span><span class="st">from the propensity model"</span>)</span>
<span id="cb31-168"><a href="#cb31-168"></a>  ) <span class="sc">+</span></span>
<span id="cb31-169"><a href="#cb31-169"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"bottom"</span>, <span class="at">legend.title =</span> <span class="fu">element_blank</span>()) <span class="sc">+</span></span>
<span id="cb31-170"><a href="#cb31-170"></a>  <span class="fu">coord_cartesian</span>(<span class="at">xlim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">3</span>), <span class="at">ylim =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">6</span>, <span class="dv">4</span>))</span>
<span id="cb31-171"><a href="#cb31-171"></a><span class="in">```</span></span>
<span id="cb31-172"><a href="#cb31-172"></a></span>
<span id="cb31-173"><a href="#cb31-173"></a>or like this when the $p$-value is plotted on the Y-axis (on a narrower grid)</span>
<span id="cb31-174"><a href="#cb31-174"></a></span>
<span id="cb31-177"><a href="#cb31-177"></a><span class="in">```{r}</span></span>
<span id="cb31-178"><a href="#cb31-178"></a>grid_search_pvalue <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="sc">-</span><span class="fl">0.05</span>, <span class="fl">0.05</span>, <span class="fl">0.001</span>) <span class="sc">%&gt;%</span></span>
<span id="cb31-179"><a href="#cb31-179"></a>  <span class="co"># get the coefficient from the correct and incorrect propensity models</span></span>
<span id="cb31-180"><a href="#cb31-180"></a>  <span class="fu">map_dfr</span>(<span class="at">.f =</span> <span class="sc">~</span> {</span>
<span id="cb31-181"><a href="#cb31-181"></a></span>
<span id="cb31-182"><a href="#cb31-182"></a>    temp_df <span class="ot">&lt;-</span> df_large <span class="sc">%&gt;%</span></span>
<span id="cb31-183"><a href="#cb31-183"></a>      <span class="fu">mutate</span>(<span class="at">H =</span> Y <span class="sc">*</span> <span class="fu">exp</span>(<span class="sc">-</span>.x <span class="sc">*</span> A))</span>
<span id="cb31-184"><a href="#cb31-184"></a></span>
<span id="cb31-185"><a href="#cb31-185"></a>    <span class="fu">list</span>(<span class="st">`</span><span class="at">No unmeasured confounding</span><span class="st">`</span> <span class="ot">=</span> <span class="st">"A ~ H + U"</span>, </span>
<span id="cb31-186"><a href="#cb31-186"></a>         <span class="st">`</span><span class="at">Unmeasured confounding</span><span class="st">`</span> <span class="ot">=</span> <span class="st">"A ~ H"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb31-187"><a href="#cb31-187"></a>      <span class="fu">map_dfc</span>(<span class="at">.f =</span> <span class="sc">~</span> {</span>
<span id="cb31-188"><a href="#cb31-188"></a>        temp_df <span class="sc">%&gt;%</span></span>
<span id="cb31-189"><a href="#cb31-189"></a>          <span class="fu">lm</span>(<span class="fu">formula</span>(.x), <span class="at">data =</span> .) <span class="sc">%&gt;%</span></span>
<span id="cb31-190"><a href="#cb31-190"></a>          <span class="fu">tidy</span>() <span class="sc">%&gt;%</span></span>
<span id="cb31-191"><a href="#cb31-191"></a>          <span class="fu">filter</span>(term <span class="sc">==</span> <span class="st">"H"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb31-192"><a href="#cb31-192"></a>          <span class="fu">pull</span>(p.value)</span>
<span id="cb31-193"><a href="#cb31-193"></a>      }) <span class="sc">%&gt;%</span></span>
<span id="cb31-194"><a href="#cb31-194"></a>      <span class="fu">mutate</span>(<span class="at">psi =</span> .x, <span class="at">.before =</span> <span class="st">`</span><span class="at">No unmeasured confounding</span><span class="st">`</span>)</span>
<span id="cb31-195"><a href="#cb31-195"></a>  }) </span>
<span id="cb31-196"><a href="#cb31-196"></a></span>
<span id="cb31-197"><a href="#cb31-197"></a>grid_search_pvalue <span class="sc">%&gt;%</span></span>
<span id="cb31-198"><a href="#cb31-198"></a>  <span class="fu">pivot_longer</span>(<span class="sc">-</span><span class="fu">c</span>(psi)) <span class="sc">%&gt;%</span></span>
<span id="cb31-199"><a href="#cb31-199"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">exp</span>(psi), <span class="at">y =</span> value, <span class="at">color =</span> name)) <span class="sc">+</span></span>
<span id="cb31-200"><a href="#cb31-200"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb31-201"><a href="#cb31-201"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb31-202"><a href="#cb31-202"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="fl">1.02</span>, <span class="at">linetype =</span> <span class="st">"dotdash"</span>) <span class="sc">+</span></span>
<span id="cb31-203"><a href="#cb31-203"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">linetype =</span> <span class="st">"dotdash"</span>) <span class="sc">+</span></span>
<span id="cb31-204"><a href="#cb31-204"></a>  <span class="fu">xlab</span>(<span class="st">"Risk ratio (true value: 1.02)"</span>) <span class="sc">+</span></span>
<span id="cb31-205"><a href="#cb31-205"></a>  <span class="fu">ylab</span>(<span class="st">"P-value for the test of alpha1 = 0"</span>) <span class="sc">+</span></span>
<span id="cb31-206"><a href="#cb31-206"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"bottom"</span>, <span class="at">legend.title =</span> <span class="fu">element_blank</span>())</span>
<span id="cb31-207"><a href="#cb31-207"></a><span class="in">```</span></span>
<span id="cb31-208"><a href="#cb31-208"></a></span>
<span id="cb31-209"><a href="#cb31-209"></a>From both the graphs, it's evident that the estimate from the correctly specified propensity model is much closer to the true value of 1.02 (or 2% increase when going from $A = a$ to $A = a + 1$) compared to the estimate from the propensity model without $U$. Recovering the true effect in the presence of unmeasured confounding would require knowing which non-zero value of $\alpha_1$ (here about -2.5) corresponds to the true value of $\psi$.</span>
<span id="cb31-210"><a href="#cb31-210"></a></span>
<span id="cb31-211"><a href="#cb31-211"></a>Grid search can be kinda tedious<span class="ot">[^10]</span> and computationally inefficient when there are multiple treatment parameters<span class="ot">[^11]</span>, but <span class="co">[</span><span class="ot">this paper</span><span class="co">](https://academic.oup.com/aje/article/187/5/1079/4930819)</span> shows a neat trick using *log-link* *Gamma Generalized Estimating Equations (GEE)* to estimate risk ratios using regression adjustment for the propensity score</span>
<span id="cb31-212"><a href="#cb31-212"></a></span>
<span id="cb31-213"><a href="#cb31-213"></a><span class="ot">[^10]: </span>It was annoying to use grid-search with p-values for this setting - if the grid was too coarse so there weren't any points close to the true value, then the p-values were very close to zero, which explains the fine grid used here. Calling <span class="in">`optimize(gest_function, interval = c(-5, 5), maximum = TRUE)`</span> where gest_function takes $\psi$ as an input and returns the p-value as the output failed to find the correct value, until the interval was narrowed to (0, 2). The coefficient estimate function wouldn't work too well either, since risk ratio values less than 1 lead to estimates of $\alpha_1$ to be very close to 0.</span>
<span id="cb31-214"><a href="#cb31-214"></a></span>
<span id="cb31-215"><a href="#cb31-215"></a><span class="ot">[^11]: </span>to account for effect-measure modification or heterogeneity of treatment effect</span>
<span id="cb31-216"><a href="#cb31-216"></a></span>
<span id="cb31-219"><a href="#cb31-219"></a><span class="in">```{r}</span></span>
<span id="cb31-220"><a href="#cb31-220"></a><span class="co">#| code-fold: false</span></span>
<span id="cb31-221"><a href="#cb31-221"></a></span>
<span id="cb31-222"><a href="#cb31-222"></a>propensity_scores <span class="ot">&lt;-</span> mgcv<span class="sc">::</span><span class="fu">gam</span>(A <span class="sc">~</span> <span class="fu">s</span>(U, <span class="at">k =</span> <span class="dv">10</span>), <span class="at">data =</span> df_large) <span class="sc">%&gt;%</span></span>
<span id="cb31-223"><a href="#cb31-223"></a>  <span class="fu">fitted</span>()</span>
<span id="cb31-224"><a href="#cb31-224"></a></span>
<span id="cb31-225"><a href="#cb31-225"></a>propensity_scores <span class="sc">%&gt;%</span> <span class="fu">summary</span>()</span>
<span id="cb31-226"><a href="#cb31-226"></a></span>
<span id="cb31-227"><a href="#cb31-227"></a>gest_confounder <span class="ot">&lt;-</span> df_large <span class="sc">%&gt;%</span></span>
<span id="cb31-228"><a href="#cb31-228"></a>  <span class="fu">mutate</span>(<span class="at">PS =</span> propensity_scores) <span class="sc">%&gt;%</span></span>
<span id="cb31-229"><a href="#cb31-229"></a>  geeM<span class="sc">::</span><span class="fu">geem</span>(Y <span class="sc">~</span> PS <span class="sc">+</span> A, <span class="at">data =</span> ., <span class="at">family =</span> <span class="fu">Gamma</span>(<span class="at">link =</span> <span class="st">"log"</span>),</span>
<span id="cb31-230"><a href="#cb31-230"></a>             <span class="at">corstr =</span> <span class="st">"independence"</span>, <span class="at">sandwich =</span> <span class="cn">TRUE</span>)</span>
<span id="cb31-231"><a href="#cb31-231"></a></span>
<span id="cb31-232"><a href="#cb31-232"></a><span class="fu">summary</span>(gest_confounder)</span>
<span id="cb31-233"><a href="#cb31-233"></a><span class="in">```</span></span>
<span id="cb31-234"><a href="#cb31-234"></a></span>
<span id="cb31-235"><a href="#cb31-235"></a>Unfortunately there's no *tidier* for objects of class <span class="in">`geem`</span> in the <span class="in">`broom`</span> package, but it's easy enough to write one to extract information from the fitted model as a data frame --- see the following code block</span>
<span id="cb31-236"><a href="#cb31-236"></a></span>
<span id="cb31-239"><a href="#cb31-239"></a><span class="in">```{r}</span></span>
<span id="cb31-240"><a href="#cb31-240"></a>tidy.geem <span class="ot">&lt;-</span> <span class="cf">function</span>(x, <span class="at">conf.int =</span> <span class="cn">FALSE</span>, </span>
<span id="cb31-241"><a href="#cb31-241"></a>                      <span class="at">exponentiate =</span> <span class="cn">FALSE</span>, </span>
<span id="cb31-242"><a href="#cb31-242"></a>                      <span class="at">conf.level =</span> <span class="fl">0.95</span>, </span>
<span id="cb31-243"><a href="#cb31-243"></a>                      <span class="at">robust =</span> <span class="cn">TRUE</span>, ...) {</span>
<span id="cb31-244"><a href="#cb31-244"></a>  <span class="co"># works only when broom is attached</span></span>
<span id="cb31-245"><a href="#cb31-245"></a>  <span class="co"># as it's added as an S3 method for broom::tidy(x, ...)</span></span>
<span id="cb31-246"><a href="#cb31-246"></a>  <span class="co"># could also do library(broom, include.only = "tidy")</span></span>
<span id="cb31-247"><a href="#cb31-247"></a>  <span class="co">#</span></span>
<span id="cb31-248"><a href="#cb31-248"></a>  <span class="co"># arguments are the same as broom::tidy.geeglm()</span></span>
<span id="cb31-249"><a href="#cb31-249"></a>  <span class="fu">stopifnot</span>(<span class="fu">is.logical</span>(robust))</span>
<span id="cb31-250"><a href="#cb31-250"></a>  s <span class="ot">&lt;-</span> <span class="fu">summary</span>(x)</span>
<span id="cb31-251"><a href="#cb31-251"></a>  ret <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"term"</span> <span class="ot">=</span> <span class="st">"coefnames"</span>, <span class="st">"estimate"</span> <span class="ot">=</span> <span class="st">"beta"</span>,</span>
<span id="cb31-252"><a href="#cb31-252"></a>           <span class="st">"std.error"</span> <span class="ot">=</span> <span class="cf">if</span> (robust) <span class="st">"se.robust"</span> <span class="cf">else</span> <span class="st">"se.model"</span>,</span>
<span id="cb31-253"><a href="#cb31-253"></a>           <span class="st">"statistic"</span> <span class="ot">=</span> <span class="st">"wald.test"</span>, <span class="st">"p.value"</span> <span class="ot">=</span> <span class="st">"p"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb31-254"><a href="#cb31-254"></a>    <span class="fu">map</span>(<span class="at">.x =</span> ., <span class="at">.f =</span> <span class="sc">~</span> <span class="fu">pluck</span>(s, .x)) <span class="sc">%&gt;%</span></span>
<span id="cb31-255"><a href="#cb31-255"></a>    <span class="fu">as_tibble</span>()</span>
<span id="cb31-256"><a href="#cb31-256"></a></span>
<span id="cb31-257"><a href="#cb31-257"></a>  <span class="cf">if</span> (conf.int) {</span>
<span id="cb31-258"><a href="#cb31-258"></a>    p <span class="ot">&lt;-</span> (<span class="dv">1</span> <span class="sc">+</span> conf.level) <span class="sc">/</span> <span class="dv">2</span></span>
<span id="cb31-259"><a href="#cb31-259"></a>    ret <span class="ot">&lt;-</span> ret <span class="sc">%&gt;%</span></span>
<span id="cb31-260"><a href="#cb31-260"></a>      <span class="fu">mutate</span>(</span>
<span id="cb31-261"><a href="#cb31-261"></a>        <span class="at">conf.low =</span> estimate <span class="sc">-</span> (<span class="fu">qnorm</span>(<span class="at">p =</span> p) <span class="sc">*</span> std.error),</span>
<span id="cb31-262"><a href="#cb31-262"></a>        <span class="at">conf.high =</span> estimate <span class="sc">+</span> (<span class="fu">qnorm</span>(<span class="at">p =</span> p) <span class="sc">*</span> std.error),</span>
<span id="cb31-263"><a href="#cb31-263"></a>      )</span>
<span id="cb31-264"><a href="#cb31-264"></a>  }</span>
<span id="cb31-265"><a href="#cb31-265"></a></span>
<span id="cb31-266"><a href="#cb31-266"></a>  <span class="cf">if</span> (exponentiate) {</span>
<span id="cb31-267"><a href="#cb31-267"></a>    <span class="co"># exponentiate the point estimate and the CI endpoints (if present)</span></span>
<span id="cb31-268"><a href="#cb31-268"></a>    ret <span class="ot">&lt;-</span> ret <span class="sc">%&gt;%</span></span>
<span id="cb31-269"><a href="#cb31-269"></a>      <span class="fu">mutate</span>(</span>
<span id="cb31-270"><a href="#cb31-270"></a>        <span class="fu">across</span>(</span>
<span id="cb31-271"><a href="#cb31-271"></a>          <span class="at">.cols =</span> <span class="sc">-</span><span class="fu">c</span>(term, std.error, statistic, p.value),</span>
<span id="cb31-272"><a href="#cb31-272"></a>          <span class="at">.fns =</span> exp</span>
<span id="cb31-273"><a href="#cb31-273"></a>        )</span>
<span id="cb31-274"><a href="#cb31-274"></a>      )</span>
<span id="cb31-275"><a href="#cb31-275"></a>  }</span>
<span id="cb31-276"><a href="#cb31-276"></a></span>
<span id="cb31-277"><a href="#cb31-277"></a>  <span class="fu">return</span>(ret)</span>
<span id="cb31-278"><a href="#cb31-278"></a>}</span>
<span id="cb31-279"><a href="#cb31-279"></a></span>
<span id="cb31-280"><a href="#cb31-280"></a>gest_confounder <span class="sc">%&gt;%</span></span>
<span id="cb31-281"><a href="#cb31-281"></a>  <span class="fu">tidy</span>(<span class="at">exponentiate =</span> <span class="cn">TRUE</span>, <span class="at">conf.int =</span> <span class="cn">TRUE</span>, <span class="at">robust =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb31-282"><a href="#cb31-282"></a>  <span class="fu">filter</span>(term <span class="sc">==</span> <span class="st">"A"</span>)</span>
<span id="cb31-283"><a href="#cb31-283"></a><span class="in">```</span></span>
<span id="cb31-284"><a href="#cb31-284"></a></span>
<span id="cb31-285"><a href="#cb31-285"></a>This can also be compared with the usual regression estimate</span>
<span id="cb31-286"><a href="#cb31-286"></a></span>
<span id="cb31-289"><a href="#cb31-289"></a><span class="in">```{r}</span></span>
<span id="cb31-290"><a href="#cb31-290"></a><span class="co">#| code-fold: false</span></span>
<span id="cb31-291"><a href="#cb31-291"></a></span>
<span id="cb31-292"><a href="#cb31-292"></a>glm_model <span class="ot">&lt;-</span> <span class="fu">glm</span>(Y <span class="sc">~</span> U <span class="sc">+</span> A, <span class="at">data =</span> df_large, <span class="at">family =</span> <span class="fu">binomial</span>(<span class="at">link =</span> <span class="st">"log"</span>))</span>
<span id="cb31-293"><a href="#cb31-293"></a></span>
<span id="cb31-294"><a href="#cb31-294"></a>glm_model <span class="sc">%&gt;%</span> </span>
<span id="cb31-295"><a href="#cb31-295"></a>  <span class="fu">tidy</span>(<span class="at">exponentiate =</span> <span class="cn">TRUE</span>, <span class="at">conf.int =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb31-296"><a href="#cb31-296"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="at">.cols =</span> <span class="fu">where</span>(is.numeric), <span class="at">.fns =</span> <span class="sc">~</span> <span class="fu">round</span>(.x, <span class="dv">4</span>)))</span>
<span id="cb31-297"><a href="#cb31-297"></a><span class="in">```</span></span>
<span id="cb31-298"><a href="#cb31-298"></a></span>
<span id="cb31-299"><a href="#cb31-299"></a>But what if $U$ is unmeasured?</span>
<span id="cb31-300"><a href="#cb31-300"></a></span>
<span id="cb31-301"><a href="#cb31-301"></a><span class="fu">## G-estimation with an IV</span></span>
<span id="cb31-302"><a href="#cb31-302"></a></span>
<span id="cb31-303"><a href="#cb31-303"></a>In a randomized trial with perfect compliance, $A$ and $Z$ will be identical so a simple analysis using either one of these will result in an unbiased estimate of the average treatment effect. On the other hand, in the presence of imperfect compliance due to unmeasured confounding, an unadjusted analysis of $A - Y$ will lead to biased estimates of the effect of treatment, and an unadjusted analysis of $Z - Y$ will lead to an estimate of assigning treatment<span class="ot">[^12]</span> instead of receiving the treatment. Analyzing only $A-Y$, the estimated treatment effect concentrates around 0.98 on average instead of 1.02</span>
<span id="cb31-304"><a href="#cb31-304"></a></span>
<span id="cb31-305"><a href="#cb31-305"></a><span class="ot">[^12]: </span>i.e., the *intention-to-treat* effect (ITT)</span>
<span id="cb31-306"><a href="#cb31-306"></a></span>
<span id="cb31-309"><a href="#cb31-309"></a><span class="in">```{r}</span></span>
<span id="cb31-310"><a href="#cb31-310"></a><span class="co"># specify the seed</span></span>
<span id="cb31-311"><a href="#cb31-311"></a><span class="fu">seq</span>(<span class="dv">1</span>, <span class="dv">100</span>, <span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb31-312"><a href="#cb31-312"></a>  <span class="fu">map_dbl</span>(<span class="at">.f =</span> <span class="sc">~</span> {</span>
<span id="cb31-313"><a href="#cb31-313"></a>    .x <span class="sc">%&gt;%</span> </span>
<span id="cb31-314"><a href="#cb31-314"></a>      <span class="fu">simulate_data</span>(<span class="at">seed =</span> ., <span class="at">n =</span> <span class="fl">1e4</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb31-315"><a href="#cb31-315"></a>      <span class="fu">glm</span>(Y <span class="sc">~</span> A, <span class="at">data =</span> ., <span class="at">family =</span> <span class="fu">binomial</span>(<span class="at">link =</span> <span class="st">"log"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb31-316"><a href="#cb31-316"></a>      <span class="fu">tidy</span>(<span class="at">exponentiate =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb31-317"><a href="#cb31-317"></a>      <span class="fu">filter</span>(term <span class="sc">==</span> <span class="st">"A"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb31-318"><a href="#cb31-318"></a>      <span class="fu">pull</span>(estimate)</span>
<span id="cb31-319"><a href="#cb31-319"></a>  }) <span class="sc">%&gt;%</span> </span>
<span id="cb31-320"><a href="#cb31-320"></a>  <span class="fu">summary</span>()</span>
<span id="cb31-321"><a href="#cb31-321"></a><span class="in">```</span></span>
<span id="cb31-322"><a href="#cb31-322"></a></span>
<span id="cb31-323"><a href="#cb31-323"></a>If the DAG with relationships $A \leftarrow U \rightarrow Y$ and $Z \rightarrow A \rightarrow Y$ holds but only $(Z, A, Y)$ are observed, and $Z$ is a variable that meets the IV conditions<span class="ot">[^13]</span>, the effect of $A$ ($\text{ATE}$ or $\text{ATT}_{IV}$) can be estimated under some additional assumptions.</span>
<span id="cb31-324"><a href="#cb31-324"></a></span>
<span id="cb31-325"><a href="#cb31-325"></a><span class="ot">[^13]: </span>Associated with $A$ (relevance), not associated with any variables in the set $U$ (ignorability), and no direct effect on $Y$ (exclusion restriction)</span>
<span id="cb31-326"><a href="#cb31-326"></a></span>
<span id="cb31-327"><a href="#cb31-327"></a>The key idea is captured by this (estimating) equation</span>
<span id="cb31-328"><a href="#cb31-328"></a></span>
<span id="cb31-329"><a href="#cb31-329"></a>$$</span>
<span id="cb31-330"><a href="#cb31-330"></a>\sum_{i = 1}^n (z_i - \bar{z})\ y_i\ \text{exp}(-\psi\ a_i) = 0</span>
<span id="cb31-331"><a href="#cb31-331"></a>$$</span>
<span id="cb31-332"><a href="#cb31-332"></a></span>
<span id="cb31-333"><a href="#cb31-333"></a>where $\bar{z}$ denotes the proportion of individuals assigned to the treatment arm.</span>
<span id="cb31-334"><a href="#cb31-334"></a></span>
<span id="cb31-335"><a href="#cb31-335"></a>Since $Z$ is randomly assigned, it should be balanced with respect to all measured and unmeasured confounders $U$. But $A$ may not be. So the correct estimate of $\psi$ is the one that leads to zero covariance between the residuals $Y^{a = 0}$ (or $H(\psi)$) and $Z$<span class="ot">[^14]</span>. Pretty magical, if you ask me.</span>
<span id="cb31-336"><a href="#cb31-336"></a></span>
<span id="cb31-337"><a href="#cb31-337"></a><span class="ot">[^14]: </span>If $(a_i - \bar{a})$ were to be used instead of $(z_i - \bar{z})$, then the estimate would be the same one as from the $A- Y$ analysis.</span>
<span id="cb31-338"><a href="#cb31-338"></a></span>
<span id="cb31-339"><a href="#cb31-339"></a>This equation can be coded up as a function which visually looks like this</span>
<span id="cb31-340"><a href="#cb31-340"></a></span>
<span id="cb31-343"><a href="#cb31-343"></a><span class="in">```{r}</span></span>
<span id="cb31-344"><a href="#cb31-344"></a>MSNMM_function <span class="ot">&lt;-</span> <span class="cf">function</span>(psi, <span class="at">data =</span> df_large, <span class="at">positive =</span> <span class="cn">TRUE</span>) {</span>
<span id="cb31-345"><a href="#cb31-345"></a>  result <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span></span>
<span id="cb31-346"><a href="#cb31-346"></a>    <span class="fu">mutate</span>(</span>
<span id="cb31-347"><a href="#cb31-347"></a>      <span class="at">Zbar =</span> <span class="fu">mean</span>(Z),</span>
<span id="cb31-348"><a href="#cb31-348"></a>      <span class="at">s =</span> (Z <span class="sc">-</span> Zbar) <span class="sc">*</span> Y <span class="sc">*</span> <span class="fu">exp</span>(<span class="sc">-</span>psi <span class="sc">*</span> A)</span>
<span id="cb31-349"><a href="#cb31-349"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb31-350"><a href="#cb31-350"></a>    <span class="fu">pull</span>(s) <span class="sc">%&gt;%</span></span>
<span id="cb31-351"><a href="#cb31-351"></a>    <span class="fu">sum</span>()</span>
<span id="cb31-352"><a href="#cb31-352"></a></span>
<span id="cb31-353"><a href="#cb31-353"></a>  <span class="cf">if</span> (positive) result <span class="ot">&lt;-</span> <span class="fu">abs</span>(result)</span>
<span id="cb31-354"><a href="#cb31-354"></a></span>
<span id="cb31-355"><a href="#cb31-355"></a>  <span class="fu">return</span>(result)</span>
<span id="cb31-356"><a href="#cb31-356"></a>}</span>
<span id="cb31-357"><a href="#cb31-357"></a></span>
<span id="cb31-358"><a href="#cb31-358"></a>IV_grid <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="sc">-</span><span class="fl">0.05</span>, <span class="fl">0.5</span>, <span class="fl">0.01</span>) <span class="sc">%&gt;%</span></span>
<span id="cb31-359"><a href="#cb31-359"></a>  <span class="fu">tibble</span>(<span class="at">psi =</span> .) <span class="sc">%&gt;%</span></span>
<span id="cb31-360"><a href="#cb31-360"></a>  <span class="fu">rowwise</span>() <span class="sc">%&gt;%</span></span>
<span id="cb31-361"><a href="#cb31-361"></a>  <span class="fu">mutate</span>(</span>
<span id="cb31-362"><a href="#cb31-362"></a>    <span class="st">`</span><span class="at">Raw value</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">MSNMM_function</span>(psi, <span class="at">positive =</span> <span class="cn">FALSE</span>),</span>
<span id="cb31-363"><a href="#cb31-363"></a>    <span class="st">`</span><span class="at">Absolute value</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">abs</span>(<span class="st">`</span><span class="at">Raw value</span><span class="st">`</span>)</span>
<span id="cb31-364"><a href="#cb31-364"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb31-365"><a href="#cb31-365"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span></span>
<span id="cb31-366"><a href="#cb31-366"></a>  <span class="fu">pivot_longer</span>(<span class="sc">-</span>psi) <span class="sc">%&gt;%</span></span>
<span id="cb31-367"><a href="#cb31-367"></a>  <span class="fu">mutate</span>(<span class="at">name =</span> <span class="fu">fct_rev</span>(<span class="fu">factor</span>(name))) </span>
<span id="cb31-368"><a href="#cb31-368"></a></span>
<span id="cb31-369"><a href="#cb31-369"></a>IV_grid <span class="sc">%&gt;%</span></span>
<span id="cb31-370"><a href="#cb31-370"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">exp</span>(psi), <span class="at">y =</span> value, <span class="at">color =</span> name)) <span class="sc">+</span></span>
<span id="cb31-371"><a href="#cb31-371"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span> <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb31-372"><a href="#cb31-372"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">linetype =</span> <span class="st">"dotdash"</span>) <span class="sc">+</span></span>
<span id="cb31-373"><a href="#cb31-373"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="fl">1.02</span>, <span class="at">linetype =</span> <span class="st">"dotdash"</span>) <span class="sc">+</span></span>
<span id="cb31-374"><a href="#cb31-374"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"bottom"</span>, <span class="at">legend.title =</span> <span class="fu">element_blank</span>()) <span class="sc">+</span></span>
<span id="cb31-375"><a href="#cb31-375"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">n.breaks =</span> <span class="dv">10</span>) <span class="sc">+</span></span>
<span id="cb31-376"><a href="#cb31-376"></a>  <span class="fu">xlab</span>(<span class="st">"Risk ratio (true value: 1.02)"</span>) <span class="sc">+</span></span>
<span id="cb31-377"><a href="#cb31-377"></a>  <span class="fu">ylab</span>(<span class="st">"Covariance between Z and H(\U1D713)"</span>)</span>
<span id="cb31-378"><a href="#cb31-378"></a><span class="in">```</span></span>
<span id="cb31-379"><a href="#cb31-379"></a></span>
<span id="cb31-380"><a href="#cb31-380"></a>Instead of using grid search, the <span class="in">`optimize()`</span> function can be used with the absolute value of the covariance to pick the value of $\psi$ that leads to 0 covariance<span class="ot">[^15]</span></span>
<span id="cb31-381"><a href="#cb31-381"></a></span>
<span id="cb31-382"><a href="#cb31-382"></a><span class="ot">[^15]: </span>if the function is flat in the specified interval, the optimization step would return incorrect results (passing <span class="sc">\`</span>interval = c(3, 5)<span class="sc">\`</span> returns the value of 3 and an objective function value of 83.8 which is far away from 0)</span>
<span id="cb31-383"><a href="#cb31-383"></a></span>
<span id="cb31-386"><a href="#cb31-386"></a><span class="in">```{r}</span></span>
<span id="cb31-387"><a href="#cb31-387"></a><span class="co">#| code-fold: false</span></span>
<span id="cb31-388"><a href="#cb31-388"></a></span>
<span id="cb31-389"><a href="#cb31-389"></a><span class="fu">optimize</span>(<span class="at">f =</span> MSNMM_function, <span class="at">interval =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">2</span>, <span class="dv">2</span>), <span class="at">maximum =</span> <span class="cn">FALSE</span>)</span>
<span id="cb31-390"><a href="#cb31-390"></a><span class="in">```</span></span>
<span id="cb31-391"><a href="#cb31-391"></a></span>
<span id="cb31-392"><a href="#cb31-392"></a>This is a slight underestimate (1.013 vs 1.02) --- but it seems to be a sampling artifact as the median of 100 simulated values concentrates around 1.02</span>
<span id="cb31-393"><a href="#cb31-393"></a></span>
<span id="cb31-396"><a href="#cb31-396"></a><span class="in">```{r}</span></span>
<span id="cb31-397"><a href="#cb31-397"></a>IV_estimates <span class="ot">&lt;-</span> <span class="fu">map_dbl</span>(</span>
<span id="cb31-398"><a href="#cb31-398"></a>  <span class="at">.x =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">100</span>,</span>
<span id="cb31-399"><a href="#cb31-399"></a>  <span class="at">.f =</span> <span class="sc">~</span> {</span>
<span id="cb31-400"><a href="#cb31-400"></a>    .x <span class="sc">%&gt;%</span></span>
<span id="cb31-401"><a href="#cb31-401"></a>      <span class="fu">simulate_data</span>(<span class="at">seed =</span> .) <span class="sc">%&gt;%</span></span>
<span id="cb31-402"><a href="#cb31-402"></a>      <span class="fu">optimize</span>(</span>
<span id="cb31-403"><a href="#cb31-403"></a>        <span class="at">f =</span> MSNMM_function, <span class="at">interval =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">2</span>, <span class="dv">2</span>), </span>
<span id="cb31-404"><a href="#cb31-404"></a>        <span class="at">maximum =</span> <span class="cn">FALSE</span>, <span class="at">data =</span> .</span>
<span id="cb31-405"><a href="#cb31-405"></a>      ) <span class="sc">%&gt;%</span></span>
<span id="cb31-406"><a href="#cb31-406"></a>      <span class="fu">pluck</span>(<span class="st">"minimum"</span>)</span>
<span id="cb31-407"><a href="#cb31-407"></a>  })</span>
<span id="cb31-408"><a href="#cb31-408"></a></span>
<span id="cb31-409"><a href="#cb31-409"></a>IV_estimates <span class="sc">%&gt;%</span> <span class="fu">exp</span>() <span class="sc">%&gt;%</span> <span class="fu">summary</span>()</span>
<span id="cb31-410"><a href="#cb31-410"></a><span class="in">```</span></span>
<span id="cb31-411"><a href="#cb31-411"></a></span>
<span id="cb31-412"><a href="#cb31-412"></a>It might just be simpler to use the <span class="in">`ivglm()`</span> function from the <span class="in">`ivtools`</span> package (see <span class="co">[</span><span class="ot">this paper</span><span class="co">](https://www.degruyter.com/document/doi/10.1515/em-2018-0024/html)</span>) to accomplish the same thing though<span class="ot">[^16]</span></span>
<span id="cb31-413"><a href="#cb31-413"></a></span>
<span id="cb31-414"><a href="#cb31-414"></a><span class="ot">[^16]: </span>which has other advantages like handling multiple instruments and different effect measures</span>
<span id="cb31-415"><a href="#cb31-415"></a></span>
<span id="cb31-418"><a href="#cb31-418"></a><span class="in">```{r}</span></span>
<span id="cb31-419"><a href="#cb31-419"></a><span class="co">#| code-fold: show</span></span>
<span id="cb31-420"><a href="#cb31-420"></a></span>
<span id="cb31-421"><a href="#cb31-421"></a>IV_model <span class="ot">&lt;-</span> <span class="fu">glm</span>(Z <span class="sc">~</span> <span class="dv">1</span>, <span class="at">family =</span> <span class="fu">binomial</span>(<span class="at">link =</span> <span class="st">"logit"</span>), <span class="at">data =</span> df_large)</span>
<span id="cb31-422"><a href="#cb31-422"></a></span>
<span id="cb31-423"><a href="#cb31-423"></a>IV_gest <span class="ot">&lt;-</span> df_large <span class="sc">%&gt;%</span></span>
<span id="cb31-424"><a href="#cb31-424"></a>  <span class="co"># need to cast tibble as a data frame to avoid cryptic errors</span></span>
<span id="cb31-425"><a href="#cb31-425"></a>  <span class="fu">as.data.frame</span>() <span class="sc">%&gt;%</span></span>
<span id="cb31-426"><a href="#cb31-426"></a>  ivtools<span class="sc">::</span><span class="fu">ivglm</span>(<span class="at">estmethod =</span> <span class="st">"g"</span>,</span>
<span id="cb31-427"><a href="#cb31-427"></a>                 <span class="at">X =</span> <span class="st">"A"</span>, <span class="at">Y =</span> <span class="st">"Y"</span>,</span>
<span id="cb31-428"><a href="#cb31-428"></a>                 <span class="at">fitZ.L =</span> IV_model,</span>
<span id="cb31-429"><a href="#cb31-429"></a>                 <span class="at">link =</span> <span class="st">"log"</span>, <span class="at">data =</span> .)</span>
<span id="cb31-430"><a href="#cb31-430"></a></span>
<span id="cb31-431"><a href="#cb31-431"></a>IV_gest <span class="sc">%&gt;%</span> <span class="fu">summary</span>()</span>
<span id="cb31-432"><a href="#cb31-432"></a><span class="in">```</span></span>
<span id="cb31-433"><a href="#cb31-433"></a></span>
<span id="cb31-436"><a href="#cb31-436"></a><span class="in">```{r}</span></span>
<span id="cb31-437"><a href="#cb31-437"></a><span class="co"># get the coefficient and CI</span></span>
<span id="cb31-438"><a href="#cb31-438"></a>glue<span class="sc">::</span><span class="fu">glue</span>(</span>
<span id="cb31-439"><a href="#cb31-439"></a>  <span class="st">"Mean: {round(exp(c(summary(IV_gest)$coefficients[1, 1])), 4)}"</span>, </span>
<span id="cb31-440"><a href="#cb31-440"></a>  <span class="st">" with 95% CI: ({round(exp(confint(IV_gest))[1], 4)},"</span>, </span>
<span id="cb31-441"><a href="#cb31-441"></a>  <span class="st">" {round(exp(confint(IV_gest))[2], 4)})"</span></span>
<span id="cb31-442"><a href="#cb31-442"></a>)</span>
<span id="cb31-443"><a href="#cb31-443"></a><span class="in">```</span></span>
<span id="cb31-444"><a href="#cb31-444"></a></span>
<span id="cb31-445"><a href="#cb31-445"></a>where it produces nearly the same estimate as above and additionally has the option of plotting the shape of the estimating equations in a neighborhood of the estimate</span>
<span id="cb31-446"><a href="#cb31-446"></a></span>
<span id="cb31-449"><a href="#cb31-449"></a><span class="in">```{r}</span></span>
<span id="cb31-450"><a href="#cb31-450"></a><span class="co"># can use ggplot on the output from estfun()</span></span>
<span id="cb31-451"><a href="#cb31-451"></a><span class="co"># ivtools::estfun(IV_gest, lower = -0.1, upper = 0.1, step = 0.01) %&gt;% </span></span>
<span id="cb31-452"><a href="#cb31-452"></a><span class="co">#   pluck("f") %&gt;%  </span></span>
<span id="cb31-453"><a href="#cb31-453"></a><span class="co">#   pluck("A") %&gt;% </span></span>
<span id="cb31-454"><a href="#cb31-454"></a><span class="co">#   data.frame() %&gt;% </span></span>
<span id="cb31-455"><a href="#cb31-455"></a><span class="co">#   ggplot(aes(x = exp(psi), y = Hsum)) + </span></span>
<span id="cb31-456"><a href="#cb31-456"></a><span class="co">#   geom_point() +</span></span>
<span id="cb31-457"><a href="#cb31-457"></a><span class="co">#   geom_line() </span></span>
<span id="cb31-458"><a href="#cb31-458"></a></span>
<span id="cb31-459"><a href="#cb31-459"></a><span class="fu">plot</span>(ivtools<span class="sc">::</span><span class="fu">estfun</span>(IV_gest, <span class="at">lower =</span> <span class="sc">-</span><span class="fl">0.1</span>, <span class="at">upper =</span> <span class="fl">0.1</span>, <span class="at">step =</span> <span class="fl">0.01</span>))</span>
<span id="cb31-460"><a href="#cb31-460"></a><span class="in">```</span></span>
<span id="cb31-461"><a href="#cb31-461"></a></span>
<span id="cb31-462"><a href="#cb31-462"></a>A caveat is that this approach can sometimes fail when this function has a weird shape in the presence of weak instruments (see <span class="co">[</span><span class="ot">this paper</span><span class="co">](https://academic.oup.com/aje/article/180/1/111/2739174)</span>).</span>
<span id="cb31-463"><a href="#cb31-463"></a></span>
<span id="cb31-464"><a href="#cb31-464"></a><span class="fu">## Estimating probabilities</span></span>
<span id="cb31-465"><a href="#cb31-465"></a></span>
<span id="cb31-466"><a href="#cb31-466"></a>If we had the model which included $U$ as a covariate, conditional probabilities $\text{Pr}<span class="co">[</span><span class="ot">Y = 1 | A = a, U = u</span><span class="co">]</span>$ as well as marginal probabilities $\text{Pr}<span class="co">[</span><span class="ot">Y = 1 | A = a</span><span class="co">]</span>$ (averaged over levels of $U$) could be generated using the amazing *marginaleffects* package to perform *g-computation* with the resulting *dose-response curves* visualized*.*</span>
<span id="cb31-467"><a href="#cb31-467"></a></span>
<span id="cb31-468"><a href="#cb31-468"></a>The following plot with conditional dose-response curves at quartiles of $U$ shows that the effect of the treatment with increasing $A$ is increasing across levels of $U$ --- which makes sense because the treatment effect is a multiplicative (percent) change relative to the previous level<span class="ot">[^17]</span></span>
<span id="cb31-469"><a href="#cb31-469"></a></span>
<span id="cb31-470"><a href="#cb31-470"></a><span class="ot">[^17]: </span>the effects of $A$ and $U$ are linear on the log scale but not on the transformed probability scale</span>
<span id="cb31-471"><a href="#cb31-471"></a></span>
<span id="cb31-474"><a href="#cb31-474"></a><span class="in">```{r}</span></span>
<span id="cb31-475"><a href="#cb31-475"></a><span class="co"># get predicted probabilities from the model at quartiles of U</span></span>
<span id="cb31-476"><a href="#cb31-476"></a>glm_model <span class="sc">%&gt;%</span></span>
<span id="cb31-477"><a href="#cb31-477"></a>  marginaleffects<span class="sc">::</span><span class="fu">plot_predictions</span>(<span class="at">condition =</span> <span class="fu">list</span>(<span class="st">"A"</span>, <span class="st">"U"</span> <span class="ot">=</span> <span class="st">"fivenum"</span>)) <span class="sc">+</span></span>
<span id="cb31-478"><a href="#cb31-478"></a>  <span class="fu">xlab</span>(<span class="st">"A"</span>) <span class="sc">+</span></span>
<span id="cb31-479"><a href="#cb31-479"></a>  <span class="fu">ylab</span>(<span class="st">"Predicted probability of Y = 1"</span>) <span class="sc">+</span> </span>
<span id="cb31-480"><a href="#cb31-480"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"bottom"</span>)</span>
<span id="cb31-481"><a href="#cb31-481"></a><span class="in">```</span></span>
<span id="cb31-482"><a href="#cb31-482"></a></span>
<span id="cb31-483"><a href="#cb31-483"></a>When $U$ is unmeasured, only the marginal dose-response curve can be estimated, and the following plot compares g-computation and g-estimation estimates and their CIs, with the true curve plotted for comparison</span>
<span id="cb31-484"><a href="#cb31-484"></a></span>
<span id="cb31-487"><a href="#cb31-487"></a><span class="in">```{r}</span></span>
<span id="cb31-488"><a href="#cb31-488"></a><span class="co"># simulate 100 datasets and take the mean of probabilities under A = 0</span></span>
<span id="cb31-489"><a href="#cb31-489"></a>baseline_conversion_probability <span class="ot">&lt;-</span> <span class="fu">map_dbl</span>(</span>
<span id="cb31-490"><a href="#cb31-490"></a>  <span class="at">.x =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">100</span>,</span>
<span id="cb31-491"><a href="#cb31-491"></a>  <span class="at">.f =</span> <span class="sc">~</span> {</span>
<span id="cb31-492"><a href="#cb31-492"></a>    <span class="fu">simulate_data</span>(<span class="at">seed =</span> .x, <span class="at">n =</span> <span class="fl">1e5</span>) <span class="sc">%&gt;%</span></span>
<span id="cb31-493"><a href="#cb31-493"></a>      <span class="fu">pull</span>(logpY0) <span class="sc">%&gt;%</span></span>
<span id="cb31-494"><a href="#cb31-494"></a>      <span class="fu">exp</span>() <span class="sc">%&gt;%</span></span>
<span id="cb31-495"><a href="#cb31-495"></a>      <span class="fu">mean</span>()</span>
<span id="cb31-496"><a href="#cb31-496"></a>    }) <span class="sc">%&gt;%</span></span>
<span id="cb31-497"><a href="#cb31-497"></a>  <span class="fu">mean</span>()</span>
<span id="cb31-498"><a href="#cb31-498"></a></span>
<span id="cb31-499"><a href="#cb31-499"></a><span class="co"># true dose-response curve</span></span>
<span id="cb31-500"><a href="#cb31-500"></a>true_dose_response_curve <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb31-501"><a href="#cb31-501"></a>  <span class="at">A =</span> <span class="dv">0</span><span class="sc">:</span><span class="dv">73</span>,</span>
<span id="cb31-502"><a href="#cb31-502"></a>  <span class="at">estimate =</span> baseline_conversion_probability <span class="sc">*</span> <span class="fu">exp</span>(<span class="fu">log</span>(<span class="fl">1.02</span>) <span class="sc">*</span> A)</span>
<span id="cb31-503"><a href="#cb31-503"></a>)</span>
<span id="cb31-504"><a href="#cb31-504"></a></span>
<span id="cb31-505"><a href="#cb31-505"></a><span class="co"># g-computation by creating counterfactual predictions</span></span>
<span id="cb31-506"><a href="#cb31-506"></a><span class="co"># by setting A = a and averaging the predicted probabilities</span></span>
<span id="cb31-507"><a href="#cb31-507"></a><span class="co"># doing this over a coarser grid to get faster run times</span></span>
<span id="cb31-508"><a href="#cb31-508"></a>g_computation_dose_response_extrapolated_levels <span class="ot">&lt;-</span> glm_model <span class="sc">%&gt;%</span></span>
<span id="cb31-509"><a href="#cb31-509"></a>  marginaleffects<span class="sc">::</span><span class="fu">predictions</span>(</span>
<span id="cb31-510"><a href="#cb31-510"></a>    <span class="at">by =</span> <span class="st">"A"</span>, <span class="at">type =</span> <span class="st">"response"</span>,</span>
<span id="cb31-511"><a href="#cb31-511"></a>    <span class="at">newdata =</span> marginaleffects<span class="sc">::</span><span class="fu">datagrid</span>(</span>
<span id="cb31-512"><a href="#cb31-512"></a>      <span class="at">A =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fu">seq</span>(<span class="dv">5</span>, <span class="dv">70</span>, <span class="dv">5</span>), <span class="dv">73</span>), <span class="at">grid_type =</span> <span class="st">"counterfactual"</span></span>
<span id="cb31-513"><a href="#cb31-513"></a>    )</span>
<span id="cb31-514"><a href="#cb31-514"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb31-515"><a href="#cb31-515"></a>  <span class="fu">select</span>(A, estimate, conf.low, conf.high) <span class="sc">%&gt;%</span></span>
<span id="cb31-516"><a href="#cb31-516"></a>  <span class="fu">as_tibble</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb31-517"><a href="#cb31-517"></a>  <span class="fu">mutate</span>(<span class="at">type =</span> <span class="st">"G-computation"</span>)</span>
<span id="cb31-518"><a href="#cb31-518"></a></span>
<span id="cb31-519"><a href="#cb31-519"></a><span class="co"># get estimates of Pr[Y = 1 | A = 0]</span></span>
<span id="cb31-520"><a href="#cb31-520"></a><span class="co"># by shaving off the effect of the treatment</span></span>
<span id="cb31-521"><a href="#cb31-521"></a><span class="co"># using the point estimate and CI endpoints from ivglm</span></span>
<span id="cb31-522"><a href="#cb31-522"></a>g_estimation_pY0 <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb31-523"><a href="#cb31-523"></a>  IV_gest <span class="sc">%&gt;%</span> <span class="fu">pluck</span>(<span class="st">"est"</span>) <span class="sc">%&gt;%</span> <span class="fu">unname</span>(),</span>
<span id="cb31-524"><a href="#cb31-524"></a>  IV_gest <span class="sc">%&gt;%</span> <span class="fu">confint</span>() <span class="sc">%&gt;%</span> <span class="fu">unname</span>()</span>
<span id="cb31-525"><a href="#cb31-525"></a>) <span class="sc">%&gt;%</span></span>
<span id="cb31-526"><a href="#cb31-526"></a>  <span class="fu">set_names</span>(<span class="at">nm =</span> <span class="fu">c</span>(<span class="st">"estimate"</span>, <span class="st">"conf.low"</span>, <span class="st">"conf.high"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb31-527"><a href="#cb31-527"></a>  <span class="fu">map_dfr</span>(</span>
<span id="cb31-528"><a href="#cb31-528"></a>    <span class="at">.f =</span> <span class="sc">~</span> {</span>
<span id="cb31-529"><a href="#cb31-529"></a>      df_large <span class="sc">%&gt;%</span></span>
<span id="cb31-530"><a href="#cb31-530"></a>        <span class="fu">mutate</span>(<span class="at">H =</span> Y <span class="sc">*</span> <span class="fu">exp</span>(<span class="sc">-</span>.x <span class="sc">*</span> A)) <span class="sc">%&gt;%</span></span>
<span id="cb31-531"><a href="#cb31-531"></a>        <span class="fu">pull</span>(H) <span class="sc">%&gt;%</span></span>
<span id="cb31-532"><a href="#cb31-532"></a>        <span class="fu">mean</span>() <span class="sc">%&gt;%</span></span>
<span id="cb31-533"><a href="#cb31-533"></a>        <span class="fu">tibble</span>(<span class="at">logRR =</span> .x, <span class="at">pY0 =</span> .)</span>
<span id="cb31-534"><a href="#cb31-534"></a>    }, </span>
<span id="cb31-535"><a href="#cb31-535"></a>    <span class="at">.id =</span> <span class="st">"name"</span></span>
<span id="cb31-536"><a href="#cb31-536"></a>  )</span>
<span id="cb31-537"><a href="#cb31-537"></a></span>
<span id="cb31-538"><a href="#cb31-538"></a><span class="co"># using logRR estimate + CI and Pr[Y = 1 | A = 0]</span></span>
<span id="cb31-539"><a href="#cb31-539"></a>g_estimation_dose_response <span class="ot">&lt;-</span> g_estimation_pY0 <span class="sc">%&gt;%</span></span>
<span id="cb31-540"><a href="#cb31-540"></a>  <span class="fu">expand_grid</span>(., <span class="at">A =</span> <span class="dv">0</span><span class="sc">:</span><span class="dv">73</span>) <span class="sc">%&gt;%</span></span>
<span id="cb31-541"><a href="#cb31-541"></a>  <span class="co"># get P[Y = 1 | A = a]</span></span>
<span id="cb31-542"><a href="#cb31-542"></a>  <span class="fu">mutate</span>(<span class="at">pY =</span> pY0 <span class="sc">*</span> <span class="fu">exp</span>(logRR <span class="sc">*</span> A)) <span class="sc">%&gt;%</span></span>
<span id="cb31-543"><a href="#cb31-543"></a>  <span class="fu">select</span>(<span class="sc">-</span>pY0, <span class="sc">-</span>logRR) <span class="sc">%&gt;%</span></span>
<span id="cb31-544"><a href="#cb31-544"></a>  <span class="fu">pivot_wider</span>(<span class="at">id_cols =</span> A, <span class="at">names_from =</span> <span class="st">"name"</span>, <span class="at">values_from =</span> <span class="st">"pY"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb31-545"><a href="#cb31-545"></a>  <span class="fu">mutate</span>(<span class="at">type  =</span> <span class="st">"G-estimation (using an IV)"</span>)</span>
<span id="cb31-546"><a href="#cb31-546"></a></span>
<span id="cb31-547"><a href="#cb31-547"></a><span class="fu">bind_rows</span>(</span>
<span id="cb31-548"><a href="#cb31-548"></a>  g_computation_dose_response_extrapolated_levels,</span>
<span id="cb31-549"><a href="#cb31-549"></a>  g_estimation_dose_response</span>
<span id="cb31-550"><a href="#cb31-550"></a>) <span class="sc">%&gt;%</span></span>
<span id="cb31-551"><a href="#cb31-551"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> A, <span class="at">y =</span> estimate, <span class="at">color =</span> type)) <span class="sc">+</span></span>
<span id="cb31-552"><a href="#cb31-552"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb31-553"><a href="#cb31-553"></a>  <span class="co"># plot the true curve</span></span>
<span id="cb31-554"><a href="#cb31-554"></a>  <span class="fu">geom_line</span>(</span>
<span id="cb31-555"><a href="#cb31-555"></a>    <span class="at">data =</span> true_dose_response_curve, </span>
<span id="cb31-556"><a href="#cb31-556"></a>    <span class="fu">aes</span>(<span class="at">x =</span> A, <span class="at">y =</span> estimate), </span>
<span id="cb31-557"><a href="#cb31-557"></a>    <span class="at">color =</span> <span class="st">"gray20"</span>, <span class="at">linewidth =</span> <span class="fl">1.2</span>,, <span class="at">linetype =</span> <span class="st">"dotdash"</span>,</span>
<span id="cb31-558"><a href="#cb31-558"></a>    <span class="at">inherit.aes =</span> <span class="cn">FALSE</span></span>
<span id="cb31-559"><a href="#cb31-559"></a>  ) <span class="sc">+</span> </span>
<span id="cb31-560"><a href="#cb31-560"></a>  <span class="fu">geom_ribbon</span>(</span>
<span id="cb31-561"><a href="#cb31-561"></a>    <span class="fu">aes</span>(<span class="at">ymin =</span> conf.low, <span class="at">ymax =</span> conf.high, <span class="at">fill =</span> type), <span class="at">alpha =</span> <span class="fl">0.2</span></span>
<span id="cb31-562"><a href="#cb31-562"></a>  ) <span class="sc">+</span></span>
<span id="cb31-563"><a href="#cb31-563"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="fl">0.25</span>, <span class="fl">0.05</span>)) <span class="sc">+</span></span>
<span id="cb31-564"><a href="#cb31-564"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">80</span>, <span class="dv">10</span>)) <span class="sc">+</span></span>
<span id="cb31-565"><a href="#cb31-565"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"bottom"</span>, <span class="at">legend.title =</span> <span class="fu">element_blank</span>()) <span class="sc">+</span></span>
<span id="cb31-566"><a href="#cb31-566"></a>  <span class="fu">ylab</span>(<span class="st">"Predicted probability of Y = 1"</span>) <span class="sc">+</span> </span>
<span id="cb31-567"><a href="#cb31-567"></a>  <span class="fu">xlab</span>(<span class="st">"A (true curve in gray)"</span>)</span>
<span id="cb31-568"><a href="#cb31-568"></a><span class="in">```</span></span>
<span id="cb31-569"><a href="#cb31-569"></a></span>
<span id="cb31-570"><a href="#cb31-570"></a>Assuming no-effect modification by $U$, the point estimate and the CI endpoints from <span class="in">`ivglm`</span> are used to first estimate $\text{Pr}<span class="co">[</span><span class="ot">Y = 1 | A = 0</span><span class="co">]</span>$ (which is the same as $\text{Pr}<span class="co">[</span><span class="ot">Y^{a = 0} = 1</span><span class="co">]</span>$<span class="ot">[^18]</span>) by using the following relation</span>
<span id="cb31-571"><a href="#cb31-571"></a></span>
<span id="cb31-572"><a href="#cb31-572"></a><span class="ot">[^18]: </span>assuming consistency</span>
<span id="cb31-573"><a href="#cb31-573"></a></span>
<span id="cb31-574"><a href="#cb31-574"></a>$$</span>
<span id="cb31-575"><a href="#cb31-575"></a>\text{Pr}<span class="co">[</span><span class="ot">Y^{a = 0} = 1</span><span class="co">]</span> = \text{Pr}<span class="co">[</span><span class="ot">Y = 1 | A = 0</span><span class="co">]</span> = \text{E}<span class="co">[</span><span class="ot">Y\ \text{exp}(\psi A)</span><span class="co">]</span></span>
<span id="cb31-576"><a href="#cb31-576"></a>$$</span>
<span id="cb31-577"><a href="#cb31-577"></a></span>
<span id="cb31-578"><a href="#cb31-578"></a>and then using these to get the dose response curves and the following CIs</span>
<span id="cb31-579"><a href="#cb31-579"></a></span>
<span id="cb31-580"><a href="#cb31-580"></a>$$</span>
<span id="cb31-581"><a href="#cb31-581"></a>\text{Pr}<span class="co">[</span><span class="ot">Y = 1 | A</span><span class="co">]</span> = \text{Pr}<span class="co">[</span><span class="ot">Y = 1 | A = 0</span><span class="co">]</span>\ \text{exp}<span class="co">[</span><span class="ot">\psi A</span><span class="co">]</span></span>
<span id="cb31-582"><a href="#cb31-582"></a>$$</span>
<span id="cb31-583"><a href="#cb31-583"></a></span>
<span id="cb31-584"><a href="#cb31-584"></a>The g-computation estimate is far narrower as the model has access to the information provided by $U$, compared to the MSMM. The MSMM estimate for this sample underestimates the true value, which shows up as a large difference between the true and the MSMM curves at values of $A$ higher than 60.</span>
<span id="cb31-585"><a href="#cb31-585"></a></span>
<span id="cb31-586"><a href="#cb31-586"></a>These probabilities can be mapped to total sales / profit given the number of individuals within each treatment level. Whether these numbers can be *transported* or extrapolated to future campaigns or other populations depends on how similar the distribution of $U$ is across these groups. In that sense, these marginal estimates are actually conditional on the distribution of confounders and effect modifiers. I came across <span class="co">[</span><span class="ot">this paper</span><span class="co">](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC5784860/)</span> which would be interesting to read in the future.</span>
<span id="cb31-587"><a href="#cb31-587"></a></span>
<span id="cb31-588"><a href="#cb31-588"></a><span class="fu">## References</span></span>
<span id="cb31-589"><a href="#cb31-589"></a></span>
<span id="cb31-590"><a href="#cb31-590"></a>This post is based on the following references</span>
<span id="cb31-591"><a href="#cb31-591"></a></span>
<span id="cb31-592"><a href="#cb31-592"></a><span class="ss">-   </span><span class="co">[</span><span class="ot">Hernán, Robins</span><span class="co">](https://www.hsph.harvard.edu/miguel-hernan/causal-inference-book/)</span> - Causal Inference: What If? - Chapters 14 (g-estimation), and 16 (instrumental variables)</span>
<span id="cb31-593"><a href="#cb31-593"></a></span>
<span id="cb31-594"><a href="#cb31-594"></a><span class="ss">-   </span><span class="co">[</span><span class="ot">Vansteelandt et al. 2011</span><span class="co">](https://projecteuclid.org/journals/statistical-science/volume-26/issue-3/On-Instrumental-Variables-Estimation-of-Causal-Odds-Ratios/10.1214/11-STS360.full)</span> - On Instrumental Variables Estimation of Causal Odds Ratios</span>
<span id="cb31-595"><a href="#cb31-595"></a></span>
<span id="cb31-596"><a href="#cb31-596"></a><span class="ss">-   </span><span class="co">[</span><span class="ot">Palmer et al. 2011</span><span class="co">](https://academic.oup.com/aje/article/173/12/1392/205870)</span> - Instrumental Variable Estimation of Causal Risk Ratios and Causal Odds Ratios in Mendelian Randomization Analyses</span>
<span id="cb31-597"><a href="#cb31-597"></a></span>
<span id="cb31-598"><a href="#cb31-598"></a><span class="ss">-   </span><span class="co">[</span><span class="ot">Dukes, Vansteelandt 2018</span><span class="co">](https://academic.oup.com/aje/article/187/5/1079/4930819)</span> - A Note on G-Estimation of Causal Risk Ratios</span>
<span id="cb31-599"><a href="#cb31-599"></a></span>
<span id="cb31-600"><a href="#cb31-600"></a><span class="ss">-   </span><span class="co">[</span><span class="ot">Burgess et al. 2014</span><span class="co">](https://academic.oup.com/aje/article/180/1/111/2739174)</span> - Lack of Identification in Semiparametric Instrumental Variable Models With Binary Outcomes</span>
<span id="cb31-601"><a href="#cb31-601"></a></span>
<span id="cb31-602"><a href="#cb31-602"></a><span class="ss">-   </span><span class="co">[</span><span class="ot">Sjolander, Martinussen 2019</span><span class="co">](https://www.degruyter.com/document/doi/10.1515/em-2018-0024/html)</span> - Instrumental Variable Estimation with the R Package ivtools</span>
<span id="cb31-603"><a href="#cb31-603"></a></span>
<span id="cb31-604"><a href="#cb31-604"></a><span class="fu">## Simulated data</span></span>
<span id="cb31-605"><a href="#cb31-605"></a></span>
<span id="cb31-606"><a href="#cb31-606"></a>The four figures --- going clockwise from top left --- show 1) the probability of compliance as a function of the confounder $U$ (where $\text{Pr}<span class="co">[</span><span class="ot">C = 1 | U</span><span class="co">]</span> = 1 / (1 + \text{exp}(-2 + 0.5)) u,\ u \in <span class="co">[</span><span class="ot">0, 10</span><span class="co">]</span>$), 2) the realized distribution of the treatment levels among those who received the treatment<span class="ot">[^19]</span> simulated from the truncated *Gamma* distribution $x_i \sim \text{max}(1, \text{min}(\Gamma(\text{shape} = 5,\ \text{scale} = 4), 100))$, 3) balance of $U$ across levels of $Z$ (which is balanced because of randomization), and 4) balance of $U$ across levels of $A$ (which is *not* balanced because of confounding by $U$)</span>
<span id="cb31-607"><a href="#cb31-607"></a></span>
<span id="cb31-608"><a href="#cb31-608"></a><span class="ot">[^19]: </span>a value is sampled for each individual, but is realized only if $Z = 1$ and $C = 1$ (where $C$ is the compliance indicator)</span>
<span id="cb31-609"><a href="#cb31-609"></a></span>
<span id="cb31-612"><a href="#cb31-612"></a><span class="in">```{r}</span></span>
<span id="cb31-613"><a href="#cb31-613"></a><span class="co"># probability of compliance as a function of the confounder</span></span>
<span id="cb31-614"><a href="#cb31-614"></a>p_compliance <span class="ot">&lt;-</span> df_large <span class="sc">%&gt;%</span></span>
<span id="cb31-615"><a href="#cb31-615"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> U, <span class="at">y =</span> prob_C)) <span class="sc">+</span></span>
<span id="cb31-616"><a href="#cb31-616"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span> </span>
<span id="cb31-617"><a href="#cb31-617"></a>  <span class="fu">ylab</span>(<span class="st">"Compliance probability"</span>) <span class="sc">+</span></span>
<span id="cb31-618"><a href="#cb31-618"></a>  <span class="fu">coord_cartesian</span>(<span class="at">y =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>))</span>
<span id="cb31-619"><a href="#cb31-619"></a></span>
<span id="cb31-620"><a href="#cb31-620"></a><span class="co"># observed distribution of exposure levels</span></span>
<span id="cb31-621"><a href="#cb31-621"></a>A_dist <span class="ot">&lt;-</span> df_large <span class="sc">%&gt;%</span></span>
<span id="cb31-622"><a href="#cb31-622"></a>  <span class="fu">filter</span>(A <span class="sc">&gt;</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span></span>
<span id="cb31-623"><a href="#cb31-623"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> A)) <span class="sc">+</span></span>
<span id="cb31-624"><a href="#cb31-624"></a>  <span class="fu">geom_bar</span>() <span class="sc">+</span></span>
<span id="cb31-625"><a href="#cb31-625"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">100</span>, <span class="dv">10</span>), </span>
<span id="cb31-626"><a href="#cb31-626"></a>                     <span class="at">labels =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">100</span>, <span class="dv">10</span>))</span>
<span id="cb31-627"><a href="#cb31-627"></a></span>
<span id="cb31-628"><a href="#cb31-628"></a><span class="co"># check balance of U across Z</span></span>
<span id="cb31-629"><a href="#cb31-629"></a><span class="co"># balanced as expected, because Z is a randomization indicator</span></span>
<span id="cb31-630"><a href="#cb31-630"></a>UZ_plot <span class="ot">&lt;-</span> df_large <span class="sc">%&gt;%</span></span>
<span id="cb31-631"><a href="#cb31-631"></a>  <span class="fu">mutate</span>(<span class="at">Z =</span> <span class="fu">factor</span>(Z, <span class="at">levels =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">0</span>), </span>
<span id="cb31-632"><a href="#cb31-632"></a>                    <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"Treatment"</span>, <span class="st">"Control"</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb31-633"><a href="#cb31-633"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> U, <span class="at">color =</span> Z)) <span class="sc">+</span></span>
<span id="cb31-634"><a href="#cb31-634"></a>  <span class="fu">geom_density</span>() <span class="sc">+</span></span>
<span id="cb31-635"><a href="#cb31-635"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"bottom"</span>)</span>
<span id="cb31-636"><a href="#cb31-636"></a></span>
<span id="cb31-637"><a href="#cb31-637"></a><span class="co"># check balance across (dichotomized version of) A</span></span>
<span id="cb31-638"><a href="#cb31-638"></a><span class="co"># not balanced because U and A are associated</span></span>
<span id="cb31-639"><a href="#cb31-639"></a>UA_plot <span class="ot">&lt;-</span> df_large <span class="sc">%&gt;%</span></span>
<span id="cb31-640"><a href="#cb31-640"></a>  <span class="fu">mutate</span>(</span>
<span id="cb31-641"><a href="#cb31-641"></a>    <span class="st">`</span><span class="at">A (binary)</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">factor</span>(<span class="fu">as.numeric</span>(A <span class="sc">&gt;</span> <span class="dv">0</span>), </span>
<span id="cb31-642"><a href="#cb31-642"></a>                          <span class="at">levels =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">0</span>), </span>
<span id="cb31-643"><a href="#cb31-643"></a>                          <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"Treated"</span>, <span class="st">"Control"</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb31-644"><a href="#cb31-644"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> U, <span class="at">color =</span> <span class="st">`</span><span class="at">A (binary)</span><span class="st">`</span>)) <span class="sc">+</span></span>
<span id="cb31-645"><a href="#cb31-645"></a>  <span class="fu">geom_density</span>() <span class="sc">+</span></span>
<span id="cb31-646"><a href="#cb31-646"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"bottom"</span>)</span>
<span id="cb31-647"><a href="#cb31-647"></a></span>
<span id="cb31-648"><a href="#cb31-648"></a>gridExtra<span class="sc">::</span><span class="fu">grid.arrange</span>(p_compliance, A_dist, </span>
<span id="cb31-649"><a href="#cb31-649"></a>                        UZ_plot, UA_plot, <span class="at">ncol =</span> <span class="dv">2</span>)</span>
<span id="cb31-650"><a href="#cb31-650"></a><span class="in">```</span></span>
</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
      &nbsp;
    </div>   
    <div class="nav-footer-center">akshat.blog © 2022-2024 Akshat Dwivedi. Built with <a href="https://www.quarto.org">Quarto</a> and <a href="https://pages.github.com">GitHub Pages</a>. Read the <a href="https://github.com/ad1729/ad1729.github.io/LICENSE.md">license.</a></div>
    <div class="nav-footer-right">
      &nbsp;
    </div>
  </div>
</footer>



</body></html>