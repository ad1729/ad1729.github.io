<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.550">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="dcterms.date" content="2025-08-09">

<title>Akshat Dwivedi - Simulating data from the cause-specific hazard approach to competing risks</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<link href="../../favicon.png" rel="icon" type="image/png">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="../../site_libs/bootstrap/bootstrap-dark.min.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<style>html{ scroll-behavior: smooth; }</style>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="../../styles.css">
</head>

<body class="floating nav-fixed slimcontent">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Akshat Dwivedi</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../about.html"> 
<span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/ad1729"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://www.linkedin.com/in/akshatd/"> <i class="bi bi-linkedin" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://500px.com/p/akshatdwivedi?view=photos"> <i class="bi bi-images" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
          <div class="quarto-navbar-tools">
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default toc-left page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <div class="quarto-title-block"><div><h1 class="title">Simulating data from the cause-specific hazard approach to competing risks</h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li><li><hr class="dropdown-divider"></li><li><a id="quarto-view-source" class="dropdown-item" href="javascript:void(0)" role="button">View Source</a></li></ul></div></div>
                                <div class="quarto-categories">
                <div class="quarto-category">R</div>
                <div class="quarto-category">Simulation</div>
                <div class="quarto-category">Time-to-event</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">August 9, 2025</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <nav id="TOC" role="doc-toc" class="toc-active" data-toc-expanded="99">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#data-generating-process" id="toc-data-generating-process" class="nav-link active" data-scroll-target="#data-generating-process">Data generating process</a>
  <ul class="collapse">
  <li><a href="#distributional-parameters" id="toc-distributional-parameters" class="nav-link" data-scroll-target="#distributional-parameters">Distributional parameters</a></li>
  <li><a href="#latent-failure-time-approach" id="toc-latent-failure-time-approach" class="nav-link" data-scroll-target="#latent-failure-time-approach">Latent failure time approach</a></li>
  <li><a href="#cause-specific-hazards-csh" id="toc-cause-specific-hazards-csh" class="nav-link" data-scroll-target="#cause-specific-hazards-csh">Cause-specific hazards (CSH)</a></li>
  <li><a href="#relative-contribution-to-the-overall-hazard" id="toc-relative-contribution-to-the-overall-hazard" class="nav-link" data-scroll-target="#relative-contribution-to-the-overall-hazard">Relative contribution to the overall hazard</a></li>
  <li><a href="#cause-specific-cumulative-incidence-function-cif" id="toc-cause-specific-cumulative-incidence-function-cif" class="nav-link" data-scroll-target="#cause-specific-cumulative-incidence-function-cif">Cause-specific cumulative incidence function (CIF)</a></li>
  <li><a href="#relative-contribution-to-overall-churn" id="toc-relative-contribution-to-overall-churn" class="nav-link" data-scroll-target="#relative-contribution-to-overall-churn">Relative contribution to overall churn</a></li>
  </ul></li>
  <li><a href="#implement-the-simulation-steps" id="toc-implement-the-simulation-steps" class="nav-link" data-scroll-target="#implement-the-simulation-steps">Implement the simulation steps</a>
  <ul class="collapse">
  <li><a href="#overall-hazard" id="toc-overall-hazard" class="nav-link" data-scroll-target="#overall-hazard">Overall hazard</a></li>
  <li><a href="#event-type-probabilities" id="toc-event-type-probabilities" class="nav-link" data-scroll-target="#event-type-probabilities">Event type probabilities</a></li>
  <li><a href="#objective-function" id="toc-objective-function" class="nav-link" data-scroll-target="#objective-function">Objective function</a></li>
  <li><a href="#simulate-single-outcome" id="toc-simulate-single-outcome" class="nav-link" data-scroll-target="#simulate-single-outcome">Simulate single outcome</a></li>
  <li><a href="#simulate-single-dataset" id="toc-simulate-single-dataset" class="nav-link" data-scroll-target="#simulate-single-dataset">Simulate single dataset</a></li>
  </ul></li>
  <li><a href="#test-the-implementation" id="toc-test-the-implementation" class="nav-link" data-scroll-target="#test-the-implementation">Test the implementation</a>
  <ul class="collapse">
  <li><a href="#parameter-estimates" id="toc-parameter-estimates" class="nav-link" data-scroll-target="#parameter-estimates">Parameter estimates</a></li>
  <li><a href="#cif-estimates" id="toc-cif-estimates" class="nav-link" data-scroll-target="#cif-estimates">CIF estimates</a></li>
  </ul></li>
  <li><a href="#comparison-with-survsimcrisk.ncens.sim" id="toc-comparison-with-survsimcrisk.ncens.sim" class="nav-link" data-scroll-target="#comparison-with-survsimcrisk.ncens.sim">Comparison with <code>survsim::crisk.ncens.sim</code></a>
  <ul class="collapse">
  <li><a href="#converting-flexsurv-parameterization-to-survsim" id="toc-converting-flexsurv-parameterization-to-survsim" class="nav-link" data-scroll-target="#converting-flexsurv-parameterization-to-survsim">Converting <code>flexsurv</code> parameterization to <code>survsim</code></a></li>
  <li><a href="#survsim-function" id="toc-survsim-function" class="nav-link" data-scroll-target="#survsim-function"><code>survsim</code> function</a></li>
  <li><a href="#compare-run-times" id="toc-compare-run-times" class="nav-link" data-scroll-target="#compare-run-times">Compare run times</a></li>
  <li><a href="#compare-samples" id="toc-compare-samples" class="nav-link" data-scroll-target="#compare-samples">Compare samples</a></li>
  </ul></li>
  <li><a href="#references" id="toc-references" class="nav-link" data-scroll-target="#references">References</a></li>
  </ul>
<div class="toc-actions"><ul><li><a href="https://github.com/ad1729/ad1729.github.io/issues/new" class="toc-action"><i class="bi bi-github"></i>Report an issue</a></li></ul></div></nav>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
    </div>
<!-- main -->
<main class="content quarto-banner-title-block page-columns page-full" id="quarto-document-content">





<p>In a <a href="../../posts/simulating-survival-data-with-non-PH-and-cure/index.html">previous post</a>, I used the <em>cumulative hazard inversion method</em> to simulate <em>time-to-event (TTE)</em> data from a log-logistic accelerated-failure time (AFT) model with statistical cure. The estimand of interest was the <em>cumulative incidence function (CIF)</em>, which is the probability of experiencing the event of interest before time <span class="math inline">\(t\)</span> (i.e., <span class="math inline">\(\text{Pr}[T \leq t]\)</span>, also known as the cumulative distribution function (CDF) in the absence of censoring).</p>
<p>I came across two things while reading up on material for that post, that I’d mentally filed away for looking into in the future. The first was on simulating TTE data using numerical methods. The second was on estimating the CIF in the <em>competing risk (CR)</em> setting where it wasn’t correct to invert the survivor function (<span class="math inline">\(S(t) = \text{Pr}[T &gt; t] = 1 - \text{Pr}[T \le t]\)</span>) to get to the CIF.</p>
<p>So this post is on simulating data from the <em>cause-specific hazards (CSH)</em> approach to CR based on <a href="https://onlinelibrary.wiley.com/doi/abs/10.1002/sim.3516">this paper</a> (Beyersmann et al.&nbsp;2009); other key papers I use material from are listed in the references below. To check whether my implementation (and understanding) is correct, I run a mini simulation to see if I can recover the true parameters used for generating the data. I also compare the estimated cause-specific CIFs with the true CIFs.</p>
<p>I initially tried to use the <code>survsim</code> package to simulate CSH CR data, but I found it quite slow. Figuring out what I was doing suboptimally was only clear to me after digging deeply into it and reimplementing the code myself by studying the <a href="https://github.com/cran/survsim/blob/6e1bf878cf3e35b37d6cb7d1ef4b0179ed99b1d3/R/crisk.ncens.sim.R">implementation</a> of <code>survsim::crisk.ncens.sim</code> and the Beyersmann paper. My implementation has the advantage that it</p>
<ul>
<li><p>is faster</p></li>
<li><p>uses closed-form expressions for the cumulative hazards rather than numerically integrating the hazards</p></li>
<li><p>uses the same parameterizations as the <code>flexsurv</code> package I’m using to fit the models so I don’t have to mess around with transforming between parameterizations</p></li>
<li><p>can use any distribution that from <code>flexsurv</code> that is not in <code>survsim</code> (so those beyond Weibull, log-normal, log-logistic, and those that are subsumed within these (e.g.&nbsp;exponential within Weibull))</p></li>
<li><p>managed to increase my knowledge of this topic</p></li>
</ul>
<p>I mean I’d most likely still use <code>survsim</code>, unless I need to simulate a lot of not very small datasets, or want the additional flexibility around simulation-model specification.</p>
<p>I think <code>adjustedCurves::sim_confounded_crisk()</code> can simulate CR data from the CSH approach as well, but I haven’t tried it out.</p>
<p>I’m using the following packages</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1"></a><span class="fu">library</span>(tidyverse)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>── Attaching core tidyverse packages ──────────────────────── tidyverse 2.0.0 ──
✔ dplyr     1.1.4     ✔ readr     2.1.5
✔ forcats   1.0.0     ✔ stringr   1.5.1
✔ ggplot2   3.5.2     ✔ tibble    3.2.1
✔ lubridate 1.9.3     ✔ tidyr     1.3.1
✔ purrr     1.1.0     
── Conflicts ────────────────────────────────────────── tidyverse_conflicts() ──
✖ dplyr::filter() masks stats::filter()
✖ dplyr::lag()    masks stats::lag()
ℹ Use the conflicted package (&lt;http://conflicted.r-lib.org/&gt;) to force all conflicts to become errors</code></pre>
</div>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1"></a><span class="fu">library</span>(survival)</span>
<span id="cb3-2"><a href="#cb3-2"></a><span class="fu">library</span>(flexsurv)</span>
<span id="cb3-3"><a href="#cb3-3"></a><span class="co"># functions called via namespace::fun() to avoid conflicts</span></span>
<span id="cb3-4"><a href="#cb3-4"></a><span class="co"># library(glue)  # string interpolation</span></span>
<span id="cb3-5"><a href="#cb3-5"></a><span class="co"># library(mirai)  # for setting daemons() for parallelization</span></span>
<span id="cb3-6"><a href="#cb3-6"></a><span class="co"># library(survsim)</span></span>
<span id="cb3-7"><a href="#cb3-7"></a><span class="co"># library(ggh4x)  # facet_grid2 function</span></span>
<span id="cb3-8"><a href="#cb3-8"></a><span class="co"># library(bench)  # for benchmarking</span></span>
<span id="cb3-9"><a href="#cb3-9"></a></span>
<span id="cb3-10"><a href="#cb3-10"></a><span class="fu">theme_set</span>(<span class="fu">theme_bw</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="data-generating-process" class="level2">
<h2 class="anchored" data-anchor-id="data-generating-process">Data generating process</h2>
<p>In the usual TTE setting, interest is on a single event. An example from marketing is that of customer churn, where a customer cancels their subscription. The competing risk approach to TTE analysis extends this to cases where more than one event can occur.</p>
<p>Sticking with the churn example, this could be (say) three possible event types (using the event indicator <span class="math inline">\(D\)</span> with values <span class="math inline">\(k = 1, 2, 3 (= K)\)</span>) — churn due to customer dissatisfaction with some aspect of the product / service which is the main event of interest that a company would like to reduce (<span class="math inline">\(D = 1\)</span>), churn due to financial reasons (<span class="math inline">\(D = 2\)</span>), and churn due to unavoidable reasons (<span class="math inline">\(D = 3\)</span>). <span class="math inline">\(D = 0\)</span> indicates not having churned (yet). I’m using an example just to make things a bit more concrete; these hazard functions are unlikely to be representative of any actual churn process.</p>
<p>This single vs multiple TTE analysis is analogous to the distinction between binary (binomial) vs categorical (multinomial) outcomes, with the former taking on values 0 / 1, and the latter taking on more than 2 values e.g., 0 / 1 / 2 / 3.</p>
<section id="distributional-parameters" class="level3">
<h3 class="anchored" data-anchor-id="distributional-parameters">Distributional parameters</h3>
<p>The three churn event types are assumed to have the hazard functions corresponding to these distributions</p>
<p><span class="math display">\[
\begin{align*}
T^1 | x_1 = 0 &amp;\sim \text{Weibull}(\text{shape} = 1.6, \text{scale} = 5) \\
T^2 | x_1 = 0 &amp;\sim \text{Log-logistic}(\text{shape} = 5, \text{scale} = 5) \\
T^3 | x_1 = 0 &amp;\sim \text{Exponential}(\text{rate} = 5)
\end{align*}
\]</span></p>
<p>for the control arm (<span class="math inline">\(x_1 = 0\)</span>) assuming some experiment is carried out to assess the effectiveness of some action intended to reduce churn. Treatment arm can be coded as <span class="math inline">\(x_1 = 1\)</span> with treatment assumed to reduce the rate of churn by a time acceleration factor of 1.4 or 40%. So we have</p>
<p><span class="math display">\[
\begin{align*}
T^1 | x_1 = 0 &amp;\sim \text{Weibull}(\text{shape} = 1.6, \text{scale} = 5) \\
T^1 | x_1 = 1 &amp;\sim \text{Weibull}(\text{shape} = 1.6, \text{scale} = 7)
\end{align*}
\]</span></p>
<p>and <span class="math inline">\(T^2 |x_1\)</span> and <span class="math inline">\(T^3 | x_1\)</span> are the same for <span class="math inline">\(x_1 = 0\)</span> and <span class="math inline">\(x_1 = 1\)</span>.</p>
<p>Choosing <span class="math inline">\(x_1\)</span> to have a non-zero effect only on <span class="math inline">\(T^1\)</span> means I’m avoiding some of the messiness that comes with interpreting treatment effects on the CIFs.</p>
<p>I’m also assuming a 50-50 (%) split of <span class="math inline">\(x_1\)</span> into the two groups.</p>
<p>These values for the shape / scale / rate parameters were chosen to have decent balance across the different event types and to not have some categories with very low event counts.</p>
</section>
<section id="latent-failure-time-approach" class="level3">
<h3 class="anchored" data-anchor-id="latent-failure-time-approach">Latent failure time approach</h3>
<p>The use of <span class="math inline">\(T^{\bullet}\)</span> makes it seem like I’m invoking the <em>latent failure time approach to CR</em>, but I’m only using it as a convenient way of indicating the chosen CSH functions. As pretty much all papers on CR warn, the latent variable approach — which retains <span class="math inline">\(T_i = min(T^1_i, \dots, T^K_i)\)</span> for each individual <span class="math inline">\(i\)</span> — assumes unverifiable dependence structures between the latent event time variable <span class="math inline">\(T^k\)</span> which are generally not identifiable from observed data.</p>
<p>This is sad because the latent variable approach seems a lot more intuitive and is very simple to generate data from when the latent event times are assumed to be independent</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1"></a>n <span class="ot">&lt;-</span> <span class="dv">7</span></span>
<span id="cb4-2"><a href="#cb4-2"></a><span class="fu">set.seed</span>(<span class="dv">25</span>)</span>
<span id="cb4-3"><a href="#cb4-3"></a><span class="fu">tibble</span>(</span>
<span id="cb4-4"><a href="#cb4-4"></a>  <span class="co"># generate group membership</span></span>
<span id="cb4-5"><a href="#cb4-5"></a>  <span class="at">x1 =</span> <span class="fu">rbinom</span>(n, <span class="dv">1</span>, <span class="at">prob =</span> <span class="fl">0.5</span>),</span>
<span id="cb4-6"><a href="#cb4-6"></a>  <span class="co"># generate counterfactual for x1 = 0</span></span>
<span id="cb4-7"><a href="#cb4-7"></a>  <span class="at">t1_0 =</span> <span class="fu">rweibull</span>(n, <span class="at">shape =</span> <span class="fl">1.6</span>, <span class="at">scale =</span> <span class="dv">5</span>),</span>
<span id="cb4-8"><a href="#cb4-8"></a>  <span class="co"># and counterfactual for x1 = 1 (using scale = 7)</span></span>
<span id="cb4-9"><a href="#cb4-9"></a>  <span class="at">t1_1 =</span> <span class="fu">rweibull</span>(n, <span class="at">shape =</span> <span class="fl">1.6</span>, <span class="at">scale =</span> <span class="fu">exp</span>(<span class="fu">log</span>(<span class="dv">5</span>) <span class="sc">+</span> <span class="fu">log</span>(<span class="fl">1.4</span>))),</span>
<span id="cb4-10"><a href="#cb4-10"></a>  <span class="co"># use the consistency equation to realize the latent t1</span></span>
<span id="cb4-11"><a href="#cb4-11"></a>  <span class="at">t1 =</span>  (x1 <span class="sc">*</span> t1_1) <span class="sc">+</span> ((<span class="dv">1</span> <span class="sc">-</span> x1) <span class="sc">*</span> t1_0),</span>
<span id="cb4-12"><a href="#cb4-12"></a>  <span class="at">t2 =</span> <span class="fu">rllogis</span>(n, <span class="at">shape =</span> <span class="dv">5</span>, <span class="at">scale =</span> <span class="dv">5</span>),</span>
<span id="cb4-13"><a href="#cb4-13"></a>  <span class="co"># exponential distribution, same as rexp(n, 1 / 5)</span></span>
<span id="cb4-14"><a href="#cb4-14"></a>  <span class="at">t3 =</span> <span class="fu">rweibull</span>(n, <span class="at">shape =</span> <span class="dv">1</span>, <span class="at">scale =</span> <span class="dv">5</span>),</span>
<span id="cb4-15"><a href="#cb4-15"></a>  <span class="co"># administrative censoring</span></span>
<span id="cb4-16"><a href="#cb4-16"></a>  <span class="at">cens_time =</span> <span class="dv">4</span>,</span>
<span id="cb4-17"><a href="#cb4-17"></a>  <span class="co"># take the minimum of the latent event and censoring times</span></span>
<span id="cb4-18"><a href="#cb4-18"></a>  <span class="at">time =</span> <span class="fu">pmin</span>(t1, t2, t3, cens_time), </span>
<span id="cb4-19"><a href="#cb4-19"></a>  <span class="co"># record which event / censor time is the smallest</span></span>
<span id="cb4-20"><a href="#cb4-20"></a>  <span class="at">event =</span> <span class="fu">case_when</span>(</span>
<span id="cb4-21"><a href="#cb4-21"></a>    cens_time <span class="sc">&lt;</span> t1 <span class="sc">&amp;</span> cens_time <span class="sc">&lt;</span> t2 <span class="sc">&amp;</span> cens_time <span class="sc">&lt;</span> t3 <span class="sc">~</span> <span class="dv">0</span>,</span>
<span id="cb4-22"><a href="#cb4-22"></a>    t1 <span class="sc">&lt;</span> t2 <span class="sc">&amp;</span> t2 <span class="sc">&lt;</span> t3 <span class="sc">~</span> <span class="dv">1</span>,</span>
<span id="cb4-23"><a href="#cb4-23"></a>    t2 <span class="sc">&lt;</span> t1 <span class="sc">&amp;</span> t2 <span class="sc">&lt;</span> t3 <span class="sc">~</span> <span class="dv">2</span>,</span>
<span id="cb4-24"><a href="#cb4-24"></a>    t3 <span class="sc">&lt;</span> t1 <span class="sc">&amp;</span> t3 <span class="sc">&lt;</span> t2 <span class="sc">~</span> <span class="dv">3</span></span>
<span id="cb4-25"><a href="#cb4-25"></a>  )</span>
<span id="cb4-26"><a href="#cb4-26"></a>) <span class="sc">%&gt;%</span> </span>
<span id="cb4-27"><a href="#cb4-27"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="at">.cols =</span> <span class="fu">everything</span>(), <span class="at">.fns =</span> <span class="sc">~</span> <span class="fu">round</span>(.x, <span class="dv">2</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 7 × 9
     x1  t1_0  t1_1    t1    t2    t3 cens_time  time event
  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;     &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
1     0  5.26  3.72  5.26  4.81  3.15         4  3.15     3
2     1  9.32 10.5  10.5   3.17  7.18         4  3.17     2
3     0  5.79  5.18  5.79  3.56  0.97         4  0.97     3
4     1  5.35  3.42  3.42  4.19  5.26         4  3.42     1
5     0  5.04  5.8   5.04  4.22  7.2          4  4        0
6     1  0.69  3.4   3.4   3    11.4          4  3        2
7     1  3.36 14.5  14.5   5.39  0.92         4  0.92     3</code></pre>
</div>
</div>
<p>I’m quite sure that if I used this for my simulation I’d still end up with unbiased parameter estimates, but the assumption of independence may not be very realistic depending on the application.</p>
<p>A future rabbit hole to go down would be to look into the literature on using copulas for modelling dependence between the latent event times.</p>
<p>The event time for each individual will be referred to using a single random variable <span class="math inline">\(T\)</span> since no latent variables are assumed.</p>
</section>
<section id="cause-specific-hazards-csh" class="level3">
<h3 class="anchored" data-anchor-id="cause-specific-hazards-csh">Cause-specific hazards (CSH)</h3>
<p>We can plot the CSH functions defined as</p>
<p><span class="math display">\[
h_k(t | x_1) = \lim_{\Delta t \rightarrow 0} \frac{\text{Pr}[t \le T &lt; t + \Delta t, D = k | T \ge t, x_1]}{\Delta t}
\]</span></p>
<p>for the <span class="math inline">\(k^\text{th}\)</span> event showing the instantaneous rate of occurrence of that event</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1"></a>time_seq <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="fl">0.01</span>, <span class="dv">50</span>, <span class="fl">0.01</span>)</span>
<span id="cb6-2"><a href="#cb6-2"></a>hazards <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(</span>
<span id="cb6-3"><a href="#cb6-3"></a>  <span class="fu">tibble</span>(</span>
<span id="cb6-4"><a href="#cb6-4"></a>    <span class="at">Distribution =</span> <span class="st">"Event 1: Weibull(shape = 1.6, scale = 5)"</span>,</span>
<span id="cb6-5"><a href="#cb6-5"></a>    <span class="at">time =</span> time_seq,</span>
<span id="cb6-6"><a href="#cb6-6"></a>    <span class="at">Hazard =</span> <span class="fu">hweibull</span>(time_seq, <span class="at">shape =</span> <span class="fl">1.6</span>, <span class="at">scale =</span> <span class="dv">5</span>)</span>
<span id="cb6-7"><a href="#cb6-7"></a>  ),</span>
<span id="cb6-8"><a href="#cb6-8"></a>  <span class="fu">tibble</span>(</span>
<span id="cb6-9"><a href="#cb6-9"></a>    <span class="at">Distribution =</span> <span class="st">"Event 1: Weibull(shape = 1.6, scale = 7)"</span>,</span>
<span id="cb6-10"><a href="#cb6-10"></a>    <span class="at">time =</span> time_seq,</span>
<span id="cb6-11"><a href="#cb6-11"></a>    <span class="at">Hazard =</span> <span class="fu">hweibull</span>(time_seq, <span class="at">shape =</span> <span class="fl">1.6</span>, <span class="at">scale =</span> <span class="dv">7</span>)</span>
<span id="cb6-12"><a href="#cb6-12"></a>  ),</span>
<span id="cb6-13"><a href="#cb6-13"></a>  <span class="fu">tibble</span>(</span>
<span id="cb6-14"><a href="#cb6-14"></a>    <span class="at">Distribution =</span> <span class="st">"Event 2: Log-logistic(shape = 5, scale = 5)"</span>,</span>
<span id="cb6-15"><a href="#cb6-15"></a>    <span class="at">time =</span> time_seq,</span>
<span id="cb6-16"><a href="#cb6-16"></a>    <span class="at">Hazard =</span> <span class="fu">hllogis</span>(time_seq, <span class="at">shape =</span> <span class="dv">5</span>, <span class="at">scale =</span> <span class="dv">5</span>)</span>
<span id="cb6-17"><a href="#cb6-17"></a>  ),</span>
<span id="cb6-18"><a href="#cb6-18"></a>  <span class="fu">tibble</span>(</span>
<span id="cb6-19"><a href="#cb6-19"></a>    <span class="at">Distribution =</span> <span class="st">"Event 3: Exponential(rate = 5)"</span>,</span>
<span id="cb6-20"><a href="#cb6-20"></a>    <span class="at">time =</span> time_seq,</span>
<span id="cb6-21"><a href="#cb6-21"></a>    <span class="at">Hazard =</span> <span class="fu">hweibull</span>(time_seq, <span class="at">shape =</span> <span class="dv">1</span>, <span class="at">scale =</span> <span class="dv">5</span>)</span>
<span id="cb6-22"><a href="#cb6-22"></a>  )</span>
<span id="cb6-23"><a href="#cb6-23"></a>)</span>
<span id="cb6-24"><a href="#cb6-24"></a></span>
<span id="cb6-25"><a href="#cb6-25"></a>hazards <span class="sc">%&gt;%</span></span>
<span id="cb6-26"><a href="#cb6-26"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> Hazard, <span class="at">group =</span> Distribution, </span>
<span id="cb6-27"><a href="#cb6-27"></a>             <span class="at">linetype =</span> Distribution)) <span class="sc">+</span></span>
<span id="cb6-28"><a href="#cb6-28"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb6-29"><a href="#cb6-29"></a>  <span class="fu">xlab</span>(<span class="st">"Time (t)"</span>) <span class="sc">+</span></span>
<span id="cb6-30"><a href="#cb6-30"></a>  <span class="fu">theme</span>(</span>
<span id="cb6-31"><a href="#cb6-31"></a>    <span class="at">legend.title =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb6-32"><a href="#cb6-32"></a>    <span class="at">legend.position =</span> <span class="st">"bottom"</span></span>
<span id="cb6-33"><a href="#cb6-33"></a>  ) <span class="sc">+</span></span>
<span id="cb6-34"><a href="#cb6-34"></a>  <span class="fu">guides</span>(<span class="at">linetype =</span> <span class="fu">guide_legend</span>(<span class="at">nrow =</span> <span class="dv">2</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-3-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>I’m using the hazard functions implemented within <code>flexsurv</code> (e.g., <code>flexsurv::hweibull()</code>). The exponential hazard is constant over time. The log-logistic hazard first rises and then falls with time. The Weibull hazards for the chosen parameters are monotonically increasing functions of time. The hazard for each event is independent of the hazard for all other events.</p>
</section>
<section id="relative-contribution-to-the-overall-hazard" class="level3">
<h3 class="anchored" data-anchor-id="relative-contribution-to-the-overall-hazard">Relative contribution to the overall hazard</h3>
<p>As mentioned in the Hinchliffe and Lambert (2013) paper, it can be useful to look at the relative contribution of the hazard of each event to the overall hazard within each group at each <span class="math inline">\(t\)</span></p>
<p><span class="math display">\[
\text{Pr}[D = k | t \le T &lt; t + \Delta t, T \ge t, x_1] = \frac{h_k(t | x_1)}{\sum_{k = 1}^K h_k(t | x_1)}
\]</span></p>
<p>This can be interpreted as the probability of an event of type <span class="math inline">\(k\)</span> among those who experience an event <strong>at</strong> time <span class="math inline">\(t\)</span> and haven’t experienced any of the events before <span class="math inline">\(t\)</span>.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1"></a><span class="co"># prob(cause | event = 1)</span></span>
<span id="cb7-2"><a href="#cb7-2"></a>cause_specific_hazards_by_group <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(</span>
<span id="cb7-3"><a href="#cb7-3"></a>  hazards <span class="sc">%&gt;%</span></span>
<span id="cb7-4"><a href="#cb7-4"></a>    <span class="co"># for x = 0, drop the cause 1 for x = 1</span></span>
<span id="cb7-5"><a href="#cb7-5"></a>    <span class="fu">filter</span>(Distribution <span class="sc">!=</span> <span class="st">"Event 1: Weibull(shape = 1.6, scale = 7)"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb7-6"><a href="#cb7-6"></a>    <span class="fu">mutate</span>(<span class="at">Group =</span> <span class="st">"x1 = 0"</span>),</span>
<span id="cb7-7"><a href="#cb7-7"></a>  hazards <span class="sc">%&gt;%</span></span>
<span id="cb7-8"><a href="#cb7-8"></a>    <span class="co"># for x = 1, drop the cause 1 for x = 0</span></span>
<span id="cb7-9"><a href="#cb7-9"></a>    <span class="fu">filter</span>(Distribution <span class="sc">!=</span> <span class="st">"Event 1: Weibull(shape = 1.6, scale = 5)"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb7-10"><a href="#cb7-10"></a>    <span class="fu">mutate</span>(<span class="at">Group =</span> <span class="st">"x1 = 1"</span>)</span>
<span id="cb7-11"><a href="#cb7-11"></a>)</span>
<span id="cb7-12"><a href="#cb7-12"></a></span>
<span id="cb7-13"><a href="#cb7-13"></a>relative_contribution_to_overall_hazard <span class="ot">&lt;-</span>cause_specific_hazards_by_group <span class="sc">%&gt;%</span></span>
<span id="cb7-14"><a href="#cb7-14"></a>  <span class="fu">arrange</span>(Group, time, Distribution) <span class="sc">%&gt;%</span></span>
<span id="cb7-15"><a href="#cb7-15"></a>  <span class="fu">group_by</span>(Group, time) <span class="sc">%&gt;%</span></span>
<span id="cb7-16"><a href="#cb7-16"></a>  <span class="fu">mutate</span>(<span class="at">overall_hazard =</span> <span class="fu">sum</span>(Hazard), <span class="at">p =</span> Hazard <span class="sc">/</span> overall_hazard) <span class="sc">%&gt;%</span></span>
<span id="cb7-17"><a href="#cb7-17"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb7-18"><a href="#cb7-18"></a></span>
<span id="cb7-19"><a href="#cb7-19"></a>relative_contribution_to_overall_hazard <span class="sc">%&gt;%</span></span>
<span id="cb7-20"><a href="#cb7-20"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> p, </span>
<span id="cb7-21"><a href="#cb7-21"></a>             <span class="at">group =</span> <span class="fu">interaction</span>(Group, Distribution), </span>
<span id="cb7-22"><a href="#cb7-22"></a>             <span class="at">linetype =</span> Distribution)) <span class="sc">+</span></span>
<span id="cb7-23"><a href="#cb7-23"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb7-24"><a href="#cb7-24"></a>  <span class="fu">xlab</span>(<span class="st">"Time (t)"</span>) <span class="sc">+</span></span>
<span id="cb7-25"><a href="#cb7-25"></a>  <span class="fu">ylab</span>(<span class="st">"Pr [event type k | any event]"</span>) <span class="sc">+</span></span>
<span id="cb7-26"><a href="#cb7-26"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> Group) <span class="sc">+</span></span>
<span id="cb7-27"><a href="#cb7-27"></a>  <span class="fu">theme</span>(</span>
<span id="cb7-28"><a href="#cb7-28"></a>    <span class="at">legend.title =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb7-29"><a href="#cb7-29"></a>    <span class="at">legend.position =</span> <span class="st">"bottom"</span></span>
<span id="cb7-30"><a href="#cb7-30"></a>  ) <span class="sc">+</span></span>
<span id="cb7-31"><a href="#cb7-31"></a>  <span class="fu">guides</span>(<span class="at">linetype =</span> <span class="fu">guide_legend</span>(<span class="at">nrow =</span> <span class="dv">2</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-4-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>For individuals that churn very soon after <span class="math inline">\(t = 0\)</span>, they’re more likely to have had <span class="math inline">\(D = 3\)</span>, followed by <span class="math inline">\(D = 1\)</span>, followed by <span class="math inline">\(D = 2\)</span>. Events that occur around <span class="math inline">\(t = 5\)</span> are most likely to be <span class="math inline">\(D = 2\)</span> as shown by the long-dash line peaking after that time.</p>
</section>
<section id="cause-specific-cumulative-incidence-function-cif" class="level3">
<h3 class="anchored" data-anchor-id="cause-specific-cumulative-incidence-function-cif">Cause-specific cumulative incidence function (CIF)</h3>
<p>A key quantity is the cumulative incidence function (CIF) for each of the <span class="math inline">\(K = 3\)</span> events, which is the probability that an individual will experience event <span class="math inline">\(k\)</span> before time <span class="math inline">\(t\)</span> in the absence of the occurrence of any of the other events</p>
<p><span class="math display">\[
\text{CIF}_k(t|x_1) = \text{Pr}[T \le t, D = k | x_1] = \int_{u=0}^{u=t} h_k(u | x_1) S(u | x_1) du
\]</span></p>
<p><span class="math inline">\(h_k(t|x_1)\)</span> is the CSH function, and <span class="math inline">\(S(t|x_1)\)</span> is the overall survivor function in each group. The latter is defined as the probability of being free of any event up to time <span class="math inline">\(t\)</span></p>
<p><span class="math display">\[
S(t | x_1) = \text{Pr}[T &gt; t | x_1] =  \text{exp}\Bigg(- \sum_{k = 1}^K H_k(t | x_1)\Bigg)
\]</span></p>
<p><span class="math inline">\(H_k(t | x_1)\)</span> is the cumulative hazard function for the <span class="math inline">\(k^{\text{th}}\)</span> event in each group</p>
<p><span class="math display">\[
H_k(t | x_1) = \int_{u = 0}^{u = t} h_k(u | x_1) du
\]</span></p>
<p>The cumulative hazard functions are used as implemented in <code>flexsurv</code> (e.g., <code>flexsurv::Hweibull()</code>). In discrete-time, the integral for the CIF is replaced by summation, and <span class="math inline">\(S(u|\cdot)\)</span> in the integrand / summand is replaced with <span class="math inline">\(S(-u | \cdot)\)</span>, which is the survival probability at a time point right before <span class="math inline">\(u\)</span>. The CIFs and <span class="math inline">\(S(t)\)</span> are probabilities of being in the different states by time <span class="math inline">\(t\)</span></p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1"></a><span class="co"># calculate the overall survival from the overall hazard</span></span>
<span id="cb8-2"><a href="#cb8-2"></a>overall_survival <span class="ot">&lt;-</span> time_seq <span class="sc">%&gt;%</span> </span>
<span id="cb8-3"><a href="#cb8-3"></a>  <span class="fu">expand_grid</span>(</span>
<span id="cb8-4"><a href="#cb8-4"></a>    <span class="at">x1 =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>), <span class="at">time =</span> .</span>
<span id="cb8-5"><a href="#cb8-5"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb8-6"><a href="#cb8-6"></a>  <span class="fu">mutate</span>(</span>
<span id="cb8-7"><a href="#cb8-7"></a>    <span class="at">surv =</span> <span class="fu">exp</span>(<span class="sc">-</span>(</span>
<span id="cb8-8"><a href="#cb8-8"></a>      <span class="fu">Hweibull</span>(<span class="at">x =</span> time, <span class="at">shape =</span> <span class="fl">1.6</span>, <span class="at">scale =</span> <span class="fu">exp</span>(<span class="fu">log</span>(<span class="dv">5</span>) <span class="sc">+</span> <span class="fu">log</span>(<span class="fl">1.4</span>) <span class="sc">*</span> x1), </span>
<span id="cb8-9"><a href="#cb8-9"></a>               <span class="at">log =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb8-10"><a href="#cb8-10"></a>      <span class="fu">Hllogis</span>(<span class="at">x =</span> time, <span class="at">shape =</span> <span class="dv">5</span>, <span class="at">scale =</span> <span class="dv">5</span>, <span class="at">log =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb8-11"><a href="#cb8-11"></a>      <span class="fu">Hweibull</span>(<span class="at">x =</span> time, <span class="at">shape =</span> <span class="dv">1</span>, <span class="at">scale =</span> <span class="dv">5</span>, <span class="at">log =</span> <span class="cn">FALSE</span>)</span>
<span id="cb8-12"><a href="#cb8-12"></a>    )),</span>
<span id="cb8-13"><a href="#cb8-13"></a>    <span class="at">Group =</span> <span class="fu">paste0</span>(<span class="st">"x1 = "</span>, x1)</span>
<span id="cb8-14"><a href="#cb8-14"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb8-15"><a href="#cb8-15"></a>  <span class="fu">select</span>(<span class="sc">-</span>x1)</span>
<span id="cb8-16"><a href="#cb8-16"></a></span>
<span id="cb8-17"><a href="#cb8-17"></a>time_step <span class="ot">&lt;-</span> time_seq[<span class="dv">2</span>] <span class="sc">-</span> time_seq[<span class="dv">1</span>]</span>
<span id="cb8-18"><a href="#cb8-18"></a></span>
<span id="cb8-19"><a href="#cb8-19"></a><span class="co"># calculate CIFs</span></span>
<span id="cb8-20"><a href="#cb8-20"></a>cumulative_incidence_curves <span class="ot">&lt;-</span> cause_specific_hazards_by_group <span class="sc">%&gt;%</span></span>
<span id="cb8-21"><a href="#cb8-21"></a>  <span class="fu">inner_join</span>(<span class="at">y =</span> overall_survival, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"Group"</span>, <span class="st">"time"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb8-22"><a href="#cb8-22"></a>  <span class="fu">group_by</span>(Group, Distribution) <span class="sc">%&gt;%</span></span>
<span id="cb8-23"><a href="#cb8-23"></a>  <span class="fu">mutate</span>(<span class="at">CIF =</span> <span class="fu">order_by</span>(time, <span class="fu">cumsum</span>(Hazard <span class="sc">*</span> surv <span class="sc">*</span> time_step))) <span class="sc">%&gt;%</span></span>
<span id="cb8-24"><a href="#cb8-24"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb8-25"><a href="#cb8-25"></a></span>
<span id="cb8-26"><a href="#cb8-26"></a><span class="co"># plot the CIFs</span></span>
<span id="cb8-27"><a href="#cb8-27"></a><span class="co"># P[T &lt;= t, cause = k | Event]</span></span>
<span id="cb8-28"><a href="#cb8-28"></a>cumulative_incidence_curves_plot_data <span class="ot">&lt;-</span> cumulative_incidence_curves <span class="sc">%&gt;%</span></span>
<span id="cb8-29"><a href="#cb8-29"></a>  <span class="fu">select</span>(<span class="sc">-</span>Hazard) <span class="sc">%&gt;%</span></span>
<span id="cb8-30"><a href="#cb8-30"></a>  <span class="fu">pivot_wider</span>(<span class="at">id_cols =</span> <span class="fu">c</span>(time, Group, surv), </span>
<span id="cb8-31"><a href="#cb8-31"></a>              <span class="at">names_from =</span> Distribution, <span class="at">values_from =</span> CIF) <span class="sc">%&gt;%</span></span>
<span id="cb8-32"><a href="#cb8-32"></a>  <span class="fu">rename</span>(<span class="st">`</span><span class="at">Event-free</span><span class="st">`</span> <span class="ot">=</span> surv) <span class="sc">%&gt;%</span></span>
<span id="cb8-33"><a href="#cb8-33"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="sc">-</span><span class="fu">c</span>(time, Group), </span>
<span id="cb8-34"><a href="#cb8-34"></a>               <span class="at">names_to =</span> <span class="st">"Event"</span>, <span class="at">values_to =</span> <span class="st">"CIF"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb8-35"><a href="#cb8-35"></a>  <span class="fu">filter</span>(<span class="fu">complete.cases</span>(.))</span>
<span id="cb8-36"><a href="#cb8-36"></a></span>
<span id="cb8-37"><a href="#cb8-37"></a>cumulative_incidence_curves_plot <span class="ot">&lt;-</span> cumulative_incidence_curves_plot_data <span class="sc">%&gt;%</span></span>
<span id="cb8-38"><a href="#cb8-38"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> CIF, <span class="at">linetype =</span> Event)) <span class="sc">+</span></span>
<span id="cb8-39"><a href="#cb8-39"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb8-40"><a href="#cb8-40"></a>  <span class="fu">xlab</span>(<span class="st">"Time (t)"</span>) <span class="sc">+</span></span>
<span id="cb8-41"><a href="#cb8-41"></a>  <span class="fu">ylab</span>(<span class="st">"Probability of being in state"</span>) <span class="sc">+</span></span>
<span id="cb8-42"><a href="#cb8-42"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> Group) <span class="sc">+</span></span>
<span id="cb8-43"><a href="#cb8-43"></a>  <span class="fu">theme</span>(</span>
<span id="cb8-44"><a href="#cb8-44"></a>    <span class="at">legend.title =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb8-45"><a href="#cb8-45"></a>    <span class="at">legend.position =</span> <span class="st">"bottom"</span></span>
<span id="cb8-46"><a href="#cb8-46"></a>  ) <span class="sc">+</span></span>
<span id="cb8-47"><a href="#cb8-47"></a>  <span class="fu">guides</span>(<span class="at">linetype =</span> <span class="fu">guide_legend</span>(<span class="at">nrow =</span> <span class="dv">3</span>))</span>
<span id="cb8-48"><a href="#cb8-48"></a></span>
<span id="cb8-49"><a href="#cb8-49"></a>cumulative_incidence_curves_plot</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-5-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The CIFs are called <em>subdistribution</em> functions because they never reach 1 (at <span class="math inline">\(t = \infty\)</span>) due to the presence of competing events so are not proper probability distributions. In the single event case, the CIF eventually reaches 1 given enough time.</p>
<p>Within each panel, the curves sum to 1 at every time point, since each individual is in one state at each time point</p>
<p><span class="math display">\[
\sum_{k = 1}^K\text{CIF}_k(t | x_1) + S(t | x_1) = 1 = \text{Pr}[T \le t, D = 1 | x_1] + \text{Pr}[T \le t, D = 2 | x_1] + \text{Pr}[T \le t, D = 3 | x_1] + \text{Pr}[T &gt; t | x_1]
\]</span></p>
<p>All individuals start with being event free at <span class="math inline">\(t = 0\)</span>, but as as time progresses, they move into any one of the <span class="math inline">\(k\)</span> states, so the probability of being event-free, i.e., staying in state <span class="math inline">\(D = 0\)</span>, decreases with time and goes to 0 eventually (here around <span class="math inline">\(t = 7\)</span>).</p>
<p>One difference between this plot and the unnormalized hazard plot is that here the hazard of each event contributes to the CIF of all other events via it’s dependence on the overall survival. So <span class="math inline">\(\text{CIF}_2(t | x1 = 0) \neq \text{CIF}_2(t | x1 = 1)\)</span> and <span class="math inline">\(\text{CIF}_3(t | x1 = 0) \neq \text{CIF}_3(t | x1 = 1)\)</span> because <span class="math inline">\(H_1(t | x_1 = 0) \ne H_1(t | x_1 = 1)\)</span>, even though <span class="math inline">\(H_2(t | x_1 = 0) = H_2(t | x_1 = 1)\)</span> and <span class="math inline">\(H_3(t | x_1 = 0) = H_3(t | x_1 = 1)\)</span>.</p>
</section>
<section id="relative-contribution-to-overall-churn" class="level3">
<h3 class="anchored" data-anchor-id="relative-contribution-to-overall-churn">Relative contribution to overall churn</h3>
<p>Similar to the relative contribution of the CSHs to overall hazard I came across in the Hinchliffe and Lambert paper, they also mention the rescaled cause-specific CIFs (disregarding <span class="math inline">\(S(t | x_1)\)</span>)</p>
<p><span class="math display">\[
\text{Pr}[D = k | T \le t, x_1] = \frac{\text{CIF}_k(t | x_1)}{\sum_{k = 1}^K \text{CIF}_k(t | x_1)}
\]</span></p>
<p>which is the probability of having had event <span class="math inline">\(k\)</span> among those who have churned <strong>by</strong> time <span class="math inline">\(t\)</span> within levels of <span class="math inline">\(x_1\)</span></p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1"></a><span class="co"># plot the rescaled CIFs conditional on event</span></span>
<span id="cb9-2"><a href="#cb9-2"></a><span class="co"># so ignores the no even state</span></span>
<span id="cb9-3"><a href="#cb9-3"></a><span class="co"># P[T &lt;= t, cause = k | Event]</span></span>
<span id="cb9-4"><a href="#cb9-4"></a>cumulative_incidence_curves <span class="sc">%&gt;%</span></span>
<span id="cb9-5"><a href="#cb9-5"></a>  <span class="fu">mutate</span>(<span class="at">rescaled_CIF =</span> CIF <span class="sc">/</span> <span class="fu">sum</span>(CIF), <span class="at">.by =</span> <span class="fu">c</span>(Group, time)) <span class="sc">%&gt;%</span></span>
<span id="cb9-6"><a href="#cb9-6"></a>  <span class="co"># arrange(Group, time) %&gt;%</span></span>
<span id="cb9-7"><a href="#cb9-7"></a>  <span class="co"># print()</span></span>
<span id="cb9-8"><a href="#cb9-8"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> rescaled_CIF, <span class="at">linetype =</span> Distribution)) <span class="sc">+</span></span>
<span id="cb9-9"><a href="#cb9-9"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb9-10"><a href="#cb9-10"></a>  <span class="fu">xlab</span>(<span class="st">"Time (t)"</span>) <span class="sc">+</span></span>
<span id="cb9-11"><a href="#cb9-11"></a>  <span class="fu">ylab</span>(<span class="st">"Pr [event type k by t | any event]"</span>) <span class="sc">+</span></span>
<span id="cb9-12"><a href="#cb9-12"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> Group) <span class="sc">+</span></span>
<span id="cb9-13"><a href="#cb9-13"></a>  <span class="fu">theme</span>(</span>
<span id="cb9-14"><a href="#cb9-14"></a>    <span class="at">legend.title =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb9-15"><a href="#cb9-15"></a>    <span class="at">legend.position =</span> <span class="st">"bottom"</span></span>
<span id="cb9-16"><a href="#cb9-16"></a>  ) <span class="sc">+</span></span>
<span id="cb9-17"><a href="#cb9-17"></a>  <span class="fu">guides</span>(<span class="at">linetype =</span> <span class="fu">guide_legend</span>(<span class="at">nrow =</span> <span class="dv">2</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-6-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="implement-the-simulation-steps" class="level2">
<h2 class="anchored" data-anchor-id="implement-the-simulation-steps">Implement the simulation steps</h2>
<p>The key idea behind simulating CR data from the CSH approach is summarized in the following steps (here within each level of covariate <span class="math inline">\(x_1\)</span>):</p>
<ul>
<li><p>specify the cause-specific hazards <span class="math inline">\(h_k(t | x_1)\)</span></p></li>
<li><p>simulate survival time <span class="math inline">\(T_i\)</span> for the <span class="math inline">\(i^\text{th}\)</span> individual with the all-cause cumulative hazard <span class="math inline">\(\sum_{k=1}^K H_k(t | x_1)\)</span></p></li>
<li><p>for a simulated <span class="math inline">\(T_i\)</span>, simulate the event type <span class="math inline">\(D_i\)</span> from a multinomial distribution with <span class="math inline">\(k\)</span>-dimensional probability vector from the scaled hazards <span class="math inline">\(h_k(t | x_1) / \sum_{k = 1}^K h_k(t | x_1)\)</span>. This gives the pair <span class="math inline">\((T_i, D_i)\)</span> for the <span class="math inline">\(i^\text{th}\)</span> individual</p></li>
<li><p>simulate censoring time <span class="math inline">\(C_i\)</span> and set <span class="math inline">\(T_i  = C_i\)</span> if <span class="math inline">\(C_i &lt; T_i\)</span> (and set <span class="math inline">\(D_i = 0\)</span>).</p></li>
</ul>
<p>The event time <span class="math inline">\(T_i\)</span> is generated by inverting the survivor function. The CDF <span class="math inline">\(F(t)\)</span> has a <span class="math inline">\(\text{Uniform}[0, 1]\)</span> distribution where <span class="math inline">\(F(t_i) = u_i \sim U[0, 1]\)</span>. We can use <span class="math inline">\(F(t) = 1 - S(t)\)</span> to equate <span class="math inline">\(S(t) = 1 - u\)</span> which gives</p>
<p><span class="math display">\[
1 - u = \text{exp}\Bigg[- \sum_{k = 1}^K H_k(t) \Bigg]
\]</span></p>
<p>Taking logs on both sides and rearranging gives the objective function</p>
<p><span class="math display">\[
\text{log}(1 - u) + \sum_{k = 1}^K H_k(t) = 0
\]</span></p>
<p>For a randomly drawn <span class="math inline">\(u_i \sim U[0,1]\)</span> (and given <span class="math inline">\(x_{i, 1}\)</span>), numerical root finding methods can be employed to estimate the value of <span class="math inline">\(t_i\)</span> which satisfies this equation. This process of using <span class="math inline">\(u_i\)</span> to estimate <span class="math inline">\(t_i\)</span> is known as <a href="https://en.wikipedia.org/wiki/Inverse_transform_sampling">inverse transform sampling</a>.</p>
<section id="overall-hazard" class="level3">
<h3 class="anchored" data-anchor-id="overall-hazard">Overall hazard</h3>
<p>This function implements the sum of the cumulative hazards <span class="math inline">\(H_k(t | x_1)\)</span> which is 0 at <span class="math inline">\(t = 0\)</span> but increases without bound beyond that</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1"></a>all_cause_cumulative_hazards <span class="ot">&lt;-</span> <span class="cf">function</span>(t, x1) {</span>
<span id="cb10-2"><a href="#cb10-2"></a>  <span class="fu">sum</span>(</span>
<span id="cb10-3"><a href="#cb10-3"></a>    <span class="fu">Hweibull</span>(<span class="at">x =</span> t, <span class="at">shape =</span> <span class="fl">1.6</span>, <span class="at">scale =</span> <span class="fu">exp</span>(<span class="fu">log</span>(<span class="dv">5</span>) <span class="sc">+</span> <span class="fu">log</span>(<span class="fl">1.4</span>) <span class="sc">*</span> x1), <span class="at">log =</span> <span class="cn">FALSE</span>),</span>
<span id="cb10-4"><a href="#cb10-4"></a>    <span class="fu">Hllogis</span>(<span class="at">x =</span> t, <span class="at">shape =</span> <span class="dv">5</span>, <span class="at">scale =</span> <span class="dv">5</span>, <span class="at">log =</span> <span class="cn">FALSE</span>),</span>
<span id="cb10-5"><a href="#cb10-5"></a>    <span class="fu">Hweibull</span>(<span class="at">x =</span> t, <span class="at">shape =</span> <span class="dv">1</span>, <span class="at">scale =</span> <span class="dv">5</span>, <span class="at">log =</span> <span class="cn">FALSE</span>)</span>
<span id="cb10-6"><a href="#cb10-6"></a>  )</span>
<span id="cb10-7"><a href="#cb10-7"></a>}</span>
<span id="cb10-8"><a href="#cb10-8"></a></span>
<span id="cb10-9"><a href="#cb10-9"></a><span class="fu">all_cause_cumulative_hazards</span>(<span class="at">t =</span> <span class="dv">0</span>, <span class="at">x1 =</span> <span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0</code></pre>
</div>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1"></a><span class="fu">all_cause_cumulative_hazards</span>(<span class="at">t =</span> <span class="dv">10</span>, <span class="at">x1 =</span> <span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 8.527941</code></pre>
</div>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1"></a><span class="fu">all_cause_cumulative_hazards</span>(<span class="at">t =</span> <span class="dv">10</span>, <span class="at">x1 =</span> <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 7.265977</code></pre>
</div>
</div>
</section>
<section id="event-type-probabilities" class="level3">
<h3 class="anchored" data-anchor-id="event-type-probabilities">Event type probabilities</h3>
<p>This next one calculates the event probabilities (conditional on an event at <span class="math inline">\(t\)</span>) <span class="math inline">\(\text{Pr}[D = k | t \le T &lt; t + \Delta t, T \ge t, x_1]\)</span> given <span class="math inline">\(t\)</span> and <span class="math inline">\(x_1\)</span></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1"></a>cause_specific_probabilities <span class="ot">&lt;-</span> <span class="cf">function</span>(t, x1) {</span>
<span id="cb16-2"><a href="#cb16-2"></a>  hazards <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb16-3"><a href="#cb16-3"></a>    <span class="fu">hweibull</span>(<span class="at">x =</span> t, <span class="at">shape =</span> <span class="fl">1.6</span>, </span>
<span id="cb16-4"><a href="#cb16-4"></a>             <span class="at">scale =</span> <span class="fu">exp</span>(<span class="fu">log</span>(<span class="dv">5</span>) <span class="sc">+</span> <span class="fu">log</span>(<span class="fl">1.4</span>) <span class="sc">*</span> x1), <span class="at">log =</span> <span class="cn">FALSE</span>),</span>
<span id="cb16-5"><a href="#cb16-5"></a>    <span class="fu">hllogis</span>(<span class="at">x =</span> t, <span class="at">shape =</span> <span class="dv">5</span>, <span class="at">scale =</span> <span class="dv">5</span>, <span class="at">log =</span> <span class="cn">FALSE</span>),</span>
<span id="cb16-6"><a href="#cb16-6"></a>    <span class="fu">hweibull</span>(<span class="at">x =</span> t, <span class="at">shape =</span> <span class="dv">1</span>, <span class="at">scale =</span> <span class="dv">5</span>, <span class="at">log =</span> <span class="cn">FALSE</span>)</span>
<span id="cb16-7"><a href="#cb16-7"></a>  )</span>
<span id="cb16-8"><a href="#cb16-8"></a></span>
<span id="cb16-9"><a href="#cb16-9"></a>  hazards <span class="sc">/</span> <span class="fu">sum</span>(hazards)</span>
<span id="cb16-10"><a href="#cb16-10"></a>}</span>
<span id="cb16-11"><a href="#cb16-11"></a></span>
<span id="cb16-12"><a href="#cb16-12"></a><span class="fu">cause_specific_probabilities</span>(<span class="at">t =</span> <span class="dv">0</span>, <span class="at">x1 =</span> <span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0 0 1</code></pre>
</div>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1"></a><span class="fu">cause_specific_probabilities</span>(<span class="at">t =</span> <span class="dv">10</span>, <span class="at">x1 =</span> <span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.4145983 0.4144437 0.1709580</code></pre>
</div>
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1"></a><span class="fu">cause_specific_probabilities</span>(<span class="at">t =</span> <span class="dv">10</span>, <span class="at">x1 =</span> <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.2924853 0.5008953 0.2066193</code></pre>
</div>
</div>
<p>The function returns a <span class="math inline">\(K\)</span>-dimensional vector which sums to 1.</p>
</section>
<section id="objective-function" class="level3">
<h3 class="anchored" data-anchor-id="objective-function">Objective function</h3>
<p>Implement the objective function</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1"></a>obj_fun <span class="ot">&lt;-</span> <span class="cf">function</span>(t, u, x1) {</span>
<span id="cb22-2"><a href="#cb22-2"></a>  <span class="fu">log</span>(<span class="dv">1</span> <span class="sc">-</span> u) <span class="sc">+</span> <span class="fu">all_cause_cumulative_hazards</span>(t, x1)</span>
<span id="cb22-3"><a href="#cb22-3"></a>}</span>
<span id="cb22-4"><a href="#cb22-4"></a></span>
<span id="cb22-5"><a href="#cb22-5"></a><span class="fu">obj_fun</span>(<span class="at">t =</span> <span class="fl">3.771</span>, <span class="at">u =</span> <span class="fl">0.8</span>, <span class="at">x1 =</span> <span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] -0.0001226652</code></pre>
</div>
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1"></a><span class="fu">tibble</span>(</span>
<span id="cb24-2"><a href="#cb24-2"></a>  <span class="at">time =</span> time_seq[time_seq <span class="sc">&lt;</span> <span class="fl">10.0</span>], </span>
<span id="cb24-3"><a href="#cb24-3"></a>  <span class="at">obj_val =</span> <span class="fu">map_dbl</span>(</span>
<span id="cb24-4"><a href="#cb24-4"></a>    <span class="at">.x =</span> time, </span>
<span id="cb24-5"><a href="#cb24-5"></a>    <span class="at">.f =</span> <span class="sc">~</span> <span class="fu">obj_fun</span>(.x, <span class="at">u =</span> <span class="fl">0.8</span>, <span class="at">x1 =</span> <span class="dv">0</span>)</span>
<span id="cb24-6"><a href="#cb24-6"></a>    )</span>
<span id="cb24-7"><a href="#cb24-7"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb24-8"><a href="#cb24-8"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> obj_val)) <span class="sc">+</span> </span>
<span id="cb24-9"><a href="#cb24-9"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span> </span>
<span id="cb24-10"><a href="#cb24-10"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">linetype =</span> <span class="st">"dotted"</span>) <span class="sc">+</span> </span>
<span id="cb24-11"><a href="#cb24-11"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="fl">3.771</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>) <span class="sc">+</span> </span>
<span id="cb24-12"><a href="#cb24-12"></a>  <span class="fu">xlab</span>(<span class="st">"Time (t)"</span>) <span class="sc">+</span> </span>
<span id="cb24-13"><a href="#cb24-13"></a>  <span class="fu">ylab</span>(<span class="st">"Objective function"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-9-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>This plot corresponding to a grid search on <span class="math inline">\(t \in (0, 10)\)</span> shows that for <span class="math inline">\(u_i = 0.8\)</span>, <span class="math inline">\(t_i \approx 3.771\)</span> (dashed vertical line) is very close to the root since the objective function evaluates to approximately -0.00012.</p>
<p>Doing grid search is kinda tedious, but we can use <code>stats::uniroot</code> to find the root <span class="math inline">\(t_i\)</span> for a given <span class="math inline">\(u_i\)</span> (and <span class="math inline">\(x_{i, 1}\)</span>) and return the pair <span class="math inline">\((T_i, D_i)\)</span>.</p>
</section>
<section id="simulate-single-outcome" class="level3">
<h3 class="anchored" data-anchor-id="simulate-single-outcome">Simulate single outcome</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1"></a>simulate_single_outcome <span class="ot">&lt;-</span> <span class="cf">function</span>(u, x1, <span class="at">admin_censor_time =</span> <span class="dv">5</span>, <span class="at">lower_bound_time =</span> <span class="fl">1e-10</span>) {</span>
<span id="cb25-2"><a href="#cb25-2"></a></span>
<span id="cb25-3"><a href="#cb25-3"></a>  <span class="co"># check whether simulated time would lie outside the time interval we want to solve for</span></span>
<span id="cb25-4"><a href="#cb25-4"></a>  <span class="co"># in this case the function would have the same sign at the interval endpoints</span></span>
<span id="cb25-5"><a href="#cb25-5"></a>  <span class="co"># if the function has different signs at the endpoints then a root is within the interval</span></span>
<span id="cb25-6"><a href="#cb25-6"></a>  same_sign <span class="ot">&lt;-</span> (<span class="fu">obj_fun</span>(<span class="at">u =</span> u, <span class="at">t =</span> <span class="fl">0.00001</span>, <span class="at">x1 =</span> x1) <span class="sc">*</span> <span class="fu">obj_fun</span>(<span class="at">u =</span> u, <span class="at">t =</span> admin_censor_time, <span class="at">x1 =</span> x1)) <span class="sc">&gt;</span> <span class="dv">0</span></span>
<span id="cb25-7"><a href="#cb25-7"></a></span>
<span id="cb25-8"><a href="#cb25-8"></a>  <span class="cf">if</span> (same_sign) {</span>
<span id="cb25-9"><a href="#cb25-9"></a>    time <span class="ot">&lt;-</span> admin_censor_time</span>
<span id="cb25-10"><a href="#cb25-10"></a>    cause <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb25-11"><a href="#cb25-11"></a>    iter <span class="ot">&lt;-</span> <span class="cn">NA_real_</span></span>
<span id="cb25-12"><a href="#cb25-12"></a>    fn_value_at_root <span class="ot">&lt;-</span> <span class="cn">NA_real_</span></span>
<span id="cb25-13"><a href="#cb25-13"></a>  } <span class="cf">else</span> {</span>
<span id="cb25-14"><a href="#cb25-14"></a>    <span class="co"># for a handful of cases (out of 100,000s) we can end up with t = 0 from a distribution that doesn't support it</span></span>
<span id="cb25-15"><a href="#cb25-15"></a>    <span class="co"># https://stats.stackexchange.com/questions/176376/invalid-survival-times-for-this-distribution</span></span>
<span id="cb25-16"><a href="#cb25-16"></a>    <span class="co"># so we can set a lower bound on time &gt; 0</span></span>
<span id="cb25-17"><a href="#cb25-17"></a>    uniroot_obj <span class="ot">&lt;-</span> <span class="fu">uniroot</span>(</span>
<span id="cb25-18"><a href="#cb25-18"></a>      <span class="at">f =</span> obj_fun, </span>
<span id="cb25-19"><a href="#cb25-19"></a>      <span class="at">interval =</span> <span class="fu">c</span>(lower_bound_time, admin_censor_time), </span>
<span id="cb25-20"><a href="#cb25-20"></a>      <span class="co"># pass arguments to the objective function</span></span>
<span id="cb25-21"><a href="#cb25-21"></a>      <span class="at">u =</span> u, <span class="at">x1 =</span> x1</span>
<span id="cb25-22"><a href="#cb25-22"></a>    )</span>
<span id="cb25-23"><a href="#cb25-23"></a>    time <span class="ot">&lt;-</span> uniroot_obj<span class="sc">$</span>root</span>
<span id="cb25-24"><a href="#cb25-24"></a>    cause <span class="ot">&lt;-</span> <span class="fu">which.max</span>(</span>
<span id="cb25-25"><a href="#cb25-25"></a>      <span class="fu">rmultinom</span>(<span class="dv">1</span>, <span class="dv">1</span>, <span class="fu">cause_specific_probabilities</span>(<span class="at">t =</span> time, <span class="at">x1 =</span> x1))</span>
<span id="cb25-26"><a href="#cb25-26"></a>    )</span>
<span id="cb25-27"><a href="#cb25-27"></a>    iter <span class="ot">&lt;-</span> uniroot_obj<span class="sc">$</span>iter</span>
<span id="cb25-28"><a href="#cb25-28"></a>    fn_value_at_root <span class="ot">&lt;-</span> uniroot_obj<span class="sc">$</span>f.root</span>
<span id="cb25-29"><a href="#cb25-29"></a>  }</span>
<span id="cb25-30"><a href="#cb25-30"></a></span>
<span id="cb25-31"><a href="#cb25-31"></a>  <span class="fu">tibble</span>(u, x1, admin_censor_time, iter, fn_value_at_root, time, cause)</span>
<span id="cb25-32"><a href="#cb25-32"></a>}</span>
<span id="cb25-33"><a href="#cb25-33"></a></span>
<span id="cb25-34"><a href="#cb25-34"></a><span class="fu">bind_rows</span>(</span>
<span id="cb25-35"><a href="#cb25-35"></a>  <span class="co"># non-censored</span></span>
<span id="cb25-36"><a href="#cb25-36"></a>  <span class="fu">simulate_single_outcome</span>(<span class="at">u =</span> <span class="fl">0.2</span>, <span class="at">x1 =</span> <span class="dv">1</span>, <span class="at">admin_censor_time =</span> <span class="dv">5</span>),</span>
<span id="cb25-37"><a href="#cb25-37"></a>  <span class="co"># censored</span></span>
<span id="cb25-38"><a href="#cb25-38"></a>  <span class="fu">simulate_single_outcome</span>(<span class="at">u =</span> <span class="fl">0.95</span>, <span class="at">x1 =</span> <span class="dv">1</span>, <span class="at">admin_censor_time =</span> <span class="dv">5</span>),</span>
<span id="cb25-39"><a href="#cb25-39"></a>  <span class="co"># same u but larger admin censored time means not censored</span></span>
<span id="cb25-40"><a href="#cb25-40"></a>  <span class="fu">simulate_single_outcome</span>(<span class="at">u =</span> <span class="fl">0.95</span>, <span class="at">x1 =</span> <span class="dv">1</span>, <span class="at">admin_censor_time =</span> <span class="dv">12</span>)</span>
<span id="cb25-41"><a href="#cb25-41"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3 × 7
      u    x1 admin_censor_time  iter fn_value_at_root  time cause
  &lt;dbl&gt; &lt;dbl&gt;             &lt;dbl&gt; &lt;dbl&gt;            &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
1  0.2      1                 5     6     -0.00000118  0.920     3
2  0.95     1                 5    NA     NA           5         0
3  0.95     1                12     7     -0.000000103 5.76      2</code></pre>
</div>
</div>
<p>A lower bound of <span class="math inline">\(t\)</span> close to 0 is applied to avoid ending up with estimates of exactly 0, which can cause problems with estimation for some parametric distributions. If the drawn <span class="math inline">\(u_i\)</span> is large enough that the objective function has the same sign at both endpoints of the interval, then we skip the root finding as that observation would be treated as censored anyway.</p>
<p>Administrative censoring at <span class="math inline">\(t = 5\)</span> is assumed, which should lead to about 7% censored individuals in <span class="math inline">\(x_1 = 0\)</span> and 10% in <span class="math inline">\(x_1 = 1\)</span> (and about 8-9% overall) as seen in this zoomed-in version of the CIF plot (from a few sections above)</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1"></a>cumulative_incidence_curves_plot <span class="sc">+</span> </span>
<span id="cb27-2"><a href="#cb27-2"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="fl">5.0</span>, <span class="at">color =</span> <span class="st">"forestgreen"</span>) <span class="sc">+</span></span>
<span id="cb27-3"><a href="#cb27-3"></a>  <span class="fu">geom_hline</span>(</span>
<span id="cb27-4"><a href="#cb27-4"></a>    <span class="at">data =</span> <span class="fu">tibble</span>(<span class="at">Group =</span> <span class="fu">c</span>(<span class="st">"x1 = 0"</span>, <span class="st">"x1 = 1"</span>), <span class="at">y =</span> <span class="fu">c</span>(<span class="fl">0.068</span>, <span class="fl">0.102</span>)),</span>
<span id="cb27-5"><a href="#cb27-5"></a>    <span class="fu">aes</span>(<span class="at">yintercept =</span> y), <span class="at">color =</span> <span class="st">"purple"</span></span>
<span id="cb27-6"><a href="#cb27-6"></a>  ) <span class="sc">+</span></span>
<span id="cb27-7"><a href="#cb27-7"></a>  <span class="fu">coord_cartesian</span>(<span class="at">xlim =</span> <span class="fu">c</span>(<span class="fl">4.5</span>, <span class="dv">6</span>), <span class="at">ylim =</span> <span class="fu">c</span>(<span class="fl">0.05</span>, <span class="fl">0.12</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-11-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="simulate-single-dataset" class="level3">
<h3 class="anchored" data-anchor-id="simulate-single-dataset">Simulate single dataset</h3>
<p>Finally, the next function stitches together the steps for simulating a full dataset with <span class="math inline">\(n = 1,000\)</span> individuals and their group indicator <span class="math inline">\(x_{i, 1} \in \{0, 1\}\)</span>, event time <span class="math inline">\(T_i\)</span>, and event indicator <span class="math inline">\(D_i \in \{0, 1, 2, 3\}\)</span>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1"></a>simulate_single_dataset <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">n_rows =</span> <span class="dv">1000</span>, <span class="at">prop_x1 =</span> <span class="fl">0.5</span>, <span class="at">seed =</span> <span class="dv">12345</span>) {</span>
<span id="cb28-2"><a href="#cb28-2"></a>  <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.null</span>(seed)) <span class="fu">set.seed</span>(seed)</span>
<span id="cb28-3"><a href="#cb28-3"></a>  x1 <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(<span class="at">n =</span> n_rows, <span class="at">size =</span> <span class="dv">1</span>, <span class="at">prob =</span> prop_x1)</span>
<span id="cb28-4"><a href="#cb28-4"></a>  u <span class="ot">&lt;-</span> <span class="fu">runif</span>(n_rows)</span>
<span id="cb28-5"><a href="#cb28-5"></a>  <span class="dv">1</span><span class="sc">:</span>n_rows <span class="sc">%&gt;%</span> </span>
<span id="cb28-6"><a href="#cb28-6"></a>    <span class="fu">map</span>(<span class="at">.f =</span> <span class="sc">~</span> <span class="fu">simulate_single_outcome</span>(<span class="at">u =</span> u[.x], <span class="at">x1 =</span> x1[.x])) <span class="sc">%&gt;%</span></span>
<span id="cb28-7"><a href="#cb28-7"></a>    <span class="fu">list_rbind</span>()</span>
<span id="cb28-8"><a href="#cb28-8"></a>}</span>
<span id="cb28-9"><a href="#cb28-9"></a></span>
<span id="cb28-10"><a href="#cb28-10"></a><span class="fu">simulate_single_dataset</span>(<span class="at">n_rows =</span> <span class="dv">5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 5 × 7
      u    x1 admin_censor_time  iter fn_value_at_root  time cause
  &lt;dbl&gt; &lt;int&gt;             &lt;dbl&gt; &lt;dbl&gt;            &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
1 0.166     1                 5     6     -0.00000122  0.765     3
2 0.325     1                 5     5     -0.000000279 1.52      1
3 0.509     1                 5     6     -0.00000489  2.47      3
4 0.728     1                 5     6     -0.000000505 3.70      2
5 0.990     0                 5    NA     NA           5         0</code></pre>
</div>
</div>
</section>
</section>
<section id="test-the-implementation" class="level2">
<h2 class="anchored" data-anchor-id="test-the-implementation">Test the implementation</h2>
<section id="parameter-estimates" class="level3">
<h3 class="anchored" data-anchor-id="parameter-estimates">Parameter estimates</h3>
<p>To check that the simulation function works, a bunch of functions are defined in the next code chunk that take a single simulated dataset, convert it into cause-specific datasets (for each event type <span class="math inline">\(k\)</span>, update the event indicator by censoring competing events), fit a (correctly specified) parametric model separately to each cause-specific dataset, extract the coefficients from each model, and return them as a data frame.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1"></a>create_cause_specific_datasets <span class="ot">&lt;-</span> <span class="cf">function</span>(data) {</span>
<span id="cb30-2"><a href="#cb30-2"></a>  <span class="fu">map</span>(</span>
<span id="cb30-3"><a href="#cb30-3"></a>    <span class="at">.x =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>,</span>
<span id="cb30-4"><a href="#cb30-4"></a>    <span class="at">.f =</span> <span class="sc">~</span> {</span>
<span id="cb30-5"><a href="#cb30-5"></a>      data <span class="sc">%&gt;%</span></span>
<span id="cb30-6"><a href="#cb30-6"></a>        <span class="fu">select</span>(x1, time, cause) <span class="sc">%&gt;%</span></span>
<span id="cb30-7"><a href="#cb30-7"></a>        <span class="fu">mutate</span>(<span class="at">event =</span> <span class="fu">as.numeric</span>(cause <span class="sc">==</span> .x))</span>
<span id="cb30-8"><a href="#cb30-8"></a>    }</span>
<span id="cb30-9"><a href="#cb30-9"></a>  )</span>
<span id="cb30-10"><a href="#cb30-10"></a>}</span>
<span id="cb30-11"><a href="#cb30-11"></a></span>
<span id="cb30-12"><a href="#cb30-12"></a>fit_cause_specific_models <span class="ot">&lt;-</span> <span class="cf">function</span>(cause_specific_datasets, <span class="at">distributions =</span> <span class="fu">c</span>(<span class="st">"weibull"</span>, <span class="st">"llogis"</span>, <span class="st">"weibull"</span>)) {</span>
<span id="cb30-13"><a href="#cb30-13"></a>  <span class="fu">map2</span>(</span>
<span id="cb30-14"><a href="#cb30-14"></a>    <span class="at">.x =</span> cause_specific_datasets,</span>
<span id="cb30-15"><a href="#cb30-15"></a>    <span class="at">.y =</span> distributions,</span>
<span id="cb30-16"><a href="#cb30-16"></a>    <span class="at">.f =</span> <span class="sc">~</span> <span class="fu">flexsurvreg</span>(<span class="fu">Surv</span>(<span class="at">time =</span> time, <span class="at">event =</span> event) <span class="sc">~</span> x1, <span class="at">data =</span> .x, <span class="at">dist =</span> .y)</span>
<span id="cb30-17"><a href="#cb30-17"></a>  )</span>
<span id="cb30-18"><a href="#cb30-18"></a>}</span>
<span id="cb30-19"><a href="#cb30-19"></a></span>
<span id="cb30-20"><a href="#cb30-20"></a>extract_coefs <span class="ot">&lt;-</span> <span class="cf">function</span>(list_models) {</span>
<span id="cb30-21"><a href="#cb30-21"></a>  <span class="fu">map2_dfr</span>(<span class="at">.x =</span> list_models, <span class="at">.y =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(list_models), <span class="at">.f =</span> <span class="sc">~</span> {</span>
<span id="cb30-22"><a href="#cb30-22"></a>    .x <span class="sc">%&gt;%</span></span>
<span id="cb30-23"><a href="#cb30-23"></a>      <span class="co"># calls flexsurv:::tidy.flexsurvreg()</span></span>
<span id="cb30-24"><a href="#cb30-24"></a>      flexsurv<span class="sc">::</span><span class="fu">tidy</span>() <span class="sc">%&gt;%</span></span>
<span id="cb30-25"><a href="#cb30-25"></a>      <span class="fu">select</span>(term, estimate, <span class="at">se =</span> std.error) <span class="sc">%&gt;%</span></span>
<span id="cb30-26"><a href="#cb30-26"></a>      <span class="fu">mutate</span>(<span class="at">cause =</span> .y, <span class="at">.before =</span> term)</span>
<span id="cb30-27"><a href="#cb30-27"></a>  })</span>
<span id="cb30-28"><a href="#cb30-28"></a>}</span>
<span id="cb30-29"><a href="#cb30-29"></a></span>
<span id="cb30-30"><a href="#cb30-30"></a>run_pipeline <span class="ot">&lt;-</span> <span class="cf">function</span>(seed) {</span>
<span id="cb30-31"><a href="#cb30-31"></a>  seed <span class="sc">%&gt;%</span></span>
<span id="cb30-32"><a href="#cb30-32"></a>    <span class="fu">simulate_single_dataset</span>(<span class="at">seed =</span> .) <span class="sc">%&gt;%</span></span>
<span id="cb30-33"><a href="#cb30-33"></a>    <span class="fu">create_cause_specific_datasets</span>() <span class="sc">%&gt;%</span></span>
<span id="cb30-34"><a href="#cb30-34"></a>    <span class="fu">fit_cause_specific_models</span>() <span class="sc">%&gt;%</span></span>
<span id="cb30-35"><a href="#cb30-35"></a>    <span class="fu">extract_coefs</span>() <span class="sc">%&gt;%</span></span>
<span id="cb30-36"><a href="#cb30-36"></a>    <span class="fu">mutate</span>(<span class="at">rep =</span> seed, <span class="at">.before =</span> cause)</span>
<span id="cb30-37"><a href="#cb30-37"></a>}</span>
<span id="cb30-38"><a href="#cb30-38"></a></span>
<span id="cb30-39"><a href="#cb30-39"></a><span class="co"># wrap it up into purrr::safely() since it fails </span></span>
<span id="cb30-40"><a href="#cb30-40"></a><span class="co"># for some seeds (e.g. 125)</span></span>
<span id="cb30-41"><a href="#cb30-41"></a>safely_run_pipeline <span class="ot">&lt;-</span> <span class="fu">safely</span>(run_pipeline)</span>
<span id="cb30-42"><a href="#cb30-42"></a></span>
<span id="cb30-43"><a href="#cb30-43"></a><span class="fu">safely_run_pipeline</span>(<span class="at">seed =</span> <span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$result
# A tibble: 9 × 5
    rep cause term  estimate     se
  &lt;dbl&gt; &lt;int&gt; &lt;chr&gt;    &lt;dbl&gt;  &lt;dbl&gt;
1     3     1 shape   1.66   0.0801
2     3     1 scale   4.93   0.246 
3     3     1 x1      0.297  0.0724
4     3     2 shape   5.50   0.359 
5     3     2 scale   4.88   0.153 
6     3     2 x1      0.0281 0.0391
7     3     3 shape   1.07   0.0418
8     3     3 scale   4.99   0.333 
9     3     3 x1     -0.0972 0.0851

$error
NULL</code></pre>
</div>
</div>
<p>The <code>safely_run_pipeline()</code> function returns the point estimates and standard errors for the shape, scale, and coefficient for <span class="math inline">\(x_1\)</span> from each cause-specific model.</p>
<p>This process is repeated 5,000 times. A single run takes about 1.6 seconds on my machine, so to save time, the runs are parallelized. Using the recently added <code>purrr::in_parallel</code> function cuts down the total execution time from a little over 2 hours to about 20 minutes (it still took 3x longer than I expected, so I’d like to look into that later — overhead is expected from parallelization but not 3x. Maybe it would have been better to use fewer cores.).</p>
<p>Using the version of <code>purrr</code> at the time of writing, <code>in_parallel</code> requires that all these functions defined above are nested into one big function which can then be shipped off to the executors. All the package functions should be explicitly namespaced via <code>package::fun()</code> as well. The full script for running this pipeline is <a href="https://github.com/ad1729/ad1729.github.io/tree/master/posts/simulating-and-modelling-competing-risk-data/nested-simulation-functions-for-parallel-run.R">here</a>.</p>
<p>Saved results can be read back in. About 44 or 0.9% of the simulations (with the following seeds) failed at some step.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1"></a>n_reps <span class="ot">&lt;-</span> <span class="dv">5000</span></span>
<span id="cb32-2"><a href="#cb32-2"></a>failed_parallel_runs <span class="ot">&lt;-</span> <span class="fu">read_rds</span>(<span class="st">"saved_objects/failed_parallel_runs.rds"</span>)</span>
<span id="cb32-3"><a href="#cb32-3"></a>failed_parallel_runs</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code> [1]    5   39  124  125  315  319  445  510  662  672  765 1058 1105 1238 1494
[16] 1673 1832 1844 2152 2176 2277 2399 2521 2526 2888 2944 2995 3065 3574 3657
[31] 3754 3818 4222 4234 4246 4259 4326 4414 4465 4481 4482 4742 4873 4978</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1"></a><span class="fu">length</span>(failed_parallel_runs) <span class="sc">/</span> n_reps</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.0088</code></pre>
</div>
</div>
<p>For the seeds that ran without error, the estimates can be plotted with the true parameter values overlaid for comparison. No transformation is needed when using <code>flexsurv:::tidy.flexsurvreg()</code> (except for the <span class="math inline">\(x_1\)</span> coefficient which is reported on the log scale)</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1"></a>true_params <span class="ot">&lt;-</span> <span class="fu">tribble</span>(</span>
<span id="cb36-2"><a href="#cb36-2"></a>  <span class="sc">~</span> cause, <span class="sc">~</span> term, <span class="sc">~</span> estimate,</span>
<span id="cb36-3"><a href="#cb36-3"></a>  <span class="dv">1</span>L, <span class="st">"shape"</span>, <span class="fl">1.6</span>,</span>
<span id="cb36-4"><a href="#cb36-4"></a>  <span class="dv">1</span>L, <span class="st">"scale"</span>, <span class="dv">5</span>,</span>
<span id="cb36-5"><a href="#cb36-5"></a>  <span class="dv">1</span>L, <span class="st">"x1"</span>, <span class="fu">log</span>(<span class="fl">1.4</span>),</span>
<span id="cb36-6"><a href="#cb36-6"></a>  <span class="dv">2</span>L, <span class="st">"shape"</span>, <span class="dv">5</span>,</span>
<span id="cb36-7"><a href="#cb36-7"></a>  <span class="dv">2</span>L, <span class="st">"scale"</span>, <span class="dv">5</span>,</span>
<span id="cb36-8"><a href="#cb36-8"></a>  <span class="dv">2</span>L, <span class="st">"x1"</span>, <span class="dv">0</span>,</span>
<span id="cb36-9"><a href="#cb36-9"></a>  <span class="dv">3</span>L, <span class="st">"shape"</span>, <span class="dv">1</span>,</span>
<span id="cb36-10"><a href="#cb36-10"></a>  <span class="dv">3</span>L, <span class="st">"scale"</span>, <span class="dv">5</span>,</span>
<span id="cb36-11"><a href="#cb36-11"></a>  <span class="dv">3</span>L, <span class="st">"x1"</span>, <span class="dv">0</span></span>
<span id="cb36-12"><a href="#cb36-12"></a>)</span>
<span id="cb36-13"><a href="#cb36-13"></a></span>
<span id="cb36-14"><a href="#cb36-14"></a>parameter_estimates_parallel <span class="ot">&lt;-</span> <span class="fu">read_rds</span>(<span class="st">"saved_objects/parameter_estimates_parallel.rds"</span>)</span>
<span id="cb36-15"><a href="#cb36-15"></a></span>
<span id="cb36-16"><a href="#cb36-16"></a>parameter_estimates_parallel <span class="sc">%&gt;%</span> </span>
<span id="cb36-17"><a href="#cb36-17"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> estimate, <span class="at">group =</span> <span class="fu">interaction</span>(cause, term))) <span class="sc">+</span></span>
<span id="cb36-18"><a href="#cb36-18"></a>  <span class="fu">geom_density</span>() <span class="sc">+</span></span>
<span id="cb36-19"><a href="#cb36-19"></a>  <span class="fu">geom_vline</span>(<span class="at">data =</span> true_params, <span class="fu">aes</span>(<span class="at">xintercept =</span> estimate)) <span class="sc">+</span></span>
<span id="cb36-20"><a href="#cb36-20"></a>  <span class="fu">xlab</span>(glue<span class="sc">::</span><span class="fu">glue</span>(<span class="st">"Sampling distribution of simulation parameters "</span>, </span>
<span id="cb36-21"><a href="#cb36-21"></a>                  <span class="st">"(5,000 datasets with n = 1,000)"</span>)) <span class="sc">+</span></span>
<span id="cb36-22"><a href="#cb36-22"></a>  ggh4x<span class="sc">::</span><span class="fu">facet_grid2</span>(<span class="at">rows =</span> <span class="fu">vars</span>(cause), <span class="at">cols =</span> <span class="fu">vars</span>(term), </span>
<span id="cb36-23"><a href="#cb36-23"></a>                     <span class="at">scales =</span> <span class="st">"free"</span>, <span class="at">independent =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb36-24"><a href="#cb36-24"></a>  <span class="fu">theme_classic</span>() <span class="sc">+</span> </span>
<span id="cb36-25"><a href="#cb36-25"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"bottom"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-15-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>It’s reassuring but not surprising, given the ubiquity of this approach to CSH CR analysis, to see the density estimates centered at the true values indicating unbiasedness of the CSH approach.</p>
</section>
<section id="cif-estimates" class="level3">
<h3 class="anchored" data-anchor-id="cif-estimates">CIF estimates</h3>
<p>Since the parameters are estimated correctly, any downstream quantities like the cause-specific CIFs and overall survival should be unbiased too. In the next figure, I’m visualizing these for the four states within <span class="math inline">\(x_1 = 0\)</span>. The true curves and the average of 100 curves from randomly simulated datasets (restricted to <span class="math inline">\(t \in (0, 10]\)</span>) are pretty close</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1"></a>sampling_distribution_CIFs <span class="ot">&lt;-</span> <span class="fu">read_rds</span>(<span class="st">"saved_objects/sampling_distribution_CIFs.rds"</span>)</span>
<span id="cb37-2"><a href="#cb37-2"></a></span>
<span id="cb37-3"><a href="#cb37-3"></a>sampling_distribution_CIFs_mean <span class="ot">&lt;-</span> sampling_distribution_CIFs <span class="sc">%&gt;%</span></span>
<span id="cb37-4"><a href="#cb37-4"></a>  <span class="fu">summarise</span>(<span class="at">CIF =</span> <span class="fu">mean</span>(CIF), <span class="at">.by =</span> <span class="fu">c</span>(Event, time))</span>
<span id="cb37-5"><a href="#cb37-5"></a></span>
<span id="cb37-6"><a href="#cb37-6"></a>sampling_distribution_CIFs <span class="sc">%&gt;%</span></span>
<span id="cb37-7"><a href="#cb37-7"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> CIF, <span class="at">group =</span> rep)) <span class="sc">+</span></span>
<span id="cb37-8"><a href="#cb37-8"></a>  <span class="fu">geom_line</span>(<span class="at">color =</span> <span class="st">"gray80"</span>) <span class="sc">+</span></span>
<span id="cb37-9"><a href="#cb37-9"></a>  <span class="fu">geom_line</span>(</span>
<span id="cb37-10"><a href="#cb37-10"></a>    <span class="at">data =</span> cumulative_incidence_curves_plot_data <span class="sc">%&gt;%</span></span>
<span id="cb37-11"><a href="#cb37-11"></a>    <span class="fu">filter</span>(Group <span class="sc">==</span> <span class="st">"x1 = 0"</span>, time <span class="sc">&lt;=</span> <span class="fl">10.0</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb37-12"><a href="#cb37-12"></a>    <span class="fu">mutate</span>(<span class="at">Event =</span> <span class="fu">fct_relevel</span>(<span class="fu">factor</span>(Event), <span class="st">"Event-free"</span>, <span class="at">after =</span> <span class="dv">0</span>)),</span>
<span id="cb37-13"><a href="#cb37-13"></a>    <span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> CIF),</span>
<span id="cb37-14"><a href="#cb37-14"></a>    <span class="at">color =</span> <span class="st">"gray20"</span>, <span class="at">linewidth =</span> <span class="fl">1.5</span>,</span>
<span id="cb37-15"><a href="#cb37-15"></a>    <span class="at">inherit.aes =</span> <span class="cn">FALSE</span></span>
<span id="cb37-16"><a href="#cb37-16"></a>  ) <span class="sc">+</span></span>
<span id="cb37-17"><a href="#cb37-17"></a>  <span class="fu">geom_line</span>(</span>
<span id="cb37-18"><a href="#cb37-18"></a>    <span class="at">data =</span> sampling_distribution_CIFs_mean,</span>
<span id="cb37-19"><a href="#cb37-19"></a>    <span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> CIF),</span>
<span id="cb37-20"><a href="#cb37-20"></a>    <span class="at">color =</span> <span class="st">"gray20"</span>, <span class="at">linewidth =</span> <span class="fl">1.5</span>, <span class="at">linetype =</span> <span class="st">"dotted"</span>,</span>
<span id="cb37-21"><a href="#cb37-21"></a>    <span class="at">inherit.aes =</span> <span class="cn">FALSE</span></span>
<span id="cb37-22"><a href="#cb37-22"></a>  ) <span class="sc">+</span></span>
<span id="cb37-23"><a href="#cb37-23"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="dv">5</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"gray20"</span>) <span class="sc">+</span></span>
<span id="cb37-24"><a href="#cb37-24"></a>  <span class="fu">xlab</span>(glue<span class="sc">::</span><span class="fu">glue</span>(<span class="st">"Time (t)</span><span class="sc">\n</span><span class="st">Sampling distribution of curves "</span>, </span>
<span id="cb37-25"><a href="#cb37-25"></a>                  <span class="st">"estimated from 100 datasets with "</span>, </span>
<span id="cb37-26"><a href="#cb37-26"></a>                  <span class="st">"n = 1,000 (light gray); </span><span class="sc">\n</span><span class="st">true curve "</span>, </span>
<span id="cb37-27"><a href="#cb37-27"></a>                  <span class="st">"(gray, solid); averaged curve (gray, dotted);"</span>,</span>
<span id="cb37-28"><a href="#cb37-28"></a>                  <span class="st">"</span><span class="sc">\n</span><span class="st">maximum observed time (gray, dashed)"</span>)) <span class="sc">+</span></span>
<span id="cb37-29"><a href="#cb37-29"></a>  <span class="fu">ylab</span>(<span class="st">"Probability of being in state"</span>) <span class="sc">+</span></span>
<span id="cb37-30"><a href="#cb37-30"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> Event, <span class="at">scales =</span> <span class="st">"free_y"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-16-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Intuitively, the variability (or lack of) boils down to the number of events of each type <span class="math inline">\(k\)</span>. Events that are more likely to occur first (in this case <span class="math inline">\(k=3\)</span>) will have more events and more precise estimates. The estimate for <span class="math inline">\(S(t|x_1 = 0)\)</span> is the most precise here (all the gray lines are very close to the black line) because it uses information on all the events.</p>
<p>Each individual curve is produced using this function</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1"></a>estimate_CIF <span class="ot">&lt;-</span> <span class="cf">function</span>(seed, time_seq, <span class="at">covariate_level =</span> <span class="fu">data.frame</span>(<span class="at">x1 =</span> <span class="dv">0</span>)) {</span>
<span id="cb38-2"><a href="#cb38-2"></a>  list_models <span class="ot">&lt;-</span> seed <span class="sc">%&gt;%</span></span>
<span id="cb38-3"><a href="#cb38-3"></a>    <span class="fu">simulate_single_dataset</span>(<span class="at">seed =</span> .) <span class="sc">%&gt;%</span></span>
<span id="cb38-4"><a href="#cb38-4"></a>    <span class="fu">create_cause_specific_datasets</span>() <span class="sc">%&gt;%</span></span>
<span id="cb38-5"><a href="#cb38-5"></a>    <span class="fu">fit_cause_specific_models</span>()</span>
<span id="cb38-6"><a href="#cb38-6"></a></span>
<span id="cb38-7"><a href="#cb38-7"></a>  transition_matrix <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="at">data =</span> <span class="fu">c</span>(<span class="fu">c</span>(<span class="cn">NA</span>, <span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>), <span class="fu">rep</span>(<span class="cn">NA</span>, <span class="dv">12</span>)), </span>
<span id="cb38-8"><a href="#cb38-8"></a>                              <span class="at">nrow =</span> <span class="dv">4</span>, <span class="at">ncol =</span> <span class="dv">4</span>, <span class="at">byrow =</span> <span class="cn">TRUE</span>)</span>
<span id="cb38-9"><a href="#cb38-9"></a></span>
<span id="cb38-10"><a href="#cb38-10"></a>  multi_state_object <span class="ot">&lt;-</span> <span class="fu">fmsm</span>(list_models[[<span class="dv">1</span>]], </span>
<span id="cb38-11"><a href="#cb38-11"></a>                             list_models[[<span class="dv">2</span>]], </span>
<span id="cb38-12"><a href="#cb38-12"></a>                             list_models[[<span class="dv">3</span>]], </span>
<span id="cb38-13"><a href="#cb38-13"></a>                             <span class="at">trans =</span> transition_matrix)</span>
<span id="cb38-14"><a href="#cb38-14"></a></span>
<span id="cb38-15"><a href="#cb38-15"></a>  multi_state_object <span class="sc">%&gt;%</span> </span>
<span id="cb38-16"><a href="#cb38-16"></a>    <span class="fu">pmatrix.fs</span>(</span>
<span id="cb38-17"><a href="#cb38-17"></a>      <span class="at">trans =</span> transition_matrix, <span class="at">t =</span> time_seq, </span>
<span id="cb38-18"><a href="#cb38-18"></a>      <span class="at">newdata =</span> covariate_level, <span class="at">tidy =</span> <span class="cn">TRUE</span></span>
<span id="cb38-19"><a href="#cb38-19"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb38-20"><a href="#cb38-20"></a>    <span class="fu">as_tibble</span>() <span class="sc">%&gt;%</span></span>
<span id="cb38-21"><a href="#cb38-21"></a>    <span class="fu">filter</span>(start <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb38-22"><a href="#cb38-22"></a>    <span class="fu">select</span>(<span class="sc">-</span>start) <span class="sc">%&gt;%</span></span>
<span id="cb38-23"><a href="#cb38-23"></a>    <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="sc">-</span>time, <span class="at">names_to =</span> <span class="st">"Distribution"</span>, <span class="at">values_to =</span> <span class="st">"CIF"</span>)</span>
<span id="cb38-24"><a href="#cb38-24"></a>}</span>
<span id="cb38-25"><a href="#cb38-25"></a></span>
<span id="cb38-26"><a href="#cb38-26"></a>safely_estimate_CIF <span class="ot">&lt;-</span> <span class="fu">safely</span>(estimate_CIF)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>and the next code runs the pipeline for producing these 100 CIF estimates</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1"></a>time_seq_subset <span class="ot">&lt;-</span> time_seq <span class="sc">%&gt;%</span> </span>
<span id="cb39-2"><a href="#cb39-2"></a>  <span class="fu">keep</span>(<span class="at">.p =</span> <span class="sc">~</span> .x <span class="sc">&lt;=</span> <span class="fl">10.0</span>)</span>
<span id="cb39-3"><a href="#cb39-3"></a></span>
<span id="cb39-4"><a href="#cb39-4"></a>sampling_distribution_CIFs <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">100</span> <span class="sc">%&gt;%</span></span>
<span id="cb39-5"><a href="#cb39-5"></a>  <span class="fu">map</span>(</span>
<span id="cb39-6"><a href="#cb39-6"></a>    <span class="at">.f =</span> <span class="sc">~</span> {</span>
<span id="cb39-7"><a href="#cb39-7"></a>      <span class="fu">print</span>(glue<span class="sc">::</span><span class="fu">glue</span>(<span class="st">"rep: {.x}"</span>))</span>
<span id="cb39-8"><a href="#cb39-8"></a>      <span class="fu">safely_estimate_CIF</span>(</span>
<span id="cb39-9"><a href="#cb39-9"></a>        <span class="at">seed =</span> .x, </span>
<span id="cb39-10"><a href="#cb39-10"></a>        <span class="at">time_seq =</span> time_seq_subset, </span>
<span id="cb39-11"><a href="#cb39-11"></a>        <span class="at">covariate_level =</span> <span class="fu">data.frame</span>(<span class="at">x1 =</span> <span class="dv">0</span>)</span>
<span id="cb39-12"><a href="#cb39-12"></a>      )</span>
<span id="cb39-13"><a href="#cb39-13"></a>    }</span>
<span id="cb39-14"><a href="#cb39-14"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb39-15"><a href="#cb39-15"></a>  <span class="co"># remove the seeds where the estimation failed</span></span>
<span id="cb39-16"><a href="#cb39-16"></a>  <span class="fu">imap</span>(</span>
<span id="cb39-17"><a href="#cb39-17"></a>    <span class="at">.f =</span> <span class="sc">~</span> {</span>
<span id="cb39-18"><a href="#cb39-18"></a>      res <span class="ot">&lt;-</span> <span class="fu">pluck</span>(.x, <span class="st">"result"</span>)</span>
<span id="cb39-19"><a href="#cb39-19"></a>      <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(res)) {</span>
<span id="cb39-20"><a href="#cb39-20"></a>        res <span class="sc">%&gt;%</span></span>
<span id="cb39-21"><a href="#cb39-21"></a>          <span class="fu">mutate</span>(<span class="at">rep =</span> .y, <span class="at">.before =</span> time)</span>
<span id="cb39-22"><a href="#cb39-22"></a>      } <span class="cf">else</span> {</span>
<span id="cb39-23"><a href="#cb39-23"></a>        res</span>
<span id="cb39-24"><a href="#cb39-24"></a>      }</span>
<span id="cb39-25"><a href="#cb39-25"></a>    }</span>
<span id="cb39-26"><a href="#cb39-26"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb39-27"><a href="#cb39-27"></a>  <span class="fu">compact</span>() <span class="sc">%&gt;%</span></span>
<span id="cb39-28"><a href="#cb39-28"></a>  <span class="fu">list_rbind</span>() <span class="sc">%&gt;%</span></span>
<span id="cb39-29"><a href="#cb39-29"></a>  <span class="fu">mutate</span>(</span>
<span id="cb39-30"><a href="#cb39-30"></a>    <span class="at">Event =</span> <span class="fu">case_when</span>(</span>
<span id="cb39-31"><a href="#cb39-31"></a>      Distribution <span class="sc">==</span> <span class="st">"V1"</span> <span class="sc">~</span> <span class="st">"Event-free"</span>,</span>
<span id="cb39-32"><a href="#cb39-32"></a>      Distribution <span class="sc">==</span> <span class="st">"V2"</span> <span class="sc">~</span> <span class="st">"Weibull(shape = 1.6, scale = 5)"</span>,</span>
<span id="cb39-33"><a href="#cb39-33"></a>      Distribution <span class="sc">==</span> <span class="st">"V3"</span> <span class="sc">~</span> <span class="st">"Log-logistic(shape = 5, scale = 5)"</span>,</span>
<span id="cb39-34"><a href="#cb39-34"></a>      Distribution <span class="sc">==</span> <span class="st">"V4"</span> <span class="sc">~</span> <span class="st">"Exponential(rate = 5)"</span></span>
<span id="cb39-35"><a href="#cb39-35"></a>    )</span>
<span id="cb39-36"><a href="#cb39-36"></a>  )</span>
<span id="cb39-37"><a href="#cb39-37"></a></span>
<span id="cb39-38"><a href="#cb39-38"></a><span class="co"># write_rds(sampling_distribution_CIFs, "saved_objects/sampling_distribution_CIFs.rds")</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
</section>
<section id="comparison-with-survsimcrisk.ncens.sim" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="comparison-with-survsimcrisk.ncens.sim">Comparison with <code>survsim::crisk.ncens.sim</code></h2>
<p>I initially started on this project by attempting to use the function from <code>survsim</code>, but I was getting very different results from fitting the models using <code>flexsurv</code>. It was also taking quite long (~6x longer) to produce simulated datasets mostly because of me picking simulation parameters without giving it much thought<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a>. Thinking through the process in detail is what led to this post being much longer than anticipated. This section compares the parameterizations for the hazard functions and simulated draws from <code>survsim</code> and <code>flexsurv</code>.</p>
<div class="no-row-height column-margin column-container"><p><sup>1</sup>&nbsp;I picked a large value for administrative censoring, which meant that <code>uniroot</code> would take much longer to run due to increased number of iterations to converge to the root, and increased time due to multiple <code>integrate()</code> calls.</p></div><section id="converting-flexsurv-parameterization-to-survsim" class="level3">
<h3 class="anchored" data-anchor-id="converting-flexsurv-parameterization-to-survsim">Converting <code>flexsurv</code> parameterization to <code>survsim</code></h3>
<p>The hazard function code for Weibull and log-logistic is taken from <code>survsim:::crisk.ncens.sim()</code> <a href="https://github.com/cran/survsim/blob/6e1bf878cf3e35b37d6cb7d1ef4b0179ed99b1d3/R/crisk.ncens.sim.R#L85-L104">here</a></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1"></a><span class="co"># code from survsim::crisk.ncens.sim()</span></span>
<span id="cb40-2"><a href="#cb40-2"></a><span class="co">#</span></span>
<span id="cb40-3"><a href="#cb40-3"></a><span class="cf">if</span> (dist.ev[k] <span class="sc">==</span> <span class="st">"llogistic"</span>) {</span>
<span id="cb40-4"><a href="#cb40-4"></a>  a.ev[k] <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">/</span><span class="fu">exp</span>(beta0.ev[k] <span class="sc">+</span> suma[k])</span>
<span id="cb40-5"><a href="#cb40-5"></a>  b.ev[k] <span class="ot">&lt;-</span> anc.ev[k]</span>
<span id="cb40-6"><a href="#cb40-6"></a>  cshaz[[k]] <span class="ot">&lt;-</span> <span class="cf">function</span>(t, r) {</span>
<span id="cb40-7"><a href="#cb40-7"></a>    par1 <span class="ot">&lt;-</span> <span class="fu">eval</span>(<span class="fu">parse</span>(<span class="at">text=</span><span class="st">"a.ev[r]"</span>))</span>
<span id="cb40-8"><a href="#cb40-8"></a>    par2 <span class="ot">&lt;-</span> <span class="fu">eval</span>(<span class="fu">parse</span>(<span class="at">text=</span><span class="st">"b.ev[r]"</span>))</span>
<span id="cb40-9"><a href="#cb40-9"></a>    z    <span class="ot">&lt;-</span> <span class="fu">eval</span>(<span class="fu">parse</span>(<span class="at">text=</span><span class="st">"az1[r]"</span>))</span>
<span id="cb40-10"><a href="#cb40-10"></a>    <span class="fu">return</span>(z<span class="sc">*</span>(par1<span class="sc">*</span>par2<span class="sc">*</span>(t<span class="sc">^</span>(par2<span class="dv">-1</span>)))<span class="sc">/</span>(<span class="dv">1</span><span class="sc">+</span>par1<span class="sc">*</span>(t<span class="sc">^</span>par2)))}</span>
<span id="cb40-11"><a href="#cb40-11"></a>}</span>
<span id="cb40-12"><a href="#cb40-12"></a></span>
<span id="cb40-13"><a href="#cb40-13"></a><span class="cf">if</span> (dist.ev[k] <span class="sc">==</span> <span class="st">"weibull"</span>) {</span>
<span id="cb40-14"><a href="#cb40-14"></a>  a.ev[k] <span class="ot">&lt;-</span> beta0.ev[k] <span class="sc">+</span> suma[k]</span>
<span id="cb40-15"><a href="#cb40-15"></a>  b.ev[k] <span class="ot">&lt;-</span> anc.ev[k]</span>
<span id="cb40-16"><a href="#cb40-16"></a>  cshaz[[k]] <span class="ot">&lt;-</span> <span class="cf">function</span>(t, r) {</span>
<span id="cb40-17"><a href="#cb40-17"></a>    par1 <span class="ot">&lt;-</span> <span class="fu">eval</span>(<span class="fu">parse</span>(<span class="at">text=</span><span class="st">"a.ev[r]"</span>))</span>
<span id="cb40-18"><a href="#cb40-18"></a>    par2 <span class="ot">&lt;-</span> <span class="fu">eval</span>(<span class="fu">parse</span>(<span class="at">text=</span><span class="st">"b.ev[r]"</span>))</span>
<span id="cb40-19"><a href="#cb40-19"></a>    z    <span class="ot">&lt;-</span> <span class="fu">eval</span>(<span class="fu">parse</span>(<span class="at">text=</span><span class="st">"az1[r]"</span>))</span>
<span id="cb40-20"><a href="#cb40-20"></a>    <span class="fu">return</span>(z <span class="sc">*</span> ((<span class="dv">1</span><span class="sc">/</span>par2)<span class="sc">/</span>((<span class="fu">exp</span>(par1))<span class="sc">^</span>(<span class="dv">1</span><span class="sc">/</span>par2)))<span class="sc">*</span></span>
<span id="cb40-21"><a href="#cb40-21"></a>           t<span class="sc">^</span>((<span class="dv">1</span><span class="sc">/</span>par2) <span class="sc">-</span> <span class="dv">1</span>))}</span>
<span id="cb40-22"><a href="#cb40-22"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>It’s a bit confusing since the user function <code>survsim::crisk.sim()</code> takes <code>anc.ev</code> and <code>beta0.ev</code> as inputs, but these get transformed to <code>a.ev</code> and <code>b.ev</code> and then to <code>par1</code> and <code>par2</code> (ok that last transformation is straightforward).</p>
<p>Here’s the Weibull AFT programmed in <code>flexsurv</code></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1"></a><span class="co"># Weibull AFT parameterization hazard</span></span>
<span id="cb41-2"><a href="#cb41-2"></a>flexsurv<span class="sc">::</span>hweibull</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>function (x, shape, scale = 1, log = FALSE)
{
    h &lt;- dbase("weibull", log=log, x=x, shape=shape, scale=scale)
    for (i in seq_along(h)) assign(names(h)[i], h[[i]])
    if (log)
        ret[ind] &lt;- log(shape) + (shape-1)*log(x/scale) - log(scale)
    else
        ret[ind] &lt;- shape * (x/scale)^(shape - 1)/scale
    ret
}
&lt;bytecode: 0x62fd9b6e0820&gt;
&lt;environment: namespace:flexsurv&gt;</code></pre>
</div>
</div>
<p>If the shape parameter is <span class="math inline">\(a\)</span> and scale parameter is <span class="math inline">\(\mu\)</span>, the hazard function is</p>
<p><span class="math display">\[
h_{\text{wei}}^{\text{flexsurv}}(t; a, \mu) = a\Bigg(\frac{t}{\mu}\Bigg)^{a - 1} \frac{1}{\mu} = a \mu^{-a}t^{a - 1}
\]</span></p>
<p>and for Weibull AFT from <code>survsim</code></p>
<p><span class="math display">\[
h_{\text{wei}}^{\text{simsurv}}(t; p_1, p_2) = \frac{1}{p_2} \Bigg(\Big(e^{p_1}\Big)^{1 / p_2}\Bigg)^{-1} t^{\Big(\frac{1}{p_2} - 1\Big)}
\]</span></p>
<p>with <code>beta0.ev = par1</code> = <span class="math inline">\(p_1\)</span> and <code>anc.ev = par2</code> = <span class="math inline">\(p_2\)</span>. This gives the corresponding transformations for Weibull in <code>simsurv</code>, <code>anc.ev</code> = <span class="math inline">\(1 / a\)</span> (so inverse of <code>flexsurv</code> shape), and <code>beta0.ev</code> = <span class="math inline">\(\text{log}(\mu)\)</span> (so log of <code>flexsurv</code> scale).</p>
<p>Log-logistic implemented in <code>flexsurv</code></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1"></a><span class="co"># log-logistic hazard</span></span>
<span id="cb43-2"><a href="#cb43-2"></a>flexsurv<span class="sc">::</span>hllogis</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>function(x, shape=1, scale=1, log = FALSE) 
{
    h &lt;- dbase("llogis", log=log, x=x, shape=shape, scale=scale)
    for (i in seq_along(h)) assign(names(h)[i], h[[i]])
    if (log) ret[ind] &lt;- log(shape) - log(scale) + (shape-1)*(log(x) - log(scale)) - log(1 + (x/scale)^shape)
    else ret[ind] &lt;- (shape/scale) * (x/scale)^{shape-1} / (1 + (x/scale)^shape)
    ret
}
&lt;bytecode: 0x62fd99288f80&gt;
&lt;environment: namespace:flexsurv&gt;</code></pre>
</div>
</div>
<p>if shape is <span class="math inline">\(a\)</span> and scale is <span class="math inline">\(b\)</span>, the hazard function is</p>
<p><span class="math display">\[
h_{\text{ll}}^{\text{flexsurv}}(t; a, b) = \frac{(a / b) (t / b)^{a - 1}}{1 + (t / b)^a}
\]</span></p>
<p>compared with the one from <code>simsurv</code> (with <code>par1</code> = <span class="math inline">\(p_1\)</span> and <code>par2</code> = <span class="math inline">\(p_2\)</span>)</p>
<p><span class="math display">\[
h_{\text{ll}}^{\text{simsurv}}(t; p_1, p_2) = \frac{p_1 p_2 t^{p_2 - 1}}{1 + p_1 t^{p_2}}
\]</span></p>
<p><span class="math inline">\(p_2 = \text{anc.ev} = a\)</span> (shape from <code>flexsurv</code>) and <span class="math inline">\(p_1 = 1 / \text{exp}(\text{beta0.ev}) = a \text{log}(b)\)</span> (shape times log(scale) from <code>flexsurv</code>).</p>
</section>
<section id="survsim-function" class="level3">
<h3 class="anchored" data-anchor-id="survsim-function"><code>survsim</code> function</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1"></a>survsim_sim_fn <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">n =</span> <span class="dv">1000</span>) {</span>
<span id="cb45-2"><a href="#cb45-2"></a>  survsim<span class="sc">::</span><span class="fu">crisk.sim</span>(</span>
<span id="cb45-3"><a href="#cb45-3"></a>    <span class="at">n =</span> n,</span>
<span id="cb45-4"><a href="#cb45-4"></a>    <span class="at">foltime =</span> <span class="dv">5</span>,</span>
<span id="cb45-5"><a href="#cb45-5"></a>    <span class="co"># TTE distr</span></span>
<span id="cb45-6"><a href="#cb45-6"></a>    <span class="at">nsit =</span> <span class="dv">3</span>,</span>
<span id="cb45-7"><a href="#cb45-7"></a>    <span class="at">dist.ev =</span> <span class="fu">c</span>(<span class="st">"weibull"</span>, <span class="st">"llogistic"</span>, <span class="st">"weibull"</span>),</span>
<span id="cb45-8"><a href="#cb45-8"></a>    <span class="co"># anc.ev is 1 / shape, exp(beta0) is scale in flexsurv weibull AFT</span></span>
<span id="cb45-9"><a href="#cb45-9"></a>    <span class="co"># anc.ev is shape, beta0.ev is shape * log(scale) in flexsurv llogis</span></span>
<span id="cb45-10"><a href="#cb45-10"></a>    <span class="at">anc.ev =</span> <span class="fu">c</span>(<span class="dv">1</span> <span class="sc">/</span> <span class="fl">1.6</span>, <span class="dv">5</span>, <span class="dv">1</span>),</span>
<span id="cb45-11"><a href="#cb45-11"></a>    <span class="at">beta0.ev =</span> <span class="fu">c</span>(<span class="fu">log</span>(<span class="dv">5</span>), <span class="dv">5</span> <span class="sc">*</span> <span class="fu">log</span>(<span class="dv">5</span>), <span class="fu">log</span>(<span class="dv">5</span>)),</span>
<span id="cb45-12"><a href="#cb45-12"></a>    <span class="co"># covariate process</span></span>
<span id="cb45-13"><a href="#cb45-13"></a>    <span class="at">x =</span> <span class="fu">list</span>(<span class="fu">c</span>(<span class="st">"bern"</span>, <span class="fl">0.5</span>)),</span>
<span id="cb45-14"><a href="#cb45-14"></a>    <span class="at">beta =</span> <span class="fu">list</span>(<span class="fu">c</span>(<span class="fl">1.4</span>), <span class="fu">c</span>(<span class="dv">0</span>), <span class="fu">c</span>(<span class="dv">0</span>)),</span>
<span id="cb45-15"><a href="#cb45-15"></a>    <span class="co"># censoring process, assume constant here to only apply administrative censoring</span></span>
<span id="cb45-16"><a href="#cb45-16"></a>    <span class="at">dist.cens =</span> <span class="st">"unif"</span>, <span class="at">beta0.cens =</span> <span class="dv">500</span>, <span class="at">anc.cens =</span> <span class="dv">500</span></span>
<span id="cb45-17"><a href="#cb45-17"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb45-18"><a href="#cb45-18"></a>    <span class="fu">as_tibble</span>()</span>
<span id="cb45-19"><a href="#cb45-19"></a>}</span>
<span id="cb45-20"><a href="#cb45-20"></a></span>
<span id="cb45-21"><a href="#cb45-21"></a><span class="fu">survsim_sim_fn</span>(<span class="at">n =</span> <span class="dv">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 10 × 8
     nid cause   time status start stop      z     x
   &lt;int&gt; &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt; &lt;lgl&gt; &lt;lgl&gt; &lt;dbl&gt; &lt;dbl&gt;
 1     1    NA 5           0 NA    NA        1     0
 2     2     1 3.79        1 NA    NA        1     0
 3     3     3 0.321       1 NA    NA        1     0
 4     4     3 1.02        1 NA    NA        1     1
 5     5     1 2.38        1 NA    NA        1     1
 6     6     3 2.45        1 NA    NA        1     1
 7     7     3 0.0557      1 NA    NA        1     0
 8     8     3 0.0681      1 NA    NA        1     0
 9     9     3 0.0741      1 NA    NA        1     1
10    10     1 2.34        1 NA    NA        1     0</code></pre>
</div>
</div>
<p>The <span class="math inline">\(z\)</span> column is for individual frailties.</p>
</section>
<section id="compare-run-times" class="level3">
<h3 class="anchored" data-anchor-id="compare-run-times">Compare run times</h3>
<p>The next figure shows a dot plot of the execution time distribution by repeating the process 10 times for both functions (again previously run results read back in)</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1"></a><span class="co"># survsim_bench &lt;- bench::mark(</span></span>
<span id="cb47-2"><a href="#cb47-2"></a><span class="co">#   survsim_sim_fn(), iterations = 10, </span></span>
<span id="cb47-3"><a href="#cb47-3"></a><span class="co">#   check = FALSE, time_unit = "s", memory = FALSE</span></span>
<span id="cb47-4"><a href="#cb47-4"></a><span class="co"># )</span></span>
<span id="cb47-5"><a href="#cb47-5"></a><span class="co"># write_rds(survsim_bench, file = "saved_objects/survsim_bench.rds")</span></span>
<span id="cb47-6"><a href="#cb47-6"></a></span>
<span id="cb47-7"><a href="#cb47-7"></a>survsim_bench <span class="ot">&lt;-</span> <span class="fu">read_rds</span>(<span class="st">"saved_objects/survsim_bench.rds"</span>)</span>
<span id="cb47-8"><a href="#cb47-8"></a></span>
<span id="cb47-9"><a href="#cb47-9"></a><span class="co"># my_implementation_bench &lt;- bench::mark(</span></span>
<span id="cb47-10"><a href="#cb47-10"></a><span class="co">#   run_pipeline(sample(1:100, size = 1, replace = TRUE)),</span></span>
<span id="cb47-11"><a href="#cb47-11"></a><span class="co">#   iterations = 10, check = FALSE, time_unit = "s", memory = FALSE</span></span>
<span id="cb47-12"><a href="#cb47-12"></a><span class="co"># )</span></span>
<span id="cb47-13"><a href="#cb47-13"></a><span class="co"># write_rds(my_implementation_bench, file = "saved_objects/my_implementation_bench.rds")</span></span>
<span id="cb47-14"><a href="#cb47-14"></a></span>
<span id="cb47-15"><a href="#cb47-15"></a>my_implementation_bench <span class="ot">&lt;-</span> <span class="fu">read_rds</span>(<span class="st">"saved_objects/my_implementation_bench.rds"</span>)</span>
<span id="cb47-16"><a href="#cb47-16"></a></span>
<span id="cb47-17"><a href="#cb47-17"></a><span class="co"># dot plot of the run times</span></span>
<span id="cb47-18"><a href="#cb47-18"></a><span class="fu">tibble</span>(</span>
<span id="cb47-19"><a href="#cb47-19"></a>  <span class="at">time =</span> <span class="fu">c</span>(survsim_bench <span class="sc">%&gt;%</span> <span class="fu">pluck</span>(<span class="st">"time"</span>, <span class="dv">1</span>), </span>
<span id="cb47-20"><a href="#cb47-20"></a>           my_implementation_bench <span class="sc">%&gt;%</span> <span class="fu">pluck</span>(<span class="st">"time"</span>, <span class="dv">1</span>)),</span>
<span id="cb47-21"><a href="#cb47-21"></a>  <span class="at">group =</span> <span class="fu">rep</span>(<span class="fu">c</span>(<span class="st">"survsim"</span>, <span class="st">"handrolled"</span>), <span class="at">each =</span> <span class="dv">10</span>)</span>
<span id="cb47-22"><a href="#cb47-22"></a>) <span class="sc">%&gt;%</span></span>
<span id="cb47-23"><a href="#cb47-23"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> group, <span class="at">fill =</span> group, <span class="at">color =</span> group)) <span class="sc">+</span></span>
<span id="cb47-24"><a href="#cb47-24"></a>  <span class="fu">geom_dotplot</span>(<span class="at">binwidth =</span> <span class="fl">0.05</span>,  <span class="at">binaxis =</span> <span class="st">"x"</span>, </span>
<span id="cb47-25"><a href="#cb47-25"></a>               <span class="at">method =</span> <span class="st">"histodot"</span>, <span class="at">binpositions =</span> <span class="st">"bygroup"</span>, </span>
<span id="cb47-26"><a href="#cb47-26"></a>               <span class="at">stackdir =</span> <span class="st">"centerwhole"</span>) <span class="sc">+</span></span>
<span id="cb47-27"><a href="#cb47-27"></a>  <span class="co">#geom_point(size = 3, position = position_jitter(height = 0.1, seed = 4)) +</span></span>
<span id="cb47-28"><a href="#cb47-28"></a>  <span class="co">#theme(legend.position = "bottom", legend.title = element_blank()) +</span></span>
<span id="cb47-29"><a href="#cb47-29"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>) <span class="sc">+</span></span>
<span id="cb47-30"><a href="#cb47-30"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">1</span>, <span class="dv">4</span>, <span class="dv">1</span>), </span>
<span id="cb47-31"><a href="#cb47-31"></a>                     <span class="at">labels =</span> <span class="fu">seq</span>(<span class="dv">1</span>, <span class="dv">4</span>, <span class="dv">1</span>), </span>
<span id="cb47-32"><a href="#cb47-32"></a>                     <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">4</span>)) <span class="sc">+</span></span>
<span id="cb47-33"><a href="#cb47-33"></a>  <span class="fu">xlab</span>(<span class="st">"Time (in seconds)"</span>) <span class="sc">+</span></span>
<span id="cb47-34"><a href="#cb47-34"></a>  <span class="fu">ylab</span>(<span class="st">""</span>) <span class="sc">+</span> </span>
<span id="cb47-35"><a href="#cb47-35"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"orange"</span>, <span class="st">"gray30"</span>)) <span class="sc">+</span> </span>
<span id="cb47-36"><a href="#cb47-36"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"orange"</span>, <span class="st">"gray30"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-23-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>shows about 2x speedup; I’m assuming most of this comes from not having to use numerical integration but using the cumulative hazards programmed within <code>flexsurv</code>.</p>
</section>
<section id="compare-samples" class="level3">
<h3 class="anchored" data-anchor-id="compare-samples">Compare samples</h3>
<p>The next plot shows the empirical distribution functions for 100 samples of size 100 from the two implementations</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1"></a><span class="co"># eCDFs for a large draw overlaid to compare the draws - they should be overlapping</span></span>
<span id="cb48-2"><a href="#cb48-2"></a><span class="co"># set.seed(23)</span></span>
<span id="cb48-3"><a href="#cb48-3"></a><span class="co"># survsim_sample &lt;- survsim_sim_fn(n = 10000)</span></span>
<span id="cb48-4"><a href="#cb48-4"></a><span class="co"># set.seed(23)</span></span>
<span id="cb48-5"><a href="#cb48-5"></a><span class="co"># handrolled_sample &lt;- simulate_single_dataset(n_rows = 10000, seed = NULL)</span></span>
<span id="cb48-6"><a href="#cb48-6"></a><span class="co">#</span></span>
<span id="cb48-7"><a href="#cb48-7"></a><span class="co"># write_rds(survsim_sample, file = "saved_objects/survsim_sample.rds")</span></span>
<span id="cb48-8"><a href="#cb48-8"></a><span class="co"># write_rds(handrolled_sample, file = "saved_objects/handrolled_sample.rds")</span></span>
<span id="cb48-9"><a href="#cb48-9"></a></span>
<span id="cb48-10"><a href="#cb48-10"></a>survsim_sample <span class="ot">&lt;-</span> <span class="fu">read_rds</span>(<span class="st">"saved_objects/survsim_sample.rds"</span>)</span>
<span id="cb48-11"><a href="#cb48-11"></a>handrolled_sample <span class="ot">&lt;-</span> <span class="fu">read_rds</span>(<span class="st">"saved_objects/handrolled_sample.rds"</span>)</span>
<span id="cb48-12"><a href="#cb48-12"></a></span>
<span id="cb48-13"><a href="#cb48-13"></a><span class="fu">bind_rows</span>(</span>
<span id="cb48-14"><a href="#cb48-14"></a>  survsim_sample <span class="sc">%&gt;%</span></span>
<span id="cb48-15"><a href="#cb48-15"></a>    <span class="fu">select</span>(time) <span class="sc">%&gt;%</span></span>
<span id="cb48-16"><a href="#cb48-16"></a>    <span class="fu">mutate</span>(<span class="at">group =</span> <span class="st">"survsim"</span>),</span>
<span id="cb48-17"><a href="#cb48-17"></a>  handrolled_sample <span class="sc">%&gt;%</span></span>
<span id="cb48-18"><a href="#cb48-18"></a>    <span class="fu">select</span>(time) <span class="sc">%&gt;%</span></span>
<span id="cb48-19"><a href="#cb48-19"></a>    <span class="fu">mutate</span>(<span class="at">group =</span> <span class="st">"handrolled"</span>)</span>
<span id="cb48-20"><a href="#cb48-20"></a>) <span class="sc">%&gt;%</span></span>
<span id="cb48-21"><a href="#cb48-21"></a>  <span class="fu">mutate</span>(<span class="at">rep =</span> <span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">100</span>, <span class="at">size =</span> <span class="dv">20000</span>, <span class="at">replace =</span> <span class="cn">TRUE</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb48-22"><a href="#cb48-22"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">group =</span> <span class="fu">interaction</span>(group, rep), <span class="at">color =</span> group)) <span class="sc">+</span></span>
<span id="cb48-23"><a href="#cb48-23"></a>  <span class="fu">stat_ecdf</span>(<span class="at">pad =</span> <span class="cn">FALSE</span>, <span class="at">alpha =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb48-24"><a href="#cb48-24"></a>  <span class="fu">xlab</span>(<span class="st">"Simulated Times"</span>) <span class="sc">+</span></span>
<span id="cb48-25"><a href="#cb48-25"></a>  <span class="fu">ylab</span>(<span class="st">"Empirical CDF"</span>) <span class="sc">+</span></span>
<span id="cb48-26"><a href="#cb48-26"></a>  <span class="fu">theme_classic</span>() <span class="sc">+</span></span>
<span id="cb48-27"><a href="#cb48-27"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"bottom"</span>, <span class="at">legend.title =</span> <span class="fu">element_blank</span>()) <span class="sc">+</span></span>
<span id="cb48-28"><a href="#cb48-28"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"orange"</span>, <span class="st">"gray30"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-24-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>It seems that the gray curves (<code>survsim</code>) are a bit higher than the ones in orange (my implementation). I haven’t looked into why, but it seems likely to be due to sampling variation.</p>
</section>
</section>
<section id="references" class="level2">
<h2 class="anchored" data-anchor-id="references">References</h2>
<p>The main refs for the material in this post</p>
<ul>
<li><p>Beyersmann, J., Latouche, A., Buchholz, A., &amp; Schumacher, M. (2009). Simulating competing risks data in survival analysis. <em>Statistics in medicine</em>, <em>28</em>(6), 956-971.</p></li>
<li><p>Allignol, A., Schumacher, M., Wanner, C. <em>et al.</em> Understanding competing risks: a simulation point of view. <em>BMC Med Res Methodol</em> <strong>11</strong>, 86 (2011). <a href="https://doi.org/10.1186/1471-2288-11-86" class="uri">https://doi.org/10.1186/1471-2288-11-86</a> - what I found cool is that this paper uses the non-parametric estimate of the baseline hazard function to simulate proportional hazard data from the cox model</p></li>
<li><p>Crowther, M. J., &amp; Lambert, P. C. (2012). Simulating Complex Survival Data. <em>The Stata Journal</em>, <em>12</em>(4), 674-687. <a href="https://doi.org/10.1177/1536867X1201200407" class="uri">https://doi.org/10.1177/1536867X1201200407</a> (Original work published 2012)</p></li>
<li><p>Putter, H., Fiocco, M. and Geskus, R.B. (2007), Tutorial in biostatistics: competing risks and multi-state models. Statist. Med., 26: 2389-2430. <a href="https://doi.org/10.1002/sim.2712" class="uri">https://doi.org/10.1002/sim.2712</a> - key paper on competing risk analyses</p></li>
<li><p>Hinchliffe, S.R., Lambert, P.C. Flexible parametric modelling of cause-specific hazards to estimate cumulative incidence functions. <em>BMC Med Res Methodol</em> <strong>13</strong>, 13 (2013). <a href="https://doi.org/10.1186/1471-2288-13-13" class="uri">https://doi.org/10.1186/1471-2288-13-13</a></p></li>
<li><p><code>flexsurv</code> package <a href="https://cran.r-project.org/web/packages/flexsurv/vignettes/multistate.pdf">vignette</a> on multi-state modelling</p></li>
<li><p><code>flexsurv</code> package <a href="https://cran.r-project.org/web/packages/flexsurv/vignettes/flexsurv.pdf">introduction vignette</a></p></li>
<li><p><code>flexsurv</code> vignette on <a href="https://cran.r-project.org/web/packages/flexsurv/vignettes/distributions.pdf">distributions</a></p></li>
<li><p><code>survsim</code> package <a href="https://cran.r-project.org/web/packages/survsim/survsim.pdf">docs</a></p></li>
</ul>
<p>Some other papers / package vignettes I came across and read (parts of if not entirely)</p>
<ul>
<li><p><code>survival</code> package <a href="https://cran.r-project.org/web/packages/survival/vignettes/compete.pdf">multi-state vignette</a></p></li>
<li><p><code>survival</code> package <a href="https://cran.r-project.org/web/packages/survivalVignettes/vignettes/tutorial.html">vignette</a> reproducing Putter et al analysis</p></li>
<li><p>Andersen PK, Geskus RB, de Witte T, Putter H. Competing risks in epidemiology: possibilities and pitfalls. Int J Epidemiol. 2012 Jun;41(3):861-70. doi: 10.1093/ije/dyr213. Epub 2012 Jan 9. PMID: 22253319; PMCID: PMC3396320.</p></li>
<li><p>Austin PC, Lee DS, Fine JP. Introduction to the Analysis of Survival Data in the Presence of Competing Risks. Circulation. 2016 Feb 9;133(6):601-9. doi: 10.1161/CIRCULATIONAHA.115.017719. PMID: 26858290; PMCID: PMC4741409.</p></li>
<li><p>Fine, J. P., &amp; Gray, R. J. (1999). A Proportional Hazards Model for the Subdistribution of a Competing Risk. <em>Journal of the American Statistical Association</em>, <em>94</em>(446), 496–509. https://doi.org/10.2307/2670170</p></li>
<li><p>Latouche A, Allignol A, Beyersmann J, Labopin M, Fine JP. A competing risks analysis should report results on all cause-specific hazards and cumulative incidence functions. J Clin Epidemiol. 2013 Jun;66(6):648-53. doi: 10.1016/j.jclinepi.2012.09.017. Epub 2013 Feb 14. PMID: 23415868.</p></li>
<li><p>Scheike, T. H., &amp; Zhang, M.-J. (2011). Analyzing Competing Risk Data Using the R timereg Package. <em>Journal of Statistical Software</em>, <em>38</em>(2), 1–15. https://doi.org/10.18637/jss.v038.i02</p></li>
<li><p>Thomas H. Scheike, Mei-Jie Zhang, Thomas A. Gerds, Predicting cumulative incidence probability by direct binomial regression, <em>Biometrika</em>, Volume 95, Issue 1, March 2008, Pages 205–220, <a href="https://doi.org/10.1093/biomet/asm096" class="uri">https://doi.org/10.1093/biomet/asm096</a></p></li>
<li><p>Edouard F Bonneville, Liesbeth C de Wreede, Hein Putter, Why you should avoid using multiple Fine–Gray models: insights from (attempts at) simulating proportional subdistribution hazards data, <em>Journal of the Royal Statistical Society Series A: Statistics in Society</em>, Volume 187, Issue 3, August 2024, Pages 580–593, <a href="https://doi.org/10.1093/jrsssa/qnae056" class="uri">https://doi.org/10.1093/jrsssa/qnae056</a></p></li>
</ul>


<!-- -->

</section>


</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
    const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
    const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
    let newTheme = '';
    if(darkModeDefault) {
      newTheme = isAlternate ? baseTheme : alternateTheme;
    } else {
      newTheme = isAlternate ? alternateTheme : baseTheme;
    }
    const changeGiscusTheme = () => {
      // From: https://github.com/giscus/giscus/issues/336
      const sendMessage = (message) => {
        const iframe = document.querySelector('iframe.giscus-frame');
        if (!iframe) return;
        iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
      }
      sendMessage({
        setConfig: {
          theme: newTheme
        }
      });
    }
    const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
    if (isGiscussLoaded) {
      changeGiscusTheme();
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  const darkModeDefault = false;
  let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
    toggleGiscusIfUsed(toAlternate, darkModeDefault);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/akshat\.blog");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
          // target, if specified
          link.setAttribute("target", "_blank");
          if (link.getAttribute("rel") === null) {
            link.setAttribute("rel", "noopener");
          }
          // default icon
          link.classList.add("external");
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<script src="https://giscus.app/client.js" data-repo="ad1729/ad1729.github.io" data-repo-id="R_kgDOHvxVCQ" data-category="Announcements" data-category-id="DIC_kwDOHvxVCc4CdwZG" data-mapping="title" data-reactions-enabled="0" data-emit-metadata="0" data-input-position="top" data-theme="light" data-lang="en" crossorigin="anonymous" async="">
</script>
<input type="hidden" id="giscus-base-theme" value="light">
<input type="hidden" id="giscus-alt-theme" value="dark_dimmed"><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb49" data-shortcodes="false"><pre class="sourceCode numberSource markdown number-lines code-with-copy"><code class="sourceCode markdown"><span id="cb49-1"><a href="#cb49-1"></a><span class="co">---</span></span>
<span id="cb49-2"><a href="#cb49-2"></a><span class="an">title:</span><span class="co"> "Simulating data from the cause-specific hazard approach to competing risks"</span></span>
<span id="cb49-3"><a href="#cb49-3"></a><span class="an">date:</span><span class="co"> "2025-08-09"</span></span>
<span id="cb49-4"><a href="#cb49-4"></a><span class="an">categories:</span><span class="co"> [R, Simulation, Time-to-event]</span></span>
<span id="cb49-5"><a href="#cb49-5"></a><span class="an">image:</span><span class="co"> "cif_plot.png"</span></span>
<span id="cb49-6"><a href="#cb49-6"></a><span class="an">code-fold:</span><span class="co"> true</span></span>
<span id="cb49-7"><a href="#cb49-7"></a><span class="an">editor:</span><span class="co"> visual</span></span>
<span id="cb49-8"><a href="#cb49-8"></a><span class="co">---</span></span>
<span id="cb49-9"><a href="#cb49-9"></a></span>
<span id="cb49-10"><a href="#cb49-10"></a>In a <span class="co">[</span><span class="ot">previous post</span><span class="co">](../simulating-survival-data-with-non-PH-and-cure/index.qmd)</span>, I used the *cumulative hazard inversion method* to simulate *time-to-event (TTE)* data from a log-logistic accelerated-failure time (AFT) model with statistical cure. The estimand of interest was the *cumulative incidence function (CIF)*, which is the probability of experiencing the event of interest before time $t$ (i.e., $\text{Pr}<span class="co">[</span><span class="ot">T \leq t</span><span class="co">]</span>$, also known as the cumulative distribution function (CDF) in the absence of censoring).</span>
<span id="cb49-11"><a href="#cb49-11"></a></span>
<span id="cb49-12"><a href="#cb49-12"></a>I came across two things while reading up on material for that post, that I'd mentally filed away for looking into in the future. The first was on simulating TTE data using numerical methods. The second was on estimating the CIF in the *competing risk (CR)* setting where it wasn't correct to invert the survivor function ($S(t) = \text{Pr}<span class="co">[</span><span class="ot">T &gt; t</span><span class="co">]</span> = 1 - \text{Pr}<span class="co">[</span><span class="ot">T \le t</span><span class="co">]</span>$) to get to the CIF.</span>
<span id="cb49-13"><a href="#cb49-13"></a></span>
<span id="cb49-14"><a href="#cb49-14"></a>So this post is on simulating data from the *cause-specific hazards (CSH)* approach to CR based on <span class="co">[</span><span class="ot">this paper</span><span class="co">](https://onlinelibrary.wiley.com/doi/abs/10.1002/sim.3516)</span> (Beyersmann et al. 2009); other key papers I use material from are listed in the references below. To check whether my implementation (and understanding) is correct, I run a mini simulation to see if I can recover the true parameters used for generating the data. I also compare the estimated cause-specific CIFs with the true CIFs.</span>
<span id="cb49-15"><a href="#cb49-15"></a></span>
<span id="cb49-16"><a href="#cb49-16"></a>I initially tried to use the <span class="in">`survsim`</span> package to simulate CSH CR data, but I found it quite slow. Figuring out what I was doing suboptimally was only clear to me after digging deeply into it and reimplementing the code myself by studying the <span class="co">[</span><span class="ot">implementation</span><span class="co">](https://github.com/cran/survsim/blob/6e1bf878cf3e35b37d6cb7d1ef4b0179ed99b1d3/R/crisk.ncens.sim.R)</span> of <span class="in">`survsim::crisk.ncens.sim`</span> and the Beyersmann paper. My implementation has the advantage that it</span>
<span id="cb49-17"><a href="#cb49-17"></a></span>
<span id="cb49-18"><a href="#cb49-18"></a><span class="ss">-   </span>is faster</span>
<span id="cb49-19"><a href="#cb49-19"></a></span>
<span id="cb49-20"><a href="#cb49-20"></a><span class="ss">-   </span>uses closed-form expressions for the cumulative hazards rather than numerically integrating the hazards</span>
<span id="cb49-21"><a href="#cb49-21"></a></span>
<span id="cb49-22"><a href="#cb49-22"></a><span class="ss">-   </span>uses the same parameterizations as the <span class="in">`flexsurv`</span> package I'm using to fit the models so I don't have to mess around with transforming between parameterizations</span>
<span id="cb49-23"><a href="#cb49-23"></a></span>
<span id="cb49-24"><a href="#cb49-24"></a><span class="ss">-   </span>can use any distribution that from <span class="in">`flexsurv`</span> that is not in <span class="in">`survsim`</span> (so those beyond Weibull, log-normal, log-logistic, and those that are subsumed within these (e.g. exponential within Weibull))</span>
<span id="cb49-25"><a href="#cb49-25"></a></span>
<span id="cb49-26"><a href="#cb49-26"></a><span class="ss">-   </span>managed to increase my knowledge of this topic</span>
<span id="cb49-27"><a href="#cb49-27"></a></span>
<span id="cb49-28"><a href="#cb49-28"></a>I mean I'd most likely still use <span class="in">`survsim`</span>, unless I need to simulate a lot of not very small datasets, or want the additional flexibility around simulation-model specification.</span>
<span id="cb49-29"><a href="#cb49-29"></a></span>
<span id="cb49-30"><a href="#cb49-30"></a>I think <span class="in">`adjustedCurves::sim_confounded_crisk()`</span> can simulate CR data from the CSH approach as well, but I haven't tried it out.</span>
<span id="cb49-31"><a href="#cb49-31"></a></span>
<span id="cb49-32"><a href="#cb49-32"></a>I'm using the following packages</span>
<span id="cb49-33"><a href="#cb49-33"></a></span>
<span id="cb49-36"><a href="#cb49-36"></a><span class="in">```{r}</span></span>
<span id="cb49-37"><a href="#cb49-37"></a><span class="co">#| code-fold: false</span></span>
<span id="cb49-38"><a href="#cb49-38"></a></span>
<span id="cb49-39"><a href="#cb49-39"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb49-40"><a href="#cb49-40"></a><span class="fu">library</span>(survival)</span>
<span id="cb49-41"><a href="#cb49-41"></a><span class="fu">library</span>(flexsurv)</span>
<span id="cb49-42"><a href="#cb49-42"></a><span class="co"># functions called via namespace::fun() to avoid conflicts</span></span>
<span id="cb49-43"><a href="#cb49-43"></a><span class="co"># library(glue)  # string interpolation</span></span>
<span id="cb49-44"><a href="#cb49-44"></a><span class="co"># library(mirai)  # for setting daemons() for parallelization</span></span>
<span id="cb49-45"><a href="#cb49-45"></a><span class="co"># library(survsim)</span></span>
<span id="cb49-46"><a href="#cb49-46"></a><span class="co"># library(ggh4x)  # facet_grid2 function</span></span>
<span id="cb49-47"><a href="#cb49-47"></a><span class="co"># library(bench)  # for benchmarking</span></span>
<span id="cb49-48"><a href="#cb49-48"></a></span>
<span id="cb49-49"><a href="#cb49-49"></a><span class="fu">theme_set</span>(<span class="fu">theme_bw</span>())</span>
<span id="cb49-50"><a href="#cb49-50"></a><span class="in">```</span></span>
<span id="cb49-51"><a href="#cb49-51"></a></span>
<span id="cb49-52"><a href="#cb49-52"></a><span class="fu">## Data generating process</span></span>
<span id="cb49-53"><a href="#cb49-53"></a></span>
<span id="cb49-54"><a href="#cb49-54"></a>In the usual TTE setting, interest is on a single event. An example from marketing is that of customer churn, where a customer cancels their subscription. The competing risk approach to TTE analysis extends this to cases where more than one event can occur.</span>
<span id="cb49-55"><a href="#cb49-55"></a></span>
<span id="cb49-56"><a href="#cb49-56"></a>Sticking with the churn example, this could be (say) three possible event types (using the event indicator $D$ with values $k = 1, 2, 3 (= K)$) — churn due to customer dissatisfaction with some aspect of the product / service which is the main event of interest that a company would like to reduce ($D = 1$), churn due to financial reasons ($D = 2$), and churn due to unavoidable reasons ($D = 3$). $D = 0$ indicates not having churned (yet). I'm using an example just to make things a bit more concrete; these hazard functions are unlikely to be representative of any actual churn process.</span>
<span id="cb49-57"><a href="#cb49-57"></a></span>
<span id="cb49-58"><a href="#cb49-58"></a>This single vs multiple TTE analysis is analogous to the distinction between binary (binomial) vs categorical (multinomial) outcomes, with the former taking on values 0 / 1, and the latter taking on more than 2 values e.g., 0 / 1 / 2 / 3.</span>
<span id="cb49-59"><a href="#cb49-59"></a></span>
<span id="cb49-60"><a href="#cb49-60"></a><span class="fu">### Distributional parameters</span></span>
<span id="cb49-61"><a href="#cb49-61"></a></span>
<span id="cb49-62"><a href="#cb49-62"></a>The three churn event types are assumed to have the hazard functions corresponding to these distributions</span>
<span id="cb49-63"><a href="#cb49-63"></a></span>
<span id="cb49-64"><a href="#cb49-64"></a>$$</span>
<span id="cb49-65"><a href="#cb49-65"></a>\begin{align*}</span>
<span id="cb49-66"><a href="#cb49-66"></a>T^1 | x_1 = 0 &amp;\sim \text{Weibull}(\text{shape} = 1.6, \text{scale} = 5) <span class="sc">\\</span></span>
<span id="cb49-67"><a href="#cb49-67"></a>T^2 | x_1 = 0 &amp;\sim \text{Log-logistic}(\text{shape} = 5, \text{scale} = 5) <span class="sc">\\</span></span>
<span id="cb49-68"><a href="#cb49-68"></a>T^3 | x_1 = 0 &amp;\sim \text{Exponential}(\text{rate} = 5)</span>
<span id="cb49-69"><a href="#cb49-69"></a>\end{align*}</span>
<span id="cb49-70"><a href="#cb49-70"></a>$$</span>
<span id="cb49-71"><a href="#cb49-71"></a></span>
<span id="cb49-72"><a href="#cb49-72"></a>for the control arm ($x_1 = 0$) assuming some experiment is carried out to assess the effectiveness of some action intended to reduce churn. Treatment arm can be coded as $x_1 = 1$ with treatment assumed to reduce the rate of churn by a time acceleration factor of 1.4 or 40%. So we have</span>
<span id="cb49-73"><a href="#cb49-73"></a></span>
<span id="cb49-74"><a href="#cb49-74"></a>$$</span>
<span id="cb49-75"><a href="#cb49-75"></a>\begin{align*}</span>
<span id="cb49-76"><a href="#cb49-76"></a>T^1 | x_1 = 0 &amp;\sim \text{Weibull}(\text{shape} = 1.6, \text{scale} = 5) <span class="sc">\\</span></span>
<span id="cb49-77"><a href="#cb49-77"></a>T^1 | x_1 = 1 &amp;\sim \text{Weibull}(\text{shape} = 1.6, \text{scale} = 7) </span>
<span id="cb49-78"><a href="#cb49-78"></a>\end{align*}</span>
<span id="cb49-79"><a href="#cb49-79"></a>$$</span>
<span id="cb49-80"><a href="#cb49-80"></a></span>
<span id="cb49-81"><a href="#cb49-81"></a>and $T^2 |x_1$ and $T^3 | x_1$ are the same for $x_1 = 0$ and $x_1 = 1$.</span>
<span id="cb49-82"><a href="#cb49-82"></a></span>
<span id="cb49-83"><a href="#cb49-83"></a>Choosing $x_1$ to have a non-zero effect only on $T^1$ means I'm avoiding some of the messiness that comes with interpreting treatment effects on the CIFs.</span>
<span id="cb49-84"><a href="#cb49-84"></a></span>
<span id="cb49-85"><a href="#cb49-85"></a>I'm also assuming a 50-50 (%) split of $x_1$ into the two groups.</span>
<span id="cb49-86"><a href="#cb49-86"></a></span>
<span id="cb49-87"><a href="#cb49-87"></a>These values for the shape / scale / rate parameters were chosen to have decent balance across the different event types and to not have some categories with very low event counts.</span>
<span id="cb49-88"><a href="#cb49-88"></a></span>
<span id="cb49-89"><a href="#cb49-89"></a><span class="fu">### Latent failure time approach</span></span>
<span id="cb49-90"><a href="#cb49-90"></a></span>
<span id="cb49-91"><a href="#cb49-91"></a>The use of $T^{\bullet}$ makes it seem like I'm invoking the *latent failure time approach to CR*, but I'm only using it as a convenient way of indicating the chosen CSH functions. As pretty much all papers on CR warn, the latent variable approach — which retains $T_i = min(T^1_i, \dots, T^K_i)$ for each individual $i$ — assumes unverifiable dependence structures between the latent event time variable $T^k$ which are generally not identifiable from observed data.</span>
<span id="cb49-92"><a href="#cb49-92"></a></span>
<span id="cb49-93"><a href="#cb49-93"></a>This is sad because the latent variable approach seems a lot more intuitive and is very simple to generate data from when the latent event times are assumed to be independent</span>
<span id="cb49-94"><a href="#cb49-94"></a></span>
<span id="cb49-97"><a href="#cb49-97"></a><span class="in">```{r}</span></span>
<span id="cb49-98"><a href="#cb49-98"></a><span class="co">#| code-fold: false</span></span>
<span id="cb49-99"><a href="#cb49-99"></a></span>
<span id="cb49-100"><a href="#cb49-100"></a>n <span class="ot">&lt;-</span> <span class="dv">7</span></span>
<span id="cb49-101"><a href="#cb49-101"></a><span class="fu">set.seed</span>(<span class="dv">25</span>)</span>
<span id="cb49-102"><a href="#cb49-102"></a><span class="fu">tibble</span>(</span>
<span id="cb49-103"><a href="#cb49-103"></a>  <span class="co"># generate group membership</span></span>
<span id="cb49-104"><a href="#cb49-104"></a>  <span class="at">x1 =</span> <span class="fu">rbinom</span>(n, <span class="dv">1</span>, <span class="at">prob =</span> <span class="fl">0.5</span>),</span>
<span id="cb49-105"><a href="#cb49-105"></a>  <span class="co"># generate counterfactual for x1 = 0</span></span>
<span id="cb49-106"><a href="#cb49-106"></a>  <span class="at">t1_0 =</span> <span class="fu">rweibull</span>(n, <span class="at">shape =</span> <span class="fl">1.6</span>, <span class="at">scale =</span> <span class="dv">5</span>),</span>
<span id="cb49-107"><a href="#cb49-107"></a>  <span class="co"># and counterfactual for x1 = 1 (using scale = 7)</span></span>
<span id="cb49-108"><a href="#cb49-108"></a>  <span class="at">t1_1 =</span> <span class="fu">rweibull</span>(n, <span class="at">shape =</span> <span class="fl">1.6</span>, <span class="at">scale =</span> <span class="fu">exp</span>(<span class="fu">log</span>(<span class="dv">5</span>) <span class="sc">+</span> <span class="fu">log</span>(<span class="fl">1.4</span>))),</span>
<span id="cb49-109"><a href="#cb49-109"></a>  <span class="co"># use the consistency equation to realize the latent t1</span></span>
<span id="cb49-110"><a href="#cb49-110"></a>  <span class="at">t1 =</span>  (x1 <span class="sc">*</span> t1_1) <span class="sc">+</span> ((<span class="dv">1</span> <span class="sc">-</span> x1) <span class="sc">*</span> t1_0),</span>
<span id="cb49-111"><a href="#cb49-111"></a>  <span class="at">t2 =</span> <span class="fu">rllogis</span>(n, <span class="at">shape =</span> <span class="dv">5</span>, <span class="at">scale =</span> <span class="dv">5</span>),</span>
<span id="cb49-112"><a href="#cb49-112"></a>  <span class="co"># exponential distribution, same as rexp(n, 1 / 5)</span></span>
<span id="cb49-113"><a href="#cb49-113"></a>  <span class="at">t3 =</span> <span class="fu">rweibull</span>(n, <span class="at">shape =</span> <span class="dv">1</span>, <span class="at">scale =</span> <span class="dv">5</span>),</span>
<span id="cb49-114"><a href="#cb49-114"></a>  <span class="co"># administrative censoring</span></span>
<span id="cb49-115"><a href="#cb49-115"></a>  <span class="at">cens_time =</span> <span class="dv">4</span>,</span>
<span id="cb49-116"><a href="#cb49-116"></a>  <span class="co"># take the minimum of the latent event and censoring times</span></span>
<span id="cb49-117"><a href="#cb49-117"></a>  <span class="at">time =</span> <span class="fu">pmin</span>(t1, t2, t3, cens_time), </span>
<span id="cb49-118"><a href="#cb49-118"></a>  <span class="co"># record which event / censor time is the smallest</span></span>
<span id="cb49-119"><a href="#cb49-119"></a>  <span class="at">event =</span> <span class="fu">case_when</span>(</span>
<span id="cb49-120"><a href="#cb49-120"></a>    cens_time <span class="sc">&lt;</span> t1 <span class="sc">&amp;</span> cens_time <span class="sc">&lt;</span> t2 <span class="sc">&amp;</span> cens_time <span class="sc">&lt;</span> t3 <span class="sc">~</span> <span class="dv">0</span>,</span>
<span id="cb49-121"><a href="#cb49-121"></a>    t1 <span class="sc">&lt;</span> t2 <span class="sc">&amp;</span> t2 <span class="sc">&lt;</span> t3 <span class="sc">~</span> <span class="dv">1</span>,</span>
<span id="cb49-122"><a href="#cb49-122"></a>    t2 <span class="sc">&lt;</span> t1 <span class="sc">&amp;</span> t2 <span class="sc">&lt;</span> t3 <span class="sc">~</span> <span class="dv">2</span>,</span>
<span id="cb49-123"><a href="#cb49-123"></a>    t3 <span class="sc">&lt;</span> t1 <span class="sc">&amp;</span> t3 <span class="sc">&lt;</span> t2 <span class="sc">~</span> <span class="dv">3</span></span>
<span id="cb49-124"><a href="#cb49-124"></a>  )</span>
<span id="cb49-125"><a href="#cb49-125"></a>) <span class="sc">%&gt;%</span> </span>
<span id="cb49-126"><a href="#cb49-126"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="at">.cols =</span> <span class="fu">everything</span>(), <span class="at">.fns =</span> <span class="sc">~</span> <span class="fu">round</span>(.x, <span class="dv">2</span>)))</span>
<span id="cb49-127"><a href="#cb49-127"></a><span class="in">```</span></span>
<span id="cb49-128"><a href="#cb49-128"></a></span>
<span id="cb49-129"><a href="#cb49-129"></a>I'm quite sure that if I used this for my simulation I'd still end up with unbiased parameter estimates, but the assumption of independence may not be very realistic depending on the application.</span>
<span id="cb49-130"><a href="#cb49-130"></a></span>
<span id="cb49-131"><a href="#cb49-131"></a>A future rabbit hole to go down would be to look into the literature on using copulas for modelling dependence between the latent event times.</span>
<span id="cb49-132"><a href="#cb49-132"></a></span>
<span id="cb49-133"><a href="#cb49-133"></a>The event time for each individual will be referred to using a single random variable $T$ since no latent variables are assumed.</span>
<span id="cb49-134"><a href="#cb49-134"></a></span>
<span id="cb49-135"><a href="#cb49-135"></a><span class="fu">### Cause-specific hazards (CSH)</span></span>
<span id="cb49-136"><a href="#cb49-136"></a></span>
<span id="cb49-137"><a href="#cb49-137"></a>We can plot the CSH functions defined as</span>
<span id="cb49-138"><a href="#cb49-138"></a></span>
<span id="cb49-139"><a href="#cb49-139"></a>$$</span>
<span id="cb49-140"><a href="#cb49-140"></a>h_k(t | x_1) = \lim_{\Delta t \rightarrow 0} \frac{\text{Pr}<span class="co">[</span><span class="ot">t \le T &lt; t + \Delta t, D = k | T \ge t, x_1</span><span class="co">]</span>}{\Delta t}</span>
<span id="cb49-141"><a href="#cb49-141"></a>$$</span>
<span id="cb49-142"><a href="#cb49-142"></a></span>
<span id="cb49-143"><a href="#cb49-143"></a>for the $k^\text{th}$ event showing the instantaneous rate of occurrence of that event</span>
<span id="cb49-144"><a href="#cb49-144"></a></span>
<span id="cb49-147"><a href="#cb49-147"></a><span class="in">```{r}</span></span>
<span id="cb49-148"><a href="#cb49-148"></a>time_seq <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="fl">0.01</span>, <span class="dv">50</span>, <span class="fl">0.01</span>)</span>
<span id="cb49-149"><a href="#cb49-149"></a>hazards <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(</span>
<span id="cb49-150"><a href="#cb49-150"></a>  <span class="fu">tibble</span>(</span>
<span id="cb49-151"><a href="#cb49-151"></a>    <span class="at">Distribution =</span> <span class="st">"Event 1: Weibull(shape = 1.6, scale = 5)"</span>,</span>
<span id="cb49-152"><a href="#cb49-152"></a>    <span class="at">time =</span> time_seq,</span>
<span id="cb49-153"><a href="#cb49-153"></a>    <span class="at">Hazard =</span> <span class="fu">hweibull</span>(time_seq, <span class="at">shape =</span> <span class="fl">1.6</span>, <span class="at">scale =</span> <span class="dv">5</span>)</span>
<span id="cb49-154"><a href="#cb49-154"></a>  ),</span>
<span id="cb49-155"><a href="#cb49-155"></a>  <span class="fu">tibble</span>(</span>
<span id="cb49-156"><a href="#cb49-156"></a>    <span class="at">Distribution =</span> <span class="st">"Event 1: Weibull(shape = 1.6, scale = 7)"</span>,</span>
<span id="cb49-157"><a href="#cb49-157"></a>    <span class="at">time =</span> time_seq,</span>
<span id="cb49-158"><a href="#cb49-158"></a>    <span class="at">Hazard =</span> <span class="fu">hweibull</span>(time_seq, <span class="at">shape =</span> <span class="fl">1.6</span>, <span class="at">scale =</span> <span class="dv">7</span>)</span>
<span id="cb49-159"><a href="#cb49-159"></a>  ),</span>
<span id="cb49-160"><a href="#cb49-160"></a>  <span class="fu">tibble</span>(</span>
<span id="cb49-161"><a href="#cb49-161"></a>    <span class="at">Distribution =</span> <span class="st">"Event 2: Log-logistic(shape = 5, scale = 5)"</span>,</span>
<span id="cb49-162"><a href="#cb49-162"></a>    <span class="at">time =</span> time_seq,</span>
<span id="cb49-163"><a href="#cb49-163"></a>    <span class="at">Hazard =</span> <span class="fu">hllogis</span>(time_seq, <span class="at">shape =</span> <span class="dv">5</span>, <span class="at">scale =</span> <span class="dv">5</span>)</span>
<span id="cb49-164"><a href="#cb49-164"></a>  ),</span>
<span id="cb49-165"><a href="#cb49-165"></a>  <span class="fu">tibble</span>(</span>
<span id="cb49-166"><a href="#cb49-166"></a>    <span class="at">Distribution =</span> <span class="st">"Event 3: Exponential(rate = 5)"</span>,</span>
<span id="cb49-167"><a href="#cb49-167"></a>    <span class="at">time =</span> time_seq,</span>
<span id="cb49-168"><a href="#cb49-168"></a>    <span class="at">Hazard =</span> <span class="fu">hweibull</span>(time_seq, <span class="at">shape =</span> <span class="dv">1</span>, <span class="at">scale =</span> <span class="dv">5</span>)</span>
<span id="cb49-169"><a href="#cb49-169"></a>  )</span>
<span id="cb49-170"><a href="#cb49-170"></a>)</span>
<span id="cb49-171"><a href="#cb49-171"></a></span>
<span id="cb49-172"><a href="#cb49-172"></a>hazards <span class="sc">%&gt;%</span></span>
<span id="cb49-173"><a href="#cb49-173"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> Hazard, <span class="at">group =</span> Distribution, </span>
<span id="cb49-174"><a href="#cb49-174"></a>             <span class="at">linetype =</span> Distribution)) <span class="sc">+</span></span>
<span id="cb49-175"><a href="#cb49-175"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb49-176"><a href="#cb49-176"></a>  <span class="fu">xlab</span>(<span class="st">"Time (t)"</span>) <span class="sc">+</span></span>
<span id="cb49-177"><a href="#cb49-177"></a>  <span class="fu">theme</span>(</span>
<span id="cb49-178"><a href="#cb49-178"></a>    <span class="at">legend.title =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb49-179"><a href="#cb49-179"></a>    <span class="at">legend.position =</span> <span class="st">"bottom"</span></span>
<span id="cb49-180"><a href="#cb49-180"></a>  ) <span class="sc">+</span></span>
<span id="cb49-181"><a href="#cb49-181"></a>  <span class="fu">guides</span>(<span class="at">linetype =</span> <span class="fu">guide_legend</span>(<span class="at">nrow =</span> <span class="dv">2</span>))</span>
<span id="cb49-182"><a href="#cb49-182"></a><span class="in">```</span></span>
<span id="cb49-183"><a href="#cb49-183"></a></span>
<span id="cb49-184"><a href="#cb49-184"></a>I'm using the hazard functions implemented within <span class="in">`flexsurv`</span> (e.g., <span class="in">`flexsurv::hweibull()`</span>). The exponential hazard is constant over time. The log-logistic hazard first rises and then falls with time. The Weibull hazards for the chosen parameters are monotonically increasing functions of time. The hazard for each event is independent of the hazard for all other events.</span>
<span id="cb49-185"><a href="#cb49-185"></a></span>
<span id="cb49-186"><a href="#cb49-186"></a><span class="fu">### Relative contribution to the overall hazard</span></span>
<span id="cb49-187"><a href="#cb49-187"></a></span>
<span id="cb49-188"><a href="#cb49-188"></a>As mentioned in the Hinchliffe and Lambert (2013) paper, it can be useful to look at the relative contribution of the hazard of each event to the overall hazard within each group at each $t$</span>
<span id="cb49-189"><a href="#cb49-189"></a></span>
<span id="cb49-190"><a href="#cb49-190"></a>$$</span>
<span id="cb49-191"><a href="#cb49-191"></a>\text{Pr}<span class="co">[</span><span class="ot">D = k | t \le T &lt; t + \Delta t, T \ge t, x_1</span><span class="co">]</span> = \frac{h_k(t | x_1)}{\sum_{k = 1}^K h_k(t | x_1)}</span>
<span id="cb49-192"><a href="#cb49-192"></a>$$</span>
<span id="cb49-193"><a href="#cb49-193"></a></span>
<span id="cb49-194"><a href="#cb49-194"></a>This can be interpreted as the probability of an event of type $k$ among those who experience an event **at** time $t$ and haven't experienced any of the events before $t$.</span>
<span id="cb49-195"><a href="#cb49-195"></a></span>
<span id="cb49-198"><a href="#cb49-198"></a><span class="in">```{r}</span></span>
<span id="cb49-199"><a href="#cb49-199"></a><span class="co"># prob(cause | event = 1)</span></span>
<span id="cb49-200"><a href="#cb49-200"></a>cause_specific_hazards_by_group <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(</span>
<span id="cb49-201"><a href="#cb49-201"></a>  hazards <span class="sc">%&gt;%</span></span>
<span id="cb49-202"><a href="#cb49-202"></a>    <span class="co"># for x = 0, drop the cause 1 for x = 1</span></span>
<span id="cb49-203"><a href="#cb49-203"></a>    <span class="fu">filter</span>(Distribution <span class="sc">!=</span> <span class="st">"Event 1: Weibull(shape = 1.6, scale = 7)"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb49-204"><a href="#cb49-204"></a>    <span class="fu">mutate</span>(<span class="at">Group =</span> <span class="st">"x1 = 0"</span>),</span>
<span id="cb49-205"><a href="#cb49-205"></a>  hazards <span class="sc">%&gt;%</span></span>
<span id="cb49-206"><a href="#cb49-206"></a>    <span class="co"># for x = 1, drop the cause 1 for x = 0</span></span>
<span id="cb49-207"><a href="#cb49-207"></a>    <span class="fu">filter</span>(Distribution <span class="sc">!=</span> <span class="st">"Event 1: Weibull(shape = 1.6, scale = 5)"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb49-208"><a href="#cb49-208"></a>    <span class="fu">mutate</span>(<span class="at">Group =</span> <span class="st">"x1 = 1"</span>)</span>
<span id="cb49-209"><a href="#cb49-209"></a>)</span>
<span id="cb49-210"><a href="#cb49-210"></a></span>
<span id="cb49-211"><a href="#cb49-211"></a>relative_contribution_to_overall_hazard <span class="ot">&lt;-</span>cause_specific_hazards_by_group <span class="sc">%&gt;%</span></span>
<span id="cb49-212"><a href="#cb49-212"></a>  <span class="fu">arrange</span>(Group, time, Distribution) <span class="sc">%&gt;%</span></span>
<span id="cb49-213"><a href="#cb49-213"></a>  <span class="fu">group_by</span>(Group, time) <span class="sc">%&gt;%</span></span>
<span id="cb49-214"><a href="#cb49-214"></a>  <span class="fu">mutate</span>(<span class="at">overall_hazard =</span> <span class="fu">sum</span>(Hazard), <span class="at">p =</span> Hazard <span class="sc">/</span> overall_hazard) <span class="sc">%&gt;%</span></span>
<span id="cb49-215"><a href="#cb49-215"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb49-216"><a href="#cb49-216"></a></span>
<span id="cb49-217"><a href="#cb49-217"></a>relative_contribution_to_overall_hazard <span class="sc">%&gt;%</span></span>
<span id="cb49-218"><a href="#cb49-218"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> p, </span>
<span id="cb49-219"><a href="#cb49-219"></a>             <span class="at">group =</span> <span class="fu">interaction</span>(Group, Distribution), </span>
<span id="cb49-220"><a href="#cb49-220"></a>             <span class="at">linetype =</span> Distribution)) <span class="sc">+</span></span>
<span id="cb49-221"><a href="#cb49-221"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb49-222"><a href="#cb49-222"></a>  <span class="fu">xlab</span>(<span class="st">"Time (t)"</span>) <span class="sc">+</span></span>
<span id="cb49-223"><a href="#cb49-223"></a>  <span class="fu">ylab</span>(<span class="st">"Pr [event type k | any event]"</span>) <span class="sc">+</span></span>
<span id="cb49-224"><a href="#cb49-224"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> Group) <span class="sc">+</span></span>
<span id="cb49-225"><a href="#cb49-225"></a>  <span class="fu">theme</span>(</span>
<span id="cb49-226"><a href="#cb49-226"></a>    <span class="at">legend.title =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb49-227"><a href="#cb49-227"></a>    <span class="at">legend.position =</span> <span class="st">"bottom"</span></span>
<span id="cb49-228"><a href="#cb49-228"></a>  ) <span class="sc">+</span></span>
<span id="cb49-229"><a href="#cb49-229"></a>  <span class="fu">guides</span>(<span class="at">linetype =</span> <span class="fu">guide_legend</span>(<span class="at">nrow =</span> <span class="dv">2</span>))</span>
<span id="cb49-230"><a href="#cb49-230"></a><span class="in">```</span></span>
<span id="cb49-231"><a href="#cb49-231"></a></span>
<span id="cb49-232"><a href="#cb49-232"></a>For individuals that churn very soon after $t = 0$, they're more likely to have had $D = 3$, followed by $D = 1$, followed by $D = 2$. Events that occur around $t = 5$ are most likely to be $D = 2$ as shown by the long-dash line peaking after that time.</span>
<span id="cb49-233"><a href="#cb49-233"></a></span>
<span id="cb49-234"><a href="#cb49-234"></a><span class="fu">### Cause-specific cumulative incidence function (CIF)</span></span>
<span id="cb49-235"><a href="#cb49-235"></a></span>
<span id="cb49-236"><a href="#cb49-236"></a>A key quantity is the cumulative incidence function (CIF) for each of the $K = 3$ events, which is the probability that an individual will experience event $k$ before time $t$ in the absence of the occurrence of any of the other events</span>
<span id="cb49-237"><a href="#cb49-237"></a></span>
<span id="cb49-238"><a href="#cb49-238"></a>$$</span>
<span id="cb49-239"><a href="#cb49-239"></a>\text{CIF}_k(t|x_1) = \text{Pr}[T \le t, D = k | x_1] = \int_{u=0}^{u=t} h_k(u | x_1) S(u | x_1) du</span>
<span id="cb49-240"><a href="#cb49-240"></a>$$</span>
<span id="cb49-241"><a href="#cb49-241"></a></span>
<span id="cb49-242"><a href="#cb49-242"></a>$h_k(t|x_1)$ is the CSH function, and $S(t|x_1)$ is the overall survivor function in each group. The latter is defined as the probability of being free of any event up to time $t$</span>
<span id="cb49-243"><a href="#cb49-243"></a></span>
<span id="cb49-244"><a href="#cb49-244"></a>$$</span>
<span id="cb49-245"><a href="#cb49-245"></a>S(t | x_1) = \text{Pr}<span class="co">[</span><span class="ot">T &gt; t | x_1</span><span class="co">]</span> =  \text{exp}\Bigg(- \sum_{k = 1}^K H_k(t | x_1)\Bigg)</span>
<span id="cb49-246"><a href="#cb49-246"></a>$$</span>
<span id="cb49-247"><a href="#cb49-247"></a></span>
<span id="cb49-248"><a href="#cb49-248"></a>$H_k(t | x_1)$ is the cumulative hazard function for the $k^{\text{th}}$ event in each group</span>
<span id="cb49-249"><a href="#cb49-249"></a></span>
<span id="cb49-250"><a href="#cb49-250"></a>$$</span>
<span id="cb49-251"><a href="#cb49-251"></a>H_k(t | x_1) = \int_{u = 0}^{u = t} h_k(u | x_1) du </span>
<span id="cb49-252"><a href="#cb49-252"></a>$$</span>
<span id="cb49-253"><a href="#cb49-253"></a></span>
<span id="cb49-254"><a href="#cb49-254"></a>The cumulative hazard functions are used as implemented in <span class="in">`flexsurv`</span> (e.g., <span class="in">`flexsurv::Hweibull()`</span>). In discrete-time, the integral for the CIF is replaced by summation, and $S(u|\cdot)$ in the integrand / summand is replaced with $S(-u | \cdot)$, which is the survival probability at a time point right before $u$. The CIFs and $S(t)$ are probabilities of being in the different states by time $t$</span>
<span id="cb49-255"><a href="#cb49-255"></a></span>
<span id="cb49-258"><a href="#cb49-258"></a><span class="in">```{r}</span></span>
<span id="cb49-259"><a href="#cb49-259"></a><span class="co"># calculate the overall survival from the overall hazard</span></span>
<span id="cb49-260"><a href="#cb49-260"></a>overall_survival <span class="ot">&lt;-</span> time_seq <span class="sc">%&gt;%</span> </span>
<span id="cb49-261"><a href="#cb49-261"></a>  <span class="fu">expand_grid</span>(</span>
<span id="cb49-262"><a href="#cb49-262"></a>    <span class="at">x1 =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>), <span class="at">time =</span> .</span>
<span id="cb49-263"><a href="#cb49-263"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb49-264"><a href="#cb49-264"></a>  <span class="fu">mutate</span>(</span>
<span id="cb49-265"><a href="#cb49-265"></a>    <span class="at">surv =</span> <span class="fu">exp</span>(<span class="sc">-</span>(</span>
<span id="cb49-266"><a href="#cb49-266"></a>      <span class="fu">Hweibull</span>(<span class="at">x =</span> time, <span class="at">shape =</span> <span class="fl">1.6</span>, <span class="at">scale =</span> <span class="fu">exp</span>(<span class="fu">log</span>(<span class="dv">5</span>) <span class="sc">+</span> <span class="fu">log</span>(<span class="fl">1.4</span>) <span class="sc">*</span> x1), </span>
<span id="cb49-267"><a href="#cb49-267"></a>               <span class="at">log =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb49-268"><a href="#cb49-268"></a>      <span class="fu">Hllogis</span>(<span class="at">x =</span> time, <span class="at">shape =</span> <span class="dv">5</span>, <span class="at">scale =</span> <span class="dv">5</span>, <span class="at">log =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb49-269"><a href="#cb49-269"></a>      <span class="fu">Hweibull</span>(<span class="at">x =</span> time, <span class="at">shape =</span> <span class="dv">1</span>, <span class="at">scale =</span> <span class="dv">5</span>, <span class="at">log =</span> <span class="cn">FALSE</span>)</span>
<span id="cb49-270"><a href="#cb49-270"></a>    )),</span>
<span id="cb49-271"><a href="#cb49-271"></a>    <span class="at">Group =</span> <span class="fu">paste0</span>(<span class="st">"x1 = "</span>, x1)</span>
<span id="cb49-272"><a href="#cb49-272"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb49-273"><a href="#cb49-273"></a>  <span class="fu">select</span>(<span class="sc">-</span>x1)</span>
<span id="cb49-274"><a href="#cb49-274"></a></span>
<span id="cb49-275"><a href="#cb49-275"></a>time_step <span class="ot">&lt;-</span> time_seq[<span class="dv">2</span>] <span class="sc">-</span> time_seq[<span class="dv">1</span>]</span>
<span id="cb49-276"><a href="#cb49-276"></a></span>
<span id="cb49-277"><a href="#cb49-277"></a><span class="co"># calculate CIFs</span></span>
<span id="cb49-278"><a href="#cb49-278"></a>cumulative_incidence_curves <span class="ot">&lt;-</span> cause_specific_hazards_by_group <span class="sc">%&gt;%</span></span>
<span id="cb49-279"><a href="#cb49-279"></a>  <span class="fu">inner_join</span>(<span class="at">y =</span> overall_survival, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"Group"</span>, <span class="st">"time"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb49-280"><a href="#cb49-280"></a>  <span class="fu">group_by</span>(Group, Distribution) <span class="sc">%&gt;%</span></span>
<span id="cb49-281"><a href="#cb49-281"></a>  <span class="fu">mutate</span>(<span class="at">CIF =</span> <span class="fu">order_by</span>(time, <span class="fu">cumsum</span>(Hazard <span class="sc">*</span> surv <span class="sc">*</span> time_step))) <span class="sc">%&gt;%</span></span>
<span id="cb49-282"><a href="#cb49-282"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb49-283"><a href="#cb49-283"></a></span>
<span id="cb49-284"><a href="#cb49-284"></a><span class="co"># plot the CIFs</span></span>
<span id="cb49-285"><a href="#cb49-285"></a><span class="co"># P[T &lt;= t, cause = k | Event]</span></span>
<span id="cb49-286"><a href="#cb49-286"></a>cumulative_incidence_curves_plot_data <span class="ot">&lt;-</span> cumulative_incidence_curves <span class="sc">%&gt;%</span></span>
<span id="cb49-287"><a href="#cb49-287"></a>  <span class="fu">select</span>(<span class="sc">-</span>Hazard) <span class="sc">%&gt;%</span></span>
<span id="cb49-288"><a href="#cb49-288"></a>  <span class="fu">pivot_wider</span>(<span class="at">id_cols =</span> <span class="fu">c</span>(time, Group, surv), </span>
<span id="cb49-289"><a href="#cb49-289"></a>              <span class="at">names_from =</span> Distribution, <span class="at">values_from =</span> CIF) <span class="sc">%&gt;%</span></span>
<span id="cb49-290"><a href="#cb49-290"></a>  <span class="fu">rename</span>(<span class="st">`</span><span class="at">Event-free</span><span class="st">`</span> <span class="ot">=</span> surv) <span class="sc">%&gt;%</span></span>
<span id="cb49-291"><a href="#cb49-291"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="sc">-</span><span class="fu">c</span>(time, Group), </span>
<span id="cb49-292"><a href="#cb49-292"></a>               <span class="at">names_to =</span> <span class="st">"Event"</span>, <span class="at">values_to =</span> <span class="st">"CIF"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb49-293"><a href="#cb49-293"></a>  <span class="fu">filter</span>(<span class="fu">complete.cases</span>(.))</span>
<span id="cb49-294"><a href="#cb49-294"></a></span>
<span id="cb49-295"><a href="#cb49-295"></a>cumulative_incidence_curves_plot <span class="ot">&lt;-</span> cumulative_incidence_curves_plot_data <span class="sc">%&gt;%</span></span>
<span id="cb49-296"><a href="#cb49-296"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> CIF, <span class="at">linetype =</span> Event)) <span class="sc">+</span></span>
<span id="cb49-297"><a href="#cb49-297"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb49-298"><a href="#cb49-298"></a>  <span class="fu">xlab</span>(<span class="st">"Time (t)"</span>) <span class="sc">+</span></span>
<span id="cb49-299"><a href="#cb49-299"></a>  <span class="fu">ylab</span>(<span class="st">"Probability of being in state"</span>) <span class="sc">+</span></span>
<span id="cb49-300"><a href="#cb49-300"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> Group) <span class="sc">+</span></span>
<span id="cb49-301"><a href="#cb49-301"></a>  <span class="fu">theme</span>(</span>
<span id="cb49-302"><a href="#cb49-302"></a>    <span class="at">legend.title =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb49-303"><a href="#cb49-303"></a>    <span class="at">legend.position =</span> <span class="st">"bottom"</span></span>
<span id="cb49-304"><a href="#cb49-304"></a>  ) <span class="sc">+</span></span>
<span id="cb49-305"><a href="#cb49-305"></a>  <span class="fu">guides</span>(<span class="at">linetype =</span> <span class="fu">guide_legend</span>(<span class="at">nrow =</span> <span class="dv">3</span>))</span>
<span id="cb49-306"><a href="#cb49-306"></a></span>
<span id="cb49-307"><a href="#cb49-307"></a>cumulative_incidence_curves_plot</span>
<span id="cb49-308"><a href="#cb49-308"></a><span class="in">```</span></span>
<span id="cb49-309"><a href="#cb49-309"></a></span>
<span id="cb49-310"><a href="#cb49-310"></a>The CIFs are called *subdistribution* functions because they never reach 1 (at $t = \infty$) due to the presence of competing events so are not proper probability distributions. In the single event case, the CIF eventually reaches 1 given enough time.</span>
<span id="cb49-311"><a href="#cb49-311"></a></span>
<span id="cb49-312"><a href="#cb49-312"></a>Within each panel, the curves sum to 1 at every time point, since each individual is in one state at each time point</span>
<span id="cb49-313"><a href="#cb49-313"></a></span>
<span id="cb49-314"><a href="#cb49-314"></a>$$</span>
<span id="cb49-315"><a href="#cb49-315"></a>\sum_{k = 1}^K\text{CIF}_k(t | x_1) + S(t | x_1) = 1 = \text{Pr}<span class="co">[</span><span class="ot">T \le t, D = 1 | x_1</span><span class="co">]</span> + \text{Pr}<span class="co">[</span><span class="ot">T \le t, D = 2 | x_1</span><span class="co">]</span> + \text{Pr}<span class="co">[</span><span class="ot">T \le t, D = 3 | x_1</span><span class="co">]</span> + \text{Pr}<span class="co">[</span><span class="ot">T &gt; t | x_1</span><span class="co">]</span></span>
<span id="cb49-316"><a href="#cb49-316"></a>$$</span>
<span id="cb49-317"><a href="#cb49-317"></a></span>
<span id="cb49-318"><a href="#cb49-318"></a>All individuals start with being event free at $t = 0$, but as as time progresses, they move into any one of the $k$ states, so the probability of being event-free, i.e., staying in state $D = 0$, decreases with time and goes to 0 eventually (here around $t = 7$).</span>
<span id="cb49-319"><a href="#cb49-319"></a></span>
<span id="cb49-320"><a href="#cb49-320"></a>One difference between this plot and the unnormalized hazard plot is that here the hazard of each event contributes to the CIF of all other events via it's dependence on the overall survival. So $\text{CIF}_2(t | x1 = 0) \neq \text{CIF}_2(t | x1 = 1)$ and $\text{CIF}_3(t | x1 = 0) \neq \text{CIF}_3(t | x1 = 1)$ because $H_1(t | x_1 = 0) \ne H_1(t | x_1 = 1)$, even though $H_2(t | x_1 = 0) = H_2(t | x_1 = 1)$ and $H_3(t | x_1 = 0) = H_3(t | x_1 = 1)$.</span>
<span id="cb49-321"><a href="#cb49-321"></a></span>
<span id="cb49-322"><a href="#cb49-322"></a><span class="fu">### Relative contribution to overall churn</span></span>
<span id="cb49-323"><a href="#cb49-323"></a></span>
<span id="cb49-324"><a href="#cb49-324"></a>Similar to the relative contribution of the CSHs to overall hazard I came across in the Hinchliffe and Lambert paper, they also mention the rescaled cause-specific CIFs (disregarding $S(t | x_1)$)</span>
<span id="cb49-325"><a href="#cb49-325"></a></span>
<span id="cb49-326"><a href="#cb49-326"></a>$$</span>
<span id="cb49-327"><a href="#cb49-327"></a>\text{Pr}<span class="co">[</span><span class="ot">D = k | T \le t, x_1</span><span class="co">]</span> = \frac{\text{CIF}_k(t | x_1)}{\sum_{k = 1}^K \text{CIF}_k(t | x_1)}</span>
<span id="cb49-328"><a href="#cb49-328"></a>$$</span>
<span id="cb49-329"><a href="#cb49-329"></a></span>
<span id="cb49-330"><a href="#cb49-330"></a>which is the probability of having had event $k$ among those who have churned **by** time $t$ within levels of $x_1$</span>
<span id="cb49-331"><a href="#cb49-331"></a></span>
<span id="cb49-334"><a href="#cb49-334"></a><span class="in">```{r}</span></span>
<span id="cb49-335"><a href="#cb49-335"></a><span class="co"># plot the rescaled CIFs conditional on event</span></span>
<span id="cb49-336"><a href="#cb49-336"></a><span class="co"># so ignores the no even state</span></span>
<span id="cb49-337"><a href="#cb49-337"></a><span class="co"># P[T &lt;= t, cause = k | Event]</span></span>
<span id="cb49-338"><a href="#cb49-338"></a>cumulative_incidence_curves <span class="sc">%&gt;%</span></span>
<span id="cb49-339"><a href="#cb49-339"></a>  <span class="fu">mutate</span>(<span class="at">rescaled_CIF =</span> CIF <span class="sc">/</span> <span class="fu">sum</span>(CIF), <span class="at">.by =</span> <span class="fu">c</span>(Group, time)) <span class="sc">%&gt;%</span></span>
<span id="cb49-340"><a href="#cb49-340"></a>  <span class="co"># arrange(Group, time) %&gt;%</span></span>
<span id="cb49-341"><a href="#cb49-341"></a>  <span class="co"># print()</span></span>
<span id="cb49-342"><a href="#cb49-342"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> rescaled_CIF, <span class="at">linetype =</span> Distribution)) <span class="sc">+</span></span>
<span id="cb49-343"><a href="#cb49-343"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb49-344"><a href="#cb49-344"></a>  <span class="fu">xlab</span>(<span class="st">"Time (t)"</span>) <span class="sc">+</span></span>
<span id="cb49-345"><a href="#cb49-345"></a>  <span class="fu">ylab</span>(<span class="st">"Pr [event type k by t | any event]"</span>) <span class="sc">+</span></span>
<span id="cb49-346"><a href="#cb49-346"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> Group) <span class="sc">+</span></span>
<span id="cb49-347"><a href="#cb49-347"></a>  <span class="fu">theme</span>(</span>
<span id="cb49-348"><a href="#cb49-348"></a>    <span class="at">legend.title =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb49-349"><a href="#cb49-349"></a>    <span class="at">legend.position =</span> <span class="st">"bottom"</span></span>
<span id="cb49-350"><a href="#cb49-350"></a>  ) <span class="sc">+</span></span>
<span id="cb49-351"><a href="#cb49-351"></a>  <span class="fu">guides</span>(<span class="at">linetype =</span> <span class="fu">guide_legend</span>(<span class="at">nrow =</span> <span class="dv">2</span>))</span>
<span id="cb49-352"><a href="#cb49-352"></a><span class="in">```</span></span>
<span id="cb49-353"><a href="#cb49-353"></a></span>
<span id="cb49-354"><a href="#cb49-354"></a><span class="fu">## Implement the simulation steps</span></span>
<span id="cb49-355"><a href="#cb49-355"></a></span>
<span id="cb49-356"><a href="#cb49-356"></a>The key idea behind simulating CR data from the CSH approach is summarized in the following steps (here within each level of covariate $x_1$):</span>
<span id="cb49-357"><a href="#cb49-357"></a></span>
<span id="cb49-358"><a href="#cb49-358"></a><span class="ss">-   </span>specify the cause-specific hazards $h_k(t | x_1)$</span>
<span id="cb49-359"><a href="#cb49-359"></a></span>
<span id="cb49-360"><a href="#cb49-360"></a><span class="ss">-   </span>simulate survival time $T_i$ for the $i^\text{th}$ individual with the all-cause cumulative hazard $\sum_{k=1}^K H_k(t | x_1)$</span>
<span id="cb49-361"><a href="#cb49-361"></a></span>
<span id="cb49-362"><a href="#cb49-362"></a><span class="ss">-   </span>for a simulated $T_i$, simulate the event type $D_i$ from a multinomial distribution with $k$-dimensional probability vector from the scaled hazards $h_k(t | x_1) / \sum_{k = 1}^K h_k(t | x_1)$. This gives the pair $(T_i, D_i)$ for the $i^\text{th}$ individual</span>
<span id="cb49-363"><a href="#cb49-363"></a></span>
<span id="cb49-364"><a href="#cb49-364"></a><span class="ss">-   </span>simulate censoring time $C_i$ and set $T_i  = C_i$ if $C_i &lt; T_i$ (and set $D_i = 0$).</span>
<span id="cb49-365"><a href="#cb49-365"></a></span>
<span id="cb49-366"><a href="#cb49-366"></a>The event time $T_i$ is generated by inverting the survivor function. The CDF $F(t)$ has a $\text{Uniform}<span class="co">[</span><span class="ot">0, 1</span><span class="co">]</span>$ distribution where $F(t_i) = u_i \sim U<span class="co">[</span><span class="ot">0, 1</span><span class="co">]</span>$. We can use $F(t) = 1 - S(t)$ to equate $S(t) = 1 - u$ which gives</span>
<span id="cb49-367"><a href="#cb49-367"></a></span>
<span id="cb49-368"><a href="#cb49-368"></a>$$</span>
<span id="cb49-369"><a href="#cb49-369"></a>1 - u = \text{exp}\Bigg<span class="co">[</span><span class="ot">- \sum_{k = 1}^K H_k(t) \Bigg</span><span class="co">]</span></span>
<span id="cb49-370"><a href="#cb49-370"></a>$$</span>
<span id="cb49-371"><a href="#cb49-371"></a></span>
<span id="cb49-372"><a href="#cb49-372"></a>Taking logs on both sides and rearranging gives the objective function</span>
<span id="cb49-373"><a href="#cb49-373"></a></span>
<span id="cb49-374"><a href="#cb49-374"></a>$$</span>
<span id="cb49-375"><a href="#cb49-375"></a>\text{log}(1 - u) + \sum_{k = 1}^K H_k(t) = 0</span>
<span id="cb49-376"><a href="#cb49-376"></a>$$</span>
<span id="cb49-377"><a href="#cb49-377"></a></span>
<span id="cb49-378"><a href="#cb49-378"></a>For a randomly drawn $u_i \sim U<span class="co">[</span><span class="ot">0,1</span><span class="co">]</span>$ (and given $x_{i, 1}$), numerical root finding methods can be employed to estimate the value of $t_i$ which satisfies this equation. This process of using $u_i$ to estimate $t_i$ is known as <span class="co">[</span><span class="ot">inverse transform sampling</span><span class="co">](https://en.wikipedia.org/wiki/Inverse_transform_sampling)</span>.</span>
<span id="cb49-379"><a href="#cb49-379"></a></span>
<span id="cb49-380"><a href="#cb49-380"></a><span class="fu">### Overall hazard</span></span>
<span id="cb49-381"><a href="#cb49-381"></a></span>
<span id="cb49-382"><a href="#cb49-382"></a>This function implements the sum of the cumulative hazards $H_k(t | x_1)$ which is 0 at $t = 0$ but increases without bound beyond that</span>
<span id="cb49-383"><a href="#cb49-383"></a></span>
<span id="cb49-386"><a href="#cb49-386"></a><span class="in">```{r}</span></span>
<span id="cb49-387"><a href="#cb49-387"></a><span class="co">#| code-fold: false</span></span>
<span id="cb49-388"><a href="#cb49-388"></a></span>
<span id="cb49-389"><a href="#cb49-389"></a>all_cause_cumulative_hazards <span class="ot">&lt;-</span> <span class="cf">function</span>(t, x1) {</span>
<span id="cb49-390"><a href="#cb49-390"></a>  <span class="fu">sum</span>(</span>
<span id="cb49-391"><a href="#cb49-391"></a>    <span class="fu">Hweibull</span>(<span class="at">x =</span> t, <span class="at">shape =</span> <span class="fl">1.6</span>, <span class="at">scale =</span> <span class="fu">exp</span>(<span class="fu">log</span>(<span class="dv">5</span>) <span class="sc">+</span> <span class="fu">log</span>(<span class="fl">1.4</span>) <span class="sc">*</span> x1), <span class="at">log =</span> <span class="cn">FALSE</span>),</span>
<span id="cb49-392"><a href="#cb49-392"></a>    <span class="fu">Hllogis</span>(<span class="at">x =</span> t, <span class="at">shape =</span> <span class="dv">5</span>, <span class="at">scale =</span> <span class="dv">5</span>, <span class="at">log =</span> <span class="cn">FALSE</span>),</span>
<span id="cb49-393"><a href="#cb49-393"></a>    <span class="fu">Hweibull</span>(<span class="at">x =</span> t, <span class="at">shape =</span> <span class="dv">1</span>, <span class="at">scale =</span> <span class="dv">5</span>, <span class="at">log =</span> <span class="cn">FALSE</span>)</span>
<span id="cb49-394"><a href="#cb49-394"></a>  )</span>
<span id="cb49-395"><a href="#cb49-395"></a>}</span>
<span id="cb49-396"><a href="#cb49-396"></a></span>
<span id="cb49-397"><a href="#cb49-397"></a><span class="fu">all_cause_cumulative_hazards</span>(<span class="at">t =</span> <span class="dv">0</span>, <span class="at">x1 =</span> <span class="dv">0</span>)</span>
<span id="cb49-398"><a href="#cb49-398"></a><span class="fu">all_cause_cumulative_hazards</span>(<span class="at">t =</span> <span class="dv">10</span>, <span class="at">x1 =</span> <span class="dv">0</span>)</span>
<span id="cb49-399"><a href="#cb49-399"></a><span class="fu">all_cause_cumulative_hazards</span>(<span class="at">t =</span> <span class="dv">10</span>, <span class="at">x1 =</span> <span class="dv">1</span>)</span>
<span id="cb49-400"><a href="#cb49-400"></a><span class="in">```</span></span>
<span id="cb49-401"><a href="#cb49-401"></a></span>
<span id="cb49-402"><a href="#cb49-402"></a><span class="fu">### Event type probabilities</span></span>
<span id="cb49-403"><a href="#cb49-403"></a></span>
<span id="cb49-404"><a href="#cb49-404"></a>This next one calculates the event probabilities (conditional on an event at $t$) $\text{Pr}<span class="co">[</span><span class="ot">D = k | t \le T &lt; t + \Delta t, T \ge t, x_1</span><span class="co">]</span>$ given $t$ and $x_1$</span>
<span id="cb49-405"><a href="#cb49-405"></a></span>
<span id="cb49-408"><a href="#cb49-408"></a><span class="in">```{r}</span></span>
<span id="cb49-409"><a href="#cb49-409"></a><span class="co">#| code-fold: false</span></span>
<span id="cb49-410"><a href="#cb49-410"></a></span>
<span id="cb49-411"><a href="#cb49-411"></a>cause_specific_probabilities <span class="ot">&lt;-</span> <span class="cf">function</span>(t, x1) {</span>
<span id="cb49-412"><a href="#cb49-412"></a>  hazards <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb49-413"><a href="#cb49-413"></a>    <span class="fu">hweibull</span>(<span class="at">x =</span> t, <span class="at">shape =</span> <span class="fl">1.6</span>, </span>
<span id="cb49-414"><a href="#cb49-414"></a>             <span class="at">scale =</span> <span class="fu">exp</span>(<span class="fu">log</span>(<span class="dv">5</span>) <span class="sc">+</span> <span class="fu">log</span>(<span class="fl">1.4</span>) <span class="sc">*</span> x1), <span class="at">log =</span> <span class="cn">FALSE</span>),</span>
<span id="cb49-415"><a href="#cb49-415"></a>    <span class="fu">hllogis</span>(<span class="at">x =</span> t, <span class="at">shape =</span> <span class="dv">5</span>, <span class="at">scale =</span> <span class="dv">5</span>, <span class="at">log =</span> <span class="cn">FALSE</span>),</span>
<span id="cb49-416"><a href="#cb49-416"></a>    <span class="fu">hweibull</span>(<span class="at">x =</span> t, <span class="at">shape =</span> <span class="dv">1</span>, <span class="at">scale =</span> <span class="dv">5</span>, <span class="at">log =</span> <span class="cn">FALSE</span>)</span>
<span id="cb49-417"><a href="#cb49-417"></a>  )</span>
<span id="cb49-418"><a href="#cb49-418"></a></span>
<span id="cb49-419"><a href="#cb49-419"></a>  hazards <span class="sc">/</span> <span class="fu">sum</span>(hazards)</span>
<span id="cb49-420"><a href="#cb49-420"></a>}</span>
<span id="cb49-421"><a href="#cb49-421"></a></span>
<span id="cb49-422"><a href="#cb49-422"></a><span class="fu">cause_specific_probabilities</span>(<span class="at">t =</span> <span class="dv">0</span>, <span class="at">x1 =</span> <span class="dv">0</span>)</span>
<span id="cb49-423"><a href="#cb49-423"></a><span class="fu">cause_specific_probabilities</span>(<span class="at">t =</span> <span class="dv">10</span>, <span class="at">x1 =</span> <span class="dv">0</span>)</span>
<span id="cb49-424"><a href="#cb49-424"></a><span class="fu">cause_specific_probabilities</span>(<span class="at">t =</span> <span class="dv">10</span>, <span class="at">x1 =</span> <span class="dv">1</span>)</span>
<span id="cb49-425"><a href="#cb49-425"></a><span class="in">```</span></span>
<span id="cb49-426"><a href="#cb49-426"></a></span>
<span id="cb49-427"><a href="#cb49-427"></a>The function returns a $K$-dimensional vector which sums to 1.</span>
<span id="cb49-428"><a href="#cb49-428"></a></span>
<span id="cb49-429"><a href="#cb49-429"></a><span class="fu">### Objective function</span></span>
<span id="cb49-430"><a href="#cb49-430"></a></span>
<span id="cb49-431"><a href="#cb49-431"></a>Implement the objective function</span>
<span id="cb49-432"><a href="#cb49-432"></a></span>
<span id="cb49-435"><a href="#cb49-435"></a><span class="in">```{r}</span></span>
<span id="cb49-436"><a href="#cb49-436"></a><span class="co">#| code-fold: false</span></span>
<span id="cb49-437"><a href="#cb49-437"></a></span>
<span id="cb49-438"><a href="#cb49-438"></a>obj_fun <span class="ot">&lt;-</span> <span class="cf">function</span>(t, u, x1) {</span>
<span id="cb49-439"><a href="#cb49-439"></a>  <span class="fu">log</span>(<span class="dv">1</span> <span class="sc">-</span> u) <span class="sc">+</span> <span class="fu">all_cause_cumulative_hazards</span>(t, x1)</span>
<span id="cb49-440"><a href="#cb49-440"></a>}</span>
<span id="cb49-441"><a href="#cb49-441"></a></span>
<span id="cb49-442"><a href="#cb49-442"></a><span class="fu">obj_fun</span>(<span class="at">t =</span> <span class="fl">3.771</span>, <span class="at">u =</span> <span class="fl">0.8</span>, <span class="at">x1 =</span> <span class="dv">0</span>)</span>
<span id="cb49-443"><a href="#cb49-443"></a></span>
<span id="cb49-444"><a href="#cb49-444"></a><span class="fu">tibble</span>(</span>
<span id="cb49-445"><a href="#cb49-445"></a>  <span class="at">time =</span> time_seq[time_seq <span class="sc">&lt;</span> <span class="fl">10.0</span>], </span>
<span id="cb49-446"><a href="#cb49-446"></a>  <span class="at">obj_val =</span> <span class="fu">map_dbl</span>(</span>
<span id="cb49-447"><a href="#cb49-447"></a>    <span class="at">.x =</span> time, </span>
<span id="cb49-448"><a href="#cb49-448"></a>    <span class="at">.f =</span> <span class="sc">~</span> <span class="fu">obj_fun</span>(.x, <span class="at">u =</span> <span class="fl">0.8</span>, <span class="at">x1 =</span> <span class="dv">0</span>)</span>
<span id="cb49-449"><a href="#cb49-449"></a>    )</span>
<span id="cb49-450"><a href="#cb49-450"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb49-451"><a href="#cb49-451"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> obj_val)) <span class="sc">+</span> </span>
<span id="cb49-452"><a href="#cb49-452"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span> </span>
<span id="cb49-453"><a href="#cb49-453"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">linetype =</span> <span class="st">"dotted"</span>) <span class="sc">+</span> </span>
<span id="cb49-454"><a href="#cb49-454"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="fl">3.771</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>) <span class="sc">+</span> </span>
<span id="cb49-455"><a href="#cb49-455"></a>  <span class="fu">xlab</span>(<span class="st">"Time (t)"</span>) <span class="sc">+</span> </span>
<span id="cb49-456"><a href="#cb49-456"></a>  <span class="fu">ylab</span>(<span class="st">"Objective function"</span>)</span>
<span id="cb49-457"><a href="#cb49-457"></a><span class="in">```</span></span>
<span id="cb49-458"><a href="#cb49-458"></a></span>
<span id="cb49-459"><a href="#cb49-459"></a>This plot corresponding to a grid search on $t \in (0, 10)$ shows that for $u_i = 0.8$, $t_i \approx 3.771$ (dashed vertical line) is very close to the root since the objective function evaluates to approximately -0.00012.</span>
<span id="cb49-460"><a href="#cb49-460"></a></span>
<span id="cb49-461"><a href="#cb49-461"></a>Doing grid search is kinda tedious, but we can use <span class="in">`stats::uniroot`</span> to find the root $t_i$ for a given $u_i$ (and $x_{i, 1}$) and return the pair $(T_i, D_i)$.</span>
<span id="cb49-462"><a href="#cb49-462"></a></span>
<span id="cb49-463"><a href="#cb49-463"></a><span class="fu">### Simulate single outcome</span></span>
<span id="cb49-464"><a href="#cb49-464"></a></span>
<span id="cb49-467"><a href="#cb49-467"></a><span class="in">```{r}</span></span>
<span id="cb49-468"><a href="#cb49-468"></a><span class="co">#| code-fold: false</span></span>
<span id="cb49-469"><a href="#cb49-469"></a></span>
<span id="cb49-470"><a href="#cb49-470"></a>simulate_single_outcome <span class="ot">&lt;-</span> <span class="cf">function</span>(u, x1, <span class="at">admin_censor_time =</span> <span class="dv">5</span>, <span class="at">lower_bound_time =</span> <span class="fl">1e-10</span>) {</span>
<span id="cb49-471"><a href="#cb49-471"></a></span>
<span id="cb49-472"><a href="#cb49-472"></a>  <span class="co"># check whether simulated time would lie outside the time interval we want to solve for</span></span>
<span id="cb49-473"><a href="#cb49-473"></a>  <span class="co"># in this case the function would have the same sign at the interval endpoints</span></span>
<span id="cb49-474"><a href="#cb49-474"></a>  <span class="co"># if the function has different signs at the endpoints then a root is within the interval</span></span>
<span id="cb49-475"><a href="#cb49-475"></a>  same_sign <span class="ot">&lt;-</span> (<span class="fu">obj_fun</span>(<span class="at">u =</span> u, <span class="at">t =</span> <span class="fl">0.00001</span>, <span class="at">x1 =</span> x1) <span class="sc">*</span> <span class="fu">obj_fun</span>(<span class="at">u =</span> u, <span class="at">t =</span> admin_censor_time, <span class="at">x1 =</span> x1)) <span class="sc">&gt;</span> <span class="dv">0</span></span>
<span id="cb49-476"><a href="#cb49-476"></a></span>
<span id="cb49-477"><a href="#cb49-477"></a>  <span class="cf">if</span> (same_sign) {</span>
<span id="cb49-478"><a href="#cb49-478"></a>    time <span class="ot">&lt;-</span> admin_censor_time</span>
<span id="cb49-479"><a href="#cb49-479"></a>    cause <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb49-480"><a href="#cb49-480"></a>    iter <span class="ot">&lt;-</span> <span class="cn">NA_real_</span></span>
<span id="cb49-481"><a href="#cb49-481"></a>    fn_value_at_root <span class="ot">&lt;-</span> <span class="cn">NA_real_</span></span>
<span id="cb49-482"><a href="#cb49-482"></a>  } <span class="cf">else</span> {</span>
<span id="cb49-483"><a href="#cb49-483"></a>    <span class="co"># for a handful of cases (out of 100,000s) we can end up with t = 0 from a distribution that doesn't support it</span></span>
<span id="cb49-484"><a href="#cb49-484"></a>    <span class="co"># https://stats.stackexchange.com/questions/176376/invalid-survival-times-for-this-distribution</span></span>
<span id="cb49-485"><a href="#cb49-485"></a>    <span class="co"># so we can set a lower bound on time &gt; 0</span></span>
<span id="cb49-486"><a href="#cb49-486"></a>    uniroot_obj <span class="ot">&lt;-</span> <span class="fu">uniroot</span>(</span>
<span id="cb49-487"><a href="#cb49-487"></a>      <span class="at">f =</span> obj_fun, </span>
<span id="cb49-488"><a href="#cb49-488"></a>      <span class="at">interval =</span> <span class="fu">c</span>(lower_bound_time, admin_censor_time), </span>
<span id="cb49-489"><a href="#cb49-489"></a>      <span class="co"># pass arguments to the objective function</span></span>
<span id="cb49-490"><a href="#cb49-490"></a>      <span class="at">u =</span> u, <span class="at">x1 =</span> x1</span>
<span id="cb49-491"><a href="#cb49-491"></a>    )</span>
<span id="cb49-492"><a href="#cb49-492"></a>    time <span class="ot">&lt;-</span> uniroot_obj<span class="sc">$</span>root</span>
<span id="cb49-493"><a href="#cb49-493"></a>    cause <span class="ot">&lt;-</span> <span class="fu">which.max</span>(</span>
<span id="cb49-494"><a href="#cb49-494"></a>      <span class="fu">rmultinom</span>(<span class="dv">1</span>, <span class="dv">1</span>, <span class="fu">cause_specific_probabilities</span>(<span class="at">t =</span> time, <span class="at">x1 =</span> x1))</span>
<span id="cb49-495"><a href="#cb49-495"></a>    )</span>
<span id="cb49-496"><a href="#cb49-496"></a>    iter <span class="ot">&lt;-</span> uniroot_obj<span class="sc">$</span>iter</span>
<span id="cb49-497"><a href="#cb49-497"></a>    fn_value_at_root <span class="ot">&lt;-</span> uniroot_obj<span class="sc">$</span>f.root</span>
<span id="cb49-498"><a href="#cb49-498"></a>  }</span>
<span id="cb49-499"><a href="#cb49-499"></a></span>
<span id="cb49-500"><a href="#cb49-500"></a>  <span class="fu">tibble</span>(u, x1, admin_censor_time, iter, fn_value_at_root, time, cause)</span>
<span id="cb49-501"><a href="#cb49-501"></a>}</span>
<span id="cb49-502"><a href="#cb49-502"></a></span>
<span id="cb49-503"><a href="#cb49-503"></a><span class="fu">bind_rows</span>(</span>
<span id="cb49-504"><a href="#cb49-504"></a>  <span class="co"># non-censored</span></span>
<span id="cb49-505"><a href="#cb49-505"></a>  <span class="fu">simulate_single_outcome</span>(<span class="at">u =</span> <span class="fl">0.2</span>, <span class="at">x1 =</span> <span class="dv">1</span>, <span class="at">admin_censor_time =</span> <span class="dv">5</span>),</span>
<span id="cb49-506"><a href="#cb49-506"></a>  <span class="co"># censored</span></span>
<span id="cb49-507"><a href="#cb49-507"></a>  <span class="fu">simulate_single_outcome</span>(<span class="at">u =</span> <span class="fl">0.95</span>, <span class="at">x1 =</span> <span class="dv">1</span>, <span class="at">admin_censor_time =</span> <span class="dv">5</span>),</span>
<span id="cb49-508"><a href="#cb49-508"></a>  <span class="co"># same u but larger admin censored time means not censored</span></span>
<span id="cb49-509"><a href="#cb49-509"></a>  <span class="fu">simulate_single_outcome</span>(<span class="at">u =</span> <span class="fl">0.95</span>, <span class="at">x1 =</span> <span class="dv">1</span>, <span class="at">admin_censor_time =</span> <span class="dv">12</span>)</span>
<span id="cb49-510"><a href="#cb49-510"></a>)</span>
<span id="cb49-511"><a href="#cb49-511"></a><span class="in">```</span></span>
<span id="cb49-512"><a href="#cb49-512"></a></span>
<span id="cb49-513"><a href="#cb49-513"></a>A lower bound of $t$ close to 0 is applied to avoid ending up with estimates of exactly 0, which can cause problems with estimation for some parametric distributions. If the drawn $u_i$ is large enough that the objective function has the same sign at both endpoints of the interval, then we skip the root finding as that observation would be treated as censored anyway.</span>
<span id="cb49-514"><a href="#cb49-514"></a></span>
<span id="cb49-515"><a href="#cb49-515"></a>Administrative censoring at $t = 5$ is assumed, which should lead to about 7% censored individuals in $x_1 = 0$ and 10% in $x_1 = 1$ (and about 8-9% overall) as seen in this zoomed-in version of the CIF plot (from a few sections above)</span>
<span id="cb49-516"><a href="#cb49-516"></a></span>
<span id="cb49-519"><a href="#cb49-519"></a><span class="in">```{r}</span></span>
<span id="cb49-520"><a href="#cb49-520"></a>cumulative_incidence_curves_plot <span class="sc">+</span> </span>
<span id="cb49-521"><a href="#cb49-521"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="fl">5.0</span>, <span class="at">color =</span> <span class="st">"forestgreen"</span>) <span class="sc">+</span></span>
<span id="cb49-522"><a href="#cb49-522"></a>  <span class="fu">geom_hline</span>(</span>
<span id="cb49-523"><a href="#cb49-523"></a>    <span class="at">data =</span> <span class="fu">tibble</span>(<span class="at">Group =</span> <span class="fu">c</span>(<span class="st">"x1 = 0"</span>, <span class="st">"x1 = 1"</span>), <span class="at">y =</span> <span class="fu">c</span>(<span class="fl">0.068</span>, <span class="fl">0.102</span>)),</span>
<span id="cb49-524"><a href="#cb49-524"></a>    <span class="fu">aes</span>(<span class="at">yintercept =</span> y), <span class="at">color =</span> <span class="st">"purple"</span></span>
<span id="cb49-525"><a href="#cb49-525"></a>  ) <span class="sc">+</span></span>
<span id="cb49-526"><a href="#cb49-526"></a>  <span class="fu">coord_cartesian</span>(<span class="at">xlim =</span> <span class="fu">c</span>(<span class="fl">4.5</span>, <span class="dv">6</span>), <span class="at">ylim =</span> <span class="fu">c</span>(<span class="fl">0.05</span>, <span class="fl">0.12</span>))</span>
<span id="cb49-527"><a href="#cb49-527"></a><span class="in">```</span></span>
<span id="cb49-528"><a href="#cb49-528"></a></span>
<span id="cb49-529"><a href="#cb49-529"></a><span class="fu">### Simulate single dataset</span></span>
<span id="cb49-530"><a href="#cb49-530"></a></span>
<span id="cb49-531"><a href="#cb49-531"></a>Finally, the next function stitches together the steps for simulating a full dataset with $n = 1,000$ individuals and their group indicator $x_{i, 1} \in <span class="sc">\{</span>0, 1<span class="sc">\}</span>$, event time $T_i$, and event indicator $D_i \in <span class="sc">\{</span>0, 1, 2, 3<span class="sc">\}</span>$.</span>
<span id="cb49-532"><a href="#cb49-532"></a></span>
<span id="cb49-535"><a href="#cb49-535"></a><span class="in">```{r}</span></span>
<span id="cb49-536"><a href="#cb49-536"></a><span class="co">#| code-fold: false</span></span>
<span id="cb49-537"><a href="#cb49-537"></a></span>
<span id="cb49-538"><a href="#cb49-538"></a>simulate_single_dataset <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">n_rows =</span> <span class="dv">1000</span>, <span class="at">prop_x1 =</span> <span class="fl">0.5</span>, <span class="at">seed =</span> <span class="dv">12345</span>) {</span>
<span id="cb49-539"><a href="#cb49-539"></a>  <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.null</span>(seed)) <span class="fu">set.seed</span>(seed)</span>
<span id="cb49-540"><a href="#cb49-540"></a>  x1 <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(<span class="at">n =</span> n_rows, <span class="at">size =</span> <span class="dv">1</span>, <span class="at">prob =</span> prop_x1)</span>
<span id="cb49-541"><a href="#cb49-541"></a>  u <span class="ot">&lt;-</span> <span class="fu">runif</span>(n_rows)</span>
<span id="cb49-542"><a href="#cb49-542"></a>  <span class="dv">1</span><span class="sc">:</span>n_rows <span class="sc">%&gt;%</span> </span>
<span id="cb49-543"><a href="#cb49-543"></a>    <span class="fu">map</span>(<span class="at">.f =</span> <span class="sc">~</span> <span class="fu">simulate_single_outcome</span>(<span class="at">u =</span> u[.x], <span class="at">x1 =</span> x1[.x])) <span class="sc">%&gt;%</span></span>
<span id="cb49-544"><a href="#cb49-544"></a>    <span class="fu">list_rbind</span>()</span>
<span id="cb49-545"><a href="#cb49-545"></a>}</span>
<span id="cb49-546"><a href="#cb49-546"></a></span>
<span id="cb49-547"><a href="#cb49-547"></a><span class="fu">simulate_single_dataset</span>(<span class="at">n_rows =</span> <span class="dv">5</span>)</span>
<span id="cb49-548"><a href="#cb49-548"></a><span class="in">```</span></span>
<span id="cb49-549"><a href="#cb49-549"></a></span>
<span id="cb49-550"><a href="#cb49-550"></a><span class="fu">## Test the implementation</span></span>
<span id="cb49-551"><a href="#cb49-551"></a></span>
<span id="cb49-552"><a href="#cb49-552"></a><span class="fu">### Parameter estimates</span></span>
<span id="cb49-553"><a href="#cb49-553"></a></span>
<span id="cb49-554"><a href="#cb49-554"></a>To check that the simulation function works, a bunch of functions are defined in the next code chunk that take a single simulated dataset, convert it into cause-specific datasets (for each event type $k$, update the event indicator by censoring competing events), fit a (correctly specified) parametric model separately to each cause-specific dataset, extract the coefficients from each model, and return them as a data frame.</span>
<span id="cb49-555"><a href="#cb49-555"></a></span>
<span id="cb49-558"><a href="#cb49-558"></a><span class="in">```{r}</span></span>
<span id="cb49-559"><a href="#cb49-559"></a><span class="co">#| code-fold: false</span></span>
<span id="cb49-560"><a href="#cb49-560"></a></span>
<span id="cb49-561"><a href="#cb49-561"></a>create_cause_specific_datasets <span class="ot">&lt;-</span> <span class="cf">function</span>(data) {</span>
<span id="cb49-562"><a href="#cb49-562"></a>  <span class="fu">map</span>(</span>
<span id="cb49-563"><a href="#cb49-563"></a>    <span class="at">.x =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>,</span>
<span id="cb49-564"><a href="#cb49-564"></a>    <span class="at">.f =</span> <span class="sc">~</span> {</span>
<span id="cb49-565"><a href="#cb49-565"></a>      data <span class="sc">%&gt;%</span></span>
<span id="cb49-566"><a href="#cb49-566"></a>        <span class="fu">select</span>(x1, time, cause) <span class="sc">%&gt;%</span></span>
<span id="cb49-567"><a href="#cb49-567"></a>        <span class="fu">mutate</span>(<span class="at">event =</span> <span class="fu">as.numeric</span>(cause <span class="sc">==</span> .x))</span>
<span id="cb49-568"><a href="#cb49-568"></a>    }</span>
<span id="cb49-569"><a href="#cb49-569"></a>  )</span>
<span id="cb49-570"><a href="#cb49-570"></a>}</span>
<span id="cb49-571"><a href="#cb49-571"></a></span>
<span id="cb49-572"><a href="#cb49-572"></a>fit_cause_specific_models <span class="ot">&lt;-</span> <span class="cf">function</span>(cause_specific_datasets, <span class="at">distributions =</span> <span class="fu">c</span>(<span class="st">"weibull"</span>, <span class="st">"llogis"</span>, <span class="st">"weibull"</span>)) {</span>
<span id="cb49-573"><a href="#cb49-573"></a>  <span class="fu">map2</span>(</span>
<span id="cb49-574"><a href="#cb49-574"></a>    <span class="at">.x =</span> cause_specific_datasets,</span>
<span id="cb49-575"><a href="#cb49-575"></a>    <span class="at">.y =</span> distributions,</span>
<span id="cb49-576"><a href="#cb49-576"></a>    <span class="at">.f =</span> <span class="sc">~</span> <span class="fu">flexsurvreg</span>(<span class="fu">Surv</span>(<span class="at">time =</span> time, <span class="at">event =</span> event) <span class="sc">~</span> x1, <span class="at">data =</span> .x, <span class="at">dist =</span> .y)</span>
<span id="cb49-577"><a href="#cb49-577"></a>  )</span>
<span id="cb49-578"><a href="#cb49-578"></a>}</span>
<span id="cb49-579"><a href="#cb49-579"></a></span>
<span id="cb49-580"><a href="#cb49-580"></a>extract_coefs <span class="ot">&lt;-</span> <span class="cf">function</span>(list_models) {</span>
<span id="cb49-581"><a href="#cb49-581"></a>  <span class="fu">map2_dfr</span>(<span class="at">.x =</span> list_models, <span class="at">.y =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(list_models), <span class="at">.f =</span> <span class="sc">~</span> {</span>
<span id="cb49-582"><a href="#cb49-582"></a>    .x <span class="sc">%&gt;%</span></span>
<span id="cb49-583"><a href="#cb49-583"></a>      <span class="co"># calls flexsurv:::tidy.flexsurvreg()</span></span>
<span id="cb49-584"><a href="#cb49-584"></a>      flexsurv<span class="sc">::</span><span class="fu">tidy</span>() <span class="sc">%&gt;%</span></span>
<span id="cb49-585"><a href="#cb49-585"></a>      <span class="fu">select</span>(term, estimate, <span class="at">se =</span> std.error) <span class="sc">%&gt;%</span></span>
<span id="cb49-586"><a href="#cb49-586"></a>      <span class="fu">mutate</span>(<span class="at">cause =</span> .y, <span class="at">.before =</span> term)</span>
<span id="cb49-587"><a href="#cb49-587"></a>  })</span>
<span id="cb49-588"><a href="#cb49-588"></a>}</span>
<span id="cb49-589"><a href="#cb49-589"></a></span>
<span id="cb49-590"><a href="#cb49-590"></a>run_pipeline <span class="ot">&lt;-</span> <span class="cf">function</span>(seed) {</span>
<span id="cb49-591"><a href="#cb49-591"></a>  seed <span class="sc">%&gt;%</span></span>
<span id="cb49-592"><a href="#cb49-592"></a>    <span class="fu">simulate_single_dataset</span>(<span class="at">seed =</span> .) <span class="sc">%&gt;%</span></span>
<span id="cb49-593"><a href="#cb49-593"></a>    <span class="fu">create_cause_specific_datasets</span>() <span class="sc">%&gt;%</span></span>
<span id="cb49-594"><a href="#cb49-594"></a>    <span class="fu">fit_cause_specific_models</span>() <span class="sc">%&gt;%</span></span>
<span id="cb49-595"><a href="#cb49-595"></a>    <span class="fu">extract_coefs</span>() <span class="sc">%&gt;%</span></span>
<span id="cb49-596"><a href="#cb49-596"></a>    <span class="fu">mutate</span>(<span class="at">rep =</span> seed, <span class="at">.before =</span> cause)</span>
<span id="cb49-597"><a href="#cb49-597"></a>}</span>
<span id="cb49-598"><a href="#cb49-598"></a></span>
<span id="cb49-599"><a href="#cb49-599"></a><span class="co"># wrap it up into purrr::safely() since it fails </span></span>
<span id="cb49-600"><a href="#cb49-600"></a><span class="co"># for some seeds (e.g. 125)</span></span>
<span id="cb49-601"><a href="#cb49-601"></a>safely_run_pipeline <span class="ot">&lt;-</span> <span class="fu">safely</span>(run_pipeline)</span>
<span id="cb49-602"><a href="#cb49-602"></a></span>
<span id="cb49-603"><a href="#cb49-603"></a><span class="fu">safely_run_pipeline</span>(<span class="at">seed =</span> <span class="dv">3</span>)</span>
<span id="cb49-604"><a href="#cb49-604"></a><span class="in">```</span></span>
<span id="cb49-605"><a href="#cb49-605"></a></span>
<span id="cb49-606"><a href="#cb49-606"></a>The <span class="in">`safely_run_pipeline()`</span> function returns the point estimates and standard errors for the shape, scale, and coefficient for $x_1$ from each cause-specific model.</span>
<span id="cb49-607"><a href="#cb49-607"></a></span>
<span id="cb49-608"><a href="#cb49-608"></a>This process is repeated 5,000 times. A single run takes about 1.6 seconds on my machine, so to save time, the runs are parallelized. Using the recently added <span class="in">`purrr::in_parallel`</span> function cuts down the total execution time from a little over 2 hours to about 20 minutes (it still took 3x longer than I expected, so I'd like to look into that later — overhead is expected from parallelization but not 3x. Maybe it would have been better to use fewer cores.).</span>
<span id="cb49-609"><a href="#cb49-609"></a></span>
<span id="cb49-610"><a href="#cb49-610"></a>Using the version of <span class="in">`purrr`</span> at the time of writing, <span class="in">`in_parallel`</span> requires that all these functions defined above are nested into one big function which can then be shipped off to the executors. All the package functions should be explicitly namespaced via <span class="in">`package::fun()`</span> as well. The full script for running this pipeline is <span class="co">[</span><span class="ot">here</span><span class="co">](https://github.com/ad1729/ad1729.github.io/tree/master/posts/simulating-and-modelling-competing-risk-data/nested-simulation-functions-for-parallel-run.R)</span>.</span>
<span id="cb49-611"><a href="#cb49-611"></a></span>
<span id="cb49-612"><a href="#cb49-612"></a>Saved results can be read back in. About 44 or 0.9% of the simulations (with the following seeds) failed at some step.</span>
<span id="cb49-613"><a href="#cb49-613"></a></span>
<span id="cb49-616"><a href="#cb49-616"></a><span class="in">```{r}</span></span>
<span id="cb49-617"><a href="#cb49-617"></a>n_reps <span class="ot">&lt;-</span> <span class="dv">5000</span></span>
<span id="cb49-618"><a href="#cb49-618"></a>failed_parallel_runs <span class="ot">&lt;-</span> <span class="fu">read_rds</span>(<span class="st">"saved_objects/failed_parallel_runs.rds"</span>)</span>
<span id="cb49-619"><a href="#cb49-619"></a>failed_parallel_runs</span>
<span id="cb49-620"><a href="#cb49-620"></a><span class="fu">length</span>(failed_parallel_runs) <span class="sc">/</span> n_reps</span>
<span id="cb49-621"><a href="#cb49-621"></a><span class="in">```</span></span>
<span id="cb49-622"><a href="#cb49-622"></a></span>
<span id="cb49-623"><a href="#cb49-623"></a>For the seeds that ran without error, the estimates can be plotted with the true parameter values overlaid for comparison. No transformation is needed when using <span class="in">`flexsurv:::tidy.flexsurvreg()`</span> (except for the $x_1$ coefficient which is reported on the log scale)</span>
<span id="cb49-624"><a href="#cb49-624"></a></span>
<span id="cb49-627"><a href="#cb49-627"></a><span class="in">```{r}</span></span>
<span id="cb49-628"><a href="#cb49-628"></a>true_params <span class="ot">&lt;-</span> <span class="fu">tribble</span>(</span>
<span id="cb49-629"><a href="#cb49-629"></a>  <span class="sc">~</span> cause, <span class="sc">~</span> term, <span class="sc">~</span> estimate,</span>
<span id="cb49-630"><a href="#cb49-630"></a>  <span class="dv">1</span>L, <span class="st">"shape"</span>, <span class="fl">1.6</span>,</span>
<span id="cb49-631"><a href="#cb49-631"></a>  <span class="dv">1</span>L, <span class="st">"scale"</span>, <span class="dv">5</span>,</span>
<span id="cb49-632"><a href="#cb49-632"></a>  <span class="dv">1</span>L, <span class="st">"x1"</span>, <span class="fu">log</span>(<span class="fl">1.4</span>),</span>
<span id="cb49-633"><a href="#cb49-633"></a>  <span class="dv">2</span>L, <span class="st">"shape"</span>, <span class="dv">5</span>,</span>
<span id="cb49-634"><a href="#cb49-634"></a>  <span class="dv">2</span>L, <span class="st">"scale"</span>, <span class="dv">5</span>,</span>
<span id="cb49-635"><a href="#cb49-635"></a>  <span class="dv">2</span>L, <span class="st">"x1"</span>, <span class="dv">0</span>,</span>
<span id="cb49-636"><a href="#cb49-636"></a>  <span class="dv">3</span>L, <span class="st">"shape"</span>, <span class="dv">1</span>,</span>
<span id="cb49-637"><a href="#cb49-637"></a>  <span class="dv">3</span>L, <span class="st">"scale"</span>, <span class="dv">5</span>,</span>
<span id="cb49-638"><a href="#cb49-638"></a>  <span class="dv">3</span>L, <span class="st">"x1"</span>, <span class="dv">0</span></span>
<span id="cb49-639"><a href="#cb49-639"></a>)</span>
<span id="cb49-640"><a href="#cb49-640"></a></span>
<span id="cb49-641"><a href="#cb49-641"></a>parameter_estimates_parallel <span class="ot">&lt;-</span> <span class="fu">read_rds</span>(<span class="st">"saved_objects/parameter_estimates_parallel.rds"</span>)</span>
<span id="cb49-642"><a href="#cb49-642"></a></span>
<span id="cb49-643"><a href="#cb49-643"></a>parameter_estimates_parallel <span class="sc">%&gt;%</span> </span>
<span id="cb49-644"><a href="#cb49-644"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> estimate, <span class="at">group =</span> <span class="fu">interaction</span>(cause, term))) <span class="sc">+</span></span>
<span id="cb49-645"><a href="#cb49-645"></a>  <span class="fu">geom_density</span>() <span class="sc">+</span></span>
<span id="cb49-646"><a href="#cb49-646"></a>  <span class="fu">geom_vline</span>(<span class="at">data =</span> true_params, <span class="fu">aes</span>(<span class="at">xintercept =</span> estimate)) <span class="sc">+</span></span>
<span id="cb49-647"><a href="#cb49-647"></a>  <span class="fu">xlab</span>(glue<span class="sc">::</span><span class="fu">glue</span>(<span class="st">"Sampling distribution of simulation parameters "</span>, </span>
<span id="cb49-648"><a href="#cb49-648"></a>                  <span class="st">"(5,000 datasets with n = 1,000)"</span>)) <span class="sc">+</span></span>
<span id="cb49-649"><a href="#cb49-649"></a>  ggh4x<span class="sc">::</span><span class="fu">facet_grid2</span>(<span class="at">rows =</span> <span class="fu">vars</span>(cause), <span class="at">cols =</span> <span class="fu">vars</span>(term), </span>
<span id="cb49-650"><a href="#cb49-650"></a>                     <span class="at">scales =</span> <span class="st">"free"</span>, <span class="at">independent =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb49-651"><a href="#cb49-651"></a>  <span class="fu">theme_classic</span>() <span class="sc">+</span> </span>
<span id="cb49-652"><a href="#cb49-652"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"bottom"</span>)</span>
<span id="cb49-653"><a href="#cb49-653"></a><span class="in">```</span></span>
<span id="cb49-654"><a href="#cb49-654"></a></span>
<span id="cb49-655"><a href="#cb49-655"></a>It's reassuring but not surprising, given the ubiquity of this approach to CSH CR analysis, to see the density estimates centered at the true values indicating unbiasedness of the CSH approach.</span>
<span id="cb49-656"><a href="#cb49-656"></a></span>
<span id="cb49-657"><a href="#cb49-657"></a><span class="fu">### CIF estimates</span></span>
<span id="cb49-658"><a href="#cb49-658"></a></span>
<span id="cb49-659"><a href="#cb49-659"></a>Since the parameters are estimated correctly, any downstream quantities like the cause-specific CIFs and overall survival should be unbiased too. In the next figure, I'm visualizing these for the four states within $x_1 = 0$. The true curves and the average of 100 curves from randomly simulated datasets (restricted to $t \in (0, 10]$) are pretty close</span>
<span id="cb49-660"><a href="#cb49-660"></a></span>
<span id="cb49-663"><a href="#cb49-663"></a><span class="in">```{r}</span></span>
<span id="cb49-664"><a href="#cb49-664"></a>sampling_distribution_CIFs <span class="ot">&lt;-</span> <span class="fu">read_rds</span>(<span class="st">"saved_objects/sampling_distribution_CIFs.rds"</span>)</span>
<span id="cb49-665"><a href="#cb49-665"></a></span>
<span id="cb49-666"><a href="#cb49-666"></a>sampling_distribution_CIFs_mean <span class="ot">&lt;-</span> sampling_distribution_CIFs <span class="sc">%&gt;%</span></span>
<span id="cb49-667"><a href="#cb49-667"></a>  <span class="fu">summarise</span>(<span class="at">CIF =</span> <span class="fu">mean</span>(CIF), <span class="at">.by =</span> <span class="fu">c</span>(Event, time))</span>
<span id="cb49-668"><a href="#cb49-668"></a></span>
<span id="cb49-669"><a href="#cb49-669"></a>sampling_distribution_CIFs <span class="sc">%&gt;%</span></span>
<span id="cb49-670"><a href="#cb49-670"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> CIF, <span class="at">group =</span> rep)) <span class="sc">+</span></span>
<span id="cb49-671"><a href="#cb49-671"></a>  <span class="fu">geom_line</span>(<span class="at">color =</span> <span class="st">"gray80"</span>) <span class="sc">+</span></span>
<span id="cb49-672"><a href="#cb49-672"></a>  <span class="fu">geom_line</span>(</span>
<span id="cb49-673"><a href="#cb49-673"></a>    <span class="at">data =</span> cumulative_incidence_curves_plot_data <span class="sc">%&gt;%</span></span>
<span id="cb49-674"><a href="#cb49-674"></a>    <span class="fu">filter</span>(Group <span class="sc">==</span> <span class="st">"x1 = 0"</span>, time <span class="sc">&lt;=</span> <span class="fl">10.0</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb49-675"><a href="#cb49-675"></a>    <span class="fu">mutate</span>(<span class="at">Event =</span> <span class="fu">fct_relevel</span>(<span class="fu">factor</span>(Event), <span class="st">"Event-free"</span>, <span class="at">after =</span> <span class="dv">0</span>)),</span>
<span id="cb49-676"><a href="#cb49-676"></a>    <span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> CIF),</span>
<span id="cb49-677"><a href="#cb49-677"></a>    <span class="at">color =</span> <span class="st">"gray20"</span>, <span class="at">linewidth =</span> <span class="fl">1.5</span>,</span>
<span id="cb49-678"><a href="#cb49-678"></a>    <span class="at">inherit.aes =</span> <span class="cn">FALSE</span></span>
<span id="cb49-679"><a href="#cb49-679"></a>  ) <span class="sc">+</span></span>
<span id="cb49-680"><a href="#cb49-680"></a>  <span class="fu">geom_line</span>(</span>
<span id="cb49-681"><a href="#cb49-681"></a>    <span class="at">data =</span> sampling_distribution_CIFs_mean,</span>
<span id="cb49-682"><a href="#cb49-682"></a>    <span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> CIF),</span>
<span id="cb49-683"><a href="#cb49-683"></a>    <span class="at">color =</span> <span class="st">"gray20"</span>, <span class="at">linewidth =</span> <span class="fl">1.5</span>, <span class="at">linetype =</span> <span class="st">"dotted"</span>,</span>
<span id="cb49-684"><a href="#cb49-684"></a>    <span class="at">inherit.aes =</span> <span class="cn">FALSE</span></span>
<span id="cb49-685"><a href="#cb49-685"></a>  ) <span class="sc">+</span></span>
<span id="cb49-686"><a href="#cb49-686"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="dv">5</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"gray20"</span>) <span class="sc">+</span></span>
<span id="cb49-687"><a href="#cb49-687"></a>  <span class="fu">xlab</span>(glue<span class="sc">::</span><span class="fu">glue</span>(<span class="st">"Time (t)</span><span class="sc">\n</span><span class="st">Sampling distribution of curves "</span>, </span>
<span id="cb49-688"><a href="#cb49-688"></a>                  <span class="st">"estimated from 100 datasets with "</span>, </span>
<span id="cb49-689"><a href="#cb49-689"></a>                  <span class="st">"n = 1,000 (light gray); </span><span class="sc">\n</span><span class="st">true curve "</span>, </span>
<span id="cb49-690"><a href="#cb49-690"></a>                  <span class="st">"(gray, solid); averaged curve (gray, dotted);"</span>,</span>
<span id="cb49-691"><a href="#cb49-691"></a>                  <span class="st">"</span><span class="sc">\n</span><span class="st">maximum observed time (gray, dashed)"</span>)) <span class="sc">+</span></span>
<span id="cb49-692"><a href="#cb49-692"></a>  <span class="fu">ylab</span>(<span class="st">"Probability of being in state"</span>) <span class="sc">+</span></span>
<span id="cb49-693"><a href="#cb49-693"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> Event, <span class="at">scales =</span> <span class="st">"free_y"</span>)</span>
<span id="cb49-694"><a href="#cb49-694"></a><span class="in">```</span></span>
<span id="cb49-695"><a href="#cb49-695"></a></span>
<span id="cb49-696"><a href="#cb49-696"></a>Intuitively, the variability (or lack of) boils down to the number of events of each type $k$. Events that are more likely to occur first (in this case $k=3$) will have more events and more precise estimates. The estimate for $S(t|x_1 = 0)$ is the most precise here (all the gray lines are very close to the black line) because it uses information on all the events.</span>
<span id="cb49-697"><a href="#cb49-697"></a></span>
<span id="cb49-698"><a href="#cb49-698"></a>Each individual curve is produced using this function</span>
<span id="cb49-699"><a href="#cb49-699"></a></span>
<span id="cb49-702"><a href="#cb49-702"></a><span class="in">```{r}</span></span>
<span id="cb49-703"><a href="#cb49-703"></a><span class="co">#| code-fold: false</span></span>
<span id="cb49-704"><a href="#cb49-704"></a></span>
<span id="cb49-705"><a href="#cb49-705"></a>estimate_CIF <span class="ot">&lt;-</span> <span class="cf">function</span>(seed, time_seq, <span class="at">covariate_level =</span> <span class="fu">data.frame</span>(<span class="at">x1 =</span> <span class="dv">0</span>)) {</span>
<span id="cb49-706"><a href="#cb49-706"></a>  list_models <span class="ot">&lt;-</span> seed <span class="sc">%&gt;%</span></span>
<span id="cb49-707"><a href="#cb49-707"></a>    <span class="fu">simulate_single_dataset</span>(<span class="at">seed =</span> .) <span class="sc">%&gt;%</span></span>
<span id="cb49-708"><a href="#cb49-708"></a>    <span class="fu">create_cause_specific_datasets</span>() <span class="sc">%&gt;%</span></span>
<span id="cb49-709"><a href="#cb49-709"></a>    <span class="fu">fit_cause_specific_models</span>()</span>
<span id="cb49-710"><a href="#cb49-710"></a></span>
<span id="cb49-711"><a href="#cb49-711"></a>  transition_matrix <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="at">data =</span> <span class="fu">c</span>(<span class="fu">c</span>(<span class="cn">NA</span>, <span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>), <span class="fu">rep</span>(<span class="cn">NA</span>, <span class="dv">12</span>)), </span>
<span id="cb49-712"><a href="#cb49-712"></a>                              <span class="at">nrow =</span> <span class="dv">4</span>, <span class="at">ncol =</span> <span class="dv">4</span>, <span class="at">byrow =</span> <span class="cn">TRUE</span>)</span>
<span id="cb49-713"><a href="#cb49-713"></a></span>
<span id="cb49-714"><a href="#cb49-714"></a>  multi_state_object <span class="ot">&lt;-</span> <span class="fu">fmsm</span>(list_models[[<span class="dv">1</span>]], </span>
<span id="cb49-715"><a href="#cb49-715"></a>                             list_models[[<span class="dv">2</span>]], </span>
<span id="cb49-716"><a href="#cb49-716"></a>                             list_models[[<span class="dv">3</span>]], </span>
<span id="cb49-717"><a href="#cb49-717"></a>                             <span class="at">trans =</span> transition_matrix)</span>
<span id="cb49-718"><a href="#cb49-718"></a></span>
<span id="cb49-719"><a href="#cb49-719"></a>  multi_state_object <span class="sc">%&gt;%</span> </span>
<span id="cb49-720"><a href="#cb49-720"></a>    <span class="fu">pmatrix.fs</span>(</span>
<span id="cb49-721"><a href="#cb49-721"></a>      <span class="at">trans =</span> transition_matrix, <span class="at">t =</span> time_seq, </span>
<span id="cb49-722"><a href="#cb49-722"></a>      <span class="at">newdata =</span> covariate_level, <span class="at">tidy =</span> <span class="cn">TRUE</span></span>
<span id="cb49-723"><a href="#cb49-723"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb49-724"><a href="#cb49-724"></a>    <span class="fu">as_tibble</span>() <span class="sc">%&gt;%</span></span>
<span id="cb49-725"><a href="#cb49-725"></a>    <span class="fu">filter</span>(start <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb49-726"><a href="#cb49-726"></a>    <span class="fu">select</span>(<span class="sc">-</span>start) <span class="sc">%&gt;%</span></span>
<span id="cb49-727"><a href="#cb49-727"></a>    <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="sc">-</span>time, <span class="at">names_to =</span> <span class="st">"Distribution"</span>, <span class="at">values_to =</span> <span class="st">"CIF"</span>)</span>
<span id="cb49-728"><a href="#cb49-728"></a>}</span>
<span id="cb49-729"><a href="#cb49-729"></a></span>
<span id="cb49-730"><a href="#cb49-730"></a>safely_estimate_CIF <span class="ot">&lt;-</span> <span class="fu">safely</span>(estimate_CIF)</span>
<span id="cb49-731"><a href="#cb49-731"></a><span class="in">```</span></span>
<span id="cb49-732"><a href="#cb49-732"></a></span>
<span id="cb49-733"><a href="#cb49-733"></a>and the next code runs the pipeline for producing these 100 CIF estimates</span>
<span id="cb49-734"><a href="#cb49-734"></a></span>
<span id="cb49-737"><a href="#cb49-737"></a><span class="in">```{r}</span></span>
<span id="cb49-738"><a href="#cb49-738"></a><span class="co">#| eval: false</span></span>
<span id="cb49-739"><a href="#cb49-739"></a></span>
<span id="cb49-740"><a href="#cb49-740"></a>time_seq_subset <span class="ot">&lt;-</span> time_seq <span class="sc">%&gt;%</span> </span>
<span id="cb49-741"><a href="#cb49-741"></a>  <span class="fu">keep</span>(<span class="at">.p =</span> <span class="sc">~</span> .x <span class="sc">&lt;=</span> <span class="fl">10.0</span>)</span>
<span id="cb49-742"><a href="#cb49-742"></a></span>
<span id="cb49-743"><a href="#cb49-743"></a>sampling_distribution_CIFs <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">100</span> <span class="sc">%&gt;%</span></span>
<span id="cb49-744"><a href="#cb49-744"></a>  <span class="fu">map</span>(</span>
<span id="cb49-745"><a href="#cb49-745"></a>    <span class="at">.f =</span> <span class="sc">~</span> {</span>
<span id="cb49-746"><a href="#cb49-746"></a>      <span class="fu">print</span>(glue<span class="sc">::</span><span class="fu">glue</span>(<span class="st">"rep: {.x}"</span>))</span>
<span id="cb49-747"><a href="#cb49-747"></a>      <span class="fu">safely_estimate_CIF</span>(</span>
<span id="cb49-748"><a href="#cb49-748"></a>        <span class="at">seed =</span> .x, </span>
<span id="cb49-749"><a href="#cb49-749"></a>        <span class="at">time_seq =</span> time_seq_subset, </span>
<span id="cb49-750"><a href="#cb49-750"></a>        <span class="at">covariate_level =</span> <span class="fu">data.frame</span>(<span class="at">x1 =</span> <span class="dv">0</span>)</span>
<span id="cb49-751"><a href="#cb49-751"></a>      )</span>
<span id="cb49-752"><a href="#cb49-752"></a>    }</span>
<span id="cb49-753"><a href="#cb49-753"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb49-754"><a href="#cb49-754"></a>  <span class="co"># remove the seeds where the estimation failed</span></span>
<span id="cb49-755"><a href="#cb49-755"></a>  <span class="fu">imap</span>(</span>
<span id="cb49-756"><a href="#cb49-756"></a>    <span class="at">.f =</span> <span class="sc">~</span> {</span>
<span id="cb49-757"><a href="#cb49-757"></a>      res <span class="ot">&lt;-</span> <span class="fu">pluck</span>(.x, <span class="st">"result"</span>)</span>
<span id="cb49-758"><a href="#cb49-758"></a>      <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(res)) {</span>
<span id="cb49-759"><a href="#cb49-759"></a>        res <span class="sc">%&gt;%</span></span>
<span id="cb49-760"><a href="#cb49-760"></a>          <span class="fu">mutate</span>(<span class="at">rep =</span> .y, <span class="at">.before =</span> time)</span>
<span id="cb49-761"><a href="#cb49-761"></a>      } <span class="cf">else</span> {</span>
<span id="cb49-762"><a href="#cb49-762"></a>        res</span>
<span id="cb49-763"><a href="#cb49-763"></a>      }</span>
<span id="cb49-764"><a href="#cb49-764"></a>    }</span>
<span id="cb49-765"><a href="#cb49-765"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb49-766"><a href="#cb49-766"></a>  <span class="fu">compact</span>() <span class="sc">%&gt;%</span></span>
<span id="cb49-767"><a href="#cb49-767"></a>  <span class="fu">list_rbind</span>() <span class="sc">%&gt;%</span></span>
<span id="cb49-768"><a href="#cb49-768"></a>  <span class="fu">mutate</span>(</span>
<span id="cb49-769"><a href="#cb49-769"></a>    <span class="at">Event =</span> <span class="fu">case_when</span>(</span>
<span id="cb49-770"><a href="#cb49-770"></a>      Distribution <span class="sc">==</span> <span class="st">"V1"</span> <span class="sc">~</span> <span class="st">"Event-free"</span>,</span>
<span id="cb49-771"><a href="#cb49-771"></a>      Distribution <span class="sc">==</span> <span class="st">"V2"</span> <span class="sc">~</span> <span class="st">"Weibull(shape = 1.6, scale = 5)"</span>,</span>
<span id="cb49-772"><a href="#cb49-772"></a>      Distribution <span class="sc">==</span> <span class="st">"V3"</span> <span class="sc">~</span> <span class="st">"Log-logistic(shape = 5, scale = 5)"</span>,</span>
<span id="cb49-773"><a href="#cb49-773"></a>      Distribution <span class="sc">==</span> <span class="st">"V4"</span> <span class="sc">~</span> <span class="st">"Exponential(rate = 5)"</span></span>
<span id="cb49-774"><a href="#cb49-774"></a>    )</span>
<span id="cb49-775"><a href="#cb49-775"></a>  )</span>
<span id="cb49-776"><a href="#cb49-776"></a></span>
<span id="cb49-777"><a href="#cb49-777"></a><span class="co"># write_rds(sampling_distribution_CIFs, "saved_objects/sampling_distribution_CIFs.rds")</span></span>
<span id="cb49-778"><a href="#cb49-778"></a><span class="in">```</span></span>
<span id="cb49-779"><a href="#cb49-779"></a></span>
<span id="cb49-780"><a href="#cb49-780"></a><span class="fu">## Comparison with `survsim::crisk.ncens.sim`</span></span>
<span id="cb49-781"><a href="#cb49-781"></a></span>
<span id="cb49-782"><a href="#cb49-782"></a>I initially started on this project by attempting to use the function from <span class="in">`survsim`</span>, but I was getting very different results from fitting the models using <span class="in">`flexsurv`</span>. It was also taking quite long (\~6x longer) to produce simulated datasets mostly because of me picking simulation parameters without giving it much thought<span class="ot">[^1]</span>. Thinking through the process in detail is what led to this post being much longer than anticipated. This section compares the parameterizations for the hazard functions and simulated draws from <span class="in">`survsim`</span> and <span class="in">`flexsurv`</span>.</span>
<span id="cb49-783"><a href="#cb49-783"></a></span>
<span id="cb49-784"><a href="#cb49-784"></a><span class="ot">[^1]: </span>I picked a large value for administrative censoring, which meant that <span class="in">`uniroot`</span> would take much longer to run due to increased number of iterations to converge to the root, and increased time due to multiple <span class="in">`integrate()`</span> calls.</span>
<span id="cb49-785"><a href="#cb49-785"></a></span>
<span id="cb49-786"><a href="#cb49-786"></a><span class="fu">### Converting `flexsurv` parameterization to `survsim`</span></span>
<span id="cb49-787"><a href="#cb49-787"></a></span>
<span id="cb49-788"><a href="#cb49-788"></a>The hazard function code for Weibull and log-logistic is taken from <span class="in">`survsim:::crisk.ncens.sim()`</span> <span class="co">[</span><span class="ot">here</span><span class="co">](https://github.com/cran/survsim/blob/6e1bf878cf3e35b37d6cb7d1ef4b0179ed99b1d3/R/crisk.ncens.sim.R#L85-L104)</span></span>
<span id="cb49-789"><a href="#cb49-789"></a></span>
<span id="cb49-792"><a href="#cb49-792"></a><span class="in">```{r}</span></span>
<span id="cb49-793"><a href="#cb49-793"></a><span class="co">#| code-fold: false</span></span>
<span id="cb49-794"><a href="#cb49-794"></a><span class="co">#| eval: false</span></span>
<span id="cb49-795"><a href="#cb49-795"></a></span>
<span id="cb49-796"><a href="#cb49-796"></a><span class="co"># code from survsim::crisk.ncens.sim()</span></span>
<span id="cb49-797"><a href="#cb49-797"></a><span class="co">#</span></span>
<span id="cb49-798"><a href="#cb49-798"></a><span class="cf">if</span> (dist.ev[k] <span class="sc">==</span> <span class="st">"llogistic"</span>) {</span>
<span id="cb49-799"><a href="#cb49-799"></a>  a.ev[k] <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">/</span><span class="fu">exp</span>(beta0.ev[k] <span class="sc">+</span> suma[k])</span>
<span id="cb49-800"><a href="#cb49-800"></a>  b.ev[k] <span class="ot">&lt;-</span> anc.ev[k]</span>
<span id="cb49-801"><a href="#cb49-801"></a>  cshaz[[k]] <span class="ot">&lt;-</span> <span class="cf">function</span>(t, r) {</span>
<span id="cb49-802"><a href="#cb49-802"></a>    par1 <span class="ot">&lt;-</span> <span class="fu">eval</span>(<span class="fu">parse</span>(<span class="at">text=</span><span class="st">"a.ev[r]"</span>))</span>
<span id="cb49-803"><a href="#cb49-803"></a>    par2 <span class="ot">&lt;-</span> <span class="fu">eval</span>(<span class="fu">parse</span>(<span class="at">text=</span><span class="st">"b.ev[r]"</span>))</span>
<span id="cb49-804"><a href="#cb49-804"></a>    z    <span class="ot">&lt;-</span> <span class="fu">eval</span>(<span class="fu">parse</span>(<span class="at">text=</span><span class="st">"az1[r]"</span>))</span>
<span id="cb49-805"><a href="#cb49-805"></a>    <span class="fu">return</span>(z<span class="sc">*</span>(par1<span class="sc">*</span>par2<span class="sc">*</span>(t<span class="sc">^</span>(par2<span class="dv">-1</span>)))<span class="sc">/</span>(<span class="dv">1</span><span class="sc">+</span>par1<span class="sc">*</span>(t<span class="sc">^</span>par2)))}</span>
<span id="cb49-806"><a href="#cb49-806"></a>}</span>
<span id="cb49-807"><a href="#cb49-807"></a></span>
<span id="cb49-808"><a href="#cb49-808"></a><span class="cf">if</span> (dist.ev[k] <span class="sc">==</span> <span class="st">"weibull"</span>) {</span>
<span id="cb49-809"><a href="#cb49-809"></a>  a.ev[k] <span class="ot">&lt;-</span> beta0.ev[k] <span class="sc">+</span> suma[k]</span>
<span id="cb49-810"><a href="#cb49-810"></a>  b.ev[k] <span class="ot">&lt;-</span> anc.ev[k]</span>
<span id="cb49-811"><a href="#cb49-811"></a>  cshaz[[k]] <span class="ot">&lt;-</span> <span class="cf">function</span>(t, r) {</span>
<span id="cb49-812"><a href="#cb49-812"></a>    par1 <span class="ot">&lt;-</span> <span class="fu">eval</span>(<span class="fu">parse</span>(<span class="at">text=</span><span class="st">"a.ev[r]"</span>))</span>
<span id="cb49-813"><a href="#cb49-813"></a>    par2 <span class="ot">&lt;-</span> <span class="fu">eval</span>(<span class="fu">parse</span>(<span class="at">text=</span><span class="st">"b.ev[r]"</span>))</span>
<span id="cb49-814"><a href="#cb49-814"></a>    z    <span class="ot">&lt;-</span> <span class="fu">eval</span>(<span class="fu">parse</span>(<span class="at">text=</span><span class="st">"az1[r]"</span>))</span>
<span id="cb49-815"><a href="#cb49-815"></a>    <span class="fu">return</span>(z <span class="sc">*</span> ((<span class="dv">1</span><span class="sc">/</span>par2)<span class="sc">/</span>((<span class="fu">exp</span>(par1))<span class="sc">^</span>(<span class="dv">1</span><span class="sc">/</span>par2)))<span class="sc">*</span></span>
<span id="cb49-816"><a href="#cb49-816"></a>           t<span class="sc">^</span>((<span class="dv">1</span><span class="sc">/</span>par2) <span class="sc">-</span> <span class="dv">1</span>))}</span>
<span id="cb49-817"><a href="#cb49-817"></a>}</span>
<span id="cb49-818"><a href="#cb49-818"></a><span class="in">```</span></span>
<span id="cb49-819"><a href="#cb49-819"></a></span>
<span id="cb49-820"><a href="#cb49-820"></a>It's a bit confusing since the user function <span class="in">`survsim::crisk.sim()`</span> takes <span class="in">`anc.ev`</span> and <span class="in">`beta0.ev`</span> as inputs, but these get transformed to <span class="in">`a.ev`</span> and <span class="in">`b.ev`</span> and then to <span class="in">`par1`</span> and <span class="in">`par2`</span> (ok that last transformation is straightforward).</span>
<span id="cb49-821"><a href="#cb49-821"></a></span>
<span id="cb49-822"><a href="#cb49-822"></a>Here's the Weibull AFT programmed in <span class="in">`flexsurv`</span></span>
<span id="cb49-823"><a href="#cb49-823"></a></span>
<span id="cb49-826"><a href="#cb49-826"></a><span class="in">```{r}</span></span>
<span id="cb49-827"><a href="#cb49-827"></a><span class="co">#| code-fold: false</span></span>
<span id="cb49-828"><a href="#cb49-828"></a></span>
<span id="cb49-829"><a href="#cb49-829"></a><span class="co"># Weibull AFT parameterization hazard</span></span>
<span id="cb49-830"><a href="#cb49-830"></a>flexsurv<span class="sc">::</span>hweibull</span>
<span id="cb49-831"><a href="#cb49-831"></a><span class="in">```</span></span>
<span id="cb49-832"><a href="#cb49-832"></a></span>
<span id="cb49-833"><a href="#cb49-833"></a>If the shape parameter is $a$ and scale parameter is $\mu$, the hazard function is</span>
<span id="cb49-834"><a href="#cb49-834"></a></span>
<span id="cb49-835"><a href="#cb49-835"></a>$$</span>
<span id="cb49-836"><a href="#cb49-836"></a>h_{\text{wei}}^{\text{flexsurv}}(t; a, \mu) = a\Bigg(\frac{t}{\mu}\Bigg)^{a - 1} \frac{1}{\mu} = a \mu^{-a}t^{a - 1}</span>
<span id="cb49-837"><a href="#cb49-837"></a>$$</span>
<span id="cb49-838"><a href="#cb49-838"></a></span>
<span id="cb49-839"><a href="#cb49-839"></a>and for Weibull AFT from <span class="in">`survsim`</span></span>
<span id="cb49-840"><a href="#cb49-840"></a></span>
<span id="cb49-841"><a href="#cb49-841"></a>$$</span>
<span id="cb49-842"><a href="#cb49-842"></a>h_{\text{wei}}^{\text{simsurv}}(t; p_1, p_2) = \frac{1}{p_2} \Bigg(\Big(e^{p_1}\Big)^{1 / p_2}\Bigg)^{-1} t^{\Big(\frac{1}{p_2} - 1\Big)}</span>
<span id="cb49-843"><a href="#cb49-843"></a>$$</span>
<span id="cb49-844"><a href="#cb49-844"></a></span>
<span id="cb49-845"><a href="#cb49-845"></a>with <span class="in">`beta0.ev = par1`</span> = $p_1$ and <span class="in">`anc.ev = par2`</span> = $p_2$. This gives the corresponding transformations for Weibull in <span class="in">`simsurv`</span>, <span class="in">`anc.ev`</span> = $1 / a$ (so inverse of <span class="in">`flexsurv`</span> shape), and <span class="in">`beta0.ev`</span> = $\text{log}(\mu)$ (so log of <span class="in">`flexsurv`</span> scale).</span>
<span id="cb49-846"><a href="#cb49-846"></a></span>
<span id="cb49-847"><a href="#cb49-847"></a>Log-logistic implemented in <span class="in">`flexsurv`</span></span>
<span id="cb49-848"><a href="#cb49-848"></a></span>
<span id="cb49-851"><a href="#cb49-851"></a><span class="in">```{r}</span></span>
<span id="cb49-852"><a href="#cb49-852"></a><span class="co">#| code-fold: false</span></span>
<span id="cb49-853"><a href="#cb49-853"></a></span>
<span id="cb49-854"><a href="#cb49-854"></a><span class="co"># log-logistic hazard</span></span>
<span id="cb49-855"><a href="#cb49-855"></a>flexsurv<span class="sc">::</span>hllogis</span>
<span id="cb49-856"><a href="#cb49-856"></a><span class="in">```</span></span>
<span id="cb49-857"><a href="#cb49-857"></a></span>
<span id="cb49-858"><a href="#cb49-858"></a>if shape is $a$ and scale is $b$, the hazard function is</span>
<span id="cb49-859"><a href="#cb49-859"></a></span>
<span id="cb49-860"><a href="#cb49-860"></a>$$</span>
<span id="cb49-861"><a href="#cb49-861"></a>h_{\text{ll}}^{\text{flexsurv}}(t; a, b) = \frac{(a / b) (t / b)^{a - 1}}{1 + (t / b)^a}</span>
<span id="cb49-862"><a href="#cb49-862"></a>$$</span>
<span id="cb49-863"><a href="#cb49-863"></a></span>
<span id="cb49-864"><a href="#cb49-864"></a>compared with the one from <span class="in">`simsurv`</span> (with <span class="in">`par1`</span> = $p_1$ and <span class="in">`par2`</span> = $p_2$)</span>
<span id="cb49-865"><a href="#cb49-865"></a></span>
<span id="cb49-866"><a href="#cb49-866"></a>$$</span>
<span id="cb49-867"><a href="#cb49-867"></a>h_{\text{ll}}^{\text{simsurv}}(t; p_1, p_2) = \frac{p_1 p_2 t^{p_2 - 1}}{1 + p_1 t^{p_2}}</span>
<span id="cb49-868"><a href="#cb49-868"></a>$$</span>
<span id="cb49-869"><a href="#cb49-869"></a></span>
<span id="cb49-870"><a href="#cb49-870"></a>$p_2 = \text{anc.ev} = a$ (shape from <span class="in">`flexsurv`</span>) and $p_1 = 1 / \text{exp}(\text{beta0.ev}) = a \text{log}(b)$ (shape times log(scale) from <span class="in">`flexsurv`</span>).</span>
<span id="cb49-871"><a href="#cb49-871"></a></span>
<span id="cb49-872"><a href="#cb49-872"></a><span class="fu">### `survsim` function</span></span>
<span id="cb49-873"><a href="#cb49-873"></a></span>
<span id="cb49-876"><a href="#cb49-876"></a><span class="in">```{r}</span></span>
<span id="cb49-877"><a href="#cb49-877"></a><span class="co">#| code-fold: false</span></span>
<span id="cb49-878"><a href="#cb49-878"></a></span>
<span id="cb49-879"><a href="#cb49-879"></a>survsim_sim_fn <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">n =</span> <span class="dv">1000</span>) {</span>
<span id="cb49-880"><a href="#cb49-880"></a>  survsim<span class="sc">::</span><span class="fu">crisk.sim</span>(</span>
<span id="cb49-881"><a href="#cb49-881"></a>    <span class="at">n =</span> n,</span>
<span id="cb49-882"><a href="#cb49-882"></a>    <span class="at">foltime =</span> <span class="dv">5</span>,</span>
<span id="cb49-883"><a href="#cb49-883"></a>    <span class="co"># TTE distr</span></span>
<span id="cb49-884"><a href="#cb49-884"></a>    <span class="at">nsit =</span> <span class="dv">3</span>,</span>
<span id="cb49-885"><a href="#cb49-885"></a>    <span class="at">dist.ev =</span> <span class="fu">c</span>(<span class="st">"weibull"</span>, <span class="st">"llogistic"</span>, <span class="st">"weibull"</span>),</span>
<span id="cb49-886"><a href="#cb49-886"></a>    <span class="co"># anc.ev is 1 / shape, exp(beta0) is scale in flexsurv weibull AFT</span></span>
<span id="cb49-887"><a href="#cb49-887"></a>    <span class="co"># anc.ev is shape, beta0.ev is shape * log(scale) in flexsurv llogis</span></span>
<span id="cb49-888"><a href="#cb49-888"></a>    <span class="at">anc.ev =</span> <span class="fu">c</span>(<span class="dv">1</span> <span class="sc">/</span> <span class="fl">1.6</span>, <span class="dv">5</span>, <span class="dv">1</span>),</span>
<span id="cb49-889"><a href="#cb49-889"></a>    <span class="at">beta0.ev =</span> <span class="fu">c</span>(<span class="fu">log</span>(<span class="dv">5</span>), <span class="dv">5</span> <span class="sc">*</span> <span class="fu">log</span>(<span class="dv">5</span>), <span class="fu">log</span>(<span class="dv">5</span>)),</span>
<span id="cb49-890"><a href="#cb49-890"></a>    <span class="co"># covariate process</span></span>
<span id="cb49-891"><a href="#cb49-891"></a>    <span class="at">x =</span> <span class="fu">list</span>(<span class="fu">c</span>(<span class="st">"bern"</span>, <span class="fl">0.5</span>)),</span>
<span id="cb49-892"><a href="#cb49-892"></a>    <span class="at">beta =</span> <span class="fu">list</span>(<span class="fu">c</span>(<span class="fl">1.4</span>), <span class="fu">c</span>(<span class="dv">0</span>), <span class="fu">c</span>(<span class="dv">0</span>)),</span>
<span id="cb49-893"><a href="#cb49-893"></a>    <span class="co"># censoring process, assume constant here to only apply administrative censoring</span></span>
<span id="cb49-894"><a href="#cb49-894"></a>    <span class="at">dist.cens =</span> <span class="st">"unif"</span>, <span class="at">beta0.cens =</span> <span class="dv">500</span>, <span class="at">anc.cens =</span> <span class="dv">500</span></span>
<span id="cb49-895"><a href="#cb49-895"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb49-896"><a href="#cb49-896"></a>    <span class="fu">as_tibble</span>()</span>
<span id="cb49-897"><a href="#cb49-897"></a>}</span>
<span id="cb49-898"><a href="#cb49-898"></a></span>
<span id="cb49-899"><a href="#cb49-899"></a><span class="fu">survsim_sim_fn</span>(<span class="at">n =</span> <span class="dv">10</span>)</span>
<span id="cb49-900"><a href="#cb49-900"></a><span class="in">```</span></span>
<span id="cb49-901"><a href="#cb49-901"></a></span>
<span id="cb49-902"><a href="#cb49-902"></a>The $z$ column is for individual frailties.</span>
<span id="cb49-903"><a href="#cb49-903"></a></span>
<span id="cb49-904"><a href="#cb49-904"></a><span class="fu">### Compare run times</span></span>
<span id="cb49-905"><a href="#cb49-905"></a></span>
<span id="cb49-906"><a href="#cb49-906"></a>The next figure shows a dot plot of the execution time distribution by repeating the process 10 times for both functions (again previously run results read back in)</span>
<span id="cb49-907"><a href="#cb49-907"></a></span>
<span id="cb49-910"><a href="#cb49-910"></a><span class="in">```{r}</span></span>
<span id="cb49-911"><a href="#cb49-911"></a><span class="co"># survsim_bench &lt;- bench::mark(</span></span>
<span id="cb49-912"><a href="#cb49-912"></a><span class="co">#   survsim_sim_fn(), iterations = 10, </span></span>
<span id="cb49-913"><a href="#cb49-913"></a><span class="co">#   check = FALSE, time_unit = "s", memory = FALSE</span></span>
<span id="cb49-914"><a href="#cb49-914"></a><span class="co"># )</span></span>
<span id="cb49-915"><a href="#cb49-915"></a><span class="co"># write_rds(survsim_bench, file = "saved_objects/survsim_bench.rds")</span></span>
<span id="cb49-916"><a href="#cb49-916"></a></span>
<span id="cb49-917"><a href="#cb49-917"></a>survsim_bench <span class="ot">&lt;-</span> <span class="fu">read_rds</span>(<span class="st">"saved_objects/survsim_bench.rds"</span>)</span>
<span id="cb49-918"><a href="#cb49-918"></a></span>
<span id="cb49-919"><a href="#cb49-919"></a><span class="co"># my_implementation_bench &lt;- bench::mark(</span></span>
<span id="cb49-920"><a href="#cb49-920"></a><span class="co">#   run_pipeline(sample(1:100, size = 1, replace = TRUE)),</span></span>
<span id="cb49-921"><a href="#cb49-921"></a><span class="co">#   iterations = 10, check = FALSE, time_unit = "s", memory = FALSE</span></span>
<span id="cb49-922"><a href="#cb49-922"></a><span class="co"># )</span></span>
<span id="cb49-923"><a href="#cb49-923"></a><span class="co"># write_rds(my_implementation_bench, file = "saved_objects/my_implementation_bench.rds")</span></span>
<span id="cb49-924"><a href="#cb49-924"></a></span>
<span id="cb49-925"><a href="#cb49-925"></a>my_implementation_bench <span class="ot">&lt;-</span> <span class="fu">read_rds</span>(<span class="st">"saved_objects/my_implementation_bench.rds"</span>)</span>
<span id="cb49-926"><a href="#cb49-926"></a></span>
<span id="cb49-927"><a href="#cb49-927"></a><span class="co"># dot plot of the run times</span></span>
<span id="cb49-928"><a href="#cb49-928"></a><span class="fu">tibble</span>(</span>
<span id="cb49-929"><a href="#cb49-929"></a>  <span class="at">time =</span> <span class="fu">c</span>(survsim_bench <span class="sc">%&gt;%</span> <span class="fu">pluck</span>(<span class="st">"time"</span>, <span class="dv">1</span>), </span>
<span id="cb49-930"><a href="#cb49-930"></a>           my_implementation_bench <span class="sc">%&gt;%</span> <span class="fu">pluck</span>(<span class="st">"time"</span>, <span class="dv">1</span>)),</span>
<span id="cb49-931"><a href="#cb49-931"></a>  <span class="at">group =</span> <span class="fu">rep</span>(<span class="fu">c</span>(<span class="st">"survsim"</span>, <span class="st">"handrolled"</span>), <span class="at">each =</span> <span class="dv">10</span>)</span>
<span id="cb49-932"><a href="#cb49-932"></a>) <span class="sc">%&gt;%</span></span>
<span id="cb49-933"><a href="#cb49-933"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> group, <span class="at">fill =</span> group, <span class="at">color =</span> group)) <span class="sc">+</span></span>
<span id="cb49-934"><a href="#cb49-934"></a>  <span class="fu">geom_dotplot</span>(<span class="at">binwidth =</span> <span class="fl">0.05</span>,  <span class="at">binaxis =</span> <span class="st">"x"</span>, </span>
<span id="cb49-935"><a href="#cb49-935"></a>               <span class="at">method =</span> <span class="st">"histodot"</span>, <span class="at">binpositions =</span> <span class="st">"bygroup"</span>, </span>
<span id="cb49-936"><a href="#cb49-936"></a>               <span class="at">stackdir =</span> <span class="st">"centerwhole"</span>) <span class="sc">+</span></span>
<span id="cb49-937"><a href="#cb49-937"></a>  <span class="co">#geom_point(size = 3, position = position_jitter(height = 0.1, seed = 4)) +</span></span>
<span id="cb49-938"><a href="#cb49-938"></a>  <span class="co">#theme(legend.position = "bottom", legend.title = element_blank()) +</span></span>
<span id="cb49-939"><a href="#cb49-939"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>) <span class="sc">+</span></span>
<span id="cb49-940"><a href="#cb49-940"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">1</span>, <span class="dv">4</span>, <span class="dv">1</span>), </span>
<span id="cb49-941"><a href="#cb49-941"></a>                     <span class="at">labels =</span> <span class="fu">seq</span>(<span class="dv">1</span>, <span class="dv">4</span>, <span class="dv">1</span>), </span>
<span id="cb49-942"><a href="#cb49-942"></a>                     <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">4</span>)) <span class="sc">+</span></span>
<span id="cb49-943"><a href="#cb49-943"></a>  <span class="fu">xlab</span>(<span class="st">"Time (in seconds)"</span>) <span class="sc">+</span></span>
<span id="cb49-944"><a href="#cb49-944"></a>  <span class="fu">ylab</span>(<span class="st">""</span>) <span class="sc">+</span> </span>
<span id="cb49-945"><a href="#cb49-945"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"orange"</span>, <span class="st">"gray30"</span>)) <span class="sc">+</span> </span>
<span id="cb49-946"><a href="#cb49-946"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"orange"</span>, <span class="st">"gray30"</span>))</span>
<span id="cb49-947"><a href="#cb49-947"></a><span class="in">```</span></span>
<span id="cb49-948"><a href="#cb49-948"></a></span>
<span id="cb49-949"><a href="#cb49-949"></a>shows about 2x speedup; I'm assuming most of this comes from not having to use numerical integration but using the cumulative hazards programmed within <span class="in">`flexsurv`</span>.</span>
<span id="cb49-950"><a href="#cb49-950"></a></span>
<span id="cb49-951"><a href="#cb49-951"></a><span class="fu">### Compare samples</span></span>
<span id="cb49-952"><a href="#cb49-952"></a></span>
<span id="cb49-953"><a href="#cb49-953"></a>The next plot shows the empirical distribution functions for 100 samples of size 100 from the two implementations</span>
<span id="cb49-954"><a href="#cb49-954"></a></span>
<span id="cb49-957"><a href="#cb49-957"></a><span class="in">```{r}</span></span>
<span id="cb49-958"><a href="#cb49-958"></a><span class="co"># eCDFs for a large draw overlaid to compare the draws - they should be overlapping</span></span>
<span id="cb49-959"><a href="#cb49-959"></a><span class="co"># set.seed(23)</span></span>
<span id="cb49-960"><a href="#cb49-960"></a><span class="co"># survsim_sample &lt;- survsim_sim_fn(n = 10000)</span></span>
<span id="cb49-961"><a href="#cb49-961"></a><span class="co"># set.seed(23)</span></span>
<span id="cb49-962"><a href="#cb49-962"></a><span class="co"># handrolled_sample &lt;- simulate_single_dataset(n_rows = 10000, seed = NULL)</span></span>
<span id="cb49-963"><a href="#cb49-963"></a><span class="co">#</span></span>
<span id="cb49-964"><a href="#cb49-964"></a><span class="co"># write_rds(survsim_sample, file = "saved_objects/survsim_sample.rds")</span></span>
<span id="cb49-965"><a href="#cb49-965"></a><span class="co"># write_rds(handrolled_sample, file = "saved_objects/handrolled_sample.rds")</span></span>
<span id="cb49-966"><a href="#cb49-966"></a></span>
<span id="cb49-967"><a href="#cb49-967"></a>survsim_sample <span class="ot">&lt;-</span> <span class="fu">read_rds</span>(<span class="st">"saved_objects/survsim_sample.rds"</span>)</span>
<span id="cb49-968"><a href="#cb49-968"></a>handrolled_sample <span class="ot">&lt;-</span> <span class="fu">read_rds</span>(<span class="st">"saved_objects/handrolled_sample.rds"</span>)</span>
<span id="cb49-969"><a href="#cb49-969"></a></span>
<span id="cb49-970"><a href="#cb49-970"></a><span class="fu">bind_rows</span>(</span>
<span id="cb49-971"><a href="#cb49-971"></a>  survsim_sample <span class="sc">%&gt;%</span></span>
<span id="cb49-972"><a href="#cb49-972"></a>    <span class="fu">select</span>(time) <span class="sc">%&gt;%</span></span>
<span id="cb49-973"><a href="#cb49-973"></a>    <span class="fu">mutate</span>(<span class="at">group =</span> <span class="st">"survsim"</span>),</span>
<span id="cb49-974"><a href="#cb49-974"></a>  handrolled_sample <span class="sc">%&gt;%</span></span>
<span id="cb49-975"><a href="#cb49-975"></a>    <span class="fu">select</span>(time) <span class="sc">%&gt;%</span></span>
<span id="cb49-976"><a href="#cb49-976"></a>    <span class="fu">mutate</span>(<span class="at">group =</span> <span class="st">"handrolled"</span>)</span>
<span id="cb49-977"><a href="#cb49-977"></a>) <span class="sc">%&gt;%</span></span>
<span id="cb49-978"><a href="#cb49-978"></a>  <span class="fu">mutate</span>(<span class="at">rep =</span> <span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">100</span>, <span class="at">size =</span> <span class="dv">20000</span>, <span class="at">replace =</span> <span class="cn">TRUE</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb49-979"><a href="#cb49-979"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">group =</span> <span class="fu">interaction</span>(group, rep), <span class="at">color =</span> group)) <span class="sc">+</span></span>
<span id="cb49-980"><a href="#cb49-980"></a>  <span class="fu">stat_ecdf</span>(<span class="at">pad =</span> <span class="cn">FALSE</span>, <span class="at">alpha =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb49-981"><a href="#cb49-981"></a>  <span class="fu">xlab</span>(<span class="st">"Simulated Times"</span>) <span class="sc">+</span></span>
<span id="cb49-982"><a href="#cb49-982"></a>  <span class="fu">ylab</span>(<span class="st">"Empirical CDF"</span>) <span class="sc">+</span></span>
<span id="cb49-983"><a href="#cb49-983"></a>  <span class="fu">theme_classic</span>() <span class="sc">+</span></span>
<span id="cb49-984"><a href="#cb49-984"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"bottom"</span>, <span class="at">legend.title =</span> <span class="fu">element_blank</span>()) <span class="sc">+</span></span>
<span id="cb49-985"><a href="#cb49-985"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"orange"</span>, <span class="st">"gray30"</span>))</span>
<span id="cb49-986"><a href="#cb49-986"></a><span class="in">```</span></span>
<span id="cb49-987"><a href="#cb49-987"></a></span>
<span id="cb49-988"><a href="#cb49-988"></a>It seems that the gray curves (<span class="in">`survsim`</span>) are a bit higher than the ones in orange (my implementation). I haven't looked into why, but it seems likely to be due to sampling variation.</span>
<span id="cb49-989"><a href="#cb49-989"></a></span>
<span id="cb49-990"><a href="#cb49-990"></a><span class="fu">## References</span></span>
<span id="cb49-991"><a href="#cb49-991"></a></span>
<span id="cb49-992"><a href="#cb49-992"></a>The main refs for the material in this post</span>
<span id="cb49-993"><a href="#cb49-993"></a></span>
<span id="cb49-994"><a href="#cb49-994"></a><span class="ss">-   </span>Beyersmann, J., Latouche, A., Buchholz, A., &amp; Schumacher, M. (2009). Simulating competing risks data in survival analysis. *Statistics in medicine*, *28*(6), 956-971.</span>
<span id="cb49-995"><a href="#cb49-995"></a></span>
<span id="cb49-996"><a href="#cb49-996"></a><span class="ss">-   </span>Allignol, A., Schumacher, M., Wanner, C. *et al.* Understanding competing risks: a simulation point of view. *BMC Med Res Methodol* **11**, 86 (2011). <span class="ot">&lt;https://doi.org/10.1186/1471-2288-11-86&gt;</span> - what I found cool is that this paper uses the non-parametric estimate of the baseline hazard function to simulate proportional hazard data from the cox model</span>
<span id="cb49-997"><a href="#cb49-997"></a></span>
<span id="cb49-998"><a href="#cb49-998"></a><span class="ss">-   </span>Crowther, M. J., &amp; Lambert, P. C. (2012). Simulating Complex Survival Data. *The Stata Journal*, *12*(4), 674-687. <span class="ot">&lt;https://doi.org/10.1177/1536867X1201200407&gt;</span> (Original work published 2012)</span>
<span id="cb49-999"><a href="#cb49-999"></a></span>
<span id="cb49-1000"><a href="#cb49-1000"></a><span class="ss">-   </span>Putter, H., Fiocco, M. and Geskus, R.B. (2007), Tutorial in biostatistics: competing risks and multi-state models. Statist. Med., 26: 2389-2430. <span class="ot">&lt;https://doi.org/10.1002/sim.2712&gt;</span> - key paper on competing risk analyses</span>
<span id="cb49-1001"><a href="#cb49-1001"></a></span>
<span id="cb49-1002"><a href="#cb49-1002"></a><span class="ss">-   </span>Hinchliffe, S.R., Lambert, P.C. Flexible parametric modelling of cause-specific hazards to estimate cumulative incidence functions. *BMC Med Res Methodol* **13**, 13 (2013). <span class="ot">&lt;https://doi.org/10.1186/1471-2288-13-13&gt;</span></span>
<span id="cb49-1003"><a href="#cb49-1003"></a></span>
<span id="cb49-1004"><a href="#cb49-1004"></a><span class="ss">-   </span><span class="in">`flexsurv`</span> package <span class="co">[</span><span class="ot">vignette</span><span class="co">](https://cran.r-project.org/web/packages/flexsurv/vignettes/multistate.pdf)</span> on multi-state modelling</span>
<span id="cb49-1005"><a href="#cb49-1005"></a></span>
<span id="cb49-1006"><a href="#cb49-1006"></a><span class="ss">-   </span><span class="in">`flexsurv`</span> package <span class="co">[</span><span class="ot">introduction vignette</span><span class="co">](https://cran.r-project.org/web/packages/flexsurv/vignettes/flexsurv.pdf)</span></span>
<span id="cb49-1007"><a href="#cb49-1007"></a></span>
<span id="cb49-1008"><a href="#cb49-1008"></a><span class="ss">-   </span><span class="in">`flexsurv`</span> vignette on <span class="co">[</span><span class="ot">distributions</span><span class="co">](https://cran.r-project.org/web/packages/flexsurv/vignettes/distributions.pdf)</span></span>
<span id="cb49-1009"><a href="#cb49-1009"></a></span>
<span id="cb49-1010"><a href="#cb49-1010"></a><span class="ss">-   </span><span class="in">`survsim`</span> package <span class="co">[</span><span class="ot">docs</span><span class="co">](https://cran.r-project.org/web/packages/survsim/survsim.pdf)</span></span>
<span id="cb49-1011"><a href="#cb49-1011"></a></span>
<span id="cb49-1012"><a href="#cb49-1012"></a>Some other papers / package vignettes I came across and read (parts of if not entirely)</span>
<span id="cb49-1013"><a href="#cb49-1013"></a></span>
<span id="cb49-1014"><a href="#cb49-1014"></a><span class="ss">-   </span><span class="in">`survival`</span> package <span class="co">[</span><span class="ot">multi-state vignette</span><span class="co">](https://cran.r-project.org/web/packages/survival/vignettes/compete.pdf)</span></span>
<span id="cb49-1015"><a href="#cb49-1015"></a></span>
<span id="cb49-1016"><a href="#cb49-1016"></a><span class="ss">-   </span><span class="in">`survival`</span> package <span class="co">[</span><span class="ot">vignette</span><span class="co">](https://cran.r-project.org/web/packages/survivalVignettes/vignettes/tutorial.html)</span> reproducing Putter et al analysis</span>
<span id="cb49-1017"><a href="#cb49-1017"></a></span>
<span id="cb49-1018"><a href="#cb49-1018"></a><span class="ss">-   </span>Andersen PK, Geskus RB, de Witte T, Putter H. Competing risks in epidemiology: possibilities and pitfalls. Int J Epidemiol. 2012 Jun;41(3):861-70. doi: 10.1093/ije/dyr213. Epub 2012 Jan 9. PMID: 22253319; PMCID: PMC3396320.</span>
<span id="cb49-1019"><a href="#cb49-1019"></a></span>
<span id="cb49-1020"><a href="#cb49-1020"></a><span class="ss">-   </span>Austin PC, Lee DS, Fine JP. Introduction to the Analysis of Survival Data in the Presence of Competing Risks. Circulation. 2016 Feb 9;133(6):601-9. doi: 10.1161/CIRCULATIONAHA.115.017719. PMID: 26858290; PMCID: PMC4741409.</span>
<span id="cb49-1021"><a href="#cb49-1021"></a></span>
<span id="cb49-1022"><a href="#cb49-1022"></a><span class="ss">-   </span>Fine, J. P., &amp; Gray, R. J. (1999). A Proportional Hazards Model for the Subdistribution of a Competing Risk. *Journal of the American Statistical Association*, *94*(446), 496–509. https://doi.org/10.2307/2670170</span>
<span id="cb49-1023"><a href="#cb49-1023"></a></span>
<span id="cb49-1024"><a href="#cb49-1024"></a><span class="ss">-   </span>Latouche A, Allignol A, Beyersmann J, Labopin M, Fine JP. A competing risks analysis should report results on all cause-specific hazards and cumulative incidence functions. J Clin Epidemiol. 2013 Jun;66(6):648-53. doi: 10.1016/j.jclinepi.2012.09.017. Epub 2013 Feb 14. PMID: 23415868.</span>
<span id="cb49-1025"><a href="#cb49-1025"></a></span>
<span id="cb49-1026"><a href="#cb49-1026"></a><span class="ss">-   </span>Scheike, T. H., &amp; Zhang, M.-J. (2011). Analyzing Competing Risk Data Using the R timereg Package. *Journal of Statistical Software*, *38*(2), 1–15. https://doi.org/10.18637/jss.v038.i02</span>
<span id="cb49-1027"><a href="#cb49-1027"></a></span>
<span id="cb49-1028"><a href="#cb49-1028"></a><span class="ss">-   </span>Thomas H. Scheike, Mei-Jie Zhang, Thomas A. Gerds, Predicting cumulative incidence probability by direct binomial regression, *Biometrika*, Volume 95, Issue 1, March 2008, Pages 205–220, <span class="ot">&lt;https://doi.org/10.1093/biomet/asm096&gt;</span></span>
<span id="cb49-1029"><a href="#cb49-1029"></a></span>
<span id="cb49-1030"><a href="#cb49-1030"></a><span class="ss">-   </span>Edouard F Bonneville, Liesbeth C de Wreede, Hein Putter, Why you should avoid using multiple Fine–Gray models: insights from (attempts at) simulating proportional subdistribution hazards data, *Journal of the Royal Statistical Society Series A: Statistics in Society*, Volume 187, Issue 3, August 2024, Pages 580–593, <span class="ot">&lt;https://doi.org/10.1093/jrsssa/qnae056&gt;</span></span>
</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
      &nbsp;
    </div>   
    <div class="nav-footer-center">
<p>akshat.blog © 2022-2025 Akshat Dwivedi. Built with <a href="https://www.quarto.org">Quarto</a> and <a href="https://pages.github.com">GitHub Pages</a>. Read the <a href="https://github.com/ad1729/ad1729.github.io/LICENSE.md">license.</a></p>
<div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/ad1729/ad1729.github.io/issues/new" class="toc-action"><i class="bi bi-github"></i>Report an issue</a></li></ul></div></div>
    <div class="nav-footer-right">
      &nbsp;
    </div>
  </div>
</footer>




<script src="../../site_libs/quarto-html/zenscroll-min.js"></script>
</body></html>